
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="走停人生路">
<meta property="og:url" content="http://tonytang1990.github.io/page/4/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tony Tang">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/09/10/设计模式/" title="设计模式" itemprop="url">设计模式</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2018-09-10T12:39:05.000Z" itemprop="datePublished"> 发表于 2018-09-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>写这篇博客的目的不再是为了一个一个单独去学习了解四人帮的设计模式(以前看四人帮的设计模式时就是这样，并没有结合游戏开发深入思考这些设计模式的真正用处和好处)。</p>
<p>本篇博客的侧重点是针对实战游戏开发过程中用到的设计模式进行深入学习了解(<em>能够运用在实际项目中的东西才是真正能发挥价值的</em>)。</p>
<p>下面几个问题，是本篇博客需要解答的疑问：</p>
<ol>
<li>为什么需要****设计模式？</li>
<li>***设计模式会给游戏开发带来什么好处？</li>
<li>什么情况下适合在实际项目中使用***模式？</li>
</ol>
<p>接下来本文将结合《Game-Programming-Patterns》书籍以及项目实战开发过程中遇到的问题就游戏编程模式而言进行深入学习和分析理解。</p>
<p>《Game-Programming-Patterns》的作者是Bob Nystrom，一个在EA工作了8年的游戏程序开发者。<br>下面给出官方网站链接:<br><a target="_blank" rel="noopener" href="http://gameprogrammingpatterns.com/">Game-Programming-Patterns</a></p>
<p>Note:<br>后面加上””号的内容表示是从书里截取的内容。</p>
<h2 id="游戏架构"><a href="#游戏架构" class="headerlink" title="游戏架构"></a>游戏架构</h2><p>为什么这里要提游戏架构了？<br>作为程序员在写代码的过程中，会发现整个游戏有很多模块，这些模块各自负责不同的功能，所有模块整合到一起才组成了完整的游戏框架。</p>
<p>一个游戏并不是把所有的代码都编写在一个main函数里就能完成的，这样的代码既不具有可读性也不具备扩展性以及维护性。</p>
<p>而游戏架构就是为了让游戏开发变得高度可扩展，可读性高，降低维护成本等。在一个好的游戏架构上编写实现一个功能可能只需要修改很少几处或者添加很少几处代码即可完成。而不好的游戏架构可能会导致你编写了上千行代码去实现一个小功能(这里无论是维护成本还是理解成本都是不能接受的)。</p>
<p>“好的设计意味着当我作出改动，整个程序就好像正等着这种改动。我可以加使用几个函数调用完成任务，而代码库本身无需改动。”</p>
<p>解耦对于上面提到的扩展性和维护成本起到了关键作用，后面会详细学习了解。</p>
<p>下面再引用一句作者对于软件架构的目标的话:<br>“最小化在编写代码前需要了解的信息。”</p>
<p>落实到真正的游戏开发过程中，我们往往要考虑开发周期，开发成本，游戏设计复杂度等，不是说任何游戏开发都往复杂的好的游戏架构上去设计就是正确的，也要结合实际情况分析。(但对于大型游戏开发，好的架构一般来说是必不可少的)</p>
<p>下面是作者给出的几个建议；</p>
<ol>
<li>“抽象和解耦让扩展代码更快更容易，但除非确信需要灵活性，否则不要在这上面浪费时<br>间。”</li>
<li>“在整个开发周期中考虑并为性能设计，但是尽可能推迟那些底层的，基于假设的优化，<br>那会锁死代码。”</li>
<li>“快速地探索游戏的设计空间，但不要跑的太快，在身后留下烂摊子。毕竟，你总得回来<br>打扫。”</li>
<li>“如果打算抛弃这段代码，就不要尝试将其写完美。摇滚明星将旅店房间弄得一团糟，因<br>为他们知道明天他们就走人了。”</li>
<li>“如果你想要做出让人享受的东西，那就享受做它的过程。”</li>
</ol>
<h2 id="游戏设计模式"><a href="#游戏设计模式" class="headerlink" title="游戏设计模式"></a>游戏设计模式</h2><p>接下来我们将结合游戏开发，实战分析学习设计模式带来的好处和实际运用的地方。</p>
<h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><p>首先看看作者是如何定义命令模式的：<br>“命令是具现化的方法调用。”</p>
<p>再看看四人帮是如何定义命令模式的:<br>“Encapsulate a request as an object, thereby letting users parameterize clients with different requests, queue or log requests, and support undoable operations”(将一个请求封装为一个对象，从而使你可用不同的请求对客户进行参数化； 对请求排队或记录请求日志，以及支持可撤销的操作。)</p>
<p>看完定义后更加糊涂了，让我们还是结合实例来学习理解。<br>假设我们通过不同的按键点击去控制玩家的行为，不考虑任何扩展性的前提下我们可能写出下面的代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputHandler::handleInput()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(Input.GetKeyDown(KEY_A))</span><br><span class="line">    &#123;</span><br><span class="line">        Attack();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(Input.GetKeyDown(KEY_SPACE))</span><br><span class="line">    &#123;</span><br><span class="line">        Jump();        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的硬编码确实实现了我们的功能需求，但当我们想改变按键所代表的行为时(比如玩家配置修改按钮功能)，我们会发现上面的代码没法满足需求，因为我们硬编码写死了指定按钮的行为。</p>
<p>我们需要支持按钮动态绑定行为的功能，这时命令模式就起作用了，命令模式把游戏行为封装成对象，通过动态绑定不同的命令可以实现同一按钮实现不同的行为。<br>首先我们需要定义一个命令基类：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> absctract <span class="keyword">class</span> <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后实现对应行为的命令类：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttackCommand</span> : <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">execute</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Attack();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JumpCommand</span> : <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">execute</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Jump();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时我们响应输入不再是直接执行特定行为，而是执行绑定在按钮上的命令：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InputHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Command Key_A;</span><br><span class="line">    <span class="keyword">private</span> Command Key_Space;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定命令的方法(用于支持动态修改按钮行为绑定)</span></span><br><span class="line">    <span class="comment">// **********</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleInput</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KEY_A))</span><br><span class="line">        &#123;</span><br><span class="line">            Key_A.execute();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(Input.GetKeyDown(KEY_SPACE))</span><br><span class="line">        &#123;</span><br><span class="line">            Key_Space.execute();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>玩家配置按钮行为，在代码里的表现就只是对于Key_A和Key_Space进行不同的行为命令绑定即可，因为我们把<em>请求对象化</em>了(四人帮里提到的定义)，所以可以通过动态绑定对象来绑定不同的命令实现动态绑定行为。</p>
<p>上面的代码还有个问题就是特定命令里的行为并不知道需要表现指定行为的对象，上面的写法是属于全局访问的一种形式，这样做耦合度太高且不灵活。<br>还记得四人帮定义里提到请求对象化后可以<em>对客户参数化</em>，这里的客户就是我们要服务要表现的行为对象。</p>
<p>因为我们把<em>请求对象化</em>了，那么我们对于请求的执行添加一些额外的信息也就是对于命令进行传参的问题：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span>(<span class="params">GameActor actor</span>)</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JumpCommand</span> : <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">execute</span>(<span class="params">GameActor actor</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        actor.Jump();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Command* command = inputHandler.handleInput();</span><br><span class="line"><span class="keyword">if</span> (command)</span><br><span class="line">&#123;</span><br><span class="line">    command-&gt;execute(actor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们的命令请求就知道应该是对谁做行为操作了。</p>
<p>通过命令模式，我们在按钮和角色操作之间增加了一层重定向，使我们可以通过按钮操作任何角色的行为(只需向命令传入不同的角色即可)。</p>
<p>在真正的实战游戏开发中，角色的AI会使用命令模式，这样一来可以对于所有的角色重用命令行为，而且通过模拟命令队列，我们可以实现AI行为队列的功能(一个行为接一个行为)。这个后续会结合Behavior Designer插件学习来进一步深入了解：</p>
<p>待续……</p>
<p>Note:</p>
<ol>
<li>我们不止可以通过定义类(Command)实现请求对象化，我们也可以通过闭包的形式把请求转化成可返回的函数对象来实现请求对象化。这里需要了解<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c3c08c621aa1">第一公民函数</a>等概念。</li>
<li>命令模式可以让我们轻易做到撤销和重做的功能。</li>
</ol>
<h3 id="框架模式"><a href="#框架模式" class="headerlink" title="框架模式"></a>框架模式</h3><p>关于框架模式最初了解过MVC，只知道是为了解耦数据，显示以及控制逻辑的一种模式。<br>后来陆陆续续了解到还有MVP,MVVM等模式。<br>为什么会有这么多MV**的框架模式了？<br>核心思想是通过解决M和V的耦合问题来实现界面分离。</p>
<p>接下来我们重点要学习了解MVC和MVVM模式以及实战运用，MVP会简单带过。</p>
<p>参考博客 :<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">谈谈对MVC、MVP和MVVM的理解</a><br><a target="_blank" rel="noopener" href="https://draveness.me/mvx">谈 MVC、MVP 和 MVVM 架构模式</a><br><a target="_blank" rel="noopener" href="https://juejin.im/entry/590ae83b5c497d005855988d">Unity 应用架构设计—— MVVM 模式的设计和实施 (Part 1)</a><br><a target="_blank" rel="noopener" href="https://juejin.im/post/5b041882f265da0b9348a4de">mvc的实现</a></p>
<h4 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h4><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/MVC">MVC模式（Model–view–controller）是软件工程中的一种软件架构模式，把软件系统分为三个基本部分：模型（Model）、视图（View）和控制器（Controller）。</a></p>
<p>MVC只是一种框架模式，针对不同的平台环境的实现方式会有些区别，这里本人的理解如下：<br><img src="/img/GameDesignPattern/MVCRelationship.png" alt="MVCRelationship"></p>
<p>模型(Model): 数据结构以及数据处理等。</p>
<p>视图(View)：专注于显示，比如前端UI显示</p>
<p>控制器(Controller)：连接(解耦)模型和视图，如处理视图的请求，更新模型数据，通知视图变化等</p>
<p>这里我们结合实例动手实现一个简单的MVC模式来加深理解：<br>需求：<br>用户通过点击按钮触发一个随机数显示在文本上。</p>
<p>分析事例中的MVC：<br>视图(View)：<br><img src="/img/GameDesignPattern/MVC_View.png" alt="MVC_View"><br>负责显示最终结果。</p>
<p>模型(Model):<br>负责存储随机数数据。</p>
<p>控制器(Controller):<br>负责响应View的点击事件，处理随机数逻辑，修改Model里的随机数数据，通知View更新显示。</p>
<p>这里Model和View之间的更新通知我们会用到监听者模式，Model是发布者，视图是订阅者。<br>接下来看下实际的代码设计:</p>
<p>监听者模式部分：<br>ObserverBase.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 监听者模式的监听者接口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ObserverBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于更新监听者状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;subject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span>(<span class="params">SubjectBase subject</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SubjectBase.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 监听者模式，发布者父类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SubjectBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 监听者列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ObserverBase&gt; mObserverList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubjectBase</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mObserverList = <span class="keyword">new</span> List&lt;ObserverBase&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 添加监听者 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;observer&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">addObserver</span>(<span class="params">ObserverBase observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mObserverList.Add(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 删除监听者 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;observer&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">deleteObserver</span>(<span class="params">ObserverBase observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mObserverList.Remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 通知所有监听者 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">notifyAllObserver</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> obesrver <span class="keyword">in</span> mObserverList)</span><br><span class="line">        &#123;</span><br><span class="line">            obesrver.update(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MVC部分：<br>UIView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVC中的View，负责UI显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIView</span> : <span class="title">MonoBehaviour</span>, <span class="title">ObserverBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Text mTxtRandomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Button mBtnRandomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        <span class="comment">// 添加UIController对UI点击事件的响应</span></span><br><span class="line">        mBtnRandomNumber.onClick.AddListener(UIController.Instance.OnBtnRandomNumberClick);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span>(<span class="params">SubjectBase subject</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// View层被通知监听对象改变了</span></span><br><span class="line">        <span class="comment">// 这里是UIModel改变了</span></span><br><span class="line">        refreshView(subject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 刷新视图显示</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshView</span>(<span class="params">SubjectBase subject</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取UIModel数据刷新显示</span></span><br><span class="line">        <span class="keyword">var</span> uimodel = subject <span class="keyword">as</span> UIModel;</span><br><span class="line">        mTxtRandomNumber.text = uimodel.mRandomNumber.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UIModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVC里的Model，负责存储随机数数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIModel</span> : <span class="title">SubjectBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UIModel Instance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mInstance == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mInstance = <span class="keyword">new</span> UIModel();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UIModel mInstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 随机数数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mRandomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 随机一个数字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">randomNumber</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mRandomNumber = Random.Range(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        <span class="comment">// 通知UIView更新显示</span></span><br><span class="line">        notifyAllObserver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UIController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVC中的Controller，负责连接(解耦)模型和视图，如处理视图的请求，更新模型数据，通知视图变化等</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 逻辑部分都在这里</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UIController Instance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mInstance == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mInstance = <span class="keyword">new</span> UIController();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UIController mInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">UIController</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UIView按钮点击事件响应</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnBtnRandomNumberClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 响应UIView按钮点击，</span></span><br><span class="line">        <span class="comment">// 修改UIModel数据，</span></span><br><span class="line">        UIModel.Instance.randomNumber();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化相关代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameProgrammingPattern</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的模型 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIModel mModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的视图 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIView mView;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 初始化MVC里的各个模块</span></span><br><span class="line">        mModel = UIModel.Instance;</span><br><span class="line">        mView = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;UIView&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 添加UIView对UIModel的监听</span></span><br><span class="line">        mModel.addObserver(mView);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到我们把UIView和UIModel设计成了监听者模式用于UIModel变化时通知UIView刷新显示。<br>通过划分V和M，把视图和数据严格分离开，视图只关心显示，模型只关心数据，其他所有的操作变化都是通过控制器去处理。</p>
<p>分析：</p>
<ol>
<li>上面的MVC里V和M并没有完全解耦，视图依然依赖于模型的数据来显示(当然我们可以通过回调注册替换监听者模式的形式去实现V和M的完全解耦)。(参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/frank901/article/details/72847352"><br>Unity3D用MVC框架思想实现的小例子</a>)</li>
<li>V和M的解耦，让我们可以重复利用M和V，只要控制器处理好V和M逻辑即可。(比如View不变，改变Model数据来源，我们重新编写一个新的Contoller去处理View和新的Model之间的逻辑关系就能实现对View的重用。反之Model重用同理。)</li>
<li>正因为V和M的解耦，所有逻辑相关处理都在C里，使得C看起来过于臃肿。</li>
</ol>
<p>问题：</p>
<ol>
<li>UI操作和数据原本就是大量交互在一起的，使用MVC使V和M分离，使得代码显的过于复杂，Controller这一层过于臃肿，对于后期维护并不友好。</li>
<li>游戏开发中，大部分时候UI变化很大，View层的重用不太现实。</li>
</ol>
<p>下面给出知乎上对于游戏里使用MVC模式的讨论(本人比较认同flashyiyi的分析)：<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23946609">如何在Unity中实现MVC模式？</a></p>
<p>结论：<br>游戏开发需要根据项目需求制定合理的框架设计，并非一种MVC就能包治百病，过度的设计有时候会带来可读性和维护性上的大大降低，Pure MVC并不适用于大部分游戏开发。</p>
<h4 id="MVP"><a href="#MVP" class="headerlink" title="MVP"></a>MVP</h4><p><img src="/img/GameDesignPattern/MVPRelationship.png" alt="MVPRelationship"><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">MVP用展示器代替了控制器，而展示器是可以直接更新视图，所以MVP中展示器可以处理视图的请求并递送到模型又可以根据模型的变化更新视图，实现了视图和模型的完全分离。</a></p>
<h4 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h4><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">MVVM是MVP更进一步的发展，把软件系统分为三个基本部分：模型（Model）、视图（View）和视图模型（ViewModel），关系如下图所示：</a><br><img src="/img/GameDesignPattern/MVVMRelationship.png" alt="MVVMRelationship"></p>
<p>模型(Model): 数据结构，基础数据等(不关心业务逻辑)。</p>
<p>视图(View)：专注于显示，比如前端UI显示</p>
<p>视图模型（ViewModel）：连接模型和视图，暴露视图所关心的数据和属性，负责修改Model数据，<em>视图模型和视图是双向绑定的</em>。</p>
<p>从上面的关系图以及介绍，可以看出MVVM里V和M通过VM完全隔离开来，V的更新通过V和VM的Data Bidning(数据绑定)以及Command模式等形式触发更新显示响应等。M的修改是通过VM来操作，V只关心和VM绑定的数据用于显示，真正的数据是在M里(比如M里存的是一个玩家的名字，VM暴露给V的数据可能是一个地址+名字格式的数据形式)。</p>
<p>MVVM优缺点(来源:<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8e3d4ab80714">MVC、MVP、MVVM架构分析与比较</a>)：<br>优点：<br>1、低耦合。View可以独立于Model变化和修改，一个ViewModel可以绑定到不同的”View”上，当View变化的时候Model可以不变，当Model变化的时候View也可以不变。<br>2、可重用性。你可以把一些视图逻辑放在一个ViewModel里面，让很多view重用这段视图逻辑。<br>3、独立开发。开发人员可以专注于业务逻辑和数据的开发（ViewModel），设计人员可以专注于页面设计，生成xml代码。<br>4、ViewModel解决MVP中View(Activity)和Presenter相互持有对方应用的问题，界面由数据进行驱动，响应界面操作无需由View(Activity)传递，数据的变化也无需Presenter调用View(Activity)实现，使得数据传递的过程更加简洁，高效。</p>
<p>缺点：<br>1、ViewModel中存在对Model的依赖。<br>2、数据绑定使得 Bug 很难被调试。你看到界面异常了，有可能是你 View 的代码有 Bug，也可能是 Model 的代码有问题。<br>3、IDE不够完善（修改ViewModel的名称对应的xml文件中不会自动修改等）。</p>
<p>关键词：</p>
<ol>
<li>Data Binding(数据绑定)</li>
<li>Event Based Programming</li>
<li>Command</li>
<li>Code Behind</li>
</ol>
<p>后面我们会实战实现一套MVVM里深入理解里面的相关概念，主要参考博客:<br><a target="_blank" rel="noopener" href="https://juejin.im/entry/590ae83b5c497d005855988d#_label3">Unity 应用架构设计—— MVVM 模式的设计和实施 (Part 1)</a></p>
<h5 id="Unity-MVVM实现"><a href="#Unity-MVVM实现" class="headerlink" title="Unity MVVM实现"></a>Unity MVVM实现</h5><p>要是在Unity里实现MVVM架构，那么我们必须先实现一套Unity里的Data Binding。</p>
<h6 id="Data-Binding-in-Unity"><a href="#Data-Binding-in-Unity" class="headerlink" title="Data Binding in Unity"></a>Data Binding in Unity</h6><p>如何在Unity里实现Data Bidning?<br>Data Binding的核心是在修改数据时能触发回调通知，能将数据和回调绑定起来。<br>明白了这一点，回顾C#里设置数据一般是通过方法或者属性或者直接访问public成员变量，要想实现回调触发，我们可以通过C#里的Property设置(set)的形式去确保回调相应。</p>
<h6 id="基础实现"><a href="#基础实现" class="headerlink" title="基础实现"></a>基础实现</h6><p>实现一个可触发回调的Property属性抽象：<br>BindableProperty.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             BindableProperty.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BindableProperty.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可触发回调的属性抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BindableProperty</span>&lt;<span class="title">T</span>&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性值变化回调委托定义</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">ValueChangedDelegate</span>(<span class="params">T oldvalue, T newvalue</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性值变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ValueChangedDelegate OnValueChanged;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> T Value</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            T oldvalue = mValue;</span><br><span class="line">            mValue = <span class="keyword">value</span>;</span><br><span class="line">            ValueChanged(oldvalue, mValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> T mValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性值变化时</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ValueChanged</span>(<span class="params">T oldvalue, T newvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(OnValueChanged != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            OnValueChanged(oldvalue, newvalue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们定义VM的Property时就可以按如下方式定义，然后让绑定V里的View到VM里对应的Property上即可：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">string</span>&gt; Name = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">int</span>&gt; AgeDetail = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">int</span>&gt;();</span><br></pre></td></tr></table></figure>
<p>按照VM负责和V的数据绑定以及负责M的修改，我们可以定义ViewModel如下：<br>MVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的VM</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 与View里Name绑定的名字属性 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">string</span>&gt; Name = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 与View里Age绑定的年纪属性 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">int</span>&gt; Age = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Model数据 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMModel Model;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Model数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;m&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeModel</span>(<span class="params">MVVMModel m</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Model = m;</span><br><span class="line">        Name.Value = Model.Name;</span><br><span class="line">        Age.Value = Model.Age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 保存Model数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveModel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Model.Name = Name.Value;</span><br><span class="line">        Model.Age = Age.Value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照V的定义只关心视图，我们可以定义View如下：<br>MVVMView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的View</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMView</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name输入文本(用于View输入改变Name) <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> InputField mInputFieldName;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Age值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtAge;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Model数据保存按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnSave;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> View所绑定的ViewModel <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMViewModel mViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定V到指定VM</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;vm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindViewModel</span>(<span class="params">MVVMViewModel vm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel = vm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化View(主要是V到VM之间的绑定)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">        mViewModel.Name.OnValueChanged = onNameChanged;</span><br><span class="line">        mViewModel.Age.OnValueChanged = onAgeChanged;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">        mInputFieldName.onValueChanged.AddListener(onInputNameChanged);</span><br><span class="line">        mBtnSave.onClick.AddListener(onSaveClick);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNameChanged</span>(<span class="params"><span class="built_in">string</span> oldname, <span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mInputFieldName.text = newname;</span><br><span class="line">        mTxtName.text = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAgeChanged</span>(<span class="params"><span class="built_in">int</span> oldvalue, <span class="built_in">int</span> newvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTxtAge.text = newvalue.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onInputNameChanged</span>(<span class="params"><span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel.Name.Value = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSaveClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel.saveModel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照M的定义只关心数据结构定义，我们可以定义Model如下：<br>MVVMModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的Model</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 名字 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 年纪 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MVVMModel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">&quot;TonyTang&quot;</span>;</span><br><span class="line">        Age = <span class="number">28</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来测试MVVM里的Data Binding:<br>GameProgrammingPattern.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameProgrammingPattern.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameProgrammingPattern</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVC Part</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的模型 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIModel mModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的视图 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIView mView;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVVM里的模型M <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMModel mMVVMModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVVM里的视图V <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMView mMVVMView;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVVM里的视图VM <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMViewModel mMVVMViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 动态变化Age属性值频率 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> WaitForSeconds mAgeChangeFrequency;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        initMonoScripts();</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVC Part</span></span><br><span class="line">        <span class="comment">// 初始化MVC里的各个模块</span></span><br><span class="line">        mModel = UIModel.Instance;</span><br><span class="line">        mView = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;UIView&gt;();</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        mMVVMViewModel = <span class="keyword">new</span> MVVMViewModel();</span><br><span class="line">        mMVVMModel = <span class="keyword">new</span> MVVMModel();</span><br><span class="line">        mMVVMView = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;MVVMView&gt;();</span><br><span class="line"></span><br><span class="line">        mAgeChangeFrequency = <span class="keyword">new</span> WaitForSeconds(<span class="number">5.0f</span>);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVC Part</span></span><br><span class="line">        <span class="comment">// 添加UIView对UIModel的监听</span></span><br><span class="line">        mModel.addObserver(mView);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        <span class="comment">// 初始化ViewModel里的Model数据</span></span><br><span class="line">        mMVVMViewModel.initializeModel(mMVVMModel);</span><br><span class="line">        <span class="comment">// 绑定View到VM上</span></span><br><span class="line">        mMVVMView.bindViewModel(mMVVMViewModel);</span><br><span class="line">        <span class="comment">// 初始化View和ViewModel的双向绑定</span></span><br><span class="line">        mMVVMView.initialize();</span><br><span class="line">        <span class="comment">// 通过携程动态使用VM修改值Age触发View变化显示</span></span><br><span class="line">        CoroutineManager.Singleton.startCoroutine(changeViewModelAgeCoroutine());</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化需要挂在的脚本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initMonoScripts</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.gameObject.AddComponent&lt;CoroutineManager&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 修改ViewModel的Age属性值携程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function">IEnumerator <span class="title">changeViewModelAgeCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> mAgeChangeFrequency;</span><br><span class="line">            mMVVMViewModel.Age.Value = Random.Range(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的测试UI如下:<br><img src="/img/GameDesignPattern/MVVMPatternTestUI.png" alt="MVVMPatternTestUI"><br>InputField里动态输入文字，会看到右边的文本动态跟新了，同时下方的Age文本因为携程动态修改数据刷新显示:<br><img src="/img/GameDesignPattern/MVVMPatternExample.png" alt="MVVMPatternExample"><br>上面的表现可以看出，我们通过绑定V和VM里的数据实现了动态修改VM数据后，V自动跟着刷新显示，V变化VM自动更新，做到了数据驱动刷新显示，完全隔离了V和M。</p>
<h6 id="解耦V和VM"><a href="#解耦V和VM" class="headerlink" title="解耦V和VM"></a>解耦V和VM</h6><p>上面的实现有一个比较严重的问题，就是V和VM严重的耦合了，V里通过保存一个指定VM类型的实例对象来访问VM，如果我们想将V绑定到另一个VM的话，就发现代码需要改动才能支持，同时上面的代码是没有处理动态绑定VM时对原始VM动态绑定部分的解除。这里为了改进这一点，我们需要了解几个概念：</p>
<ol>
<li>依赖倒置原则（DIP）<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">高层模块不应依赖于低层模块，两者应该依赖于抽象。 抽象不不应该依赖于实现，实现应该依赖于抽象。</a></li>
<li>控制反转（IoC）<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">控制反转（IoC），它为相互依赖的组件提供抽象，将依赖（低层模块）对象的获得交给第三方（系统）来控制，即依赖对象不在被依赖模块的类中直接通过new来获取。</a></li>
<li>依赖注入（DI）<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">依赖注入（DI），它提供一种机制，将需要依赖（低层模块）对象的引用传递给被依赖（高层模块）对象。</a></li>
</ol>
<p>引用的文章里对几个核心概念做了如下总结，这里直接搬过来:<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">依赖倒置原则（DIP）：一种软件架构设计的原则（抽象概念）。<br>控制反转（IoC）：一种反转流、依赖和接口的方式（DIP的具体实现方式）。<br>依赖注入（DI）：IoC的一种实现方式，用来反转依赖（IoC的具体实现方式）。<br>IoC容器：依赖注入的框架，用来映射依赖，管理对象创建和生存周期（DI框架）。</a></p>
<p>上面的核心概念是高层模块不应该直接依赖底层模块，而是依赖于抽象，然后通过依赖注入的形式实现反转依赖，解耦高层模块和底层模块。</p>
<p>针对解耦V和VM，让我们修改上面的实现：<br>为了解耦V和VM，根据依赖倒置的原则，我们需要让V依赖于VM的接口而非具体的类，同时通过依赖注入的形式传入实现控制反转。<br>IMVVMView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             IMVVMView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> IMVVMView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的V的抽象接口(抽象出V和VM之间的绑定关系)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IMVVMView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> MVVM里V的VM上下文</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通过定义VM的Interface接口类成员，实现依赖倒置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    IMVVMViewModel mMVVMViewModelContext</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IMVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             IMVVMViewModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> IMVVMViewModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的VM抽象接口(实现依赖倒置，避免V和VM的高度耦合)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IMVVMViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了实现ViewModel可动态绑定修改，我们还需定义一个View的父类，用于实现动态响应ViewModel的绑定修改：<br>MVVMBaseView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMBaseView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMBaseView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的View的基类(含ViewModel的动态绑定定义以及ViewModel的接口成员定义(依赖倒置))</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMBaseView</span> : <span class="title">MonoBehaviour</span>, <span class="title">IMVVMView</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可绑定的ViewModel属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于实现V动态绑定VM</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> BindableProperty&lt;IMVVMViewModel&gt; ViewModelProperty = <span class="keyword">new</span> BindableProperty&lt;IMVVMViewModel&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> V的VM上下文属性接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> IMVVMViewModel mMVVMViewModelContext</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> ViewModelProperty.Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!mIsInitialized)</span><br><span class="line">            &#123;</span><br><span class="line">                OnInitialize();</span><br><span class="line">                mIsInitialized = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ViewModelProperty.Value = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> View是否初始化过</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于避免逻辑依赖于显示(比如绑定VM上下文属性变化回调时，依赖于View的显示)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">bool</span> mIsInitialized;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MVVMBaseView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 绑定VM上下文修改回调</span></span><br><span class="line">        <span class="comment">// 避免这种写法，会导致绑定VM上下文属性变化回调依赖于显示</span></span><br><span class="line">        <span class="comment">//ViewModelProperty.OnValueChanged += OnBindingContextChanged;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 第一次初始化初始化方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnInitialize</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 绑定VM上下文修改回调</span></span><br><span class="line">        ViewModelProperty.OnValueChanged += OnBindingContextChanged;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> VM动态绑定回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnBindingContextChanged</span>(<span class="params">IMVVMViewModel oldvm, IMVVMViewModel newvm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改原来的MVVMView实现:<br>MVVMView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的View</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMView</span> : <span class="title">MVVMBaseView</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name输入文本(用于View输入改变Name) <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> InputField mInputFieldName;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Age值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtAge;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Model数据保存按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnSave;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 真实绑定的VM对象访问入口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MVVMViewModel ViewModel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (MVVMViewModel)mMVVMViewModelContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应VM绑定变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 在这里做V和VM绑定相关的事</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBindingContextChanged</span>(<span class="params">IMVVMViewModel oldvm, IMVVMViewModel newvm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnBindingContextChanged(oldvm, newvm);</span><br><span class="line">        <span class="comment">// 解除老的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span>(oldvm != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">            MVVMViewModel ovm = oldvm <span class="keyword">as</span> MVVMViewModel;</span><br><span class="line">            ovm.Name.OnValueChanged -= onNameChanged;</span><br><span class="line">            ovm.Age.OnValueChanged -= onAgeChanged;</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mInputFieldName.onValueChanged.RemoveListener(onInputNameChanged);</span><br><span class="line">            mBtnSave.onClick.RemoveListener(onSaveClick);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加新的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span> (ViewModel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part            </span></span><br><span class="line">            ViewModel.Name.OnValueChanged += onNameChanged;</span><br><span class="line">            ViewModel.Age.OnValueChanged += onAgeChanged;</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mInputFieldName.onValueChanged.AddListener(onInputNameChanged);</span><br><span class="line">            mBtnSave.onClick.AddListener(onSaveClick);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNameChanged</span>(<span class="params"><span class="built_in">string</span> oldname, <span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mInputFieldName.text = newname;</span><br><span class="line">        mTxtName.text = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAgeChanged</span>(<span class="params"><span class="built_in">int</span> oldvalue, <span class="built_in">int</span> newvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTxtAge.text = newvalue.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onInputNameChanged</span>(<span class="params"><span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewModel.Name.Value = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSaveClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewModel.saveModel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MVVMViewModel只需要修改来实现IMVVMViewModel即可:<br>MVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel</span> : <span class="title">IMVVMViewModel</span>&#123;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码也要跟着修改:<br>GameProgrammingPattern.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">    <span class="comment">// 初始化ViewModel里的Model数据</span></span><br><span class="line">    mMVVMViewModel.initializeModel(mMVVMModel);</span><br><span class="line">    <span class="comment">// 绑定View到VM上</span></span><br><span class="line">    mMVVMView.mMVVMViewModelContext = mMVVMViewModel;</span><br><span class="line">    <span class="comment">// 通过携程动态使用VM修改值Age触发View变化显示</span></span><br><span class="line">    CoroutineManager.Singleton.startCoroutine(changeViewModelAgeCoroutine());</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果依然是正常双向绑定V和VM，实现V和M隔离，但现在我们的V不在和VM强耦合了，可以动态绑定到同类型不同的VM实例对象:<br><img src="/img/GameProgrammingPattern/MVVMPatternExampleRefactor.png" alt="MVVMPatternExampleRefactor"></p>
<h6 id="VM如何通知V"><a href="#VM如何通知V" class="headerlink" title="VM如何通知V"></a>VM如何通知V</h6><p>V和VM在MVVM里是通过数据绑定实现的双向绑定，但假设V里点击一个按钮后修改VM里的数据后并不需要更新View刷新显示，而是需要VM通知View数据处理完毕并将最新数据返回做后续处理了(比如弹窗口提示之类)？</p>
<p>这时候我们需要的是一种通知数据处理完毕后回调通知的形式，我们很容易想到的一种实现方案是传递回调的形式：<br>伪代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">View</span> : <span class="title">BaseView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onBtnClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel.ChangeName(newname, ChangeNameCallback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ChangeNameCallback</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// VM处理完毕后回调做后续处理</span></span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但这样在View里编写Code Behind代码会导致View层被污染，导致View层包含逻辑代码。同时也打断了MVVM里ViewModel的Unit Test特性。</p>
<p>我们可以通过绑定按钮点击到ViewModel的一个Command(包含操作的数据对象以及检查是否可执行以及最终逻辑回调等)里，把逻辑部分搬到ViewModel层实现Zero Code Behind并不破坏ViewModel的Unit Test。也可以考虑直接调用VM方法在方法里写逻辑。如果是涉及到View层表现，可以考虑绑定属性，在VM写逻辑去修改对应属性触发View层表现。</p>
<p>这里并没有太弄懂Command存在的意义(和直接在VM层写逻辑的区别是什么？)，所以这里没有去实现这一套东西。</p>
<h6 id="简化V和VM绑定代码"><a href="#简化V和VM绑定代码" class="headerlink" title="简化V和VM绑定代码"></a>简化V和VM绑定代码</h6><p>从前面的事例可以看到，V和VM的绑定都是成对出现，属于有规律可循的代码(后续可以自动化代码生成来解决)，但这里我们希望解决的不是自动化代码的问题，而是提供一套更方便的代码绑定方案，解决大量复杂代码的编写。</p>
<p>实现思考:</p>
<ol>
<li>通过统一的一个类来实现简化V和VM的绑定。</li>
<li>因为要访问VM的属性对象，需要通过反射访问(没想到更好的方案)</li>
</ol>
<p>因为涉及到反射实现，这里觉得并不好(一是效率方面，二是直观上查找不到属性引用(维护方面))，不如单纯的实现自动化代码生成的形式。所以这里就不去实现这一套方案了，详细参考下文作者实现：<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/OceanEyes/p/unity3d_framework_designing_get_started_with_mvvm_part2.html">Unity应用架构设计(1)—— MVVM 模式的设计和实施(Part 2)</a></p>
<h6 id="VM和VM之间通信"><a href="#VM和VM之间通信" class="headerlink" title="VM和VM之间通信"></a>VM和VM之间通信</h6><p>现实开发过程中，我们的View和View有些时候是需要通信的，虽然View实现了和ViewModel的双向绑定，但并没有解决View和View之间的通信问题。</p>
<p>实现方便来说我们会去写如下代码实现View与View之间的访问:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ViewA</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyViewB</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewB.UpdateView();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但这样的代码是的View与View之间强耦合了，并不推荐这样实现，我们使用MVVM模式的目的是为了解耦V和M，同时实现V和VM之间数据驱动刷新。这里我们需要解决View和View之间ViewModel与ViewModel之间通信的问题。</p>
<p>首先V和VM是一对一的，V和VM是双向绑定的，所以要实现View和View之间的沟通交流，其实只要实现VM和VM之间的沟通交流即可。VM和VM是一对多的，为了解耦，我们可以通过一个中介者来解耦并统一管理ViewModel之间的沟通交流，然后使用订阅者模式实现消息订阅的形式模拟实现ViewModel之间一对多的沟通交流。</p>
<p>首先核心的消息统一订阅分发类：<br>MessageDispatcher.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MessageDispatcher.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MessageDispatcher.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 消息分发单例类(这里是为了解耦类似ViewModel和ViewModel之间的交流)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 类似于EventDispather，只不过这里是支持对任意string的消息监听而非EventId枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MessageDispatcher</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">MessageDispatcher</span>&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息回调定义</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span>发送消息对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paras&quot;&gt;</span>消息参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">MessageDelegate</span>(<span class="params"><span class="built_in">object</span> sender, <span class="keyword">params</span> <span class="built_in">object</span>[] paras</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息映射类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Key为订阅的消息字符串</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Value为注册的回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="built_in">string</span>, MessageDelegate&gt; mMessageMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, MessageDelegate&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册监听消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span>监听的消息字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;handler&quot;&gt;</span>监听的消息响应回调<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span>(<span class="params"><span class="built_in">string</span> message, MessageDelegate handler</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(message))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mMessageMap.ContainsKey(message))</span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap.Add(message, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap[message] += handler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;不能订阅空的字符串消息!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注销消息监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;handler&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unSubscribe</span>(<span class="params"><span class="built_in">string</span> message, MessageDelegate handler</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(message))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mMessageMap.ContainsKey(message))</span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap[message] -= handler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;不能取消空的字符串消息!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分发消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span>分发的消息字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span>发送消息对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paras&quot;&gt;</span>消息参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span>(<span class="params"><span class="built_in">string</span> message, <span class="built_in">object</span> sender, <span class="keyword">params</span> <span class="built_in">object</span>[] paras</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(message))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mMessageMap.ContainsKey(message))</span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap[message](sender, paras);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;不能分发空的字符串消息!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改ViewModel1的代码，添加消息监听:<br>MVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的VM</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel</span> : <span class="title">IMVVMViewModel</span>&#123;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册消息监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMessageListener</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageDispatcher.Singleton.subscribe(<span class="string">&quot;ChangeName&quot;</span>, onChangeNameMessageHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 取消小心监听注册</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterMessageListener</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageDispatcher.Singleton.unSubscribe(<span class="string">&quot;ChangeName&quot;</span>, onChangeNameMessageHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 保存Model数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveModel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Model.Name = Name.Value;</span><br><span class="line">        Model.Age = Age.Value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应ChangeName消息回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paras&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onChangeNameMessageHandler</span>(<span class="params"><span class="built_in">object</span> sender, <span class="built_in">object</span>[] paras</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Name.Value = paras[<span class="number">0</span>] <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加View 2和ViewModel2相关代码:<br>MVVMView2.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMView2.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMView2.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 第二个View</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMView2</span> : <span class="title">MVVMBaseView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 通知ViewModel1改变Name属性按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnChangeViewModel1Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 真实绑定的VM对象访问入口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MVVMViewModel2 ViewModel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (MVVMViewModel2)mMVVMViewModelContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应VM绑定变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 在这里做V和VM绑定相关的事</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBindingContextChanged</span>(<span class="params">IMVVMViewModel oldvm, IMVVMViewModel newvm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnBindingContextChanged(oldvm, newvm);</span><br><span class="line">        <span class="comment">// 解除老的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span> (oldvm != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mBtnChangeViewModel1Name.onClick.RemoveListener(onNotifyViewModel1Click);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加新的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span> (ViewModel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part            </span></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mBtnChangeViewModel1Name.onClick.AddListener(onNotifyViewModel1Click);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNotifyViewModel1Click</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewModel.notifyViewModel1NameChange();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MVVMViewModel2.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMViewModel2.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMViewModel2.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 第二个ViewModel</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel2</span> : <span class="title">IMVVMViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通知ViewModel1的名字修改</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyViewModel1NameChange</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageDispatcher.Singleton.publish(<span class="string">&quot;ChangeName&quot;</span>, <span class="keyword">this</span>, <span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化View2和ViewModel2相关的绑定:<br>GameProgrammingPattern.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameProgrammingPattern.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameProgrammingPattern</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 第二个ViewModel <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMViewModel2 mMVVMViewModel2;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 第二个View <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMView2 mMVVMView2;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        initMonoScripts();</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        ******</span><br><span class="line"></span><br><span class="line">        mMVVMViewModel2 = <span class="keyword">new</span> MVVMViewModel2();</span><br><span class="line">        mMVVMView2 = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;MVVMView2&gt;();</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        <span class="comment">// 初始化ViewModel里的Model数据</span></span><br><span class="line">        mMVVMViewModel.initializeModel(mMVVMModel);</span><br><span class="line">        <span class="comment">// ViewModel注册消息监听</span></span><br><span class="line">        mMVVMViewModel.registerMessageListener();</span><br><span class="line">        <span class="comment">// 绑定View到VM上</span></span><br><span class="line">        mMVVMView.mMVVMViewModelContext = mMVVMViewModel;</span><br><span class="line">        <span class="comment">// 通过携程动态使用VM修改值Age触发View变化显示</span></span><br><span class="line">        CoroutineManager.Singleton.startCoroutine(changeViewModelAgeCoroutine());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绑定View2到ViewModel2上</span></span><br><span class="line">        mMVVMView2.mMVVMViewModelContext = mMVVMViewModel2;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行点击ViewModel2的按钮可以看到我们成功通过消息订阅和分发达到ViewModel和ViewModel之间交流的目的，成功实现了解耦ViewModel和ViewModel之间的通信:<br><img src="/img/GameProgrammingPattern/MessageDispatcher.png" alt="MessageDispatcher"></p>
<h6 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h6><ol>
<li>自动化生成View和ViewModel属性绑定部分代码<br>待续……</li>
</ol>
<h5 id="MVVM使用思考"><a href="#MVVM使用思考" class="headerlink" title="MVVM使用思考"></a>MVVM使用思考</h5><p>可以看到MVVM相比传统MVC模式，将V和M完全解耦，V和M不需要关心对方，通过ViewModel去实现V和M的桥接，通过双向绑定实现View的数据驱动刷新显示。通过消息分发注册等类似机制实现ViewModel与ViewModel之间的沟通交流，实现低耦合的MVVM框架。<br>View可以绑定不同的ViewModel，快速实现不同数据刷新显示。<br>同时因为V和M完全分离，开发人员可以专注于业务逻辑和数据的开发（ViewModel），设计人员可以专注于页面设计。</p>
<p>MVVM应用范围思考:</p>
<ol>
<li>独立开发，方便测试，MVVM比较适合多人合作项目，设计人员和开发人员可以同时开工，</li>
<li>代码重用性，开发人员之间的代码有很高的重用性(重用V或者重用VM都有可能)，开发人员之间的代码不会互相污染。</li>
<li>适用于数据驱动的不复杂的游戏UI部分(数据驱动刷新显示)。</li>
</ol>
<p>待续……</p>
<h4 id="ECS"><a href="#ECS" class="headerlink" title="ECS"></a>ECS</h4><p>待续……</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="网站"><a href="#网站" class="headerlink" title="网站"></a>网站</h2><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">谈谈对MVC、MVP和MVVM的理解</a><br><a target="_blank" rel="noopener" href="https://draveness.me/mvx">谈 MVC、MVP 和 MVVM 架构模式</a><br><a target="_blank" rel="noopener" href="https://juejin.im/entry/590ae83b5c497d005855988d">Unity 应用架构设计—— MVVM 模式的设计和实施 (Part 1)</a><br><a target="_blank" rel="noopener" href="https://juejin.im/post/5b041882f265da0b9348a4de">mvc的实现</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23946609">如何在Unity中实现MVC模式？</a><br><a target="_blank" rel="noopener" href="https://blog.codingnow.com/2017/02/tracedoc.html">跟踪数据结构的变更</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8e3d4ab80714">MVC、MVP、MVVM架构分析与比较</a></p>
<h2 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h2><p>《Game-Programming-Patterns》 – Robert.Nystrom<br>《Design Pattern》 – GoF(四人帮)</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Programming-Language/">Programming Language</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/GameDesignPattern/">GameDesignPattern</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/05/29/2D像素画/" title="2D像素画" itemprop="url">2D像素画</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2018-05-29T00:59:01.000Z" itemprop="datePublished"> 发表于 2018-05-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习2D像素画方面的技巧以及知识而写，希望有一天能做自己的2D像素独立游戏。</p>
<h2 id="电子游戏史"><a href="#电子游戏史" class="headerlink" title="电子游戏史"></a>电子游戏史</h2><p>在学习了解像素画之前，先了解下电子游戏史，有助于学习了解像素画游戏的由来，同时也可以加深对游戏发展史的了解。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%BB%E5%AD%90%E9%81%8A%E6%88%B2%E5%8F%B2">电子游戏在1970年代开始以商业娱乐媒体的姿态出现，成为1970年代末日本、美国和欧洲一个重要娱乐工业的基础。</a></p>
<h3 id="街机时代"><a href="#街机时代" class="headerlink" title="街机时代"></a>街机时代</h3><p>关键词： 街机 &amp; 70年代初发展 &amp; 70年代末至90年代中期盛行<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%A1%97%E6%9C%BA">在街机上运行的游戏为街机游戏。街机游戏发端于70年代初而盛行于70年代末至90年代中期。90年代后期，虽然SNK的拳皇和合金弹头依然颇受欢迎，但整个产业已经开始衰退。进入21世纪后，街机迅速衰弱，日益远离大众的视线。</a><br>小时候90年代，街机很流行，从小就混迹街机室，不得不说有很深的感情。<br>这里放几张图留念：<br><img src="/img/GameArt/ArcadeGame.png" alt="ArcadeGame"><br>小时候比较喜欢的几款街机游戏，拳皇97，三国战纪，恐龙快打，合金弹头等。<br><img src="/img/GameArt/KingOfFighters.png" alt="KingOfFighters"><br><img src="/img/GameArt/SanGuoZhanJi.png" alt="SanGuoZhanJi"><br><img src="/img/GameArt/KongLongKuaiDa.png" alt="KongLongKuaiDa"><br><img src="/img/GameArt/MetalSlug.png" alt="MetalSlug"></p>
<h3 id="掌机时代"><a href="#掌机时代" class="headerlink" title="掌机时代"></a>掌机时代</h3><p>关键词: 掌机 &amp; 任天堂 &amp; 索尼 &amp; 70年代初发展 &amp; 80年代以后开始盛行<br>虽然掌机游戏发展史70年代初，但掌机游戏真正发光是任天堂的掌机系列。<br>任天堂掌机系列:</p>
<ol>
<li>GB(Game Body) – 第一代<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Game_Boy">Game Boy（日语：ゲームボーイ，简称GB）是任天堂公司在1989年发售的第一代便携式掌上游戏机。</a><br>这里截取一段GB主机的技术参数信息:<br><img src="/img/GameArt/GameBoyParameters.png" alt="GameBoyParameters"><br>不得不说以前掌机的内存，容量等都相当苛刻，8 KByte RAM放到今天真的是难以想象。<br>掌机小时候玩的并不算多，印象中还是用下面的掌机玩俄罗斯方块之类的:<br><img src="/img/GameArt/GameBoyTetris.png" alt="GameBoyTetris"></li>
<li>GBA(Game Boy Advance) – 第二代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">2001年初，任天堂发布了Game Boy后续机型Game Boy Advance（GBA）。</a></li>
<li>NDS(Nintendo Dual screen) – 第三代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">2004年11月，任天堂DS系列掌机产品上市。NDS采用了上下两块的3英寸屏幕，其下屏幕的触控设计一举颠覆了过往游戏掌机的操控概念。</a><br>可以看出NDS在显示操作上针对GBA做出了很大改变:<br><img src="/img/GameArt/NintendoDualScreen.png" alt="NintendoDualScreen"></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">NDSL</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">NDSi</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">NDSiLL</a></li>
<li>3DS<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">任天堂于2011年2月26日发布的次世代掌机</a><br>这里再看看3DS的部分技术参数信息：<br><img src="/img/GameArt/3DS.png" alt="3DS"><br>可以看出从Game Boy到3DS，经历了20年的发展，内存和容量都得到了大大的提高。</li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">3DSLL</a></li>
<li>Switch<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">Nintendo Switch近日首度亮相，集电视游戏主机与掌上游戏机“双机一体”</a><br>Switch不同于普通的掌机，还结合了游戏主机的功能。但当初了解到Switch令我眼前一亮的是他的游戏设计创意上(瓦楞纸游戏):<br>通过纸盒做出游戏所需的零部件，在这些纸板上会有一些反光部件，IR 摄像头就是通过计算这些反光，来触发相应的功能，从而实现游戏性。<br>这里就放一个链接，个人可以去感受下，创意真的很好:<br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av18433605/">Switch瓦楞纸游戏视频</a></li>
</ol>
<p>索尼掌机系列；</p>
<ol>
<li>PSP(PlayStation Portable)<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/PSP/85995">2003年5月13日，SCE在E3大展5月11日的例行新闻发布会上首次披露了携带游戏主机PSP，社长久多良木健将之称许为“21世纪 的WALKMAN” </a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">PSP2</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">PSP3</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">PSV(Play Station Vita)</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/PlayStation_4">PS4</a></li>
</ol>
<h3 id="家用机时代"><a href="#家用机时代" class="headerlink" title="家用机时代"></a>家用机时代</h3><p>关键词： 家用机 &amp; 任天堂 &amp; </p>
<ol>
<li>FC(Family Computer) – 第一代<br>大家熟悉的红白机指的就是这个，小时候在家玩的插卡的魂斗罗，超级玛丽就是在FC上玩的。<br><img src="/img/GameArt/FamilyComputer.png" alt="FamilyComputer"><br>小时候家里有卖这个，直接拿回家里就可以玩了，真的是童年里很快乐的时光。<br>很多红白机经典游戏，现在都记忆犹新:<br><img src="/img/GameArt/PixelArtGameSuperMario.png" alt="超级玛丽"><br><img src="/img/GameArt/MaXiTuan.png" alt="马戏团"><br><img src="/img/GameArt/HunDouLuo.png" alt="魂斗罗"></li>
<li>SFC – 第二代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/SFC/99631">SFC是「FAMICOM」后任天堂推出的第2代家用机。 [1]  采用全新16位元架构，搭配强化的图形与音效处理功能，成功延续FC的霸业。SFC手柄最大的改进之处在于第一次加入了肩部按键L&#x2F;R，并形成了ABXY四个按键的手柄布局、和satellaview。</a></li>
<li>N64(Nintendo 64) – 第三代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BB%BB%E5%A4%A9%E5%A0%8264/2619380?fromtitle=N64&fromid=2387227">N64手柄堪称游戏史上最重要的输入设备，它有3个堪称划时代的设计：类比摇杆，扳机按键，震动包。 N64上诞生了塞尔达传说：时之笛和超级马里奥64等超级大作。N64下一代产品为任天堂NGC。</a><br>塞尔达传说和超级玛丽相比也不逊色游戏大作，这里本人并没有玩过，但可以看下简单的游戏版本信息截图来感受下：<br><img src="/img/GameArt/TheLegendOfZelda.png" alt="TheLegendOfZelda"></li>
<li>NGC(Nintento GameCube) – 第四代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/NGC/7005912">2001年9月4日，NGC在日本本土发售。</a></li>
<li>Wii – 第五代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Wii">Wii是任天堂公司2006年11月19日推出的家用游戏机。是NGC的后续机种。Wii第一次将体感引入了电视游戏主机。</a><br><img src="/img/GameArt/Wii.png" alt="Wii"></li>
<li>WiiU<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Wii_U">Wii U是任天堂继Wii之后所推出的家用游戏主机，是Wii的后继机种。于2011年6月7日首次公布</a></li>
</ol>
<h3 id="电脑时代"><a href="#电脑时代" class="headerlink" title="电脑时代"></a>电脑时代</h3><p>关键词： 60年代初诞生 &amp; 斯蒂夫.拉塞尔 &amp; 80,90年代开始盛行 &amp; 21世纪鼎盛时期<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%94%B5%E8%84%91%E6%B8%B8%E6%88%8F">电脑游戏（英语：PC games，或称computer games，全写personal computer games）是一个相对于主机游戏和街机游戏的概念，指在个人电脑上运行的游戏软件，是一种本身提供娱乐功能的电脑软件。<br>电脑游戏的出现与1960年代电子计算机出现在美国大学校园有密切的联系。当年的环境培养出了一群编程的高手。在1962年，一位叫斯蒂夫·拉塞尔的大学生在美国DEC公司生产的PDP-1型电子计算机上编制的电脑游戏就是在当时很有名的《宇宙战争》（Space War）。游戏业界人士一般认为，斯蒂夫·拉塞尔就是发明电脑游戏的人</a><br>小时候90年代初，电脑游戏已经开始盛行，只是当时处于硬件和技术等限制，还没有那么多3A大作游戏。小时候当初影响最深要数传奇，暗黑2，星际争霸和半条命了。<br>传奇算是当初非常火的MMORPG(大型多人在线角色扮演类游戏):<br><img src="/img/GameArt/Legend.png" alt="传奇"><br>当时还在读小学，玩传奇玩的不亦乐乎，对于这种大型多人在线游戏以及打怪升级，杀人爆装备的设定，感觉很有意思。当时玩的最多的是法师，最喜欢去招宝宝(暗黑神殿的巨型多角虫)带去练级刷怪了。<br>暗黑2(暴雪出品)算是Isometric Projection(等角投影)用2D模拟3D显示典型的游戏:<br><img src="/img/GameArt/Diablo2.png" alt="暗黑2"><br>暗黑2利用Isometric Projectection使用2D来制作2.5D的游戏，看起来特别舒服，同时里面的装备系统，难度模式，剧情以及各种职业特点都很有特点，让人即使是网吧局域网都玩的不亦乐乎。<br>星际争霸(暴雪出品)算是典型的RTS(Real Time Strategy即时战略类)游戏:<br><img src="/img/GameArt/StarCraft1.png" alt="StarCraft1"><br>半条命(Valve公司出品)算是典型的FPS(First Person Shooting第一人称射击)游戏:<br><img src="/img/GameArt/CS.png" alt="半条命"></p>
<p>电脑游戏虽然受到手机游戏的冲击，但目前看来电脑游戏依然还是主流。(2018&#x2F;06&#x2F;02)</p>
<h3 id="手机时代"><a href="#手机时代" class="headerlink" title="手机时代"></a>手机时代</h3><p>关键词： 21世纪 &amp; 智能机普及<br>21世纪，伴随着智能机的普及，手机已经是人们生活中必不可少的工具了。为移动端游戏的开发和繁荣奠定了基础。<br>这里就说太多了，这里主要想提下，移动游戏里自己最喜欢的游戏COC(部落冲突)，由芬兰Supercell公司开发(后来被腾讯斥资86亿美元收购了)。这一款游戏让我被移动游戏开发深深吸引，原来移动游戏可以做到如此的好玩，也激发了我做独立移动游戏的思想。<br>这里不厌其烦的再次放张自己玩COC以前的截图作为纪念:<br><img src="/img/Unity/MyCOC.PNG" alt="My COC"></p>
<p>虽然现在(2018&#x2F;06&#x2F;02)移动游戏已经不再像几年前，百花齐放，已经趋于稳定，基本剩下的都是大厂或者有实力的公司。但独立游戏的梦想让我并不想放弃做移动游戏，因此走上了Unity的移动游戏开发之路。</p>
<h2 id="像素画"><a href="#像素画" class="headerlink" title="像素画"></a>像素画</h2><p>还是按What，Why，How的顺序来学习理解像素画。<br>什么是像素画？(What)<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%83%8F%E7%B4%A0%E7%94%BB">像素画是一种以“像素”（Pixel）为基本单位来制作的电脑绘图表现形式。</a></p>
<p>这里让我们了解两个概念，<strong>位图</strong>和<strong>向量图</strong>。<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%9B%BE">位图（Bitmap），又称栅格图（英语：Raster graphics）或点阵图，是使用像素阵列(Pixel-array&#x2F;Dot-matrix点阵)来表示的图像。</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%9F%A2%E9%87%8F%E5%9B%BE%E5%BD%A2">矢量图形是计算机图形学中用点、直线或者多边形等基于数学方程的几何图元表示图像。矢量图形与使用像素表示图像的位图不同。</a></p>
<p>我个人简单的理解就是位图是存储的原始像素信息，矢量图存的是图形描述信息然后通过计算机栅格化显示出来。两则很重要的一个区别就是前者放大缩小会失真，后者因为是根据图形描述信息动态栅格化计算显示放大缩小出来的不会失真。</p>
<p>为什么会有像素画？(Why)<br><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/pixel-art-academy-1/">像素风格起源于电子游戏，是硬件和显示器技术不发达的时期用来表现画面的一种解决方案。后来随着技术的发展，延伸出越来越多的变种，界限也越来越宽泛。<br>像素风格伴随50年代电子游戏出现而诞生，到了家用机大行其道的FC（Family Computer）时代，更是诞生了大量大家熟知的优秀像素风格游戏作品。<br>正由于这个原因，像素风格往往让人联想到游戏的起源，并且常常被视为游戏文化和复古潮流的象征之一。</a></p>
<p>题外话：<br>个人在做独立游戏的时，美术是个很大的问题，同时游戏开发出来后要想跟大厂的游戏去比画质比游戏性基本是不太可能的，而像素画是一个门槛相对低，对于像素风格复古风格的游戏始终有着自己的一小部分受众，所以像素画是独立游戏的一个不错选择。以前在独立游戏大电影里，了解到了独立游戏FEZ(像素风)一个人花费了大量的时间完成且取得了很大成功的游戏，既有感动，又感受到独立游戏开发之路辛酸。</p>
<p>这里贴一张图以示敬意：<br><img src="/img/GameArt/PixelArtGameFEZ.png" alt="PixelArtGameFEZ"></p>
<p>如何学好像素画？(How)<br>这是一个比较大的问题，这里暂时只提及个人认为从入门到精通需要经历的步骤：</p>
<ol>
<li>找到讲解介绍像素画的网站(找到入门点)</li>
<li>明确自己想学习的方向(想做什么样的像素画，需要学习那些知识)</li>
<li>欲善其事，必先利其器(找到合适的工具)</li>
<li>花费时间去学习了解像素画里的知识和技巧(熟能生巧)</li>
<li>实战运用</li>
</ol>
<h2 id="像素画知识"><a href="#像素画知识" class="headerlink" title="像素画知识"></a>像素画知识</h2><h3 id="像素画分类"><a href="#像素画分类" class="headerlink" title="像素画分类"></a>像素画分类</h3><p>下面的像素画分类信息来源:<br><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/learn-pixel-drawing-by-myself-02/">二维平面像素介绍</a></p>
<ol>
<li>黑白画风<br><img src="/img/GameArt/BlackAndWhitePixelArt.png" alt="BlackAndWhitePixelArt"></li>
<li>复古画风<br><img src="/img/GameArt/FuGuPixelArt.png" alt="FuGuPixelArt"></li>
<li>等距视角画风<br><img src="/img/GameArt/IsometricProjectionPixelArt.png" alt="IsometricProjectionPixelArt"></li>
<li>极简画风<br><img src="/img/GameArt/ExtramSimplePixelArt.png" alt="ExtramSimplePixelArt"></li>
<li>计繁画风<br><img src="/img/GameArt/ComplicatedPixelArt.png" alt="ComplicatedPixelArt"></li>
<li>写实画风<br><img src="/img/GameArt/RealisticPixelArt.png" alt="RealisticPixelArt"></li>
<li>Q萌画风<br><img src="/img/GameArt/QStylePixelArt.png" alt="QStylePixelArt"></li>
<li>油画式画风<br><img src="/img/GameArt/YouHuaStylePixelArt.png" alt="YouHuaStylePixelArt"></li>
<li>光影渲染画风<br><img src="/img/GameArt/LightShadowStylePixelArt.png" alt="LightShadowStylePixelArt"><br>从上面别人的总结讲解来看，考虑到个人美术功底比较差，<strong>复古画风</strong>是一个入门学习的不错选择。</li>
</ol>
<h2 id="像素画技巧"><a href="#像素画技巧" class="headerlink" title="像素画技巧"></a>像素画技巧</h2><h3 id="绘制方法"><a href="#绘制方法" class="headerlink" title="绘制方法"></a>绘制方法</h3><p>下面的绘制方法信息来源:<br><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/learn-pixel-drawing-by-myself-02/">二维平面像素介绍</a></p>
<ol>
<li>绘制线稿法<br><img src="/img/GameArt/HuiZhiXianGaoFaPixelArt.png" alt="HuiZhiXianGaoFaPixelArt"></li>
<li>色块构图法<br><img src="/img/GameArt/SeKuaiGouTuFaPixelArt.png" alt="SeKuaiGouTuFaPixelArt"></li>
<li>缩图修改法<br><img src="/img/GameArt/SuoTuXiuGaiFaPixelArt.png" alt="SuoTuXiuGaiFaPixelArt"><br>从上面别人的总结分享来看，初学入门选择<strong>绘制线稿法</strong>来练习像素画比较全面的学习像素画的各方面技巧。</li>
</ol>
<h2 id="像素画工具"><a href="#像素画工具" class="headerlink" title="像素画工具"></a>像素画工具</h2><p>欲善其事，必先利其器。<br>PC端：</p>
<ol>
<li>PhotoShop<br>相对来说属于功能很强大，但不适合非专业美术人员用于学习像素画，对于像素画比如Animation，Tile等方面支持都并不友好。</li>
<li><a target="_blank" rel="noopener" href="https://www.aseprite.org/docs/">Aseprite</a>(Open Source这一点比较吃惊，付费版$14.99，免费版需要自己编译)<br><a target="_blank" rel="noopener" href="https://github.com/aseprite/aseprite/">Aseprite Github Link</a></li>
<li><a target="_blank" rel="noopener" href="https://pyxeledit.com/about.php">Pyxel Edit</a>(付费 $9.00)<br>参考了网上的观点和对应官方网站的教学视频。个人觉得Asesprite能满足我做像素画以及像素动画的需求，同时官方网站做的比较完善，资料相对完整些，最终决定Asesprite作为像素画入门工具。</li>
</ol>
<p>移动端:<br>Android:<br>8bit Painter<br>IOS:<br>8bit Painter</p>
<p>Note:<br>因为是移动端版本，只适合画一些简单的像素画(工具丰富层度和操作形式限制了)，专业的还是需要在PC端操作(Aseprite软件)。</p>
<h3 id="Aseprite学习"><a href="#Aseprite学习" class="headerlink" title="Aseprite学习"></a>Aseprite学习</h3><p>本人直接购买的付费版，先来张软件截图：<br><img src="/img/GameArt/Aseprite.png" alt="Aseprite"></p>
<h4 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h4><p>通过Edit -&gt; Keyboard Shotcuts修改自定义快捷键<br>Tab – Layer &amp; Frame面板快捷键</p>
<p>可以设置前景色和背景色，左键是前景色，右键是背景色<br>View -&gt; Symetriy Options可以自动对称绘制</p>
<h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><p>这里的工具很多跟PS里很像，这里就不一一讲解了。详细参考教程学习：<a target="_blank" rel="noopener" href="https://www.aseprite.org/docs/tutorial/">Aseprite Tutorial</a></p>
<h4 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h4><p>What is the best size to draw pixel art?<br>根据需要绘制的像素画各部位表现所需的大小来决定最终的画布大小。</p>
<p>Common mistakes in Pixel Art:</p>
<ol>
<li>Doubles<br> <img src="/img/GameArt/DoublesInPixelArt.png" alt="DoublesInPixelArt"><br> 纠正方法：<ul>
<li>启用Pixel-Perfect or 手动Pixel-Perfect<br> <img src="/img/GameArt/PixelPerfectPixelArt.png" alt="PixelPerfectPixelArt"></li>
<li>2px</li>
<li>AA<br> <img src="/img/GameArt/DoublesSolutions.png" alt="DoublesSolutions"></li>
</ul>
</li>
<li>Jaggies(锯齿)<br> <img src="/img/GameArt/JaggiesLine.png" alt="JaggiesLine"><br> 纠正方法:<ul>
<li>连续的图像像素连续数量增加减少要有规律(比如:43211234)</li>
<li>连续的图像像素连续数量有限取小数量的(比如:43211235)<br> <img src="/img/GameArt/NotJaggiesLine.png" alt="NotJaggiesLine"></li>
</ul>
</li>
<li>Outline<br> 确认哪些部分是需要突出的，哪些是不需要突出的。<br> 突出部分可以多加一点像素outline来凸显，不需要突出的部分紧贴着outline即可。</li>
</ol>
<h2 id="像素画实战学习"><a href="#像素画实战学习" class="headerlink" title="像素画实战学习"></a>像素画实战学习</h2><p>前面的一部分学习是参考一下学习网站:<br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Md6W79jtLJM&feature=youtu.be">Mort的系列视频</a></p>
<p>接下来主要根据下面这个网站，一步一步的学习绘制像素画:<br><a target="_blank" rel="noopener" href="https://32comic.com/tag/%E5%85%A5%E9%97%A8/">教你画像素画</a></p>
<p>像素素材网站:<br><a target="_blank" rel="noopener" href="https://indienova.com/resource/tag/pixel-art">像素艺术</a><br><a target="_blank" rel="noopener" href="http://pixeljoint.com/">pixeljoint</a></p>
<p>工具:<br>Asperite</p>
<h3 id="自定义快捷键"><a href="#自定义快捷键" class="headerlink" title="自定义快捷键"></a>自定义快捷键</h3><p>画像素画，快捷键很重要，因为我们需要不断在各种画笔，橡皮檫，取色工具等之间不断的切换。</p>
<p>Edit -&gt; Keyboard Shortcuts自定义快捷键<br>以下几个是比较常见的，为了方便我把默认的Ctrl + Alt形式改成了Shift + Alt的形式。</p>
<ul>
<li>Shift + Alt + B – 画笔</li>
<li>Shift + Alt + E – 橡皮檫</li>
<li>Shift + Alt + C(默认是I，按键隔太远了我改成了C) – 吸取颜色</li>
<li>Shift + Alt + G – 填充整色</li>
<li>Shift + Alt + M – 矩形选中区</li>
<li>Shift + Alt + U – 矩形框选区</li>
<li>Shift + Alt + Z – Undo</li>
<li>Shift + Alt + Y – Redo</li>
<li>Space + 左键 – 移动画布</li>
<li>滚动鼠标 – 放大缩小<br>更多的快捷键根据自己的需求修改，这里就不一一列出了</li>
</ul>
<h3 id="AA-Anti-Aliasing"><a href="#AA-Anti-Aliasing" class="headerlink" title="AA(Anti-Aliasing)"></a>AA(Anti-Aliasing)</h3><p>AA(Anti-Aliasing)即抗锯齿。<br>前面简单的提过如何去通过手动添加绘制完成AA，但为什么像素画需要AA了？<br><a target="_blank" rel="noopener" href="https://32comic.com/2018/05/14/hgt%E5%83%8F%E7%B4%A0%E7%94%BB%E6%95%99%E7%A8%8B%EF%BC%9A%E5%83%8F%E7%B4%A0%E7%94%BB%E6%8A%80%E6%B3%95%E5%9F%BA%E7%A1%80/">像素画不支持半透明，因此抗锯齿的工作只能有画家手工完成。</a></p>
<p>下面通过对比大写的字母A，一个没有AA一个有AA来对比看下效果:<br><img src="/img/GameArt/AAUsing.png" alt="AAUsing"><br>可以看到没有添加AA的因为没有半透明的过度，边缘斜线过度区域很明显很生硬，添加AA后边的柔和不再那么生硬。</p>
<p>AA不仅在于手工的添加上，好的AA颜色选择也是关键所在。<br>AA颜色的选择记住下面几条准则：</p>
<ol>
<li>确定添加AA的地方两侧的颜色信息</li>
<li>中间色选取两侧颜色信息中间的部分<br><img src="/img/GameArt/AAColorChoosen.png" alt="AAColorChoosen"></li>
</ol>
<p>Note:</p>
<ol>
<li>中间色不能过多，太多的话像素画会模糊。</li>
<li>在AA手工抗锯齿的时候，应当尽量避免平行像素(这里的平行像素是指AA自身像素平行)。平行像素会强化锯齿感，缺乏视觉美感。</li>
</ol>
<h3 id="实战绘画步骤"><a href="#实战绘画步骤" class="headerlink" title="实战绘画步骤"></a>实战绘画步骤</h3><ol>
<li>想好要画什么(最好能找到图片模板对照着)</li>
<li>决定像素画画布大小(初期学习绘制最好控制在32X32大小以内)</li>
<li>选择好颜色(考虑好冷色暖色颜色选择以及中间过度的AA颜色)，设置好调色板(palette)</li>
<li>利用基础线条勾勒出基本轮廓(像素画像素是有限的，讲求的是神似而非写实，所以只要勾勒出基本轮廓即可，<strong>化繁为简</strong>)</li>
<li>填充颜色</li>
<li>AA绘制</li>
<li>勾勒高亮和暗部区域</li>
</ol>
<h4 id="实战画动物"><a href="#实战画动物" class="headerlink" title="实战画动物"></a>实战画动物</h4><p>结合上面几个步骤，接下来实战绘制一次：</p>
<ol>
<li>想好要画什么<br>这一步，考虑到初期学习，这里决定画参考文章尝试绘制动物<br><a target="_blank" rel="noopener" href="https://32comic.com/2018/08/17/%E5%83%8F%E7%B4%A0%E7%94%BB%E5%88%9D%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%9A%E9%B8%A1%E7%9A%84%E7%94%BB%E6%B3%95/">像素画初级教程：鸡的画法</a><br>原图:<br><img src="/img/GameArt/Chicken.png" alt="Chicken"></li>
<li>决定好像素画布大小<br>这里考虑初学像素画，决定按32X32的大小来绘制</li>
<li>决定好颜色选择<br>这一步因为有原图，直接吸取原图几个主要颜色作为调色板颜色即可，然后把AA中间色等准备好即可:<br><img src="/img/GameArt/ChikenPalette.png" alt="ChikenPalette"></li>
<li>勾勒基础轮廓<br><img src="/img/GameArt/LunKuo.png" alt="LunKuo"></li>
<li>填充基本色<br><img src="/img/GameArt/TiuanChongJiChuSe.png" alt="TiuanChongJiChuSe"></li>
<li>手动AA<br><img src="/img/GameArt/ChickenAfterAA.png" alt="ChickenAfterAA"></li>
<li>勾勒高亮和暗部区域<br><img src="/img/GameArt/ChikenFinish.png" alt="ChikenFinish"></li>
</ol>
<h4 id="调色板设计与管理"><a href="#调色板设计与管理" class="headerlink" title="调色板设计与管理"></a>调色板设计与管理</h4><p>参考学习文章:<br><a target="_blank" rel="noopener" href="https://32comic.com/2018/07/19/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%AB%98%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%9A%E5%83%8F%E7%B4%A0%E7%94%BB%E8%B0%83%E8%89%B2%E6%9D%BF%E6%8C%87%E5%8D%97/">像素画高级教程：像素画调色板指南</a><br><a target="_blank" rel="noopener" href="https://32comic.com/2018/09/13/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%AB%98%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%9A%E5%83%8F%E7%B4%A0%E7%94%BB%E8%B0%83%E8%89%B2%E6%9D%BF%E8%AE%BE%E8%AE%A1%E5%92%8C%E7%AE%A1%E7%90%86/">像素画高级教程：像素画调色板设计和管理</a><br><a target="_blank" rel="noopener" href="https://32comic.com/2017/09/27/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%A2%9C%E8%89%B2%E5%9F%BA%E7%A1%80%E5%9F%BA%E6%9C%AC%E9%85%8D%E8%89%B2%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D/">像素画颜色基础基本配色方法介绍</a></p>
<p>初学像素画，要想画出的效果好看，除了画的好，好的颜色选择也很关键。<br>这一节主要学习像素画调色板的准备和颜色相关知识，为画好的像素画打好基础。</p>
<h5 id="色相-饱和度-亮度-HSB"><a href="#色相-饱和度-亮度-HSB" class="headerlink" title="色相 &amp; 饱和度 &amp; 亮度(HSB)"></a>色相 &amp; 饱和度 &amp; 亮度(HSB)</h5><p>平时我接触关于颜色的概念，更多是RGB三原色的概念(R - 红色 G - 绿色 B - 蓝色)。<br>接下来让我们学习理解下HSB颜色模式：<br>H(Hue)色相 – 实际颜色(0 - 360)<br>S(Saturation)饱和度 - 颜色的强度或纯度(0 - 100%)<br>B(Brightness)亮度 - 混合颜色的黑色或白色的量(0 - 100%)</p>
<p>这里HSB和之前的RGB是完全不一样的概念，颜色的组成不在是三个颜色的混合结果，而是通过定义色相，饱和度，亮度来决定最终的颜色。</p>
<p>色相可以理解成我们选择的基准颜色，这个基准颜色可以是RGB任何一种组合结果，比如我们选取纯红(RGB - 255,0,0)作为基准色。<br><img src="/img/GameArt/HueBasicColor.png" alt="HueBasicColor"><br>可以看到虽然我们选取了红色作为基准色，但最终的颜色还是纯黑的，这是因为我们设置的B亮度是0导致的。</p>
<p>亮度决定了黑白的颜色量，这里可以理解成白色颜色的占比比重((255,255,255) X 0-1(亮度))，从而影响最终颜色的颜色占比，比如我们设置B亮度50%:<br><img src="/img/GameArt/BasicColorWithHalfBrightness.png" alt="BasicColorWithHalfBrightness"><br>可以看到，我们的色相颜色红色(255,0,0)因为B亮度50%的设置，变成了RBG颜色信息是128,128,128，这真是因为50%的亮度决定了整体颜色的颜色基础值。</p>
<p>看到这里，读者可能会和我有一个相同的疑问，既然亮度决定了颜色值，那么我们设置色相又有什么作用了？<br>H色相是配合S饱和度来起作用的，亮度决定了基调颜色信息，色相和饱和度决定了我们非色相颜色信息的占比。</p>
<p>色相只是决定了我们的基准色，但这个颜色的饱和度是多少了，会决定RGB里我们的非色相颜色的占比。比如此时我们把S饱和度信息设置成50%，我们会看到如下结果:<br><img src="/img/GameArt/BasicColorWithHalfBAndHalfS.png" alt="BasicColorWithHalfBAndHalfS"><br>颜色(128,128,128)因为饱和度50%的设置使得非色相颜色的占比降低了一半，也就是颜色(128,64,64)。</p>
<p>因此我们最终得到的颜色信息是128,64,64。</p>
<p>总结:</p>
<ol>
<li>B亮度决定了基础颜色信息。</li>
<li>H色相决定了主色颜色信息。</li>
<li>S饱和度决定了非主色颜色信息的占比。</li>
<li>三者共同影响颜色的计算得出最终颜色。</li>
</ol>
<p>Note：</p>
<ol>
<li>色相的值范围0-360可以理解成颜色圆盘信息从纯红开始绕360度</li>
<li>饱和度是从外往内递减<br><img src="/img/GameArt/HSBCircle.png" alt="HSBCircle"></li>
<li>亮度第二章图下面的横条<br><img src="/img/GameArt/HSBCircle2.png" alt="HSBCircle2"></li>
</ol>
<h5 id="颜色选择"><a href="#颜色选择" class="headerlink" title="颜色选择"></a>颜色选择</h5><p>颜色有区分冷色和暖色之分：</p>
<ol>
<li>冷色<br>冷色给人冰冷的感觉。<br>蓝绿、蓝青、蓝、蓝紫</li>
<li>暖色<br>暖色给人愉悦和温暖的感觉。<br>红紫、红、橘、黄橘、黄。</li>
<li>中性色<br>紫、绿、黑、白、灰。</li>
</ol>
<p><img src="/img/GameArt/WarmAndColdeColor.png" alt="WarmAndColdeColor"></p>
<p>颜色选择建议：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://32comic.com/2018/04/25/%E5%88%9D%E7%BA%A7%E5%83%8F%E7%B4%A0%E7%94%BB%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/">在一件作品上创建阴影时，最好使用偏冷的颜色。对于最亮的区域，包含更多暖色调显然会更好。</a></li>
<li>选色时要考虑角色个性，场景属性，场景光照颜色等。</li>
<li>新手同一个物品绘制颜色选择不要太多(初期建议控制在10个及以内，最多最好控制在32个以内，颜色越多在颜色选择和管理上花费的时间也就越多)。</li>
<li>选好两个基础色(亮度色和暗部色，然后通过添加两个颜色之间的过渡色完成调色板基础色准备)</li>
<li>过渡色除了亮度和饱和度上的变化，最好还有色相上的变化，相邻颜色过度会比较自然。</li>
<li>颜色饱和度不要过高，高了眼睛看久了会累。</li>
</ol>
<h5 id="自制调色板"><a href="#自制调色板" class="headerlink" title="自制调色板"></a>自制调色板</h5><p>有了前面的颜色概念和选色意见，接下来我们去制作一个用于真正绘制像素画的调色板，实战演练。</p>
<ol>
<li>定两个基准颜色(红色和蓝色)</li>
<li>亮度偏黄色(暖色),暗部偏青色(冷色)</li>
<li>分析光照(假设光照是白色光)</li>
</ol>
<p>开始制作我们的调色板：<br><img src="/img/GameArt/CustomPalette.png" alt="CustomPalette"><br>可以看到主色红色和蓝色有饱和度和明暗度以及色相上的颜色变化。</p>
<h4 id="明暗知识"><a href="#明暗知识" class="headerlink" title="明暗知识"></a>明暗知识</h4><p>参考文章:<br><a target="_blank" rel="noopener" href="https://32comic.com/2017/08/18/%E7%94%BB%E6%98%8E%E6%9A%97%E5%92%8C%E9%85%8D%E8%89%B2tips/">画明暗和配色Tips</a><br><a target="_blank" rel="noopener" href="http://chuansong.me/n/2589343151417">笨办法学像素画：像素画明暗画法指南</a></p>
<p><a target="_blank" rel="noopener" href="https://32comic.com/2017/08/18/%E7%94%BB%E6%98%8E%E6%9A%97%E5%92%8C%E9%85%8D%E8%89%B2tips/">上明暗的时候要兼顾色调变化。最简单的规则就是，亮部的颜色偏暖，暗部的颜色偏冷。</a></p>
<p>文章里明暗画法提到下面3点基础：<br>1、有光源（发出光的东西叫光源）才有明暗，影子位置与光源相反；<br>2、光是一种粒子，会被物体吸收和反射；<br>3、光直射的区域是高光；阴影里面稍亮的区域是反光；</p>
<p>接下来结合文章里绘制立方体来学习绘制明暗。<br>步骤一：<br>准备调色板</p>
<ol>
<li>以土黄色单色为主</li>
<li>明暗上的变化以饱和度和亮度变化为主(单纯绘制明暗，暂时不考虑色相变化)<br><img src="/img/GameArt/MingAnPalette.png" alt="MingAnPalette"></li>
</ol>
<p>步骤二：<br>绘制基础形状外观<br><img src="/img/GameArt/BasicOutline.png" alt="BasicOutline"></p>
<p>步骤三：<br>确定光源位置(假设光源在左侧)，会出暗部和亮部以及影子<br><img src="/img/GameArt/MingAnWhithLight.png" alt="MingAnWhithLight"></p>
<p>步骤四：<br>调整颜色以及细节明暗。<br><img src="/img/GameArt/MingAnFinal.png" alt="MingAnFinal"></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%83%8F%E7%B4%A0%E7%94%BB">像素画</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%9B%BE">位图</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%9F%A2%E9%87%8F%E5%9B%BE%E5%BD%A2">矢量图形</a></p>
<h2 id="Background-knowledge-Part"><a href="#Background-knowledge-Part" class="headerlink" title="Background knowledge Part"></a>Background knowledge Part</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%BB%E5%AD%90%E9%81%8A%E6%88%B2%E5%8F%B2">电子游戏史</a><br><a target="_blank" rel="noopener" href="https://jobyu.gitbooks.io/rpgmakerpixeltutorials/">RPGMaker官方像素画教程</a><br><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/learn-pixel-drawing-by-myself-02/">二维平面像素介绍</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%A1%97%E6%9C%BA">街机</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Game_Boy">Game Boy</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">Game Boy Advanced</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/SFC/99631">SFC</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BB%BB%E5%A4%A9%E5%A0%8264/2619380?fromtitle=N64&fromid=2387227">N64</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/NGC/7005912">NGC</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Wii">Wii</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Wii_U">WiiU</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/PSP/85995">Play Station Portable</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/PlayStation_4">PS4</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%94%B5%E8%84%91%E6%B8%B8%E6%88%8F">电脑游戏</a></p>
<h2 id="Pixel-Art-Part"><a href="#Pixel-Art-Part" class="headerlink" title="Pixel Art Part"></a>Pixel Art Part</h2><p><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/pixel-art-academy-1/">什么是像素画</a><br><a target="_blank" rel="noopener" href="https://32comic.com/tag/%E5%85%A5%E9%97%A8/">教你画像素画</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Md6W79jtLJM&feature=youtu.be">Mort的系列视频</a><br><a target="_blank" rel="noopener" href="https://indienova.com/resource/tag/pixel-art">像素艺术</a><br><a target="_blank" rel="noopener" href="http://pixeljoint.com/">pixeljoint</a></p>
<h2 id="Pixel-Art-Tutorial"><a href="#Pixel-Art-Tutorial" class="headerlink" title="Pixel Art Tutorial"></a>Pixel Art Tutorial</h2><p><a target="_blank" rel="noopener" href="https://32comic.com/2018/07/19/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%AB%98%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%9A%E5%83%8F%E7%B4%A0%E7%94%BB%E8%B0%83%E8%89%B2%E6%9D%BF%E6%8C%87%E5%8D%97/">像素画高级教程：像素画调色板指南</a><br><a target="_blank" rel="noopener" href="https://32comic.com/2018/09/13/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%AB%98%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%9A%E5%83%8F%E7%B4%A0%E7%94%BB%E8%B0%83%E8%89%B2%E6%9D%BF%E8%AE%BE%E8%AE%A1%E5%92%8C%E7%AE%A1%E7%90%86/">像素画高级教程：像素画调色板设计和管理</a><br><a target="_blank" rel="noopener" href="https://32comic.com/2017/09/27/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%A2%9C%E8%89%B2%E5%9F%BA%E7%A1%80%E5%9F%BA%E6%9C%AC%E9%85%8D%E8%89%B2%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D/">像素画颜色基础基本配色方法介绍</a><br><a target="_blank" rel="noopener" href="https://32comic.com/2017/08/18/%E7%94%BB%E6%98%8E%E6%9A%97%E5%92%8C%E9%85%8D%E8%89%B2tips/">画明暗和配色Tips</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a href=""></a><br><a href=""></a><br><a href=""></a><br><a href=""></a><br><a href=""></a><br><a href=""></a><br><a href=""></a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Art/">Art</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Art/">Art</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/04/01/Unity小知识/" title="Unity小知识" itemprop="url">Unity小知识</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2018-04-01T04:24:38.000Z" itemprop="datePublished"> 发表于 2018-04-01</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章只是为了记录一些使用学习Unity过程中的一些能够帮助我们自动化快速完成一些重复工作的小技巧。</p>
<h2 id="Script-Template"><a href="#Script-Template" class="headerlink" title="Script Template"></a>Script Template</h2><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>使用Unity的时候我们难以避免需要创建脚本，平时都是通过Priject -&gt; Right CLick -&gt; Create -&gt; C# Script的形式创建默认的脚本。</p>
<p>默认脚本如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NewBehaviourScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需求决定功能，但默认的脚本模本不足以提供我们想要的结果，比如我们希望自动创建如下的脚本:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             NewBehaviourScript类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/04/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NewBehaviourScript类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NewBehaviourScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们就不需要每次都自己去编写自动化描述相关的内容了。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>如何实现，先让我们来看看，Unity是如何自动化生成NewBehaviourScript.cs脚本的。</p>
<p>让我们打开%EDITORPATH%&#x2F;Data&#x2F;Resources&#x2F;ScriptTemplates&#x2F;路径一探究竟:<br><img src="/img/Unity/UnityScriptTemplate.PNG" alt="UnityScriptTemplate"></p>
<p>可以看到Unity默认的脚本模板是定义在这个路径下的，让我们打开81-C# Script-NewBehaviourScript.cs.txt看看默认的脚本模板是如何定义的:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> #<span class="title">SCRIPTNAME</span># : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        <span class="meta">#NOTRIM#</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">        <span class="meta">#NOTRIM#</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于Unity脚本模板的定义规则，这里没有找到官方的介绍，下面的规则参考了网上的说法:<br><a target="_blank" rel="noopener" href="https://gist.github.com/JoaoBorks/af59720a4baba84f080e2df686cacba2">Custom Unity Script Template</a></p>
<p>但Unity提供的脚本模板Keyword数量有限，所以我们想要创建自己的脚本模本需要分两步走：</p>
<ol>
<li>根据Unity脚本模板规则创建自定义脚本</li>
<li>监听脚本Asset修改保存回调去自动化修改替换自定义Keyword</li>
</ol>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ol>
<li>根据Unity脚本模板规则创建自定义脚本，编写自定义脚本模板<br>81-C# Custom Mono Script Template-NewBehaviourScript.cs.txt</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             #SCRIPTNAME#.cs</span></span><br><span class="line"><span class="comment"> * Author:                  #AUTHOR#</span></span><br><span class="line"><span class="comment"> * Create Date:             #CREATEDATE#</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> #SCRIPTNAME#.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> #<span class="title">SCRIPTNAME</span># : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到通过添加Unity脚本模板，右键创建时已经多了一个模板脚本选择。<br><img src="/img/Unity/CustomScriptTemplateUI.png" alt="CustomScriptTemplateUI"></p>
<ol start="2">
<li>监听脚本Asset创建回调去自动化修改替换自定义Keyword<br>ScriptKeywordProcesser.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             脚本模板自定义Keyword处理脚本</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/04/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Security.Principal;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 脚本模板自定义Keyword处理脚本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ScriptKeywordProcesser</span> : <span class="title">UnityEditor.AssetModificationProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 非用户导入的Asset创建回调(e.g. .meta文件)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnWillCreateAsset</span>(<span class="params"><span class="built_in">string</span> assetpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        assetpath = assetpath.Replace(<span class="string">&quot;.meta&quot;</span>, <span class="built_in">string</span>.Empty);</span><br><span class="line">        <span class="built_in">int</span> index = assetpath.LastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(index &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判定是否是cs脚本</span></span><br><span class="line">        <span class="built_in">string</span> filepostfix = assetpath.Substring(index);</span><br><span class="line">        <span class="keyword">if</span>(!filepostfix.Equals(<span class="string">&quot;.cs&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判定脚本文件是否存在</span></span><br><span class="line">        index = Application.dataPath.LastIndexOf(<span class="string">&quot;Assets&quot;</span>);</span><br><span class="line">        assetpath = Application.dataPath.Substring(<span class="number">0</span>, index) + assetpath;</span><br><span class="line">        <span class="keyword">if</span>(!File.Exists(assetpath))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> filecontent = File.ReadAllText(assetpath);</span><br><span class="line">        filecontent = replaceKeywords(filecontent);</span><br><span class="line">        File.WriteAllText(assetpath, filecontent);</span><br><span class="line">        AssetDatabase.Refresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 替换文本Keyword</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义Keyword替换规则写在这里</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filecontent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">replaceKeywords</span>(<span class="params"><span class="built_in">string</span> filecontent</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> author = WindowsIdentity.GetCurrent().Name;</span><br><span class="line">        <span class="comment">// 只取最终用户名</span></span><br><span class="line">        <span class="keyword">var</span> splashindex = author.IndexOf(<span class="string">&quot;\\&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(splashindex &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            author = author.Substring(<span class="number">0</span>, splashindex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        filecontent = filecontent.Replace(<span class="string">&quot;#AUTHOR#&quot;</span>, author);</span><br><span class="line">        filecontent = filecontent.Replace(<span class="string">&quot;#CREATEDATE#&quot;</span>, DateTime.Now.ToString(<span class="string">&quot;yyyy//MM/dd&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> filecontent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终自动化创建一份MyCustomMonoScript.cs:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MyCustomMonoScript.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/04/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MyCustomMonoScript.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyCustomMonoScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此我们成功创建并支持了自定义关键词的自动化脚本创建，以后再也不用每次都去编写这些固定的文件头了。</p>
<h2 id="Asset-Import-Cache-资源导入缓存"><a href="#Asset-Import-Cache-资源导入缓存" class="headerlink" title="Asset Import Cache(资源导入缓存)"></a>Asset Import Cache(资源导入缓存)</h2><p>在Unity里，我们每次导入或者修改资源都会资源被重新导入。在大的项目里，当大量的资源被其他人修改或者切换平台的时候会导致资源导入的时间很长，这一点是不能接受的。</p>
<p>Unity官方出的Cache Server正式为了减少资源导入，充分利用缓存以及共享导入资源的方式减少导入资源的时间。</p>
<p>先让我们看看，什么是Cache Server。</p>
<h3 id="Cache-Server"><a href="#Cache-Server" class="headerlink" title="Cache Server"></a>Cache Server</h3><p>接下来还是按照What,Why,How的方式循序渐进了解学习Cache Server.</p>
<h4 id="What"><a href="#What" class="headerlink" title="What"></a>What</h4><p>What is Cache Server?(什么是Cache Server?)<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/CacheServer.html">When you enable the Cache Server (see How to set up a Cache Server as a user, below), you can even share Asset imports across multiple projects (that is, the work of importing is done on one computer and the results are shared with others).</a><br>从官方的介绍可以看出，Cache Server是为了共享资源导入的一个工具。</p>
<h4 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h4><p>Why do we use Cache Server?(为什么需要用Cache Server?)<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/CacheServer.html">Unity has a completely automatic Asset<br> pipeline. Whenever a source Asset like a .psd or an .fbx file is modified, Unity detects the change and automatically re-imports it. The imported data from the file is subsequently stored by Unity in an internal format.</a><br>因为Unity会把外部资源根据导入设置导入成一个内部的资源格式来使用，每次资源导入设置或者资源有变化都会导致资源被重新导入一次。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/CacheServer.html">Caching the imported Assets data on the Cache Server drastically reduces the time it takes to import Assets.</a><br>缓存并共享前面说到的资源导入则可以有效的减少资源导入的时间，提高团队工作效率，这也是我们为什么需要Cach Server的主要原因。</p>
<h4 id="How"><a href="#How" class="headerlink" title="How"></a>How</h4><p>How to use Cache Server?(如何使用Cache Server)<br>在了解如何使用Cach Server之前，让我们先了解下Asset在什么情况下会被重新导入：</p>
<ol>
<li>The Asset file itself(Asset自身)</li>
<li>The import settings(导入设置)</li>
<li>Asset importer version(Asset导入版本-这里应该是指Unity版本)</li>
<li>The current platform(资源平台-平时我们切换的Android，IOS，PC这些)<br><strong>当上述4点任何一点被改变的话都会导致资源被重新导入。否则就直接使用Cache Server上缓存的资源导入。</strong></li>
</ol>
<p>如何高效的使用Cach Server了？</p>
<ol>
<li>足够的硬盘空间</li>
<li>高速的读写硬盘(SSD)</li>
<li>足够的网络带宽(最好用于局域网内)</li>
<li>尽量在Linux或者MacOS上使用Cache Server</li>
</ol>
<p>第四个点参考官网描述:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/CacheServer.html">he Cache Server runs optimally on a Linux or Mac OS X computer. The Windows file system is not particularly well-optimized for how the Cache Server stores data, and problems with file locking on Windows can cause issues that don’t occur on Linux or Mac OS X.</a></p>
<p>接下来让我们实战看看如何设置Cache Server:<br>第一步：<br>下载对应Unity版本的Cache Server</p>
<p>Unity对应版本官方的Cache Server链接:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/get-unity/download/archive">Unity 下载存档</a><br><img src="/img/Unity/Unity-Tips/CacheServerDownloadPage.png" alt="CacheServerDownloadPage"><br>最新Cache Server链接是在Github上:<br><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/unity-cache-server">unity-cache-server</a></p>
<p>第二步：<br>运行Cache Server<br>这里我是安装在MacOS上的，所以运行RunOSX.command命令行即可:<br><img src="/img/Unity/Unity-Tips/RunCacheServer.png" alt="RunCacheServer"></p>
<p>第三步：<br>查看Cache Server所在电脑IP(最好能固定Cache Server电脑的IP地址，避免每次去设置)，配置需要使用Cache Server的Unity<br><img src="/img/Unity/Unity-Tips/CacheServerConnect.png" alt="CacheServerConnect"><br>看到Connection Successful就代表我们链接成功了。</p>
<p>接下来我们就可以重用团队或者已经缓存过的Asset导入资源了。</p>
<p>Note:<br>使用Cache Server有哪些需要注意的点了？</p>
<ol>
<li>修改已存在的Material</li>
<li>脚本和一些原始资源(Maya，3D Max直接使用的格式)不会被缓存</li>
</ol>
<h2 id="待续"><a href="#待续" class="headerlink" title="待续"></a>待续</h2><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conceptions-Part"><a href="#Conceptions-Part" class="headerlink" title="Conceptions Part"></a>Conceptions Part</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/CacheServer.html">Cache Server</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a target="_blank" rel="noopener" href="https://gist.github.com/JoaoBorks/af59720a4baba84f080e2df686cacba2">Custom Unity Script Template</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/03/18/导表工具/" title="导表工具" itemprop="url">导表工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2018-03-18T04:30:52.000Z" itemprop="datePublished"> 发表于 2018-03-18</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。</p>
<h1 id="Data-Config"><a href="#Data-Config" class="headerlink" title="Data Config"></a>Data Config</h1><h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>数据配置 – 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。</p>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>那么为什么需要数据配置了？</p>
<ol>
<li>数据是游戏最基本的单位 – 无论是炫酷的特效还是惊人的AI都是通过读取底层数据最终得出结论的。</li>
<li>协同工作 – 这里说的数据配置更多的是游戏逻辑层的数据，即类似游戏里的对话显示，背包单位格子数量上限等配置。有了数据配置，程序和策划很容易协同工作，程序负责数据读取实现功能，策划负责具体的数据配置实现想要的效果。</li>
<li>多语言显示 – 数据配置用于语言包显示也帮助我们很方便的实现多语言的版本(读取不同语言版本的数据配置即可)。</li>
</ol>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><p>实现数据配置读取原理上是把数据序列化导出保存在本地(.xml, .json .bytes……)，然后通过反序列化读取回来。<br>这里我们不单单是针对个别数据进行序列化反序列化。这里要实现的是一个针对表格配置，可以动态生成支持反序列化读取(非反射机制)读取到程序里的工具。</p>
<p>序列化相关知识学习参考<a href="http://tonytang1990.github.io/2015/08/15/CS%E5%AD%A6%E4%B9%A0/#Runtime_Serialization">Runtime Serialization</a><br>PC端Excel读取库选择参考:<a href="http://tonytang1990.github.io/2015/07/15/Unity%E5%AD%A6%E4%B9%A0/#Excel%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96">Excel数据读取</a></p>
<p>Note:<br>这里注意反射和反序列化不是一回事，反序列化可以用反射也可以不用反射来实现。</p>
<h3 id="Functional-Requirement-功能需求"><a href="#Functional-Requirement-功能需求" class="headerlink" title="Functional Requirement(功能需求)"></a>Functional Requirement(功能需求)</h3><ol>
<li>支持int，float，string基础数据配置</li>
<li>支持大于一个维度的数据读取(多余一个的数据)快速读取(比如配置:1;2;3;4分别代表物体随机的生命值选项)(这个算是<strong>基础需求功能</strong>)</li>
<li>支持列表数据自定义数据结构快速读取(<strong>高阶功能需求</strong>，方便列表数据复杂的时候能够抽象成数据结构快速读取。)<br>实际需求举列:<br>我们配置一个道具不同等级的属性加成数据：1+200|2+300;3+400|4+500|5+600 表示第一级加属性id为1的属性加200并且，属性id为2的加300。第二季加属性id为3,4,5的分别加400,500,600)<br>如果我们不能动态创建自定义结构数据，那么我们就需要在代码里写string.split()这种形式的分割数据去判定读取，不论是从性能开销还是代码编写都是很不划算的。<br>如果我们能自动创建自定义结构，生成如下代码:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Property</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Value</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Property[0].Length : 2</span></span><br><span class="line"><span class="comment">// Proeprty[1].Length : 3</span></span><br><span class="line">Property[<span class="number">2</span>][] mPropertyArray;   <span class="comment">// 存储表格数据的成员</span></span><br></pre></td></tr></table></figure>

<p>那么我们就能方便的编写代码去访问特定等级所加成的属性了：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//快速访问特定等级所加成的属性值</span></span><br><span class="line">mPropertyArray[<span class="number">1</span>][<span class="number">2</span>]表示第二级所加成的第二个属性数据</span><br></pre></td></tr></table></figure>

<pre><code>扩展内嵌多层的话(这样的需求应该很少，这里暂时就不考虑了)，此方案需要扩展多维数组来支持，并不是很友好
</code></pre>
<ol start="4">
<li>支持自动生成读表相关代码</li>
<li>内存开销要控制，读取速度要快</li>
<li>跨平台</li>
<li>跨语言</li>
<li>独立于Unity的工具(后期优化部分)</li>
<li>前后端表格数据区分(后期优化部分)(因为前后端往往是读不同的数据，并不需要导同一套表格数据)</li>
</ol>
<h3 id="原理思考"><a href="#原理思考" class="headerlink" title="原理思考"></a>原理思考</h3><p>流程：</p>
<ol>
<li>定义excel表格格式规则(这一步会影响后面所有步骤)</li>
<li>读取excel数据</li>
<li>生成可跨平台跨语言的序列化代码</li>
<li>序列化写入excel数据(这一步涉及跨语言问题)</li>
<li>反序列化读取数据</li>
</ol>
<ul>
<li><p>定义excel表格格式规则<br>这一步要决定我们excel长什么样子，决定不同数据不同的行号字段代表什么。</p>
</li>
<li><p>读取excel数据<br>通过第三方库(比如PC端跨平台的<a target="_blank" rel="noopener" href="http://exceldatareader.codeplex.com/">ExcelRead</a>)可以解决读取问题。</p>
</li>
<li><p>生成跨平台跨语言的序列化反序列化代码<br>这一步的重点在于跨平台和<br>跨平台这一点肯定不用说，要想在PC端序列化的数据在移动端使用，这一点是必须的也并不是难点。<br><strong>跨语言</strong>这一点上，试想如果前后端用的语言不同，但前后端想共用一份导表工具来生成需要的表格数据，那么跨语言这一点就是必须的了。<br>序列化数据和反序列化数据时，我们需要考虑跨语言的问题，后续的方案中就会强调这一点。</p>
</li>
<li><p>序列化写入excel数据<br>写入数据也就是序列化的过程，解决了前面提到的跨语言生成序列化代码问题后，这个问题也就迎刃而解。</p>
</li>
<li><p>反序列化读取数据<br>读数据就是反序列化的过程，同理序列化，解决了跨语言生成序列化代码的问题，这个问题依然不是问题。</p>
</li>
</ul>
<h3 id="方案比较"><a href="#方案比较" class="headerlink" title="方案比较"></a>方案比较</h3><ol>
<li>C# .Net BinaryFormatter(不夸语言，序列化后数据相对大，反序列化费时且内存开销大)</li>
<li>ProtoBuff(跨语言，序列化数据相对小，反序列化费时和内存开销相对好点。工具成熟，社区完善，自定义数据结构方便)</li>
<li>FlatBuff(跨语言，序列化数据小，反序列化费时少，编写自定义序列化和反序列化数据结构不方便)</li>
<li>XBuffer(之前一位同事写的基于C#的简化版FlatBuff，高效且高度支持扩展和配置)</li>
</ol>
<p>接下来针对各个方案进行简单学习，理解各自的优缺点。</p>
<h4 id="C-Net-BinaryFormatter"><a href="#C-Net-BinaryFormatter" class="headerlink" title="C# .Net BinaryFormatter"></a>C# .Net BinaryFormatter</h4><p>参考这篇文章：<a href="blog.csdn.net/qq_14903317/article/details/78637440">Unity C#配置表工具</a></p>
<p>我们可以看到，我们需要做的事情有以下几步：</p>
<ol>
<li>定义excel表格格式规则</li>
<li>从excel中读取数据</li>
<li>根据数据类型，动态生成每个表的C#类(用于反序列化读取数据)</li>
<li>动态编译C#类，输出一个动态库以及相关代码</li>
<li>实例化C#类，并且把数据填入到实例化对象中，序列化数据，保存在Untiy本地Resources目录中</li>
<li>运行时，通过生成的C#类反序列化加载并创建对应实例化对象去存储数据</li>
</ol>
<p>Utilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 工具静态类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Utilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 本机打开特定目录(暂时只用于Windows)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;folderPath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenFolder</span>(<span class="params"><span class="built_in">string</span> folderPath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(folderPath))</span><br><span class="line">        &#123;</span><br><span class="line">            ProcessStartInfo startInfo = <span class="keyword">new</span> ProcessStartInfo(folderPath, <span class="string">&quot;explorer.exe&quot;</span>);</span><br><span class="line">            Process.Start(startInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            UnityEngine.Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; Directory does not exist!&quot;</span>, folderPath));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查指定目录是否存在，不存在创建一个</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkOrCreateSpecificFolder</span>(<span class="params"><span class="built_in">string</span> folderpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.CreateDirectory(folderpath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 无论目录是否存在都删除所有文件重新创建一个目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">recreateSpecificFolder</span>(<span class="params"><span class="built_in">string</span> folderpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.Delete(folderpath, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Directory.CreateDirectory(folderpath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取文件的目录名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filepath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">getFileFolderName</span>(<span class="params"><span class="built_in">string</span> filepath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Path.GetFileName(Path.GetDirectoryName(filepath));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PathUtilites.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 路径静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PathUtilties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Excel Data</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据文件夹目录路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelFileFolderPath = Application.dataPath + <span class="string">&quot;/../ExcelDatas/Game/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据生成的对应代码目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 因为序列化反序列化时要求Assemble信息一致，所以如果反序列化使用Unity 编译后的C#无法成功反序列化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BinderToType低版本.Net可以用但BinderToName要求.Net 4.0</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所以这里放弃了直接生成新的cs表代码通过Unity编译使用的方案，选择依然采用直接编译表代码成dll来使用</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表代码依然生成，但放到Asset外部作为非有效代码存储方便查看</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 参考:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> https://stackoverflow.com/questions/505611/binary-deserialization-with-different-assembly-version</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> https://www.codeproject.com/Tips/1101106/How-to-serialize-across-assemblies-with-the-Binary</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptOutputFolderPath = Application.dataPath + <span class="string">&quot;/../DataConfigScripts/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据序列化后的文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelDataFileName = <span class="string">&quot;dataconfig.byte&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据序列化后的数据文件存储目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelDataFileOutputFolderPath = Application.dataPath + <span class="string">&quot;/Resources/DataConfig/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据序列化后的数据文件相对于Resource目录的相对目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelDataFileOutputFolderRelativePath = <span class="string">&quot;DataConfig/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据生成的对应Assembly&amp;Script临时文件临时目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptAssemblyFilePath = Application.dataPath + <span class="string">&quot;/Scripts/Core/DataConfig/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据生成的对应Assembly临时文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptAssemblyFileName = <span class="string">&quot;dataconfig.dll&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表格代码文件后缀</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptFilePostFix = <span class="string">&quot;.cs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表格生成数据管理读取代码文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptDataManagerFileName = <span class="string">&quot;DataManager.cs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表代码Container后缀名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelTableContainerPostfix = <span class="string">&quot;Container&quot;</span>;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ExportExcelData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Excel;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> Microsoft.CSharp;</span><br><span class="line"><span class="keyword">using</span> System.CodeDom.Compiler;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 表格数据抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConfigData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Type;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字段名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 导表工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExportExcelData</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字段名行号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> NameLineNumber = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字段类型行号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> TypeLineNumber = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据开始行号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> DataLineNumber = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 有效的数据类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="built_in">string</span>&gt; ValideTypesList =  <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;(<span class="keyword">new</span> <span class="built_in">string</span>[]&#123;<span class="string">&quot;int&quot;</span>, <span class="string">&quot;float&quot;</span>, <span class="string">&quot;string&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Tools/DataConfig/导出所有表格数据&quot;</span>, false, 100)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exportAllExcelData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span>[] excelfiles = Directory.GetFiles(PathUtilties.ExcelFileFolderPath, <span class="string">&quot;*.xlsx&quot;</span>);</span><br><span class="line">        <span class="comment">// 表格数据映射Map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为表格对应的数据列表，List的每一个元素代表一行的数据数组</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, List&lt;ConfigData[]&gt;&gt; datadic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;ConfigData[]&gt;&gt;();</span><br><span class="line">        <span class="comment">// 字段信息map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为对应表格的字段数据</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; namedic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;();</span><br><span class="line">        <span class="comment">// 字段类型信息map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为对应表格的字段类型数据</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; typedic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> excelfile <span class="keyword">in</span> excelfiles)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!readAllDataFromExcelFile(excelfile, <span class="keyword">ref</span> datadic, <span class="keyword">ref</span> typedic, <span class="keyword">ref</span> namedic))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 表格代码映射map</span></span><br><span class="line">        <span class="comment">// Key为类名字，Value为对应代码数据</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; codemap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="comment">//根据刚才记录的每一张表格数据生成对应代码数据</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datadic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> classname = data.Key;</span><br><span class="line">            DataConfigScriptGenerator dcsg = <span class="keyword">new</span> DataConfigScriptGenerator(classname, typedic[classname], namedic[classname]);</span><br><span class="line">            codemap.Add(classname, dcsg.generateCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除前一次所有相关文件</span></span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelScriptOutputFolderPath);</span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelDataFileOutputFolderPath);</span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelScriptAssemblyFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成dll，Assemble文件用于序列化数据</span></span><br><span class="line">        <span class="built_in">string</span>[] scripts = <span class="keyword">new</span> <span class="built_in">string</span>[codemap.Values.Count];</span><br><span class="line">        codemap.Values.CopyTo(scripts, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">var</span> assemblyfilepath = PathUtilties.ExcelScriptAssemblyFilePath + PathUtilties.ExcelScriptAssemblyFileName;</span><br><span class="line">        Assembly assembly = compileCode(scripts, assemblyfilepath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (assembly == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;编译dll失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用Assemble序列化数据</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datadic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">object</span> container = assembly.CreateInstance(data.Key + <span class="string">&quot;Container&quot;</span>);</span><br><span class="line">            Type classtype = assembly.GetType(data.Key);</span><br><span class="line">            <span class="keyword">if</span> (!serialize(container, classtype, data.Value, PathUtilties.ExcelDataFileOutputFolderPath))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对应Manager加载管理的cs代码文件</span></span><br><span class="line">        createDataManager(assembly, PathUtilties.ExcelScriptAssemblyFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对应cs代码文件(如果删除dll，使用cs编译的Assembly-CSharp.dll会导致反序列化出问题。猜测是因为Assemly名字改变后，默认的序列化和反序列化的部分信息(e.g. 比如assembly name)对不上。)</span></span><br><span class="line">        <span class="comment">// 所以这里生成的代码仅供查看，释放到Asset上层目录的</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> code <span class="keyword">in</span> codemap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (FileStream fs = File.Create(PathUtilties.ExcelScriptOutputFolderPath + code.Key + PathUtilties.ExcelScriptFilePostFix))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] info = <span class="keyword">new</span> UTF8Encoding(<span class="literal">true</span>).GetBytes(code.Value);</span><br><span class="line">                fs.Write(info, <span class="number">0</span>, info.Length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除Assemble文件</span></span><br><span class="line">        <span class="comment">//File.Delete(assemblyfilepath);</span></span><br><span class="line"></span><br><span class="line">        AssetDatabase.Refresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取excel里所有数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;excelfile&quot;&gt;</span>excel文件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datadic&quot;&gt;</span>表格数据<span class="doctag">&lt;/param&gt;</span>]</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;names&quot;&gt;</span>字段数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typs&quot;&gt;</span>类型数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">readAllDataFromExcelFile</span>(<span class="params"><span class="built_in">string</span> excelfile, <span class="keyword">ref</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;ConfigData[]&gt;&gt; datadic, <span class="keyword">ref</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; typesmap, <span class="keyword">ref</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; namesmap</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;excelfile: &#123;0&#125;&quot;</span>, excelfile));</span><br><span class="line">        FileStream fs = File.Open(excelfile, FileMode.Open, FileAccess.Read);</span><br><span class="line">        IExcelDataReader excelreader = ExcelReaderFactory.CreateOpenXmlReader(fs);</span><br><span class="line">        <span class="keyword">if</span> (!excelreader.IsValid)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel文件:&#123;0&#125;读取失败！&quot;</span>, excelfile));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel文件.Name:&#123;0&#125;&quot;</span>, excelreader.Name));</span><br><span class="line">            <span class="keyword">var</span> dataset = excelreader.AsDataSet();</span><br><span class="line">            <span class="keyword">if</span> (dataset.Tables.Count &gt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel文件:&#123;0&#125;,不允许一个Excel多张Table!&quot;</span>, excelreader.Name));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (datadic.ContainsKey(excelreader.Name))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;有同名的Excel Table存在!同名Excel:&#123;0&#125;!&quot;</span>, excelreader.Name));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> currentlinenumber = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">string</span>[] types = <span class="literal">null</span>;</span><br><span class="line">                <span class="built_in">string</span>[] names = <span class="literal">null</span>;</span><br><span class="line">                datadic.Add(excelreader.Name, <span class="keyword">new</span> List&lt;ConfigData[]&gt;());</span><br><span class="line">                <span class="keyword">while</span>(excelreader.Read())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//读取每一行的数据</span></span><br><span class="line">                    <span class="built_in">string</span>[] datas = <span class="keyword">new</span> <span class="built_in">string</span>[excelreader.FieldCount];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; excelreader.FieldCount; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        datas[i] = excelreader.GetString(i);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 字段信息</span></span><br><span class="line">                    <span class="keyword">if</span> (currentlinenumber == NameLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        names = datas;</span><br><span class="line">                        <span class="keyword">if</span>(checkRepeatedNameString(names))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel Table:&#123;0&#125;&quot;</span>, excelreader.Name));</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        namesmap.Add(excelreader.Name, names);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 字段类型信息</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>(currentlinenumber == TypeLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        types = datas;</span><br><span class="line">                        <span class="keyword">if</span> (checkInvalideType(types))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel Table:&#123;0&#125;&quot;</span>, excelreader.Name));</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        typesmap.Add(excelreader.Name, types);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>(currentlinenumber &gt;= DataLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 记录每一行所有数据的字段名，字段类型，字段数据</span></span><br><span class="line">                        ConfigData[] configdatas = <span class="keyword">new</span> ConfigData[datas.Length];</span><br><span class="line">                        <span class="keyword">for</span>(<span class="built_in">int</span> m = <span class="number">0</span>; m &lt; datas.Length; m++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            ConfigData cd = <span class="keyword">new</span> ConfigData();</span><br><span class="line">                            cd.Type = types[m];</span><br><span class="line">                            cd.Name = names[m];</span><br><span class="line">                            cd.Data = datas[m];</span><br><span class="line">                            <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(cd.Type))</span><br><span class="line">                            &#123;</span><br><span class="line">                                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;数据第&#123;0&#125;行，第&#123;1&#125;列字段类型不能为空!&quot;</span>, currentlinenumber, m));</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(cd.Name))</span><br><span class="line">                            &#123;</span><br><span class="line">                                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;数据第&#123;0&#125;行，第&#123;1&#125;列字段名字不能为空!&quot;</span>, currentlinenumber, m));</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            configdatas[m] = cd;</span><br><span class="line">                        &#125;</span><br><span class="line">                        datadic[excelreader.Name].Add(configdatas);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;无效的行号:&#123;0&#125;&quot;</span>, currentlinenumber));</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    currentlinenumber++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查是否有重复的字段名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;names&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">checkRepeatedNameString</span>(<span class="params"><span class="built_in">string</span>[] names</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> tempdic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> name <span class="keyword">in</span> names)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tempdic.ContainsKey(name))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;同名字段:&#123;0&#125;!&quot;</span>, name));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                tempdic.Add(name, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查是否有无效的字段类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;types&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">checkInvalideType</span>(<span class="params"><span class="built_in">string</span>[] types</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!ValideTypesList.Contains(type))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;无效类型:&#123;0&#125;&quot;</span>, type));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 编译代码到dll</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scripts&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputfile&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>返回Assembly<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Assembly <span class="title">compileCode</span>(<span class="params"><span class="built_in">string</span>[] scripts, <span class="built_in">string</span> outputfile</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//编译参数</span></span><br><span class="line">        CSharpCodeProvider codeprovider = <span class="keyword">new</span> CSharpCodeProvider();</span><br><span class="line">        CompilerParameters objcompilerparameters = <span class="keyword">new</span> CompilerParameters();</span><br><span class="line">        objcompilerparameters.ReferencedAssemblies.AddRange(<span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;System.dll&quot;</span> &#125;);</span><br><span class="line">        objcompilerparameters.OutputAssembly = outputfile;</span><br><span class="line">        objcompilerparameters.GenerateExecutable = <span class="literal">false</span>;</span><br><span class="line">        objcompilerparameters.GenerateInMemory = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始编译脚本</span></span><br><span class="line">        CompilerResults cr = codeprovider.CompileAssemblyFromSource(objcompilerparameters, scripts);</span><br><span class="line">        <span class="keyword">if</span> (cr.Errors.HasErrors)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;编译错误：&quot;</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (CompilerError err <span class="keyword">in</span> cr.Errors)</span><br><span class="line">                Debug.LogError(err.ErrorText);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cr.CompiledAssembly;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;container&quot;&gt;</span>数据容器对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>数据Class类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datalist&quot;&gt;</span>数据列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputpath&quot;&gt;</span>输出目录<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">serialize</span>(<span class="params"><span class="built_in">object</span> container, Type type, List&lt;ConfigData[]&gt; datalist, <span class="built_in">string</span> outputpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        FieldInfo dictInfo = container.GetType().GetField(<span class="string">&quot;Dict&quot;</span>);</span><br><span class="line">        <span class="built_in">object</span> dict = dictInfo.GetValue(container);</span><br><span class="line">        <span class="comment">//读取每一行数据并填充到实例对象里</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> datas <span class="keyword">in</span> datalist)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">object</span> instance = type.Assembly.CreateInstance(type.FullName);</span><br><span class="line">            <span class="comment">//填充实例对象数据</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datas)</span><br><span class="line">            &#123;</span><br><span class="line">                FieldInfo fieldinfo = type.GetField(data.Name);</span><br><span class="line">                fieldinfo.SetValue(instance, parseValue(data.Type, data.Data));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将实例对象数据添加到Container Map里，后续用于序列化数据</span></span><br><span class="line">            <span class="built_in">object</span> id = type.GetField(<span class="string">&quot;id&quot;</span>).GetValue(instance);</span><br><span class="line">            <span class="built_in">bool</span> isExist = (<span class="built_in">bool</span>)dict.GetType().GetMethod(<span class="string">&quot;ContainsKey&quot;</span>).Invoke(dict, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; id &#125;);</span><br><span class="line">            <span class="keyword">if</span> (isExist)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">&quot;Repetitive key &quot;</span> + id + <span class="string">&quot; in &quot;</span> + container.GetType().Name);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            dict.GetType().GetMethod(<span class="string">&quot;Add&quot;</span>).Invoke(dict, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; id, instance &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将数据序列化到本地文件</span></span><br><span class="line">        <span class="keyword">var</span> bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">        <span class="keyword">var</span> s = <span class="keyword">new</span> FileStream(outputpath + type.Name + <span class="string">&quot;.bytes&quot;</span>, FileMode.CreateNew, FileAccess.Write);</span><br><span class="line">        bf.Serialize(s, container);</span><br><span class="line">        s.Close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建生成反序列化加载接口代码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assembly&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputpath&quot;&gt;</span>输出路径<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">createDataManager</span>(<span class="params">Assembly assembly, <span class="built_in">string</span> outputpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        StringBuilder source = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        source.Append(<span class="string">&quot;/*\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\tAuto create\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\tDon&#x27;t Edit it\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;*/\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        source.Append(<span class="string">&quot;using System;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using UnityEngine;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using System.Runtime.Serialization;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using System.Runtime.Serialization.Formatters.Binary;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using System.IO;\n\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;[Serializable]\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;public class DataManager : SingletonTemplate&lt;DataManager&gt;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义所有Container的成员变量</span></span><br><span class="line">        <span class="keyword">var</span> types = assembly.GetTypes();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!type.Name.EndsWith(PathUtilties.ExcelTableContainerPostfix))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            source.Append(<span class="string">&quot;\tpublic &quot;</span> + type.Name + <span class="string">&quot; &quot;</span> + type.Name.Remove(<span class="number">0</span>, <span class="number">2</span>) + <span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        source.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//加载所有配置表</span></span><br><span class="line">        source.Append(<span class="string">&quot;\tpublic void loadAll()\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!type.Name.EndsWith(<span class="string">&quot;Container&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">string</span> typeName = type.Name.Remove(type.Name.IndexOf(<span class="string">&quot;Container&quot;</span>));</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&quot;</span> + type.Name.Remove(<span class="number">0</span>, <span class="number">2</span>) + <span class="string">&quot; = Load(&quot;</span> + <span class="string">&#x27;&quot;&#x27;</span> + typeName + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&quot;) as &quot;</span> + type.Name + <span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化接口方法</span></span><br><span class="line">        source.Append(<span class="string">&quot;\tprivate System.Object Load(string name)\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tvar bf = new BinaryFormatter();\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tTextAsset text = Resources.Load&lt;TextAsset&gt;(&quot;</span> + <span class="string">&#x27;&quot;&#x27;</span> + PathUtilties.ExcelDataFileOutputFolderRelativePath + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&quot; + name);\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tStream s = new MemoryStream(text.bytes);\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tSystem.Object obj = bf.Deserialize(s);\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\ts.Close();\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\treturn obj;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 数据加载接口</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (type.Name.EndsWith(<span class="string">&quot;Container&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> classname = type.Name;</span><br><span class="line">            source.Append(<span class="string">&quot;\t\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\tpublic &quot;</span> + classname + <span class="string">&quot; get&quot;</span> + classname.Substring(<span class="number">2</span>) + <span class="string">&quot;Data(int id)\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&quot;</span> + classname + <span class="string">&quot; data = null;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&quot;</span> + classname.Substring(<span class="number">2</span>) + <span class="string">&quot;Container.getMap().TryGetValue(id, out data);\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\tif(data == null)\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&#123;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t\tDebug.LogError(string.Format(\&quot;表格:&#123; 0&#125;找不到id: &#123; 1&#125;的数据!\&quot;, data.GetType().ToString(), id));\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&#125;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\treturn data;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        source.Append(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存脚本</span></span><br><span class="line">        StreamWriter sw = <span class="keyword">new</span> StreamWriter(outputpath + PathUtilties.ExcelScriptDataManagerFileName);</span><br><span class="line">        sw.WriteLine(source.ToString());</span><br><span class="line">        sw.Close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据字符串解析类型(暂时只支持基础类型)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">object</span> <span class="title">parseValue</span>(<span class="params"><span class="built_in">string</span> type, <span class="built_in">string</span> data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (type.Equals(<span class="string">&quot;string&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type.Equals(<span class="string">&quot;int&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">int</span>.Parse(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type.Equals(<span class="string">&quot;float&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">float</span>.Parse(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;类型字符串:&#123;0&#125;不支持该类型数据解析!&quot;</span>, type));</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataConfigScriptGenerator.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 导表代码生成工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataConfigScriptGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 类名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ClassName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 成员字段类型数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>[] TypeDatas</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 成员字段名字数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>[] TypeNameDatas</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataConfigScriptGenerator</span>(<span class="params"><span class="built_in">string</span> classname, <span class="built_in">string</span>[] typedatas, <span class="built_in">string</span>[] typenamedatas</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ClassName = classname;</span><br><span class="line">        TypeDatas = typedatas;</span><br><span class="line">        TypeNameDatas = typenamedatas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成对应表代码外部接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">generateCode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(ClassName) || TypeDatas == <span class="literal">null</span> || TypeNameDatas == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> generateRealCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成表代码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">generateRealCode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//生成类文件头</span></span><br><span class="line">        StringBuilder classsource = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        classsource.Append(<span class="string">&quot;/*\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tAuto create\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tDon&#x27;t Edit it\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;*/\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;using System;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;using System.Reflection;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;using System.Collections.Generic;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;[Serializable]\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;public class &quot;</span> + ClassName + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成成员声明数据</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; TypeDatas.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            classsource.Append(filedString(TypeDatas[i], TypeNameDatas[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成Container</span></span><br><span class="line">        classsource.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;[Serializable]\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;public class &quot;</span> + ClassName + PathUtilties.ExcelTableContainerPostfix + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tpublic &quot;</span> + <span class="string">&quot;Dictionary&lt;int, &quot;</span> + ClassName + <span class="string">&quot;&gt;&quot;</span> + <span class="string">&quot; Dict&quot;</span> + <span class="string">&quot; = new Dictionary&lt;int, &quot;</span> + ClassName + <span class="string">&quot;&gt;();\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tpublic &quot;</span> + <span class="string">&quot;Dictionary&lt;int, &quot;</span> + ClassName + <span class="string">&quot;&gt;&quot;</span> + <span class="string">&quot; getMap()\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\t\treturn Dict;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> classsource.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 成员声明数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>成员类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;field&quot;&gt;</span>成员名<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">filedString</span>(<span class="params"><span class="built_in">string</span> type, <span class="built_in">string</span> field</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(type) || <span class="built_in">string</span>.IsNullOrEmpty(field))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        StringBuilder sbProperty = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sbProperty.Append(<span class="string">&quot;\tpublic &quot;</span> + type + <span class="string">&quot; &quot;</span> + field + <span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sbProperty.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让我们来看看最终的结果：<br>game.xlsx<br><img src="/img/Unity/ExcelDataConfig.PNG" alt="ExcelDataConfig"></p>
<p><img src="/img/Unity/DataConfigData.PNG" alt="DataConfigData"></p>
<p>t_game.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Auto create</span></span><br><span class="line"><span class="comment">    Don&#x27;t Edit it</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> author;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> sex;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> money;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_gameContainer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_game&gt; Dict = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, t_game&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_game&gt; <span class="title">getMap</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Dict;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Auto create</span></span><br><span class="line"><span class="comment">    Don&#x27;t Edit it</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">DataManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> t_gameContainer gameContainer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        gameContainer = Load(<span class="string">&quot;t_game&quot;</span>) <span class="keyword">as</span> t_gameContainer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> System.<span class="function">Object <span class="title">Load</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">        TextAsset text = Resources.Load&lt;TextAsset&gt;(<span class="string">&quot;DataConfig/&quot;</span> + name);</span><br><span class="line">        Stream s = <span class="keyword">new</span> MemoryStream(text.bytes);</span><br><span class="line">        System.Object obj = bf.Deserialize(s);</span><br><span class="line">        s.Close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> t_game <span class="title">getgameData</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        t_game data = <span class="literal">null</span>;</span><br><span class="line">        gameContainer.getMap().TryGetValue(id, <span class="keyword">out</span> data);</span><br><span class="line">        <span class="keyword">if</span>(data == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;表格:&#123; 0&#125;找不到id: &#123; 1&#125;的数据!&quot;</span>, data.GetType().ToString(), id));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在Unity里测试读取和打印:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GUILayout.BeginHorizontal();</span><br><span class="line"><span class="keyword">if</span> (GUILayout.Button(<span class="string">&quot;加载所有表格数据&quot;</span>, GUILayout.MaxWidth(<span class="number">250.0f</span>), GUILayout.MaxHeight(<span class="number">50.0f</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">&quot;加载所有表格数据&quot;</span>);</span><br><span class="line">    DataManager.Singleton.loadAll();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (GUILayout.Button(<span class="string">&quot;打印所有表格数据&quot;</span>, GUILayout.MaxWidth(<span class="number">250.0f</span>), GUILayout.MinHeight(<span class="number">50.0f</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">&quot;打印所有表格数据&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt;= DataManager.Singleton.gameContainer.Dict.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> data = DataManager.Singleton.getgameData(i);</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;data.id : &#123;0&#125;, data.author : &#123;1&#125;, data.age : &#123;2&#125;, data.sex : &#123;3&#125;, data.money : &#123;4&#125;&quot;</span>, data.id, data.author, data.age, data.sex, data.money));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">GUILayout.EndHorizontal();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/DataConfigResult.PNG" alt="DataConfigResult"></p>
<p>就这样我们成功的通过读取表格数据，生成对应代码，序列化数据，然后通过生成的对应表代码反序列化读取出数据就基本完成了。</p>
<p>遇到的问题:<br>第三步动态编译dll进行序列化反序列化，这一步本来想最终不使用dll而是跟着Unity参与编译的代码来反序列化，但是反序列化出现了问题。</p>
<p>错误信息:<br>SerializationExeption: could not find type ‘System.Collections.Generic.Dictionary’ **</p>
<p>个人猜测因为序列化反序列化时要求Assemble信息一致，所以如果反序列化使用Unity 编译后的C#无法成功反序列化</p>
<p>网上相关问题:<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/505611/binary-deserialization-with-different-assembly-version">SerializationException: Could not find type ‘System.Collections.Generic.List’1 in c# untiy3d</a><br><a target="_blank" rel="noopener" href="https://www.codeproject.com/Tips/1101106/How-to-serialize-across-assemblies-with-the-Binary">How to Serialize Across Assemblies with the BinaryFormatter</a></p>
<p>但考虑到BinderToType低版本.Net可以用但BinderToName要求.Net 4.0，所以这里放弃了直接生成新的cs表代码通过Unity编译使用的方案，选择依然采用直接编译表代码成dll来使用。<br>表代码依然生成，但放到Asset外部作为非有效代码存储方便查看</p>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><ol>
<li>C#反序列化默认是反射实现的，速度会比较慢，可以考虑实现自定义反序列化加快读取速度，参考：<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Runtime_Serialization">Runtime_Serialization</a><br>测试方式:</li>
</ol>
<ul>
<li>序列化同一个类型对象500次并反序列化500次</li>
<li>打印记录反序列化的内存和时间开销<br>测试代码:</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">long</span> mHeapMemorySize;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 显示堆内存使用准备工作(在调用ShowHeapMemoryUsing打印堆内存分配之前调用此方法确保计算显示的堆内存数据申请正确)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TonyTangShowHeapMemoryUsingPrepration</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 确保得到正确的起始Heap Memory Size</span></span><br><span class="line">    GC.Collect();</span><br><span class="line">    mHeapMemorySize = GC.GetTotalMemory(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 显示堆内存使用情况</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;postfix&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TonyTangShowHeapMemoryUsing</span>(<span class="params"><span class="built_in">string</span> postfix</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> newestheapmemorysize = GC.GetTotalMemory(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">var</span> heapmemoryoffset = newestheapmemorysize - mHeapMemorySize;</span><br><span class="line">    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;Heap Memory Size = &#123;0&#125; Pre Memory Size = &#123;1&#125; Memory Offset = &#123;2&#125; -- &#123;3&#125;&quot;</span>, newestheapmemorysize, mHeapMemorySize, heapmemoryoffset, postfix));</span><br><span class="line">    mHeapMemorySize = newestheapmemorysize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Note:</span></span><br><span class="line"><span class="comment">//注释掉的部分就是自定义序列化和反序列化的代码部分</span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Map</span> <span class="comment">//: ISerializable, IDeserializationCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Special construct(required by ISerializable) to control deserialization</span></span><br><span class="line">    <span class="comment">//[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]</span></span><br><span class="line">    <span class="comment">//protected Map(SerializationInfo info, StreamingContext context)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    m_SiInfo = info;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]</span></span><br><span class="line">    <span class="comment">//public virtual void GetObjectData(SerializationInfo info, StreamingContext context)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    info.AddValue(&quot;mID&quot;, mID);</span></span><br><span class="line">    <span class="comment">//    info.AddValue(&quot;mMapName&quot;, mMapName);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//void IDeserializationCallback.OnDeserialization(Object sender)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    if (m_SiInfo == null)</span></span><br><span class="line">    <span class="comment">//    &#123;</span></span><br><span class="line">    <span class="comment">//        return;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    mID = m_SiInfo.GetInt32(&quot;mID&quot;);</span></span><br><span class="line">    <span class="comment">//    mMapName = m_SiInfo.GetString(&quot;mMapName&quot;);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//private SerializationInfo m_SiInfo;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Map</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mID = <span class="number">0</span>;</span><br><span class="line">        mMapName = <span class="string">&quot;DefaultMap&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mID;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mID = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> MapName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mMapName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMapName = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mMapName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Serialization</span></span><br><span class="line"><span class="built_in">string</span> mMapSavePath = <span class="string">&quot;./mapInfo.dat&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="built_in">int</span> id = <span class="number">0</span>; id &lt; <span class="number">500</span>; id++)</span><br><span class="line">&#123;</span><br><span class="line">    Map map = <span class="keyword">new</span> Map();</span><br><span class="line">    map.ID = id;</span><br><span class="line">    map.MapName = id.ToString();</span><br><span class="line">    BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">    <span class="keyword">var</span> mapsavepath = mMapSavePath + id;</span><br><span class="line">    <span class="keyword">if</span> (!File.Exists(mapsavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream fsc = File.Create(mapsavepath);</span><br><span class="line">        fsc.Close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileStream fs = File.Open(mapsavepath, FileMode.Open);</span><br><span class="line">    bf.Serialize(fs, map);</span><br><span class="line">    fs.Close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">ShowHeapMemoryUsingPrepration();</span><br><span class="line">TimeCounter.Singleton.Restart(<span class="string">&quot;Deserialization&quot;</span>);</span><br><span class="line">Map mDSMap;</span><br><span class="line">BinaryFormatter dsbf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> id = <span class="number">0</span>; id &lt; <span class="number">500</span>; id++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> mapsavepath = mMapSavePath + id;</span><br><span class="line">    <span class="keyword">if</span> (File.Exists(mapsavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream dsfs = File.Open(mapsavepath, FileMode.Open);</span><br><span class="line">        mDSMap = (Map)dsbf.Deserialize(dsfs);</span><br><span class="line">        dsfs.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">TimeCounter.Singleton.End();</span><br><span class="line">ShowHeapMemoryUsing(<span class="string">&quot;Serialization&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>自定义序列化反序列化开销:<br><img src="/img/Unity/CustomSerializationPerformance.PNG" alt="CustomSerializationPerformance"><br>默认序列化开销:<br><img src="/img/Unity/DefaultSerializationPerformance.PNG" alt="DefaultSerializationPerformance"><br>Note:<br>    <strong>实际测试以后发现，自定义并没有加快反序列化的速度，反而增加了内存开销</strong><br>    从上面的测试可以看出反序列化的速度没有加快，反倒是反序列化的内存开销增加了。<br>    这里的测试结果也和<a target="_blank" rel="noopener" href="https://theburningwork.com/2011/08/performance-test-binaryformatter-vs-protobuf-net/">Performance Test - BinaryFormatter vs Protobuf-Net</a>里的结论一致了。<strong>但至于为什么反序列化速度没有提升，这里不太明白，理论上避免了反射应该是有所提升才对。希望知道的朋友忘告知。</strong></p>
<ol start="2">
<li>序列化的数据仅仅是通过C#自身可以反序列化出来，不支持跨语言(比如服务器端使用Java的话，并不能直接使用同样的序列化数据)。</li>
</ol>
<h4 id="ProtoBuff"><a href="#ProtoBuff" class="headerlink" title="ProtoBuff"></a>ProtoBuff</h4><h5 id="ProtoBuff学习了解"><a href="#ProtoBuff学习了解" class="headerlink" title="ProtoBuff学习了解"></a>ProtoBuff学习了解</h5><p>Protocol Buffers是Google发布出来的开源项目。<br><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/overview">Protocol Buffers - a language-neutral, platform-neutral, extensible way of serializing structured data for use in communications protocols, data storage, and more. </a><br>从官网介绍可以看出Google Protocol Buffers(平台无关，语言无关)是针对序列化数据的存储和传输协议等。<br>既然都是用于数据存储，那么Protocol buffers相比传统的二进制和XML序列化有什么优势了？<br>相比XML序列化，Protocol buffers更高效，更灵活，更快，更小，更简单。<br>更方便简单在于 – PB只需定义一次data的数据结构就能自动生成对应语言的解析该数据结构的代码类。<br>更高效更小在于 – XML存储的数据量大，XML在解析的时候，空间开销大，内容多速度慢。(XML的好处 – 具有可读性)<br>更灵活在于 – 只需更新数据结构定义然后编译出对应语言的代码就能无缝衔接以前的版本。<br>既然Protocol buffers这么好，那么让我们看看他是怎么工作的？</p>
<ol>
<li>定义出我们需要序列化的数据结构，保存在.proto文件里。</li>
<li>运用Protocol buffer编译器编译出我们对应语言的解析该数据结构的代码类。<br>首先下载对应语言的<a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/tag/v3.0.0">Protocol buffer编译器</a><br>“There are two NuGet packages: Google.Protobuf (the support library) and Google.Protobuf.Tools (containing protoc)”<br>根据上面写的，C#现在貌似有两个版本支持Protocol Buffer，但原生的Protobuf版本支持的.NET版本很高，所以不适合Unity(Unity是基于Mono的，Mono现在对.NET的支持还停留在.NET 2.0和.NET 2.0 subset)。</li>
</ol>
<p>—————————–2018&#x2F;5&#x2F;6(新增)———————————–<br><img src="/img/Unity/UntiyDotNetVersion.PNG" alt="UntiyDotNetVersion"><br>虽然表面上Unity(5.6.4p4)写的.Net 2.0和.Net 2.0 Subnet，其实支持的算是.Net 2.0 + .Net 3.5<br>详情参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/myqtmacc/article/details/70500099">扒一扒.net、.net framework、mono和Unity</a><br><img src="/img/Unity/Unity2017DotNetVersion.PNG" alt="Unity2017DotNetVersion"><br>到了Unity 2017,Unity已经支持到.Net 3.5和测试版的.Net 4.6了(支持C# 6语法)<br>Mono逐渐被IL2CPP取代，MonoDevelop工具在Unity2018开始也正式废弃不再支持。<a target="_blank" rel="noopener" href="https://blogs.unity3d.com/cn/2018/01/05/discontinuing-support-for-monodevelop-unity-starting-in-unity-2018-1/">Replacing MonoDevelop-Unity with Visual Studio Community starting in Unity 2018.1</a><br>——————————2018&#x2F;5&#x2F;6(新增)———————————–</p>
<p>所以通过Google，我找到了以下两个开源项目：<br>    1. <a target="_blank" rel="noopener" href="https://github.com/jskeet/protobuf-csharp-port">Protobuf-csharp-port</a><br>    2. <a target="_blank" rel="noopener" href="https://github.com/mgravell/protobuf-net">Protobuf-net</a><br>    前者在Git上的描述不多，所以这里就以下面引用的话来了解两者之间的区别。<br>    <a target="_blank" rel="noopener" href="http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/">Protobuf-csharp-port is written by Jon Skeet and is a faithful port of Google’s java implementation that uses similar command-line tooling. You create the data definitions in text-based .proto files and use a code generation tool to create the C# classes.</a><br>    Protobuf-csharp-port是由Jon Skeet编写，利用原生工具去port的版本。在编译创建上都沿用了Protocol buffer的原始方式(通过编译.proto文件生成解析定义的Message数据结构的C#代码类)<br>    <a target="_blank" rel="noopener" href="http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/">Protobuf-net is written by Marc Gravell and will be more familiar to .Net developers. The implementation uses .Net classes and attributes to define data rather than .proto files. Overall, the code resembles existing .Net serializers such as the DataContractSerializer.</a><br>    Protobuf-net是由Marc Gravell编写，支持.NET的类和attributes去定义数据结构，也支持.proto文件预编译生成对应代码类。可以说是.NET风格的Protobuf。<br>    同时Github写明了支持：<br>    .net 2.0&#x2F;3.0&#x2F;3.5&#x2F;4.0<br>    Mono 2.x<br>    所以这里就决定使用Protobuf-net作为Unity C#序列化数据的存储和协议传输的库来学习。<br>        1. 安装Protobuf-net<br>        VS -&gt; Tools -&gt; Nuget Package Manager -&gt; Package Manager Console<br>        在Package Manager Console窗口输入下列命令就会自动去下载Protobuf-net包并安装了。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package protobuf-net</span><br></pre></td></tr></table></figure>

<pre><code>    也可以直接下载[Down load link of Protobuf-net](https://code.google.com/archive/p/protobuf-net/downloads)
    把Protobuf-net.dll放到Assets/Plugins目录下
    2. 定义可序列化的类
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> ProtoBuf;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ProtoContract</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerData</span> &#123;</span><br><span class="line">    [<span class="meta">ProtoMember(1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> SceneName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ProtoMember(2)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Scores</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ProtoMember(3)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过C#(对应语言)protocol buffer API去读写存储的数据。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line"></span><br><span class="line">    mProfilePath =  Application.persistentDataPath + <span class="string">&quot;/PlayerProile.bin&quot;</span>;</span><br><span class="line">    Debug.Log(<span class="string">&quot;mProfilePath = &quot;</span> + mProfilePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SavePlayerData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Do serialization for player data</span></span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Create(mProfilePath);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadPlayerData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.OpenRead(mProfilePath);</span><br><span class="line">        mPlayerData = Serializer.Deserialize&lt;PlayerData&gt;(profile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line">        mPlayerData.SceneName = Application.productName;</span><br><span class="line">        mPlayerData.Scores = <span class="number">0</span>;</span><br><span class="line">        mPlayerData.SpeedLevel = <span class="number">1</span>;</span><br><span class="line">        SavePlayerData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但只是这样的话，会报如下错误：<br>NotSupportException： …… System.Reflection.Emit is not supported<br>这里出现了Emit类的使用，显然是用到了动态生成代码，根据我们之前讲到的IOS是在Full-AOT模式下运行不允许动态生成代码的。<br>所以直接使用.NET风格的Attribute会触发动态代码生成，那么我们就需要想办法提前生成，这里就需要使用.proto文件然后通过预编译的方式生成对应的代码类。<br>所以现在我们需要先定义.proto文件(Protobuf-net只支持Proto2)，所以编写<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto">proto2参考</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PlayerData.proto</span></span><br><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line">package NGUI2DGame;</span><br><span class="line"></span><br><span class="line">message PlayerData&#123;</span><br><span class="line">    optional <span class="built_in">string</span> SceneName = <span class="number">1</span>;</span><br><span class="line">    optional int32 Scores = <span class="number">2</span>;</span><br><span class="line">    optional int32 SpeedLevel = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过Protogen.exe帮我们生成对应解析该数据结构所需要的代码类</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protogen -i:PlayerData.proto -o:PlayerData.cs -ns:NGUI2DGame</span><br></pre></td></tr></table></figure>

<p>-i是指明输入，这里可以通过-i指定多个输入proto文件。-o是指定输出文件，最终生成的对应信息的代码类。-ns是指定namespace</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PlayerData.cs</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//     This code was generated by a tool.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     Changes to this file may cause incorrect behavior and will be lost if</span></span><br><span class="line"><span class="comment">//     the code is regenerated.</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Generated from: PlayerData.proto</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NGUI2DGame</span></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="meta">global::System.Serializable, global::ProtoBuf.ProtoContract(Name=@<span class="string">&quot;PlayerData&quot;</span>)</span>]</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">PlayerData</span> : <span class="title">global</span>::<span class="title">ProtoBuf.IExtensible</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PlayerData</span>()</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _SceneName = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    [<span class="meta">global::ProtoBuf.ProtoMember(1, IsRequired = false, Name=@<span class="string">&quot;SceneName&quot;</span>, DataFormat = global::ProtoBuf.DataFormat.Default)</span>]</span><br><span class="line">    [<span class="meta">global::System.ComponentModel.DefaultValue(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> SceneName</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> _SceneName; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123; _SceneName = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _Scores = <span class="literal">default</span>(<span class="built_in">int</span>);</span><br><span class="line">    [<span class="meta">global::ProtoBuf.ProtoMember(2, IsRequired = false, Name=@<span class="string">&quot;Scores&quot;</span>, DataFormat = global::ProtoBuf.DataFormat.TwosComplement)</span>]</span><br><span class="line">    [<span class="meta">global::System.ComponentModel.DefaultValue(default(int))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Scores</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> _Scores; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123; _Scores = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _SpeedLevel = <span class="literal">default</span>(<span class="built_in">int</span>);</span><br><span class="line">    [<span class="meta">global::ProtoBuf.ProtoMember(3, IsRequired = false, Name=@<span class="string">&quot;SpeedLevel&quot;</span>, DataFormat = global::ProtoBuf.DataFormat.TwosComplement)</span>]</span><br><span class="line">    [<span class="meta">global::System.ComponentModel.DefaultValue(default(int))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> _SpeedLevel; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123; _SpeedLevel = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">global</span>::ProtoBuf.IExtension extensionObject;</span><br><span class="line">    <span class="keyword">global</span>::ProtoBuf.IExtension <span class="keyword">global</span>::ProtoBuf.IExtensible.GetExtensionObject(<span class="built_in">bool</span> createIfMissing)</span><br><span class="line">      &#123; <span class="keyword">return</span> <span class="keyword">global</span>::ProtoBuf.Extensible.GetExtensionObject(<span class="keyword">ref</span> extensionObject, createIfMissing); &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来把我们生成的代码通过VS编译成DLL</p>
<ol>
<li>新建C# Library工程</li>
<li>删掉原始cs添加刚才生成的PlayerData.cs</li>
<li>添加Protobuf-net库引用(用CoreOnly&#x2F;ios&#x2F;protobuf-net.dll)</li>
<li>编译出dll<br>最后我们需要通过上一步生成的信息类dll来编译出专门序列化该信息的类库。(添加precompile.exe的路径到环境变量确保找得到，这里要注意的是dll项目的.NET target设置成2.0，因为Unity Mono现在只支持到2.0)<br>在之前生成的PlayerData.dll目录下执行下列命令：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">precompile PlayerData.dll -o:ProtobufSerializer.dll -t:com.TonyTang.ProtobufSerializer</span><br></pre></td></tr></table></figure>

<p>-o指明输出文件 -t指明生成的序列化类的类名<br>最后利用生成的PlayerData.dll和ProtobufSerializer.dll到Unity里进行测试，编写对应代码即可，写法和之前的区别就是用我们生成好的类来完成序列化和反序列化。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Serialization</span></span><br><span class="line">ProtobufSerializer serializer = <span class="keyword">new</span> ProtobufSerializer();       </span><br><span class="line">profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">serializer.Serialize(profile, mPlayerData);</span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">profile = File.OpenRead(mProfilePath);</span><br><span class="line">mPlayerData = serializer.Deserialize(profile,<span class="literal">null</span>,<span class="keyword">typeof</span>(PlayerData)) <span class="keyword">as</span> PlayerData;</span><br></pre></td></tr></table></figure>

<p>因为需要编写.proto文件后编译生成对应的Serialization类的dll，所以最好通过shell脚本写成自动化。<br>还有一种方式是使用Probobuf-net源码的形式(貌似需要设定-unsafe和.NET 2 subset)，这里我没有尝试，下面给出链接：<br><a target="_blank" rel="noopener" href="http://www.ceeger.com/forum/read.php?tid=14359&fid=27">在ios android设备上使用 Protobuf (使用源码方式) </a></p>
<p>了解了什么(What)是Protobuf，如何(How)使用Protobuf，那么我们也应该大概了解下为什么(Why)Protobuf高效，更小，更快，更简单…..<br>参考下面两篇文章：<br><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/">Google Protocol Buffer 的使用和原理</a><br><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/encoding">官网讲到的Protocol buffer的Encode技术</a><br>从上面可以看出，更小更快是因为Protocol buffer采用了巧妙的Encoding方法。<br>而这个Encoding方法利用了Varint技术，那么什么是Varint了？<br>“Varints are a method of serializing integers using one or more bytes. Smaller numbers take a smaller number of bytes. “<br>Varints通过更少的字节来表达准确的数据，比如0-127只需要1个字节就能表示。<br>当需要多个字节表达的时候，通过利用1byte里的first bit来区分，如果first bit是1表示后续的7个bit都表示数据，如果first bit是0表示这是最后一个字节用于表示数据。<br>同时Protocol buffer在Encode的时候通过key和value来存储数据。key只包含filed的名字和类型，value包含数据。<br>类型数据映射<br><img src="/img/Unity/ProtocolBufferMessageValueType.PNG" alt="ProtocolBufferMessageValueType"><br>当Decode的时候，如果遇到不识别的key值，只需要skip即可，保证了程序的老版本兼容。<br>更方便在于，我们只需通过编写简单易懂的.proto文件然后通过ProtoGen，Precompile工具就能生成对应的Message，Encode和Decode类。<br>结合前面的事例，让我们窥探一下到底Protocol-net是如何实现编写.proto文件结合编译生成Message类和序列化类来实现数据的Encode和Decode的。<br>首先反编译的ProtovufSerializer.dll，查看Serialize方法<br><img src="/img/Unity/ProtobufSerializerSerialize.PNG" alt="ProtobufSerializerSerialize"><br>可以看到ProtobufSerializer调用了Write方法，接下来查看Write方法<br><img src="/img/Unity/ProtobufSerializerWrite.PNG" alt="ProtobufSerializerWrite"><br>可以看到我们ProtobufSerializer实际是通过调用ProtoBuf.ProtoWriter::WriteFieldHeader(Protobuf-net库)实现数据的Encode的。同时因为ProtobufSerializer是根据PlayerData.dll编译而成，所以Write方法里的实现针对每一个需要Encode的Message成员进行数据Encode写入。<br>这样一来就完成了通过编写.proto文件定义Message，然后生成对应的Message类和序列化类再结合Protocol-net库实现了自定义Message的Encode和Decode了，而最终数据的Encode，Decode实现就落实到Protocol-net的实现了。</p>
<p>那么为什么要用Protocol buffer了？<br>参考文章：<br><a target="_blank" rel="noopener" href="http://www.oschina.net/translate/choose-protocol-buffers">使用 Protocol Buffers 代替 JSON 的五个原因</a><br>Protocol buffer因为是存储在二进制文件，相比XML，Jason等技术不具可读性。</p>
<p>Note:<br>最初的Protocol Buffers只开发了针对Java,C++,Python的版本。后来开园后有了C#，Go等语言的支持。<br>Protocol Buffer存储的数据是以二进制的形式。<br>Protocol-net只支持<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto">proto2的语言编写规范</a>。</p>
<p>从之前的学习可以知道的是，ProtoBuf通过自定义了Encode和Decode，使用Varint技术，把数据成功压缩更小，实现了更小的数据量存储。</p>
<p>——————————-2018&#x2F;04&#x2F;22———————————–<br>关于ProtoBuf原理深度解析，这里找到一篇好文:<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/30ef9b3780d9">Protocol Buffer 序列化原理大揭秘 - 为什么Protocol Buffer性能这么好？</a>——————————-2018&#x2F;04&#x2F;22———————————–</p>
<p>前面提到的是Protocol Buffer 2的使用，那么我们能否集成使用Protocol Buffer 3吗？<br>答案是可以的，接下来我们学习Protocol Bufffer 3的集成使用。</p>
<h5 id="Protocol-Buffer-3-in-Unity"><a href="#Protocol-Buffer-3-in-Unity" class="headerlink" title="Protocol Buffer 3 in Unity"></a>Protocol Buffer 3 in Unity</h5><p>Protocok Buffer(高效的跨语言序列化反序列化数据以及数据结构向后扩展兼容)</p>
<p>问题：</p>
<ol>
<li>PB3对.Net版本的要求？<br>在前面的学习中，我们使用了Protobuf-net版本(支持.Net 2.0,3.0,4.0，但只支持PB2)，这里是学习了解PB3是否能在Unity中使用起来。</li>
</ol>
<p>Probuf官方Git链接：<br><a target="_blank" rel="noopener" href="https://github.com/google/protobuf">protobuf</a><br>Probuf最新压缩包链接：<br><a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/tag/v3.6.1">protobuf latest</a><br>从Git上下载的最新PB3要求.Net4.5，这是从Git上Protobuf CS源代码工程的Google.Protobuf.csproj文件里看出来的：<br><img src="/img/Unity/Data-Config-Automation/Protobuf3DotNetTargetNumber.png" alt="Protobuf3DotNetTargetNumber"></p>
<ol start="2">
<li><p>Unity支持的.Net版本?<br><img src="/img/Unity/Unity2017DotNetVersion.PNG" alt="Unity2017DotNetVersion"><br>到了Unity 2017,Unity已经支持到.Net 3.5和测试版的.Net 4.6了(支持C# 6语法)</p>
</li>
<li><p>Unity支持的PB版本？<br>通过前面两个问题可以知道，Unity要想支持PB3，我们需要把PB3编译成基于.Net 3.5(因为.Net 4.6还处于测试阶段，所以没选择.Net 4.6)来使用。看网上都有兼容PB3的版本了，理论上Unity是有办法支持PB3的。<br>兼容PB3的版本链接:<br><a target="_blank" rel="noopener" href="https://github.com/bitcraftCoLtd/protobuf3-for-unity">protobuf3-for-unity</a></p>
</li>
<li><p>Python对应需要的PB版本？<br>选择和前面CS版本相同版本的Python版本的PB3即可(PB3 3.6.1)</p>
</li>
<li><p>Protoc的选择？<br>直接下载编译好的对应版本的Protoc(3.6.1)压缩包即可</p>
</li>
</ol>
<p>流程：<br>Protobuf CSharp篇：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/tag/v3.6.1">下载新版Protobuf Csharp版</a></li>
<li>自己编译基于.Net 3.5版本Protobuf Csharp版dll(我的理解这一步的dll是Protobuf核心的模块，用于支持对数据编码存储)<br>打开下载的Protobuf Csharp源码里的Google.Protobuf.sln，修改里面Google.Protobuf.csproj工程的TargetFrameworks编译生成我们想要的基于.Net 3.5的Csharp版Protobuf-Csharp.dll<br><img src="/img/Unity/Data-Config-Automation/CompileProtobufCsharpForDoNet35.png" alt="CompileProtobufCsharpForDoNet35"><br><img src="/img/Unity/Data-Config-Automation/DoNet35ProtobufCsharpDll.png" alt="DoNet35ProtobufCsharpDll"><br>复制基于.Net 3.Google.Protobuf.dll到我们的Unity脚本目录下。</li>
</ol>
<p>Note:</p>
<ul>
<li>Protobuf 3.6.1的Google.Protobuf.sln工程需要VS2017才能正确打开，VS2015本人打开显示加载.csproj的C#项目都失败了</li>
</ul>
<ol start="3">
<li>使用Protoc.exe对*.proto文件进行解析生成对应的代码(我的理解，这一步是为了支持指定定义的数据格式的序列化和反序列化相关代码)<br>第一步需要添加Protoc.exe到环境变量里，方便快速访问调用Protoc.exe(这个就不细说了)<br>编写测试GameConfig.proto文件：</li>
</ol>
<figure class="highlight proto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用proto3</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="comment">// 指明namespace</span></span><br><span class="line"><span class="keyword">package</span> GameData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 游戏配置信息</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">GameConfig</span> &#123;</span><br><span class="line">  <span class="type">string</span> difficultyLevel = <span class="number">1</span>;           <span class="comment">// 游戏难度</span></span><br><span class="line">  <span class="type">int32</span> versionNumber = <span class="number">2</span>;              <span class="comment">// 游戏版本号</span></span><br><span class="line">  <span class="type">int32</span> resourceNumber = <span class="number">3</span>;             <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用protoc.exe生成用于序列化反序列化GameConfig的代码:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc.exe --csharp_out=CsharpCode -I=Proto GameConfig.proto</span><br></pre></td></tr></table></figure>

<p>–csharp_out指明CS脚本输出目录<br>-I指明Proto文件查找目录<br>GameConfig.proto表示protoc.exe编译该文件<br>最终得到我们Csharp序列化和反序列化GameConfig所需的代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//     Generated by the protocol buffer compiler.  DO NOT EDIT!</span></span><br><span class="line"><span class="comment">//     source: GameConfig.proto</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span> disable 1591, 0612, 3021</span></span><br><span class="line"><span class="meta">#<span class="keyword">region</span> Designer generated code</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> pb = <span class="keyword">global</span>::Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> pbc = <span class="keyword">global</span>::Google.Protobuf.Collections;</span><br><span class="line"><span class="keyword">using</span> pbr = <span class="keyword">global</span>::Google.Protobuf.Reflection;</span><br><span class="line"><span class="keyword">using</span> scg = <span class="keyword">global</span>::System.Collections.Generic;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GameData</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Holder for reflection information generated from GameConfig.proto<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GameConfigReflection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Descriptor</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>File descriptor for GameConfig.proto<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> pbr::FileDescriptor Descriptor &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> descriptor; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> pbr::FileDescriptor descriptor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">GameConfigReflection</span>()</span> &#123;</span><br><span class="line">      <span class="built_in">byte</span>[] descriptorData = <span class="keyword">global</span>::System.Convert.FromBase64String(</span><br><span class="line">          <span class="built_in">string</span>.Concat(</span><br><span class="line">            <span class="string">&quot;ChBHYW1lQ29uZmlnLnByb3RvEghHYW1lRGF0YSJUCgpHYW1lQ29uZmlnEhcK&quot;</span>,</span><br><span class="line">            <span class="string">&quot;D2RpZmZpY3VsdHlMZXZlbBgBIAEoCRIVCg12ZXJzaW9uTnVtYmVyGAIgASgF&quot;</span>,</span><br><span class="line">            <span class="string">&quot;EhYKDnJlc291cmNlTnVtYmVyGAMgASgFYgZwcm90bzM=&quot;</span>));</span><br><span class="line">      descriptor = pbr::FileDescriptor.FromGeneratedCode(descriptorData,</span><br><span class="line">          <span class="keyword">new</span> pbr::FileDescriptor[] &#123; &#125;,</span><br><span class="line">          <span class="keyword">new</span> pbr::GeneratedClrTypeInfo(<span class="literal">null</span>, <span class="keyword">new</span> pbr::GeneratedClrTypeInfo[] &#123;</span><br><span class="line">            <span class="keyword">new</span> pbr::GeneratedClrTypeInfo(<span class="keyword">typeof</span>(<span class="keyword">global</span>::GameData.GameConfig), <span class="keyword">global</span>::GameData.GameConfig.Parser, <span class="keyword">new</span>[]&#123; <span class="string">&quot;DifficultyLevel&quot;</span>, <span class="string">&quot;VersionNumber&quot;</span>, <span class="string">&quot;ResourceNumber&quot;</span> &#125;, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">          &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="keyword">region</span> Messages</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 游戏配置信息</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GameConfig</span> : <span class="title">pb</span>::<span class="title">IMessage</span>&lt;<span class="title">GameConfig</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> pb::MessageParser&lt;GameConfig&gt; _parser = <span class="keyword">new</span> pb::MessageParser&lt;GameConfig&gt;(() =&gt; <span class="keyword">new</span> GameConfig());</span><br><span class="line">    <span class="keyword">private</span> pb::UnknownFieldSet _unknownFields;</span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> pb::MessageParser&lt;GameConfig&gt; Parser &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> _parser; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> pbr::MessageDescriptor Descriptor &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">global</span>::GameData.GameConfigReflection.Descriptor.MessageTypes[<span class="number">0</span>]; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    pbr::MessageDescriptor pb::IMessage.Descriptor &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> Descriptor; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameConfig</span>()</span> &#123;</span><br><span class="line">      OnConstruction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">partial</span> <span class="keyword">void</span> <span class="title">OnConstruction</span>()</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameConfig</span>(<span class="params">GameConfig other</span>) : <span class="title">this</span>()</span> &#123;</span><br><span class="line">      difficultyLevel_ = other.difficultyLevel_;</span><br><span class="line">      versionNumber_ = other.versionNumber_;</span><br><span class="line">      resourceNumber_ = other.resourceNumber_;</span><br><span class="line">      _unknownFields = pb::UnknownFieldSet.Clone(other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameConfig <span class="title">Clone</span>()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> GameConfig(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Field number for the &quot;difficultyLevel&quot; field.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> DifficultyLevelFieldNumber = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> difficultyLevel_ = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏难度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DifficultyLevel &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> difficultyLevel_; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123;</span><br><span class="line">        difficultyLevel_ = pb::ProtoPreconditions.CheckNotNull(<span class="keyword">value</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Field number for the &quot;versionNumber&quot; field.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> VersionNumberFieldNumber = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> versionNumber_;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏版本号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> VersionNumber &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> versionNumber_; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123;</span><br><span class="line">        versionNumber_ = <span class="keyword">value</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Field number for the &quot;resourceNumber&quot; field.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> ResourceNumberFieldNumber = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> resourceNumber_;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏资源版本号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ResourceNumber &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> resourceNumber_; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123;</span><br><span class="line">        resourceNumber_ = <span class="keyword">value</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Equals</span>(<span class="params"><span class="built_in">object</span> other</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Equals(other <span class="keyword">as</span> GameConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Equals</span>(<span class="params">GameConfig other</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (ReferenceEquals(other, <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ReferenceEquals(other, <span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel != other.DifficultyLevel) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != other.VersionNumber) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != other.ResourceNumber) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">return</span> Equals(_unknownFields, other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">GetHashCode</span>()</span> &#123;</span><br><span class="line">      <span class="built_in">int</span> hash = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel.Length != <span class="number">0</span>) hash ^= DifficultyLevel.GetHashCode();</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != <span class="number">0</span>) hash ^= VersionNumber.GetHashCode();</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != <span class="number">0</span>) hash ^= ResourceNumber.GetHashCode();</span><br><span class="line">      <span class="keyword">if</span> (_unknownFields != <span class="literal">null</span>) &#123;</span><br><span class="line">        hash ^= _unknownFields.GetHashCode();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> pb::JsonFormatter.ToDiagnosticString(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WriteTo</span>(<span class="params">pb::CodedOutputStream output</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel.Length != <span class="number">0</span>) &#123;</span><br><span class="line">        output.WriteRawTag(<span class="number">10</span>);</span><br><span class="line">        output.WriteString(DifficultyLevel);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        output.WriteRawTag(<span class="number">16</span>);</span><br><span class="line">        output.WriteInt32(VersionNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        output.WriteRawTag(<span class="number">24</span>);</span><br><span class="line">        output.WriteInt32(ResourceNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (_unknownFields != <span class="literal">null</span>) &#123;</span><br><span class="line">        _unknownFields.WriteTo(output);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">CalculateSize</span>()</span> &#123;</span><br><span class="line">      <span class="built_in">int</span> size = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel.Length != <span class="number">0</span>) &#123;</span><br><span class="line">        size += <span class="number">1</span> + pb::CodedOutputStream.ComputeStringSize(DifficultyLevel);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        size += <span class="number">1</span> + pb::CodedOutputStream.ComputeInt32Size(VersionNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        size += <span class="number">1</span> + pb::CodedOutputStream.ComputeInt32Size(ResourceNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (_unknownFields != <span class="literal">null</span>) &#123;</span><br><span class="line">        size += _unknownFields.CalculateSize();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MergeFrom</span>(<span class="params">GameConfig other</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (other == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (other.DifficultyLevel.Length != <span class="number">0</span>) &#123;</span><br><span class="line">        DifficultyLevel = other.DifficultyLevel;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (other.VersionNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        VersionNumber = other.VersionNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (other.ResourceNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        ResourceNumber = other.ResourceNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      _unknownFields = pb::UnknownFieldSet.MergeFrom(_unknownFields, other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MergeFrom</span>(<span class="params">pb::CodedInputStream input</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">uint</span> tag;</span><br><span class="line">      <span class="keyword">while</span> ((tag = input.ReadTag()) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(tag) &#123;</span><br><span class="line">          <span class="literal">default</span>:</span><br><span class="line">            _unknownFields = pb::UnknownFieldSet.MergeFieldFrom(_unknownFields, input);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">10</span>: &#123;</span><br><span class="line">            DifficultyLevel = input.ReadString();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">16</span>: &#123;</span><br><span class="line">            VersionNumber = input.ReadInt32();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">24</span>: &#123;</span><br><span class="line">            ResourceNumber = input.ReadInt32();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span> Designer generated code</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用生成的代码进行序列化和反序列化数据测试<br>UIDebugMonoScript.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 快速访问UI组件测试挂在脚本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIDebugMonoScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建GameConfig按钮</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnCreateGameConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取GameConfig按钮</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnReadGameConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mBtnCreateGameConfig.onClick.AddListener(onCreateGameConfigClick);</span><br><span class="line">        mBtnReadGameConfig.onClick.AddListener(onReadGameConfigClick);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mBtnCreateGameConfig.onClick.RemoveAllListeners();</span><br><span class="line">        mBtnReadGameConfig.onClick.RemoveAllListeners();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCreateGameConfigClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onCreateGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.ProtobufDataFolderPath : &quot;</span> + PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        PathUtilities.checkAndCreateFolder(PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        GameConfig gameconfig = <span class="keyword">new</span> GameConfig();</span><br><span class="line">        gameconfig.DifficultyLevel = <span class="string">&quot;Easy&quot;</span>;</span><br><span class="line">        gameconfig.VersionNumber = <span class="number">1</span>;</span><br><span class="line">        gameconfig.ResourceNumber = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> output = File.Create(PathUtilities.ProtobufDataFolderPath + <span class="string">&quot;GameConfig.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            gameconfig.WriteTo(output);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onReadGameConfigClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onReadGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.ProtobufDataFolderPath : &quot;</span> + PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        GameConfig gameconfig;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.ProtobufDataFolderPath + <span class="string">&quot;GameConfig.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            gameconfig = GameConfig.Parser.ParseFrom(intput);</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.Log(<span class="string">&quot;gameconfig.DifficultyLevel : &quot;</span> + gameconfig.DifficultyLevel);</span><br><span class="line">        Debug.Log(<span class="string">&quot;gameconfig.VersionNumber : &quot;</span> + gameconfig.VersionNumber);</span><br><span class="line">        Debug.Log(<span class="string">&quot;gameconfig.ResourceNumber : &quot;</span> + gameconfig.ResourceNumber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PathUtilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             路径静态工具类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/03/12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 路径静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PathUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//******</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Protobuf</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Protobuf生成数据目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProtobufDataFolderPath = Application.dataPath + <span class="string">&quot;/Resources/ProtoData/&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> UNITY_ANDROID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProtobufDataFolderPath = Application.temporaryCachePath + <span class="string">&quot;/ProtoData/&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> UNITY_IOS</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProtobufDataFolderPath = Application.temporaryCachePath + <span class="string">&quot;/ProtoData/&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> 公用方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查并确保目录存在</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;folderpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkAndCreateFolder</span>(<span class="params"><span class="built_in">string</span> folderpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.CreateDirectory(folderpath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PC:<br><img src="/img/Unity/Data-Config-Automation/ProtobufSerialization.png" alt="ProtobufSerialization"><br>Android:<br><img src="/img/Unity/Data-Config-Automation/ProtobufSerializationAndroidPlatform.png" alt="ProtobufSerializationAndroidPlatform"><br>可以看到我们在PC和Android都成功使用Protobuf3进行了数据的序列化和反序列化。<br>接下来我们要完成的是测试同样的二进制序列化文件，通过Python版的Protobuf3是否能够正确的反序列化读取(验证跨语言数据存储读取)。</p>
<p>Protobuf Python篇：</p>
<ol>
<li>安装python</li>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/download/v3.6.1/protoc-3.6.1-win32.zip">Protoc.exe</a>用于安装生成python版proto文件对应的解析所需文件</li>
<li>下载对应版本的<a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/download/v3.6.1/protobuf-python-3.6.1.zip">Protobuf 3 Python版本</a>(这里我下的和Csharp版本的Protobuf3一样的版本3.6.1)</li>
<li>安装Protobuf 3 Python所需环境(在下载的Protobuf3 Python的Python原代码下运行python setup.py install)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<p>安装完成后会发现Protobuf 3 For Python相关的Package环境都被下载到了site-packages目录：<br><img src="/img/Unity/Data-Config-Automation/InstallProtobuf3EnviromentForPython.png" alt="Protobuf3ForPythonSetup"></p>
<ol start="5">
<li>编译Proto文件生成解析所需文件<br>依然使用protoc.exe，但这一次指定的输出代码是针对python的:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc.exe --python_out=PythonCode -I=Proto GameConfig.proto</span><br></pre></td></tr></table></figure>

<p>GameConfig_pb2.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generated by the protocol buffer compiler.  DO NOT EDIT!</span></span><br><span class="line"><span class="comment"># source: GameConfig.proto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">_b=sys.version_info[<span class="number">0</span>]&lt;<span class="number">3</span> <span class="keyword">and</span> (<span class="keyword">lambda</span> x:x) <span class="keyword">or</span> (<span class="keyword">lambda</span> x:x.encode(<span class="string">&#x27;latin1&#x27;</span>))</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> descriptor <span class="keyword">as</span> _descriptor</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> message <span class="keyword">as</span> _message</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> reflection <span class="keyword">as</span> _reflection</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> symbol_database <span class="keyword">as</span> _symbol_database</span><br><span class="line"><span class="comment"># @@protoc_insertion_point(imports)</span></span><br><span class="line"></span><br><span class="line">_sym_db = _symbol_database.Default()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DESCRIPTOR = _descriptor.FileDescriptor(</span><br><span class="line">  name=<span class="string">&#x27;GameConfig.proto&#x27;</span>,</span><br><span class="line">  package=<span class="string">&#x27;GameData&#x27;</span>,</span><br><span class="line">  syntax=<span class="string">&#x27;proto3&#x27;</span>,</span><br><span class="line">  serialized_options=<span class="literal">None</span>,</span><br><span class="line">  serialized_pb=_b(<span class="string">&#x27;\n\x10GameConfig.proto\x12\x08GameData\&quot;T\n\nGameConfig\x12\x17\n\x0f\x64ifficultyLevel\x18\x01 \x01(\t\x12\x15\n\rversionNumber\x18\x02 \x01(\x05\x12\x16\n\x0eresourceNumber\x18\x03 \x01(\x05\x62\x06proto3&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_GAMECONFIG = _descriptor.Descriptor(</span><br><span class="line">  name=<span class="string">&#x27;GameConfig&#x27;</span>,</span><br><span class="line">  full_name=<span class="string">&#x27;GameData.GameConfig&#x27;</span>,</span><br><span class="line">  filename=<span class="literal">None</span>,</span><br><span class="line">  file=DESCRIPTOR,</span><br><span class="line">  containing_type=<span class="literal">None</span>,</span><br><span class="line">  fields=[</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;difficultyLevel&#x27;</span>, full_name=<span class="string">&#x27;GameData.GameConfig.difficultyLevel&#x27;</span>, index=<span class="number">0</span>,</span><br><span class="line">      number=<span class="number">1</span>, <span class="built_in">type</span>=<span class="number">9</span>, cpp_type=<span class="number">9</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=_b(<span class="string">&quot;&quot;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;versionNumber&#x27;</span>, full_name=<span class="string">&#x27;GameData.GameConfig.versionNumber&#x27;</span>, index=<span class="number">1</span>,</span><br><span class="line">      number=<span class="number">2</span>, <span class="built_in">type</span>=<span class="number">5</span>, cpp_type=<span class="number">1</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;resourceNumber&#x27;</span>, full_name=<span class="string">&#x27;GameData.GameConfig.resourceNumber&#x27;</span>, index=<span class="number">2</span>,</span><br><span class="line">      number=<span class="number">3</span>, <span class="built_in">type</span>=<span class="number">5</span>, cpp_type=<span class="number">1</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">  ],</span><br><span class="line">  extensions=[</span><br><span class="line">  ],</span><br><span class="line">  nested_types=[],</span><br><span class="line">  enum_types=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_options=<span class="literal">None</span>,</span><br><span class="line">  is_extendable=<span class="literal">False</span>,</span><br><span class="line">  syntax=<span class="string">&#x27;proto3&#x27;</span>,</span><br><span class="line">  extension_ranges=[],</span><br><span class="line">  oneofs=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_start=<span class="number">30</span>,</span><br><span class="line">  serialized_end=<span class="number">114</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">DESCRIPTOR.message_types_by_name[<span class="string">&#x27;GameConfig&#x27;</span>] = _GAMECONFIG</span><br><span class="line">_sym_db.RegisterFileDescriptor(DESCRIPTOR)</span><br><span class="line"></span><br><span class="line">GameConfig = _reflection.GeneratedProtocolMessageType(<span class="string">&#x27;GameConfig&#x27;</span>, (_message.Message,), <span class="built_in">dict</span>(</span><br><span class="line">  DESCRIPTOR = _GAMECONFIG,</span><br><span class="line">  __module__ = <span class="string">&#x27;GameConfig_pb2&#x27;</span></span><br><span class="line">  <span class="comment"># @@protoc_insertion_point(class_scope:GameData.GameConfig)</span></span><br><span class="line">  ))</span><br><span class="line">_sym_db.RegisterMessage(GameConfig)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @@protoc_insertion_point(module_scope)</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>利用Python的Proto代码序列化(或者反序列化C#序列化的)数据<br>反序列化C#序列化的数据事例：<br>GameConfigSerialization.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File Name:        GameConfigSerialization.py</span></span><br><span class="line"><span class="comment"># Description:      This file is used to Serialize GameConfig Data</span></span><br><span class="line"><span class="comment"># Author:           TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:      2018/08/20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> GameConfig_pb2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">gameconfig = GameConfig_pb2.GameConfig()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read the existing GameConfig.data</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;GameConfig.data&quot;</span>, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line">gameconfig.ParseFromString(f.read())</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;gameconfig.difficultyLevel = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(gameconfig.difficultyLevel))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;gameconfig.versionNumber = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(gameconfig.versionNumber))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;gameconfig.resourceNumber = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(gameconfig.resourceNumber))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/PythonPB3DeserilizationFileStructure.png" alt="PythonPB3DeserilizationFileStructure"><br><img src="/img/Unity/Data-Config-Automation/PythonPB3Deserialization.png" alt="PythonPB3Deserialization"><br>可以看到我们成功的反序列化了C#序列化的数据(*证明了PB3跨语言的序列化反序列化支持)</p>
<p>Python PB3序列化数据事例:<br>GameConfigSerialization.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File Name:        GameConfigSerialization.py</span></span><br><span class="line"><span class="comment"># Description:      This file is used to Serialize GameConfig Data</span></span><br><span class="line"><span class="comment"># Author:           TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:      2018/08/20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> GameConfig_pb2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">gameconfig = GameConfig_pb2.GameConfig()</span><br><span class="line">gameconfig.difficultyLevel = <span class="string">&quot;Hard&quot;</span></span><br><span class="line">gameconfig.versionNumber = <span class="number">2</span></span><br><span class="line">gameconfig.resourceNumber = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Write the new GmaeConfig back to disk.</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;GameConfig_Py.data&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">f.write(gameconfig.SerializeToString())</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p>CSharp PB3反序列化:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GameConfig gameconfig;</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.ProtobufDataFolderPath + <span class="string">&quot;GameConfig_Py.data&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    gameconfig = GameConfig.Parser.ParseFrom(intput);</span><br><span class="line">&#125;</span><br><span class="line">Debug.Log(<span class="string">&quot;gameconfig.DifficultyLevel : &quot;</span> + gameconfig.DifficultyLevel);</span><br><span class="line">Debug.Log(<span class="string">&quot;gameconfig.VersionNumber : &quot;</span> + gameconfig.VersionNumber);</span><br><span class="line">Debug.Log(<span class="string">&quot;gameconfig.ResourceNumber : &quot;</span> + gameconfig.ResourceNumber);</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/CSharpPB3DeserilizationFileStructure.png" alt="CSharpPB3DeserilizationFileStructure"><br><img src="/img/Unity/Data-Config-Automation/CSharpPB3Deserialization.png" alt="CSharpPB3Deserialization"><br>可以看到我们也成功的通过C#的PB3反序列化了Python序列化的数据。这也验证了Protocol Buffer 3<em>跨语言的特性</em>。</p>
<p>Note:<br>Protocol Buffer很适合跨平台跨语言通信，用于网络通信定义数据结构。(待学习)</p>
<h4 id="FlatBuff"><a href="#FlatBuff" class="headerlink" title="FlatBuff"></a>FlatBuff</h4><p>在介绍FlatBuff前，让我们来看一张令人惊艳的各序列化方案测试性能对比图：<br><a target="_blank" rel="noopener" href="https://github.com/CodeZeg/xbuffer">图1来源至XBuffer的性能测试</a>:<br><img src="/img/Unity/Data-Config-Automation/SerializationPerformanceComparision.png" alt="SerializationPerformanceComparision"></p>
<p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/flatbuffers_benchmarks.html">图2来源至FlatBuff官方性能Benchmark</a>:<br><img src="/img/Unity/Data-Config-Automation/FlatBuffPerformanceBenchmark.png" alt="FlatBuffPerformanceBenchmark"></p>
<p>从上面两张图可以看到，令人惊讶的FlatBuff性能，无论是序列化还是反序列化，FlatBuff都相当高效，反序列化的时间居然几乎为0。</p>
<p>接下来我们深入学习了解FlatBuff，洞察其中的奥妙。</p>
<h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/">官网FlatBuffer</a><br><a href="google.github.io/flatbuffers">Represents hierachical data in a flat binary buffer in such a way that it can still be acecssed directly without parsing&#x2F;unpacking, while also still supporting data structure evolution(forwards&#x2F;backwards compatibility)</a><br>根据官方的介绍，FlatBuff把数据存储在一个扁平化的二进制Buffer里，这样一来FlatBuff访问和解析数据时可以向访问数据结构一样快速不需要解析或者解包(这应该就是为什么FlatBuff的反序列化时间几乎为0的原因)</p>
<p>这里简单列举下官方给出的FlatBuffer的好处:</p>
<ol>
<li>Access to serialized data without parsing&#x2F;unpacking(访问序列化数据块)</li>
<li>Memory efficiency and speed(内存和速度都很高效)</li>
<li>Flexible(向前向后兼容)</li>
<li>Tiny code footprint(生成代码量少且无依赖)</li>
<li>Strongly typed</li>
<li>Convenient to use(使用简单？)</li>
<li>Cross platform code with no dependencies(跨平台无依赖)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/">详情参考官网介绍</a></p>
<h5 id="实战使用"><a href="#实战使用" class="headerlink" title="实战使用"></a>实战使用</h5><p>接下来先按教程学习使用一波，再来看看底层的实现和优缺点：<br>使用步骤：</p>
<ol>
<li>编写schema文件(定义数据结构)<br>GameConfigFB.fbs</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">namespace GameData;</span><br><span class="line"></span><br><span class="line">table GameConfigFB&#123;</span><br><span class="line">  difficultyLevel:string;           // 游戏难度</span><br><span class="line">  versionNumber:int;                // 游戏版本号</span><br><span class="line">  resourceNumber:int;               // 游戏资源版本号</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root_type GameConfigFB;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html">schema文件编写参考</a></p>
<ol start="2">
<li>使用Flatc.exe(可以自己编译源码，也可以<a target="_blank" rel="noopener" href="https://github.com/google/flatbuffers/releases">下载现成的</a>)编译解析schema文件生成序列化和反序列化数据所需代码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./../flatc.exe --csharp .\GameConifgFB.fbs</span><br></pre></td></tr></table></figure>

<p>GameConfigFB.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//  automatically generated by the FlatBuffers compiler, do not modify</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GameData</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">global</span>::System;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">global</span>::FlatBuffers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> Table __p;</span><br><span class="line">  <span class="keyword">public</span> ByteBuffer ByteBuffer &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> __p.bb; &#125; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb</span>)</span> &#123; <span class="keyword">return</span> GetRootAsGameConfigFB(_bb, <span class="keyword">new</span> GameConfigFB()); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb, GameConfigFB obj</span>)</span> &#123; <span class="keyword">return</span> (obj.__assign(_bb.GetInt(_bb.Position) + _bb.Position, _bb)); &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> __init(<span class="built_in">int</span> _i, ByteBuffer _bb) &#123; __p.bb_pos = _i; __p.bb = _bb; &#125;</span><br><span class="line">  <span class="keyword">public</span> GameConfigFB __assign(<span class="built_in">int</span> _i, ByteBuffer _bb) &#123; __init(_i, _bb); <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> DifficultyLevel &#123; <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">4</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.__string(o + __p.bb_pos) : <span class="literal">null</span>; &#125; &#125;</span><br><span class="line">  <span class="keyword">public</span> ArraySegment&lt;<span class="built_in">byte</span>&gt;? GetDifficultyLevelBytes() &#123; <span class="keyword">return</span> __p.__vector_as_arraysegment(<span class="number">4</span>); &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> VersionNumber &#123; <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">6</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> ResourceNumber &#123; <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">8</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Offset&lt;GameConfigFB&gt; <span class="title">CreateGameConfigFB</span>(<span class="params">FlatBufferBuilder builder,</span></span></span><br><span class="line"><span class="params"><span class="function">      StringOffset difficultyLevelOffset = <span class="literal">default</span>(StringOffset</span>),</span></span><br><span class="line"><span class="function">      <span class="built_in">int</span> versionNumber</span> = <span class="number">0</span>,</span><br><span class="line">      <span class="built_in">int</span> resourceNumber = <span class="number">0</span>) &#123;</span><br><span class="line">    builder.StartObject(<span class="number">3</span>);</span><br><span class="line">    GameConfigFB.AddResourceNumber(builder, resourceNumber);</span><br><span class="line">    GameConfigFB.AddVersionNumber(builder, versionNumber);</span><br><span class="line">    GameConfigFB.AddDifficultyLevel(builder, difficultyLevelOffset);</span><br><span class="line">    <span class="keyword">return</span> GameConfigFB.EndGameConfigFB(builder);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StartGameConfigFB</span>(<span class="params">FlatBufferBuilder builder</span>)</span> &#123; builder.StartObject(<span class="number">3</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddDifficultyLevel</span>(<span class="params">FlatBufferBuilder builder, StringOffset difficultyLevelOffset</span>)</span> &#123; builder.AddOffset(<span class="number">0</span>, difficultyLevelOffset.Value, <span class="number">0</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddVersionNumber</span>(<span class="params">FlatBufferBuilder builder, <span class="built_in">int</span> versionNumber</span>)</span> &#123; builder.AddInt(<span class="number">1</span>, versionNumber, <span class="number">0</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddResourceNumber</span>(<span class="params">FlatBufferBuilder builder, <span class="built_in">int</span> resourceNumber</span>)</span> &#123; builder.AddInt(<span class="number">2</span>, resourceNumber, <span class="number">0</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Offset&lt;GameConfigFB&gt; <span class="title">EndGameConfigFB</span>(<span class="params">FlatBufferBuilder builder</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">int</span> o = builder.EndObject();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Offset&lt;GameConfigFB&gt;(o);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FinishGameConfigFBBuffer</span>(<span class="params">FlatBufferBuilder builder, Offset&lt;GameConfigFB&gt; offset</span>)</span> &#123; builder.Finish(offset.Value); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FinishSizePrefixedGameConfigFBBuffer</span>(<span class="params">FlatBufferBuilder builder, Offset&lt;GameConfigFB&gt; offset</span>)</span> &#123; builder.FinishSizePrefixed(offset.Value); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用FlatBufferBuilder(位于FlatBuff源码的&#x2F;net&#x2F;FlatBuffers目录下)根据schema生成代码序列化数据到二进制文件</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> FlatBuffers;</span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">FlatBufferStudy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> GameConfig数据全路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> GameConfigDataFullPath = <span class="string">&quot;./GameConfig.data&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 存储GameConfig数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SaveGameConfigData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Create a `FlatBufferBuilder`, which will be used to create our</span></span><br><span class="line">            <span class="comment">// GameConfigFB&#x27; FlatBuffers.</span></span><br><span class="line">            <span class="comment">// 定义FlatBufferBulder对象用于我们构建数据对象</span></span><br><span class="line">            <span class="keyword">var</span> builder = <span class="keyword">new</span> FlatBufferBuilder(<span class="number">4</span>);</span><br><span class="line">            <span class="keyword">var</span> difficultylevel = builder.CreateString(<span class="string">&quot;Hard-困难&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Use the `CreateGameConfigFB()` helper function to create the GameConfigFB, since we set every field.</span></span><br><span class="line">            <span class="comment">// 往GameConfigFB里填充数据</span></span><br><span class="line">            <span class="keyword">var</span> gameconfig = GameConfigFB.CreateGameConfigFB(builder, difficultylevel, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Call `Finish()` to instruct the builder that this GameConfigFB is complete.</span></span><br><span class="line">            <span class="comment">// 指定GameConfigFB数据构建完成</span></span><br><span class="line">            builder.Finish(gameconfig.Value);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This must be called after `Finish()`.</span></span><br><span class="line">            <span class="comment">// 包含GameConfigFB的二进制数据的数据对象</span></span><br><span class="line">            <span class="keyword">var</span> buf = builder.DataBuffer;</span><br><span class="line">            <span class="comment">// GameConfigFB的二进制数据</span></span><br><span class="line">            <span class="built_in">byte</span>[] bufbytes = builder.SizedByteArray();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//写入GameConfig二进制数据得到本地</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> filestream = <span class="keyword">new</span> FileStream(GameConfigDataFullPath, FileMode.Create))</span><br><span class="line">            &#123;</span><br><span class="line">                filestream.Write(bufbytes, <span class="number">0</span>, bufbytes.Length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 读取GameConfig数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ReadGameConfigData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//写入GameConfig二进制数据得到本地</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> filestream = <span class="keyword">new</span> FileStream(GameConfigDataFullPath, FileMode.Open))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] bufbytes = <span class="keyword">new</span> <span class="built_in">byte</span>[filestream.Length];</span><br><span class="line">                filestream.Read(bufbytes, <span class="number">0</span>, bufbytes.Length);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Get an accessor to the root object inside the buffer.</span></span><br><span class="line">                <span class="comment">// 通过字节流数据构建FlatBuff所需的Buf对象，然后使用该Buf对象通过FlatBuff构建GameConfigFB对象</span></span><br><span class="line">                <span class="keyword">var</span> buf = <span class="keyword">new</span> ByteBuffer(bufbytes);</span><br><span class="line">                <span class="keyword">var</span> gameconfig = GameConfigFB.GetRootAsGameConfigFB(buf);</span><br><span class="line"></span><br><span class="line">                Console.WriteLine(<span class="string">&quot;gameconfig.DifficultyLevel : &quot;</span> + gameconfig.DifficultyLevel);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;gameconfig.VersionNumber : &quot;</span> + gameconfig.VersionNumber);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;gameconfig.ResourceNumber : &quot;</span> + gameconfig.ResourceNumber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SaveGameConfigData();</span><br><span class="line"></span><br><span class="line">            ReadGameConfigData();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;结束!&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/FlatBuffGameConfigDataOutput.png" alt="FlatBuffGameConfigDataOutput"><br><img src="/img/Unity/Data-Config-Automation/FlatBuffOutput.png" alt="FlatBuffOutput"><br>可以看到我们成功通过FlatBuff序列化反序列化出了我们想要的数据。</p>
<p>通过上面的使用，可以看出FlatBuff在使用灵活度方面还是比较欠缺，对于数据的填充构建都是通过FlatBufferBuilder按指定填充方式构建数据并填充进去。</p>
<p>这里暂时没有对性能进行测试，具体性能对比参考前面给出过的对比图。</p>
<p>Note：<br>当我把FlatBuffer的.Net代码放进Unity时，我发现里面用到了C# 6.0的高阶语言特性，导致Unity里无法编译通过，所以上面的测试是脱离Unity基于.Net C#工程来测试的。</p>
<h5 id="深入探究"><a href="#深入探究" class="headerlink" title="深入探究"></a>深入探究</h5><p>这一步，让我们结合上面的学习用例来探究下FlatBuffer是如何实现高效的序列化和反序列化读取的。</p>
<p>通过学习了解FlatBuffer下面几个核心的类来理解学习:</p>
<ol>
<li>FlatBufferBuilder.cs(FlatBuffer构建填充数据的对外接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Responsible for building up and accessing a FlatBuffer formatted byte</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> array (via ByteBuffer).</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlatBufferBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _space;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer _bb;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _minAlign = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The vtable for the current table (if _vtableSize &gt;= 0)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] _vtable = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="comment">// The size of the vtable. -1 indicates no vtable</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _vtableSize = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// Starting offset of the current struct/table.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _objectStart;</span><br><span class="line">    <span class="comment">// List of offsets of all vtables.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] _vtables = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="comment">// Number of entries in `vtables` in use.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _numVtables = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// For the current vector being built.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _vectorNumElems = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Create a FlatBufferBuilder with a given initial size.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;initialSize&quot;&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The initial size to use for the internal buffer.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FlatBufferBuilder</span>(<span class="params"><span class="built_in">int</span> initialSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (initialSize &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">&quot;initialSize&quot;</span>,</span><br><span class="line">                initialSize, <span class="string">&quot;Must be greater than zero&quot;</span>);</span><br><span class="line">        _space = initialSize;</span><br><span class="line">        _bb = <span class="keyword">new</span> ByteBuffer(initialSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddInt</span>(<span class="params"><span class="built_in">int</span> o, <span class="built_in">int</span> x, <span class="built_in">int</span> d</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span> (ForceDefaults || x != d) </span><br><span class="line">        &#123; </span><br><span class="line">            AddInt(x); Slot(o); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>这里只截图了FlatBufferBuilder成员变量定义和部分函数定义。
</code></pre>
<ol start="2">
<li>ByteBuffer.cs(定义不同数据类型的byte数据分配以及填充，读取)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBuffer</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBufferAllocator _buffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _pos;  <span class="comment">// Must track start of the buffer.</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params">ByteBufferAllocator allocator, <span class="built_in">int</span> position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer = allocator;</span><br><span class="line">        _pos = position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="built_in">int</span> size</span>) : <span class="title">this</span>(<span class="params"><span class="keyword">new</span> <span class="built_in">byte</span>[size]</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="built_in">byte</span>[] buffer</span>) : <span class="title">this</span>(<span class="params">buffer, <span class="number">0</span></span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="built_in">int</span> pos</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer = <span class="keyword">new</span> ByteArrayAllocator(buffer);</span><br><span class="line">        _pos = pos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_buffer != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _buffer.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Position &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _pos; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; _pos = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Length &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> _buffer.Length; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Reset</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _pos = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Increases the size of the ByteBuffer, and copies the old data towards</span></span><br><span class="line">    <span class="comment">// the end of the new buffer.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="built_in">int</span> newSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer.GrowFront(newSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutStringUTF8</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        AssertOffsetAndLength(offset, <span class="keyword">value</span>.Length);</span><br><span class="line">        Encoding.UTF8.GetBytes(<span class="keyword">value</span>, <span class="number">0</span>, <span class="keyword">value</span>.Length,</span><br><span class="line">            _buffer.ByteArray, offset);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutInt</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        PutUint(offset, (<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteLittleEndian</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> count, <span class="built_in">ulong</span> data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (BitConverter.IsLittleEndian)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _buffer.Buffer[offset + i] = (<span class="built_in">byte</span>)(data &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _buffer.Buffer[offset + count - <span class="number">1</span> - i] = (<span class="built_in">byte</span>)(data &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ByteBufferAllocator.cs(抽象二进制byte数据的分配管理)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">ByteBufferAllocator</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNSAFE_BYTEBUFFER</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="built_in">byte</span>* Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">byte</span>[] Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Length</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="built_in">int</span> newSize</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !ENABLE_SPAN_T</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">byte</span>[] ByteArray &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Table.cs(抽象FlatBuffer自定义结构的数据存储以及读取)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> Table</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> bb_pos;</span><br><span class="line">    <span class="keyword">public</span> ByteBuffer bb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ByteBuffer ByteBuffer &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> bb; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据序列化存储部分：<br>可以看出我们所有的数据最终都被写入在一个一维的byte数组里，而Flatbuffer通过按指定方式往byte数组里填充数据实现对数据的序列化存储。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlatBufferBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer _bb;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBuffer</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBufferAllocator _buffer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutStringUTF8</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutInt</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        PutUint(offset, (<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteLittleEndian</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> count, <span class="built_in">ulong</span> data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteArrayAllocator</span> : <span class="title">ByteBufferAllocator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">byte</span>[] _buffer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="built_in">int</span> newSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer.GrowFront(newSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据反序列化读取部分；</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Table __p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ByteBuffer ByteBuffer </span><br><span class="line">    &#123; </span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> __p.bb; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">       <span class="keyword">return</span> GetRootAsGameConfigFB(_bb, <span class="keyword">new</span> GameConfigFB()); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb, GameConfigFB obj</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">return</span> (obj.__assign(_bb.GetInt(_bb.Position) + _bb.Position, _bb)); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> __init(<span class="built_in">int</span> _i, ByteBuffer _bb) </span><br><span class="line">    &#123; </span><br><span class="line">        __p.bb_pos = _i; __p.bb = _bb; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameConfigFB __assign(<span class="built_in">int</span> _i, ByteBuffer _bb) </span><br><span class="line">    &#123; </span><br><span class="line">        __init(_i, _bb); <span class="keyword">return</span> <span class="keyword">this</span>; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DifficultyLevel </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">4</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.__string(o + __p.bb_pos) : <span class="literal">null</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到当我们通过以下代码读取二进制数据构建我们自定义的GameConfigFB对象时,我们已经把二进制数据按FlatBuffer存储的方式读取进来:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> ByteBuffer(bufbytes);</span><br><span class="line"><span class="keyword">var</span> gameconfig = GameConfigFB.GetRootAsGameConfigFB(buf);</span><br></pre></td></tr></table></figure>

<p>然后通过Table按自定义的数据结构读取指定的偏移把数据成功读取出来(这应该也是为什么FlatBuffer反序列化读取能这么高效的原因):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> ArraySegment&lt;<span class="built_in">byte</span>&gt;? GetDifficultyLevelBytes() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">return</span> __p.__vector_as_arraysegment(<span class="number">4</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> VersionNumber </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">6</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ResourceNumber </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">8</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里放一张其他博客上给出的一张FlatBuffer数据存储图解加深印象，<a target="_blank" rel="noopener" href="https://www.race604.com/flatbuffers-intro/">下图来源</a>:<br><img src="/img/Unity/Data-Config-Automation/FlatBufferBytesStructure.png" alt="FlatBufferBytesStructure"></p>
<h4 id="Xbuffer"><a href="#Xbuffer" class="headerlink" title="Xbuffer"></a>Xbuffer</h4><p>公司一前同事写的基于C#的简化版的Flatbuffer。<br>这里重复再放一次前面放过的性能对比图：<br><img src="/img/Unity/Data-Config-Automation/SerializationPerformanceComparision.png" alt="SerializationPerformanceComparision"><br>可以看到Xbuffer序列化和反序列化性能也相当优秀。</p>
<p>接下来我们通过实战使用和深入探究来学习其中的奥妙。</p>
<h5 id="实战使用-1"><a href="#实战使用-1" class="headerlink" title="实战使用"></a>实战使用</h5><p>使用流程：</p>
<ol>
<li>定义数据结构文件<br>GameConfigXB.xb</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 游戏版本信息</span><br><span class="line">class GameConfigXB</span><br><span class="line">&#123;</span><br><span class="line">    difficultyLevel:string;             // 游戏难度</span><br><span class="line">    versionNumber:int;                  // 游戏版本号</span><br><span class="line">    resourceNumber:int;                 // 游戏资源版本号</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用xbuffer_parser.exe根据模板文件解析数据结构文件生成对应类文件以及对应类Xbuffer序列化反序列化所需的代码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xbuffer_parser.exe input=GameConfigXB.xb template=&quot;templates/csharp_class.ftl&quot; output_dir=&quot;output/csharp/csharp_class/&quot; suffix=&quot;.cs&quot;</span><br><span class="line">xbuffer_parser.exe input=GameConfigXB.xb template=&quot;templates/csharp_buffer.ftl&quot; output_dir=&quot;output/csharp/csharp_buffer/&quot; suffix=&quot;Buffer.cs&quot;</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>

<p>GameConfigXB.cs(对应数据结构文件)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 游戏版本信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GameConfigXB</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> difficultyLevel;              <span class="comment">// 游戏难度</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> versionNumber;               <span class="comment">// 游戏版本号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> resourceNumber;              <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameConfigXBBuffer.cs(对应数据结构Xbuffer序列化反序列化所需文件)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GameConfigXBBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigXB <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">int</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="built_in">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> _difficultyLevel = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            <span class="built_in">int</span> _versionNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            <span class="built_in">int</span> _resourceNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GameConfigXB() &#123;</span><br><span class="line">                difficultyLevel = _difficultyLevel,</span><br><span class="line"></span><br><span class="line">                versionNumber = _versionNumber,</span><br><span class="line"></span><br><span class="line">                resourceNumber = _resourceNumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">GameConfigXB <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="literal">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.difficultyLevel, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.versionNumber, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.resourceNumber, steam);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面生成默认的模板生成的GameConfigXBBuffer.cs貌似跟源码测试使用的接口对不上，需要把模板改成如下:<br>charp_buffer.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">namespace xbuffer</span><br><span class="line">&#123;</span><br><span class="line">    public static class #CLASS_NAME#Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        public static #CLASS_NAME# deserialize(byte[] buffer, ref uint offset)</span><br><span class="line">        &#123;</span><br><span class="line">#IF_DESERIALIZE_CLASS#</span><br><span class="line">            // null</span><br><span class="line">            bool _null = boolBuffer.deserialize(buffer, ref offset);</span><br><span class="line">            if (_null) return null;</span><br><span class="line">#END_DESERIALIZE_CLASS#</span><br><span class="line">#DESERIALIZE_PROCESS#</span><br><span class="line">            // #VAR_NAME#</span><br><span class="line">#IF_SINGLE#</span><br><span class="line">            #VAR_TYPE# _#VAR_NAME# = #VAR_TYPE#Buffer.deserialize(buffer, ref offset);</span><br><span class="line">#END_SINGLE#</span><br><span class="line">#IF_ARRAY#</span><br><span class="line">            int _#VAR_NAME#_length = intBuffer.deserialize(buffer, ref offset);</span><br><span class="line">            #VAR_TYPE#[] _#VAR_NAME# = new #VAR_TYPE#[_#VAR_NAME#_length];</span><br><span class="line">            for (int i = 0; i &lt; _#VAR_NAME#_length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _#VAR_NAME#[i] = #VAR_TYPE#Buffer.deserialize(buffer, ref offset);</span><br><span class="line">            &#125;</span><br><span class="line">#END_ARRAY#</span><br><span class="line">#DESERIALIZE_PROCESS#</span><br><span class="line"></span><br><span class="line">            // value</span><br><span class="line">            return new #CLASS_NAME#() &#123;</span><br><span class="line">#DESERIALIZE_RETURN#</span><br><span class="line">                #VAR_NAME# = _#VAR_NAME#,</span><br><span class="line">#DESERIALIZE_RETURN#</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static void serialize(#CLASS_NAME# value, XSteam steam)</span><br><span class="line">        &#123;</span><br><span class="line">#IF_SERIALIZE_CLASS#</span><br><span class="line">            // null</span><br><span class="line">            boolBuffer.serialize(value == null, steam);</span><br><span class="line">            if (value == null) return;</span><br><span class="line">#END_SERIALIZE_CLASS#</span><br><span class="line">#SERIALIZE_PROCESS#</span><br><span class="line">            // #VAR_NAME#</span><br><span class="line">#IF_SINGLE#</span><br><span class="line">            #VAR_TYPE#Buffer.serialize(value.#VAR_NAME#, steam);</span><br><span class="line">#END_SINGLE#</span><br><span class="line">#IF_ARRAY#</span><br><span class="line">            intBuffer.serialize(value.#VAR_NAME#.Length, steam);</span><br><span class="line">            for (int i = 0; i &lt; value.#VAR_NAME#.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                #VAR_TYPE#Buffer.serialize(value.#VAR_NAME#[i], steam);</span><br><span class="line">            &#125;</span><br><span class="line">#END_ARRAY#</span><br><span class="line">#SERIALIZE_PROCESS#</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>把Xbuffer核心代码xbuffer_runtime.dll放到项目目录下。</li>
<li>使用Xbuffer生成的对应Buffer类序列化和反序列化数据</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 快速访问UI组件测试挂在脚本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIDebugMonoScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Xbuffer内存存储抽象对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> XSteam mXbufferStream;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCreateGameConfigClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onCreateGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.XbufferDataFolderPath : &quot;</span> + PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        PathUtilities.checkAndCreateFolder(PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        <span class="comment">//固定一个内存分配，把数据往这里面填充，不够的画动态扩展</span></span><br><span class="line">        mXbufferStream = <span class="keyword">new</span> XSteam(<span class="number">1</span>, <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1000</span>);</span><br><span class="line">        GameConfigXB gameconfigxb = <span class="keyword">new</span> GameConfigXB();</span><br><span class="line">        gameconfigxb.difficultyLevel = <span class="string">&quot;Hard&quot;</span>;</span><br><span class="line">        gameconfigxb.versionNumber = <span class="number">1</span>;</span><br><span class="line">        gameconfigxb.resourceNumber = <span class="number">1</span>;</span><br><span class="line">        GameConfigXBBuffer.serialize(gameconfigxb, mXbufferStream);</span><br><span class="line">        <span class="keyword">var</span> bytes = mXbufferStream.getBytes();</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> output = File.Create(PathUtilities.XbufferDataFolderPath + <span class="string">&quot;GameConfigXB.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            output.Write(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onReadGameConfigClick</span>()</span> </span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onReadGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.XbufferDataFolderPath : &quot;</span> + PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.XbufferDataFolderPath + <span class="string">&quot;GameConfigXB.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[intput.Length];</span><br><span class="line">            intput.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">            <span class="built_in">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">var</span> gameconfig = GameConfigXBBuffer.deserialize(bytes, <span class="keyword">ref</span> offset);</span><br><span class="line">            Debug.Log(<span class="string">&quot;gameconfig.difficultyLevel : &quot;</span> + gameconfig.difficultyLevel);</span><br><span class="line">            Debug.Log(<span class="string">&quot;gameconfig.versionNumber : &quot;</span> + gameconfig.versionNumber);</span><br><span class="line">            Debug.Log(<span class="string">&quot;gameconfig.resourceNumber : &quot;</span> + gameconfig.resourceNumber);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/XbufferData.png" alt="XbufferData"><br><img src="/img/Unity/Data-Config-Automation/XbufferOutput.png" alt="XbufferOutput"><br>可以看到我们成功通过Xbuffer序列化反序列了数据。</p>
<h5 id="深入探究-1"><a href="#深入探究-1" class="headerlink" title="深入探究"></a>深入探究</h5><p>接下来结合源码，让我们深入Xbuffer内部去看看是如何实现高效的序列化和反序列以及挂镀可配置的。<br>Xbuffer提供了一下两个核心的部件：</p>
<ol>
<li>xbuffe_parser.exe</li>
<li>xbuffer_runtime.dll</li>
</ol>
<h6 id="xbuffer-parser"><a href="#xbuffer-parser" class="headerlink" title="xbuffer_parser"></a>xbuffer_parser</h6><p>xbuffer_parser负责根据模板自动化生成对应类以及Xbuffer序列化反序列化所需文件代码。</p>
<ol>
<li>Config.cs(负责参数的检查 – 这个就不详细介绍了)</li>
<li>Proto.cs(抽象数据结构文件的各个组成部分)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               Proto.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             原型语法解析工具</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2017/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Proto_Class[] class_protos;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto</span>(<span class="params"><span class="built_in">string</span> proto</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> matchs = Regex.Matches(proto, <span class="string">@&quot;//\s*(\S*)\s*((class)|(struct))\s*(\w+)\s*&#123;\s*((\w+):([\[|\]|\w]+);\s*//\s*(\S*)\s*)*&#125;&quot;</span>);</span><br><span class="line">            class_protos = <span class="keyword">new</span> Proto_Class[matchs.Count];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; matchs.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                class_protos[i] = <span class="keyword">new</span> Proto_Class(matchs[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 变量结构</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto_Variable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Var_Type;                             <span class="comment">// 变量类型</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Var_Name;                             <span class="comment">// 变量名</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> IsArray;                                <span class="comment">// 是否是数组</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Var_Comment;                          <span class="comment">// 变量注释</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto_Variable</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">string</span> type, <span class="built_in">string</span> comment</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Var_Name = name;</span><br><span class="line">            <span class="keyword">if</span> (type.Contains(<span class="string">&quot;[&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                Var_Type = type.Substring(<span class="number">1</span>, type.Length - <span class="number">2</span>);</span><br><span class="line">                IsArray = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Var_Type = type;</span><br><span class="line">                IsArray = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Var_Comment = comment;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 类结构</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto_Class</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Class_Comment;                            <span class="comment">// 注释</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Class_Type;                               <span class="comment">// 类型 例如 class struct</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Class_Name;                               <span class="comment">// 类名</span></span><br><span class="line">        <span class="keyword">public</span> Proto_Variable[] Class_Variables;                <span class="comment">// 变量列表</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto_Class</span>(<span class="params">Match match</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Class_Comment = match.Groups[<span class="number">1</span>].Value;</span><br><span class="line">            Class_Type = match.Groups[<span class="number">2</span>].Value;</span><br><span class="line">            Class_Name = match.Groups[<span class="number">5</span>].Value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> varNames = match.Groups[<span class="number">7</span>].Captures;</span><br><span class="line">            <span class="keyword">var</span> varTypes = match.Groups[<span class="number">8</span>].Captures;</span><br><span class="line">            <span class="keyword">var</span> varComments = match.Groups[<span class="number">9</span>].Captures;</span><br><span class="line">            Class_Variables = <span class="keyword">new</span> Proto_Variable[varNames.Count];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Class_Variables.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Class_Variables[i] = <span class="keyword">new</span> Proto_Variable(varNames[i].Value, varTypes[i].Value, varComments[i].Value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>核心思想是通过正则匹配文本内容后，分别将对应内容填充到抽象的Proto类对象里。
</code></pre>
<ol start="3">
<li>Parser.cs(负责将抽象后的数据结构数据结合模板文件转换成对应代码) &amp; Xtemplate.cs(负责模板与代码生成部分的逻辑处理)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               Parser.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             将类对象转化成代码文本</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2017/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Parser</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将类对象转化成代码文本</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;proto_class&quot;&gt;</span>类结构<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;template_str&quot;&gt;</span>模板文本<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">parse</span>(<span class="params">Proto_Class proto_class, <span class="built_in">string</span> template_str, <span class="built_in">bool</span> showHead</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> template = <span class="keyword">new</span> XTemplate(template_str);</span><br><span class="line"></span><br><span class="line">            template.setCondition(<span class="string">&quot;HEAD&quot;</span>, showHead);</span><br><span class="line">            template.setValue(<span class="string">&quot;#CLASS_TYPE#&quot;</span>, proto_class.Class_Type);</span><br><span class="line">            template.setValue(<span class="string">&quot;#CLASS_NAME#&quot;</span>, proto_class.Class_Name);</span><br><span class="line">            template.setValue(<span class="string">&quot;#CLASS_COMMENT#&quot;</span>, proto_class.Class_Comment);</span><br><span class="line"></span><br><span class="line">            template.setCondition(<span class="string">&quot;DESERIALIZE_CLASS&quot;</span>, proto_class.Class_Type == <span class="string">&quot;class&quot;</span>);</span><br><span class="line">            template.setCondition(<span class="string">&quot;SERIALIZE_CLASS&quot;</span>, proto_class.Class_Type == <span class="string">&quot;class&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#VARIABLES#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">&quot;SINGLE&quot;</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">&quot;ARRAY&quot;</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#DESERIALIZE_PROCESS#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">&quot;SINGLE&quot;</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">&quot;ARRAY&quot;</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#DESERIALIZE_RETURN#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#SERIALIZE_PROCESS#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">&quot;SINGLE&quot;</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">&quot;ARRAY&quot;</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> template.getContent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>核心依然是通过正则匹配替换模板文本内容。
</code></pre>
<p>上面几个文件就是解析模板文件以及根据数据结构定义文件生成对应Xbuffer所需代码的核心逻辑。可以看到模板的高自由度配置，让Xbuffer具备了对多语言的快速支持以及灵活配置的能力。</p>
<h6 id="xbuffer-runtime"><a href="#xbuffer-runtime" class="headerlink" title="xbuffer_runtime"></a>xbuffer_runtime</h6><p>xbuffer_runtime.dll是xbuffer对数据进行序列化和反序列化的核心类。</p>
<ol>
<li>XSteam.cs(Xbuffer核心字节流序列化反序列化的关键类)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               XSteam.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             一个简单的内存流实现 用于精准的控制内存管理</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/04/09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XSteam</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> index_group;            <span class="comment">// 当前组别序号 行</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> index_cell;             <span class="comment">// 当前单元序号 列</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> capacity_group;         <span class="comment">// 行的数量</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> capacity_cell;          <span class="comment">// 列的数量</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">byte</span>[][] contents;           <span class="comment">// 内容列表</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span>[] wastes;               <span class="comment">// 浪费列表 对应每一行</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">XSteam</span>(<span class="params"><span class="built_in">uint</span> capacity_group, <span class="built_in">uint</span> capacity_cell</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.capacity_group = capacity_group;</span><br><span class="line">            <span class="keyword">this</span>.capacity_cell = capacity_cell;</span><br><span class="line"></span><br><span class="line">            contents = <span class="keyword">new</span> <span class="built_in">byte</span>[capacity_group][];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; capacity_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                contents[i] = <span class="keyword">new</span> <span class="built_in">byte</span>[capacity_cell];</span><br><span class="line">            &#125;</span><br><span class="line">            wastes = <span class="keyword">new</span> <span class="built_in">uint</span>[capacity_group];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 申请空间</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 基本策略是不够了就申请一倍</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;size&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applySize</span>(<span class="params"><span class="built_in">uint</span> size</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (index_cell + size &gt; capacity_cell)</span><br><span class="line">            &#123;</span><br><span class="line">                wastes[index_group] = capacity_cell - index_cell;</span><br><span class="line">                index_cell = <span class="number">0</span>;</span><br><span class="line">                index_group++;</span><br><span class="line">                <span class="keyword">if</span> (index_group &gt;= capacity_group)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> nCapacity_Group = capacity_group + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> nContents = <span class="keyword">new</span> <span class="built_in">byte</span>[nCapacity_Group][];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">uint</span> i = <span class="number">0</span>; i &lt; nCapacity_Group; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (i &lt; capacity_group)</span><br><span class="line">                            nContents[i] = contents[i];</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            nContents[i] = <span class="keyword">new</span> <span class="built_in">byte</span>[capacity_cell];</span><br><span class="line">                    &#125;</span><br><span class="line">                    contents = nContents;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> nWastes = <span class="keyword">new</span> <span class="built_in">uint</span>[nCapacity_Group];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">uint</span> i = <span class="number">0</span>; i &lt; capacity_group; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nWastes[i] = wastes[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    wastes = nWastes;</span><br><span class="line"></span><br><span class="line">                    capacity_group = nCapacity_Group;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回输出字节流</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">getBytes</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> len = index_group * capacity_cell + index_cell;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; index_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                len -= wastes[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">byte</span>[len];</span><br><span class="line">            <span class="keyword">var</span> idx = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; index_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; capacity_cell - wastes[i]; j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    ret[idx++] = contents[i][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; index_cell; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                ret[idx++] = contents[index_group][i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>从上面源码可以看出，Xbuffer是采用了一个二维的byte数组来存储原始数据的(*实现固定内存大小的数据分配*)。空间容量不够的时候在扩容处理，这一点和Flatbuffer是类似的(Flatbuffer貌似是个一维数组)。当现有定义的空间不足时，Xbuffer采取的是翻倍处理(数据存储上是采用扩展二维数组的第二维度实现扩容)。这里可以想成，

举个例子，一开始是byte[1][1024]的byte数组容量。当不够的时候，会扩展成byte[2][1024]的容量，然后从byte[2][]开始填充新的数据，而byte[1][]里未填充完的部分，就当做浪费的部分不再使用。

*但最后返回Xstream的byte数据时，是返回的一个一维byte数组，并且是剔除了wast部分的byte分配，详情见Xstream的getBytes方法*
</code></pre>
<ol start="2">
<li>boolBuffer.cs &amp; byteBuffer.cs &amp; floatBuffer.cs &amp; intBuffer.cs &amp; longBuffer.cs &amp; stringBuffer.cs &amp; uintBuffer.cs(负责对各数据类型的数据序列化写入和反序列化读取进行实现)<br>下面以intBuffer.cs为例:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               intBuffer.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             基本类型处理</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2017/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">intBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">uint</span> size = <span class="keyword">sizeof</span>(<span class="built_in">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr = buffer)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> <span class="keyword">value</span> = *(<span class="built_in">int</span>*)(ptr + offset);</span><br><span class="line">                offset += size;</span><br><span class="line">                <span class="keyword">return</span> BitConverter.IsLittleEndian ? <span class="keyword">value</span> : (<span class="built_in">int</span>)utils.toLittleEndian((<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            steam.applySize(size);</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr = steam.contents[steam.index_group])</span><br><span class="line">            &#123;</span><br><span class="line">                *(<span class="built_in">int</span>*)(ptr + steam.index_cell) = BitConverter.IsLittleEndian ? <span class="keyword">value</span> : (<span class="built_in">int</span>)utils.toLittleEndian((<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">                steam.index_cell += size;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>从上面可以看出，底层的数据写入是根据数据类型大小，通过fixed使用非托管的内存分配方式进行指定内存位置指定数据byte的写入和读取。

举个例子，一开始分配了byte[1][1024*1024]也就是1M的内存，当我们写入一个int数据时，因为int类型的byte大小是4bytes也就是32bits，也就是说byte[1][0] - byte[1][4]的内存数据时用于存储这个int的值。其他类型同理。
</code></pre>
<ol start="3">
<li>utils.cs(负责一些细节处理，比如大小端问题，这里就不放源码了)</li>
<li>Serializer.cs(提供模板化的序列化反序列化读取加载接口)</li>
<li>***Buffer.cs(自动化生成的序列化反序列化所需的类代码)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GameConfigXBBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigXB <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="built_in">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            <span class="built_in">string</span> _difficultyLevel = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);            </span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            <span class="built_in">int</span> _versionNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            <span class="built_in">int</span> _resourceNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GameConfigXB()</span><br><span class="line">            &#123;</span><br><span class="line">                difficultyLevel = _difficultyLevel,</span><br><span class="line"></span><br><span class="line">                versionNumber = _versionNumber,</span><br><span class="line"></span><br><span class="line">                resourceNumber = _resourceNumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">GameConfigXB <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="literal">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.difficultyLevel, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.versionNumber, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.resourceNumber, steam);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>从上面可以看到，根据数据结构定义文件生成对应的序列化和反序列化代码核心是通过各成员数据按循序依次以各自类型的写入方式将数据写入XStream里。
反序列化时同理依次从byte数据里读取出来。
不难看出，数据存储确实和Flatbuffer类似，存储在一个固定的内存byte[]数组里，只不过是一维和二维数组的区别(*但实际上最后返回Xstream的byte数据时，是剔除了wast部分的一个一维的byte数组*)。数据序列化和反序列化都是读取指定内存位置按指定数据类型读取出来即可，这应该就是Xbuffer和Flatbuffer序列化和反序列化高效的原因吧。
</code></pre>
<h3 id="方案比较-1"><a href="#方案比较-1" class="headerlink" title="方案比较"></a>方案比较</h3><p>不同的序列化反序列化库的优劣比较:</p>
<ol>
<li>自定义数据填充和读取<br>优点：</li>
</ol>
<ul>
<li>实现简单<br>缺点:</li>
<li>序列化和反序列化速度慢，内存开销大</li>
<li>不适合数据量大和频繁使用的情况</li>
</ul>
<p><em>适用于数据量不大且不需要跨语言的情况，不适合对性能要求高的场合。</em></p>
<ol start="2">
<li>ProtoBuff<br>优点：</li>
</ol>
<ul>
<li>序列化和反序列化速度和内存开销都很不错</li>
<li>数据定义向后兼容</li>
<li>高度自定义配置数据结构(proto文件)</li>
<li>数据序列化反序列化代码简介，接口简单</li>
<li>社区强大<br>缺点:</li>
<li>相比FlatBuffer和Xbuffer速度和内存开销上不占优势</li>
</ul>
<p><em>很适合作为网络数据传输方案(向后兼容)。</em></p>
<ol start="3">
<li>FlatBuff<br>优点：</li>
</ol>
<ul>
<li>序列化和反序列化速度快，内存开销小</li>
<li>支持自定义配置数据结构(schema文件)<br>缺点:</li>
<li>序列化反序列化代码编写过于面向内存结构，不符合平时面向对象的编写风格，编写复杂(这一层被Xbuffer封装成自动化生成***Buffer.cs的代码类)</li>
</ul>
<ol start="4">
<li>XBuffer<br>优点:</li>
</ol>
<ul>
<li>序列化和反序列化速度快，内存开销小</li>
<li>高度自由配置(基于模板配置且自定义配置文件配置)</li>
<li>接口简单方便使用，支持泛型和非泛型序列化反序列化</li>
<li>根据需求可以快速修改来符合自身需求(比如要做导表工具，只需在上层再封一层即可)<br>缺点:</li>
<li>向后不兼容(因为数据是严格按照数据结构按顺序读取的，所以当已经存储进数据库的数据，在扩展字段内容后是无法正常反序列化读取出来的)</li>
</ul>
<p><em>不适合作为网络序列化数据方案，更适合表格数据序列化反序列化方案。</em></p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="方案选择"><a href="#方案选择" class="headerlink" title="方案选择"></a>方案选择</h3><p>学习了解了那么多序列化和反序列化的库，根据我现有的需求是制作一个导表工具(速度和内存开销以及配置灵活度都要求比较高)来看，个人认为基于Xbuffer来编写是比较适合的一种方案。</p>
<p>原因如下:</p>
<ol>
<li>速度快</li>
<li>内存开销小</li>
<li>高度可配置</li>
</ol>
<h3 id="基于Xbuffer的导表工具"><a href="#基于Xbuffer的导表工具" class="headerlink" title="基于Xbuffer的导表工具"></a>基于Xbuffer的导表工具</h3><p>流程：</p>
<ol>
<li>定义导表工具基础功能需求</li>
<li>XML配置导表相关路径数据(比如表格路径配置，输出目录配置等)</li>
<li>定义excel表格格式规则</li>
<li>读取excel数据(Window可以使用ExcelRead库)</li>
<li>创建excel对应Xbuffer数据结构文件(这一步需要自己去写)</li>
<li>使用Xbuffer_parser解析新生成的数据结构文件，生成所需类文件以及序列化相关文件(使用Xbuffer_parser解析即可)</li>
<li>使用生成的代码序列化excel数据到二进制数据流(这一步需要自己去写)</li>
<li>封装一层表格数据读取快速读取管理类，负责统一管理表格数据的加载和读取(这一步需要自己去写)</li>
<li>通过统一管理类使用Xbuffer去加载读取序列化的二进制数据(结合自身代码，使用Xbuffer_runtime.dll里的核心代码去反序列化)</li>
</ol>
<p>相关语言及工具：<br>C#(Unity客户端使用的语言)<br>Xbuffer(第三方序列化反序列化库)</p>
<p>接下将来针对每一步的实现进行实战学习。</p>
<h4 id="导表功能需求"><a href="#导表功能需求" class="headerlink" title="导表功能需求"></a>导表功能需求</h4><ol>
<li>支持int，float，long, string, bool基础数据配置</li>
<li>支持一维和多维数据配置(进阶功能，理论上，对于xbuffer而言，数组的维度扩展就能支持多维数据)</li>
<li>自动生成表格数据以及表格读取相关代码</li>
<li>工具独立于Unity存在使用</li>
<li>支持跨语言(xbuffer理论上通过模板生成不同语言版本的相关代码即可)</li>
<li>支持XML配置相关工具配置(比如表格路径配置，输出目录配置等。)</li>
</ol>
<h4 id="支持导表路径配置"><a href="#支持导表路径配置" class="headerlink" title="支持导表路径配置"></a>支持导表路径配置</h4><p>因为工具是独立于Unity所以不受Unity .Net版本的限制，这里决定使用.Net自身的XML解析库System.XML。</p>
<p>ExportConfig.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">ExportConfig</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">ExcelInputPath</span>&gt;</span>./Excels/<span class="tag">&lt;/<span class="name">ExcelInputPath</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">TemplatePath</span>&gt;</span>./Templates/<span class="tag">&lt;/<span class="name">TemplatePath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">DesFileOutputPath</span>&gt;</span>./DesFiles/<span class="tag">&lt;/<span class="name">DesFileOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">ByteDataOutputPath</span>&gt;</span>./../Assets/Resources/DataBytes/<span class="tag">&lt;/<span class="name">ByteDataOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">CSClassCodeOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSOutput/ClassCode/<span class="tag">&lt;/<span class="name">CSClassCodeOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">CSBufferCodeOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSOutput/BufferCode/<span class="tag">&lt;/<span class="name">CSBufferCodeOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">CSTemplateOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSTemplateOutput/<span class="tag">&lt;/<span class="name">CSTemplateOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">OtherLanguageCodeOutputPath</span>&gt;</span>./OtherOutput/<span class="tag">&lt;/<span class="name">OtherLanguageCodeOutputPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ExportConfig</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ExportConfig.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             导表工具导出配置数据抽象</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">XbufferExcelToData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExportConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 表格数据路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ExcelInputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Xbuffer模板路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> TemplatePath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 序列化数据输出路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ByteDataOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> CS代码输出路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> CSCodeOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 其他语言代码输出路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> OtherLanguageCodeOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打印所有信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printOutAllInfo</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;ExcelInputPath : &#123;0&#125;&quot;</span>, ExcelInputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;TemplatePath : &#123;0&#125;&quot;</span>, TemplatePath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;DesFileOutputPath : &#123;0&#125;&quot;</span>, DesFileOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;ByteDataOutputPath : &#123;0&#125;&quot;</span>, ByteDataOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;CSCodeOutputPath : &#123;0&#125;&quot;</span>, CSCodeOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;OtherLanguageCodeOutputPath : &#123;0&#125;&quot;</span>, OtherLanguageCodeOutputPath));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>XbufferExcelToDataConfig.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             导表工具相关配置单例类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> System.Xml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">XbufferExcelToData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 导表工具相关配置单例类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XbufferExcelToDataConfig</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">XbufferExcelToDataConfig</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> XML配置文件全路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> XMLConfigFileFullPath &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 导出配置数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> ExportConfig ExportConfigInfo &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">XbufferExcelToDataConfig</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            XMLConfigFileFullPath = <span class="string">&quot;./ExportConfig.xml&quot;</span>;</span><br><span class="line">            ExportConfigInfo = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 加载导出配置数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">LoadExportConfigData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(File.Exists(XMLConfigFileFullPath))</span><br><span class="line">            &#123;</span><br><span class="line">                XmlDocument xmldoc = <span class="keyword">new</span> XmlDocument();</span><br><span class="line">                xmldoc.Load(XMLConfigFileFullPath);</span><br><span class="line">                <span class="keyword">var</span> rootnode = xmldoc.DocumentElement;</span><br><span class="line">                <span class="keyword">var</span> rootnodename = rootnode.Name;</span><br><span class="line">                <span class="keyword">var</span> reflecttype = <span class="keyword">this</span>.GetType().Assembly.GetType(<span class="string">&quot;XbufferExcelToData.&quot;</span> + rootnodename);</span><br><span class="line">                <span class="keyword">if</span>(reflecttype ==  <span class="keyword">typeof</span>(ExportConfig))</span><br><span class="line">                &#123;</span><br><span class="line">                    ExportConfigInfo = <span class="keyword">new</span> ExportConfig();</span><br><span class="line">                    <span class="keyword">var</span> childnodes = rootnode.ChildNodes;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>, length = childnodes.Count; i &lt; length; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> property = ExportConfigInfo.GetType().GetProperty(childnodes[i].Name);</span><br><span class="line">                        <span class="keyword">if</span>(property != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            property.SetValue(ExportConfigInfo, childnodes[i].InnerText);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;不支持的属性配置 : &#123;0&#125;&quot;</span>, childnodes[i].Name));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;                    </span><br><span class="line">                    ExportConfigInfo.printOutAllInfo();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;找不到配置的类型数据信息 : &#123;0&#125;&quot;</span>, rootnodename));</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;当前只支持ExportConfig类型信息配置&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;导出配置文件不存在 : &#123;0&#125;&quot;</span>, XMLConfigFileFullPath));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/LoadXMLConfig.png" alt="LoadXMLConfig"><br>可以看到我们成功的读取了XML里配置的信息(后续的导表工具会用到)。</p>
<h4 id="定义表格规则"><a href="#定义表格规则" class="headerlink" title="定义表格规则"></a>定义表格规则</h4><ol>
<li>第一行定义字段</li>
<li>第二行写字段注释</li>
<li>第三行定义字段类型</li>
<li>第四行表示分割符(只对一维数组类型有用)</li>
<li>第五和第六行保留为未来扩展使用</li>
<li>第七行及以后正式填写数据(数据不填采用对应类型的默认值，比如int为0，bool为false，int[]为null)</li>
</ol>
<h4 id="读取excel数据"><a href="#读取excel数据" class="headerlink" title="读取excel数据"></a>读取excel数据</h4><p>Windows PC端决定使用ExcelRead库来解决excel读取问题。</p>
<p>核心代码是下面两个文件：<br>ExcelDataManager.cs<br>ExcelData.cs</p>
<p>考虑到博客暂时不支持代码折叠，这里就不直接放源代码了，整个工程源代码会在博客最后给出链接。<br>主要实现了以下功能：</p>
<ol>
<li>按表格规则解析</li>
<li>检查表格配置是否正确(1. 不允许同名excel sheet 2. 字段名不允许重复 3. 支持的数据类型检查 4. id第一列必须为int类型且不允许不填且同一个表格id不能重复 5. 支持的分隔符检查配置)</li>
</ol>
<p>这里直接验证下读取Excel数据的结果:<br><img src="/img/Unity/Data-Config-Automation/ExcelDatOutput.png" alt="ExcelDatOutput"></p>
<h4 id="创建对应数据结构文件"><a href="#创建对应数据结构文件" class="headerlink" title="创建对应数据结构文件"></a>创建对应数据结构文件</h4><p>这一步，我们需要自动化生成Xbuffer用于自动化生成相关序列化代码的数据结构定义文件。</p>
<p>还记的我们前面学习Xbuffer时定义的GameConfigXB.xb吗?<br>GameConfigXB.xb</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 游戏版本信息</span></span><br><span class="line"><span class="keyword">class</span> <span class="title">GameConfigXB</span></span><br><span class="line">&#123;</span><br><span class="line">    difficultyLevel:<span class="built_in">string</span>;             <span class="comment">// 游戏难度</span></span><br><span class="line">    versionNumber:<span class="built_in">int</span>;                  <span class="comment">// 游戏版本号</span></span><br><span class="line">    resourceNumber:<span class="built_in">int</span>;                 <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们现在的目标就是将我们的Excel定义的数据内容转换成对应的数据结构定义文件。</p>
<p>实现方案思考：<br>数据结构定义文件不需要考虑跨平台，真正跨平台的实现是在序列化模板文件那一步完成的，所以这里打算简单的通过字节流形式按顺序文本写入即可。</p>
<p>代码很简单，就是利用之前存储的表格数据信息，一次写入字符串信息，最后通过文件流写入文件，这里就不放源代码了。</p>
<p>核心类是:<br>XbufferExcelToDesFile.cs</p>
<p>直接来看下最终生成的结果:<br>t_AuthorInfo.xb</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t_AuthorInfo的注释</span></span><br><span class="line"><span class="keyword">class</span> <span class="title">t_AuthorInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    id:<span class="built_in">int</span>;                                      <span class="comment">//唯一id</span></span><br><span class="line">    author:<span class="built_in">string</span>;                                <span class="comment">//作者</span></span><br><span class="line">    age:<span class="built_in">int</span>;                                        <span class="comment">//年龄</span></span><br><span class="line">    money:<span class="built_in">float</span>;                                    <span class="comment">//拥有金钱</span></span><br><span class="line">    hashouse:<span class="built_in">bool</span>;                                <span class="comment">//拥有房子</span></span><br><span class="line">    pbutctime:<span class="built_in">long</span>;                              <span class="comment">//出版utc时间</span></span><br><span class="line">    luckynumber:[<span class="built_in">int</span>];                            <span class="comment">//幸运数字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一步，我们成功自动化生成了Xbuffer需要的Excel对应的数据结构定义文件。</p>
<h4 id="生成序列化所需文件"><a href="#生成序列化所需文件" class="headerlink" title="生成序列化所需文件"></a>生成序列化所需文件</h4><p>为了便于修改Xbuffer满足我们新的需求，这里直接把Xbuffer的两个核心工程(xbuffer_parser &amp; xbuffer_runtime)集成到我们的导表工具里来：<br><img src="/img/Unity/Data-Config-Automation/IntegrateXbuffer.png" alt="IntegrateXbuffer"></p>
<p>然后修改Xbuffer两个核心工程的输出路径和我们主工程一致(便于主工程使用):<br><img src="/img/Unity/Data-Config-Automation/ModifyXbufferOutputPath.png" alt="ModifyXbufferOutputPath"></p>
<p>然后编译出两个工程各自的核心文件:<br><img src="/img/Unity/Data-Config-Automation/CompileXbufferCSProjects.png" alt="CompileXbufferCSProjects"></p>
<p>为了不修改原有Xbuffer的使用方式，这里采用通过跨程序调用exe的方式来使用Xbuffer。<br>核心类是:<br>XbufferDesFileToCSCode.cs</p>
<p>成功生成序列化相关代码:<br>t_AuthorInfoBuffer.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">t_AuthorInfoBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> t_AuthorInfo <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="built_in">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// id</span></span><br><span class="line">            <span class="built_in">int</span> _id = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// author</span></span><br><span class="line">            <span class="built_in">string</span> _author = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// age</span></span><br><span class="line">            <span class="built_in">int</span> _age = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// money</span></span><br><span class="line">            <span class="built_in">float</span> _money = floatBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// hashouse</span></span><br><span class="line">            <span class="built_in">bool</span> _hashouse = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pbutctime</span></span><br><span class="line">            <span class="built_in">long</span> _pbutctime = longBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// luckynumber</span></span><br><span class="line">            <span class="built_in">int</span> _luckynumber_length = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="built_in">int</span>[] _luckynumber = <span class="keyword">new</span> <span class="built_in">int</span>[_luckynumber_length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; _luckynumber_length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _luckynumber[i] = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> t_AuthorInfo() &#123;</span><br><span class="line">                id = _id,</span><br><span class="line">                author = _author,</span><br><span class="line">                age = _age,</span><br><span class="line">                money = _money,</span><br><span class="line">                hashouse = _hashouse,</span><br><span class="line">                pbutctime = _pbutctime,</span><br><span class="line">                luckynumber = _luckynumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">t_AuthorInfo <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="literal">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// id</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.id, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// author</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.author, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// age</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.age, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// money</span></span><br><span class="line">            floatBuffer.serialize(<span class="keyword">value</span>.money, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// hashouse</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span>.hashouse, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pbutctime</span></span><br><span class="line">            longBuffer.serialize(<span class="keyword">value</span>.pbutctime, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// luckynumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.luckynumber.Length, steam);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">value</span>.luckynumber.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                intBuffer.serialize(<span class="keyword">value</span>.luckynumber[i], steam);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>t_AuthorInfo.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t_AuthorInfo的注释</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">t_AuthorInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> id;              <span class="comment">// 唯一id</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> author;               <span class="comment">// 作者</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> age;             <span class="comment">// 年龄</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> money;             <span class="comment">// 拥有金钱</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> hashouse;               <span class="comment">// 拥有房子</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> pbutctime;              <span class="comment">// 出版utc时间</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span>[] luckynumber;               <span class="comment">// 幸运数字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:<br>因为xbuffer_parser默认只支持一个一个文件解析，保留原始使用方法会导致弹过多的弹窗，所以这里把xbuffer_parser改成指定目录形式的自动化生成。</p>
<h4 id="序列化数据"><a href="#序列化数据" class="headerlink" title="序列化数据"></a>序列化数据</h4><p>Xbuffer序列化相关的代码自动生成完成后，下一步就是把Excel的数据序列化到我们指定的二进制文件流了。</p>
<p>实现方案思考：</p>
<ul>
<li>这一步主要依赖于最初存储的Excel数据以及前面生成的Xbuffer相关的序列化代码来进行序列化数据。</li>
<li>但序列化的代码是动态生成的没有被编译到工具代码里的，我们无法利用现成的序列化代码来进行数据序列化。</li>
<li>只能根据表格数据以及类型信息通过Xbuffer的基础数据类型写入对应数据，反序列化时再利用反序列化代码进行数据读取。</li>
<li>除了写入数据信息，我们还需要在写入数据信息之前，写入两个关键信息(1. 数据数量(行数) 2. 数据长度(字节数))，用于我们后面去读取加载存储数据时使用，后者如果完全是一个byte对应一个excel数据的话倒是可以不用存储，因为加载后就已经知道总长度了，但如果是所有byte通过zip压缩到一起的话就需要知道每个byte的数据长度。</li>
</ul>
<p>序列化的核心代码文件:<br>XbufferExcelDataToBytes.cs</p>
<p>Note:</p>
<ol>
<li>暂时是一个Excel文件对应一个bytes数据的方式进行存储。(<strong>2022&#x2F;1&#x2F;22完成了单Excel多Sheet导出的支持</strong>)</li>
<li>如果想对数据进行压缩或者加密验证，都可以在序列化这一步或者压缩之后写入数据，然后在加载时反向操作判定对比即可。(TODO:优化)</li>
</ol>
<h4 id="统一表格数据加载和读取"><a href="#统一表格数据加载和读取" class="headerlink" title="统一表格数据加载和读取"></a>统一表格数据加载和读取</h4><p>这一步是属于加载一测的了，是需要运用在Unity里的代码，统一表格加载管理是为了对于表格数据进行快速的访问和管理(一般都会有个GameDataManager之类的单例类负责管理)。<br>因为表格数据是动态生成的，所以加载的代码也需要动态生成。</p>
<p>实现方案思考:</p>
<ul>
<li>这一步因为涉及到自动化的加载代码生成，会涉及到多语言支持问题，所以如果想要支持多语言最好通过模板一类的方式来动态生成代码。</li>
<li>虽然Xbuffer里有一套根据模板生成代码的方案，但想自己尝试实现一下，所以不准备直接拿过来用，准备参考Xbuffer模板替换思路自己模仿写一份(尝试写了这个才发现正则的强大之处)。</li>
</ul>
<p>模板功能需求：</p>
<ul>
<li>支持模板内容基于占位符替换</li>
<li>支持模板内容基于占位符循环替换</li>
</ul>
<p>实现方案跟Xbuffer的一样，支持如下功能：</p>
<ol>
<li>支持两种替换规则(1. 占位符单次替换 2. 限定模板内容多次替换累加)</li>
<li>前者作用范围整个模板(不包含多次替换模板内容部分 – 通过定义不重复的占位符来实现)，后者允许指定局部内容作为模板用于多次替换累加</li>
<li>多次替换模板内容允许跨行</li>
<li>模板占位符可自定义名字，但格式必须是:#名字#</li>
<li>多次替换模板内可定义占位符，支持占位符单次替换</li>
</ol>
<p>比如如下定义方式:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated, do not edit it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> Xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#循环标签名1#</span></span><br><span class="line">        <span class="keyword">public</span> <span class="meta">#循环占位符名1#Container #循环占位符名1#Container = new #循环占位符名1#Container();</span></span><br><span class="line">        <span class="meta">#循环标签名1#</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#循环标签名2#</span></span><br><span class="line">        <span class="meta">#循环占位符名2#Container.loadDataFromBin();</span></span><br><span class="line">        <span class="meta">#循环标签名2#</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Instance = <span class="keyword">new</span> GameDataManager();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模板文件定义分析:</p>
<ol>
<li>整个文件内容是作为完整的模板内容。</li>
<li>在非循环占位符标签内的#占位符名#会用于作为单次替换占位符</li>
<li>循环标签名1和循环标签名2定义一个局部模板内容作为多次替换的模板(循环标签必须配对使用，且不允许同一个模板里重复使用)</li>
<li>循环占位符名1和循环占位符名2表示多次替换模板里的占位符(注意不能和单次占位符名字重复，不然会被单次替换掉)</li>
</ol>
<p>这里主要需要以下几个文件的模板:<br>先手写一版模板初稿</p>
<ol>
<li>GameDataManager.ftl – GameDataManager.cs(表数据统一加载管理类)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated, do not edit it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Singleton = <span class="keyword">new</span> GameDataManager();</span><br><span class="line"></span><br><span class="line">        <span class="meta">#CONTAINER_MEMBER_LOOP#</span></span><br><span class="line">        <span class="keyword">private</span> <span class="meta">#CLASS_NAME#Container m#CLASS_NAME#Container = new #CLASS_NAME#Container();</span></span><br><span class="line">        <span class="meta">#CONTAINER_MEMBER_LOOP#</span></span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="meta">#CONTAINER_LOAD_LOOP#</span></span><br><span class="line">			m<span class="meta">#LOOP_CLASS_NAME#Container.loadDataFromBin();</span></span><br><span class="line">			<span class="meta">#CONTAINER_LOAD_LOOP#</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">#CONTAINER_GET_LOOP#</span></span><br><span class="line">		<span class="keyword">public</span> List&lt;<span class="meta">#LOOP_CLASS_NAME#&gt; Get#LOOP_CLASS_NAME#List()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> m<span class="meta">#LOOP_CLASS_NAME#Container.getList();</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #LOOP_CLASS_NAME#&gt; Get#LOOP_CLASS_NAME#Map()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> m<span class="meta">#LOOP_CLASS_NAME#Container.getMap();</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">#CONTAINER_GET_LOOP#</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>excelContainer.ftl – excelContainer.cs(表格数据存储类)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated by XbufferExcelToData, do not edit it </span></span><br><span class="line"><span class="comment"> * 表格名字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> #<span class="title">CLASS_NAME</span>#<span class="title">Container</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;<span class="meta">#CLASS_NAME#&gt; list = null;</span></span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #CLASS_NAME#&gt; map = null;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="meta">#CLASS_NAME#&gt; getList()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="literal">null</span> || list.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #CLASS_NAME#&gt; getMap()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (map == <span class="literal">null</span> || map.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearList</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.Count &gt; <span class="number">0</span>)</span><br><span class="line">                list.Clear();</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="literal">null</span> &amp;&amp; map.Count &gt; <span class="number">0</span>)</span><br><span class="line">                map.Clear();</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadDataFromBin</span>()</span></span><br><span class="line">        &#123;   </span><br><span class="line">            Stream fs = ConfLoader.Singleton.getStreamByteName(<span class="keyword">typeof</span>(<span class="meta">#CLASS_NAME#).Name);</span></span><br><span class="line">            <span class="keyword">if</span>(fs != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                BinaryReader br = <span class="keyword">new</span> BinaryReader(fs);</span><br><span class="line">                <span class="built_in">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">bool</span> frist = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span> (fs.Length - fs.Position &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (frist)</span><br><span class="line">                        &#123;</span><br><span class="line">                            frist = <span class="literal">false</span>;</span><br><span class="line">                            ClearList();</span><br><span class="line">                            <span class="keyword">var</span> count = br.ReadInt32();</span><br><span class="line">                            list =  <span class="keyword">new</span> List&lt;<span class="meta">#CLASS_NAME#&gt;(count);</span></span><br><span class="line">                            map = <span class="keyword">new</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #CLASS_NAME#&gt;(count);</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> length = br.ReadInt32();</span><br><span class="line">                        <span class="keyword">var</span> data = br.ReadBytes(length);</span><br><span class="line">                        <span class="keyword">var</span> obj= <span class="meta">#CLASS_NAME#Buffer.deserialize(data, ref offset);</span></span><br><span class="line">                        offset = <span class="number">0</span>;</span><br><span class="line">                        list.Add(obj);</span><br><span class="line">                        map.Add(obj.<span class="meta">#ID_NAME#, obj); </span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.LogError(<span class="string">&quot;import data error: &quot;</span> + ex.ToString());</span><br><span class="line">                &#125;           </span><br><span class="line">                br.Close();</span><br><span class="line">                fs.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ConfLoader.cs(二进制配置数据文件加载类 - 这个不需要自动化生成)</li>
</ol>
<p>这里只支持了一维数组维度的配置:<br>来看下自动生成后的相关代码：<br>GameDataManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated, do not edit it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Instance = <span class="keyword">new</span> GameDataManager();</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> t_AuthorInfoContainer mt_AuthorInfoContainer = <span class="keyword">new</span> t_AuthorInfoContainer();</span><br><span class="line">        </span><br><span class="line">        ******</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> t_language_cnContainer mt_language_cnContainer = <span class="keyword">new</span> t_language_cnContainer();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> t_uiContainer mt_uiContainer = <span class="keyword">new</span> t_uiContainer();</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			</span><br><span class="line">			mt_AuthorInfoContainer.loadDataFromBin();</span><br><span class="line">			</span><br><span class="line">			******</span><br><span class="line">			</span><br><span class="line">			mt_language_cnContainer.loadDataFromBin();</span><br><span class="line">			</span><br><span class="line">			mt_uiContainer.loadDataFromBin();</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> List&lt;t_AuthorInfo&gt; <span class="title">Gett_AuthorInfoList</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_AuthorInfoContainer.getList();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt; <span class="title">Gett_AuthorInfoMap</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_AuthorInfoContainer.getMap();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">        ******</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> List&lt;t_ui&gt; <span class="title">Gett_uiList</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_uiContainer.getList();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, t_ui&gt; <span class="title">Gett_uiMap</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_uiContainer.getMap();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>t_AuthorInfoContainer.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated by XbufferExcelToData, do not edit it </span></span><br><span class="line"><span class="comment"> * 表格名字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_AuthorInfoContainer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;t_AuthorInfo&gt; list = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt; map = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;t_AuthorInfo&gt; <span class="title">getList</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="literal">null</span> || list.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt; <span class="title">getMap</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (map == <span class="literal">null</span> || map.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearList</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.Count &gt; <span class="number">0</span>)</span><br><span class="line">                list.Clear();</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="literal">null</span> &amp;&amp; map.Count &gt; <span class="number">0</span>)</span><br><span class="line">                map.Clear();</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadDataFromBin</span>()</span></span><br><span class="line">        &#123;   </span><br><span class="line">            Stream fs = ConfLoader.Singleton.getStreamByteName(<span class="keyword">typeof</span>(t_AuthorInfo).Name);</span><br><span class="line">            <span class="keyword">if</span>(fs != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                BinaryReader br = <span class="keyword">new</span> BinaryReader(fs);</span><br><span class="line">                <span class="built_in">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">bool</span> frist = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span> (fs.Length - fs.Position &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (frist)</span><br><span class="line">                        &#123;</span><br><span class="line">                            frist = <span class="literal">false</span>;</span><br><span class="line">                            ClearList();</span><br><span class="line">                            <span class="keyword">var</span> count = br.ReadInt32();</span><br><span class="line">                            list =  <span class="keyword">new</span> List&lt;t_AuthorInfo&gt;(count);</span><br><span class="line">                            map = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt;(count);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> length = br.ReadInt32();</span><br><span class="line">                        <span class="keyword">var</span> data = br.ReadBytes(length);</span><br><span class="line">                        <span class="keyword">var</span> obj= t_AuthorInfoBuffer.deserialize(data, <span class="keyword">ref</span> offset);</span><br><span class="line">                        offset = <span class="number">0</span>;</span><br><span class="line">                        list.Add(obj);</span><br><span class="line">                        map.Add(obj.id, obj); </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.LogError(<span class="string">&quot;import data error: &quot;</span> + ex.ToString());</span><br><span class="line">                &#125;           </span><br><span class="line">                br.Close();</span><br><span class="line">                fs.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note：</p>
<ol>
<li>占时我ConfLoad.cs加载二进制文件是通过放在Resources目录下以TextAsset形式加载进来，所以加载的时候是没带后缀的，具体ConfLoad代码根据不同的存储位置和加载方式会稍作改动。</li>
</ol>
<h4 id="读取序列化数据"><a href="#读取序列化数据" class="headerlink" title="读取序列化数据"></a>读取序列化数据</h4><p>终于走到最后一步了，完成这一步，导表工具的工具链基本就算打通了。</p>
<p>ConfLoader.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             配置表加载辅助单例类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 配置表加载辅助单例类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConfLoader</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">ConfLoader</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel表格数据存储目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ExcelDataFolderPath = <span class="string">&quot;DataBytes/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConfLoader</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取表格配置数据的二进制流数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bytefilename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Stream <span class="title">getStreamByteName</span>(<span class="params"><span class="built_in">string</span> bytefilename</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> textasset = Resources.Load(ExcelDataFolderPath + bytefilename) <span class="keyword">as</span> TextAsset;</span><br><span class="line">        <span class="keyword">var</span> memorystream = <span class="keyword">new</span> MemoryStream(textasset.bytes);</span><br><span class="line">        <span class="keyword">return</span> memorystream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合前面的GameManager.cs和所有对应的***Container.cs文件，完成我们对于序列化数据的加载。</p>
<p>激动人心的一刻，PC上成功加载表格数据代码并打印出来:<br><img src="/img/Unity/Data-Config-Automation/ExcelDataLoadAndPrint.png" alt="ExcelDataLoadAndPrint"></p>
<p>遇到个严峻的问题，真机上读取float数据时出了空引用:<br>？大写的问号脸，PC成功了但是真机Android报空？<br>问题猜想1:<br>是不是Xbuffer对于float的序列化或者反序列化没写对？<br>猜想1思考:<br>但仔细一想PC都是对的，这个猜测自然不成立了。</p>
<p>问题猜想2:<br>大小端数据存储的问题？<br>猜想2思考:<br>Windows PC(Intel)和Android Mix2手机(ARM)都是小端，同时真机不是数据错误而是报空，这个猜想也不成立。</p>
<p>问题猜想3:<br>根据报错是在var value &#x3D; <em>(float</em>)(ptr + offset);时报空，那肯定跟字节数据float解析有关。<br>猜想3思考:<br>结合万能的Google，貌似总算找到关键点了。[Google问答](<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a]">https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a]</a></p>
<p>原因:<br>上面那个问题提到了ARM设备上对于浮点数(比如floating，double)的值进行dereference要求内存地址必须是4-bytes对齐的形式才能正确解析。</p>
<p>相关知识储备:<br><a target="_blank" rel="noopener" href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html">浅谈字节序（Byte Order）及其相关操作</a><br><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/library/pa-dalign/">Data alignment: Straighten up and fly right</a></p>
<p>分析当前情况:<br>当前使用Xbuffer对于表格数据的存储只是单纯的按顺序填充数据，没有考虑任何的对齐问题，float数据也是前面的数据填到哪个字节数就在后面填入4bytes的float数据。</p>
<p>解决方案:<br>固定分配一个常驻的byte[4]作为中间缓冲区，在内存地址不满足4byte对齐时进行赋值byte数据然后对满足4byte对齐的常驻byte[4]对象进行解析。</p>
<p>floatBuffer.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">******</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">floatBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">uint</span> size = <span class="keyword">sizeof</span>(<span class="built_in">float</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//-------------------------------------------------</span></span><br><span class="line">        <span class="comment">// float在ARM机器上dereferencing浮点数(float,double等)强制要求内存地址4字节对齐，不然会报空</span></span><br><span class="line">        <span class="comment">// 参考链接:</span></span><br><span class="line">        <span class="comment">// https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a</span></span><br><span class="line">        <span class="comment">//-------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修复方案，定义一个全局的4字节byte数组，用于不满足内存地址4字节对齐时赋值用于解析float</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">byte</span>[] fourByteAlginedArray = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr = buffer)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">float</span> <span class="keyword">value</span>;</span><br><span class="line">                <span class="keyword">if</span> ((<span class="built_in">int</span>)(ptr + offset) % <span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">value</span> = *(<span class="built_in">float</span>*)(ptr + offset);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        fourByteAlginedArray[i] = (ptr + offset)[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr2 = fourByteAlginedArray)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">value</span> = *(<span class="built_in">float</span>*)(ptr2);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                offset += size;</span><br><span class="line">                <span class="keyword">return</span> BitConverter.IsLittleEndian ? <span class="keyword">value</span> : utils.toLittleEndian((<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>真正激动人心的时刻，真机运行反序列化数据:<br><img src="/img/Unity/Data-Config-Automation/AndroidDeviceExcelDataLoadAndPrint.png" alt="AndroidDeviceExcelDataLoadAndPrint"><br>可以看到我们成功反序列化了表格数据，同时解决了float在真机上dereference问题。</p>
<h4 id="性能和内存开销"><a href="#性能和内存开销" class="headerlink" title="性能和内存开销"></a>性能和内存开销</h4><p>工具链虽然打通了，但是我们我不只是要考虑能不能用，更多的我们还要关心内存开始以及序列化反序列化的速度性能问题。</p>
<p>接下来就是通过大数据配置来测试内存分配和序列化性能问题。</p>
<p>测试用例:<br>两张表（author_info.xlsx和global_config.xlsx），各配置了994行数据，然后复制两张表9次并改名(文件名和Excel内部sheet名都得改)(总计20张表 X 994行数据)。</p>
<p>测试平台：<br>PC Windows</p>
<p>导表耗时:<br><img src="/img/Unity/Data-Config-Automation/XbufferExcelToDataTimeConsume.png" alt="XbuuferExcelToDataTimeConsume"></p>
<p>导表后的二进制文件大小(未压缩):<br>二进制数据总大小我统计了下未压缩是1.3M。</p>
<p>表格数据读取内存以及反序列化时间开销：<br>我通过Unity的Profiler.GetMonoUsedSizeLong()统计计算堆内存的开销：<br>统计类:<br>MonoMeoryProfiler.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MemoryProfiler.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Profiling;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MemoryProfiler.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 简陋的内存统计工具(统计托管的Mono内存)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MonoMemoryProfiler</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">MonoMemoryProfiler</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 内存Profile类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> MemoryProfilerType</span><br><span class="line">    &#123;</span><br><span class="line">        CSharp_GC = <span class="number">1</span>,          <span class="comment">// CS GC统计</span></span><br><span class="line">        Unity_Profiler = <span class="number">2</span>      <span class="comment">// Unity Profiler接口统计</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前内存统计类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MemoryProfilerType mCurrentMemoryProfilerType = MemoryProfilerType.Unity_Profiler;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 内存标签名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mTagName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始统计时总共使用的Mono内存</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">long</span> mTotalUsedMonoMemory_Begin;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束统计时总共使用的Mono内存</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">long</span> mTotalUsedMonoMemory_End;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置当前内存统计类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mpt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMemoryProfilerType</span>(<span class="params">MemoryProfilerType mpt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentMemoryProfilerType = mpt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开启内存统计Tag</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;tag&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginMemorySample</span>(<span class="params"><span class="built_in">string</span> tag</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!tag.IsNullOrEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            mTagName = tag;</span><br><span class="line">            <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.CSharp_GC)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 确保得到正确的起始Heap Memory Size</span></span><br><span class="line">                mTotalUsedMonoMemory_Begin = GC.GetTotalMemory(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.Unity_Profiler)</span><br><span class="line">            &#123;</span><br><span class="line">                GC.Collect();</span><br><span class="line">                mTotalUsedMonoMemory_Begin = Profiler.GetMonoUsedSizeLong();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;MonoMemoryProfiler的Tag不能为空!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束内存统计</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endMemorySample</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!mTagName.IsNullOrEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.CSharp_GC)</span><br><span class="line">            &#123;</span><br><span class="line">                mTotalUsedMonoMemory_End = GC.GetTotalMemory(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.Unity_Profiler)</span><br><span class="line">            &#123;</span><br><span class="line">                GC.Collect();</span><br><span class="line">                mTotalUsedMonoMemory_End = Profiler.GetMonoUsedSizeLong();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> heapmemoryoffset = mTotalUsedMonoMemory_End - mTotalUsedMonoMemory_Begin;            </span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;内存统计标签 : &#123;0&#125;&quot;</span>, mTagName));</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;当前Mono内存大小 = &#123;0&#125; Bytes&quot;</span>, mTotalUsedMonoMemory_End));</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;之前Mono内存大小 = &#123;0&#125; Bytes&quot;</span>, mTotalUsedMonoMemory_Begin));</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;总共Mono内存占用 = &#123;0&#125; Bytes == &#123;1&#125; KB == &#123;2&#125; M&quot;</span>, heapmemoryoffset, heapmemoryoffset / <span class="number">1024</span> , heapmemoryoffset / (<span class="number">1024</span> * <span class="number">1024</span>)));</span><br><span class="line">            mTagName = <span class="built_in">string</span>.Empty;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PC:<br><img src="/img/Unity/Data-Config-Automation/Profiler_GetMonoUsedSizeLong_MemoryUsing.png" alt="Profiler_GetMonoUsedSizeLong_MemoryUsing"></p>
<p>Android真机:<br><img src="/img/Unity/Data-Config-Automation/AndroidDevice_Profiler_GetMonoUsedSizeLong_MemoryUsing.png" alt="AndroidDevice_Profiler_GetMonoUsedSizeLong_MemoryUsing"></p>
<p>可以看到两种方式统计有不少误差，在5M左右的堆内存开销。<br>时间开销PC在100ms左右,Android真机在200ms左右。</p>
<p>从20张表，每张表大概4-7个字段，各1000行数据来看，内存和序列化，反序列化速度都还是相当可观的。这里因为没有集成支持其他序列化方式，所以没法做详细的对比，详细各序列化库性能对比参考Xbuffer作者在Github上的对比<a target="_blank" rel="noopener" href="https://github.com/CodeZeg/xbuffer">Xbuffer</a>。</p>
<h4 id="优化点"><a href="#优化点" class="headerlink" title="优化点"></a>优化点</h4><p>未来需要支持和优化的工作点：</p>
<ol>
<li>支持多维数据的配置(放弃支持)<br>方案1：<br>- 扩展到多维不定长数组<br>问题：<br>- 每一个维度上的数组长度都是不定长的，用多维数组存储会伴随多维数组的维度以及各维度的数量级增长，导致各维度各数量级上的长度信息存储过多(占用过多的二进制字节数据)。<br>- 同时会需要不定长的多维数组来支持，序列化和反序列化都很复杂<br>- 需要扩展Xbuffer的维度支持<br>方案2：<br>- 扩展到多维定长数组<br>结论：<br>不太可行，空间不浪费，各维度数组长度信息过于复杂，实现过于复杂<br>问题：<br>- 只需要存储各个维度上的长度信息，维度长度信息和维度成正比，数量级小易存储<br>- 在配置复杂的不定长数据时，定长数组存储会造成大量的数据空间浪费<br>- 序列化代码依然复杂，反序列化代码相对简单<br>- 需要扩展Xbuffer的维度支持<br>结论：<br>可行，空间比较浪费，多维度数组信息存储简单，实现相对复杂<br>方案3：<br>- 多维数据依然存储在一个一维数组里，通过一维数组索引去访问<br>问题：<br>- 数据存储空间不存在浪费<br>- 不需要扩展Xbuffer多维度支持<br>- 序列化和反序列化代码简单<br>- 无法像多维数组形式方便快速索引数据，只能计算好对应索引值去访问索引数据(数据量配置一旦大了，访问复杂度成指数级成长)<br>- 对于数据配置的抽象不友好们无法快速访问指定部分数据(相当于一维数组的单个字符分割，这样一来没有意义了)<br>结论：<br>可行，空间不浪费，实现简单，访问和理解都不友好，配置复杂度影响访问复杂度。但变相成了一维数组的单个字符分割，没有意义了。<br>最终结论：<br>没有想到好的方式支持，最终放弃了支持多维数据的解析和快速访问。<br>多维数据配置建议:<br>- 可以采用配置多个一维数组映射来支持。<br>- 获取一维数组配置后，自己去split分割访问解析。</li>
<li>支持单列允许填写notation数据类型作为注释类型，单纯作为excel可查看的注释不序列化到数据里。(<strong>完成</strong>)<ul>
<li>修改导表工具支持notation数据类型配置作为注释类型</li>
<li>修改导表生成二进制数据那里不序列化注释类型数据</li>
</ul>
</li>
<li>支持个数据类型不配置，直接使用各类型默认值的方式(<strong>完成</strong>)<ul>
<li>修改导表公安局二进制数据序列化时判定书否有数据，没有数据用各类型默认数据</li>
</ul>
</li>
<li>二进制数据的压缩(暂时未做)<ul>
<li>对序列化好的二进制数据可以进行一些压缩格式的压缩后然后运行时解压的形式实现数据压缩</li>
</ul>
</li>
<li>支持单Excel多Sheet导出(<strong>2022&#x2F;1&#x2F;20完成</strong>)</li>
<li>支持Sheet黑名单，blacklist开头的Sheet名不参与导表(<strong>2022&#x2F;1&#x2F;20完成</strong>)</li>
<li>第一列字段名不限，同时类型支持int和string(<strong>2022&#x2F;1&#x2F;20完成</strong>)</li>
</ol>
<h4 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h4><p>最后给出工具的Github链接:<br><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/XbufferExcellToData">XbufferExcelToData</a><br>上面写了导表工具的详细支持和测试信息。</p>
<h4 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h4><ol>
<li>高效的数据序列化和反序列化不是语言自带的序列化和反序列化方式(很有可能默认使用了反射之类的)而是直接对于内存的数据的快速访问解析(比如flatbuffer，Xbuffer最终都是采用一个扁平化的字节数组对数据进行存储访问)</li>
<li>更进一步的数据压缩是对于基础数据类型的存储格式与数据解析定义(比如Protobuf里Varint数据存储方式)</li>
<li>跨语言的序列化反序列化只要定义统一的字节流写入和读取即可。</li>
<li>数据向后兼容问题(这里需要向Flatbuffer和Protobuf对于数据的存储做更多的处理才能做到)</li>
<li>完整的工具链要考虑的不仅仅是数据的存储和加载，还要关注自动化相关代码的生成(比如通过模板定义做到对多语言工具链的支持)。</li>
<li>二进制数据的处理需要关注大小端问题(不同CPU数据存储方式不一样)，内存对齐问题(不同架构比如ARM和Intel对于浮点数的dereference就有内存4字节对齐的要求)。</li>
<li>强大的正则表达式在做模板问题处理时，相当优秀。</li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://github.com/google/protobuf">protobuf</a><br><a target="_blank" rel="noopener" href="https://github.com/google/flatbuffers">FlatBuff</a><br><a target="_blank" rel="noopener" href="https://github.com/CodeZeg/xbuffer">Xbuffer</a></p>
<h2 id="Knowlodge-Part"><a href="#Knowlodge-Part" class="headerlink" title="Knowlodge Part"></a>Knowlodge Part</h2><p><a target="_blank" rel="noopener" href="https://www.race604.com/flatbuffers-intro/">FlatBuffers 体验</a><br><a target="_blank" rel="noopener" href="https://github.com/google/flatbuffers/releases">Flatc</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/30ef9b3780d9">Protocol Buffer 序列化原理大揭秘 - 为什么Protocol Buffer性能这么好？</a><br><a target="_blank" rel="noopener" href="https://www.xcode.me/more/microsoft-net-framework-version-define">Microsoft .NET Framework 版本定义</a><br><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/library/pa-dalign/">Data alignment: Straighten up and fly right</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/ce123_zhouwei/article/details/6971544">详解大端模式和小端模式</a><br><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/11/byte-order.html">理解字节序</a><br><a target="_blank" rel="noopener" href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html">浅谈字节序（Byte Order）及其相关操作</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a href="blog.csdn.net/qq_14903317/article/details/78637440">Unity C#配置表工具</a><br><a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-494944.html">Unity3D游戏开发之当游戏开发遇上Excel</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/2429">Unity3D研究院之MAC&amp;Windows跨平台解析Excel（六十五）</a><br><a target="_blank" rel="noopener" href="https://github.com/ExcelDataReader/ExcelDataReader">ExcelReader</a><br><a target="_blank" rel="noopener" href="https://www.race604.com/flatbuffers-intro/">FlatBuffers 体验</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Excel/">Excel</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Excel/">Excel</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/08/14/Unity中的Lua/" title="Unity中的Lua" itemprop="url">Unity中的Lua</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-08-14T14:19:01.000Z" itemprop="datePublished"> 发表于 2017-08-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h1><p>结合以前的初步学习了解，这一次要对Lua进行进一步的深入学习。</p>
<p>首先我们要知道Lua是脚本语言，是有自己的虚拟机，是解析执行而非像C#,C++,Java这些编译执行。同时Lua是弱类型语言。</p>
<p>这里不更多的讲解Lua虚拟机相关概念，详情参考[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]</a>(Scripting System)<br><img src="/img/Lua/Virtual_Machine_Working_Levels.PNG" alt="Virtual_Machine_Working_Levels"><br>这里只要知道Lua的虚拟机(程序模拟线程，堆栈等)是运行在程序里而非物理CPU上，因此只要虚拟机把Lua脚本解析成对应平台的机器码就能支持跨平台(好比Java的JVM)。</p>
<h1 id="Lua-Study"><a href="#Lua-Study" class="headerlink" title="Lua Study"></a>Lua Study</h1><p>以前的部分学习参考:<br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html">Scripting System &amp; Lua Study</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0rk.html">Lua – some important concept and knowledge</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zp.html">Lua - C API </a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zs.html">Lua - C call Lua &amp; Lua call C</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s9.html">Lua - Object Oriented Programming</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v1qg.html">Lua - Userdata</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v383.html">Lua - Managing Resources &amp; Threads and States</a></p>
<h2 id="Weak-Tables-And-Finalizers"><a href="#Weak-Tables-And-Finalizers" class="headerlink" title="Weak Tables And Finalizers"></a>Weak Tables And Finalizers</h2><p>“and Finalizers Lua  does  automatic  memory  management. Programs  create  objects  (tables, threads,  etc.),  but  there  is  no  function  to  delete  objects. Lua  automatically deletes  objects that become garbage,  using garbage  collection. “</p>
<p><strong>Weak Table</strong><br>“Weak tables allow the collection of Lua objects that are still accessible to the program”</p>
<p>“A weak reference is a reference to an object hat is not considered by the garbage collector”</p>
<p>“In weak tables,, both keys and values can be weak”(three kinds of week table:1. weak key 2. weak value 3. weak key and value)</p>
<p>Weak Table Using:</p>
<ol>
<li>释放使用不再使用的缓存数据(memorizing)<br>Auxiliary table(辅助表),Lua里有类似于C#里的internal hash table用于重用使用过的string和访问结果(C#里主要是使用过的string重用。Lua还能将访问过的string的table结果缓存返回)</li>
</ol>
<p>但Auxiliary table有个缺点就是使用不频繁的string和result会一直被缓存无法释放。weak table正是用于解决这一问题的方案之一。(因为weak table的weak reference一旦不再被使用就会被下一次GC释放)</p>
<ol start="2">
<li><p>Object Attributes Implemetation<br>Solution: use external table to associate objects with attributes<br>Drawback: external table reference prevent objects from being collected<br>Final solution: use weak keys for objects in external table</p>
</li>
<li><p>Tables with Default Values<br>这里有两种各有优缺点的实现方案：<br>方案1:</p>
</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> defaults = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(defaults, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;k&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">local</span> mt = &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t)</span></span> <span class="keyword">return</span> defaults[t] <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setDefault</span> <span class="params">(t, d)</span></span></span><br><span class="line">defaults[t] = d</span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>方案2:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> metas = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(metas, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;v&quot;</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setDefault</span> <span class="params">(t, d)</span></span></span><br><span class="line"><span class="keyword">local</span> mt = metas[d]</span><br><span class="line"><span class="keyword">if</span> mt == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">mt = &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="keyword">return</span> d <span class="keyword">end</span>&#125;</span><br><span class="line">metas[d] = mt <span class="comment">-- memorize</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>前者针对每一个不同的Table都会分配一个defaults入口,table作为key，default value作为value。这样的缺点就是当table数量很大的时候会需要分配很多内存去存储不同table的default value。</p>
<p>后者针对不同的default value分配了更多的内存(比如mt，entry on metas, closure……)，但优点是同样的default value只需要分配一次即可，所以后者更适用于table数量多但default value大都相同的情况。</p>
<ol start="4">
<li>Ephemeron Tables(声明短暂的table Lua 5.2里提供)<br>Ephemeron Table:<br>“In Lua 5.2, a table with weak keys and strong values is an ephemeron table. In an ephemeron table, the accessibility of a key controls the accessibility of its corresponding value.(只当有strong<br> reference to key时value才是strong的)”<br>e.g. constant-function factory</li>
</ol>
<p>Note:<br>“Only objects can be collected from a weak table. Values, such as numbers and booleans, are not collectible”(只有Objects在weak table里能被gc回收，number和booleans这种Value类型不能在weak table里被gc回收)</p>
<p>“strings are collectible, but string is not removed from weak table(unless its associated value is collected)”</p>
<p><strong>Finalizers</strong><br>“Finalizers allow the collection of externa objects that are not directly under control of the garbage collector”</p>
<p>“Finalizer is a function associated with an object that is called when that object is about to be collected.”(相当于C#里的Finalize,在GC object的时候会被调用。但只有一开始设置Metamethod的__gc时才能mark该object为可finalization的，否则就算后面在复制__gc也不会在调用该object的finalizer)</p>
<p>Lua里是通过Metamethod里的__gc实现。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试环境要求至少Lua 5.2</span></span><br><span class="line">o = &#123;x = <span class="string">&quot;hi&quot;</span>&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(o, &#123;<span class="built_in">__gc</span> = <span class="function"><span class="keyword">function</span> <span class="params">(o)</span></span> <span class="built_in">print</span>(o.x) <span class="keyword">end</span>&#125;)</span><br><span class="line">o = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">collectgarbage</span>() <span class="comment">--&gt; hi</span></span><br></pre></td></tr></table></figure>

<p>The order of finalization called:<br>“When the collector finalizes several obejcts in the same cycle, it calls their finalizers in the reverse order that the objects were marked for finalization”(先声明__gc被mark为可finalization的object的finalizer后被调用)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试环境要求至少Lua 5.2</span></span><br><span class="line">mt = &#123;<span class="built_in">__gc</span> = <span class="function"><span class="keyword">function</span> <span class="params">(o)</span></span> <span class="built_in">print</span>(o[<span class="number">1</span>]) <span class="keyword">end</span>&#125;</span><br><span class="line">list = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">3</span> <span class="keyword">do</span></span><br><span class="line">    list = <span class="built_in">setmetatable</span>(&#123;i, link = list&#125;, mt)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">list = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">collectgarbage</span>()</span><br><span class="line"><span class="comment">--&gt; 1</span></span><br><span class="line"><span class="comment">--&gt; 2</span></span><br><span class="line"><span class="comment">--&gt; 3</span></span><br></pre></td></tr></table></figure>

<p>对于被finalize的object，Finlization会使被finalize的object处于两个特殊的状态：</p>
<ol>
<li>transient resurrection(短暂的复苏)</li>
<li>permanent resurrection(永久的复苏)<br>前者因为在调用__gc的metamethod时我们会得到finalize的object，这样一来使得该object alive again，然后我们可以通过该object用于访问里面的对象。<br>finalizer被调用时，该alive again的object被存储在了global table里，导致该object在finalize后依然存在。<strong>要想使用finalize也真正回收obejct，我们需要调用两次gc，第一次用于回收原始object，第二次用于回收alive again的object。</strong></li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 因为当前测试环境是Lua 5.1(基于LuaTo#插件学习的，JIT支持到5.1的版本)所以不支持Talbe的__gc Metamethod，这里暂时没有写测试程序。</span></span><br></pre></td></tr></table></figure>

<p>Note:<br>“In lua 5.1 the only lua values that work with __gc metamethod is userdata. “(Lua 5.1不支持table的__gc metamethod，只支持userdata的__gc metamethod)</p>
<h2 id="Lua里的位运算"><a href="#Lua里的位运算" class="headerlink" title="Lua里的位运算"></a>Lua里的位运算</h2><p>在了解Lua里的位运算之前我们需要了解原码，反码，补码相关的概念，详情参考：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangziqiu/archive/2011/03/30/computercode.html">原码, 反码, 补码 详解</a></p>
<p>这里直接说结论：<br><strong>机器的数字存储采用补码的方式来编码存储的。</strong></p>
<p><strong>正数的反码 &#x3D; 自身</strong><br><strong>负数的反码 &#x3D; 符号位不变 + 其他位取反</strong></p>
<p><strong>正数的补码 &#x3D; 自身</strong><br><strong>负数的补码 &#x3D; 反码 + 1</strong></p>
<p><strong>移码 &#x3D; 2^n + 补码(真值为排开非符号位的值，n为真值的位数) &#x3D; 补码符号位取反</strong></p>
<p>为什么会需要原码，反码，补码?<br>个人总结原因有以下几点:</p>
<ol>
<li><strong>计算机运算设计为了简化让符号位直接参与运算，同时只有加法没有减法，减法用加一个负数的表示</strong></li>
<li><strong>直接用原码相加无法解决符号位相加问题，导致结果不正确</strong></li>
<li><strong>直接用反码相加无法解决0的准确表达，即1<em>0和0</em>0都表示0但区分了正负之分(有效范围127到-127)</strong></li>
<li><strong>用补码相加不仅解决了正负0的问题，同时1*0还能表示-128(扩展有效范围为127到-128。这也是为什么我们的int32的有效范围为2^31 - 1到(-2)^31的原因)</strong></li>
<li><strong>移码解决补码不能快速比较两个数大小的问题</strong></li>
</ol>
<p>了解了基础的理论知识，让我们再来看看Lua里的位运算。</p>
<h3 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i = <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line">	<span class="built_in">print</span>(i)</span><br><span class="line">	<span class="keyword">local</span> number = i</span><br><span class="line">	<span class="keyword">local</span> result = ~number</span><br><span class="line">	<span class="built_in">print</span>(result)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>让我们看下输出结果:<br><img src="/img/Lua/BitNotOperation.png" alt="BitNotOperation"><br>上面的结果出人意料，0取反为-1，1取反为-2,2取反为-3,3取反为-4，并不是我们想象中的0取反为-2^31</p>
<p>那么为什么会有这样的结果了，让我们结合前面学习的原码，反码，补码知识来破解其中的奥妙。<br>让我们来一步一步看看，0在取反的过程中是怎么一步一步变成-1的。<br>正向:<br>0000(原码)                    0<br>0000(反码)                    0<br>0000(补码)                    0<br>1111(补码取反)                -2^31 + 1</p>
<p>因为机器是以补码存储数字的，所以0的存储编码为0000<br>我们通过对0取反，得到1111(补码取反)<br>得到了取反后的补码，我们如何知道这个补码表达的是什么数值了？这个时候需要结合补码的计算方式逆向推导出原码值。</p>
<p>补码逆向:<br>1111 - 1 &#x3D; 1110(反码)          -2^31 + 1<br>1110(反码) &#x3D; 原码符号位不变 + 原码其他位取反 &#x3D; 1001(原码) &#x3D; -1</p>
<p>可以看到通过正向和逆向反推，我们成功得出了0取反后的值为-1而不是我们想象中的-2^31</p>
<h3 id="移位和异或"><a href="#移位和异或" class="headerlink" title="移位和异或"></a>移位和异或</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> num1 = <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(num1 &lt;&lt; <span class="number">1</span>)</span><br><span class="line"><span class="keyword">local</span> num2 = <span class="number">-1</span></span><br><span class="line"><span class="built_in">print</span>(num2 &lt;&lt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line"><span class="comment">-- 01101(原码)</span></span><br><span class="line"><span class="comment">-- 01101(补码)</span></span><br><span class="line"><span class="keyword">local</span> num3 = <span class="number">13</span></span><br><span class="line"><span class="comment">-- 11011(原码)</span></span><br><span class="line"><span class="comment">-- 10100(反码)</span></span><br><span class="line"><span class="comment">-- 10101(补码)</span></span><br><span class="line"><span class="keyword">local</span> num4 = <span class="number">-11</span></span><br><span class="line"><span class="comment">-- 01101(补码) &amp; 10011(补码)</span></span><br><span class="line"><span class="comment">-- 00101(异后补码)</span></span><br><span class="line"><span class="comment">-- 00101(异后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num3 &amp; num4)</span><br><span class="line"><span class="comment">-- 01101(补码) | 10101(补码)</span></span><br><span class="line"><span class="comment">-- 11101(或后补码)</span></span><br><span class="line"><span class="comment">-- 11100(或后反码)</span></span><br><span class="line"><span class="comment">-- 10011(或后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num3 | num4)</span><br><span class="line"><span class="comment">-- 01101(补码) ~ 10101(补码)</span></span><br><span class="line"><span class="comment">-- 11000(异或后)</span></span><br><span class="line"><span class="comment">-- 10111(异或后反码)</span></span><br><span class="line"><span class="comment">-- 11000(异或后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num3 ~ num4)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line"><span class="comment">-- 11001(原码)</span></span><br><span class="line"><span class="comment">-- 10111(补码)</span></span><br><span class="line"><span class="keyword">local</span> num5 = <span class="number">-9</span></span><br><span class="line"><span class="comment">-- 00011(原码)</span></span><br><span class="line"><span class="comment">-- 00011(补码)</span></span><br><span class="line"><span class="keyword">local</span> num6 = <span class="number">3</span></span><br><span class="line"><span class="comment">-- 10111(补码) ~ 00011(补码)</span></span><br><span class="line"><span class="comment">-- 10100(异或后)</span></span><br><span class="line"><span class="comment">-- 10011(异或后反码)</span></span><br><span class="line"><span class="comment">-- 11100(异或后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num5 ~ num6)</span><br></pre></td></tr></table></figure>
<p><img src="/img/Lua/BitwiseOperation.png" alt="BitwiseOperation"><br>可以看到num5和num6异或因为补码的影响得到-12的结果。<br>Note:<br>    1. <strong>有负数的情况，异和或操作都会受补码影响，整数补码等于原码，所以整数异和或操作等价于原码直接异或</strong><br>    2. <strong>异或操作对符号位会有影响，需要考虑补码影响</strong><br>    3. <strong>位移操作左移会替换符号位，右移会丢弃低位</strong></p>
<h2 id="Lua里的OOP"><a href="#Lua里的OOP" class="headerlink" title="Lua里的OOP"></a>Lua里的OOP</h2><p>OOP(Object Oriented Programming)<br>首先Lua里面编写更重要的是Think in Lua，所以这里我不是强调OOP的重要性，而是单纯因为OOP被更多的C#程序员所熟悉。</p>
<h3 id="Class抽象"><a href="#Class抽象" class="headerlink" title="Class抽象"></a>Class抽象</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:    Class.lua</span></span><br><span class="line"><span class="comment">-- Description:    模拟Lua里OOP特性(不支持多重继承)</span></span><br><span class="line"><span class="comment">-- Author:       TangHuan</span></span><br><span class="line"><span class="comment">-- Create Date:    2018/11/09</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用方法：</span></span><br><span class="line"><span class="comment">-- 1. 定义类</span></span><br><span class="line"><span class="comment">-- local ClassName = Class(&quot;ClassName&quot;, nil)</span></span><br><span class="line"><span class="comment">-- ***(自定义类数据方法等)</span></span><br><span class="line"><span class="comment">-- 参数说明：</span></span><br><span class="line"><span class="comment">-- clsname类名，super父类</span></span><br><span class="line"><span class="comment">-- 返回结果:</span></span><br><span class="line"><span class="comment">-- ClassName(含Class基本信息结构的table)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 实例化类对象</span></span><br><span class="line"><span class="comment">-- 参数说明：</span></span><br><span class="line"><span class="comment">-- BaseClass含类定义的Class Table</span></span><br><span class="line"><span class="comment">-- ...构造类实例对象的构造函数ctor()的参数</span></span><br><span class="line"><span class="comment">-- 返回结果：</span></span><br><span class="line"><span class="comment">-- 基于BaseClass的实例对象</span></span><br><span class="line"><span class="comment">-- new(BaseClass, ...)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---克隆对象(建议用于克隆Class对象)</span></span><br><span class="line"><span class="comment">---@param  any 对象</span></span><br><span class="line"><span class="comment">---@return  any 克隆对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Clone</span><span class="params">(object)</span></span></span><br><span class="line">    <span class="keyword">local</span> lookup_table = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_copy</span><span class="params">(object)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(object) ~= <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> object</span><br><span class="line">        <span class="keyword">elseif</span> lookup_table[object] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> lookup_table[object]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> new_table = &#123;&#125;</span><br><span class="line">        lookup_table[object] = new_table</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(object) <span class="keyword">do</span></span><br><span class="line">            new_table[_copy(key)] = _copy(value)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setmetatable</span>(new_table, <span class="built_in">getmetatable</span>(object))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> _copy(object)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---判定是否是指定类或者继承至该类</span></span><br><span class="line"><span class="comment">---@param self Class@类实例对象或者类</span></span><br><span class="line"><span class="comment">---@param cname string | Class@类名或者类定义table</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">IsClass</span><span class="params">(self, cname)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(<span class="built_in">self</span>) ~= <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(cname) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>.class == cname <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">elseif</span> <span class="built_in">self</span>.super <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">self</span>.super.IsClass(<span class="built_in">self</span>.super, cname);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">elseif</span> <span class="built_in">type</span>(cname) == <span class="string">&quot;string&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>.class.className == cname <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">elseif</span> <span class="built_in">self</span>.super <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">self</span>.super.IsClass(<span class="built_in">self</span>.super, cname);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 提供Lua的OOP实现，快速定义一个Class(不支持多重继承)</span></span><br><span class="line"><span class="comment">--- 模拟Class封装，继承，多态，类型信息，构造函数等</span></span><br><span class="line"><span class="comment">--- 模拟一个基础的Class需要的信息</span></span><br><span class="line"><span class="comment">---@param clsname string@类名</span></span><br><span class="line"><span class="comment">---@param super super@父类</span></span><br><span class="line"><span class="comment">---@return Class@含Class所需基本信息的Class table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Class</span><span class="params">(clsname, super)</span></span></span><br><span class="line">    <span class="keyword">local</span> classtable = &#123;&#125;</span><br><span class="line">    <span class="comment">-- ctor模拟构造函数</span></span><br><span class="line">    classtable.Ctor = <span class="literal">false</span></span><br><span class="line">    <span class="comment">-- className模拟类型信息，负责存储类名</span></span><br><span class="line">    classtable.className = clsname</span><br><span class="line">    <span class="comment">-- super模拟父类</span></span><br><span class="line">    <span class="comment">-- Note: 外部逻辑层不允许直接._super访问父类</span></span><br><span class="line">    classtable._super = super</span><br><span class="line">    <span class="comment">-- 自身class类table</span></span><br><span class="line">    classtable.class = classtable;</span><br><span class="line">    <span class="comment">-- 指定索引元方法__index为自身,模拟类访问</span></span><br><span class="line">    <span class="comment">-- 后面实例化对象时会将classtable作为元表，从而实现访问类封装的数据</span></span><br><span class="line">    classtable.<span class="built_in">__index</span> = classtable</span><br><span class="line">    <span class="comment">-- 是否是指定类或者继承至某类的方法接口</span></span><br><span class="line">    classtable.IsClass = IsClass;</span><br><span class="line">    <span class="comment">-- 如果指定了父类，通过设置Class的元表为父类模拟继承</span></span><br><span class="line">    <span class="keyword">if</span> super <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(classtable, super)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">--print(&quot;如果定义的不是最基类，请确认是否require了父类!&quot;)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> classtable</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 提供实例化对象的方法接口</span></span><br><span class="line"><span class="comment">--- 模拟构造函数的递归调用，从最上层父类构造开始调用</span></span><br><span class="line"><span class="comment">---@param cls cls@类定义</span></span><br><span class="line"><span class="comment">---@param ... ...@构造函数变长参数</span></span><br><span class="line"><span class="comment">---@return cls@cls类的实例对象table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">New</span><span class="params">(cls, ...)</span></span></span><br><span class="line">    <span class="comment">-- 实例对象表</span></span><br><span class="line">    <span class="keyword">local</span> instance = &#123;&#125;</span><br><span class="line">    <span class="comment">-- 设置实例对象元表为cls类模拟类的封装访问</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(instance, cls)</span><br><span class="line">    <span class="comment">-- create模拟面向对象里构造函数的递归调用(从父类开始构造)</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">create</span></span><br><span class="line">    <span class="built_in">create</span> = <span class="function"><span class="keyword">function</span><span class="params">(cls, ...)</span></span></span><br><span class="line">        <span class="keyword">if</span> cls._super <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">create</span>(cls._super, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> cls.Ctor <span class="keyword">then</span></span><br><span class="line">            cls.Ctor(instance, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">create</span>(cls, ...)</span><br><span class="line">    <span class="keyword">return</span> instance</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---静态类</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>  <span class="title">StaticClass</span><span class="params">(clsname)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>上面的代码注释已经很清楚了，就不一一解释了。</p>
<p>理解上面Lua实现OOP的关键在于通过table模拟Class的抽象以及数据封装，通过metatable模拟继承特性。</p>
<h3 id="Class定义"><a href="#Class定义" class="headerlink" title="Class定义"></a>Class定义</h3><p>定义一个类的方式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">类名 = Class(<span class="string">&quot;类名&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 类名:<span class="title">Ctor</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">--成员变量定义</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--方法定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 类名:方法名<span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Class继承"><a href="#Class继承" class="headerlink" title="Class继承"></a>Class继承</h3><p>继承一个类的方式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">子类名 = Class(<span class="string">&quot;子类名&quot;</span>, 父类名)</span><br><span class="line"></span><br><span class="line"><span class="comment">--构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 子类名:<span class="title">Ctor</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">--成员变量定义</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--方法定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 子类名:方法名<span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Class对象实例化"><a href="#Class对象实例化" class="headerlink" title="Class对象实例化"></a>Class对象实例化</h3><p>Lua OOP对象实例化方式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> 变量名 = New(类名)</span><br><span class="line">变量名.成员变量</span><br><span class="line">变量名:成员方法()</span><br><span class="line">变量名.静态方法()</span><br></pre></td></tr></table></figure>

<h2 id="Lua只读Table"><a href="#Lua只读Table" class="headerlink" title="Lua只读Table"></a>Lua只读Table</h2><p>在游戏开发里，配置表数据往往是固定不允许修改的，无论是C#还是Lua，对于对象修改限制都只能通过上层封装实现此功能。</p>
<p>而这里我要学习了解的就是在Lua里实现ReadOnly table用于配置表，确保开发人员不会出现对配置表的错误操作。</p>
<p>参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/tkokof1/article/details/112850563">Sweet Snippet 之 Lua readonly table</a></p>
<h3 id="基础版只读Table"><a href="#基础版只读Table" class="headerlink" title="基础版只读Table"></a>基础版只读Table</h3><p>在Lua官网上其实已经给出了一版ReadOnly的基础实现思路:</p>
<p><a target="_blank" rel="noopener" href="https://www.lua.org/pil/13.4.5.html">Read-Only Tables</a></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readOnly</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123;       <span class="comment">-- create metatable</span></span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="string">&quot;attempt to update a read-only table&quot;</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">days = readOnly&#123;<span class="string">&quot;Sunday&quot;</span>, <span class="string">&quot;Monday&quot;</span>, <span class="string">&quot;Tuesday&quot;</span>, <span class="string">&quot;Wednesday&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Thursday&quot;</span>, <span class="string">&quot;Friday&quot;</span>, <span class="string">&quot;Saturday&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(days[<span class="number">1</span>])     <span class="comment">--&gt; Sunday</span></span><br><span class="line">days[<span class="number">2</span>] = <span class="string">&quot;Noday&quot;</span>  <span class="comment">--&gt; stdin:1: attempt to update a read-only table</span></span><br></pre></td></tr></table></figure>

<p>通过上面的事例可以看出，设计Readonly table的核心思想是通过**__index**(访问不存在Key时触发)和**__newindex**(赋值不存在Key时触发)元方法来接手所有的table访问赋值。</p>
<p>为了确保**__index<strong>和</strong>__newindex<strong>的触发，我们需要通过实现一个空table作为代理table来实现所有的Key访问和赋值都能触发</strong>__index<strong>和</strong>__newindex**，然后通过实现**__index<strong>和</strong>__newindex**将数据访问赋值指向原始table来实现数据访问和ReadOnly功能。</p>
<h3 id="进阶版只读Table-支持-和pairs"><a href="#进阶版只读Table-支持-和pairs" class="headerlink" title="进阶版只读Table(支持#和pairs)"></a>进阶版只读Table(支持#和pairs)</h3><p>上面的事例代码虽然实现了基础的ReadOnly功能，但当我们采用#或pairs访问数据长度和数据时会发现，访问不到数据，原因是因为我们的代理table本来就没有数据并且我们也没有自己实现**__len<strong>和</strong>__pairs**元方法指向原始数据访问导致的。所以进阶版ReadOnly实现如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReadOnly</span> <span class="params">(t, name)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123;       <span class="comment">-- create metatable</span></span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;attempt to update a read-only table:%s&quot;</span>, name))</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        <span class="built_in">__len</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> #t</span><br><span class="line">	    <span class="keyword">end</span>,</span><br><span class="line">        __pairs = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">next</span>, t, <span class="literal">nil</span></span><br><span class="line">	    <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> originalTable = &#123;&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(originalTable, <span class="string">&quot;A&quot;</span>)</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(originalTable, <span class="string">&quot;C&quot;</span>)</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(originalTable, <span class="string">&quot;B&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> readOnlyTable = ReadOnly(originalTable, <span class="string">&quot;readOnlyTable&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(#readOnlyTable)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(readOnlyTable) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(key)</span><br><span class="line">	<span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(readOnlyTable) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(index)</span><br><span class="line">	<span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line">readOnlyTable[<span class="number">3</span>] = <span class="string">&quot;BB&quot;</span></span><br><span class="line"><span class="comment">--readOnlyTable[4] = &quot;D&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/ReadOnlyTableOutput.png" alt="ReadOnlyTableOutput"></p>
<p>可以看到，通过重写**__len<strong>和</strong>__pairs**我们已经支持了ReadOnly的长度获取和pairs遍历访问。</p>
<h3 id="完善版只读Table-支持递归ReadOnly"><a href="#完善版只读Table-支持递归ReadOnly" class="headerlink" title="完善版只读Table(支持递归ReadOnly)"></a>完善版只读Table(支持递归ReadOnly)</h3><p>经过上面的努力我们已经支持了#和pairs的遍历操作，但我们的只读Table还只支持了一层，也就是说嵌套的table并没有支持只读设定。</p>
<p>实现思路:</p>
<ol>
<li>递归对所有的table调用ReadOnly方法</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 转换table成只读table</span></span><br><span class="line"><span class="comment">---@param t table @需要变成ReadOnly的table</span></span><br><span class="line"><span class="comment">---@param name string @ReadOnly table的名字(方便报错打印定位)</span></span><br><span class="line"><span class="comment">---@param depth number @只读table深度</span></span><br><span class="line"><span class="comment">---@return table @转换后的只读table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReadOnlyTable</span><span class="params">(t, name, depth)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(t) ~= <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">&quot;not support none table to a recusive read-only table!&quot;</span>)</span><br><span class="line"> 		<span class="keyword">return</span> t</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	depth = depth <span class="keyword">or</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> depth &gt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    	<span class="keyword">local</span> nextDepth = depth - <span class="number">1</span></span><br><span class="line">	    <span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">	    	<span class="keyword">if</span> <span class="built_in">type</span>(value) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">	    		t[key] = ReadOnlyTable (t[key], name, nextDepth)</span><br><span class="line">	    	<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123;</span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;attempt to update a read-only table:%s&quot;</span>, name))</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        <span class="built_in">__len</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> #t</span><br><span class="line">	    <span class="keyword">end</span>,</span><br><span class="line">        __pairs = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">next</span>, t, <span class="literal">nil</span></span><br><span class="line">	    <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> originalTable = &#123;&#125;</span><br><span class="line">originalTable[<span class="string">&quot;A&quot;</span>] = <span class="string">&quot;A&quot;</span></span><br><span class="line">originalTable[<span class="string">&quot;NestTable&quot;</span>] = &#123;</span><br><span class="line">	[<span class="string">&quot;Nest_A&quot;</span>] = <span class="string">&quot;Nest_A&quot;</span>,</span><br><span class="line">	[<span class="string">&quot;Nest_B&quot;</span>] = <span class="string">&quot;Nest_B&quot;</span>,</span><br><span class="line">	[<span class="string">&quot;NestNestTable&quot;</span>] = &#123;</span><br><span class="line">		[<span class="string">&quot;Nest_Nest_A&quot;</span>] = <span class="string">&quot;Nest_Nest_A&quot;</span>,</span><br><span class="line">		[<span class="string">&quot;Nest_Nest_B&quot;</span>] = <span class="string">&quot;Nest_Nest_B&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">originalTable[<span class="string">&quot;B&quot;</span>] = <span class="string">&quot;B&quot;</span></span><br><span class="line"><span class="keyword">local</span> readOnlyTable = ReadOnlyTable(originalTable, <span class="string">&quot;readOnlyTable&quot;</span>, <span class="number">2</span>)</span><br><span class="line">print_table(readOnlyTable)</span><br><span class="line"><span class="built_in">print</span>(#readOnlyTable)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(readOnlyTable) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(key)</span><br><span class="line">	<span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="comment">--readOnlyTable[&quot;A&quot;] = &quot;AA&quot; --&gt; ReadOnly Error</span></span><br><span class="line"><span class="comment">--readOnlyTable[&quot;NestTable&quot;][&quot;Nest_A&quot;] = &quot;Nest_AA&quot; --&gt; ReadOnly Error</span></span><br><span class="line">readOnlyTable[<span class="string">&quot;NestTable&quot;</span>][<span class="string">&quot;NestNestTable&quot;</span>][<span class="string">&quot;Nest_Nest_A&quot;</span>] = <span class="string">&quot;Nest_Nest_AA&quot;</span></span><br><span class="line">print_table(readOnlyTable)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/RecusiveReadOnlyTableOuput.png" alt="RecusiveReadOnlyTableOuput"></p>
<p>通过上面的完善，我们成功的实现了支持指定深度的ReadOnly表实现。</p>
<h3 id="优化点"><a href="#优化点" class="headerlink" title="优化点"></a>优化点</h3><ol>
<li><strong>考虑到原表的性能开销，我们可以在开发期开启ReadOnly表的设计，发包后直接采用原始表访问的方式来优化掉这部分性能开销</strong></li>
</ol>
<h2 id="Lua回调绑定"><a href="#Lua回调绑定" class="headerlink" title="Lua回调绑定"></a>Lua回调绑定</h2><p>在Lua里函数有着第一类值的说法(在Lua中函数和其他值（数值、字符串）一样，函数可以被存放在变量中，也可以存放在表中，可以作为函数的参数，还可以作为函数的返回值。)。</p>
<p>很多时候我们想传递一个类方法作为回调方法，希望回来的时候是自带self，如果我们只按以下写法来使用，我们将丢掉self这个上下文:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> testHandler = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:FuncWithoutParams</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;testHandler:FuncWithoutParams()&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:TestHandler</span><span class="params">(cb)</span></span>    </span><br><span class="line">	cb()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">testHandler:TestHandler(testHandler.FuncWithoutParams)</span><br></pre></td></tr></table></figure>

<p>所以为了封装self的，我们需要通过闭包机制来实现一个handler，以下代码实现了带参和不带参的handler.lua版本:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:      Handler.lua</span></span><br><span class="line"><span class="comment">-- Description:    带self的回调绑定</span></span><br><span class="line"><span class="comment">-- Author:         TonyTang</span></span><br><span class="line"><span class="comment">-- Create Date:    2021/6/5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 无参委托绑定</span></span><br><span class="line"><span class="comment">---@param obj table @对象</span></span><br><span class="line"><span class="comment">---@param method func() @方法</span></span><br><span class="line"><span class="comment">---@return func() @委托绑定无参方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler</span><span class="params">(obj, method)</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">		method(obj)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 带参委托绑定</span></span><br><span class="line"><span class="comment">---@param obj table @对象</span></span><br><span class="line"><span class="comment">---@param method func() @方法</span></span><br><span class="line"><span class="comment">---@param ... any @参数</span></span><br><span class="line"><span class="comment">---@return func(...) @委托绑定带参方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlerBind</span><span class="params">(object, method, ...)</span></span></span><br><span class="line">	<span class="keyword">local</span> params = <span class="built_in">table</span>.pack(...)</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">		method(obj, <span class="built_in">table</span>.<span class="built_in">unpack</span>(params))</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> testHandler = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:FuncWithoutParams</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;testHandler:FuncWithoutParams()&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:FuncWithParams</span><span class="params">(param1, param2, param3)</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;testHandler:FuncWithParams(%s, %s, %s)&quot;</span>, param1, param2, param3))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:TestHandler</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">local</span> handler = <span class="built_in">_G</span>.handler(<span class="built_in">self</span>, <span class="built_in">self</span>.FuncWithoutParams)</span><br><span class="line">	handler()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:TestHandlerBind</span><span class="params">(param1, param2, param3)</span></span></span><br><span class="line">	<span class="keyword">local</span> handlerBind = <span class="built_in">_G</span>.handlerBind(<span class="built_in">self</span>, <span class="built_in">self</span>.FuncWithParams, param1, param2, param3)</span><br><span class="line">	handlerBind()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">testHandler:TestHandler()</span><br><span class="line">testHandler:TestHandlerBind(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">testHandler:TestHandlerBind(<span class="number">1</span>, <span class="literal">nil</span>, <span class="number">3</span>)</span><br><span class="line">testHandler:TestHandlerBind(<span class="literal">nil</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/HandlerOutput.PNG" alt="HandlerOutput"></p>
<p>但上面这种设计，还不支持自定义传参的基础上保留自定义函数传参：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function testHandler:FuncWithParams(...)</span><br><span class="line">	print(<span class="string">&quot;testHandler:FuncWithParams()&quot;</span>)</span><br><span class="line">    print(...)</span><br><span class="line">end</span><br><span class="line">    </span><br><span class="line">function testHandler:TestHandlerBind(...)</span><br><span class="line">	local handlerBind = _G.handlerBind(self, self.FuncWithParams, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>)</span><br><span class="line">	handlerBind(...)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">testHandler:TestHandlerBind(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>理论上上面这种情况，我们预期的testHandler:FuncWithParams()最终调用传入的参数为2+N个(“param1”+”param2”+…)</p>
<p><strong>实现上面的需求，核心我们需要利用table.pack和table.unpack的机制(但要注意table.unpack(tb)默认效果等价于table.unpack(tb, 1, #tb)即会被nil打断的，这个不是我们希望看到的)。</strong></p>
<p><strong>解决上述问题，我们只需要通过封装参数pack和unpack过程，并明确指定table.unpack(tb, 1, count)的方式来解决被nil打断的情况，最终handler.lua代码如下:</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">-- File Name:      Handler.lua</span><br><span class="line">-- Description:    带self的回调绑定</span><br><span class="line">-- Author:         TonyTang</span><br><span class="line">-- Create Date:    <span class="number">2021</span>/<span class="number">6</span>/<span class="number">5</span></span><br><span class="line"></span><br><span class="line">--- 无参委托绑定</span><br><span class="line">---@param obj table @对象</span><br><span class="line">---@param <span class="function">method <span class="title">func</span>() @方法</span></span><br><span class="line"><span class="function">---@<span class="keyword">return</span> <span class="title">func</span>() @委托绑定无参方法</span></span><br><span class="line"><span class="function">function <span class="title">handler</span>(<span class="params">obj, method</span>)</span></span><br><span class="line"><span class="function">	<span class="keyword">return</span> <span class="title">function</span>(<span class="params">...</span>)</span></span><br><span class="line"><span class="function">		<span class="title">method</span>(<span class="params">obj, ...</span>)</span></span><br><span class="line"><span class="function">	end</span></span><br><span class="line"><span class="function">end</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">--- 带参委托绑定</span></span><br><span class="line"><span class="function">---@param obj table @对象</span></span><br><span class="line"><span class="function">---@param method <span class="title">func</span>() @方法</span></span><br><span class="line"><span class="function">---@param ... any @可变长参数</span></span><br><span class="line"><span class="function">---@<span class="keyword">return</span> <span class="title">func</span>(<span class="params">...</span>) @委托绑定带参方法</span></span><br><span class="line"><span class="function">function <span class="title">handlerBind</span>(<span class="params"><span class="built_in">object</span>, method, ...</span>)</span></span><br><span class="line"><span class="function">	local <span class="keyword">params</span></span> = SafePack(...)</span><br><span class="line">	<span class="keyword">return</span> function(...)</span><br><span class="line">		local params2 = SafePack(...)</span><br><span class="line">		local concateParams = ConcatePack(<span class="keyword">params</span>, params2)</span><br><span class="line">		method(obj, SaveUnpack(concateParams))</span><br><span class="line">	end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--- 安全Pack(解决原生pack的nil截断问题, SafePack与SafeUnpack要成对使用)</span><br><span class="line">---@return table @pack后的参数<span class="function">table</span></span><br><span class="line"><span class="function">function <span class="title">SafePack</span>(<span class="params">...</span>)</span></span><br><span class="line"><span class="function">    local <span class="keyword">params</span></span> = &#123;...&#125;</span><br><span class="line">    <span class="keyword">params</span>.n = <span class="keyword">select</span>(<span class="string">&quot;#&quot;</span>, ...)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">params</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--- 安全Unpack(解决原生unpack被nil阶段问题, SafePack与SafeUnpack要成对使用)</span><br><span class="line">---@return ... @unpack后的参数列表</span><br><span class="line"><span class="function">function <span class="title">SaveUnpack</span>(<span class="params">parakParams</span>)</span></span><br><span class="line"><span class="function">	--- 使用table.<span class="title">unpack</span>()显示指定起始值和数量的方式避免被nil打断</span></span><br><span class="line"><span class="function">	<span class="keyword">return</span> table.<span class="title">unpack</span>(<span class="params">parakParams, <span class="number">1</span>, parakParams.n</span>)</span></span><br><span class="line"><span class="function">end</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">--- 合并参数</span></span><br><span class="line"><span class="function">---@param packParams1 table @已经pack的参数table1</span></span><br><span class="line"><span class="function">---@param packParams2 table @已经pack的参数table2</span></span><br><span class="line"><span class="function">---@<span class="keyword">return</span> table @合并pack后table</span></span><br><span class="line"><span class="function">function <span class="title">ConcatePack</span>(<span class="params">packParams1, packParams2</span>)</span></span><br><span class="line"><span class="function">	--- 基于table.pack和table.unpack机制合并参数</span></span><br><span class="line"><span class="function">	local finalParams</span> = &#123;&#125;</span><br><span class="line">	local params1Count = packParams1.n</span><br><span class="line">	<span class="keyword">for</span> i = <span class="number">1</span>, params1Count, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">		finalParams[i] = packParams1[i]</span><br><span class="line">	end</span><br><span class="line">	local params2Count = packParams2.n</span><br><span class="line">	<span class="keyword">for</span> i = <span class="number">1</span>, params2Count, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">		finalParams[params1Count + i] = packParams2[i]</span><br><span class="line">	end</span><br><span class="line">	finalParams.n = params1Count + params2Count</span><br><span class="line">	<span class="keyword">return</span> finalParams</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li><strong>table.unpack()默认是table.unpack(tb, 1, #tb),所以如果传递了nil的话是会被打断无法返回所有的</strong></li>
</ol>
<h2 id="Lua小知识"><a href="#Lua小知识" class="headerlink" title="Lua小知识"></a>Lua小知识</h2><ol>
<li><p>Lua里没有Class只有通过Table模拟的Class<br>参考前面的Lua OOP实现</p>
</li>
<li><p>Lua里没有this的概念，self不等价于this，函数调用传的是谁谁就是self。Lua里.定义和:定义相对于self的用法来说相当于静态和成员定义。<br>Lua里通过.调用的话是不会默认传递自身作为self的，不主动传的话self为空<br>Lua里通过:调用的话默认第一个参数就是调用者，既self</p>
</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tab.dotFunc</span><span class="params">(param)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;self = &quot;</span>, <span class="built_in">self</span>)</span><br><span class="line">    <span class="built_in">print</span>(param)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tab:colonFunc</span><span class="params">(param)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;self = &quot;</span>, <span class="built_in">self</span>)</span><br><span class="line">    <span class="built_in">print</span>(param)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">tab.dotFunc(<span class="number">1</span>)</span><br><span class="line">tab:colonFunc(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<pre><code>![LuaDotAndColon](/img/Lua/LuaDotAndColon.png)
Note:
:只是起了省略第一个参数self的作用，该self指向调用者本身，并没有其他特殊的地方。
</code></pre>
<ol start="3">
<li><p>Lua中的函数是带有词法定界（lexical scoping）的第一类值（first-class values）(在Lua中函数和其他值（数值、字符串）一样，函数可以被存放在变量中，也可以存放在表中，可以作为函数的参数，还可以作为函数的返回值)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class:Func</span><span class="params">(param1, func)</span></span></span><br><span class="line">    <span class="built_in">print</span>(param1)</span><br><span class="line">    func()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">myfunc = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;tempFunc()&quot;</span>) <span class="keyword">end</span></span><br><span class="line">class:Func(<span class="number">1</span>, myfunc)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaFirstClassValues.png" alt="LuaFirstClassValues"></p>
</li>
<li><p>指定Lua搜索文件路径</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">package</span>.<span class="built_in">path</span> = *</span><br></pre></td></tr></table></figure>

<p>package.path是在Lua触发require时会去搜索的路径，默认是LUA_PATH_5_3或者LUA_PATH，详情参考:<a target="_blank" rel="noopener" href="https://www.lua.org/manual/5.3/manual.html#pdf-package.path">Lua Manual</a></p>
</li>
<li><p>Lua文件热重载<br>Lua通过require加载进来的文件都会被记录在package.loaded里，所以Lua热重载的核心就是让pacakge.loaded里的对应Lua文件清除后重新加载。</p>
 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---热重载指定Lua脚本</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reloadLua</span><span class="params">(filename)</span></span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">package</span>.<span class="built_in">loaded</span>[filename] == <span class="literal">nil</span>) <span class="keyword">then</span></span><br><span class="line">        Log.<span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;lua脚本 : %s 未被加载&quot;</span>, filename))</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        Log.<span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;lua脚本 : %s 已加载&quot;</span>, filename))</span><br><span class="line">        <span class="comment">--重置loaded信息</span></span><br><span class="line">        <span class="built_in">package</span>.<span class="built_in">loaded</span>[filename] = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">--重新加载Lua脚本</span></span><br><span class="line">    <span class="built_in">require</span>(filename)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Lua里pairs和ipairs有区别。pairs是key，value的形式遍历所有值。ipairs是从1开始按顺序递增遍历。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">testtab = &#123;[<span class="number">1</span>] = <span class="string">&quot;Tony&quot;</span>, [<span class="number">4</span>] = <span class="string">&quot;Huan&quot;</span>, [<span class="number">2</span>] = <span class="string">&quot;Tang&quot;</span>, [<span class="number">5</span>] = <span class="literal">nil</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(testtab) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k)</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(testtab) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaPairsAndIpairs.png" alt="LuaPairsAndIpairs"></p>
<p>Note:<br><strong>pairs不会被nil打断但ipairs都会被nil打断</strong><br><strong>ipairs还会被不是按1递增的打断</strong></p>
</li>
<li><p>Lua参数传递<br>Lua里通过arg[?]的形式访问传入的参数，默认第一个参数是arg[1]，arg[0]是lua脚本自身</p>
</li>
<li><p>Lua里面可以通过#得到table长度<br>Note:<br><strong>#会被nil打断</strong></p>
</li>
<li><p>Lua里打印数据类型用type</p>
</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="string">&quot;Tony&quot;</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaType.png" alt="LuaType">  </p>
<h1 id="Lua常用插件"><a href="#Lua常用插件" class="headerlink" title="Lua常用插件"></a>Lua常用插件</h1><h2 id="luarocks"><a href="#luarocks" class="headerlink" title="luarocks"></a>luarocks</h2><p><a target="_blank" rel="noopener" href="https://luarocks.org/"><strong>LuaRocks</strong> is the package manager for Lua modules.</a></p>
<p>从官方的介绍可以看出，LuaRocks相对于Lua，就好比Package Ctronl在Sublime Text里的存在，主要目的就是包管理器，方便Lua快速安装各种第三方Lua库。</p>
<p>根据官方的教程，LuaRocks安装设置相当复杂，单纯下载一个exe还有很多环境问题要处理。</p>
<p>这里本人不想使用官方<a target="_blank" rel="noopener" href="https://github.com/luarocks/luarocks/wiki/Installation-instructions-for-Windows/_edit">Installation instructions for Windows</a><a target="_blank" rel="noopener" href="https://github.com/luarocks/luarocks/wiki/_new">New Page</a>]的一键安装方式，主要是希望能用Lua5.3，他一键安装的方式好像是Lua5.1，所以最后打算把Lua和LuaRocks都按照以下博主的方式从源码编译走一遍流程:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/techfield/article/details/82896403">Windows 平台 Luarocks 3.0.2 编译安装</a></p>
<ul>
<li><p>安装<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/mingw-w64/">MinGW</a>(用于编译源码)</p>
<p>添加**&#x2F;MinGW&#x2F;bin到环境变量，确保gcc编译器能找到.</p>
<p><img src="/img/Lua/WhereMinGW.png" alt="WhereMinGW"></p>
<p>关于MinGW和Cygwin的区别这里暂时不深入，详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1343059">MinGw与Cygwin的区别</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1343059">MinGW 的主要方向是让GCC的Windows移植版能使用Win32API来编程。 Cygwin 的目标是能让Unix-like下的程序代码在Windows下直接被编译。</a></p>
<p>这里考虑到这里的主要目的是编译Windows版的Lua5.3，用哪一个都行，暂时是用MinGW了。</p>
</li>
<li><p>编译Lua5.3</p>
<p>下载<a target="_blank" rel="noopener" href="https://www.lua.org/ftp/">Lua5.3源码</a></p>
<p>MinGW安装好后，编译Lua5.3就很容易了，因为Lua5.3里面自带了MakeFile(指定make如何编译的文件，这里暂时不深入学习)，通过命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mingw32-make mingw</span><br></pre></td></tr></table></figure>

<p>就能触发编译Lua5.3，但为了LuaSocks后续会用到的相关目录准备工作，这里还是采用前面<a target="_blank" rel="noopener" href="https://blog.csdn.net/techfield/article/details/82896403">博主</a>提供的build.bat:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">:: ========================</span><br><span class="line">:: build.bat</span><br><span class="line">::</span><br><span class="line">:: build lua to dist folder</span><br><span class="line">:: tested with lua-<span class="number">5</span>.<span class="number">3</span>.<span class="number">5</span></span><br><span class="line">:: based on:</span><br><span class="line">:: https://medium.com/@CassiusBenard/lua-basics-windows-<span class="number">7</span>-installation-and-running-lua-files-from-the-command-line-e8196e988d71</span><br><span class="line">:: ========================</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line">:: you may change the following variable’s value</span><br><span class="line">:: to suit the downloaded version</span><br><span class="line"><span class="built_in">set</span> work_dir=%~dp0</span><br><span class="line">:: Removes trailing backslash</span><br><span class="line">:: to enhance readability <span class="keyword">in</span> the following steps</span><br><span class="line"><span class="built_in">set</span> work_dir=<span class="variable">%work_dir:~0,-1%</span></span><br><span class="line"><span class="built_in">set</span> lua_install_dir=<span class="variable">%work_dir%</span>\dist</span><br><span class="line"><span class="built_in">set</span> compiler_bin_dir=<span class="variable">%work_dir%</span>\tdm-gcc\bin</span><br><span class="line"><span class="built_in">set</span> lua_build_dir=<span class="variable">%work_dir%</span></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">path</span>=<span class="variable">%compiler_bin_dir%</span>;<span class="variable">%path%</span></span><br><span class="line"><span class="built_in">cd</span> /D <span class="variable">%lua_build_dir%</span></span><br><span class="line">mingw32-make PLAT=mingw</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="built_in">echo</span> **** COMPILATION TERMINATED ****</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="built_in">echo</span> **** BUILDING BINARY DISTRIBUTION ****</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line">:: create a clean “binary” installation</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\doc</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\bin</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\include</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\lib</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\doc\*.* <span class="variable">%lua_install_dir%</span>\doc\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\*.exe <span class="variable">%lua_install_dir%</span>\bin\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\*.dll <span class="variable">%lua_install_dir%</span>\bin\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\luaconf.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lua.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lualib.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lauxlib.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lua.hpp <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\liblua.a <span class="variable">%lua_install_dir%</span>\lib\liblua.a</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="built_in">echo</span> **** BINARY DISTRIBUTION BUILT ****</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="variable">%lua_install_dir%</span>\bin\lua.exe -e &quot;<span class="built_in">print</span> [[Hello!]];<span class="built_in">print</span>[[Simple Lua test successful<span class="variable">!!!</span>]]&quot;</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"></span><br><span class="line">:: configure environment variable</span><br><span class="line">:: https://stackoverflow.com/a/<span class="number">21606502</span>/<span class="number">4394850</span></span><br><span class="line">:: http://lua-users.org/wiki/LuaRocksConfig</span><br><span class="line">:: SETX - <span class="built_in">Set</span> an environment variable permanently.</span><br><span class="line">:: /m <span class="built_in">Set</span> the variable <span class="keyword">in</span> the system environment HKLM.</span><br><span class="line">setx LUA &quot;<span class="variable">%lua_install_dir%</span>\bin\lua.exe&quot; /m</span><br><span class="line">setx LUA_BINDIR &quot;<span class="variable">%lua_install_dir%</span>\bin&quot; /m</span><br><span class="line">setx LUA_INCDIR &quot;<span class="variable">%lua_install_dir%</span>\include&quot; /m</span><br><span class="line">setx LUA_LIBDIR &quot;<span class="variable">%lua_install_dir%</span>\lib&quot; /m</span><br><span class="line"></span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure>

<p>这样一来Lua编译以及Lua环境变量设置就搞定了:</p>
<p><img src="/img/Lua/LuaBuildOutput.png" alt="LuaBuildOutput"></p>
<p><img src="/img/Lua/LuaEnvSetting.png" alt="LuaEnvSetting"></p>
<p>测试以下Lua使用：</p>
<p><img src="/img/Lua/MakeSureLuaExits.png" alt="MakeSureLuaExits"></p>
<p>Note：</p>
<ol>
<li><strong>因为我们使用的是MinGW，所以博客上的make命令是找不到的需要用mingw32-make</strong></li>
<li><strong>因为涉及到设置环境变量等操作所以启动cmd或者powershell运行bat时需要以管理员身份</strong></li>
<li><strong>上文的Lua环境变量设置并未设置Lua到Path中，所以还需要单独添加Lua&#x2F;bin到能确保Lua能被找到使用</strong></li>
</ol>
</li>
<li><p>编译LuaRocks</p>
<p>下载<a target="_blank" rel="noopener" href="http://luarocks.github.io/luarocks/releases/">LuaRocks源码</a>(下一键带Install.bat的)</p>
<p>执行Install.bat触发编译流程</p>
<p><img src="/img/Lua/LuaRocksInstallCommand.png" alt="LuaRocksInstallCommand"></p>
<p>详细参数介绍参考:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/luarocks/luarocks/wiki/Installation-instructions-for-Windows">Installation instructions for Windows</a></p>
<p>最后看到LuaRocks安装成功:</p>
<p><img src="/img/Lua/LuaRocksInstallSuccess.png" alt="LuaRocksInstallSuccess"></p>
<p>最后将LuaRocks&#x2F;systree&#x2F;bin所在目录添加到环境变量Path里，这样通过LuaRocks安装的第三方库就可以使用了(经测试单独只加到Path里还不行(好像是因为Lua和LuaRocks默认分开安装的)，package.path里默认是不会去LuaRocks&#x2F;systree&#x2F;bin下找的)，需要执行以下命令来查看手动设置LUA_PATH所需的位置信息：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luarocks <span class="built_in">path</span> --bin</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaRocksPathAndCPath.png" alt="LuaRocksPathAndCPath"></p>
<p>原本的LUA_PATH和LUACPATH信息：</p>
<p><img src="/img/Lua/OrignalLuaPathAndCPath.png" alt="OrignalLuaPathAndCPath"></p>
<p>把上面两个手动设置到环境变量LUA_PATH和LUA_CPATH里:</p>
<p><img src="/img/Lua/LuaEnviromentSetting.png" alt="LuaEnviromentSetting"></p>
</li>
</ul>
<p>接下来测试LuaRocks的使用：</p>
<p>我们尝试安装serpent：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luarocks install serpent</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/InstallSerpent.png" alt="InstallSerpent"></p>
<p><img src="/img/Lua/SerpentInstallatio.png" alt="SerpentInstallatio"></p>
<p>后续会讲到serpent的使用学习，到这里Lua5.3和LuaRocks以及serpent的LuaRocks快速安装就全部结束了。</p>
<h2 id="serpent"><a href="#serpent" class="headerlink" title="serpent"></a>serpent</h2><p><a target="_blank" rel="noopener" href="https://github.com/pkulchenko/serpent">Lua serializer and pretty printer.</a></p>
<p>从Git上的介绍可以看出，Serpent是一个支持序列化反序列化以及格式化打印的第三方库。</p>
<p>比如我们希望把内存里的某个Table序列化到本地，支持下一次反序列化加载：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SerpentStudy!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;DIYLog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> serpent = <span class="built_in">require</span> <span class="string">&quot;serpent&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> serializeDataTable = &#123;</span><br><span class="line">	[<span class="string">&quot;Name&quot;</span>] = <span class="string">&quot;TonyTang&quot;</span>,</span><br><span class="line">	detailInfo = &#123;</span><br><span class="line">		[<span class="string">&quot;Age&quot;</span>] = <span class="number">18</span>,</span><br><span class="line">		[<span class="string">&quot;BirthDate&quot;</span>] = <span class="string">&quot;2000/01/01&quot;</span>,</span><br><span class="line">		[<span class="string">&quot;Adrress&quot;</span>] = <span class="string">&quot;SiChuan&quot;</span>		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> serializeString = serpent.<span class="built_in">dump</span>(serializeDataTable)</span><br><span class="line"><span class="built_in">print</span>(serializeString)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> formatSerializeString = serpent.block(serializeDataTable)</span><br><span class="line"><span class="built_in">print</span>(formatSerializeString)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> result, deserializeDataTable = serpent.<span class="built_in">load</span>(formatSerializeString)</span><br><span class="line">print_table(deserializeDataTable)</span><br></pre></td></tr></table></figure>

<p>输出:</p>
<p><img src="/img/Lua/SerpentOutput.png" alt="SerpentOutput"></p>
<p>从上面测试用例结果可以看出，通过Serpent我们轻易的做到了Lua序列化反序列化以及格式化输出</p>
<h2 id="Lpeg"><a href="#Lpeg" class="headerlink" title="Lpeg"></a>Lpeg</h2><p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/"><em>LPeg</em> is a new pattern-matching library for Lua, based on Parsing Expression Grammars (PEGs). </a></p>
<p>从官方的介绍可以看出Lpeg是一个类似正则的但并不是正则的新一代(基于Parsing Expression Grammars)的模式匹配Lua库。</p>
<p>那么什么是Parsing Expression Grammars了？</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Parsing_expression_grammar"> a <strong>parsing expression grammar</strong> (<strong>PEG</strong>), is a type of analytic formal grammar, i.e. it describes a formal language in terms of a set of rules for recognizing strings in the language.</a></p>
<p>根据Wiki的介绍可以看出Parsing Expression Grammars就是我们编程语言里的解析表达式语法。</p>
<p>为了进一步的深入学习和使用，让我们先通过Luasocks安装Lpeg库。</p>
<p><img src="/img/Lua/LpegInstallation.png" alt="LpegInstallation"></p>
<p>接下来文档<a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/">Lpeg</a>和下面这篇文章<a target="_blank" rel="noopener" href="https://www.cnblogs.com/freeblues/p/8436523.html">通过 LPeg 介绍解析表达式语法(Parsing Expression Grammars)</a>来深入学习Lpeg的设计和使用:</p>
<h3 id="Pattern"><a href="#Pattern" class="headerlink" title="Pattern"></a>Pattern</h3><p>Pattern差不多可以理解成正则里的匹配表达式。</p>
<p>为了方便理解，这里先截图下Lpeg Pattern相关定义的基础介绍:</p>
<p><img src="/img/Lua/LpegPatternsDoc.png" alt="LpegPatternsDoc"></p>
<h3 id="Match"><a href="#Match" class="headerlink" title="Match"></a>Match</h3><p>Match也和正则里的概念差不多，就是触发指定字符串使用指定Pattern进行匹配的一个过程，同时返回匹配相关结果(比如返回匹配到的字符位置的下一个字符位置。或者通过Capture函数将匹配结果转换成指定值)</p>
<p>了解了Lpeg里面的一些基础Pattern定义后，让我们看看Lpeg里匹配函数match的介绍:</p>
<p>lpeg.match (pattern, subject [, init])</p>
<p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/">The matching function. It attempts to match the given pattern against the subject string. If the match succeeds, returns the index in the subject of the first character after the match, or the captured values(if the pattern captured any value).</a></p>
<p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/">Unlike typical pattern-matching functions, <code>match</code> works only in <em>anchored</em> mode; that is, it tries to match the pattern with a prefix of the given subject string (at position <code>init</code>), not with an arbitrary substring of the subject. So, if we want to find a pattern anywhere in a string, we must either write a loop in Lua or write a pattern that matches anywhere.</a></p>
<p>从上面的介绍可以看出，match匹配成功会返回匹配位置的下一个位置或者是捕获到的值(后续会讲到<strong>捕获函数</strong>相关)。同时match不想正则可以把所有匹配都找出来而是需要通过自行通过match的init方式来loop所有捕获后的子字符串来找出所有匹配的结果。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/freeblues/p/8436523.html">默认情况下，成功匹配时，<code>LPeg</code> 将返回字符消耗数(译者注: 也就是成功匹配子串之后的下一个字符的位置). 如果你只是想看看是否匹配这就足够好了，但如果你试图解析出字符串的结构来，你必须用一些 <code>LPeg</code> 的捕获(<code>capturing</code>)函数.</a></li>
</ol>
<h3 id="Capture"><a href="#Capture" class="headerlink" title="Capture"></a>Capture</h3><p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/#captures">A <em>capture</em> is a pattern that produces values (the so called <em>semantic information</em>) according to what it matches. LPeg offers several kinds of captures, which produces values based on matches and combine these values to produce new values. Each capture may produce zero or more values.</a></p>
<p>从介绍大概理解Capture也是一种Pattern，但它是一种基于Pattern匹配结果转换出结果值的Pattern而不是常规的匹配Pattern(个人理解就好比Pattern+转换函数)。</p>
<p>为了方便理解，这里先截图下Capture相关定义的基础介绍:</p>
<p><img src="/img/Lua/LpegCaptureDoc.png" alt="LpegCaptureDoc"></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/#captures">A capture pattern produces its values only when it succeeds.</a>(Capture Pattern只会在成功时计算值)</li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;LpegStudy&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;DIYLog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 最终目标：</span></span><br><span class="line"><span class="comment">--- 1. &#123;***&#125;占位替换 </span></span><br><span class="line"><span class="comment">--- 2. &#123;num string1 | string2 | string3 &#125;根据num选择对应字符串</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> lpeg = <span class="built_in">require</span>(<span class="string">&quot;lpeg&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> <span class="built_in">match</span> = lpeg.<span class="built_in">match</span></span><br><span class="line"><span class="keyword">local</span> P = lpeg.P</span><br><span class="line"><span class="keyword">local</span> R = lpeg.R</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 普通匹配</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;普通匹配:&quot;</span>)</span><br><span class="line"><span class="comment">--- 不匹配，返回nil</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(P(<span class="string">&quot;hello&quot;</span>), <span class="string">&quot;world&quot;</span>))</span><br><span class="line"><span class="comment">--- 一个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(P(<span class="string">&quot;hello&quot;</span>), <span class="string">&quot;hello&quot;</span>))</span><br><span class="line"><span class="comment">--- 一个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(P(<span class="string">&quot;hello&quot;</span>), <span class="string">&quot;helloworld&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 模式组合</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;模式组合:&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> helloPattern = P(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> worldPattern = P(<span class="string">&quot;world&quot;</span>)</span><br><span class="line"><span class="comment">--- *表示匹配pattern1后面跟随pattern2</span></span><br><span class="line"><span class="keyword">local</span> helloAndworldPattern = helloPattern * worldPattern</span><br><span class="line"><span class="comment">--- +表示匹配pattern1或者pattern2</span></span><br><span class="line"><span class="keyword">local</span> helloOrworldPattern = helloPattern + worldPattern</span><br><span class="line"><span class="comment">--- 一个匹配，返回11</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloAndworldPattern, <span class="string">&quot;helloworld&quot;</span>))</span><br><span class="line"><span class="comment">--- 不匹配，返回nil</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloAndworldPattern, <span class="string">&quot;worldhello&quot;</span>))</span><br><span class="line"><span class="comment">--- 1个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloOrworldPattern, <span class="string">&quot;helloworld&quot;</span>))</span><br><span class="line"><span class="comment">--- 1个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloOrworldPattern, <span class="string">&quot;worldhello&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 解析数字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;解析数字:&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> integerPattern = R(<span class="string">&quot;09&quot;</span>)^<span class="number">1</span></span><br><span class="line"><span class="comment">--- 解析数字带捕获函数</span></span><br><span class="line"><span class="keyword">local</span> integerCapturePattern = R(<span class="string">&quot;09&quot;</span>)^<span class="number">1</span> / <span class="built_in">tonumber</span></span><br><span class="line"><span class="comment">--- 匹配，返回5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(integerPattern, <span class="string">&quot;2923 2924&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，返回2923</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(integerCapturePattern, <span class="string">&quot;2923 2924&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 解析数字或者字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;解析数字或者字符：&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> charPattern = P(<span class="number">1</span>)</span><br><span class="line"><span class="comment">--- 匹配，返回2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(charPattern, <span class="string">&quot;hello 123&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> integerOrchaPattern = integerCapturePattern<span class="comment">-- + charPattern</span></span><br><span class="line"><span class="comment">--- 利用Capture.Ct函数存储所有匹配结果到表中</span></span><br><span class="line"><span class="keyword">local</span> integerOrcharCapture = lpeg.Ct(integerOrchaPattern^<span class="number">0</span>)</span><br><span class="line"><span class="comment">--- 未匹配输出 &#123;&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;hello!&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出：&#123;123&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;hello 123&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出：&#123;5,5,5,7,7,7&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;5 5 5 yeah 7 7 7&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出：&#123;5,5,5,7,7,7&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;5 5 5 a b c d 7 7 7&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 计算器语法解析器</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;计算器语法解析器:&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> white = lpeg.S(<span class="string">&quot; \t\r\n&quot;</span>) ^ <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> integer = white * lpeg.R(<span class="string">&quot;09&quot;</span>) ^ <span class="number">1</span> / <span class="built_in">tonumber</span></span><br><span class="line"><span class="keyword">local</span> muldiv = white * lpeg.C(lpeg.S(<span class="string">&quot;/*&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> addsub = white * lpeg.C(lpeg.S(<span class="string">&quot;+-&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> factor = integer * muldiv * integer + integer</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;5&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(lpeg.Ct(factor), <span class="string">&quot;5&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;2,&quot;*&quot;,1&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(lpeg.Ct(factor), <span class="string">&quot;2*1&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 字符串匹配替换</span></span><br><span class="line"><span class="comment">--- 实现类似gsub的方法的效果</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;字符串匹配替换：&quot;</span>)</span><br><span class="line"><span class="comment">--- lpeg.Ct -- 仅仅捕获到table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">(s, patt)</span></span></span><br><span class="line">	patt = P(patt) / <span class="built_in">tostring</span></span><br><span class="line">	<span class="keyword">local</span> p = lpeg.Ct((patt + <span class="number">1</span>)^<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">match</span>(p, s)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- lpeg.Cs -- 捕获并替换</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gsub</span><span class="params">(s, patt, repl)</span></span></span><br><span class="line">	patt = P(patt)</span><br><span class="line">	<span class="keyword">local</span> p = lpeg.Cs((patt / repl + <span class="number">1</span>)^<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">match</span>(p, s)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;&quot;dog&quot;,&quot;dog&quot;&#125;</span></span><br><span class="line">print_table(<span class="built_in">find</span>(<span class="string">&quot;hello dog, dog!&quot;</span>, <span class="string">&quot;dog&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;&quot;hello cat, cat!&quot;&#125;</span></span><br><span class="line">print_table(<span class="built_in">gsub</span>(<span class="string">&quot;hello dog, dog!&quot;</span>, <span class="string">&quot;dog&quot;</span>, <span class="string">&quot;cat&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 最终目标1: &#123;***&#125;占位替换</span></span><br><span class="line"><span class="comment">--- 指定字符串，采用table里的key替换&#123;key&#125;成key对应的value</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tableGsub</span><span class="params">(s, tb)</span></span></span><br><span class="line">	<span class="keyword">local</span> result = s</span><br><span class="line">	<span class="keyword">local</span> replaceKey = <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">local</span> replaceValue = <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(tb) <span class="keyword">do</span></span><br><span class="line">		replaceKey = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;&#123;%s&#125;&quot;</span>, key)</span><br><span class="line">		replaceValue = <span class="built_in">tostring</span>(value)</span><br><span class="line">		<span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;字符串:%s 替换:%s为%s&quot;</span>, result, replaceKey, replaceValue))</span><br><span class="line">		result = <span class="built_in">gsub</span>(result, replaceKey, replaceValue)</span><br><span class="line">		<span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;替换后结果:%s&quot;</span>, result))</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> content = <span class="string">&quot;测试table替换,名字:&#123;name&#125; 年龄:&#123;age&#125; 性别:&#123;sex&#125; 名字2:&#123;name&#125; 名字3:&#123;name&#125;&quot;</span></span><br><span class="line"><span class="keyword">local</span> replaceTable = &#123;</span><br><span class="line">	name = <span class="string">&quot;TonyTang&quot;</span>,</span><br><span class="line">	sex = <span class="string">&quot;Man&quot;</span>,</span><br><span class="line">	age = <span class="number">18</span>,</span><br><span class="line">	luckyNumber = <span class="number">7</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">local</span> timeCounter = New(TimeCounter, <span class="string">&quot;tableGsub&quot;</span>)</span><br><span class="line">timeCounter:Start()</span><br><span class="line">content = tableGsub(content, replaceTable)</span><br><span class="line">timeCounter:Stop()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;替换后结果:replaceValue&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;替换耗时:%s&quot;</span>, timeCounter.EllapseTime))</span><br></pre></td></tr></table></figure>









<h1 id="Lua-IDE"><a href="#Lua-IDE" class="headerlink" title="Lua IDE"></a>Lua IDE</h1><p>首先这里决定选一个相对轻量级的Lua IDE，VS因为太重量级了，这里不考虑。<br>其次考虑到跨平台和前端常用的(平时主要会用到C#和Lua)，最初决定选择VSCode作为Lua代码编写的IDE，VSCode丰富的插件库也是选择VSCode很重要的一个原因之一。经过调研发现VSCode第三方插件<a target="_blank" rel="noopener" href="https://www.showdoc.cc/luaide?page_id=1832520940259550">Luaide在VSCode 1.33.1以上版本有严重的内存暴涨问题</a>，所以最后笔者转向了VSCode + EmmyLua 插件的方式。</p>
<h2 id="VSCode"><a href="#VSCode" class="headerlink" title="VSCode"></a>VSCode</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Visual_Studio_Code">Visual Studio Code（简称VS Code）是一个由微软开发的，同时支持Windows、Linux、和macOS系统且开放源代码的代码编辑器[4]，它支持测试，并内置了Git 版本控制功能，同时也具有开发环境功能，例如代码补全（类似于 IntelliSense）、代码片段、和代码重构等，该编辑器支持用户个性化配置，例如改变主题颜色、键盘快捷方式等各种属性和参数，还在编辑器中内置了扩展程序管理的功能。</a></p>
<h3 id="设置同步"><a href="#设置同步" class="headerlink" title="设置同步"></a>设置同步</h3><p>VSCode支持高度自由的自定义插件和自定义设置，我们如何在不同的工作环境快速同步IDE信息(插件，自定义设置等)，避免每一次在不同工作环境下都重复下载插件设置等操作是一个需要解决的问题。</p>
<p>借助于第三方插件：<br>SettingsSync(使用了Github Gist)可以同步保存VSCode配置和扩展。</p>
<p>详细配置流程参考:<br><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=Shan.code-settings-sync">Settings Sync</a></p>
<p>上传快捷键：<br>Shift + Alt + U<br>下载同步快捷键：<br>Shift + Alt + D</p>
<h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><p>当拿到新的IDE时，为了工作效率，快捷键不熟是一个很影响开发效率的问题。<br>VSCode丰富的插件库和高度的可自定义可以轻松解决这个问题：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.vs-keybindings">Visual Studio Keymap</a>(第三方插件 – 快速导入VS的快捷键)</li>
<li>Custom Shortcup Keymap(自定义设置快捷键File -&gt; Preference -&gt; Keyboard Shortcuts – 用于满足自定义需求)</li>
</ol>
<h3 id="Snippets"><a href="#Snippets" class="headerlink" title="Snippets"></a>Snippets</h3><p>Snippets又名代码片段，主要目的是为了通过自定义关键词和模板，快速触发代码片段生成。<br>这里主要针对自定义代码片段的功能使用来学习。<br>File -&gt; Preference -&gt; User Snippets<br>e.g.个人文件署名的代码片段：<br>lua.json</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Lua File Title Sneppits&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;prefix&quot;</span>: <span class="string">&quot;LuaFileTitle&quot;</span>,</span><br><span class="line">        <span class="string">&quot;body&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;-- File Name:    $TM_FILENAME&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-- Description:    This file is used to $&#123;1:Staff&#125;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-- Author:       $&#123;2:TangHuan&#125;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-- Create Date:    $&#123;3:Year&#125;/$&#123;4:Month&#125;/$&#123;5:Day&#125;&quot;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Lua File Title Sneppits&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来当我们输入LuaFileTitle关键词时，VSCode就会自动触发提示，直接table键选择Snippets就能触发代码生成。<br>效果如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:    Base.lua</span></span><br><span class="line"><span class="comment">-- Description:    This file is used to Staff</span></span><br><span class="line"><span class="comment">-- Author:       TangHuan</span></span><br><span class="line"><span class="comment">-- Create Date:    Year/Month/Day</span></span><br></pre></td></tr></table></figure>

<p>详细使用Snippets参考:<br><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/editor/userdefinedsnippets">Creating your own snippets</a></p>
<h3 id="Lua调试"><a href="#Lua调试" class="headerlink" title="Lua调试"></a>Lua调试</h3><p>Lua作为解析执行的语言，调试相比其他高级语言比较麻烦一点，这里选择借助第三方(Luaide)插件作为辅助工具。</p>
<p>经过调研发现VSCode第三方插件<a target="_blank" rel="noopener" href="https://www.showdoc.cc/luaide?page_id=1832520940259550">Luaide在VSCode 1.33.1以上版本有严重的内存暴涨问题</a>，所以最后笔者转向了VSCode + EmmyLua 插件的方式。<br>这里就没有详细了解VSCode + LuaIde的调试方式了。</p>
<h4 id="EmmyLua"><a href="#EmmyLua" class="headerlink" title="EmmyLua"></a>EmmyLua</h4><p><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/annotation.html">EmmyLua</a><br>VSCode安装EmmyLua很简单，直接插件里搜索安装即可，这里就不多做说明。</p>
<p>接下来主要结合XLua+VSCode+EmmyLua实战使用EmmyLua提示和调试两大重要功能。</p>
<h5 id="VSCode配置"><a href="#VSCode配置" class="headerlink" title="VSCode配置"></a>VSCode配置</h5><p>安装EmmyLua插件后，VSCode基本就已经完成配置了，但要使用VSCode开始编写Lua代码，我们还需要把Lua代码导入到VSCode里来。</p>
<p>VSCode导入Lua代码是以目录的形式，我们导入的我们加载Lua文件所在的最上层目录即可：<br><img src="/img/Lua/LuaFolderStructure.png" alt="LuaFolderStructure"></p>
<h5 id="XLua"><a href="#XLua" class="headerlink" title="XLua"></a>XLua</h5><p><a target="_blank" rel="noopener" href="https://github.com/Tencent/xLua">XLua官网</a><br>XLua的集成很简单，从Git下下来，把关键的几个目录放到项目里即可。<br>主要是如下几个目录：</p>
<ol>
<li>Tools(打包时XLua代码注入需要的工具在这里 Note: 放Assets同一层不要放到Assets里了)</li>
<li>Assets&#x2F;XLua&#x2F;Src(XLua需要的CS源代码)</li>
<li>Assets&#x2F;XLua&#x2F;Editor&#x2F;ExampleConfig.cs(XLua默认给的一套纯Lua开发基于反射生成需要标记CSharpCallLua || LuaCallCSharp || BlackList || Hotfix的一套模板)</li>
<li>Assets&#x2F;Plugins(XLua编译多平台后的库文件)</li>
</ol>
<p>Unity加载Lua文件默认不认.lua后缀的文件，我们需要自定义CustomLoader去加载到我们想要加载的.lua文件。<br>LuaManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> XLua;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lua单例管理者</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LuaManager</span> : <span class="title">SingletonMonoBehaviourTemplate</span>&lt;<span class="title">LuaManager</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua环境(全局唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> LuaEnv LuaEnv</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua脚本默认创建目录路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> LuaScriptFolderPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua脚本文件后缀</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> LuaFilePostFix = <span class="string">&quot;.lua&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua脚本文件路径映射Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Key为文件名(不含.lua后缀)，Value为该文件的全路径(含.lua后缀)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; mLuaScriptFilePathMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;LuaManager:init()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (LuaEnv == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            LuaEnv = <span class="keyword">new</span> LuaEnv();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Lua环境已经初始化！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LuaScriptFolderPath = Application.dataPath + <span class="string">&quot;/Scripts/XLua/Lua/&quot;</span>;</span><br><span class="line">        mLuaScriptFilePathMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自定义CustomLoader</span></span><br><span class="line">        LuaEnv.AddLoader(LuaCustomLoader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取所有Lua文件</span></span><br><span class="line">        readAllLuaFiles();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载LuaMain.lua</span></span><br><span class="line">        LuaEnv.DoString(<span class="string">&quot;require &#x27;LuaMain&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readAllLuaFiles</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> allluafiles = Directory.GetFiles(LuaScriptFolderPath, <span class="string">&quot;*.lua&quot;</span>, SearchOption.AllDirectories);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> luafile <span class="keyword">in</span> allluafiles)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> luafilename = Path.GetFileNameWithoutExtension(luafile);</span><br><span class="line">            <span class="keyword">if</span>(!mLuaScriptFilePathMap.ContainsKey(luafilename))</span><br><span class="line">            &#123;</span><br><span class="line">                mLuaScriptFilePathMap.Add(luafilename, luafile);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;有重名的Lua文件,文件路径:&#123;0&#125;文件路径:&#123;1&#125;&quot;</span>,luafile, mLuaScriptFilePathMap[luafilename]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua自定义Loader</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">byte</span>[] <span class="title">LuaCustomLoader</span>(<span class="params"><span class="keyword">ref</span> <span class="built_in">string</span> filename</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;加载Lua文件 ： &#123;0&#125;&quot;</span>, filename));</span><br><span class="line">        <span class="keyword">var</span> scriptfullpath = <span class="built_in">string</span>.Empty;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        <span class="comment">//Editor走File加载</span></span><br><span class="line">        <span class="comment">//Unity不认Lua后缀的情况</span></span><br><span class="line">        <span class="keyword">var</span> luascriptfolderpath = <span class="built_in">string</span>.Empty;</span><br><span class="line">        <span class="built_in">byte</span>[] luafile = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mLuaScriptFilePathMap.TryGetValue(filename, <span class="keyword">out</span> scriptfullpath))</span><br><span class="line">        &#123;</span><br><span class="line">            luafile = File.ReadAllBytes(scriptfullpath);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">        <span class="comment">//真机走其他方式加载</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (luafile != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> luafile;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;找不到Lua文件 : &#123;0&#125;&quot;</span>, filename));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到为了成功加载.lua后缀的Lua文件我做了以下几件事：</p>
<ol>
<li>通过Directory.GetFiles()获取到所有*.lua文件的路径映射，用于加载时消除目录的概念</li>
<li>自定义CustomLoader，支持加载(通过File.ReadAllBytes).lua后缀文件</li>
</ol>
<h5 id="代码提示"><a href="#代码提示" class="headerlink" title="代码提示"></a>代码提示</h5><p>Test.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:    Test.lua</span></span><br><span class="line"><span class="comment">-- Description:    This file is used to Test EmmyLua</span></span><br><span class="line"><span class="comment">-- Author:       TangHuan</span></span><br><span class="line"><span class="comment">-- Create Date:    2019/04/29</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 自定义table类型，测试Emmylua注释提示</span></span><br><span class="line"><span class="comment">---@class diytable</span></span><br><span class="line"><span class="comment">---@field field1 number 字段1</span></span><br><span class="line"><span class="comment">---@field field2 string 字段2</span></span><br><span class="line"><span class="keyword">local</span> diytable = &#123;</span><br><span class="line">    field1 = <span class="number">321</span>,</span><br><span class="line">    field2 = <span class="string">&quot;field2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">---@param para1 number 参数1</span></span><br><span class="line"><span class="comment">---@return diytable 返回diytable</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Test</span><span class="params">(para1)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Test(&quot;</span> .. para1 .. <span class="string">&quot;)&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> diytable</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">table</span> = Test(<span class="number">123</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">table</span>.field1)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">table</span>.field2)</span><br></pre></td></tr></table></figure>

<p>输入table.时会看到成员变量提示:<br><img src="/img/Lua/EmmyLuaNotation.png" alt="EmmyLuaNotation"></p>
<p>EmmyLua提示详细使用参考：<br><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/annotations/class.html">@class类声明注解</a></p>
<h5 id="查找方法引用"><a href="#查找方法引用" class="headerlink" title="查找方法引用"></a>查找方法引用</h5><p>EmmyLua查找方法引用很简单，直接在方法上右键查找所有引用即可：<br><img src="/img/Lua/LuaMethodReference.png" alt="LuaMethodReference"></p>
<h5 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h5><p>EmmyLua插件装好后，VSCode导入了Lua加载最上层目录后，调试Lua就很简单了：<br>F5 -&gt; EmmyLua Attach Debug -&gt; 选择对应Unity进程<br>然后通过F9下断点就可以像VS一样给Lua下断点了。<br><img src="/img/Lua/VSCodeEmmyLuaDebug.png" alt="VSCodeEmmyLuaDebug"></p>
<h1 id="ToLua"><a href="#ToLua" class="headerlink" title="ToLua"></a>ToLua</h1><p>待续……</p>
<h1 id="Refrence"><a href="#Refrence" class="headerlink" title="Refrence"></a>Refrence</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/freeblues/p/8436523.html">通过 LPeg 介绍解析表达式语法(Parsing Expression Grammars)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg">lpeg</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangziqiu/archive/2011/03/30/computercode.html">原码, 反码, 补码 详解</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000024426172">谈谈二进制（四）——原码、补码、反码、移码</a></p>
<h2 id="以前学习笔记"><a href="#以前学习笔记" class="headerlink" title="以前学习笔记"></a>以前学习笔记</h2><p>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]</a>(Game Scripting Mastery)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0rk.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0rk.html]</a>(Lua – some important concept and knowledge)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s0.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s0.html]</a>(Lua - Coroutines Study )<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s5.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s5.html]</a>(Lua - Metatables and Metamethods)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s9.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s9.html]</a>(Lua - Object Oriented Programming)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zp.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0zp.html]</a>(Lua - C API)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zs.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0zs.html]</a>(Lua - C call Lua &amp; Lua call C )<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v1qg.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v1qg.html]</a>(Lua - Userdata )<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v383.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v383.html]</a>(Lua - Managing Resources &amp; Threads and States)</p>
<h2 id="官方网站"><a href="#官方网站" class="headerlink" title="官方网站"></a>官方网站</h2><p><a target="_blank" rel="noopener" href="https://github.com/Tencent/xLua">XLua</a><br><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/installation.html">EmmyLua</a></p>
<h2 id="参考书籍"><a href="#参考书籍" class="headerlink" title="参考书籍"></a>参考书籍</h2><p>《Programming in Lua third edition》 – Roberto Ierusalimschy<br>《Lua用户手册》<br>《Game Scripting Mastery》 – Alex Varanese</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Programming-Language/">Programming Language</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Lua/">Lua</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/06/14/Android自动化签包/" title="Android自动化签包" itemprop="url">Android自动化签包</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-06-14T02:12:01.000Z" itemprop="datePublished"> 发表于 2017-06-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Android-Sign-Study"><a href="#Android-Sign-Study" class="headerlink" title="Android Sign Study"></a>Android Sign Study</h1><p>这一章主要是学习Android签包相关的概念和方法。<br>通过采用原始签包工具(zipalign &amp; apksigner &amp; keytool)，使用命令行的形式对于已经经过Unity打包签名的包进行重签来学习理解相关概念。</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><h2 id="When"><a href="#When" class="headerlink" title="When"></a>When</h2><p><a target="_blank" rel="noopener" href="https://developer.android.com/studio/publish/app-signing.html">Android requires that all APKs be digitally signed with a certificate before they can be installed.</a><br>Android要求所有的APK都必须通过证书签名否则不能被安装到设备上。</p>
<h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p><a target="_blank" rel="noopener" href="https://developer.android.com/studio/publish/app-signing.html">When you sign an APK, the signing tool attaches the public-key certificate to the APK. The public-key certificate serves as as a “fingerprint” that uniquely associates the APK to you and your corresponding private key.</a><br>签名可以唯一标示我们自己的APK。每个签名的APK都会有对应的公钥证书,而这个公钥证书会与我们的private key唯一对应，我们只需保证private key不泄露，就能保证我们签名的程序的唯一性。(公钥证书和私钥是由有公信力的机构分发的确保了公钥的正确性，那么与之唯一对应的私钥就保证了APK的唯一性。详情见后面)</p>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>那么我们为什么需要签名了？<br>以下引用至<a target="_blank" rel="noopener" href="https://kknews.cc/tech/yxlvj.html">Android APK签名原理及方法</a>:</p>
<ol>
<li><p>应用程序升级<br>如果想无缝升级一个应用，Android系统要求应用程序的新版本与老版本具有相同的签名与包名。若包名相同而签名不同，系统会拒绝安装新版应用。</p>
</li>
<li><p>应用程序模块化<br>Android系统可以允许同一个证书签名的多个应用程序在一个进程里运行，系统实际把他们作为一个单个的应用程序。此时就可以把我们的应用程序以模块的方式进行部署，而用户可以独立的升级其中的一个模块。</p>
</li>
<li><p>代码或数据共享<br>Android提供了基于签名的权限机制，一个应用程序可以为另一个以相同证书签名的应用程序公开自己的功能与数据，同时其它具有不同签名的应用程序不可访问相应的功能与数据。</p>
</li>
<li><p>应用程序的可认定性<br>签名信息中包含有开发者信息，在一定程度上可以防止应用被伪造。例如网易云加密对Android APK加壳保护中使用的“校验签名（防二次打包）”功能就是利用了这一点。</p>
</li>
</ol>
<h2 id="Conceptions"><a href="#Conceptions" class="headerlink" title="Conceptions"></a>Conceptions</h2><h3 id="数据摘要-Message-Digest"><a href="#数据摘要-Message-Digest" class="headerlink" title="数据摘要(Message Digest)"></a>数据摘要(Message Digest)</h3><p>以下内容引用至<a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a><br>这个知识点很好理解，百度百科即可，其实他也是一种算法，就是对一个数据源进行一个算法之后得到一个摘要，也叫作数据指纹，不同的数据源，数据指纹肯定不一样，就和人一样。</p>
<p>消息摘要算法（Message Digest Algorithm）是一种能产生特殊输出格式的算法，其原理是根据一定的运算规则对原始数据进行某种形式的信息提取，被提取出的信息就被称作原始数据的消息摘要。<br>著名的摘要算法有RSA公司的MD5算法和SHA-1算法及其大量的变体。<br>消息摘要的主要特点有：<br>1）无论输入的消息有多长，计算出来的消息摘要的长度总是固定的。例如应用MD5算法摘要的消息有128个比特位，用SHA-1算法摘要的消息最终有160比特位的输出。<br>2）一般来说（不考虑碰撞的情况下），只要输入的原始数据不同，对其进行摘要以后产生的消息摘要也必不相同，即使原始数据稍有改变，输出的消息摘要便完全不同。但是，相同的输入必会产生相同的输出。<br>3）具有不可逆性，即只能进行正向的信息摘要，而无法从摘要中恢复出任何的原始消息。</p>
<p><strong>可以看出数据摘要确保了数据的完整性。</strong></p>
<h3 id="数字签名-Signature"><a href="#数字签名-Signature" class="headerlink" title="数字签名(Signature)"></a>数字签名(Signature)</h3><p>以下内容引用至<a target="_blank" rel="noopener" href="http://andrewlcgu.github.io/2016/04/17/apk-sign-theroy/">APK签名原理解析</a>:<br>数字签名是非对称密钥加密技术与数字摘要技术的应用。将信息摘要用发送者的私钥加密，与原文一起传送给接收者。接收者只有用发送者的公钥才能解密被加密的信息摘要，然后接收者用相同的Hash函数对收到的原文产生一个信息摘要，与解密的信息摘要做比对。如果相同，则说明收到的信息是完整的，在传输过程中没有被修改；不同则说明信息被修改过，因此数字签名能保证信息的完整性。并且由于只有发送者才有加密摘要的私钥，所以我们可以确定信息一定是发送者发送的(发送者的身份认证)。</p>
<p><strong>可以看出数字签名确保了数据的正确性(数据来源可靠性)，但需要确保公钥的安全传输问题。</strong></p>
<h3 id="CA机构-Certification-Authority"><a href="#CA机构-Certification-Authority" class="headerlink" title="CA机构(Certification Authority)"></a>CA机构(Certification Authority)</h3><p>以下内容引用至<a target="_blank" rel="noopener" href="http://andrewlcgu.github.io/2016/04/17/apk-sign-theroy/">APK签名原理解析</a>:<br>受信任的第三方，承担公钥体系中公钥的合法性检验的责任</p>
<h3 id="根证书"><a href="#根证书" class="headerlink" title="根证书"></a>根证书</h3><p>以下内容引用至<a target="_blank" rel="noopener" href="http://andrewlcgu.github.io/2016/04/17/apk-sign-theroy/">APK签名原理解析</a>:<br>是未被签名的公钥证书或自签名的证书;是CA认证中心给自己颁发的证书，是信任链的起始点。安装根证书意味着对这个CA认证中心的信任。用户在使用自己的数字证书之前必须先下载根证书。</p>
<h3 id="数字证书-Certification"><a href="#数字证书-Certification" class="headerlink" title="数字证书(Certification)"></a>数字证书(Certification)</h3><p>以下内容引用至<a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a>:<br>所谓数字证书，一般包含以下一些内容：</p>
<ol>
<li>证书的发布机构（Issuer）</li>
<li>证书的有效期（Validity）</li>
<li>消息发送方的公钥</li>
<li>证书所有者（Subject）</li>
<li>数字签名所使用的算法</li>
<li>数字签名<br>可以看出，数字证书其实也用到了数字签名技术。只不过要签名的内容是消息发送方的公钥，以及一些其它信息。但与普通数字签名不同的是，数字证书中签名者不是随随便便一个普通的机构，而是要有一定公信力的机构。这就好像你的大学毕业证书上签名的一般都是德高望重的校长一样。一般来说，这些有公信力机构的根证书已经在设备出厂前预先安装到了你的设备上了。所以，数字证书可以保证数字证书里的公钥确实是这个证书的所有者的，或者证书可以用来确认对方的身份。数字证书主要是用来解决公钥的安全发放问题。<br><img src="/img/Android/CertificationVerificationFlowChat.PNG" alt="CertificationVerificationFlowChat"></li>
</ol>
<p><strong>可以看出通过获得权威的机构获取到唯一的数字证书，这样一来解决了前面数字签名提到的公钥安全传输问题(数字证书能够确保公钥的正确性)</strong></p>
<h3 id="keystores"><a href="#keystores" class="headerlink" title="keystores"></a>keystores</h3><p>因为没有正确签名的应用，Android系统不会安装或者运行。所以我们通过有公信力机构得到公钥证书以及与之唯一对应的私钥，我们就能验证特定应用是否是特定私钥签名的应用()<br>接下来我们了解下Android签名过程中一个重要概念：<br>keystore存储着公信力机构分发的私钥和公钥证书。<br>通过使用keystore签名APK，我们能够确保APK的唯一性。</p>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><p>接下来通过使用相关签名工具来重签一个已经签过名的APK来实战学习理解签名过程。</p>
<h3 id="apktool"><a href="#apktool" class="headerlink" title="apktool"></a>apktool</h3><p>apktool是一个帮助我们编码和反编码APK的一个工具。<br>这里我有一个已经签过名的APK_Signed_Aligned.apk为例进行重签：<br>第一步：<br>准备好APK和apktool:<br><img src="/img/Android/apktoolprepare.PNG" alt="apktoolprepare"><br>第二步：<br>我们需要反编码APK：<br><img src="/img/Android/apktooldecode.PNG" alt="apktooldecode"><br>第三步:<br>替换APK_Signed_Aligned里的部分内容(比如替换Log之类的)然后进入刚才反编码的文件夹进行APK重编码(这时我们会得到一个重编码后APK_Unsigned_Unaligned.apk)：<br><img src="/img/Android/apktoolbuild.PNG" alt="apktoolbuild"><br>Note:<br><a target="_blank" rel="noopener" href="https://ibotpeaches.github.io/Apktool/documentation/#decoding">In order to run a rebuilt application. You must resign the application. Android documentation can help with this.</a><br>此时的APK_Unsigned_Unaligned.apk是处于未签名也未进行压缩数据对齐处理(后续会讲到)。</p>
<h3 id="zipalign"><a href="#zipalign" class="headerlink" title="zipalign"></a>zipalign</h3><p><a target="_blank" rel="noopener" href="https://developer.android.com/studio/command-line/zipalign.html">zipalign is an archive alignment tool that provides important optimization to Android application (APK) files. The purpose is to ensure that all uncompressed data starts with a particular alignment relative to the start of the file.</a><br>zipalign是一个对于APK压缩数据进行对齐处理的工具。<br>第四步：<br>对APK_Unsigned_Unaligned.apk进行压缩数据对齐处理得到压缩数据对齐的APK_Unsigned_Aligned.apk:<br><img src="/img/Android/zipalignalignment.PNG" alt="zipalignalignment"></p>
<p>Note:<br>zipalign位于Android SDK的build tools目录下。</p>
<h3 id="keytool"><a href="#keytool" class="headerlink" title="keytool"></a>keytool</h3><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/6/docs/technotes/tools/windows/keytool.html">Manages a keystore (database) of cryptographic keys, X.509 certificate chains, and trusted certificates.</a><br>keytool这里可以理解成有公信力的机构(工具)帮助我们生成唯一的公共证书和与之对应的私钥。</p>
<p>第五步：<br>在对我们进行压缩数据对齐后的APK_Unsigned_Aligned.apk进行重签之前，我们需要生成自己的keystore用于签名认证我们的APK。<br>使用keytool生成我们需要的公共证书和与之对应的私钥：<br><img src="/img/Android/keytoolgenerakeystore.PNG" alt="keytoolgenerakeystore"><br>上面要填的信息就是之前在数字证书里提到的生成公共秘钥和私钥需要的信息。<br>最后得到我们的TonyTangKeyStore.jks(签名需要的keystore，公共秘钥和私钥都在里面)<br><img src="/img/Android/keystore.PNG" alt="keystore"><br>接下来我们通过keytool查看我们刚生成的keystore信息(因为不是在同一台电脑上测试学习KeyStore，所以路径并不一致)：<br><img src="/img/Android/KeyStoreInfo.PNG" alt="KeyStoreInfo"><br>可以看到我们的Keystore是由Sun公司提供的，采用SHA1(前面提到的数字摘要算法之一e.g. MD5 or SHA1)算法计算私钥的数字摘要。</p>
<p>Note:<br>keytool位于JDK的bin目录下。<br>上面输入的Keystore密码后续签包时会用到。<br>上面生成keystore默认只有90天有效期，在开发过程中我们要保证keystore有效期远大于软件生命周期，不然期限到了就无法在继续使用同一个keystore，也就不能保证APK的唯一性了。<br>keytool貌似有个参数-validity是决定有效期的，这里就没有尝试了，详情参考keytool官网。</p>
<h3 id="apksigner"><a href="#apksigner" class="headerlink" title="apksigner"></a>apksigner</h3><p>第六步：<br>得到了keystore，那么我们就可以进行签名工作了。<br>使用apksigner进行签包：<br><img src="/img/Android/apksignersigne.PNG" alt="apksignersigne"><br>通过apksigner验证特定APK是否签名：<br><img src="/img/Android/apksignerverify.PNG" alt="apksignerverify"><br>最终我们得到了我们重新重签后的APK_Signed_Aligned.apk(与我们使用的keystore里的私钥唯一对应)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/command-line/apksigner.html#usage">The apksigner tool, available in revision 24.0.3 and higher of the Android SDK Build Tools</a><br>apksigner工具在AndroidSDK 24.0.3的Build Tool才可用。<br>其他签名工具还有jarsigner和signapk。</p>
<h2 id="Deep"><a href="#Deep" class="headerlink" title="Deep"></a>Deep</h2><p>深入学习理解签包里的相关文件：<br>这里主要参考别人的学习理解<a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a><br>通过上文我们可以看出签名后验证APK的相关文件主要有以下三个文件：</p>
<ol>
<li>MANIFEST.MF</li>
<li>CERT.SF</li>
<li>CERT.RSA</li>
</ol>
<p>打开MANIFEST.MF(以下只复制了很少一部分做验证使用):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Created-By: <span class="number">1.0</span> (Android)</span><br><span class="line"></span><br><span class="line">Name: assets/bin/Data/Managed/System.Core.dll</span><br><span class="line">SHA1-Digest: cBOiG0b7uqe/+kFj8qkmBvP2/zw=</span><br><span class="line"></span><br><span class="line">Name: AndroidManifest.xml</span><br><span class="line">SHA1-Digest: JYiwTP2AVjbfgZVkMuuhe/bPrf0=</span><br></pre></td></tr></table></figure>
<p>可以看出MANIFEST.MF文件记录了APK里文件内容的SHA1-Digest(数字摘要)，这个数字摘要通过上面博主找到的源码来看是通过对文件内容做一次SHA1算法后然后通过Base64 Encode得到的。</p>
<p>下面我们直接通过HashTable和Base64网站验证一下(这里以AndroidManifest.xml为例)：<br><img src="/img/Android/AndroidManifestHashValue.PNG" alt="AndroidManifestHashValue"><br>因为我们使用的是SHA1数字摘要算法，所以这里用AndroidManifest.xml的SHA1值ECFB805F9645FB3CDB7B29DB4529B6FD7545261D进行反推。<br>通过Base64 Encode后：<br><img src="/img/Android/SHA1AfterBase64.PNG" alt="SHA1AfterBase64"><br>把Base64 Encode后的值和我们在MANIFEST.MF里AndroidManifest.xml的SHA1-Digest进行对比，就会发现是一致的。</p>
<p>这里不再对三个文件做深入研究，上面那位博主已经做了很清晰的解释，详情参见<a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a>。<br>这里只记录下三个文件之间的关系以及在APK简明里起的作用做个总结：</p>
<ol>
<li>MANIFEST.MF(对APK里的部分文件通过SHA1和Base64 Encode后记录下对应的数字摘要，<strong>用于验证APK文件的完整性</strong>)</li>
<li>CERT.SF(对MANIFEST.MF文件进行一次SHA1和Basee64 Encode进行记录，并针对MANIFEST.MF里每一块进行SHA1和Base64 Encode并记录，<strong>用于验证MANIFEST.MF的完整性</strong>)</li>
<li>CERT.RSA(这里会包含我们通过keystore生成的私钥计算出的签名以及公钥信息等数字证书信息，<strong>用于验证APK的唯一性也就是我们一直强调的签名来源</strong>)</li>
</ol>
<p>那么上面三个文件就能确保APK的唯一性和安全性了吗？<br>一下来自<a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a>的总结：<br>首先，如果你改变了apk包中的任何文件，那么在apk安装校验时，改变后的文件摘要信息与MANIFEST.MF的检验信息不同，于是验证失败，程序就不能成功安装。<br>其次，如果你对更改的过的文件相应的算出新的摘要值，然后更改MANIFEST.MF文件里面对应的属性值，那么必定与CERT.SF文件中算出的摘要值不一样，照样验证失败。<br>最后，如果你还不死心，继续计算MANIFEST.MF的摘要值，相应的更改CERT.SF里面的值，那么数字签名值必定与CERT.RSA文件中记录的不一样，还是失败。<br>那么能不能继续伪造数字签名呢？不可能，因为没有数字证书对应的私钥。<br>所以，如果要重新打包后的应用程序能再Android设备上安装，必须对其进行重签名。</p>
<p>从上面的分析可以得出，只要修改了Apk中的任何内容，就必须重新签名，不然会提示安装失败，当然这里不会分析，后面一篇文章会注重分析为何会提示安装失败。</p>
<p>从上面的总结可以看出，Keystore的Private Key是作为我们APK签名安全的最后一道防线，确保数字签名不会被伪造。</p>
<h1 id="Android-Stuido-and-Gradle"><a href="#Android-Stuido-and-Gradle" class="headerlink" title="Android Stuido and Gradle"></a>Android Stuido and Gradle</h1><p>在开始实战APK重签之前，这里需要先学习了解Android Studio和Gradle，这一步可以帮助我们把java代码打包成jar来使用。<br>详情参考<a href="http://tonytang1990.github.io/2016/12/11/Unity%E5%8E%9F%E7%94%9F&%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8F%92%E4%BB%B6/#Android_Studio">Android Studio</a></p>
<h1 id="APK重签实战"><a href="#APK重签实战" class="headerlink" title="APK重签实战"></a>APK重签实战</h1><p>通过上面的学习，我们知道了APK的重签需要经过一下步骤:</p>
<ol>
<li>反解APK</li>
<li>修改内容</li>
<li>重新打包APK</li>
<li>APK数据对齐</li>
<li>重新签名APK</li>
</ol>
<p>接下来我们以实现以下几个功能作为实战重签APK的学习目标:</p>
<ol>
<li>修改AndroidManifest.xml内容(通过修改versioncode打印检验)</li>
<li>替换APK里的资源(替换streamingasset路径下的一个文本文件内容并打印检验)</li>
<li>替换签名重签APK(通过apksigner验证apk重签后的签名)</li>
</ol>
<p>我将会结合前面提到的工具利用Python完成这一次自动化重签功能学习:<br>直接上学习代码:<br>resignAPK.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 指定文件包含非anscii字符</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os  </span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">## Decompile APK(反编译APK)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DecompileAPK</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DecompileAPK()&quot;</span>)</span><br><span class="line">    apttooldecompilecmd = <span class="string">&quot;&#123;&#125;/apktool.bat -f d &#123;&#125;.apk&quot;</span>.<span class="built_in">format</span>(apktoolDir, apkName)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------excute cmd :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(apttooldecompilecmd))</span><br><span class="line">    os.system(apttooldecompilecmd)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Modify AndroidManifest File(修改AndroidMainifest.xml)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ModifyAndroidManifest</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ModifyAndroidManifest()&quot;</span>)</span><br><span class="line">    lines = []</span><br><span class="line">    androidManifestFile = <span class="built_in">open</span>(decompileAndroidManifestPath, mode=<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> androidManifestFile:</span><br><span class="line">        line = ReplaceVersionCode(line, newVersionCode)</span><br><span class="line">        lines.append(line)</span><br><span class="line">    androidManifestFile.close()</span><br><span class="line"></span><br><span class="line">    androidManifestFile = <span class="built_in">open</span>(decompileAndroidManifestPath, mode=<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        androidManifestFile.write(line)</span><br><span class="line">    androidManifestFile.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">## Template Replace(模板替换AndroidManifest.xml里的值)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CheckTemplateReplace</span>(<span class="params">line, qct, npn</span>):</span><br><span class="line">    <span class="comment"># Python 2.X string.find</span></span><br><span class="line">    <span class="comment">#result = string.find(line, qct)</span></span><br><span class="line">    <span class="comment"># Python 3.X str.find</span></span><br><span class="line">    result = line.find(qct)</span><br><span class="line">    <span class="keyword">if</span> result != -<span class="number">1</span>:</span><br><span class="line">        line = line.replace(qct, npn)</span><br><span class="line">    <span class="keyword">return</span> line</span><br><span class="line"></span><br><span class="line"><span class="comment">## Modify Version Code Value(修改AndroidManifest.xml里的version code值)</span></span><br><span class="line"><span class="comment">## 实际使用过程发现apktool反解APK后AndroidManifest.xmnl里没有对应versioncode值</span></span><br><span class="line"><span class="comment">## 但以下代码如果存在versioncode=&quot;*&quot;的话是能够替换成功的</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ReplaceVersionCode</span>(<span class="params">line, newverioncode</span>):</span><br><span class="line">    <span class="comment"># Python 2.X string.find</span></span><br><span class="line">    <span class="comment">#result = string.find(line, versionCodeTemplate)</span></span><br><span class="line">    <span class="comment"># Python 3.X str.find</span></span><br><span class="line">    result = line.find(versionCodeTemplate)</span><br><span class="line">    <span class="keyword">if</span> result != -<span class="number">1</span>:</span><br><span class="line">        line = re.sub(<span class="string">&#x27;(versionCode=&quot;[0-9]*&quot;)&#x27;</span>, <span class="string">&quot;versioncode=\&quot;&#123;&#125;\&quot;&quot;</span>.<span class="built_in">format</span>(newverioncode), line, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> line</span><br><span class="line"></span><br><span class="line"><span class="comment">## Copy new resource to APK(复制新资源到包内)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CopyNewResourceToAPK</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;CopyNewResourceToAPK()&quot;</span>)</span><br><span class="line">    shutil.copy(newResourceName, <span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(replaceResourceDestinationPath))</span><br><span class="line"></span><br><span class="line"><span class="comment">## Recompile APK(重新打包APK)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RecompileAPK</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;RecompileAPK()&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------os.chdir(./&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(apkName))</span><br><span class="line"></span><br><span class="line">    os.chdir(<span class="string">&quot;./&#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkName))</span><br><span class="line"></span><br><span class="line">    retval = os.getcwd()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------Current working directory &#123;&#125;&quot;</span>.<span class="built_in">format</span>(retval))</span><br><span class="line"></span><br><span class="line">    apttoolrecompilecmd = <span class="string">&quot;&#123;&#125;/apktool.bat b -o ../&#123;&#125;.apk&quot;</span>.<span class="built_in">format</span>(apktoolDir, apkUnsignedUnaglinedName)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------excute cmd :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(apttoolrecompilecmd))</span><br><span class="line"></span><br><span class="line">    os.system(apttoolrecompilecmd)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------os.chdir(./..)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    os.chdir(<span class="string">&quot;./..&quot;</span>)</span><br><span class="line"></span><br><span class="line">    retval = os.getcwd()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Current working directory &#123;&#125;&quot;</span>.<span class="built_in">format</span>(retval))</span><br><span class="line"></span><br><span class="line"><span class="comment">## Aligned APK(APK 4K对齐)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">AlignedAPK</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;AlignedAPK()&quot;</span>)</span><br><span class="line"></span><br><span class="line">    zalignedcmd = <span class="string">&quot;&#123;&#125;\\build-tools\\24.0.3\\zipalign.exe -f 4 &#123;&#125;.apk &#123;&#125;.apk&quot;</span>.<span class="built_in">format</span>(androidSDKDir, apkUnsignedUnaglinedName, apkUnsignedAglinedName)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------zalignedcmd :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(zalignedcmd))</span><br><span class="line"></span><br><span class="line">    os.system(zalignedcmd)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Resigned APK(重签APK)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResignedAPK</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ResignedAPK()&quot;</span>)</span><br><span class="line"></span><br><span class="line">    resignedcmd = <span class="string">&quot;&#123;&#125;\\build-tools\\24.0.3\\apksigner.bat sign --ks &#123;&#125; --ks-pass pass:&#123;&#125; --out &#123;&#125;.apk &#123;&#125;.apk&quot;</span>.<span class="built_in">format</span>(androidSDKDir, keystoreFilename, keystorePassword, apkResignedName, apkUnsignedAglinedName)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------resignedcmd :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(resignedcmd))</span><br><span class="line"></span><br><span class="line">    os.system(resignedcmd)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Repackage process</span></span><br><span class="line"><span class="comment"># argparse解析参数输入，需要先定义一个ArgumentParser对象</span></span><br><span class="line"><span class="comment"># description - -h的时候显示在最前面的信息</span></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Study argparse module.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add_argument - 定义如何解析一个参数</span></span><br><span class="line"><span class="comment"># 第一个参数代表参数名</span></span><br><span class="line"><span class="comment"># type - 指定参数数据类型</span></span><br><span class="line"><span class="comment"># help - -h时解释该参数的用意</span></span><br><span class="line"><span class="comment"># dest - 表示该参数最终在parser.parse_args()返回对象里的名字</span></span><br><span class="line"><span class="comment"># default - 表示该参数的默认值</span></span><br><span class="line"><span class="comment"># required - 表示该参数是不是必须填的参数</span></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--APKName&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;APK名字&#x27;</span>, dest=<span class="string">&#x27;APKName&#x27;</span>,</span><br><span class="line">                    required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--VersionCode&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;新的VersionCode&#x27;</span>, dest=<span class="string">&#x27;NewVersionCode&#x27;</span>,</span><br><span class="line">                    required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--ResourceName&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;新资源名字&#x27;</span>, dest=<span class="string">&#x27;NewResourceName&#x27;</span>,</span><br><span class="line">                    default=<span class="string">&#x27;default.aba&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--ResourcePath&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;新资源包内目录&#x27;</span>, dest=<span class="string">&#x27;NewResourcePath&#x27;</span>,</span><br><span class="line">                    default=<span class="string">&#x27;./assets/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析输入的参数</span></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印参数的详细信息，通过访问parser.parse_args()的对象去访问</span></span><br><span class="line"><span class="built_in">print</span>(args)</span><br><span class="line">apkName = args.APKName</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;apkName : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(apkName))</span><br><span class="line">newVersionCode = args.NewVersionCode</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;newVersionCode : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(newVersionCode))</span><br><span class="line">newResourceName = args.NewResourceName</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;newResourceName : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(newResourceName))</span><br><span class="line">newResourcePath = args.NewResourcePath</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;newResourcePath : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(newResourcePath))</span><br><span class="line"></span><br><span class="line">currentFolder = os.getcwd()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;currentFolder : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(currentFolder))</span><br><span class="line"></span><br><span class="line">apktoolDir = currentFolder</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;apktoolDir : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(apktoolDir))</span><br><span class="line"></span><br><span class="line">androidSDKDir = os.getenv(<span class="string">&quot;AndroidSDK&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;androidSDKDir : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(androidSDKDir))</span><br><span class="line"><span class="keyword">if</span> androidSDKDir == <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;androidSDKDir == None,请配置ANdroidSDK环境变量路径&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">150</span>)</span><br><span class="line">    exit()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;androidSDKDir != None&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># version code替换原模板</span></span><br><span class="line">versionCodeTemplate = <span class="string">&quot;versionCode=&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;versionCodeTemplate = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(versionCodeTemplate))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要替换的资源目录</span></span><br><span class="line">replaceResourcePath = <span class="string">&quot;./&#123;&#125;/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkName, newResourcePath)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;replaceResourcePath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(replaceResourcePath))</span><br><span class="line"></span><br><span class="line">keystoreFilename = <span class="string">&quot;TonyTangNewKeyStore.jks&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;keystoreFilename = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(keystoreFilename))</span><br><span class="line"></span><br><span class="line">keystorePassword = <span class="string">&quot;th13568582998&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;keystorePassword = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(keystorePassword))</span><br><span class="line"></span><br><span class="line">decompileFolderPath = <span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkName)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;decompileFolderPath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(decompileFolderPath))</span><br><span class="line"></span><br><span class="line">decompileAndroidManifestPath = <span class="string">&quot;./&#123;&#125;/AndroidManifest.xml&quot;</span>.<span class="built_in">format</span>(decompileFolderPath)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;decompileAndroidManifestPath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(decompileAndroidManifestPath))</span><br><span class="line"></span><br><span class="line">replaceResourceDestinationPath = <span class="string">&quot;&#123;&#125;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(replaceResourcePath, newResourceName)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;replaceResourceDestinationPath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(replaceResourceDestinationPath))</span><br><span class="line"></span><br><span class="line">apkUnsignedUnaglinedName = <span class="string">&quot;&#123;&#125;_Unsinged_Unaligned&quot;</span>.<span class="built_in">format</span>(apkName)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;apkUnsignedUnaglinedName = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkUnsignedUnaglinedName))</span><br><span class="line"></span><br><span class="line">apkUnsignedAglinedName = <span class="string">&quot;&#123;&#125;_Unsigned_Aligned&quot;</span>.<span class="built_in">format</span>(apkName)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;apkUnsignedAglinedName = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkUnsignedAglinedName))</span><br><span class="line"></span><br><span class="line">apkResignedName = <span class="string">&quot;&#123;&#125;_Signed_Aligned&quot;</span>.<span class="built_in">format</span>(apkName)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;apkResignedName = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkResignedName))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;.apk resigned start&quot;</span>.<span class="built_in">format</span>(apkName))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反解APK</span></span><br><span class="line">DecompileAPK()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改AndroidMainifest.xml里面的内容</span></span><br><span class="line">ModifyAndroidManifest()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制资源到指定目录</span></span><br><span class="line">CopyNewResourceToAPK()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新打包APK</span></span><br><span class="line">RecompileAPK()</span><br><span class="line"></span><br><span class="line"><span class="comment"># APK数据对齐</span></span><br><span class="line">AlignedAPK()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新签名APK</span></span><br><span class="line">ResignedAPK()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂停不关闭命令行窗口(仅限Windows)</span></span><br><span class="line">os.system(<span class="string">&#x27;pause&#x27;</span>) </span><br></pre></td></tr></table></figure>
<p>上面的注释都比较详细了，就不再细说每一步了。<br>这里直接来看下运行这个resignAPK.py的环境要求以及目录结构：<br><img src="/img/Android/AndroidResignAPKFolderStructure.png" alt="AndroidResignAPKFolderStructure"><br>以下是使用argparse作为参数解析库的帮助查看:<br><img src="/img/Android/AndroidResignAPKArgParse.png" alt="AndroidResignAPKArgParse"><br>以下是正式使用重签resignAPK.py用法:<br><img src="/img/Android/AndroidResignAPKCommandsUsing.png" alt="AndroidResignAPKCommandsUsing"><br>最后输出了一个叫apkName_Signed_Aligned的APK使我们最终重签后的APK:<br><img src="/img/Android/AndroidResignFinalAPK.png" alt="AndroidResignFinalAPK"><br>ABTestFile.text文件是位于StreamingAsset目录下的一个文件，原文是test，我覆盖后内容是test2。<br>配合测试访问代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             ResourceManager.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ResourceManager.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 资源加载管理单例类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ResourceManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">ResourceManager</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> AB资源路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ABPath</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mABPath = Application.streamingAssetsPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 测试资源文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mTestResourceFileName = <span class="string">&quot;/ABTestFile.text&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载AB测试资源</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadABTestResource</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;loadABTestResource()&quot;</span>);</span><br><span class="line">        CoroutineManager.Singleton.startCoroutine(loadTestResourceCoroutine());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载临时资源携程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function">IEnumerator <span class="title">loadTestResourceCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;loadTestResourceCoroutine()&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> testresourcefullpath = mABPath + mTestResourceFileName;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_ANDROID &amp;&amp; !UNITY_EDITOR</span></span><br><span class="line">        UnityEngine.Networking.UnityWebRequest www = UnityEngine.Networking.UnityWebRequest.Get(testresourcefullpath);</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> www.SendWebRequest();</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;ABTestFile Content : &#123;0&#125;&quot;</span>, www.downloadHandler.text));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="keyword">var</span> testresource = System.IO.File.ReadAllText(testresourcefullpath);</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;ABTestFile Content : &#123;0&#125;&quot;</span>, testresource));</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Android/AndroidResignAndReplaceResourceDynamically.png" alt="AndroidResignAndReplaceResourceDynamically"><br>至此我们成功完成了通过python编写了自动化重签APK，动态替换APK部分资源，动态修改AndroidManifest.xml内容的功能。</p>
<h1 id="Unity实战"><a href="#Unity实战" class="headerlink" title="Unity实战"></a>Unity实战</h1><p>待续……</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/6/docs/technotes/tools/windows/keytool.html">keytool</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/command-line/zipalign.html">zipalign</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/command-line/apksigner.html#usage">apksigner</a><br><a target="_blank" rel="noopener" href="https://ibotpeaches.github.io/Apktool/documentation/#decoding">Apktool</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/intro/">Android Studio</a><br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/userguide.html">Gradle</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Gradle">Gradle Wiki</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/30432152">如何通俗地理解 Gradle？</a><br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/tutorial_using_tasks.html">Build Script Basics</a><br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/more_about_tasks.html">Authoring Tasks</a></p>
<h2 id="Knowledge-Part"><a href="#Knowledge-Part" class="headerlink" title="Knowledge Part"></a>Knowledge Part</h2><p><a target="_blank" rel="noopener" href="https://developer.android.com/studio/publish/app-signing.html">Sign Your App</a><br><a target="_blank" rel="noopener" href="https://kknews.cc/tech/yxlvj.html">Android APK签名原理及方法</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a><br><a target="_blank" rel="noopener" href="http://andrewlcgu.github.io/2016/04/17/apk-sign-theroy/">APK签名原理解析</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v7t7.html">JNI和NDK交叉编译进阶学习</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102vazu.html">NDK&amp;JNI&amp;Java&amp;Android初步学习总结归纳</a><br><a target="_blank" rel="noopener" href="http://google.github.io/android-gradle-dsl/current/index.html">Android DSL Android Plugin DSL Reference</a><br><a target="_blank" rel="noopener" href="https://guides.gradle.org/building-android-apps/?_ga=2.32380022.931589262.1533988091-1402562034.1533988091">Gradle - Building Android Apps</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a target="_blank" rel="noopener" href="http://implbits.com/products/hashtab/">HashTable</a><br><a target="_blank" rel="noopener" href="http://tomeko.net/online_tools/hex_to_base64.php?lang=en">Base64Website</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Native/">Native</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/06/12/Python使用/" title="Python使用" itemprop="url">Python使用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-06-12T14:45:55.000Z" itemprop="datePublished"> 发表于 2017-06-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Python-Study"><a href="#Python-Study" class="headerlink" title="Python Study"></a>Python Study</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h3 id="When"><a href="#When" class="headerlink" title="When"></a>When</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Python_(programming_language)">Python is a widely used high-level programming language for general-purpose programming, created by Guido van Rossum and first released in 1991.</a><br>Python第一版发布于1991年，由<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Guido_van_Rossum">Guido van Rossum</a>编写。</p>
<h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Python_(programming_language)">An interpreted language, Python has a design philosophy which emphasizes code readability (notably using whitespace indentation to delimit code blocks rather than curly brackets or keywords), and a syntax which allows programmers to express concepts in fewer lines of code than possible in languages such as C++ or Java.[22][23] The language provides constructs intended to enable writing clear programs on both a small and large scale.</a><br>首先我们要知道Python跟Lua一样，是解释型语言(不需要编译，通过解析执行，有自己的解析器)。Python设计理念强调可读性(通过缩进而非{}来表示代码块)。</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Python_(programming_language)">Python features a dynamic type system and automatic memory management and supports multiple programming paradigms, including object-oriented, imperative, functional programming, and procedural styles.</a><br>Python是动态类型语言，同时有自己的内存管理机制，支持多种编程范式(待深入学习了解)。</p>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p>了解了Python When &amp; What。那么我们Why什么要选择学习使用Python了？<br><a target="_blank" rel="noopener" href="https://www.python.org/about/">Python is powerful… and fast; plays well with others; runs everywhere; is friendly &amp; easy to learn; is Open. </a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Python_(programming_language)">supports multiple programming paradigms. It has a large and comprehensive standard library.[25]</a><br>把上面可以归纳如下:</p>
<ol>
<li>Run everywhere(跨平台)</li>
<li>Friendly &amp; easy to learn(学习更友好更容易(对于无编程经验的人更加友好，语法更nature))</li>
<li>Supports multiple programming paradigms(支持多种编程范式)</li>
<li>Large and comprehensive standard library(丰富的标准库和Package)</li>
</ol>
<p>Note:<br>这里提一句Python里很有名的一句话:<br>“Life is short, you need python.”</p>
<h2 id="IDE-Editor"><a href="#IDE-Editor" class="headerlink" title="IDE &amp; Editor"></a>IDE &amp; Editor</h2><p>学习任何一门编程语言，好的IDE或者Editor都能帮助我们更加快速的学习。<br>因为初学Python且Python是解析执行，这里暂时不考虑过于强大的IDE。<br>IDE详情选择可以参考<a target="_blank" rel="noopener" href="https://wiki.python.org/moin/IntegratedDevelopmentEnvironments">Python IDE</a><br>这里通过使用Sublime Text 3以及其Python相关的扩展插件作为学习Python的Editor。<br><a href="http://tonytang1990.github.io/2017/02/17/Editor-Sublime-Text-3/#Usefule_Commands">Sublime Text 3 Python相关插件设置详情</a></p>
<h2 id="Python-Version-Choosen"><a href="#Python-Version-Choosen" class="headerlink" title="Python Version Choosen"></a>Python Version Choosen</h2><p>Python有一个比较重要版本分割线2.x &amp; 3.x。<br>详情参见<a target="_blank" rel="noopener" href="https://wiki.python.org/moin/Python2orPython3">Python2orPython3</a><br>这里就不深入去了解2.x和3.x之间的区别了。<br>简单的理解就是3.x提供了更多更全的功能支持，同时有更多的丰富的库支持。如果作为初学者，并不需要维护老版本(2.x)的工具代码时，完全可以从3.x学起。</p>
<h2 id="Useful-Package"><a href="#Useful-Package" class="headerlink" title="Useful Package"></a>Useful Package</h2><h3 id="Pip"><a href="#Pip" class="headerlink" title="Pip"></a>Pip</h3><p>Python有丰富的标准库。而其中最重要也是新手第一时间就应该安装的就是Pip。<br>Pip对于Python就好比Package Control好比Sublime Text 3。<br>Pip(Python Package Index)是一个Python Package集中管理安装的扩展包。<br><a target="_blank" rel="noopener" href="https://pip.pypa.io/en/stable/installing/">Pip安装详情参考官方文档</a><br>Pip安装成功后我们就可以通过Pip去查看或安装丰富的Python Package了。<br>Package Install:<br><img src="/img/Python/PipPackageInstallation.PNG" alt="PipPackageInstallation"><br>Show Intalled Packages:<br><img src="/img/Python/PipListInstalledPackages.PNG" alt="PipListInstalledPackages"><br>安装之后的Package可以在安装目录查看到:<br><img src="/img/Python/PythonPackageLocation.PNG" alt="PythonPackageLocation"><br><a target="_blank" rel="noopener" href="https://pip.pypa.io/en/stable/user_guide/#installing-packages">更多关于Pip使用查看官方文档</a></p>
<h3 id="argparse"><a href="#argparse" class="headerlink" title="argparse"></a>argparse</h3><p>详细的介绍会在后面Tip的Command Line Args篇章</p>
<h2 id="Tutorial-基础篇"><a href="#Tutorial-基础篇" class="headerlink" title="Tutorial(基础篇)"></a>Tutorial(基础篇)</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><h4 id="Keywords-and-Identifier"><a href="#Keywords-and-Identifier" class="headerlink" title="Keywords and Identifier"></a>Keywords and Identifier</h4><p>Identifier(标识.e.g funcname, variable ……)定义规则:</p>
<ol>
<li>Keywords不能用做变量声明(这应该是任何语言都通用的规范了吧)</li>
<li>变量名不能以数字开头</li>
<li>变量名不能用特殊符号(e.g. !, @, #, $, %)<br>简单了解下Python的关键词：<br><img src="/img/Python/PythonKeywords.PNG" alt="PythonKeywords"></li>
</ol>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/keywords-identifier">Python is a case-sensitive language. This means, Variable and variable are not the same. Always name identifiers that make sense.</a><br>Python是大小写敏感的，大小写不同的变量名是不同变量。</p>
<h4 id="Statements-Comments"><a href="#Statements-Comments" class="headerlink" title="Statements &amp; Comments"></a>Statements &amp; Comments</h4><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/statement-indentation-comments">Instructions that a Python interpreter can execute are called statements.</a><br>Python可解析执行的语句叫做Statements。<br>多行Statements可以通过\或者[]或者{}或者()链接或封装：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> + <span class="number">2</span> + \</span><br><span class="line">    <span class="number">3</span> + <span class="number">4</span> + \</span><br><span class="line">    <span class="number">5</span> + <span class="number">6</span></span><br><span class="line"></span><br><span class="line">b = (<span class="number">1</span> + <span class="number">2</span> + <span class="number">3</span> + <span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>Python设计理念强调可读性(通过缩进而非{}来表示代码块)：<br>同时Python注释是通过# or ‘’’ or “””:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">if</span> i &gt;= <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;0&#125; &gt;= 5&quot;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># No break happends in for loop</span></span><br><span class="line">    <span class="comment"># Then execute this block</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No number is equal or greater than 5!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Docstring(Docstring is short for documentation string):<br>可以看出Docstring是一段文档描述(好比在C#里通过&#x2F;&#x2F;&#x2F;编写描述信息一样)。Python在书写格式上要求比较严，虽然不会导致报错，但会算作不是规范的写法，这也就是我们为什么会去安装Sublime Text 3 flake8这样的linter插件了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">addition</span>(<span class="params">par1, par2</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;This funtion is used to get result of (a + b).&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> par1 + par2</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(addition(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(addition.__doc__)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/DocString.PNG" alt="DocString"><br>可以看到我们定义了一个加法函数，并编写了docstring。<br>通过func_name.__doc__我们可以得到那段描述</p>
<h4 id="Python-I-O-and-Import"><a href="#Python-I-O-and-Import" class="headerlink" title="Python I&#x2F;O and Import"></a>Python I&#x2F;O and Import</h4><p>Python里的输入输出交互(好比C++里的cin,cout)是通过input和print。<br>因为需要交互所以需要在可执行Python代码的terminal里执行python脚本:<br><img src="/img/Python/PythonInputAndOutput.PNG" alt="PythonInputAndOutput"></p>
<p>因为Python的import是指import Module，我们需要知道Python里Module的定义，<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/modules">Modules refer to a file containing Python statements and definitions.</a><br>Modules在Python里是指一个文件所包含的所有定义和声明(以文件为单位划分，文件名即为import的名字)。</p>
<p>在import Module还有一个重要的点就是，我们需要知道Python查找所有*.py的搜索路径(跟环境变量有点像):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys.path:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(sys.path))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/ImoprtSearchPath.PNG" alt="ImoprtSearchPath"></p>
<p>我们可以指定只导入特定定义(e.g. from math import pi)</p>
<p>Note:<br>Python的Module和C#的namespace概念不一样，前者是以文件为单位，后者是以命名空间划分(支持在多个文件里定义在同一命名空间下)</p>
<h4 id="Python-Operators"><a href="#Python-Operators" class="headerlink" title="Python Operators"></a>Python Operators</h4><p>运算符跟大多数编程差不多，这里只讲几个比较特殊的:<br>Logical Operators:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="literal">True</span></span><br><span class="line">y = <span class="literal">False</span></span><br><span class="line"><span class="built_in">print</span>(x <span class="keyword">and</span> y)</span><br><span class="line"><span class="built_in">print</span>(x <span class="keyword">or</span> y)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonLogicalOperator.PNG" alt="PythonLogicalOperator"><br>或许跟Python提倡简洁明了有关，可以直接采用and or not之类的逻辑运算符</p>
<p>Identity operators：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">x1 = <span class="number">1</span></span><br><span class="line">y1 = <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;x1 is y1 = &quot;</span>, x1 <span class="keyword">is</span> y1)</span><br><span class="line">y1 = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;After y1 = 2. x1 is y1 = &quot;</span>, x1 <span class="keyword">is</span> y1)</span><br><span class="line"></span><br><span class="line">list1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">list2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;list1 is list2 = &quot;</span>, list1 <span class="keyword">is</span> list2)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonIdentityOperator.PNG" alt="PythonIdentityOperator"></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/operators">is and is not are used to check if two values (or variables) are located on the same part of the memory.</a><br><strong>List可以理解成分配了不同的内存去存储实际成员值所以是不同identity，上面x1 &#x3D; 1和y1 &#x3D; 1是located on the same part of the memory就需要理解后续会讲到的[Namespaces概念](<a href="http://tonytang1990.github.io/2017/06/12/Python-Study/#Object">http://tonytang1990.github.io/2017/06/12/Python-Study/#Object</a> &amp; Class)</strong></p>
<p>Membership operators:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">list3 = [<span class="number">1</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;H&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;T&#x27;</span> <span class="keyword">in</span> list3)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span> <span class="keyword">not</span> <span class="keyword">in</span> list3)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonMemberOperator.PNG" alt="PythonMemberOperator"></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/operators">in &amp; not in are used to test whether a value or variable is found in a sequence (string, list, tuple, set and dictionary).</a><br>in &amp; not in 主要是用于判断特定变量或者值是否存在于特定sequence里。</p>
<h3 id="Flow-Control"><a href="#Flow-Control" class="headerlink" title="Flow Control"></a>Flow Control</h3><p>if,elif,else,while,for这里主要记录一些Python相对于C++,C#,Java这些语言里的一些区别。</p>
<p>Python里是以:结束条件语句，以缩进表示层级。<br>while和for有一点比较特殊，支持else语句(没有break语句执行时)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">if</span> i &gt;= <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;0&#125; &gt;= 5&quot;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># No break happends in for loop</span></span><br><span class="line">    <span class="comment"># Then execute this block</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No number is equal or greater than 5!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/FlowControlForUsing.PNG" alt="FlowControlForUsing"></p>
<h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><p>Python的Function定义关键词是def，格式如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func_name</span>(<span class="params">paras</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Docstring&quot;&quot;&quot;</span></span><br><span class="line">    Statements</span><br></pre></td></tr></table></figure>

<p>Python支持显示传递参数，也支持默认参数和不限数量参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># User-defined functions</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_python_function</span>(<span class="params">para1, dp1=<span class="string">&quot;dp1&quot;</span>, dp2=<span class="string">&quot;dp2&quot;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;My Python Function Docstring.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Build-in functions</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;my_python_function(para1:&#123;0&#125; dp1:&#123;1&#125; dp2:&#123;2&#125;)&quot;</span>.<span class="built_in">format</span>(para1, dp1, dp2))</span><br><span class="line"></span><br><span class="line">my_python_function(<span class="string">&quot;Tony&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Keyword para call</span></span><br><span class="line">my_python_function(dp1=<span class="string">&quot;ndp1&quot;</span>, para1=<span class="string">&quot;Tang&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Parameters without length limited</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arbitrary_para_function</span>(<span class="params">*paras</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Python function without length of parameter limitation.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> para <span class="keyword">in</span> paras:</span><br><span class="line">        <span class="built_in">print</span>(para)</span><br><span class="line"></span><br><span class="line">arbitrary_para_function(<span class="string">&quot;para1&quot;</span>, <span class="string">&quot;para2&quot;</span>, <span class="string">&quot;para3&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonFunctionDefinition.PNG" alt="PythonFunctionDefinition"></p>
<p>Python也支持匿名函数(Lambda Function),只是不像C++，C#使用(x)&#x3D;&gt;表示而是lambda x:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqrfunc = <span class="keyword">lambda</span> x: x * <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(sqrfunc(<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonAnonymousFunction.PNG" alt="PythonAnonymousFunction"></p>
<h4 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h4><p>C,C++里有#include。C#有using。Java有import。Python里有Modules。<br>但Python里的Modules更像C,C++是针对文件为单位。<br>使用的时候通过import filename即可(也支持指定别名 as newname)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_first_python_func</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;MyFirstPython.py&#x27;s function.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;my_first_python_func() called&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> MyFirstPython <span class="keyword">as</span> MFP</span><br><span class="line"></span><br><span class="line">MFP.my_first_python_func()</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonModuleImportAndUsing.PNG" alt="PythonModuleImportAndUsing"></p>
<p>知道了Python是以文件为单位导入的，那么我们也需要知道Python导入文件时的搜索路径(通过打印sys.path即可)</p>
<p>Note:<br>Python也支持只导入指定文件里的指定对象<br>e.g.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> pi</span><br></pre></td></tr></table></figure>

<h4 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h4><p>C++，C#里有namespace。Java有package。Python里有Package(相当于Java里package和C#里namespace概念，负责抽象对应Directory到指定Package里)<br>Steps:</p>
<ol>
<li>创建文件夹(文件夹名作为Package Name)</li>
<li>文件夹目录下创建一个__init__.py文件(默认可以不写任何内容)</li>
<li>通过import PackageName.Module引入特定文件<br>e.g.</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> MyPackage.MyFirstPython</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonPackageUsing.PNG" alt="PythonPackageUsing"></p>
<p>Note:<br>Package是针对Directory而言，Module是针对file而言</p>
<h3 id="Datatypes"><a href="#Datatypes" class="headerlink" title="Datatypes"></a>Datatypes</h3><p>Variable变量赋值在Python里简单明了:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p1 = <span class="number">1</span></span><br><span class="line">p2, p3, p4 = <span class="number">2</span>, <span class="number">3</span>, <span class="string">&quot;Tony&quot;</span></span><br><span class="line"><span class="built_in">print</span>(p1, p2, p3, p4)</span><br></pre></td></tr></table></figure>

<p>判断数据类型Python是通过type()这个类似C#GetType()。<br>判断是否是某个类型实例Python是通过isinstance()，类似于Python里的is关键词。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;My first class.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    name</span><br><span class="line"></span><br><span class="line">myclassinstance = MyClass()</span><br><span class="line">myclassinstance.name = <span class="string">&quot;Tony&quot;</span></span><br><span class="line">mystring = <span class="string">&quot;Tony&quot;</span></span><br><span class="line"><span class="built_in">print</span>(myclassinstance, <span class="string">&quot; is typeof &quot;</span>, <span class="built_in">type</span>(myclassinstance))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;myclassinstance is typeof MyClass:&quot;</span>, <span class="built_in">isinstance</span>(myclassinstance, MyClass))</span><br><span class="line"><span class="built_in">print</span>(mystring, <span class="string">&quot; is typeof &quot;</span>, <span class="built_in">type</span>(mystring))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/DataTypeCheck.PNG" alt="DataTypeCheck"><br>可以看出在Python是弱语言类型，声明变量是无需显示指定变量类型。<br>同时通过type和isinstance可以判断实例对象类型。</p>
<p>Note:<br>这里的Data Type是指实例对象的类型，Python是弱类型语言。</p>
<h4 id="Basic-Data-Types"><a href="#Basic-Data-Types" class="headerlink" title="Basic Data Types"></a>Basic Data Types</h4><p>Python支持大部分基本数据类型，e.g. int, float等。<br>有一点比较特殊的是Python支持complex numbers(复数)：x + yj(x为实部，yj为虚部)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cn = <span class="number">2</span> + <span class="number">3j</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;cn = &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(cn))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/ComplexNumber.PNG" alt="ComplexNumber"><br>同时表示不同进制的Number只需添加不同前缀即可：<br><img src="/img/Python/NumberSystem.PNG" alt="NumberSystem"></p>
<h5 id="List"><a href="#List" class="headerlink" title="List"></a>List</h5><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">List is an ordered sequence of items. It is one of the most used datatype in Python and is very flexible. All the items in a list do not need to be of the same type.</a><br>Python的List好比数组，但是更灵活，可存储不同类型的对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pythonList = [<span class="number">1</span>, <span class="string">&quot;a&quot;</span>, <span class="number">3.0</span>, <span class="literal">True</span>]</span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> pythonList:</span><br><span class="line">    <span class="built_in">print</span>(member, <span class="string">&quot; is typof &quot;</span>, <span class="built_in">type</span>(member))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonList.PNG" alt="PythonList"></p>
<p>更多的List处理参见List.Method和其他Build-in Functions(比如len(),sorted()等)</p>
<p>Note：<br>List是通过[]定义。</p>
<h5 id="Tuple"><a href="#Tuple" class="headerlink" title="Tuple"></a>Tuple</h5><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">Tuple is an ordered sequence of items same as list.The only difference is that tuples are immutable. Tuples once created cannot be modified.</a><br>Tuple和List的唯一区别就是创建后不可再被改变，但如果内嵌可变的(e.g. List)那么List的数据是可以被改变的。Tuple是通过()定义内容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">my_tuple = (<span class="number">1</span>, <span class="string">&quot;string&quot;</span>, [<span class="number">1</span>, <span class="string">&quot;th&quot;</span>])</span><br><span class="line">my_tuple[<span class="number">2</span>][<span class="number">0</span>] = <span class="number">2</span></span><br><span class="line"><span class="keyword">for</span> tuplemember <span class="keyword">in</span> my_tuple:</span><br><span class="line">    <span class="built_in">print</span>(tuplemember)</span><br><span class="line"><span class="keyword">del</span> my_tuple</span><br><span class="line"><span class="comment"># my_tuple -- Error: name &#x27;my_tuple&#x27; is not defined</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/TupleUsing.PNG" alt="TupleUsing"><br>从上面可以看出del关键词可以删除变量的引用。</p>
<p>Note：<br>Tuple是通过()定义。<br>Tuple相比List更适合用于存储固定的不同数据类型的数据。<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/keyword-list#del">Everything is object in Python.</a>(这一点跟Java，C#一样)</p>
<h5 id="Strings"><a href="#Strings" class="headerlink" title="Strings"></a>Strings</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mypythonstring = <span class="string">&quot;我的名字是TonyTang&quot;</span></span><br><span class="line"><span class="built_in">print</span>(mypythonstring)</span><br><span class="line"><span class="built_in">print</span>(mypythonstring[<span class="number">0</span>])</span><br><span class="line">mypythonstring[<span class="number">0</span>] = <span class="string">&#x27;你&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonStrings.PNG" alt="PythonStrings"></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">String is sequence of Unicode characters. Strings are immutable</a><br>Python里是采用Unicode编码存储字符串。Strings可以通过[]访问，但是不可被改变的。<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/string">We cannot delete or remove characters from a string. But deleting the string entirely is possible using the keyword del.</a>因为string是immutable的，所以我们不能通过del删除string里面的个别character，但是我们可以删除对string的整个引用。</p>
<h5 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h5><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">Set is an unordered collection of unique items. Set is defined by values separated by comma inside braces { }. Items in a set are not ordered.</a><br>Set也是一系列数据的集合类型，但是是无序的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mySet1 = &#123;<span class="number">1</span>, <span class="string">&quot;a&quot;</span>, <span class="number">2</span>, <span class="string">&quot;b&quot;</span>, <span class="number">1</span>&#125;</span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> mySet1:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;member in mySet1:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(member))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonSet.PNG" alt="PythonSet"><br>可以看出因为Set是无序的，连循环遍历出来的结果也是不确定的。所以针对Set，[]访问就是无意义也是不被允许的。</p>
<p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/set">Every element is unique (no duplicates) and must be immutable (which cannot be changed).</a><br>Set还有一点特性就是成员是唯一且不可变的同时支持类似于集合与或等操作:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mySet2 = &#123;<span class="string">&quot;a&quot;</span>, <span class="number">2</span>, <span class="string">&quot;b&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> (mySet1 &amp; mySet2):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;member in (mySet1 &amp; mySet2):&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(member))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> (mySet1 - mySet2):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;member in (mySet1 - mySet2):&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(member))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/SetStudy.PNG" alt="SetStudy"></p>
<p>Note：<br>Set是通过{}定义。<br>更多操作参考Set.API</p>
<h5 id="Dictionary"><a href="#Dictionary" class="headerlink" title="Dictionary"></a>Dictionary</h5><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">Dictionary is an unordered collection of key-value pairs.</a><br>Python里的Dictionary跟C#里的Dictionary差不多，代表无序的Key-Value主键值对。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myDictionary = &#123;<span class="number">1</span>: <span class="string">&quot;Tony&quot;</span>, <span class="string">&quot;Tang&quot;</span>: <span class="number">2</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(myDictionary[<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(myDictionary[<span class="string">&quot;Tang&quot;</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonDictionary.PNG" alt="PythonDictionary"><br>可以看出Python里Dictionary的键值对定义时通过:分割，然后通过[]去方案对应Key得到Value值。</p>
<p>Note：<br>Dictionary是通过{}定义。<br>更多操作参考Dictionary.API</p>
<h4 id="Conversion-between-data-types"><a href="#Conversion-between-data-types" class="headerlink" title="Conversion between data types"></a>Conversion between data types</h4><p>基础数据类型转换通过int,float,complex显示转换即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">myint = <span class="built_in">int</span>(<span class="number">2.5</span>)</span><br><span class="line"><span class="built_in">print</span>(myint)</span><br><span class="line">mylist = <span class="built_in">list</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> mylist:</span><br><span class="line">    <span class="built_in">print</span>(member)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonDataConversion.PNG" alt="PythonDataConversion"></p>
<h3 id="Files"><a href="#Files" class="headerlink" title="Files"></a>Files</h3><h4 id="File-Operation"><a href="#File-Operation" class="headerlink" title="File Operation"></a>File Operation</h4><p>首先看看最新官方文档给出的API说明:<br><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/functions.html#open">open(file, mode&#x3D;’r’, buffering&#x3D;-1, encoding&#x3D;None, errors&#x3D;None, newline&#x3D;None, closefd&#x3D;True, opener&#x3D;None)</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># try: finally: Make sure f close successfully</span></span><br><span class="line"><span class="comment"># specify encoding=&#x27;utf-8&#x27; is used to avoid platform dependent problems</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;./FilesFolder/TonyTangFile.txt&quot;</span>, mode=<span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        <span class="built_in">print</span>(line)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Another way to make sure file close successfully</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./FilesFolder/TonyTangFile.txt&quot;</span>, mode=<span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># Do file operation here</span></span><br><span class="line">    f.write(<span class="string">&quot;Flow my heart!\nI have a dream!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonFileOperation.PNG" alt="PythonFileOperation"><br>从上面可以看到，open的几个关键参数，mode决定了可读还是可写等模式，encoding决定编码格式是为了确保不同平台脚本的一致性。</p>
<h4 id="Directory"><a href="#Directory" class="headerlink" title="Directory"></a>Directory</h4><p>Python提供了<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/os.html">os module</a>支持很多文件夹目录操作的API</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(os.getcwd())</span><br><span class="line"><span class="built_in">print</span>(os.listdir())</span><br><span class="line">os.chdir(<span class="string">&quot;./FilesFolder&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(os.getcwd())</span><br><span class="line"><span class="keyword">if</span> os.path.exists(<span class="string">&quot;MyNewFilesFolder&quot;</span>) == <span class="literal">False</span>:</span><br><span class="line">    os.mkdir(<span class="string">&quot;MyNewFilesFolder&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(os.listdir())</span><br><span class="line"><span class="keyword">if</span> os.path.exists(<span class="string">&quot;MyRenameFilesFolder&quot;</span>) == <span class="literal">True</span>:</span><br><span class="line">    os.removedirs(<span class="string">&quot;MyRenameFilesFolder&quot;</span>)</span><br><span class="line">os.rename(<span class="string">&#x27;MyNewFilesFolder&#x27;</span>, <span class="string">&#x27;MyRenameFilesFolder&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(os.listdir())</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonDirectory.PNG" alt="PythonDirectory"><br>从上面可以看出Python的API都很简洁明了，跟bat，shell很像，具体使用过程中主要还是按需求差文档写自己的自动化即可。</p>
<h4 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h4><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/exceptions">Python Exception</a><br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/exception-handling">Exception Handling</a><br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/user-defined-exception">User-defined Exception</a></p>
<h3 id="Object-Class"><a href="#Object-Class" class="headerlink" title="Object &amp; Class"></a>Object &amp; Class</h3><h4 id="Name"><a href="#Name" class="headerlink" title="Name"></a>Name</h4><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/namespace">Name (also called identifier) is simply a name given to objects.</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(2) = &#x27;</span>, <span class="built_in">id</span>(<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(a) = &#x27;</span>, <span class="built_in">id</span>(a))</span><br><span class="line"></span><br><span class="line">a = a + <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(a) = &#x27;</span>, <span class="built_in">id</span>(a))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(3) = &#x27;</span>, <span class="built_in">id</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(2) = &#x27;</span>, <span class="built_in">id</span>(<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(b) = &#x27;</span>, <span class="built_in">id</span>(b))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonNameOutput.PNG" alt="PythonNamespaceOutput"><br>id()适用于打印object地址，从上面的输出可以看到只要Name指向Object的值是一致的，那么他们所指向的地址就是一致的。详情参考下图:<br><img src="/img/Python/PythonName.PNG" alt="PythonName"><br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/namespace">This is efficient as Python doesn’t have to create a new duplicate object. This dynamic nature of name binding makes Python powerful; a name could refer to any type of object.</a></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/namespace">Everything in Python is an object.</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> this</span><br></pre></td></tr></table></figure>

<p>上面这段代码很有意思，会在控制台打印出Python的编程哲学:<br><img src="/img/Python/TheZenOfPython.PNG" alt="TheZenOfPython"></p>
<h4 id="Namepsace-Scope"><a href="#Namepsace-Scope" class="headerlink" title="Namepsace &amp; Scope"></a>Namepsace &amp; Scope</h4><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/namespace">namespace is a collection of names.</a>(前面讲解了什么是Name，接下来要理解的Namespace就好比一系列Name的集合)<br>我们平时用到的Build-in Functions就属于Build-in Namespace里。<br>让我们结合下图看看Python里Namespace的层级：<br><img src="/img/Python/PythonNamespaceHierarchical.PNG" alt="PythonNamespaceHierarchical"></p>
<p>讲完Namespace，Python里还有一点跟Namespace密切相关的Scope:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/namespace">Scope is the portion of the program from where a namespace can be accessed directly without any prefix.</a>(Namespace在Python就好比C++,C#里的namespace。Scope就好比C++,C#里变量的有效区域。)</p>
<p>现阶段主要分为3中Scope:</p>
<ol>
<li>Scope of the current function which has local names(当前function scope)</li>
<li>Scope of the module which has global names(全局scope)</li>
<li>Outermost scope which has build-in names(最外层Build-in scope)</li>
</ol>
<p>接下来透过实例学习理解Python里的Scope:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">outer_function</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Outer Function.&quot;&quot;&quot;</span></span><br><span class="line">    a = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner_function</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Inner Function.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">global</span> a</span><br><span class="line">        a = <span class="number">30</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;a = &quot;</span>, a)</span><br><span class="line"></span><br><span class="line">    inner_function()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;a = &quot;</span>, a)</span><br><span class="line"></span><br><span class="line">a = <span class="number">10</span></span><br><span class="line">outer_function()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a = &quot;</span>, a)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonScope.PNG" alt="PythonScope"><br>可以看出在Function内的定义因为在不同的Scope不会覆盖Global Scope的a定义。当我们显示指定Function Scope里的a为global的a时，我们可以在Function Scope内引用到Global的a。</p>
<h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h4><p>接触过面向对象编程的人应该对Class都不陌生，他是我们抽象对象定义的关键类型。<br>在面向对象编程语言的Python里Class也起着同样的作用，只不过定义的方式有所区别，详情如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyFirstClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;docstring for MyClass&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Class Constructor.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>(MyFirstClass, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.name = arg</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sayhi</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Class Member Function.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">printname</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Print name member.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;self.name = &quot;</span>, <span class="variable language_">self</span>.name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里因为我是定义在MyFirstPython.py文件里的，所以导入的是MyFirstPython</span></span><br><span class="line"><span class="keyword">import</span> MyFirstPython</span><br><span class="line">mfp = MyFirstPython.MyFirstClass(<span class="string">&quot;Tony&quot;</span>)</span><br><span class="line">mfp.sayhi()</span><br><span class="line">mfp.printname()</span><br><span class="line"><span class="built_in">print</span>(mfp.name)</span><br><span class="line">mfp.age = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(mfp.age)</span><br><span class="line"><span class="keyword">del</span> mfp.name</span><br><span class="line"><span class="comment"># mfp.printname() AttributeError: &#x27;MyFirstClass&#x27; object has no attribute &#x27;name&#x27;</span></span><br><span class="line"><span class="keyword">del</span> mfp</span><br><span class="line"><span class="comment"># mfp.sayhi() NameError: name &#x27;mfp&#x27; is not defined</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonClassDefinition.PNG" alt="PythonClassDefinition"><br>从上面可以看出Python里Class的定义格式如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">classname</span>(<span class="params">父类</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Docstring Class description.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Docstring Constructor description.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># constructor&#x27;s body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">functionname</span>(<span class="params">arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;DocString Member Function description.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># body</span></span><br></pre></td></tr></table></figure>

<p>__init__就好比C++里的构造函数。<br>Python里的继承写法:classname()括号里面跟的是父类，在子类可以通过super去访问父类。<br>值得一提的是Docstring，每一个类或者方法都有Docstring，我们可以通过classname.__doc__的方式去访问。<br>同时我们看到Python里还可以在运行时动态定义成员变量(e.g. mfp.age)<br>Python里不是通过new关键词去实例化类对象，但del关键词就好比C++里和new配对的delete，但这里的delete不仅是针对new出来的实例化对象进行回收，还能针对特定实例化成员进行删除。(当我们del mfp实例对象时，我们只是把mfp的对于Object的引用从corresponding namespace里移除而非真的销毁内存里Object。真正的销毁是发生在没有人在绑定到该Object时。)</p>
<p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/class">This automatic destruction of unreferenced objects in Python is also called garbage collection.</a>(真正的销毁就好比C++里的GC对内存进行释放)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/class">Python is an object oriented programming language.</a></p>
<h4 id="Inheritance"><a href="#Inheritance" class="headerlink" title="Inheritance"></a>Inheritance</h4><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/multiple-inheritance">Like C++, a class can be derived from more than one base classes in Python. This is called multiple inheritance.</a></p>
<p>关于继承这里就不多讲了，大家参考文档介绍。</p>
<h4 id="Operator-Overloading"><a href="#Operator-Overloading" class="headerlink" title="Operator Overloading"></a>Operator Overloading</h4><p>Operator Overloading翻译过来应该是运算符重载。</p>
<p>在了解Operator Overloading之前，让我们来了解下Python Class里的一些特殊方法。</p>
<p>这里的特殊方法学过lua的同学应该会感到很亲切:</p>
<ol>
<li><strong>new</strong> – New一个Class的实例对象时会被调用</li>
<li><strong>init</strong> – Class的构造函数(父类构造函数需要手动调用，默认不递归调用)</li>
<li><strong>del</strong> – Class实例对象销毁时调用(类似C#析构函数)</li>
<li><strong>class</strong> – 访问类的静态变量的时候(实例对象可以直接通过self访问)</li>
<li><strong>str</strong> – str()，format()以及print()函数触发Class获取字符串表达方法</li>
<li><strong>lt</strong> – &lt;运算符操作时调用</li>
<li><strong>le</strong> – &#x3D;&#x3D;运算法操作时调用</li>
<li><strong>hash</strong> – hash()方法计算Class实例对象Hash值时</li>
<li><strong>getattr</strong> – 访问Class成员不能存在时调用(类似Lua的__index元方法)</li>
<li><strong>setattr</strong> – 设置Class成员值时调用(类似Lua的__newindex元方法)</li>
<li>……</li>
</ol>
<p>更多特殊方法参考:<a target="_blank" rel="noopener" href="https://docs.python.org/3/reference/datamodel.html#special-method-names">Special method names</a></p>
<p>从上面可以看出Python和Lua有很多相似的地方。</p>
<p>接下来让我们看看实战效果:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MyFirstPython.py</span></span><br><span class="line"><span class="comment"># File Name: 		MyFirstPython.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study python</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2017/6/5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyFirstClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="string">&quot;&quot;&quot;docstring for MyClass&quot;&quot;&quot;</span></span><br><span class="line">	<span class="comment"># class Static Member</span></span><br><span class="line">	age = <span class="number">10</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 构造函数</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">		<span class="string">&quot;&quot;&quot;Class Constructor.&quot;&quot;&quot;</span></span><br><span class="line">		<span class="built_in">super</span>().__init__()</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;MyFirstClass:__init__(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">		<span class="variable language_">self</span>.name = name</span><br><span class="line"></span><br><span class="line">	<span class="comment"># str()，format()以及print()函数触发</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;MyFirstClass name:&#123;&#125; age:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>.name, <span class="variable language_">self</span>.age)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 获取不存在成员时触发</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;MyFirstClass:__getattr__(&#123;&#125;) not exist!&quot;</span>.<span class="built_in">format</span>(name))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 设置成员值时触发</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name, value</span>):</span><br><span class="line">		<span class="built_in">super</span>().__setattr__(name, value)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;MyFirstClass:__setattr__(&#123;&#125;, &#123;&#125;)!&quot;</span>.<span class="built_in">format</span>(name, value))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 加号运算符重载</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">		newName = <span class="variable language_">self</span>.name + other.name</span><br><span class="line">		<span class="keyword">return</span> MyFirstClass(newName)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">sayhi</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="string">&quot;&quot;&quot;Class Member Function.&quot;&quot;&quot;</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;MyFirstClass:sayhi() Hello World!&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">printname</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="string">&quot;&quot;&quot;Print name member.&quot;&quot;&quot;</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;MyFirstClass:printname() self.name = &quot;</span>, <span class="variable language_">self</span>.name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_first_python_func</span>():</span><br><span class="line">	<span class="string">&quot;&quot;&quot;MyFirstPython.py&#x27;s function.&quot;&quot;&quot;</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;my_first_python_func() called&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Class e.g.</span></span><br><span class="line">mfp = MyFirstPython.MyFirstClass(<span class="string">&quot;Tony&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(mfp.__class__.age)</span><br><span class="line">mfp.sayhi()</span><br><span class="line">mfp.printname()</span><br><span class="line"><span class="built_in">print</span>(mfp.name)</span><br><span class="line"><span class="built_in">print</span>(mfp.noneexitname)</span><br><span class="line">mfp.age = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(mfp.age)</span><br><span class="line"><span class="built_in">print</span>(mfp)</span><br><span class="line">mfp2 = MyFirstPython.MyFirstClass(<span class="string">&quot;Tang&quot;</span>)</span><br><span class="line">tempMfp = mfp + mfp2</span><br><span class="line"><span class="built_in">print</span>(tempMfp)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/ClassSpecialFunctionsOutput.png" alt="ClassSpecialFunctionsOutput"></p>
<p>通过上面的学习用例，可以看到我们通过自定义__init__,<strong>str</strong>,<strong>getattr</strong>,<strong>setattr</strong>,__add__等特殊方法实现了类构造，类成员自定义访问设置，类+运算符重载，类print()等方法自定义输出等效果。看到这里，不得不说Python特殊方法和Lua的元方法概念很像。</p>
<h3 id="Iterator"><a href="#Iterator" class="headerlink" title="Iterator"></a>Iterator</h3><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/iterator">Iterator in Python is simply an <a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/class">object</a> that can be iterated upon. An object which will return data, one element at a time.</a></p>
<p>这里的Iterator和C#里的迭代器应该是一个概念。实现迭代器需要实现两个特殊方法(<strong>iter__和__next</strong>)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Name: 		IteratorStudy.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study python iterator</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2021/5/25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 迭代器类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IteratorClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="string">&quot;&quot;&quot;Class to implement an iterator&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 构造函数</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, <span class="built_in">max</span></span>):</span><br><span class="line">		<span class="built_in">super</span>().__init__()</span><br><span class="line">		<span class="variable language_">self</span>.<span class="built_in">max</span> = <span class="built_in">max</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 返回迭代器</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;IteratorClass:__iter__()&quot;</span>)</span><br><span class="line">		<span class="variable language_">self</span>.n = <span class="number">0</span></span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 迭代器MoveNext</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;IteratorClass:__next__()&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="variable language_">self</span>.n &lt;= <span class="variable language_">self</span>.<span class="built_in">max</span>:</span><br><span class="line">			value = <span class="variable language_">self</span>.n</span><br><span class="line">			<span class="variable language_">self</span>.n += <span class="number">1</span></span><br><span class="line">			<span class="keyword">return</span> value</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">raise</span> StopIteration</span><br><span class="line"></span><br><span class="line">iteratorClassInstance = IteratorClass(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">iter</span> <span class="keyword">in</span> iteratorClassInstance:</span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">iter</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/IteratorOuput.png" alt="IteratorOuput"></p>
<h3 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h3><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/generator">Python generators are a simple way of creating iterators. Simply speaking, a generator is a function that returns an object (iterator) which we can iterate over (one value at a time). </a></p>
<p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/generator">It is fairly simple to create a generator in Python. It is as easy as defining a normal function, but with a <code>yield</code> statement instead of a <code>return</code> statement.</a></p>
<p>看介绍Generators的概念和C#的携程差不多。</p>
<p>Generator和普通方法的区别:</p>
<ol>
<li>Generator function contains one or more <code>yield</code> statements.</li>
<li>When called, it returns an object (iterator) but does not start execution immediately.</li>
<li>Methods like <code>__iter__()</code> and <code>__next__()</code> are implemented automatically. So we can iterate through the items using <code>next()</code>.</li>
<li>Once the function yields, the function is paused and the control is transferred to the caller.</li>
<li>Local variables and their states are remembered between successive calls.</li>
<li>Finally, when the function terminates, <code>StopIteration</code> is raised automatically on further calls.</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generator</span></span><br><span class="line">GeneratorVariable = <span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GeneratorFunction</span>():</span><br><span class="line">	<span class="keyword">global</span> GeneratorVariable</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;GeneratorFunction() &#123;&#125;&quot;</span>.<span class="built_in">format</span>(GeneratorVariable))</span><br><span class="line">	<span class="keyword">yield</span> GeneratorVariable</span><br><span class="line">	GeneratorVariable += <span class="number">1</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;GeneratorFunction() &#123;&#125;&quot;</span>.<span class="built_in">format</span>(GeneratorVariable))</span><br><span class="line">	<span class="keyword">yield</span> GeneratorVariable</span><br><span class="line">	GeneratorVariable += <span class="number">1</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;GeneratorFunction() &#123;&#125;&quot;</span>.<span class="built_in">format</span>(GeneratorVariable))</span><br><span class="line">	<span class="keyword">yield</span> GeneratorVariable</span><br><span class="line">	</span><br><span class="line">GeneratorFunc = GeneratorFunction()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;GeneratorFunction Start&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> generator <span class="keyword">in</span> GeneratorFunc:</span><br><span class="line">	<span class="built_in">print</span>(generator)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/GeneratorOuput.png" alt="GeneratorOuput"></p>
<p>可以看到Generator在Python里还能直接通过for循环的形式便利这一点和C#的携程还不太一样。</p>
<p>通过Generator我们可以简化自定义Iterator的写法，无需自定义__iter__和__next__方法，通过自定义的Generator方法即可实现迭代效果。Generator更多好处参考:<a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/generator">Generator</a></p>
<h3 id="Closure"><a href="#Closure" class="headerlink" title="Closure"></a>Closure</h3><p>Closure指类似传统语言里的闭包，但在Python里有几个较大的区别：</p>
<ol>
<li>闭包访问外围变量时，默认是只读的，需要通过nonlocal关键字来标识闭包内部可写。</li>
<li>闭包必须是嵌套函数定义</li>
<li>嵌套函数必须访问外部成员</li>
<li>外围函数必须返回嵌套函数自身</li>
</ol>
<p>Python里用闭包的好处：</p>
<p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/closure">Closures can avoid the use of global values and provides some form of data hiding. It can also provide an object oriented solution to the problem.</a></p>
<h3 id="Decorators"><a href="#Decorators" class="headerlink" title="Decorators"></a>Decorators</h3><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/decorator">A decorator takes in a function, adds some functionality and returns it.</a></p>
<p>看介绍Decorator像是设计模式里的修饰器概念，能够做到给现有功能添加额外功能的作用。</p>
<p>看介绍利用万物皆object的概念(类似Lua里第一类值)的概念，实现封装函数调用实现扩展函数功能。</p>
<p>还有更多更复杂的使用方式，详情参考:<a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/decorator">Decorators</a></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/decorator">everything in Python (Yes! Even classes), are [objects].</a></li>
</ol>
<h3 id="Property"><a href="#Property" class="headerlink" title="Property"></a>Property</h3><p>Property类似于C#里的属性概念。Python通过关键字@property实现属性的快速定义。</p>
<p><img src="/img/Python/PropertyKeywordDefinition.png" alt="PropertyKeywordDefinition"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Name: 		PropertyStudy.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study python property</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2021/5/25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 属性类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PropertyClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="string">&quot;&quot;&quot;Class to implement an property&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 构造函数</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, propertyvalue</span>):</span><br><span class="line">		<span class="built_in">super</span>().__init__()</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;PropertyClass.__init__()&quot;</span>)</span><br><span class="line">		<span class="variable language_">self</span>.Property = propertyvalue</span><br><span class="line"></span><br><span class="line"><span class="meta">	@property</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">Property</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Getting Property Value : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>._Property))</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">self</span>._Property</span><br><span class="line"></span><br><span class="line"><span class="meta">	@Property.setter</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">Property</span>(<span class="params">self, value</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Setting Property Value : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(value))</span><br><span class="line">		<span class="variable language_">self</span>._Property = value</span><br><span class="line"></span><br><span class="line">propertyClassInstance = PropertyClass(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(propertyClassInstance.Property)</span><br><span class="line">propertyClassInstance.Property = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(propertyClassInstance.Property)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PropertyOutput.png" alt="PropertyOutput"></p>
<p>更多学习参考:[Property][<a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/property]">https://www.programiz.com/python-programming/property]</a></p>
<h3 id="RegEx"><a href="#RegEx" class="headerlink" title="RegEx"></a>RegEx</h3><h3 id="Date-and-Time"><a href="#Date-and-Time" class="headerlink" title="Date and Time"></a>Date and Time</h3><h3 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h3><p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/multiprocessing.html">multiprocessing is a package that supports spawning processes using an API similar to the threading module.</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/threading.html#module-threading">threading module constructs higher-level threading interfaces on top of the lower level _thread module.</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/subprocess.html">The subprocess module allows you to spawn new processes, connect to their input&#x2F;output&#x2F;error pipes, and obtain their return codes. This module intends to replace several older modules and functions：os.system os.spawn*</a></p>
<p>从介绍可以看出，multiprocessing包是用于支持多进程类似多线程功能的模块。</p>
<p>threading是多线程的一个上层抽象模块。</p>
<p>multiprocessing是多进程的一个上层抽象模块(相比threading，不受限于**Global Interpreter Lock(多线程锁，限定同时只有一个Thread执行)**可以真正利用多核来跑多进程功能。</p>
<p>subprocess模块是封装的更好的一个创建使用子进程的模块，同时提供了和子进程处理交互相关的接口。</p>
<p>这里我们重点学习process相关即multiprocessing和subprocess相关概念和使用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">	File Name: 		MultiProcessStudy.py</span></span><br><span class="line"><span class="string">	Description: 		This file is used to study python subprocess</span></span><br><span class="line"><span class="string">	Author:  			TangHuan</span></span><br><span class="line"><span class="string">	Create Date:  	2021/8</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_task</span>(<span class="params">subProcessName</span>):</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;subProcessName:&#123;0&#125; Process pid:&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(subProcessName, os.getpid()))</span><br><span class="line">	start = time.time()</span><br><span class="line">	time.sleep(random.random())</span><br><span class="line">	end = time.time()</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;SubProcess:&#123;0&#125; Process pid:&#123;1&#125; runs:&#123;2&#125; seconds!&quot;</span>.<span class="built_in">format</span>(subProcessName, os.getpid(), end - start))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;MultiProcessStudy&quot;</span>)</span><br><span class="line">	<span class="comment"># 打印主进程id</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;Current Process pid:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid()))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 创建4个多进程(子进程)的进程池</span></span><br><span class="line">	p = Pool(<span class="number">4</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">		p.apply_async(process_task, args=(<span class="string">&quot;SubProcess&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(i),))</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;Waiting for all subprocesses done.&quot;</span>)</span><br><span class="line">	<span class="comment"># 停止提交更多的任务到p里</span></span><br><span class="line">	p.close()</span><br><span class="line">	<span class="comment"># 等待p里的所有子线程任务完成</span></span><br><span class="line">	p.join()</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;All subprocesses done.&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># SubProcess的方式开启子进程1</span></span><br><span class="line">	subProcess1 = subprocess.Popen([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;SubProcess1.py&#x27;</span>])</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;start SubProcess1&quot;</span>)</span><br><span class="line">	<span class="comment"># SubProcess的方式开启子进程2</span></span><br><span class="line">	subProcess2 = subprocess.Popen([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;SubProcess2.py&#x27;</span>])</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;start SubProcess2&quot;</span>)</span><br><span class="line">	<span class="comment"># 等待子进程1完成</span></span><br><span class="line">	subProcess1.wait()</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;SubProcess1 complete&quot;</span>)</span><br><span class="line">	<span class="comment"># 等待子进程2完成</span></span><br><span class="line">	subProcess2.wait()</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;SubProcess2 complete&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Name: 		SubProcess1.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study python subprocess</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2021/8/7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess1-1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess1 parent pid:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(os.getppid()))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess1 pid:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid()))</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess1-2&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Name: 		SubProcess2.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study python subprocess</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2021/8/7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess2-1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess2 parent pid:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(os.getppid()))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess2 pid:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid()))</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess2-2&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/MultiProcessingOutput.png" alt="MultiProcessingOutput"></p>
<p>从上面的测试代码可以看出，我们通过mutilprocessing模块提供的Pool(用于控制一组子进程的创建使用)成功创建了4个多进程池开启5个多进程任务(其中有一个任务需要等待一个可用的进程才能执行)。</p>
<p>通过SubProcess模块，我们实现了开启多个进程执行不同Python脚本的功能，从而实现多进程执行多Python脚本任务的需求。</p>
<p>更多更细节的学习参考:</p>
<p><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017628290184064">多进程</a></p>
<p>Note：</p>
<ol>
<li><strong>multiprocessing和subprocess是提供了多进程而非多线程</strong></li>
<li>Unix&#x2F;Linux操作系统多进程是采用fork()实现真正的进程复制，而Windows不支持fork()函数，Windows上多进程是通过在子进程里创建新的Python解析器来实现的(来源:<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/28744046/multiprocessing-python-not-running-in-parallel">On Windows, there is no such system call. Python needs to perform the quite heavy task of creating a fresh Python interpreter session in the child, and re-create (step by step) the state of the parent.</a>)，所以我们执行多进程时要通过命令行而非Sumblime等软件。</li>
</ol>
<p>待续……</p>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><h3 id="encode-and-decode"><a href="#encode-and-decode" class="headerlink" title="encode and decode"></a>encode and decode</h3><p>字符编码问题，无论是shell，python都是需要考虑的，不然会出现乱码的情况。</p>
<p>encode(编码)和decode(解码)是需要一一对应的，不然同一个二进制数据，通过不同的编码和解码会得出不一样的结果。</p>
<p>首先我们来看看Python官网对于Encode和Decode的介绍:<br><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/codecs.html#encodings-and-unicode">Strings are stored internally as sequences of code points in range 0x0–0x10FFFF. (See PEP 393 for more details about the implementation.) Once a string object is used outside of CPU and memory, endianness and how these arrays are stored as bytes become an issue. As with other codecs, serialising a string into a sequence of bytes is known as encoding, and recreating the string from the sequence of bytes is known as decoding.</a></p>
<p>从上面可以看出，我们的string最终都是以字节码形式存储起来的。我们指定如何编码字符串到字节码的方法叫做编码。我们制定如何解析字节码到字符串的方法叫做解码。</p>
<p>关于字符编码的详细学习，这里参考以前转载的一片文章来加深理解:<br><a target="_blank" rel="noopener" href="http://www.imkevinyang.com/2010/06/%E5%85%B3%E4%BA%8E%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%EF%BC%8C%E4%BD%A0%E6%89%80%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84.html">关于字符编码，你所需要知道的（ASCII,Unicode,Utf-8,GB2312…）</a></p>
<p>不难看出，编码和解码方式要是不一致，最终字节码数据解析出来就会出现不正确(比如乱码)的情况。</p>
<p>这里需要提一下Python 3.X里有提供codecs的Package专门负责处理encode，decode问题。<br><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/codecs.html#standard-encodings">codecs深入了解链接</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 指定文件包含非anscii字符</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印系统默认编码</span></span><br><span class="line"><span class="built_in">print</span>(sys.getdefaultencoding())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果默认编码不是utf-8，强制设置成utf8去支持文本内非anscii字符</span></span><br><span class="line"><span class="comment"># 下面这段代码针对Python 2.X</span></span><br><span class="line"><span class="comment"># Phtyon 3.X默认就是utf-8编码不需要自己设定utf-8编码</span></span><br><span class="line"><span class="comment">#reload(sys)</span></span><br><span class="line"><span class="comment">#sys.setdefaultencoding(&#x27;utf-8&#x27;)</span></span><br><span class="line"></span><br><span class="line">s=<span class="string">&quot;English-中文&quot;</span></span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line"></span><br><span class="line">s2=codecs.encode(s,<span class="string">&quot;gb2312&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(codecs.decode(s2,<span class="string">&quot;gb2312&quot;</span>))</span><br><span class="line"><span class="comment">#解码格式与编码格式gb2312不一致，报错，无法解析</span></span><br><span class="line"><span class="comment">#print(codecs.decode(s2,&quot;utf-8&quot;))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要指定和文件一样的编码格式才能正确解析文件里的内容</span></span><br><span class="line"><span class="comment"># 读取解码格式与inputfile.txt保存的编码格式utf-8不一致报错</span></span><br><span class="line"><span class="comment">#f = open(&#x27;inputfile.txt&#x27;,&#x27;r&#x27;,encoding=&#x27;gb2312&#x27;)</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;inputfile.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">content = f.read()</span><br><span class="line"><span class="built_in">print</span>(content)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/EncodeAndDecode.png" alt="EncodeAndDecode"></p>
<p>可以看到当我们把通过gb2312编码的字符串通过对应的gb2312解析时能正确显示，但用utf-8去解析时就出现了问题。同理文件读取指定的解码格式与文件自身的编码格式不一致也会出现无法读取的情况。</p>
<p>结论：<br>编码和解码格式要一一对应才能正确解析显示。<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">String is sequence of Unicode characters. Strings are immutable. We cannot delete or remove characters from a string. But deleting the string entirely is possible using the keyword del.</a><br>Python里是采用Unicode编码存储字符串。Strings可以通过[]访问，但是不可被改变的。<br>因为string是immutable的，所以我们不能通过del删除string里面的个别character，但是我们可以删除对string的整个引用。</p>
<h3 id="main"><a href="#main" class="headerlink" title="main"></a><strong>main</strong></h3><p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/__main__.html"><code>&#39;__main__&#39;</code> is the name of the scope in which top-level code executes. A module’s <strong>name</strong> is set equal to <code>&#39;__main__&#39;</code> when read from standard input, a script, or from an interactive prompt. A module can discover whether or not it is running in the main scope by checking its own <code>__name__</code>, which allows a common idiom for conditionally executing code in a module when it is run as a script or with <code>python -m</code> but not when it is imported:</a></p>
<p>从上面的介绍可以看出__main__表示是否是从最上层执行(比如直接执行脚本，命令行执行脚本)代码的名字。</p>
<p>如何判定是否是从最上层执行当前python脚本了？</p>
<p>从上面的介绍可以看出，__name__变量标识了当前python脚本是通过什么方式执行的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Name: 		MainName.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study __name__ and __main__ using</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2021/5/22</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;MainName.py&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(__name__)</span><br></pre></td></tr></table></figure>

<p>比如上面这段代码，在通过脚本直接执行时，我们会看到打印输出:</p>
<p><img src="/img/Python/DirectExecuteNameOuput.png" alt="DirectExecuteNameOuput"></p>
<p>如果我们通过以下代码导入MainName.py会看到打印输出:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> MyPackage.MainName</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/ImportNameOutput.png" alt="ImportNameOutput"></p>
<p>在命令行执行脚本和直接执行脚本同理。</p>
<p>可以看出当我们通过非import方式导入脚本时，__name__的值为__main__这个特殊的值，我们可以通过判定这个值来判定当前python脚本的执行方式，因此我们经常会看到以下代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;DoSomething()&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这样就能做到只有通过非import方式执行当前python脚本时才执行某些东西。</p>
<h3 id="Command-Line-Args"><a href="#Command-Line-Args" class="headerlink" title="Command Line Args"></a>Command Line Args</h3><h4 id="os-argv"><a href="#os-argv" class="headerlink" title="os.argv"></a>os.argv</h4><p>很多时候作为脚本语言Python，我们写的Python脚本更多是用于自动化流程(比如打包签包等)，而调用此Python脚本的方式大多为命令行调用。这里就引出了如何通过命令行将我们所需的参数传递进我们Python脚本的问题。</p>
<p>Python自带了一个os.argv的参数用于获取命令行传入参数数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> arg <span class="keyword">in</span> sys.argv:</span><br><span class="line">	<span class="built_in">print</span>(arg)</span><br></pre></td></tr></table></figure>

<p>如果我们通过命令执行以下脚本传入参数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">***.py param1 param2 param3</span><br></pre></td></tr></table></figure>

<p>我们会看到以下输出:</p>
<p><img src="/img/Python/PythonArgsOutput.png" alt="PythonArgsOutput"></p>
<p>可以看到第0个参数表示当前python脚本执行的文件路径。</p>
<p>但上面这种方式，虽然能获得命令行传入的参数，但对于参数的格式以及参数的要求对于用的人来说都还是不透明且未做任何安全检查也未给与任何提示信息的，这样会导致Python脚本内部还需要自行做这些参数检查。这里就要引出接下来要提到的模块功能:<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/argparse.html">argparse</a></p>
<p>Note:</p>
<ol>
<li>如果以-c的参数触发python，os.argv的第一个参数是-c,详情参考:<a target="_blank" rel="noopener" href="https://docs.python.org/3/using/cmdline.html#cmdoption-c">-c</a></li>
</ol>
<h4 id="argparse-1"><a href="#argparse-1" class="headerlink" title="argparse"></a>argparse</h4><p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/argparse.html">The argparse module makes it easy to write user-friendly command-line interfaces. The program defines what arguments it requires, and argparse will figure out how to parse those out of sys.argv. The argparse module also automatically generates help and usage messages and issues errors when users give the program invalid arguments.</a></p>
<p>argparse是Python里帮助我们引导输入参数和快速解析参数的模块。</p>
<p>接下来我们直接上学习Demo，简单学习了解下如何使用argparse帮助我们快速引导输入参数和快速解析参数:<br>argparsestudy.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 指定文件包含非anscii字符</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># argparse解析参数输入，需要先定义一个ArgumentParser对象</span></span><br><span class="line"><span class="comment"># description - -h的时候显示在最前面的信息</span></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Study argparse module.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add_argument - 定义如何解析一个参数</span></span><br><span class="line"><span class="comment"># 第一个参数代表参数名</span></span><br><span class="line"><span class="comment"># type - 指定参数数据类型</span></span><br><span class="line"><span class="comment"># help - -h时解释该参数的用意</span></span><br><span class="line"><span class="comment"># dest - 表示该参数最终在parser.parse_args()返回对象里的名字</span></span><br><span class="line"><span class="comment"># default - 表示该参数的默认值</span></span><br><span class="line"><span class="comment"># required - 表示该参数是不是必须填的参数</span></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--APKName&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;APK名字&#x27;</span>, dest=<span class="string">&#x27;APKName&#x27;</span>,</span><br><span class="line">                    required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--ClientChId&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;新的ClientChId值&#x27;</span>, dest=<span class="string">&#x27;New_Clientchid&#x27;</span>,</span><br><span class="line">                    default=<span class="string">&#x27;com.default.com&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--LEBIAN_VERCODE&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                     <span class="built_in">help</span>=<span class="string">&#x27;新的LEBIAN_VERCODE值&#x27;</span>, dest=<span class="string">&#x27;New_Lebian_Vercode&#x27;</span>,</span><br><span class="line">                     default=<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--TemplateValue&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;替换AndroidManifest.xml里quicksdk_packName字段为新的*&#x27;</span>, dest=<span class="string">&#x27;NewTemplateValue&#x27;</span>,</span><br><span class="line">                    default=<span class="string">&#x27;com.defaulttemplatevalue.com&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--ResourcePath&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;放入新资源到指定包内目录&#x27;</span>, dest=<span class="string">&#x27;NewResourcePath&#x27;</span>,</span><br><span class="line">                    default=<span class="string">&#x27;./default.aba&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析输入的参数</span></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印参数的详细信息，通过访问parser.parse_args()的对象去访问</span></span><br><span class="line"><span class="built_in">print</span>(args)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;APKName : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(args.APKName))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;New_Clientchid : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(args.New_Clientchid))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;New_Lebian_Vercode : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(args.New_Lebian_Vercode))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NewTemplateValue : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(args.NewTemplateValue))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NewResourcePath : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(args.NewResourcePath))</span><br></pre></td></tr></table></figure>

<p>命令行输入:<br>Python .\argparsestudy.py -h<br>会看到每个参数的详细信息<br><img src="/img/Python/ArgparseHelpInfo.png" alt="ArgparseHelpInfo"></p>
<p>真正使用时因为–APKName是必传参数，所以按下面方式调用即可:<br>Python .\argparsestudy.py –APKName com.tonytang.com<br><img src="/img/Python/ArgparseUsing.png" alt="ArgparseUsing"><br>可以看到我们通过argparse模块轻松的完成参数输入引导以及参数解析的任务。</p>
<p>更多详细学习参考:<br><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/argparse.html#the-add-argument-method">argparse — Parser for command-line options, arguments and sub-commands</a></p>
<h3 id="Path"><a href="#Path" class="headerlink" title="Path"></a>Path</h3><p>关于Path模块，这里需要先了解一下跟语言无关的一个基础知识。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zlwzlwzlw/article/details/7768313/">路径中斜杠&#x2F;和反斜杠\的区别</a></p>
<p>从博客介绍中可以看出，斜杠和反斜杠主要是Windows路径和Unix路径里区分，大部分情况(无论是浏览器还是html url都是反斜杠)。</p>
<p>这里就引出了在自动化流程里涉及路径时，我们需要兼容Windows，Mac，Android或者IOS时候路径问题需要处理。而Path模块正是能够处理这一问题的现有模块功能。</p>
<h4 id="os-path"><a href="#os-path" class="headerlink" title="os.path"></a>os.path</h4><p>这里只是简单示范几个常规API用法，详情参考:<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/os.path.html">os.path</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">FilePath = sys.argv[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;FilePath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(FilePath))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前工作目录</span></span><br><span class="line">WorkingFolder = os.getcwd()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;WorkingFolder = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件所在文件夹名</span></span><br><span class="line">FileFolderName = os.path.dirname(FilePath)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;FileFolderName = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(FileFolderName))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.path.isdir(WorkingFolder):</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is directory!&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is not directory!&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/OSPathAPIOutput.png" alt="OSPathAPIOutput"></p>
<h4 id="pathlib"><a href="#pathlib" class="headerlink" title="pathlib"></a>pathlib</h4><p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pathlib.html#module-pathlib">This module offers classes representing filesystem paths with semantics appropriate for different operating systems. Path classes are divided between <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pathlib.html#pure-paths">pure paths</a>, which provide purely computational operations without I&#x2F;O, and <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pathlib.html#concrete-paths">concrete paths</a>, which inherit from pure paths but also provide I&#x2F;O operations.</a></p>
<p>上面提到了两种概念PurePath和Concrete Paths，前者只是提供路径概念(比如区分Windows还是Unix文件系统以及路径相关操作)不和文件系统挂钩。后者就是Pathlib提供的OOP文件路径系统抽象，提供了一系列的文件操作接口(Pathlib相当于进阶版的Path抽象模块)。</p>
<p><img src="/img/Python/UMLPathDesgin.png" alt="UMLPathDesgin"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">FilePath = sys.argv[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;FilePath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(FilePath))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前工作目录</span></span><br><span class="line">WorkingFolder = os.getcwd()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;WorkingFolder = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件所在文件夹名</span></span><br><span class="line">FileFolderName = os.path.dirname(FilePath)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;FileFolderName = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(FileFolderName))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.path.isdir(WorkingFolder):</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is directory!&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is not directory!&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这一步可以自动转化成对应平台的路径格式(最后需要str的时候需要转化成str)</span></span><br><span class="line">PathWorkingFolder = Path(WorkingFolder)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;PathWorkingFolder = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(PathWorkingFolder))</span><br><span class="line"></span><br><span class="line">WorkingFolderJoinPath = PathWorkingFolder.joinpath(<span class="string">&quot;joinpath&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;WorkingFolderJoinPath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(WorkingFolderJoinPath))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> PathWorkingFolder.exists():</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; exists!&quot;</span>.<span class="built_in">format</span>(PathWorkingFolder))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PathLibAPIOutput.png" alt="PathLibAPIOutput"></p>
<p>这里用Pathlib除了他提供了更多的文件路径操作外，还有就是它继承了PurePath跨平台文件路径处理的特性，让我们可以在处理文件路径时无需关心平台。</p>
<h3 id="Bat-and-Shell"><a href="#Bat-and-Shell" class="headerlink" title="Bat and Shell"></a>Bat and Shell</h3><p>Bat和Shell在<a href="http://tonytang1990.github.io/2017/04/29/Unity%E8%87%AA%E5%8A%A8%E5%8C%96&IOS%E8%87%AA%E5%8A%A8%E5%8C%96%E7%AD%BE%E5%8C%85/">Unity自动化&amp;IOS自动化签包</a>文章中已经了解过了，这里主要是介绍如何在python里和bat，shell交互(比如我们想获取环境变量里的数据，执行shell命令等)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">androidhome = os.getenv(<span class="string">&quot;ANDROID_HOME&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> androidhome == <span class="literal">None</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;未配置ANDROID_HOME环境变量路径，请先配置ANDROID_HOME环境变量&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;ANDROID_HOME = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(androidhome))</span><br><span class="line"></span><br><span class="line">WorkingFolder = os.getcwd()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;WorkingFolder = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"></span><br><span class="line">CmdCommand = <span class="string">&quot;echo Hello World&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;CmdCommand = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(CmdCommand))</span><br><span class="line"><span class="comment"># 执行CDM命令</span></span><br><span class="line">os.system(CmdCommand)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保不自动关闭</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;请按任意键继续...&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/SystemInfoOutput.png" alt="SystemInfoOutput"></p>
<p>注释和用法都很详细了，这里就不多介绍了。</p>
<h2 id="Python-GUI"><a href="#Python-GUI" class="headerlink" title="Python GUI"></a>Python GUI</h2><p>GUI(Graphic User Interface)可视化用户界面。<br>Python实现GUI有很多选择，这里参考一位博主的分享：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/22619896">Python 的图形界面（GUI）编程？</a></p>
<p>学习需要从需求出发，这里本人主要是想用Python写点简单的GUI来满足可视化即可，所以对GUI要求不高，本人不是以Python为主，只是用Python写点周边小工具，所以这里本人考虑的是学习了解Python自带的TKinter。</p>
<p>如果对GUI要求比较高，有比较常用Python，根据上面那位博主的建议来看，PyQT是个不错的选择。</p>
<h3 id="TKinter"><a href="#TKinter" class="headerlink" title="TKinter"></a>TKinter</h3><p>官方介绍：<br><a target="_blank" rel="noopener" href="https://wiki.python.org/moin/TkInter/">Tkinter is Python’s de-facto standard GUI (Graphical User Interface) package. It is a thin object-oriented layer on top of Tcl&#x2F;Tk.</a></p>
<p>接下来将根据<a target="_blank" rel="noopener" href="http://infohost.nmt.edu/tcc/help/pubs/tkinter/web/index.html">Tkinter 8.5 reference: a GUI for Python</a>去学习了解TKinter的概念以及使用。</p>
<p>待续……</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://www.python.org/">Python</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Guido_van_Rossum">Guido van Rossum</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.python.org/moin/TkInter/">Tkinter</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/codecs.html#encodings-and-unicode">Encode and Decode in Python</a></p>
<h2 id="Tutorial-Part"><a href="#Tutorial-Part" class="headerlink" title="Tutorial Part"></a>Tutorial Part</h2><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/keywords-identifier">Python Tutorial</a><br><a target="_blank" rel="noopener" href="https://pip.pypa.io/en/stable/user_guide/#installing-packages">Python Package Index</a></p>
<p><a target="_blank" rel="noopener" href="http://infohost.nmt.edu/tcc/help/pubs/tkinter/web/index.html">Tkinter 8.5 reference: a GUI for Python</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/codecs.html#standard-encodings">codecs</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/argparse.html">argparse</a></p>
<p><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1016959663602400">Python教程</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a target="_blank" rel="noopener" href="https://wiki.python.org/moin/Python2orPython3">Python2orPython3</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/22619896">Python 的图形界面（GUI）编程？</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Programming-Language/">Programming Language</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Python/">Python</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/29/Unity自动化&IOS自动化签包/" title="Unity自动化&amp;IOS自动化签包" itemprop="url">Unity自动化&amp;IOS自动化签包</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-04-29T07:17:56.000Z" itemprop="datePublished"> 发表于 2017-04-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Unity自动化打包"><a href="#Unity自动化打包" class="headerlink" title="Unity自动化打包"></a>Unity自动化打包</h1><p>本章节主要是为了学习Unity自动化打包相关知识以及运用。<br>本文大部分属于本人学习理解的东西，如有不对欢迎指出，学习交流，共同进步。</p>
<p>本章节的流程如下：</p>
<ol>
<li>了解什么是打包以及打包过程中的一些相关概念</li>
<li>了解什么是自动化以及帮助我们快速完成一键打包的工具</li>
<li>自动化打包工具或编程语言的选取</li>
<li>Unity自动化打包过程中的相关工具</li>
<li>实战集成运用到Unity构建一键打包</li>
<li>更多学习程序发布以及相关概念</li>
</ol>
<p>在了解相关自动化工具之前，我们需要先简单了解下什么是版本控制。在我们的日常开发工作中必不可少。</p>
<h2 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h2><p><a href="http://tonytang1990.github.io/2019/04/19/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/">版本控制相关概念学习</a></p>
<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>平时做游戏开发，在完成整个游戏功能开发后，需要通过打包上真机测试。<br>把所有游戏资源代码打包成安装包的过程称为打包。</p>
<h3 id="多平台"><a href="#多平台" class="headerlink" title="多平台"></a>多平台</h3><p>在多平台的处理上，Unity已经帮我们做了很大一部分工作了。让我们大部分时间只需关心游戏核心开发(Unity部分API在不同平台有差异)，在打包这一块只需打选择对应平台即可。</p>
<p>但Unity自带的打包，终究只包含最基本的打包流程，当我们有特殊需求时，我们需要通过Unity以及相关工具完成支持我们自定义的打包流程。</p>
<h3 id="自动化"><a href="#自动化" class="headerlink" title="自动化"></a>自动化</h3><p>在了解什么是自动化之前，让我们看看打包的基本流程。<br>在打包过程中，打包往往包含4个步骤。</p>
<ol>
<li>Preprocess(打包准备步骤)<br>这一步主要是为正式打包编译做准备，比如做一些平台相关设置，资源打包处理，文件复制等</li>
<li>Build(打包编译步骤)<br>这一步是程序代码和资源正式打包成安装包的步骤，主要是通过指定打包参数执行打包。<br>Unity在打包到Android和IOS平台时有差异。Android是直接就打包出APK，而IOS要先打包成XCode工程，然后在通过编译XCode工程打包出Ipa安装包。</li>
<li>Postprocess(打包结束后期处理步骤)<br>这一步是打包完成后负责后续的自动化操作以及善后工作，比如在打包IOS时打包出XCode工程后，可以在这一步进行XCode工程的自动化处理部分(比如动态添加info.plist文件信息，动态插入代码等)</li>
<li>Deploy(安装步骤)<br>这一步主要是打包好的安装包安装到真机的步骤</li>
</ol>
<p>如果没有自动化，我们需要一步一步人工手动去完成上面的步骤。<br>而自动化就是只需人工设置打包最基本的参数信息，然后通过一步就自动化完成上述步骤的过程。</p>
<h4 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h4><p><strong>Introduction</strong><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Jenkins_(%E8%BD%AF%E4%BB%B6)">Jenkins是一个用Java编写的开源的持续集成工具。Jenkins提供了软件开发的持续集成服务。它运行在Servlet容器中（例如Apache Tomcat）。它支持软件配置管理（SCM）工具（包括AccuRev SCM、CVS、Subversion、Git、Perforce、Clearcase和RTC），可以执行基于Apache Ant和Apache Maven的项目，以及任意的Shell脚本和Windows批处理命令。Jenkins的主要开发者是川口耕介。</a></p>
<p>本人使用目的：<br>做Unity游戏打包机，持续集成自动化打包流程，做到一键打包。</p>
<p><a target="_blank" rel="noopener" href="https://jenkins.io/doc/"><strong>Deployment</strong></a></p>
<ol>
<li>Download Jeakins</li>
<li>Open up a terminal in the download directory and run java -jar jenkins.war</li>
<li>Browse to <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080</a> and follow the instructions to complete the installation.(安装插件)</li>
</ol>
<h4 id="Jenkins实战"><a href="#Jenkins实战" class="headerlink" title="Jenkins实战"></a>Jenkins实战</h4><h5 id="自由风格构建系统"><a href="#自由风格构建系统" class="headerlink" title="自由风格构建系统"></a>自由风格构建系统</h5><p>主要是采用特定的构建系统去构建自动化。(比如java通过ant||Maven，windows通过bat||python等)<br><img src="/img/Unity/OpenAutomation.PNG" alt="OpenAutomation"></p>
<p>如果不想采用Pipeline编写自动化流程，也可以通过直接编写调用Windows Bat或者Python等命令触发自动化流程。<br><img src="/img/Unity/OpenAutomationWithCommands.PNG" alt="OpenAutomationWithCommands"></p>
<p>Unity3d Plugin不支持Pipeline，所以为了使用Unity3d Plugins,这里采用自由风格构建系统来搭建Unity3D的自动化打包。</p>
<ol>
<li>Create Free Style(创建自由风格项目)<br>新建 -&gt; 构建一个自由风格的软件项目<br><img src="/img/Unity/JenkinsFreeStyleProject.PNG" alt="JenkinsFreeStyleProject"></li>
<li>设置参数构造(用于自定义参数添加)<br><img src="/img/Unity/FreeStyleWithParametersSetting.PNG" alt="FreeStyleWithParametersSetting"></li>
<li>设置代码来源<br><img src="/img/Unity/FreeStyleWithSourceSetting.PNG" alt="FreeStyleWithSourceSetting"></li>
<li>设置构建命令(bat || python || unity3d……)<br><img src="/img/Unity/FreeStyleWithCommandsSetting.PNG" alt="FreeStyleWithCommandsSetting"></li>
<li>设置构建完毕后的一些行为(比如邮件通知)<br><img src="/img/Unity/FreeStyleWithPostProcessing.PNG" alt="FreeStyleWithPostProcessing"></li>
</ol>
<p>Note:<br>想要改变默认的workspace路径的话。<br>设置-&gt;使用自定义的工作空间(只针对当前设置的自由风格项目有效)<br><img src="/img/Unity/FreeStyleWithOwnWorkspace.PNG" alt="FreeStyleWithOwnWorkspace"></p>
<h5 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h5><h6 id="What"><a href="#What" class="headerlink" title="What"></a>What</h6><p><a target="_blank" rel="noopener" href="https://jenkins.io/doc/">Jenkins Pipeline is a suite of plugins which supports implementing and integrating continuous delivery pipelines into Jenkins. Pipeline provides an extensible set of tools for modeling simple-to-complex delivery pipelines “as code”.</a>(这里的Pipeline是一套插件，用于支持持续自动化集成编写。好比脚本文件定义一系列的自动化流程，但并不等价于脚本。)</p>
<p>那么Pipeline是用什么语言编写了？<br>Jenkins是基于Java的，Pipeline的编写是基于Groovy。<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Groovy">Groovy是Java平台上设计的面向对象编程语言。这门动态语言拥有类似Python、Ruby和Smalltalk中的一些特性，可以作为Java平台的脚本语言使用。</a></p>
<h6 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h6><p>为什么需要Pipeline？</p>
<ol>
<li>Code – 可管理可编辑可视化的自动化流程脚本</li>
<li>Durable – 可持续化开发</li>
<li>Pausable – 可以自动也可以停止等待输入</li>
<li>Versatile – 支持复杂的持续交付需求</li>
<li>Extensible – “The Pipeline plugin supports custom extensions to its DSL [5: Domain-Specific<br>Language] and multiple options for integration with other plugins.”</li>
</ol>
<h6 id="How"><a href="#How" class="headerlink" title="How"></a>How</h6><p>接下来让我们看看如何创建一个Pipeline。</p>
<ol>
<li>下载Pipeline插件<br><img src="/img/Unity/DownloadPipelinePlugin.PNG" alt="DownloadPipelinePlugin"></li>
<li>New Item – 新建Pipeline(选择Pipeline类型)<br><img src="/img/Unity/CreatePipelineStep1.PNG" alt="CreatePipeline"></li>
<li>Configure Pipeline<ul>
<li>配置Pipeline的名字<br><img src="/img/Unity/CreatePipelineStep2.PNG" alt="ConfigurePipeline"></li>
<li>设置Jenkins Pipeline Code的来源<ul>
<li>网页版编写<br><img src="/img/Unity/SetPipelineSourceFromWeb.PNG" alt="CreatePipelineSetPipelineSource"></li>
<li>SVN下含Jenksfile文件<br><img src="/img/Unity/SetPipelineSourceFromSVN.PNG" alt="CreatePipelineSetPipelineSourceSVN"><br>这里不深入讨论Jenkins的各种设置，详情查看官方文档<a target="_blank" rel="noopener" href="https://jenkins.io/user-handbook.pdf">Jenkins User Handbook</a></li>
</ul>
</li>
</ul>
</li>
</ol>
<p>Note:<br>Pipeline supports two syntaxes, Declarative and Scripted Pipeline</p>
<h6 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h6><p>除了直接在网页上编写Pipeline自动化流程。我们也可以指定Jenkinsfile文件作为编写Pipeline的地方。</p>
<p>为什么需要Jenkinsfile？<br>主要还是为了放入版本管理，方便所有人可视化看到自动化流程代码。</p>
<p>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!groovy</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    <span class="comment">//agent指定jenkins从哪里以及如何执行pipeline</span></span><br><span class="line">    <span class="comment">//any表示从any available agent处执行</span></span><br><span class="line">    agent any</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//看定义在那一层，就只针对那一层起作用(pipeline一层针对pipeline。stage一层针对特定stage)</span></span><br><span class="line">    <span class="comment">//也可以修改已定义的环境变量值</span></span><br><span class="line">    environment &#123;</span><br><span class="line">        UNITY_PROJECT_PATH = <span class="string">&#x27;E:\\TonyTang\\Work\\Projects\\TGame_code&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义参数</span></span><br><span class="line">    <span class="comment">//可以通过pipeline代码编写，也可以直接在web UI界面上添加</span></span><br><span class="line">    parameters&#123;</span><br><span class="line">        <span class="built_in">string</span>(name: <span class="string">&#x27;Platform&#x27;</span>, defaultValue: <span class="string">&#x27;Android&#x27;</span>, description: <span class="string">&#x27;Which plaftform is using?&#x27;</span>)</span><br><span class="line">        booleanParam(name: <span class="string">&#x27;DEBUG_BUILD&#x27;</span>, defaultValue: <span class="literal">true</span>, description: <span class="string">&#x27;Is debug version?&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;postprocess&#x27;</span>)&#123;</span><br><span class="line">            <span class="comment">//when表示执行条件判断</span></span><br><span class="line">            <span class="comment">//决定stage是否应该执行</span></span><br><span class="line">            <span class="keyword">when</span>&#123;</span><br><span class="line">                expression</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">params</span>.DEBUG_BUILD</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps&#123;</span><br><span class="line">                <span class="comment">//params是访问pipeline里定义的所有parameters入口</span></span><br><span class="line">                echo <span class="string">&quot;Current platform is $&#123;params.Platform&#125;&quot;</span></span><br><span class="line">                echo <span class="string">&#x27;postprocess&#x27;</span></span><br><span class="line">                echo UNITY_PROJECT_PATH</span><br><span class="line">                <span class="comment">//env是jenkins定义的全局的环境变量</span></span><br><span class="line">                <span class="comment">//http://localhost:8080/job/TonyTangPipeline/pipeline-syntax/globals</span></span><br><span class="line">                echo env.WORKSPACE</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">//Windows调用bat</span></span><br><span class="line">                <span class="comment">//Mac Linux采用sh</span></span><br><span class="line">                bat <span class="string">&#x27;TonyTangPipeline&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;deploy&#x27;</span>)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                echo <span class="string">&#x27;deploy&#x27;</span></span><br><span class="line">                <span class="comment">//支持调用python</span></span><br><span class="line">                bat <span class="string">&#x27;python FirstPython.py&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//post表示Pipeline执行完之后执行，做一些clean up操作</span></span><br><span class="line">    post &#123;</span><br><span class="line">        <span class="comment">//根据pipeline的结果做特定操作</span></span><br><span class="line">        always&#123;</span><br><span class="line">            echo <span class="string">&#x27;Always!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo <span class="string">&#x27;Success!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        failure&#123;</span><br><span class="line">            echo <span class="string">&#x27;Failed!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Script Pipeline(Optional)</span></span><br><span class="line"><span class="comment">//在pipeline执行完成之后执行</span></span><br><span class="line"><span class="comment">//支持大部分Groovy</span></span><br><span class="line"><span class="comment">//Script Pipeline的参数定义需要在properties里</span></span><br><span class="line">properties([parameters([<span class="built_in">string</span>(defaultValue: <span class="string">&#x27;Android&#x27;</span>, description: <span class="string">&#x27;Which platform is using?&#x27;</span>, name: <span class="string">&#x27;Platform&#x27;</span>)])])</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    <span class="comment">//定义字符串</span></span><br><span class="line">    def Date = <span class="string">&#x27;2017//4//26&#x27;</span></span><br><span class="line">    stage(<span class="string">&#x27;postprocess&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">//要使用$&#123;&#125;访问string，需要用&quot;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;Date = $&#123;Date&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;Current platform is $&#123;params.Platform&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&#x27;postprocess....&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;build&#x27;</span>) &#123;</span><br><span class="line">        echo <span class="string">&#x27;build....&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;deploy&#x27;</span>) &#123;</span><br><span class="line">        echo <span class="string">&#x27;deploy....&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li>指定使用版本管理后，Jenkinsfile必须放到版本管理里才能找到。</li>
<li>Jenkinsfile必需放到前面设置的本机相对路径下才能找到。</li>
</ol>
<h6 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h6><ol>
<li>构建参数一旦通过代码指定添加后，代码删除了依然存在</li>
<li>No valid crumb was included in the request</li>
</ol>
<p>Solutions:</p>
<ol>
<li>通过Pipeline -&gt; Setting的UI界面手动删除参数</li>
<li>在系统管理 –&gt; Configure Global Security<br>取消“防止跨站点请求伪造（Prevent Cross Site Request Forgery exploits）”的勾选。</li>
</ol>
<h5 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h5><h6 id="Pipeline-Tools"><a href="#Pipeline-Tools" class="headerlink" title="Pipeline Tools"></a>Pipeline Tools</h6><p><a target="_blank" rel="noopener" href="http://localhost:8080/pipeline-syntax/">Snippet Generator</a><br><img src="/img/Unity/PipelineSnippetGenerator.PNG" alt="PipelineSnippetGenerator"><br>这是一个很有用帮助快速编写Pipeline的工具,他可以帮助我们把我们熟悉的自动化脚本转换成Pipeline格式的语句，也可以快速生成一些特定功能的脚本(比如邮件功能等)。(Jenkins提供)</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/pipeline-syntax/globals">Pipiline全局环境变量</a></p>
<h6 id="Email-Plugin"><a href="#Email-Plugin" class="headerlink" title="Email Plugin"></a>Email Plugin</h6><p>利用现有的SMTP(腾讯，网易等)服务进行搭建邮件提醒，详情参见如下：<br><a target="_blank" rel="noopener" href="http://blog.csdn.net/houyefeng/article/details/50914582">Jenkins——应用篇——插件使用——Mailer Plugin</a><br>Jenkins自带Email配置如下:<br>Manage Jenkins -&gt; Configure System -&gt; E-mail Notification<br><img src="/img/Unity/EmailNotificationSetting.png" alt="EmailNotificationSetting"><br>Jenkins自带的Mailer提供的功能很有限，为了提供更多更广的功能，这里我们需要用到<a href="wiki.jenkins-ci.org/display/JENKINS/Email-ext+plugin">Jenkins Email Extension Plugin</a><br><a target="_blank" rel="noopener" href="http://m.v4.cc/News-966281.html">Jenkins进阶系列之——01使用email-ext替换Jenkins的默认邮件通知</a><br>Email Extension Plugin配置详情参见如下：<br>Manage Jenkins -&gt; Configure System -&gt; Extended E-mail Notification<br><img src="/img/Unity/ExtendedEmailNotificationPart1.png" alt="ExtendedEmailNotificationPart1"><br>针对workspace自定义邮件内容配置如下：<br><img src="/img/Unity/WorkspaceExtendedEmailSetting.png" alt="WorkspaceExtendedEmailSetting"><br>最终收到Email提醒:<br><img src="/img/Unity/EmailResult.PNG" alt="EmailResult"></p>
<h6 id="Unity3D-Plugin"><a href="#Unity3D-Plugin" class="headerlink" title="Unity3D Plugin"></a>Unity3D Plugin</h6><p>管理插件-&gt;<a target="_blank" rel="noopener" href="https://plugins.jenkins.io/unity3d-plugin">Unity3d Plugin</a><br>Unity本身是支持从命令行启动U3D，执行Editor特定方法的。<br>但Unity3D Plugin是一个针对Jenkins集成Unity命令行的插件，可以帮助我们直接在Jenkins上编写U3D命令，对于Jenkins更加友好。<br>好处如下:</p>
<ol>
<li>Log file redirection(Log重定位到Jenkins界面)</li>
<li>Distributed builds(分布式编译)</li>
</ol>
<p><strong>Unity3D Plugin实战配置</strong></p>
<ol>
<li>Configure Unity Installation Path<br>System Setting -&gt; Global Tool Configuration<br><img src="/img/Unity/JenkinsUnityPathConfiguration.PNG" alt="JenkinsUnityPathConfiguration"></li>
<li>编写Unity下可通过命令行调用的代码</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UnityBuild</span> &#123;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Custom/UnityBuild/OneKeyBuild&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OneKeyBuild</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;OneKeyBuild() Called!&quot;</span>);   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置Unity命令行运行启动以及参数<br><img src="/img/Unity/JenkinsUnityMethodCall.PNG" alt="JenkinsUnityMethodCall"><br><img src="/img/Unity/JenkinsUnityMethodCallOutput.PNG" alt="JenkinsUnityMethodCallOutput"><br>从上面可以看出我们成功的配置了Jenkins以及对于Unity打包方法的调用(在这一步我们可以做很多我们自己对于Unity打包的流程设置，资源打包或者其他的预处理等)</li>
<li>编写完整的打包设置以及相关预处理代码<br>待续…….<br>接下来是为了在IOS进行Jenkins自动化打包而设置的步骤</li>
<li>在IOS搭配SmartSVN拉VisualSVN上的文件(Windows上用TortoiseSVN作为SVN客户端即可)</li>
<li>在IOS上配置Jenkins(和Windows上类似，需要下载Java支持Jenkins运行)<br>这里讲几个配置搭建Mac OSX的Jenkins时遇到的坑：<ol>
<li>配置Unity插件Unity安装路径问题<br>Windows上是到Editor上一层即可。IOS是到Unity.app这一层(Unity.app(e.g. &#x2F;Applications&#x2F;Unity&#x2F;Unity.app&#x2F;)在命令行里可以往里访问)</li>
<li>指定IOS Subversion URL(e.g. <a target="_blank" rel="noopener" href="https://192.168.1.3/svn/***)%E6%97%B6%E6%98%BE%E7%A4%BA%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E6%88%96%E8%80%85%E4%B8%8D%E6%AD%A3%E7%A1%AE%E7%9A%84credential">https://192.168.1.3/svn/***)时显示无法访问或者不正确的credential</a>(这里是因为默认的Mac SVN版本过低需要更新Mac OSX自带的SVN)</li>
<li>更新Mac OSX自带SVN时在添加新装的SVN到环境变量里后依然显示是老版的SVN<br>在~&#x2F;目录下touch .bash_profile(创建.bash_profile)<br>然后添加环境变量路径export PATH&#x3D;”&#x2F;opt&#x2F;subversion&#x2F;bin;$PATH”<br>使其环境变量路径设置生效source .bash_profile<br>查看当前SVN版本svn –version<br>如果上一步依然显示是旧版SVN且当前系统是10.11<br>那么我们就需要删除Mac OSX上原本的SVN以实现更新SVN的目的<br>查看旧版SVN路径which svn<br>删除旧版SVN(sudo -s rm -rf &#x2F;svnpath&#x2F;svn*)(此时如果出现No Permission to remove，那么恭喜，你是用的10.11系统。10.11推出了SIP(System Integrity Protection)机制去防止root用户对于部分文件的操作权限限制用于防止病毒破坏或修改重要文件)<br>为了能够删除旧版SVN，这里我们需要进到Recover Mode去临时关闭SIP(重启电脑一直按住cmd+R，然后在terminal里执行csrutil disable，关闭成功后就可以重启电脑去删除旧版svn了)<br>然后将新版SVN链接到旧版SVN执行路径(sudo -s ln -s &#x2F;opt&#x2F;subversion&#x2F;bin&#x2F;svn* &#x2F;svnpath)<br>最后到Recover Mode里恢复SIP(csrutil enable)</li>
<li>打包IOS时报错：_RegisterApplication(), FAILED TO establish the default connection to the WindowServer, _CGSDefaultConnection() is NULL.<br>这是因为Jenkins默认安装时是以Jenkins作为用户和组。开机自启动时也是以Jenkins用户和组来运行的。而Unity我是默认安装在我自己的用户apple和admin组下。所以在Jenkins需要启动Unity时应该是没有权限调用 Unity Editor 的命令行。所以我们要做的就是确保Unity和Jenkins运行在同一个User和Group下。<br>以下采用把Jenkins改到apple和wheel下运行以支持Unity的命令行运行。<br>详情参见<a target="_blank" rel="noopener" href="http://7dot9.com/2016/11/18/macos-jenkins-ci-unity-setup-config-guide/">macOS 安装配置 Jenkins 持续集成 Unity 项目指南</a></li>
<li>指定Custom Workspace(自定义到桌面特定目录后每次都报Failed to mkdir，这个跟第四个问题是同一个问题，默认Jenkins用户权限问题)</li>
</ol>
</li>
</ol>
<p>Note:<br>很多文件是Unity自动生成的(比如Library目录)，我们无需加入版本管理(SVN只要不加入版本管理即可)</p>
<p>Note:<br>Unity3d Plugin不支持在Pipeline里添加。<br>同时Unity3d Plugin只在3.4.2 to 5.0.1的版本下测试过。(经本人测试在Unity5.4.0f3的版本也能正常使用)</p>
<h4 id="Jenkins从零搭建"><a href="#Jenkins从零搭建" class="headerlink" title="Jenkins从零搭建"></a>Jenkins从零搭建</h4><p>这里的从零搭建，在借助Jenkins插件的基础上，尽量采用Pipeline编写为主，插件UI为辅的方式来实现一整套完整的Jenkins自动化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">#!groovy</span><br><span class="line">pipeline &#123;</span><br><span class="line">    //agent指定jenkins从哪里以及如何执行pipeline</span><br><span class="line">    //any表示从any available agent处执行</span><br><span class="line">    agent any</span><br><span class="line">    </span><br><span class="line">    //看定义在那一层，就只针对那一层起作用(pipeline一层针对pipeline。stage一层针对特定stage)</span><br><span class="line">    //也可以修改已定义的环境变量值</span><br><span class="line">    environment &#123;</span><br><span class="line">        UNITY_PROJECT_PATH = &#x27;E:\\TonyTang\\Work\\Projects\\MyGitHubProjects\\GitStudy2&#x27;</span><br><span class="line">        GIT_URL = &#x27;git@github.com:TonyTang1990/GitStudy.git&#x27;</span><br><span class="line">        GIT_AUTH = &#x27;7d947f92-1e9c-44ba-9a80-9744f92f2ff6&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //自定义参数</span><br><span class="line">    //可以通过pipeline代码编写，也可以直接在web UI界面上添加</span><br><span class="line">    parameters&#123;</span><br><span class="line">        string(name: &#x27;Platform&#x27;, defaultValue: &#x27;Android&#x27;, description: &#x27;Which plaftform is using?&#x27;)</span><br><span class="line">        booleanParam(name: &#x27;DEBUG_BUILD&#x27;, defaultValue: true, description: &#x27;Is debug version?&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;postprocess&#x27;)&#123;</span><br><span class="line">            //when表示执行条件判断</span><br><span class="line">            //决定stage是否应该执行</span><br><span class="line">            when&#123;</span><br><span class="line">                expression</span><br><span class="line">                &#123;</span><br><span class="line">                    return params.DEBUG_BUILD</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps&#123;</span><br><span class="line">                //params是访问pipeline里定义的所有parameters入口</span><br><span class="line">                echo &quot;Current platform is $&#123;params.Platform&#125;&quot;</span><br><span class="line">                echo &#x27;postprocess&#x27;</span><br><span class="line">                echo &quot;$&#123;env.UNITY_PROJECT_PATH&#125;&quot;</span><br><span class="line">                echo &quot;$&#123;env.GIT_URL&#125;&quot;</span><br><span class="line">                echo &quot;$&#123;env.GIT_AUTH&#125;&quot;</span><br><span class="line">                //env是jenkins定义的全局的环境变量</span><br><span class="line">                //http://localhost:8080/job/TonyTangPipeline/pipeline-syntax/globals</span><br><span class="line">                echo env.WORKSPACE</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Git&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Git operation&#x27;</span><br><span class="line">                checkout([$class: &#x27;GitSCM&#x27;, </span><br><span class="line">                        userRemoteConfigs: [[url: &quot;$&#123;env.GIT_URL&#125;&quot;, credentialsId: &quot;$&#123;env.GIT_AUTH&#125;&quot;]],</span><br><span class="line">                        extensions: [[$class: &#x27;CleanBeforeCheckout&#x27;, $class: &#x27;GitLFSPull&#x27;]]</span><br><span class="line">                        ])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                //Windows调用bat</span><br><span class="line">                //Mac Linux采用sh</span><br><span class="line">                bat &#x27;BatAutomation&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;deploy&#x27;)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                echo &#x27;deploy&#x27;</span><br><span class="line">                //支持调用python</span><br><span class="line">                bat &#x27;python PythonAutomation.py&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //post表示Pipeline执行完之后执行，做一些clean up操作</span><br><span class="line">    post &#123;</span><br><span class="line">        //根据pipeline的结果做特定操作</span><br><span class="line">        always&#123;</span><br><span class="line">            echo &#x27;Always!&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo &#x27;Success!&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">        failure&#123;</span><br><span class="line">            echo &#x27;Failed!&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Script Pipeline(Optional)</span><br><span class="line">//在pipeline执行完成之后执行</span><br><span class="line">//支持大部分Groovy</span><br><span class="line">//Script Pipeline的参数定义需要在properties里</span><br><span class="line">properties([parameters([string(defaultValue: &#x27;Android&#x27;, description: &#x27;Which platform is using?&#x27;, name: &#x27;Platform&#x27;)])])</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    //定义字符串</span><br><span class="line">    def Date = &#x27;2017//4//26&#x27;</span><br><span class="line">    stage(&#x27;postprocess&#x27;) &#123;</span><br><span class="line">        //要使用$&#123;&#125;访问string，需要用&quot;&quot;</span><br><span class="line">        echo &quot;Date = $&#123;Date&#125;&quot;</span><br><span class="line">        echo &quot;Current platform is $&#123;params.Platform&#125;&quot;</span><br><span class="line">        echo &#x27;postprocess....&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&#x27;build&#x27;) &#123;</span><br><span class="line">        echo &#x27;build....&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&#x27;deploy&#x27;) &#123;</span><br><span class="line">        echo &#x27;deploy....&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>













<h4 id="脚本语言"><a href="#脚本语言" class="headerlink" title="脚本语言"></a>脚本语言</h4><p>为了快速编写一些自动化任务，我们往往需要用到脚本语言。</p>
<h5 id="bat"><a href="#bat" class="headerlink" title="bat"></a>bat</h5><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%89%B9%E6%AC%A1%E6%AA%94">批处理文件（英语：Batch file），又称批次档，在DOS、OS&#x2F;2、微软视窗系统中，是一种用来当成脚本语言运作程序的文件。它本身是文本文件，其中包含了一系列让具备命令行界面的解释器读取并运行的指令。它相当于是类Unix系统下的Shell script。</a></p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">:: 关闭命令输出打印</span><br><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">:: UTF8</span><br><span class="line"><span class="built_in">chcp</span> <span class="number">65001</span></span><br><span class="line">:: 清除命令行界面内容</span><br><span class="line"><span class="built_in">CLS</span></span><br><span class="line">:: 输出打印信息</span><br><span class="line"><span class="built_in">echo</span> Tony Tang bat study</span><br><span class="line">:: 设置打印传入参数</span><br><span class="line"><span class="built_in">set</span> par1=%<span class="number">1</span></span><br><span class="line"><span class="built_in">set</span> par2=%<span class="number">2</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%par1%</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%par2%</span></span><br><span class="line">:: 输出打印当前目录路径</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%cd%</span></span><br><span class="line">:: 切换到上一层路径</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">:: 输出打印当前目录路径</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%cd%</span></span><br><span class="line">:: 切换到BatStudy目录</span><br><span class="line"><span class="built_in">cd</span> BatStudy</span><br><span class="line">:: 输出打印当前目录路径</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%cd%</span></span><br><span class="line">:: 打印帮助信息</span><br><span class="line">::<span class="built_in">HELP</span></span><br><span class="line">:: 自定义变量(定义变量时=号两边不能有空格)</span><br><span class="line"><span class="built_in">set</span> batvariable=tonytang</span><br><span class="line">:: 打印自定义变量</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%batvariable%</span></span><br><span class="line">:: 自定义数字变量</span><br><span class="line"><span class="built_in">set</span> number=<span class="number">3</span></span><br><span class="line">:: 打印自定义数字变量</span><br><span class="line"><span class="built_in">echo</span> number = <span class="variable">%number%</span></span><br><span class="line">:: 条件语句</span><br><span class="line"><span class="keyword">if</span> <span class="variable">%number%</span>==<span class="number">2</span> (<span class="built_in">echo</span> <span class="variable">%number%</span>==<span class="number">2</span>) <span class="keyword">else</span> (<span class="built_in">echo</span> <span class="variable">%number%</span>!=<span class="number">2</span>)</span><br><span class="line">:: 检查文件是否存在</span><br><span class="line"><span class="built_in">set</span> filename=batcontent.txt</span><br><span class="line"><span class="built_in">echo</span> filename=<span class="variable">%filename%</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">EXIST</span> ./<span class="variable">%filename%</span> (<span class="built_in">echo</span> <span class="variable">%filename%</span> exits) <span class="keyword">else</span> (<span class="built_in">echo</span> <span class="variable">%filename%</span> <span class="keyword">not</span> <span class="keyword">exist</span>)</span><br><span class="line">:: 普通循环语句</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%i</span> <span class="keyword">in</span> (<span class="number">1</span> <span class="number">2</span> <span class="number">3</span>) <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">%%i</span></span><br><span class="line">:: 当前目录文件循环遍历语句</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%f</span> <span class="keyword">in</span> (*) <span class="keyword">do</span> @<span class="built_in">echo</span> <span class="variable">%%f</span></span><br><span class="line">:: 启用变量执行时解析</span><br><span class="line"><span class="built_in">SetLocal</span> EnableDelayedExpansion</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%i</span> <span class="keyword">in</span> (<span class="number">1</span> <span class="number">2</span> <span class="number">3</span>) <span class="keyword">do</span> (</span><br><span class="line">	<span class="built_in">set</span> numberVariable=<span class="variable">%%i</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">!numberVariable!</span></span><br><span class="line">	<span class="built_in">set</span> numberVariable=<span class="variable">!numberVariable!</span>+<span class="variable">!numberVariable!</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">!numberVariable!</span></span><br><span class="line">)</span><br><span class="line">:: 暂停等待输入</span><br><span class="line"><span class="built_in">pause</span></span><br><span class="line">:: 退出命令界面 <span class="number">0</span>代表正常退出</span><br><span class="line"><span class="keyword">EXIT</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Bash/BatStudyOutput.png" alt="BatStudyOutput"></p>
<p>这里只列举一些常用基础的，详细Windows Batch学习参考:<br><a target="_blank" rel="noopener" href="http://www.trytoprogram.com/batch-file/">Batch file – Programming tutorial</a><br><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/batch_script/index.htm">Batch Script Tutorial</a></p>
<h5 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h5><p>Windows上的bat，power shell<br>Linux上的shell<br>好处：<br>简单快速的编写一些系统相关的任务(比如文件复制等)<br>缺点：<br>有平台差异</p>
<p>在正式学习Shell之前，让我们依然从What，How，Why，When这四个问题着手：<br>What?<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix_shell">Unix shell，一种壳层与命令行界面，是UNIX操作系统下传统的用户和计算机的交互界面。第一个用户直接输入命令来执行各种各样的任务。</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix_shell">第一个Unix shell是由肯·汤普逊，仿效Multic上的shell所实现出来，称为sh。</a></p>
<p>后续出了其他的Shell:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Bash">Bourne-Again shell - bash</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Debian_Almquist_shell">Debian Almquist shell - dash</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Korn_shell">Korn shell - ksh</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Z_shell">Z shell - zsh</a></li>
</ol>
<p>上面的几个Shell都可以看作是后续发展功能越来越强大的Shell解析器，至于具体分别包含些什么功能就不在本文讨论的范围内了。这里我们主要以bash和shell作为解析器来学习编写shell脚本。</p>
<p>How?<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Shell%E8%84%9A%E6%9C%AC">Shell脚本（英语：Shell script），又称Shell命令稿、程序化脚本，是一种计算机程序与文本文件，内容由一连串的shell命令组成，经由Unix Shell直译其内容后运作。被当成是一种脚本语言来设计，其运作方式与解释型语言相当，由Unix shell扮演命令行解释器的角色，在读取shell脚本之后，依序运行其中的shell命令，之后输出结果。利用shell脚本可以进行系统管理，文件操作等。</a></p>
<p>可以看出Shell脚本是被当做脚本语言来解释执行，通过调用系统内核的一些工具来实现特定功能任务的。</p>
<p>Why?<br>Shell并不适合编写复杂的程序任务，因为他只提供了一些比较基础的工具，并且不具备面向对象编程等高级语言的特性。<br>既然如此那我们为何还要坚持使用Shell了？为何不直接选择Python，Ruby，Perl这些相对高级一点的解释性语言了？<br>理论上是可以的，但Shell属于原生就具备提供的工具，可以很快捷的编写出一些看似简单但却方便的工具脚本。即使Python可以实现，但针对特定的功能可能没有Shell来的那么快捷方便，根据需求选择合适的脚本语言也是很重要的。后续我会结合Python夸平台的特性，使用Python结合Shell编写一些自动化相关的工具。</p>
<p>Note:<br>Shell跟操作系统紧密相关，原本并非跨系统平台的，但通过移植很多shell具备了跨系统平台的能力(Windows上通过Cygwin与MinGW可以模拟执行Unix Shell)。</p>
<p>When?<br>那么什么时候适合用Shell了？从前面三个问题不难看出，Shell只适合用于一些不复杂的功能任务里，无论是语言特性还是跨平台都没有Python那些高级语言支持的好。如果需要实现复杂的且跨平台，需要高级语言特性(面向对象等)时，不应该考虑Shell而是Python，Perl，Ruby这些。 </p>
<p>Note:<br>这里所说的shell和Window的batch并不是同一个东西。</p>
<h6 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h6><ul>
<li>指定解析器</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Proper header for a Bash script</span><br></pre></td></tr></table></figure>

<p>**#!**是two-byte的magic number<br>表示这个文本是executable shell script，后面紧跟的&#x2F;bin&#x2F;bash表示shell解析器是用的bash</p>
<ul>
<li>输出打印<br>学程序，最初开始的地方肯定是Hello World。<br>在bash里打印输出是通过<strong>echo</strong>指令。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Proper header for a Bash script</span><br><span class="line">echo &quot;Hello World&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Bash/BashEcho.png" alt="Bash echo"></p>
<ul>
<li>特殊符号</li>
</ul>
<ol>
<li>井号(#) – 注释符号</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Proper header for a Bash script(这一行#号开头表示注释)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>; – 命令分隔符(允许同一行多个指令)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#! /bin.bash</span><br><span class="line">echo &quot;Hello&quot;; echo &quot;World&quot;</span><br></pre></td></tr></table></figure>

<pre><code>![CommandSeparator](/img/Bash/CommandSeparator.png)
</code></pre>
<ol start="3">
<li>;; – 跳出case语句</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">variable=&quot;TonyTang&quot;</span><br><span class="line">case &quot;$variable&quot; in</span><br><span class="line">    TonyTang) echo &quot;TonyTang1&quot;;;</span><br><span class="line">    TonyTang) echo &quot;TonyTang2&quot;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<pre><code>![TerminateCommand](/img/Bash/TerminateCommand.png)
</code></pre>
<ol start="4">
<li>.<ul>
<li>表示文件是隐藏的</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">touch .hidden-file</span><br><span class="line">ls -l</span><br><span class="line">ls -al</span><br></pre></td></tr></table></figure>

<pre><code>![HidenProfileCommand](/img/Bash/HidenProfileCommand.png)
- 表示当前目录
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwd</span><br><span class="line">cd .</span><br><span class="line">pwd</span><br></pre></td></tr></table></figure>

<pre><code>![CurrentDirectoryCommand](/img/Bash/CurrentDirectoryCommand.png)
- 正则里面表示匹配单个字母
</code></pre>
<ol start="5">
<li>“” - 字符串(保留大部分特殊符号)</li>
<li>‘’ - 字符串(保留所有特殊符号)</li>
<li>,</li>
<li>\ - 反斜杠，忽略特殊符号</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">echo &quot;\&quot;Hello World&quot;\&quot;</span><br></pre></td></tr></table></figure>

<pre><code>![Backslash](/img/Bash/Backslash.png)
</code></pre>
<ol start="9">
<li>&#x2F; - 文件路径分隔符</li>
<li>: - 相当于内置true</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">while :</span><br><span class="line">do</span><br><span class="line">    echo &quot;Number 1&quot;</span><br><span class="line">    echo &quot;Number 2&quot;</span><br><span class="line">    echo &quot;Number 3&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<pre><code>![ColonOperator](/img/Bash/ColonOperator.png)
</code></pre>
<ol start="11">
<li>! - 取反</li>
<li>星号(*) - 通配符或者乘法</li>
<li>? - 三目运算符或者表示测试条件</li>
<li>$<ul>
<li>$ 变量取值符号</li>
<li>$? 退出状态码</li>
<li>$$ 进程号</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">var1=100</span><br><span class="line">echo &quot;var1 = $var1&quot;</span><br><span class="line">echo $?</span><br><span class="line">echo $$</span><br></pre></td></tr></table></figure>

<pre><code>![VariableSubstitution](/img/Bash/VariableSubstitution.png)
</code></pre>
<ol start="15">
<li><blockquote>
<p>&amp;&gt; &gt;&amp; &gt;&gt; &lt; &lt;&gt; </p>
</blockquote>
<ul>
<li><blockquote>
<p>&amp;&gt; 重定向输出到指定文件</p>
</blockquote>
</li>
<li><p>&lt;&gt; 文件读取</p>
</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">ls -l</span><br><span class="line">echo &quot;Hello World&quot; &gt;HelloWorldFile.txt</span><br><span class="line">ls -l</span><br><span class="line">cat HelloWorldFile.txt</span><br></pre></td></tr></table></figure>

<pre><code>![RedirectionCommand](/img/Bash/RedirectionCommand.png)
</code></pre>
<ol start="16">
<li>~ ~+ - home目录和当前目录</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo ~</span><br><span class="line">echo $HOME</span><br><span class="line">echo ~+</span><br><span class="line">echo $PWD</span><br></pre></td></tr></table></figure>

<pre><code>![FolderCommands](/img/Bash/FolderCommands.png)
</code></pre>
<ol start="17">
<li>&#96; - 命令执行符号(可以用于快速执行命令并将结果复制)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Date=`date +%Y%m%d%H%M%S`</span><br><span class="line">echo $Date</span><br></pre></td></tr></table></figure>

<pre><code>![CommandsSubstitution](/img/Bash/CommandsSubstitution.png)
</code></pre>
<ul>
<li>Shell小知识</li>
</ul>
<ol>
<li><p>$0 - $9<br>$0表示Shell文件名<br>$1-$9表示Shell的第一个到第九个参数</p>
</li>
<li><p>ls -l<br>查看文件详细信息(比如读写权限等)<br><img src="/img/Bash/LSCommand.png" alt="LSCommand"><br>具体如何理解最前面的权限信息，参考<a target="_blank" rel="noopener" href="http://cn.linux.vbird.org/linux_basic/0210filepermission.php">第六章、Linux 的文件权限与目录配置</a></p>
</li>
<li><p>chmod<br>修改文件权限</p>
</li>
<li><p>cd<br>切换目录</p>
</li>
<li><p>pwd or ~+<br>当前所在目录</p>
</li>
<li><p>echo<br>输出信息</p>
</li>
<li><p>exit<br>退出shell</p>
</li>
<li><p>$?<br>前一段shell的返回输出值</p>
</li>
<li><p>$ or ${}<br>去变量值</p>
</li>
<li><p><br>多行shell支持</p>
</li>
<li><p>$SHELL<br>从当前Shell执行结束的地方打开一个新的terminal窗口(能保持之前所有的输出信息都在)</p>
</li>
</ol>
<p>待续……</p>
<h5 id="Python-严格意义上不算脚本语言"><a href="#Python-严格意义上不算脚本语言" class="headerlink" title="Python(严格意义上不算脚本语言)"></a>Python(严格意义上不算脚本语言)</h5><p>好处：</p>
<ol>
<li>跨平台</li>
<li>解释性语言，开发方便快速</li>
<li>库丰富<br>待续……</li>
</ol>
<h4 id="IOS自动化打包"><a href="#IOS自动化打包" class="headerlink" title="IOS自动化打包"></a>IOS自动化打包</h4><h5 id="IOS打包准备"><a href="#IOS打包准备" class="headerlink" title="IOS打包准备"></a>IOS打包准备</h5><ol>
<li><p>Apple Account(发布到IOS设备上需要)<br>任何账号都可以发布到自己的设备测试，但是如果要使用GC or In-App Purchases或者发布到App Store的话需要注册Apple Developer Program。</p>
</li>
<li><p>Xcode(up-to-date version)<br>因为Xcode是Mac上的软件，所以这里需要Mac电脑或者是黑苹果。(开发所需的SDK，IDE套装都在这)</p>
</li>
<li><p>Adding your Apple ID to Xcode<br>Open Xcode -&gt; Xcode -&gt; Preferences -&gt; Account -&gt; </p>
</li>
<li><p>在开发之前，Mac需要获得IOS Certificartes(用于对Mac开发授权，程序签名等)<br>登陆Apple Developer Program -&gt; Certificates ,identifiers &amp; Profiles -&gt; Certificate Signing Request<br>Create CSR(Certificate Signing Request):</p>
<ol>
<li>Folder -&gt; Utilities Folder -&gt; Keychain Access</li>
<li>Keychain Access -&gt; Certificate Assistant -&gt; Request a Certificate from a Certificate Authority -&gt; 填完内容存储到本地<br>CSR里包含了public key和private key。<br>当CSR创建以后，需要使用CSR去请求一个Certificate:</li>
<li>上传CSR</li>
<li>下载Certificate</li>
<li>运行安装Certificate<br>安装Certificate后public和private key pair就生成了(在Keychain Access下可以查看)<a target="_blank" rel="noopener" href="http://www.cnblogs.com/zhaoyang/p/3582436.html">而我们的应用程序签名是使用私钥来签名用公钥来进行验证,  而苹果生成的Certificate 只包含了公钥,当你用自己的私钥签名后,苹果会用公钥来进行验证,确保是你自己对程序签名而不是别人冒充的</a><br>通过导出共享公钥和私钥，可以实现共同开发(Mac开发授权，程序签名等)。</li>
</ol>
</li>
<li><p>设置App ID(相当于Android包名，用于识别App)<br>App ID包含以下组成部分：</p>
<ol>
<li>Prefix – 作为Team ID</li>
<li>Suffix – 作为Build ID的搜索字符串(可指定通配符)</li>
<li>AppServices – 指定包含的Service(比如Game Center， IAP， iCloud等服务)，只有指定了这些，使用包含了此APP ID的Provision Profile才能使用特定服务</li>
</ol>
</li>
<li><p>添加设备列表(只有被添加了的设备列表才能用于安装和测试程序)<br>需要通过Itunes查看UDID，然后添加到设备列表。</p>
</li>
<li><p>用上述我们创建的Certificate, Apple ID, Devices List等生成我们的Provision Profile(Unity Cloud Build的时候需要指定)<br>不同的Provision Profile有不同的用处，比如iPhone Developer证书用于测试设备上运行，iPhone Distribution证书用于提交应用到App Store。<br>让我们来理解一些相关概念，下文引用至<a target="_blank" rel="noopener" href="http://www.cnblogs.com/zhaoyang/p/3582436.html">IOS开发 证书总结</a><br> Identifier:<br> 顾名思义App ID（application id, not apple id）, 对于你的一个或者一组app他们的唯一标识, 这个App ID跟你Xcode中的Targets —–&gt; General—–&gt; Identity中的Bundle Identifier是匹配的,(其余的那些推送服务啊什么的都是配置在APP ID下面的) 如下图:</p>
<p> Provisioning Profile<br> 一个Provisioning Profile包含了上述所有内容 Certificate &amp;&amp; App ID &amp;&amp; Device, 这个Provisioning Profile文件会在打包时嵌入到.ipa的包里,如下图: </p>
<p> 所以一台设备上运行应用程序的过程如下(以Developer Provisioning Profile为例):<br> 1 检查app 的 bunld ID 是否 matches Provisioning Profile 的 App ID<br> 2 检查 app 的 entitements 是否 matches Provisioning Profile 的 entitements<br> 3 用Certificate来验证签名签名<br> 4 检查此设备的UDID是否存在于 Provisioning Profiles中 （仅在 非发布证书中）</p>
<p> 如何创建?<br> 在 Provisioning Profiles 中点加号,然后依次选择App ID, Certificate, Devices(development),再指定名称,最后下载, 双击则安装到Xcode中</p>
<p> Xcode中的配置<br> Project &amp;&amp; Target 的 build settings 中搜索Code sign…<br> 然后分别选好对应的证书,如果选择列表中没有刚才创建的证书可以双击直接复制名字上去 </p>
<p> 关于推送服务<br> 基于上面的操作，如果需要推送服务我们还需要申请一个推送证书<br> 依次进入 Certificates —&gt;Production —&gt;Apple Push Notification service SSL (Production)<br> 然后选择需要推送服务的App ID<br> 再选择前面创建的.cerSigningRequest文件<br> 最后点击generated生成推送证书<br>IOS开发流程大致如下：<br><img src="/img/Unity/IOSAppDistributionWorkflows.PNG" alt="IOSAppDistributionWorkflows"></p>
</li>
</ol>
<h5 id="XUPorter-or-Unity-API-PBXFroject"><a href="#XUPorter-or-Unity-API-PBXFroject" class="headerlink" title="XUPorter or Unity API(PBXFroject)"></a>XUPorter or Unity API(PBXFroject)</h5><p>PBXFroject是Unity 5.X版本加进来的。因为5.X以前没有关于XCode自动化修改的相关接口，所以以前的版本用的都是XUPoter这个第三方插件工具来实现自动化修改info.plist文件，自动添加library之类的功能。</p>
<p>本人只使用过XUPoter还没详细使用PBXProject，但XUPoter的作者在Unity 5.X开始已经不在更新支持了，因为有了PBXProject，所以可以这样说，Unity 5.X版本开始可以直接使用Unity 5.X不需要再使用XUPoter了。</p>
<h6 id="XUPoter"><a href="#XUPoter" class="headerlink" title="XUPoter"></a>XUPoter</h6><p>这里直接给出作者工具链接，就不详细讲解如何集成使用了，具体参考官方作者网站。<br><a target="_blank" rel="noopener" href="https://github.com/onevcat/XUPorter">onevcat&#x2F;XUPorter</a></p>
<h6 id="PBXProject"><a href="#PBXProject" class="headerlink" title="PBXProject"></a>PBXProject</h6><p>对IOS的打包后的XCode工程做后处理，我们需要在代码里实现IPostProcessBuild接口的OnPostProcessBuild方法。</p>
<p>XcodePostProcess.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">UnityEditor.iOS.Xcode</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">XCodePostProcess</span> : <span class="title">IPostprocessBuild</span></span><br><span class="line"></span><br><span class="line">    <span class="title">public</span> <span class="title">void</span> <span class="title">OnPostprocessBuild</span>(<span class="title">BuildTarget</span> <span class="title">target</span>, <span class="title">string</span> <span class="title">path</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;XCodePostProcess.OnPostprocessBuild for target &quot;</span> + target + <span class="string">&quot; at path &quot;</span> + path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过PBXProject访问并修改XCode工程相关的设置</span></span><br><span class="line">        <span class="built_in">string</span> projpath = path + <span class="string">&quot;/Unity-iPhone.xcodeproj/project.pbxproj&quot;</span>;</span><br><span class="line">        PBXProject proj = <span class="keyword">new</span> PBXProject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取XCode项目的数据</span></span><br><span class="line">        proj.ReadFromString(File.ReadAllText(projPath));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取XCode项目的Unity Target名字</span></span><br><span class="line">        <span class="built_in">string</span> nativetargetname = PBXProject.GetUnityTargetName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取XCode项目的Unity Target的GUID</span></span><br><span class="line">        <span class="built_in">string</span> nativeTarget = proj.TargetGuidByName(nativetargetname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取XCode项目的Test Target名字</span></span><br><span class="line">        <span class="built_in">string</span> testTarget = proj.TargetGuidByName(PBXProject.GetUnityTestTargetName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置需要设定的target列表</span></span><br><span class="line">        <span class="built_in">string</span>[] buildTargets = <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; nativeTarget, testTarget &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//BitCode是用于提交AppStore后优化数据用的，IOS上是optional，但watchOS和tvOS是必须的。动态设置BitCode值</span></span><br><span class="line">        proj.SetBuildProperty(buildTargets, <span class="string">&quot;ENABLE_BITCODE&quot;</span>, <span class="string">&quot;NO&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//动态修改UnityAppController.mm文件的arc编译参数</span></span><br><span class="line">        ArcOnFileByProjectPath(proj, nativetargetname, <span class="string">&quot;Classes/UnityAppController.mm&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自动化删除ReleaseForProfiling和ReleaseForRunning两个Configuration</span></span><br><span class="line">        proj.RemoveBuildConfig(<span class="string">&quot;ReleaseForProfiling&quot;</span>);</span><br><span class="line">        proj.RemoveBuildConfig(<span class="string">&quot;ReleaseForRunning&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//整个XCode项目数据写回去</span></span><br><span class="line">        File.WriteAllText(projPath, proj.WriteToString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开启或关闭指定target的指定文件的arc(Automatic Reference Counting)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;proj&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;targetname&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filepath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isenablearc&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ArcOnFileByProjectPath</span>(<span class="params">PBXProject proj, <span class="built_in">string</span> targetname, <span class="built_in">string</span> filepath, <span class="built_in">bool</span> isenablearc</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> targetguid = proj.TargetGuidByName(targetname);</span><br><span class="line">        <span class="keyword">var</span> fileguid = proj.FindFileGuidByProjectPath(filepath);</span><br><span class="line">        Debug.Log(<span class="string">&quot;targetguid = &quot;</span> + targetguid);</span><br><span class="line">        Debug.Log(<span class="string">&quot;fileguid = &quot;</span> + fileguid);</span><br><span class="line">        <span class="keyword">var</span> compileflaglist = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="keyword">if</span>(isenablearc)</span><br><span class="line">        &#123;</span><br><span class="line">            compileflaglist.Add(<span class="string">&quot;-fobjc-arc&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            compileflaglist.Add(<span class="string">&quot;-fno-objc-arc&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        proj.SetCompileFlagsForFile(targetguid, fileguid, compileflaglist);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就不一一截Mac对应的图了，示例代码对XCode的各种参数设置都进行了修改，注释也很清楚了，具体详细的使用，请参考官网API解释。</p>
<h4 id="IOS自动化签包"><a href="#IOS自动化签包" class="headerlink" title="IOS自动化签包"></a>IOS自动化签包</h4><p><a target="_blank" rel="noopener" href="https://developer.apple.com/legacy/library/documentation/Darwin/Reference/ManPages/man1/xcodebuild.1.html">Xcodebuild</a>是XCode上编译Xcode工程的工具。</p>
<p>所以接下来我们主要是要学习的是使用Xcodebuild去编写自动化签包的工具。</p>
<p>学习XCode Project项目里的一些相关概念。<br>一下概念来源<a target="_blank" rel="noopener" href="https://www.cnblogs.com/cy568searchx/p/5781717.html">iOS系统提供开发环境下命令行编译工具：xcodebuild</a>:</p>
<ol>
<li>Workspace：简单来说，Workspace就是一个容器，在该容器中可以存放多个你创建的Xcode Project， 以及其他的项目中需要使用到的文件。<br>使用Workspace的好处有：<ul>
<li>扩展项目的可视域，即可以在多个项目之间跳转，重构，一个项目可以使用另一个项目的输出。Workspace会负责各个Project之间提供各种相互依赖的关系;</li>
<li>多个项目之间共享Build目录。</li>
</ul>
</li>
<li>Project：指一个项目，该项目会负责管理生成一个或者多个软件产品的全部文件和配置，一个Project可以包含多个Target。</li>
<li>Target：一个Target是指在一个Project中构建的一个产品，它包含了构建该产品的所有文件，以及如何构建该产品的配置。</li>
<li>Scheme：一个定义好构建过程的Target成为一个Scheme。可在Scheme中定义的Target的构建过程有：Build&#x2F;Run&#x2F;Test&#x2F;Profile&#x2F;Analyze&#x2F;Archive</li>
<li>BuildSetting：配置产品的Build设置，比方说，使用哪个Architectures？使用哪个版本的SDK？。在Xcode Project中，有Project级别的Build Setting，也有Target级别的Build Setting。Build一个产品时一定是针对某个Target的，因此，XCode中总是优先选择Target的Build Setting，如果Target没有配置，则会使用Project的Build Setting。</li>
</ol>
<p>了解了XCode Project中的一些概念，让我们看看Xcodebuild到底是什么样的工具了？<br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/technotes/tn2339/_index.html">xcodebuild is a command-line tool that allows you to perform build, query, analyze, test, and archive operations on your Xcode projects and workspaces from the command line. It operates on one or more targets contained in your project, or a scheme contained in your project or workspace. </a></p>
<p>如果想查看xcodebuild的详细说明，我们可以通过命令行输入:man xcodebuild查看即可:<br><img src="/img/Bash/XcodebuildManualPage.png" alt="XcodebuildManualPage"></p>
<p>首先以XcodeProject为例，我们来看看上面的概念在实际操作过程中对应的东西:<br><img src="/img/Bash/XcodeProjectDemo.png" alt="XcodeProjectDemo"><br>从上面可以看出，我们的Demo Xcode Project是没有workspace的，只有一个叫做Unity-iPhone.xcodeproj的Xcode工程文件，而这个文件对应的就是我们前面提到的Project的概念。</p>
<p>如果我们想查看Xcode Project里面的相关schemes或者target信息，我们可以通过命令行切换到Xcode Project目录下然后输入xcodebuild -list -project *.xcodeproj命令来查看:<br><img src="/img/Bash/XcodeProjectListInfo.png" alt="XcodeProjectListInfo"><br>从上面的信息我们可以看到，我们的Unity-iPhone.xcodeproj项目里有两个Targets分别为:Unity-iPhone和Unity-iPhone Tests以及一个Schemes:Unity-iPhone。这些都分别对应了我们前面最初所了解的相关Xcode Project的概念。</p>
<p>如果想要查看Xcode Project的详细Build Setting设置信息，我们可以通过输入xcodebuild -showBuildSettings来查看：<br><img src="/img/Bash/XcodeProjectBuildSettingsInfo.png" alt="XcodeProjectBuildSettingsInfo"><br>-showBuildSettings有不少东西，很多概念需要对比着Xcode工程里的设置来看，这里暂时不深究每一个代表什么意思。</p>
<p>了解了Workspace,Project,Target,Scheme,BuildSetting等等概念以及如何通过xcodebuild工具查看Xcode工程相关信息后，接下来我们看一下xcodebuild是如何编译打包导出IPA的。</p>
<p>这里参考网上，我发现Xcode9以后有两种方式来实现自动化打包。</p>
<ol>
<li>Automatic</li>
<li>Manual</li>
</ol>
<p>这里我先以Manual的形式来学习打包，后续再学习了解Automatic的形式打包。</p>
<p>首先我们来看看官方对xcodebuild工具的介绍:<br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/technotes/tn2339/_index.html">xcodebuild is a command-line tool that allows you to perform build, query, analyze, test, and archive operations on your Xcode projects and workspaces from the command line.</a><br>可以看出xcodebuild正式苹果官方给出的通过命令行触发打包编译导出一系列操作的工具。</p>
<p>具体想知道xcodebuild的详细使用介绍，可以在shell里输入man xcodebuild查看即可：<br><img src="/img/XcodeAutoSign/ManXcodeBuild.png" alt="ManXcodebuild"></p>
<p>Manual:<br>手动打包之前，我们要用到下面几个比较重要的xcodebuild命令参数:</p>
<ol>
<li>clean – Remove build products and intermediate files from the build root(SYMROOT)(清楚通过build触发编译的所有中间文件)</li>
<li>build – Build the target in the build root(SYMROOT). This is the default action, and is used if no action is given.(build指定target)</li>
<li>archive – Archive a scheme from the build root(SYMROOT). This requires specifying a scheme.(打包指定scheme)</li>
<li>exportArchive – Specifies that an archive should be exported. Requires -archivePath, -exportPath, and -exportOptionsPlist.  Cannot be passed along with an action.(指定Archive文件导出IPA)</li>
</ol>
<p>下面以工作中完整的命令行编译打包导出IPA为例来讲解学习(敏感信息中文代替):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line"># 检查并创建文件夹</span><br><span class="line">CheckAndCreateFolder()</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;CheckOrCreateFolder parameter1 : $1&quot;</span><br><span class="line">    if [ -d $1 ]</span><br><span class="line">    then </span><br><span class="line">        echo &quot;$1 exits!&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;$1 not exits!&quot;</span><br><span class="line">        mkdir -p $1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">currentfolder=~+</span><br><span class="line">homefolderpath=~</span><br><span class="line">xcodeexportoptionfolderpath=&quot;$&#123;homefolderpath&#125;/Desktop/XcodeAutoSign/&quot;</span><br><span class="line">currentdatetime=`date +%Y%m%d%H%M%S`</span><br><span class="line"></span><br><span class="line">#签包相关信息(默认大陆Appstore)</span><br><span class="line"># 包名</span><br><span class="line">bundleid=&quot;对应包名&quot;</span><br><span class="line"># 大陆</span><br><span class="line">areas=&quot;dalu&quot;</span><br><span class="line">#证书类型</span><br><span class="line">provisionprofiletype=&quot;AppStore&quot;</span><br><span class="line"># 证书名字</span><br><span class="line">codesignidentity=&quot;对应证书名字&quot;</span><br><span class="line"># 描述文件名字</span><br><span class="line">provisioningprofile=&quot;对应描述文件名字&quot;</span><br><span class="line"># Deployment最低版本指定</span><br><span class="line">deploymenttarget=&quot;对应最低IOS支持版本&quot;</span><br><span class="line"># 打包导出配置文件</span><br><span class="line"># 最终签名相关信息都是以配置文件为准</span><br><span class="line">exportoptionsplist=&quot;对应签名配置文件&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;--------------------&quot;</span><br><span class="line">echo &quot;1. 大陆Appstore&quot;</span><br><span class="line">echo &quot;2. 大陆AdHoc&quot;</span><br><span class="line">echo &quot;3. 台湾Appstore&quot;</span><br><span class="line">echo &quot;4. 台湾AdHoc&quot;</span><br><span class="line">echo &quot;--------------------&quot;</span><br><span class="line">echo &quot;输入打包类型数字id(默认不输入是大陆AppStore):&quot;</span><br><span class="line">read countrynumber</span><br><span class="line"># 默认大陆</span><br><span class="line">echo &quot;countrynumber = $&#123;countrynumber:=1&#125;&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;输入工程文件夹全路径:&quot;</span><br><span class="line">read xcodeprojectfolderpath</span><br><span class="line">xcodeprojectfullpath=&quot;$&#123;xcodeprojectfolderpath&#125;/Unity-iPhone.xcodeproj&quot;</span><br><span class="line">echo &quot;xcodeprojectfullpath : $&#123;xcodeprojectfullpath&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 检查工程Xcode项目文件是否存在</span><br><span class="line">if [ -d $&#123;xcodeprojectfullpath&#125; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;Xcode项目文件存在!&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;Xcode项目:$&#123;xcodeprojectfullpath&#125;文件不存在!签包IPA失败!&quot; &gt; ErrorLog.txt</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $countrynumber -eq 1 ]</span><br><span class="line">then    </span><br><span class="line">    #大陆Appstore</span><br><span class="line">    echo &quot;大陆AppStore&quot;</span><br><span class="line">    areas=&quot;dalu&quot;</span><br><span class="line">    provisionprofiletype=&quot;AppStore&quot;</span><br><span class="line">    bundleid=&quot;对应包名&quot;</span><br><span class="line">    codesignidentity=&quot;对应证书名字&quot;</span><br><span class="line">    provisioningprofile=&quot;对应描述文件名&quot;</span><br><span class="line">    deploymenttarget=&quot;对应最低IOS支持版本&quot;</span><br><span class="line">    exportoptionsplist=&quot;对应签名配置文件&quot;</span><br><span class="line">elif [ $countrynumber -eq 2 ]</span><br><span class="line">then</span><br><span class="line">    #大陆Ad Hoc</span><br><span class="line">    echo &quot;大陆AdHoc&quot;</span><br><span class="line">    areas=&quot;dalu&quot;</span><br><span class="line">    provisionprofiletype=&quot;AdHoc&quot;</span><br><span class="line">    bundleid=&quot;对应包名&quot;</span><br><span class="line">    codesignidentity=&quot;对应证书名字&quot;</span><br><span class="line">    provisioningprofile=&quot;对应描述文件名&quot;</span><br><span class="line">    deploymenttarget=&quot;对应最低IOS支持版本&quot;</span><br><span class="line">    exportoptionsplist=&quot;对应签名配置文件&quot;</span><br><span class="line">elif [ $countrynumber -eq 3 ]</span><br><span class="line">then</span><br><span class="line">    #台湾Appstore</span><br><span class="line">    echo &quot;台湾Appstore&quot;</span><br><span class="line">    areas=&quot;taiwan&quot;</span><br><span class="line">    provisionprofiletype=&quot;AppStore&quot;</span><br><span class="line">    bundleid=&quot;对应包名&quot;</span><br><span class="line">    codesignidentity=&quot;对应证书名字&quot;</span><br><span class="line">    provisioningprofile=&quot;对应描述文件名&quot;</span><br><span class="line">    deploymenttarget=&quot;对应最低IOS支持版本&quot;</span><br><span class="line">    exportoptionsplist=&quot;对应签名配置文件&quot;</span><br><span class="line">elif [ $countrynumber -eq 4 ]</span><br><span class="line">then</span><br><span class="line">    #台湾AdHoc</span><br><span class="line">    echo &quot;台湾AdHoc&quot;</span><br><span class="line">    areas=&quot;taiwan&quot;</span><br><span class="line">    provisionprofiletype=&quot;AdHoc&quot;</span><br><span class="line">    bundleid=&quot;对应包名&quot;</span><br><span class="line">    codesignidentity=&quot;对应证书名字&quot;</span><br><span class="line">    provisioningprofile=&quot;对应描述文件名&quot;</span><br><span class="line">    deploymenttarget=&quot;对应最低IOS支持版本&quot;</span><br><span class="line">    exportoptionsplist=&quot;对应签名配置文件&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;请输入1或者2或者3或者4!签包失败!&quot; &gt; ErrorLog.txt</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># IPA文件名</span><br><span class="line">ipadname=&quot;$&#123;areas&#125;_$&#123;provisionprofiletype&#125;_$currentdatetime&quot;</span><br><span class="line"># IPA输出目录全路径</span><br><span class="line">ipaexportpath=&quot;/Users/Shared/build-ios/$&#123;areas&#125;/$&#123;provisionprofiletype&#125;/$&#123;currentdatetime&#125;&quot;</span><br><span class="line"># Archive文件名</span><br><span class="line">archivefilename=&quot;$&#123;xcodeprojectfolderpath&#125;/$&#123;areas&#125;_archive.xcarchive&quot;</span><br><span class="line"></span><br><span class="line"># 切换到对应工程目录下</span><br><span class="line">cd $xcodeprojectfolderpath</span><br><span class="line">echo &quot;切换到对应工程目录后当前目录:&quot;</span><br><span class="line">echo ~+</span><br><span class="line"></span><br><span class="line"># 检查输出目录是否存在，不存在则创建一个</span><br><span class="line">CheckAndCreateFolder $ipaexportpath</span><br><span class="line"></span><br><span class="line">#检查导出配置文件是否路径正确且存在</span><br><span class="line">echo &quot;导出配置文件路径:&quot;</span><br><span class="line">echo &quot;$&#123;xcodeexportoptionfolderpath&#125;/$&#123;exportoptionsplist&#125;&quot;</span><br><span class="line">if [ -f $&#123;xcodeexportoptionfolderpath&#125;/$&#123;exportoptionsplist&#125; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;导出配置文件存在!&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;导出配置文件不存在!签包IPA失败!&quot; &gt; ErrorLog.txt</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 判定符合条件的Archive文件是否存在，</span><br><span class="line"># 存在则直接Export，</span><br><span class="line"># 不存在则完全重新签包</span><br><span class="line">if [ ! -d $&#123;archivefilename&#125; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;$&#123;archivefilename&#125;文件不存在!&quot;</span><br><span class="line">    #clean下工程</span><br><span class="line">    echo &quot;开始清理工程&quot;</span><br><span class="line">    xcodebuild  clean \</span><br><span class="line">                -project Unity-iPhone.xcodeproj \</span><br><span class="line">                -configuration Release -alltargets \</span><br><span class="line">                PRODUCT_BUNDLE_IDENTIFIER=&quot;$bundleid&quot;</span><br><span class="line"></span><br><span class="line">    #开始编译</span><br><span class="line">    echo &quot;开始编译打包&quot;</span><br><span class="line">    xcodebuild -project Unity-iPhone.xcodeproj \</span><br><span class="line">                -scheme Unity-iPhone \</span><br><span class="line">                -configuration Release \</span><br><span class="line">                PRODUCT_BUNDLE_IDENTIFIER=&quot;$bundleid&quot; \</span><br><span class="line">                CODE_SIGN_STYLE=&quot;Manual&quot; \</span><br><span class="line">                CODE_SIGN_IDENTITY=&quot;$codesignidentity&quot; \</span><br><span class="line">                PROVISIONING_PROFILE=&quot;$provisioningprofile&quot; \</span><br><span class="line">                IPHONEOS_DEPLOYMENT_TARGET=&quot;$deploymenttarget&quot; \</span><br><span class="line">                -archivePath &quot;$&#123;archivefilename&#125;&quot; \</span><br><span class="line">                archive</span><br><span class="line">else</span><br><span class="line">    echo &quot;$&#123;archivefilename&#125;文件存在!&quot;</span><br><span class="line">fi</span><br><span class="line">            </span><br><span class="line">#开始打包Archive</span><br><span class="line">echo &quot;开始导出IPA&quot;</span><br><span class="line">xcodebuild -exportArchive \</span><br><span class="line">           -archivePath &quot;$&#123;archivefilename&#125;&quot; \</span><br><span class="line">           -exportOptionsPlist &quot;$&#123;xcodeexportoptionfolderpath&#125;/$&#123;exportoptionsplist&#125;&quot; \</span><br><span class="line">           -exportPath &quot;$&#123;ipaexportpath&#125;&quot;</span><br><span class="line"></span><br><span class="line">#修改最终输出的ipa文件名</span><br><span class="line">mv -f &quot;$&#123;ipaexportpath&#125;/Unity-iPhone.ipa&quot; &quot;$&#123;ipaexportpath&#125;/$&#123;ipadname&#125;.ipa&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;xcodeprojectfolderpath : $xcodeprojectfolderpath&quot;</span><br><span class="line">echo &quot;homefolderpath : $homefolderpath&quot;</span><br><span class="line">echo &quot;ipaexportpath : $ipaexportpath&quot;</span><br><span class="line">echo &quot;bundleid : $bundleid&quot;</span><br><span class="line">echo &quot;codesignidentity : $codesignidentity&quot;</span><br><span class="line">echo &quot;provisioningprofile : $provisioningprofile&quot;</span><br><span class="line">echo &quot;deploymenttarget : $deploymenttarget&quot;</span><br><span class="line">echo &quot;exportoptionsplist : $exportoptionsplist&quot;</span><br><span class="line">echo &quot;xcodeexportoptionfolderpath : $xcodeexportoptionfolderpath&quot;</span><br><span class="line">echo &quot;currentdatetime : $currentdatetime&quot;</span><br><span class="line">echo &quot;ipadname : $ipadname&quot;</span><br><span class="line">echo &quot;archivefilename : $archivefilename&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;签包结束.&quot;</span><br><span class="line">$SHELL</span><br></pre></td></tr></table></figure>

<p>这里针对上面的自动化签包脚本，我们需要理解几个关键概念：</p>
<ol>
<li>包名 – 我们平时说的包名，Unity里平台设置那里设置的包名<br>Xcode里显示参考下图：<br> <img src="/img/XcodeAutoSign/XcodeBundleId.png" alt="XcodeBundleId"></li>
<li>证书名字 – IOS开发打包需要的证书文件(比如:Development,Distribution证书)<br>因为Apple Developer Account最近刚到期，无法截后台账号的图，这里只放一张Keychain里面显示已经安装在本地的Certificate图:<br><img src="/img/XcodeAutoSign/KeyChainCertificates.png" alt="KeyChainCertificates"><br>证书名字通过右键对应Certificate后选择Get Info可查看:<br> <img src="/img/XcodeAutoSign/CertificateDetail.png" alt="CertificateDetail"></li>
<li>描述文件 – 是指后台指定了Certificate,Apple Id, Device List等信息的描述文件<br><img src="/img/XcodeAutoSign/ProvisioningProfile.png" alt="ProvisioningProfile"><br>如果想详细查看里面的信息，可以通过下面这个命令:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">security cmd -D -i *.mobileprovision</span><br></pre></td></tr></table></figure>

<p>这里面就包含了很多信息，这里我们暂时需要通过这个找到描述文件的名字:<br>    <img src="/img/XcodeAutoSign/ProvisionProfileName.png" alt="ProvisionProfileName"></p>
<ol start="4">
<li>IOS最低版本支持 – 这个是对应Xcode里设置Deployment Target的那个参数，表示打包支持的最低IOS版本<br><img src="/img/XcodeAutoSign/DeploymentTarget.png" alt="DeploymentTarget"></li>
<li>签名配置文件 – 关于导出IPA时的签名信息以及相关参数等的配置文件<br><img src="/img/XcodeAutoSign/ExportOptionFile.png" alt="ExportOptionFile"><br>让我们看下里面的详细信息:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version=&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">    &lt;key&gt;method&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;app-store&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;provisioningProfiles&lt;/key&gt;</span><br><span class="line">    &lt;dict&gt;</span><br><span class="line">        &lt;key&gt;对应包名&lt;/key&gt;</span><br><span class="line">        &lt;string&gt;对应描述文件名&lt;/string&gt;</span><br><span class="line">    &lt;/dict&gt;</span><br><span class="line">    &lt;key&gt;signingCertificate&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;***&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;signingStyle&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;manual&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;stripSwiftSymbols&lt;/key&gt;</span><br><span class="line">    &lt;true/&gt;</span><br><span class="line">    &lt;key&gt;teamID&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;***&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;uploadSymbols&lt;/key&gt;</span><br><span class="line">    &lt;false/&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到签名配置文件里面指定了导出类型(app-store or development等)，证书名以及包名，描述文件信息等信息。<br>那么这个配置文件哪里来的了？<br>手动Archive后，我们会在*.ipa的同层文件目录下得到一个叫ExportOption.plist的文件，这个就是那个配置文件。</p>
<p>Note：<br>如果我们的程序开启了苹果相关的服务，比如Apple Wallet等，那这些服务会以参数的信息显示在上面的配置文件里，如果后台证书配置了使用特定服务，但该配置文件里没有，就会提示特定字段信息对不上或者遗漏而报错。</p>
<p>可以看出通过上面的自动化，我们可以命令行指定以下内容:</p>
<ol>
<li>包名</li>
<li>证书</li>
<li>描述文件</li>
<li>IOS最低支持版本号</li>
<li>签名证书</li>
</ol>
<p>接下来我们看看xcodebuild编译里是如何指定这些信息并成功导出IPA的:</p>
<ol>
<li>清理工程</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild  clean \                              # 指定了清理工程</span><br><span class="line">            -project Unity-iPhone.xcodeproj \    # 指定清理哪一个project</span><br><span class="line">            -configuration Release -alltargets \ # 指定清理Release下的所有targets</span><br><span class="line">            PRODUCT_BUNDLE_IDENTIFIER=&quot;$bundleid&quot;# 指定了包名(这一个可能不需要)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编译打包</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild -project Unity-iPhone.xcodeproj \                # 指定打包哪个project</span><br><span class="line">            -scheme Unity-iPhone \                          # 指定打包哪个scheme</span><br><span class="line">            -configuration Release \                        # 指定编译Release</span><br><span class="line">            PRODUCT_BUNDLE_IDENTIFIER=&quot;$bundleid&quot; \         # 指定包名</span><br><span class="line">            CODE_SIGN_STYLE=&quot;Manual&quot; \                      # 指定手动签名</span><br><span class="line">            CODE_SIGN_IDENTITY=&quot;$codesignidentity&quot; \        # 指定证书</span><br><span class="line">            PROVISIONING_PROFILE=&quot;$provisioningprofile&quot; \   # 指定描述文件</span><br><span class="line">            IPHONEOS_DEPLOYMENT_TARGET=&quot;$deploymenttarget&quot; \# 指定IOS最低版本</span><br><span class="line">            -archivePath &quot;$&#123;archivefilename&#125;&quot; \             # 指定生成的Archive文件路径</span><br><span class="line">            archive                                         # 指定编译打包</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>导出IPA</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild -exportArchive \                                         # 指定导出IPA</span><br><span class="line">           -archivePath &quot;$&#123;archivefilename&#125;&quot; \                      # 指定Archive文件路径</span><br><span class="line">           -exportOptionsPlist &quot;$&#123;xcodeexportoptionfolderpath&#125;/$&#123;exportoptionsplist&#125;&quot; \ # 指定签名配置文件路径</span><br><span class="line">           -exportPath &quot;$&#123;ipaexportpath&#125;&quot;                           # 指定IPA输出路径</span><br></pre></td></tr></table></figure>

<p>上面的注释已经很详细了，这里就不在详细讲解了。<br>通过archive命令，我们得到了一个*.xcarchive的文件。<br><img src="/img/XcodeAutoSign/ArchiveFile.png" alt="ArchiveFile"><br>通过这个*.xcarchive文件，我们可以通过指定签名配置文件导出我们想要的IPA文件。</p>
<p>Automatic:<br>待续……</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a target="_blank" rel="noopener" href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/001374027586935cf69c53637d8458c9aec27dd546a6cd6000">http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/001374027586935cf69c53637d8458c9aec27dd546a6cd6000</a>)</p>
<h2 id="Jenkins-Part"><a href="#Jenkins-Part" class="headerlink" title="Jenkins Part"></a>Jenkins Part</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Groovy">Groovy</a><br><a target="_blank" rel="noopener" href="https://wiki.jenkins-ci.org/display/JENKINS/Unity3dBuilder+Plugin#Unity3dBuilderPlugin-Usageguide">Uniy3d Plugin</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/houyefeng/article/details/50914582">Jenkins——应用篇——插件使用——Mailer Plugin</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/zz0412/p/jenkins_jj_01.html">Jenkins进阶系列之——01使用email-ext替换Jenkins的默认邮件通知</a><br><a target="_blank" rel="noopener" href="http://7dot9.com/2016/11/18/macos-jenkins-ci-unity-setup-config-guide/">macOS 安装配置 Jenkins 持续集成 Unity 项目指南</a><br><a target="_blank" rel="noopener" href="http://www.it610.com/article/3905365.htm">MAC EI Capitan上更新系统自带SVN版本(关闭SIP方能sudo rm)</a><br><a target="_blank" rel="noopener" href="https://support.apple.com/en-us/HT204899">About System Integrity Protection on your Mac</a><br><a target="_blank" rel="noopener" href="https://wiki.jenkins-ci.org/display/JENKINS/Email-ext+plugin#Email-extplugin-TemplateExamples">Email-ext plugin</a></p>
<h2 id="Shell-Part"><a href="#Shell-Part" class="headerlink" title="Shell Part"></a>Shell Part</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix_shell">Unix shell</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Shell%E8%84%9A%E6%9C%AC">Shell脚本</a><br><a target="_blank" rel="noopener" href="http://tldp.org/LDP/abs/html/">Advanced Bash-Scripting Guide</a></p>
<h2 id="Xcodebuild-Part"><a href="#Xcodebuild-Part" class="headerlink" title="Xcodebuild Part"></a>Xcodebuild Part</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e691a81d576c">Xcode 9 最新 最准确 的自动化打包</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cy568searchx/p/5781717.html">iOS系统提供开发环境下命令行编译工具：xcodebuild</a><br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/technotes/tn2339/_index.html">Building from the Command Line with Xcode FAQ</a><br><a target="_blank" rel="noopener" href="https://help.apple.com/xcode/mac/current/#/itcaec37c2a6">Build settings reference</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a href=""></a><br><a href=""></a><br><a href=""></a><br><a href=""></a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Automation/">Automation</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/17/SublimeText3使用/" title="SublimeText3使用" itemprop="url">SublimeText3使用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-02-17T15:59:11.000Z" itemprop="datePublished"> 发表于 2017-02-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Editor"><a href="#Editor" class="headerlink" title="Editor"></a>Editor</h1><h2 id="Editor-Comparison"><a href="#Editor-Comparison" class="headerlink" title="Editor Comparison"></a>Editor Comparison</h2><p>先如今有很多优秀的编辑器(有些近乎IDE的水准):</p>
<ol>
<li>Sublime Text 3</li>
<li>Vim</li>
<li>Emacs</li>
<li>VS Code</li>
<li>Notepade++<br>……</li>
</ol>
<p>每一种都各有各的优势，作为一个小白用户，连Sublime Text 3和VS Code都算不上使用熟悉，所以这里并不能做详细的比较。</p>
<h2 id="Editor-Chosen"><a href="#Editor-Chosen" class="headerlink" title="Editor Chosen"></a>Editor Chosen</h2><p>How to choose editor?<br>在选择自己的IDE或则编辑器的时候，我很赞同一句话“没有最厉害最优秀的只有最适合。”<br>所以哪一种最好最适合取决于我们用它做什么。</p>
<p>What do I need?<br>作为一个前端程序员，大部分时间是在做手游或者PC端的开发，需要和Android，IOS，PC打交道。<br>在Windows上主要使用VS，Android Studio作为IDE。<br>在Mac上使用XCode作为IDE。<br>主要使用C++,C#,Java,Python,bat,Lua等编程语言。<br>但VS，Android Studio，XCode都属于比较大型的IDE，这里主要是需要一个轻量级的编辑器。<br>主要希望有下列功能：</p>
<ol>
<li>跨平台(跨Mac和Windows开发)</li>
<li>语法高亮</li>
<li>代码补充</li>
<li>调试(option)</li>
<li>快速切换，查询，跳转等方便快捷的快捷修改</li>
<li>快速启动</li>
<li>方便自定义(比如背景，快捷键设置等)</li>
<li>扩展性强(方便添加支持更多功能)<br>……</li>
</ol>
<p>Why choose Sublime Text 3?<br>这里就不一一说明Sublime Text 3的好处了，几乎上面我需要的都可以很方便的扩展支持，这也就是为什么选择Sublime Text 3的原因。</p>
<h1 id="Sublime-Text-3"><a href="#Sublime-Text-3" class="headerlink" title="Sublime Text 3"></a>Sublime Text 3</h1><p><a target="_blank" rel="noopener" href="https://www.sublimetext.com/">Sublime Text 3官网</a></p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><p><a target="_blank" rel="noopener" href="https://www.sublimetext.com/3">Download Sublime Text 3</a></p>
<h2 id="Useful-Package"><a href="#Useful-Package" class="headerlink" title="Useful Package"></a>Useful Package</h2><ol>
<li>Package Control<br>Sublime Text 3扩展性强就在于通过安装扩展包，可以得到很多有用的功能支持。<br>而帮助快速安装和查找有用的Package，就不得不提Package Control，有了它我们可以快速的搜索和安装想要的Package。<br>如何安装Package Control：<br><a target="_blank" rel="noopener" href="https://packagecontrol.io/installation">Package Control Installation</a><br>如果不知道有哪些Package，可以在下面官网查询：<br><a target="_blank" rel="noopener" href="https://packagecontrol.io/">Package Control Package</a></li>
<li>Terminal<br>偶尔会需要打开命令行窗口，这个插件可以帮助我们直接在Sublime里通过快捷键快速打开系统自带命令行<br><a target="_blank" rel="noopener" href="https://github.com/wbond/sublime_terminal">Terminal</a><br>Note:<br>虽然Sublime Text 3也有Git相关的插件，但是考虑已经添加了快速打开命令行的插件，并且Git使用不会太频繁，所以不单独添加Git扩展。</li>
<li>Markdown<br>Markdown是我们经常会去编写文档的一类格式，语法高亮，快速浏览效果是效率的关键。<ol>
<li><p><a target="_blank" rel="noopener" href="https://packagecontrol.io/packages/MarkdownEditing">Markdown Edit</a><br> Better syntax understanding and good color schemes.</p>
</li>
<li><p>Markdown Preview<br> ctrl+shift+p，然后输入Markdown Preview: Preview in Browser<br> 我们去Preference -&gt; Key Binding里去改快速生成Markdown HTML的快捷键</p>
</li>
</ol>
</li>
</ol>
<p><img src="/img/Editors/SublimeText3/MarkPreviewShortCut.PNG" alt="MarkPreviewShortCut"><br>    最后得到我们Markdown的网页版：<br><img src="/img/Editors/SublimeText3/MarkDownPreviewOnBrowser.PNG" alt="MarkDownPreviewOnBrowser"></p>
<ol start="4">
<li><a target="_blank" rel="noopener" href="https://packagecontrol.io/packages/SublimeCodeIntel">SublimeCodeIntel</a><br><a target="_blank" rel="noopener" href="https://www.oschina.net/news/71008/8-sublime-text-3-plugins">SublimeCodeIntel 作为一个代码提示和补全插件，支持 JavaScript、Mason、XBL、XUL、RHTML、SCSS、Python、HTML、Ruby、Python3、XML、Sass、XSLT、Django、HTML5、Perl、CSS、Twig、Less、Smarty、Node.js、Tcl、TemplateToolkit 和 PHP 等所有语言，是 Sublime Text 自带代码提示功能基础上一个更好的扩展，自带代码提示功能只可提示系统代码，而SublimeCodeIntel则可以提示用户自定义代码。</a><br>这里本人主要是为了配置Python<br>因为官网提到Default Settings在更新时会被覆盖，如果要修改设置应该写在User里。<br>Preferences -&gt; Package Settings -&gt; SublimeCodeIntel -&gt; Setting User<br>配置Python如下：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">   SublimeCodeIntel user settings</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">       Defines a configuration for each language.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="string">&quot;codeintel_language_settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Python&quot;</span>: &#123; </span><br><span class="line">           <span class="comment">// For Windows Python 2.7</span></span><br><span class="line">           <span class="string">&quot;python&quot;</span>: <span class="string">&quot;H:/StudyTools/Phyton2_7/python.exe&quot;</span>,</span><br><span class="line">           <span class="string">&quot;pythonExtraPaths&quot;</span>:[</span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Phyton2_7&quot;</span>,</span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Phyton2_7/DLLs&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Phyton2_7/Lib&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Phyton2_7/Lib/lib-tk&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Phyton2_7/Lib/site-packages&quot;</span>,  </span><br><span class="line">           ],</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;Python3&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;python&quot;</span>: <span class="string">&quot;H:/StudyTools/Python3_6/python.exe&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pythonExtraPaths&quot;</span>: [</span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Python3_6&quot;</span>,</span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Python3_6/DLLs&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Python3_6/Lib&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Python3_6/Lib/tkinter&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Python3_6/Lib/site-packages&quot;</span>,  </span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>其中是Python和Python3分别代表Python2.x和Python3.x的安装路径
如果需要配置其他语言，也写在&quot;codeintel_language_settings&quot;里即可。
这个由于还没正式开始学习使用Python，但测试无论配没配置上面，系统提示和自定义方法都会有自动提示和补全功能和函数跳转(Alt+click)(不确定是Sublime Text 3自带的还是SublimeCodeIntel的功能，暂时先按上面的方式设置)
</code></pre>
<ol start="5">
<li><a target="_blank" rel="noopener" href="http://www.sublimelinter.com/en/latest/installation.html">SublimeLinter</a><br>SublimeLinter是一个 framework for linters(静态代码检查的框架)。要支持不同的语言需要额外装对应的扩展包。<br>主要是为了装Python的静态代码和代码规范检查。<br>现在SublimeLinter上Python的Linter有很多，比如pep8,pylint,flake8,bandit等<br>作为Python初学者这里暂时不纠结哪一个更好，暂时使用flake作为尝试。<br>因为SublimeLinterFlake8会用到flake，所以需要安装flake先：<br>打开terminal，输入pip install flake<br>python3自带pip<br>低于python2.7.9的好像要自己装pip<br>pip可以理解成类似于Package Control帮助快速安装Python工具包的工具。<br>确认flake8.exe在环境变量中：<br><img src="/img/Editors/SublimeText3/WhereFlake8.PNG" alt="WhereFlake8"><br>然后通过PackageControl安装SublimeLinterFlake8即可。<br>这样一来就有静态代码和代码规范检查了:<br><img src="/img/Editors/SublimeText3/SublimeLinterFlake8.PNG" alt="SublimeLinterFlake8"></li>
<li><a target="_blank" rel="noopener" href="https://packagecontrol.io/packages/Git">Git</a><br>Git是程序员经常打交道的东西。为了在Sublime Text 3里快速的使用Git提高效率。安装Git插件可以支持我们在Ctrl+Shift+P里直接调用Git命令。<br>安装步骤还是通过Package Control这里就不再重述。<br>直接看看安装好后的效果：<br><img src="/img/Editors/SublimeText3/GitPlugin.PNG" alt="GitPlugin"></li>
<li><a target="_blank" rel="noopener" href="https://packagecontrol.io/packages/GitGutter">GitGutter</a><br>GitGutter主要是提供了Git提交时在Sublime Text 3里支持高亮显示增删改查等变化。<br>老规矩安装(Packgage Control)<br>直接看看使用GitGutter提交时的高亮显示变化效果:<br><img src="/img/Editors/SublimeText3/GitGutter.PNG" alt="GitGutter"></li>
</ol>
<h2 id="Custom-Sublime-Text-3"><a href="#Custom-Sublime-Text-3" class="headerlink" title="Custom Sublime Text 3"></a>Custom Sublime Text 3</h2><ol>
<li><p>Key Binding<br>自定义快捷键。打开Preference -&gt; Key Binding进行快捷键修改(这里以打开修改方法跳转，文件搜索等快捷键跟VS番茄插件一致为例)<br><img src="/img/Editors/SublimeText3/KeyBinding.PNG" alt="KeyBinding"><br>Note:<br>改快捷键绑定只是让新的快捷键覆盖相同快捷键但并不关闭原始快捷键设置，要想默认快捷键不起作用还得设置相同的快捷键覆盖。</p>
</li>
<li><p>Sublime Text 3 Setting<br>字体大小，行号显示，拼写检查等设置。<br>修改默认设置跟自定义快捷键差不多。<br>比如我们想默认字体大小改大一点：<br>Preference -&gt; Settings<br><img src="/img/Editors/SublimeText3/SublimeText3Setting.PNG" alt="SublimeText3Setting"><br>我们希望修改只针对MarkDown文件的语法高亮规则：<br>打开*.md文件<br>Preference -&gt; Settings - Syntax Specific</p>
</li>
<li><p>Theme</p>
</li>
<li><p>Custom Snippets<br>自定义快速填充片段。帮助我们在快速编写重复的代码或者注释。<br>Tools -&gt; Developer -&gt; New Snippets<br>放在:C:\Users\mshz\AppData\Roaming\Sublime Text 3\Packages\User下<br>貌似每一个Snippets文件只能编写一个对应的Snippet。<br>所以要想管理不同编程语言之间的Snippets，我们可以通过建立不同的文件夹进行管理分类。<br>接下来看看Snippet事例和使用效果：</p>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;snippet&gt;</span><br><span class="line">  &lt;content&gt;&lt;![CDATA[</span><br><span class="line"><span class="meta"># File Name:    $TM_FILENAME</span></span><br><span class="line"><span class="meta"># Description:    This file is used to $&#123;1:Staff&#125;</span></span><br><span class="line"><span class="meta"># Author:       $&#123;2:TangHuan&#125;</span></span><br><span class="line"><span class="meta"># Create Date:    $&#123;3:Year&#125;/$&#123;4:Month&#125;/$&#123;5:Day&#125;</span></span><br><span class="line">]]&gt;&lt;/content&gt;</span><br><span class="line">  &lt;!-- Optional: Set a tabTrigger to define how to trigger the snippet --&gt;</span><br><span class="line">  &lt;tabTrigger&gt;PyFileHeader&lt;/tabTrigger&gt;</span><br><span class="line">  &lt;!-- Optional: Set a scope to limit <span class="keyword">where</span> the snippet will trigger --&gt;</span><br><span class="line">  &lt;scope&gt;source.python&lt;/scope&gt;</span><br><span class="line">&lt;/snippet&gt;</span><br></pre></td></tr></table></figure>
<p><content><![CDATA[这里的内容是我们自定义快速生成的模板]]></content><br><tabTrigger>这里的内容是触发当前Snippet的输入内容</tabTrigger><br><scop>这里的内容是当前Snippet支持的文件类型</scop><br>看看使用效果:<br><img src="/img/Editors/SublimeText3/SublimeText3SnippetsTrigger.PNG" alt="SublimeText3SnippetsTrigger"><br><img src="/img/Editors/SublimeText3/SublimeText3SnippetsUsing.PNG" alt="SublimeText3SnippetsUsing"></p>
<h2 id="Useful-Shortcut"><a href="#Useful-Shortcut" class="headerlink" title="Useful Shortcut"></a>Useful Shortcut</h2><h3 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h3><ol>
<li>Open Package Control - Ctrl + Shift + P<br><img src="/img/Editors/SublimeText3/PackageControl.PNG" alt="PackageControl"></li>
<li>Open Console - Ctrl + &#96;<br><img src="/img/Editors/SublimeText3/ShowCommands.PNG" alt="Console"></li>
<li>Open CMD Console - Ctrl + Shift + T<br><img src="/img/Editors/SublimeText3/ShowCommands.PNG" alt="ShowCommands"><br>Windows上默认是打开的power shell，如果希望打开普通的cmd窗口，可以在Preferences &gt; Package Settings &gt; Terminal &gt; Settings – Default 里指定terminal路径参数等<br><img src="/img/Editors/SublimeText3/TerminalSetting.PNG" alt="TerminalSetting"></li>
</ol>
<h3 id="Editing"><a href="#Editing" class="headerlink" title="Editing"></a>Editing</h3><ol>
<li>Go Anything - Ctrl + P<br>平时打开一个工程或则大的文件目录，我们想要快速定位特定文件里的特定内容。<br>这时Go Anything能满足需求。<br>比如查找FPSDisplay.cs文件里Init()符号：<br>FPSDisplay.cs @Init<br>查找FPSDisplay.cs文件里的特定文字：<br>FPSDisplay.cs #Hello<br>跳转特定文件特定行：<br>FPSDisplay.cs :1(行号)</li>
<li>Multiple Selections<br>当我们需要在文本中找到特定文本并进行修改时，我们可以通过Multiple Selections进行选中我们想要选中的文本然后进行一次修改多行改变，而不用修改多次。<br>Ctrl+D：选中当前光标所在位置的单词。连续使用时，进行多光标选择，选中下一个同名单词。<br>Ctrl+K：配合Ctrl+D可以跳过下一个同名单词。<br>下面是选择替换FPSDisplay.cs中的mTestSublimeGoAnything为例(只替换第一个和第三个匹配的)：<br><img src="/img/Editors/SublimeText3/MutilpleSelection.PNG" alt="MutilpleSelection"></li>
</ol>
<h2 id="Usefule-Commands"><a href="#Usefule-Commands" class="headerlink" title="Usefule Commands"></a>Usefule Commands</h2><ol>
<li>sublime.log_commands(True) – 在console窗口显示当前操作的命令(可以针对特定命令修改成我们自己想要的快捷键)<br><img src="/img/Editors/SublimeText3/ShowCommands.PNG" alt="ShowCommands"></li>
</ol>
<h2 id="Usefule-Setting"><a href="#Usefule-Setting" class="headerlink" title="Usefule Setting"></a>Usefule Setting</h2><ol>
<li>Split Editing<br>View -&gt; Layout -&gt; **<br>很多时候我们需要同时查看多个文件，方便对照查看并修改。<br>分割出来的窗口在窗口操作上是独立的，但同样的文件在两个窗口是同一份。<br><img src="/img/Editors/SublimeText3/SplitEdit.PNG" alt="SplitEdit"></li>
</ol>
<h2 id="User-Setting-Backup"><a href="#User-Setting-Backup" class="headerlink" title="User Setting Backup"></a>User Setting Backup</h2><p>备份Sublime Text 3所有的Package和个性化设置。<br>我们只需要保存一下目录即可:<br>C:\Users\user\AppData\Roaming\Sublime Text 3\Packages<br>当需要同步的时候，把上面的内容覆盖到新的电脑上Sublime Text 3对应的目录即可。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://www.sublimetext.com/">Sublime Text 3</a><br><a target="_blank" rel="noopener" href="http://blog.guowenfh.com/2015/12/26/SublimeText/">一个前端程序猿的Sublime Text3的自我修养</a><br><a target="_blank" rel="noopener" href="https://www.sublimetext.com/docs/3/">Sublime Text 3 Documentation</a><br><a target="_blank" rel="noopener" href="https://www.oschina.net/news/71008/8-sublime-text-3-plugins">开发者最常用的 8 款 Sublime text 3 插件</a><br><a target="_blank" rel="noopener" href="http://tanchao90.com/sublime/">Sublime Text 使用小结</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Other/">Other</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/SubmlineText3/">SubmlineText3</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/20/Unity-Shader/" title="Unity Shader" itemprop="url">Unity Shader</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-12-19T16:35:50.000Z" itemprop="datePublished"> 发表于 2016-12-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>参考书籍《Unity Shader 入门精要》 – 冯乐乐(一位在图形渲染方面很厉害的女生)</p>
<p>使用的Unity版本：<br>Unity 5.4.0f3</p>
<h1 id="Rendering"><a href="#Rendering" class="headerlink" title="Rendering"></a>Rendering</h1><p>关于图形渲染相关知识以及OpenGL相关学习参见：<br><a href="http://tonytang1990.github.io/2015/08/29/Computer-Graphic-Study/">Computer_Graphic_Study</a><br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/">OpenGL_Study</a></p>
<h1 id="Unity-Shader"><a href="#Unity-Shader" class="headerlink" title="Unity Shader"></a>Unity Shader</h1><p>首先让我们通过官网的一张图来看看Unity Shader里面占据重要地位的3D Model,Material,Shader之间的关系：<br><img src="/img/Unity/UnityShaderFundamention.PNG" alt="UnityShaderFundamention"><br>可以看出Material会决定使用哪些Texture和Shader去渲染Model。<br>Shader是针对Texture和Model去做运算的地方。</p>
<p>Unity Shader最主要的有两种(还有Image Effect Shader,Computer Shader等后续会学习)：</p>
<ol>
<li>Surface shader<br>Time to use – “Whenever the material you want to simulate needs to be affected by lights in a realistic way, chances are you’ll need a surface shader. Surface shaders hide the calculations of how light is reflected and allows to specify “intuitive” properties such as the albedo, the normals, the reflectivity and so on in a function called surf.”<br>可以看出Unity的Surface Shader帮我们把光照对物体的影响的计算抽象了出来。我们只需设定一些控制系数，然后通过Surface Shader的surf方法就能触发光照作用对表面的运算。<br>下面简单看下官网给出的Surface Shader Code：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CGPROGRAM</span><br><span class="line"><span class="comment">// Uses the Lambertian lighting model</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> surface surf Lambert</span></span><br><span class="line"></span><br><span class="line">sampler2D _MainTex; <span class="comment">// The input texture</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> Input &#123;</span><br><span class="line">    float2 uv_MainTex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutput o</span>)</span> &#123;</span><br><span class="line">    o.Albedo = tex2D (_MainTex, IN.uv_MainTex).rgb;</span><br><span class="line">&#125;</span><br><span class="line">ENDCG</span><br></pre></td></tr></table></figure>
<pre><code>Note:
必须使用#pragma surface去表示是surface shader
Surface Shader的Code是包含在SubShader里的并且必须写在CGPROGRAM和ENDCG标识之间。
</code></pre>
<ol start="2">
<li>Fragment and Vertex Shaders<br>Fragment and Vertex Shaders就跟OpenGL里差不多，model的vertex会经历完整的Shader Pipeline，最终通过计算得出最终的颜色。<br>让我们来看看官网给出的Fragment and Vertex Shaders Code:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Pass &#123;</span><br><span class="line">    CGPROGRAM</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> vertex vert             </span></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> vertInput &#123;</span><br><span class="line">        float4 pos : POSITION;</span><br><span class="line">    &#125;;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> vertOutput &#123;</span><br><span class="line">        float4 pos : SV_POSITION;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function">vertOutput <span class="title">vert</span>(<span class="params">vertInput input</span>)</span> &#123;</span><br><span class="line">        vertOutput o;</span><br><span class="line">        o.pos = mul(UNITY_MATRIX_MVP, input.pos);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">half4 <span class="title">frag</span>(<span class="params">vertOutput output</span>) : COLOR</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> half4(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    ENDCG</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出vert方法好比OpenGL里vertex shader的main函数入口。<br>frag方法好比OpenGL里fragment shader的main函数入口。<br>这里frag方法return的half4相当于OpenGL FS里的FragColor。<br>可以看出我们还是需要在VS里先将vertex变换到透视投影坐标系，然后最后传递给FS，FS计算出最终的颜色。<br>Note：<br>这里需要注意的一点是，在VS和FS Shader里，code是包含在Pass {…..}里的。</p>
<p>让我们来看看官网给出的Shader的大体结构：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;MyShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// The properties of your shaders</span></span><br><span class="line">        <span class="comment">// - textures</span></span><br><span class="line">        <span class="comment">// - colours</span></span><br><span class="line">        <span class="comment">// - parameters</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// The code of your shaders</span></span><br><span class="line">        <span class="comment">// - surface shader</span></span><br><span class="line">        <span class="comment">//    OR</span></span><br><span class="line">        <span class="comment">// - vertex and fragment shader</span></span><br><span class="line">        <span class="comment">//    OR</span></span><br><span class="line">        <span class="comment">// - fixed function shader</span></span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Properties:<br>“The properties of your shader are somehow equivalent to the public fields in a C# script; they’ll appear in the inspector of your material, giving you the chance to tweak them.”<br>从这里看出Properties在Unity里相当于OPENGL Shader里定义的Uniform，Sampler，全局变量等，用于作为可控的输入。<br>让我们来看看官网给出的例子</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Properties</span><br><span class="line">&#123;</span><br><span class="line">    _MyTexture (<span class="string">&quot;My texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">    _MyNormalMap (<span class="string">&quot;My normal map&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;bump&quot;</span> &#123;&#125;  <span class="comment">// Grey</span></span><br><span class="line"></span><br><span class="line">    _MyInt (<span class="string">&quot;My integer&quot;</span>, Int) = <span class="number">2</span></span><br><span class="line">    _MyFloat (<span class="string">&quot;My float&quot;</span>, Float) = <span class="number">1.5</span></span><br><span class="line">    _MyRange (<span class="string">&quot;My range&quot;</span>, Range(<span class="number">0.0</span>, <span class="number">1.0</span>)) = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    _MyColor (<span class="string">&quot;My colour&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)    <span class="comment">// (R, G, B, A)</span></span><br><span class="line">    _MyVector (<span class="string">&quot;My Vector4&quot;</span>, Vector) = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// (x, y, z, w)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们先看看对应显示在Unity面板是什么模样：<br><img src="/img/Unity/UnityShaderProperty.PNG" alt="UnityShaderProperty"><br>2D代表_MyTexture,_MyNormalMap是texture类型.Color代表颜色。Range代表范围值……<br>可以看到Properties里定义的变量都显示在了Unity面板里用于控制。但是真正通过Shader去访问，我们还需要在SubShader里重新定义对应的变量。<br>SubShader：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SubShader</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Code of the shader</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    sampler2D _MyTexture;</span><br><span class="line">    sampler2D _MyNormalMap;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> _MyInt;</span><br><span class="line">    <span class="built_in">float</span> _MyFloat;</span><br><span class="line">    <span class="built_in">float</span> _MyRange;</span><br><span class="line">    half4 _MyColor;</span><br><span class="line">    float4 _MyVector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Code of the shader</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出Texture在Unity Shader里面的定义和在OpenGL Shader里差不多，也是通过sampler2D，只是不再需要加uniform修饰了。<br>这里值得注意的是Color对应的不是Vector4而是half4。<br>还有就是在Properties里定义的变量名在SubShader要一一对应。</p>
<p>接下来让我们看看官网给出的SubShader里Shader具体是怎样的格式：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SubShader</span><br><span class="line">&#123;</span><br><span class="line">    Tags</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Queue&quot;</span> = <span class="string">&quot;Geometry&quot;</span></span><br><span class="line">        <span class="string">&quot;RenderType&quot;</span> = <span class="string">&quot;Opaque&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    CGPROGRAM</span><br><span class="line">    <span class="comment">// Cg / HLSL code of the shader</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    ENDCG</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>真正的Shader Code是在CGPROGRAM和ENGCG里。<br>这里需要先提一下Tags的作用，Tags是为了告诉Unity我们Shader的特定属性(比如RenderType-渲染类型，Queue–渲染顺序)。</p>
<h2 id="Surface-Shaders"><a href="#Surface-Shaders" class="headerlink" title="Surface Shaders"></a>Surface Shaders</h2><p>让我们看看Surface Shader的大体流程：<br><a target="_blank" rel="noopener" href="http://www.alanzucconi.com/2015/06/17/surface-shaders-in-unity3d/">下图来源</a><br><img src="/img/Unity/SurfaceShaderFlowChart.PNG" alt="SurfaceShaderFlowChart"><br>从上图可以看出，Surace Shader通过Surface function生成最终参与光照计算所需的数据(rendering properties – e.g. texture……)。</p>
<p>让我们来看看Surface Shader里的关键组成部分：</p>
<ol>
<li>Surface function<br>Surface function把model data作为输入，把rendering properties作为输出，这些rendering properties最后会参与光照的计算得到最终颜色。</li>
<li>Input<br>Input structure一般包含了texture相关的信息(比如 UV坐标信息)，也可以包含一些额外信息(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-SurfaceShaders.html">参见</a>)<br>Note:<br>定义texture coordinate的时候必须以uv或者uv2开头加texture名字。</li>
<li>SurfaceOutput<br>SurfaceOutput描述了surface的属性，这些属性最终会参与光照计算。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> SurfaceOutput</span><br><span class="line">&#123;</span><br><span class="line">    fixed3 Albedo;  <span class="comment">// diffuse color</span></span><br><span class="line">    fixed3 Normal;  <span class="comment">// tangent space normal, if written</span></span><br><span class="line">    fixed3 Emission;</span><br><span class="line">    half Specular;  <span class="comment">// specular power in 0..1 range</span></span><br><span class="line">    <span class="keyword">fixed</span> Gloss;    <span class="comment">// specular intensity</span></span><br><span class="line">    <span class="keyword">fixed</span> Alpha;    <span class="comment">// alpha for transparencies</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<pre><code>我们可以通过Shader去计算上面参与光照计算的属性去影响Surface的最终效果，从而达到Surface Shader的真正目的。
</code></pre>
<ol start="4">
<li>Light Model<br>Light Model是真正通过SurfaceOutput属性去计算光照的地方，通过使用或编写不同的Light Model我们可以实现不同的光照影响效果。<br>那么如何定义光照运算函数了？<ol>
<li>half4 Lighting<Name> (SurfaceOutput s, half3 lightDir, half atten);<br>因为没有viewDir所以这里是用于不需要知道观察点的Ambient光照计算</li>
<li>half4 Lighting<Name> (SurfaceOutput s, half3 lightDir, half3 viewDir, half atten);<br>因为有了viewDir，知道了观察点信息，我们可以计算出需要知道观察点的Diffuse和Specular光照。</li>
<li>half4 Lighting<Name>_PrePass (SurfaceOutput s, half4 light);<br>这个用于Deferer Shading(但这里我比较好奇的是如果要计算Diffuse和Specular光照还是需要知道lightDir和viewDir等信息才对。)<br>Note：<br>自定义光照模型的时候，我们不需要定义所有的光照函数，只需定义我们需要的即可。</li>
</ol>
</li>
<li>Vertex Function<br>Provide the ability to change vertices before sending them to surf.<br>定义方式如下：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vert</span>(<span class="params">inout appdata_full v</span>)</span>&#123;......&#125;</span><br></pre></td></tr></table></figure>
<pre><code>appdata_full包含了所有vertex相关的信息
</code></pre>
<ol start="6">
<li>Finalcolor Function<br>用于对经过Surface Shader处理后的pixel进行最后的处理。<br>格式如下：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> surface surf Lambert finalcolor:mycolor</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mycolor</span> (<span class="params">Input IN, SurfaceOutput o, inout fixed4 color</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    color *= _ColorTint;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>接下来让我们通过创建自己的Surface Shader来感受下Surface Shader实际运用效果(这里我拿了SurviveShooter里的模型做输入)：</strong><br>以下学习参考至<a target="_blank" rel="noopener" href="http://www.alanzucconi.com/2015/06/17/surface-shaders-in-unity3d/">Surface shaders in Unity3D</a><br>我们删掉默认创建的Shader Code，只简单输出Albedo(Diffuse Color)看看效果:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    SubShader &#123;</span><br><span class="line">        <span class="comment">// 定义渲染顺序 - RenderType</span></span><br><span class="line">        Tags &#123; <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Opaque&quot;</span> &#125;</span><br><span class="line">        </span><br><span class="line">        CGPROGRAM</span><br><span class="line">        <span class="comment">// #pragma surface指明是surface shader</span></span><br><span class="line">        <span class="comment">// surf Lambert指明用的光照模式是Lambert(会决定光照是如何计算的)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">pragma</span> surface surf Lambert</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> Input &#123;</span><br><span class="line">            float2 color : COLOR;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutput o</span>)</span> &#123;</span><br><span class="line">            o.Albedo = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125; </span><br><span class="line">    FallBack <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/SurfaceShaderWithAlbedoSetting.PNG" alt="SurfaceShaderWithAlbedoSetting"><br><strong>接下来让我们给Hellephant加上纹理图案：</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        <span class="comment">// 为了在编辑器里提供控制纹理输入，Properties必须和struct Input里的uv_MainTex对应</span></span><br><span class="line">        _MainTex(<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader&#123;</span><br><span class="line">        Tags&#123; <span class="string">&quot;RenderType&quot;</span> = <span class="string">&quot;Opaque&quot;</span>&#125;</span><br><span class="line">        CGPROGRAM</span><br><span class="line">        <span class="meta">#<span class="keyword">pragma</span> surface surf Lambert</span></span><br><span class="line">        <span class="comment">// 提供纹理输入</span></span><br><span class="line">        <span class="keyword">struct</span> Input&#123;</span><br><span class="line">            float2 uv_MainTex</span><br><span class="line">        &#125;;</span><br><span class="line">        sampler2D _MainTex;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutputStandard o</span>)</span> &#123;</span><br><span class="line">            o.Albedo = tex2D(_MainTex, IN.uv_MainTex).rgb;</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/SurfaceShaderWithTexture.PNG" alt="SurfaceShaderWithTexture"><br>让我们看看现在对应的Unity Material Editor：<br><img src="/img/Unity/SurfaceShaderMaterialEditorWithTexture.PNG" alt="SurfaceShaderMaterialEditorWithTexture"><br><strong>图像看起来还不真实，没有深度感，接下来我们添加<a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Light_and_Shadow">Normal Mapping 参见</a>：</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        .....</span><br><span class="line">        _BumpMap(<span class="string">&quot;Bumpmap&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;bump&quot;</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader&#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> Input&#123;</span><br><span class="line">            ......</span><br><span class="line">            float2 uv_BumpMap;</span><br><span class="line">        &#125;;</span><br><span class="line">        ......</span><br><span class="line">        sampler2D _BumpMap;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutputStandard o</span>)</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            o.Normal = UnpackNormal(tex2D(_BumpMap, IN.uv_Bumpmap));</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UnpackNormal接受一个fixed4的输入，并将其转换为所对应的法线值（fixed3）<br>比较有无Normal map的效果，见如下：<br><img src="/img/Unity/SurfaceShaderWithNormalMap.PNG" alt="SurfaceShaderWithNormalMap"><br><img src="/img/Unity/SurfaceShaderWithTexture.PNG" alt="SurfaceShaderWithTexture"><br><strong>接下来让我们通过计算Normal和Viedir的情况去高亮物体：</strong><br>这里需要用到build-in variable viewDir(代表观察者看顶点的方向)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        ......</span><br><span class="line">        _RimColor(<span class="string">&quot;Rim Color&quot;</span>, Color) = (<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span><br><span class="line">        _RimPower(<span class="string">&quot;Rim Power&quot;</span>, Range(<span class="number">0.5</span>, <span class="number">8.0</span>)) = <span class="number">3.0</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader &#123;</span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">struct</span> Input &#123;</span><br><span class="line">            .....</span><br><span class="line">            float3 viewDir;</span><br><span class="line">        &#125;;</span><br><span class="line">        ......</span><br><span class="line">        float4 _RimColor;</span><br><span class="line">        <span class="built_in">float</span> _RimPower;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutput o</span>)</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            half rim = <span class="number">1.0</span> - saturate(dot(normalize(IN.viewDir), o.Normal));</span><br><span class="line">            o.Emission = _RimColor.rgb * pow(rim, _RimPower);</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125; </span><br><span class="line">    FallBack <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>saturate的作用是把观察者方向和顶点法线夹角Cos值限定在[0,1]，再用1减去这个值，表明观察者方向和顶点法线夹角越小rim值越小，当夹角大于等于90度的时候达到rim最大值。从而实现高亮边缘的效果(周边和观察者角度往往比较大)。<br><img src="/img/Unity/SurfaceShaderWithEmssion.PNG" alt="SurfaceShaderWithEmssion"><br><strong>接下来我们看看通过vertex function去动态计算新vertex值的效果(这里我们根据顶点法线方向去收缩顶点postion)：</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        ......</span><br><span class="line">        _Amount(<span class="string">&quot;Extrusion Amount&quot;</span>, Range(<span class="number">-0.5</span>,<span class="number">0.5</span>)) = <span class="number">0.0</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader &#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        CGPROGRAM</span><br><span class="line">        <span class="comment">// vertex:vert定义了vert方法名</span></span><br><span class="line">        <span class="meta">#<span class="keyword">pragma</span> surface surf Lambert vertex:vert</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">float</span> _Amount;</span><br><span class="line">        <span class="comment">// vert方法定义，根据顶点法线去计算新的顶点位置</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">vert</span>(<span class="params">inout appdata_full v</span>)</span>&#123;</span><br><span class="line">            v.vertex.xyz += v.normal * _Amount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutput o</span>)</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125; </span><br><span class="line">    FallBack <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/SurfaceShaderWithNegativeExtrusion.PNG" alt="SurfaceShaderWithNegativeExtrusion"><br><img src="/img/Unity/SurfaceShaderWithPositiveExtrusion.PNG" alt="SurfaceShaderWithPositiveExtrusion"><br>在vert function里我们也可以自定义一些成员在surface shader里传递，但这样的话vert必须有两个参数，一个inout appdata_full v,一个out Input o，这里的out Input o回座位surf function的Input IN参数作为输入。<a target="_blank" rel="noopener" href="http://docs.unity3d.com/Manual/SL-SurfaceShaderExamples.html">Custom Input Member详细用法参见</a><br><strong>接下来让我们看看Light Model对于最终颜色计算的影响：</strong><br>待学习了解<br><strong>最后我们来看看Final Color Function是如何影响最终颜色计算的：</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        ......</span><br><span class="line">        _ColorTint(<span class="string">&quot;Tint&quot;</span>, Color) = (<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Tags &#123; <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Opaque&quot;</span> &#125;</span><br><span class="line">        </span><br><span class="line">        CGPROGRAM</span><br><span class="line">        <span class="comment">// finalcolor:mycolor定义final function name</span></span><br><span class="line">        <span class="meta">#<span class="keyword">pragma</span> surface surf Lambert vertex:vert finalcolor:mycolor</span></span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        fixed4 _ColorTint;</span><br><span class="line">        <span class="comment">// final color function格式， color会影响所有lightmaps,light probes等的颜色信息</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">mycolor</span>(<span class="params">Input IN, SurfaceOutput o, inout fixed4 color</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            color *= _ColorTint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutput o</span>)</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125; </span><br><span class="line">    FallBack <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/SurfaceShaderWithFinalColorFunction.PNG" alt="SurfaceShaderWithFinalColorFunction"></p>
<h2 id="Vertex-and-Fragment-Shaders"><a href="#Vertex-and-Fragment-Shaders" class="headerlink" title="Vertex and Fragment Shaders"></a>Vertex and Fragment Shaders</h2><p>见后续Shader学习</p>
<h1 id="Unity-Shader入门精要"><a href="#Unity-Shader入门精要" class="headerlink" title="Unity Shader入门精要"></a>Unity Shader入门精要</h1><h2 id="渲染管线"><a href="#渲染管线" class="headerlink" title="渲染管线"></a>渲染管线</h2><p>参考以前的学习：<br><a href="http://tonytang1990.github.io/2015/08/29/Computer-Graphic-Study/">Computer_Graphic_Study</a><br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/">OpenGL_Study</a></p>
<h2 id="Unity-Shader基础"><a href="#Unity-Shader基础" class="headerlink" title="Unity Shader基础"></a>Unity Shader基础</h2><h3 id="材质和Unity-Shader"><a href="#材质和Unity-Shader" class="headerlink" title="材质和Unity Shader"></a>材质和Unity Shader</h3><p>结合前面的学习，我们知道了在Unity里Material会决定使用那些Texture和Shader去渲染Model。</p>
<p>这里再简单梳理下他们之间的关系：</p>
<ol>
<li>Model(模型) – 最终我们需要通过渲染去实现特定效果的模型。(提供模型数据 e.g. 顶点，法线等)</li>
<li>Texture(贴图数据) – 这里没有直接说成纹理是因为Texture不仅能提供纹理数据，还能提供作为其他计算的数据(e.g. 光照方面的数据等)</li>
<li>Material(材质) – 会决定使用哪些Texture作为数据输入(e.g. 纹理数据，光照计算相关数据等)。通过指定Shader去处理Model和Texture等传入的数据进行处理。而材质面板是与Shader沟通的桥梁，允许我们通过面板暴露Shader暴露出的参数进行渲染控制。</li>
<li>Shader – 处理前面传入的Model，Texture等数据加以处理计算实现各式各样的渲染效果。</li>
</ol>
<p>Unity Shader分类：</p>
<ol>
<li>Standard Surface Shader – 前面我们提到的提供了一个包含标准光照模型计算的表面着色器。(最终还是会被编译成对应图形API接口的Vertex and Fragment Shader)</li>
<li>Unlit Shader – 不包含光照的Vertex and Fragment 。Shader,需要自己编写完整的渲染管线流程代码。</li>
<li>Image Effect Shader – 主要用于实现各种屏幕后处理效果。</li>
<li>Compute Shader – 利用GPU的并行性进行一些与常规渲染流水线无关的计算。</li>
</ol>
<p>这里我们主要学习Unlit Shader。</p>
<p>Shader对于Unity而言也是一种资源文件，所以依然有导入设置：<br><img src="/img/Unity/UnityShaderSettingPanel.PNG" alt="UnityShaderSettingPanel"><br>Note:<br>Unity Shader最终还是会被编译成对应图形编程接口(e.g. DX,OpenGL……)的Shader代码实现真正的渲染。</p>
<h3 id="ShaderLab"><a href="#ShaderLab" class="headerlink" title="ShaderLab"></a>ShaderLab</h3><p>“ShaderLab是Unity提供的编写Unity Shader的一种说明性语言。ShaderLab类似于CgFX和DX Effects语言。<br>“(引用自《Unity Shader入门精要》)</p>
<p>ShaderLab帮助我们快速定义Shader编写过程中需要资源和设置等。Unity会最终把ShaderLab编写的Shader编译成对应平台的真正代码和Shader文件，实现跨平台。</p>
<h3 id="Unity-Shader结构"><a href="#Unity-Shader结构" class="headerlink" title="Unity Shader结构"></a>Unity Shader结构</h3><p>这里我们创建一个基本的UnlitShader，结合里面的代码来学习理解(详情参考代码里的注释)：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 材质索引Shader时的路径</span></span><br><span class="line">Shader <span class="string">&quot;Custom/UnlitShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Shader暴露给材质面板的属性用于动态修改控制</span></span><br><span class="line">    <span class="comment">// Properties在Unity里相当于OPENGL Shader里定义的Uniform，Sampler，全局变量等，用于作为可控的输入</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2D代表_MyTexture,_MyNormalMap是texture类型.Color代表颜色。Range代表范围值，更多内容查官网</span></span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每一个Unity Shader至少要包含一个SubShader(Unity会使用第一个可以在目标平台运行的SubShader用于渲染，如果都不支持则会使用Fallback语义指定的Unity Shader)</span></span><br><span class="line">    <span class="comment">// SubShader定义了真正的Shader相关代码(渲染流程，渲染状态设置等)</span></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Tags是为了告诉Unity我们Shader的特定属性(比如RenderType - 渲染类型，Queue—渲染顺序)。</span></span><br><span class="line">        <span class="comment">// Note:</span></span><br><span class="line">        <span class="comment">// Tag也可以在Pass里声明，但SubShader里的Tags相当于针对所有Pass的Tag设置，优先于Tag本身的Tag设置</span></span><br><span class="line">        Tags &#123; <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Opaque&quot;</span> &#125;</span><br><span class="line">        LOD <span class="number">100</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pass代表一次完成的渲染流程</span></span><br><span class="line">        <span class="comment">// 这个好比OpenGL里实现Shadow Map效果时需要先通过First Pass生成光源点角度的Depth Texture，</span></span><br><span class="line">        <span class="comment">// 然后Second Pass通过比较摄像机角度的Depth Texture得出哪些点是Shadow的结论里的Pass一样</span></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Pass支持定义名字</span></span><br><span class="line">            <span class="comment">// Name &quot;PassName&quot;</span></span><br><span class="line">            <span class="comment">// 我们可以通过这个名字去指定使用特定Pass</span></span><br><span class="line">            <span class="comment">// UsePass &quot;ShaderName/PassName&quot;</span></span><br><span class="line">            <span class="comment">// GrabPass负责抓取屏幕并存储在一张纹理中用于后续Pass处理</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Unity Shader采用的是类似CG的Shader语言编写</span></span><br><span class="line">            <span class="comment">// Shader代码被包含在CGPROGRAM和ENDCG之间</span></span><br><span class="line">            <span class="comment">// Note:</span></span><br><span class="line">            <span class="comment">// 如果想要使用GLSL来编写需要包含在GLSLPROGRAM和ENDGLSL之间</span></span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="comment">// 真正的Shader代码从这里开始</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line">            <span class="comment">// make fog work</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> multi_compile_fog</span></span><br><span class="line">            </span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> appdata</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">                UNITY_FOG_COORDS(<span class="number">1</span>)</span><br><span class="line">                float4 vertex : SV_POSITION;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 映射Properties里暴露给Material材质面板的对象</span></span><br><span class="line">            sampler2D _MainTex;</span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Vertex Shader入口</span></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">appdata v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.vertex = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                o.uv = TRANSFORM_TEX(v.uv, _MainTex);</span><br><span class="line">                UNITY_TRANSFER_FOG(o,o.vertex);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Fragment Shader入口</span></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// sample the texture</span></span><br><span class="line">                fixed4 col = tex2D(_MainTex, i.uv);</span><br><span class="line">                <span class="comment">// apply fog</span></span><br><span class="line">                UNITY_APPLY_FOG(i.fogCoord, col);</span><br><span class="line">                <span class="keyword">return</span> col;</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在所有Pass都不被支持时，我们可以指定最终使用的Pass</span></span><br><span class="line">    <span class="comment">// Fallback &quot;PassName&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数学相关知识"><a href="#数学相关知识" class="headerlink" title="数学相关知识"></a>数学相关知识</h2><p>参考书籍:<br>《3D数学基础:图形与游戏开发》<br>《Fundamentals of Computer Graphics (3rd Edition)》 — Peter Shirley, Steve Marschnner<br>《Real-Time Rendering, Third Edition》 — Tomas Akenine-Moller, Eric Haines, Naty Hoffman</p>
<p>这里只说几点DX和OpenGL还有Unity之间需要注意的特殊点:</p>
<ol>
<li>坐标系<br>DX和Unity使用的是左手坐标系。<br>OpenGL使用的是右手坐标系。</li>
<li>行列向量<br>DX使用的是行向量(矩阵乘法是右乘)<br>OpenGL和Unity使用的是列向量(矩阵乘法是左乘)</li>
<li>正交矩阵<br>因为正交矩阵M(T)&#x3D;M(-1)<br>在提前得知是正交矩阵的前提下可以直接使用M(T)(转置矩阵)快速求的M(-1)(逆矩阵)(e.g. 旋转是正交的)<br>逆矩阵可以用于快速回复之前的矩阵变化</li>
<li>4<em>4矩阵<br>| M(3</em>3)  t(3<em>1)|<br>|  0(1</em>3)    1  |<br>M(3<em>3)代表线性变换(e.g. 旋转，缩放，错切，径向，正交投影…..)<br>t(3</em>1)代表平移变换<br>0(1*3)代表零矩阵<br>1代表标量1</li>
<li>纹理坐标<br>OpenGL中(0,0)是左下角<br>DX中(0,0)是左上角</li>
</ol>
<p>关于渲染流程里的坐标系转换相关知识参考之前的学习:<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Coordinate_Transformations_&_Perspective_Projection">Coordinate Transformations &amp; Perspective Projection</a></p>
<p>Unity Shader的内置变量参考:<br>UnityShaderVariables.cginc</p>
<h2 id="Unity-Shader学习之旅"><a href="#Unity-Shader学习之旅" class="headerlink" title="Unity Shader学习之旅"></a>Unity Shader学习之旅</h2><p>本人使用的Unity版本为5.4.0f3 Personal</p>
<h3 id="一个最简单的顶点-片元着色器"><a href="#一个最简单的顶点-片元着色器" class="headerlink" title="一个最简单的顶点&#x2F;片元着色器"></a>一个最简单的顶点&#x2F;片元着色器</h3><p>依然采用代码实战，跟之前Unity Shader结构讲的类似，但更细节一些，相关解释都写在注释里了:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/SimpleShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 定义Material材质与Shader的交流面板</span></span><br><span class="line">    Properties&#123;</span><br><span class="line">        <span class="comment">// 声明一个Color类型的属性</span></span><br><span class="line">        _Color(<span class="string">&quot;Color Tint&quot;</span>, Color) = (<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 定义一个与Material面板交流控制的对应属性</span></span><br><span class="line">            fixed4 _Color;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 自定义结构体定义vertex shader输入</span></span><br><span class="line">            <span class="keyword">struct</span> a2v &#123;</span><br><span class="line">                <span class="comment">// POSITION告诉Unity，用模型空间的顶点坐标填充vertex变量</span></span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                <span class="comment">// NORMAL告诉Unity，用模型空间的法线方向填充normal变量</span></span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">                <span class="comment">// TEXTURE0告诉Unity，用模型的第一套纹理坐标填充texcoord变量</span></span><br><span class="line">                float4 texcoord : TEXCOORD0;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 自定义结构体用于vertex shader和fragment shader之间数据传入</span></span><br><span class="line">            <span class="keyword">struct</span> v2f &#123;</span><br><span class="line">                <span class="comment">// SV_POSITION告诉Unity，pos是裁剪空间中的顶点坐标位置信息</span></span><br><span class="line">                float4 pos : SV_POSITION;</span><br><span class="line">                <span class="comment">// color存储颜色信息</span></span><br><span class="line">                fixed3 color : COLOR0;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 声明输出结构体实例</span></span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 将v.normal的顶点法线信息从[-1.0,1.0]到[0.0, 1.0]并存储在颜色信息中</span></span><br><span class="line">                o.color = v.normal * <span class="number">0.5</span> + fixed3(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// SV_Target告诉渲染器把用户的输出颜色存储到一个渲染目标中，这里默认是帧缓存中</span></span><br><span class="line">            <span class="comment">// 因为vertex shader是针对顶点运算，fragment shader是针对fragment</span></span><br><span class="line">            <span class="comment">// 所以fragment的输入是顶点数据进行插值后得到的</span></span><br><span class="line">            <span class="comment">// 顶点数据只有三角形的三个顶点，中间的fragment信息通过插值得到</span></span><br><span class="line">            <span class="comment">// i是vertex shader输出后通过插值传递过来的</span></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// v.normal映射后的颜色信息</span></span><br><span class="line">                fixed3 c = i.color;</span><br><span class="line">                <span class="comment">// 使用Material面板控制的_Color参与最终的fragment颜色运算</span></span><br><span class="line">                c *= _Color.rgb;</span><br><span class="line">                <span class="keyword">return</span> fixed4(c, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Unity内置文件和变量"><a href="#Unity内置文件和变量" class="headerlink" title="Unity内置文件和变量"></a>Unity内置文件和变量</h3><p>[Unity Shader内置文件官网下载地址](<a target="_blank" rel="noopener" href="http://unity3d.com/cn/get-unity/download/">http://unity3d.com/cn/get-unity/download/</a><br>archive)</p>
<p>内置文件包含文件：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#include &quot;**.cginc&quot;</span></span><br></pre></td></tr></table></figure>

<p>内置Shader目录结构：<br><img src="/img/Unity/UnityBuildInShaderFolderStructure.PNG" alt="UnityBuildInShaderFolderStructure"></p>
<ol>
<li>CGIncludes – 包含所有的内置包含文件</li>
<li>DefaultResources – 包含了一些内置组件或者功能需要的Unity Shader</li>
<li>DefaultResourcesExtra – 包含了所有的Unity中内置的Unity Shader</li>
<li>Editor – 只有一个脚本，定义了Unity 5引入的Standard Shader所有的材质面板</li>
</ol>
<p>常用包含文件介绍：</p>
<ol>
<li>UnityCG.cginc – 包含了常用的帮助函数，宏和结构体等</li>
<li>UnityShaderVariables.cginc – 包含了许多内置的全局变量,e.g. UNITY_MATRIX_MVP</li>
<li>Lighting.cginc – 包含了各种内置的光照模型</li>
<li>HLSLSupport.cginc – 声明了很多用于跨平台编译的宏和定义</li>
</ol>
<p>Note:<br>Unity Shader内置文件如果安装时下载安装了，也可以在Editor\Data\CGIncludes目录下找到所有内置文件</p>
<h3 id="CG-HLSL语义"><a href="#CG-HLSL语义" class="headerlink" title="CG&#x2F;HLSL语义"></a>CG&#x2F;HLSL语义</h3><p>“语义实际上就是让Shader知道从哪里读取数据，并把数据输出到哪里。”</p>
<p>“SV代表的含义是系统数据(system-value)。DX10以后引入的。大部分时候SV_POSITION和POSITION是等价的。但为了更好的跨平台最好尽量采用SV开头的语义来修饰。”</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-ShaderSemantics.html">Shader semantics官网查询</a></p>
<h3 id="Shader-Debugger"><a href="#Shader-Debugger" class="headerlink" title="Shader Debugger"></a>Shader Debugger</h3><p>欲善其事，必先利其器。<br>在学习Unity Shader之前我们需要知道如何去调试Unity Shader。</p>
<h4 id="Color-Info"><a href="#Color-Info" class="headerlink" title="Color Info"></a>Color Info</h4><p>在渲染的时候把数据信息以颜色的方式渲染到物体上，用于了解特定数据信息。</p>
<h4 id="Unity-Frame-Debugger"><a href="#Unity-Frame-Debugger" class="headerlink" title="Unity Frame Debugger"></a>Unity Frame Debugger</h4><p>Unity提供的的帧调试器，是基于Unity API层面。(Window -&gt; Frame Debug)</p>
<h4 id="VS-Graphics-Debugger"><a href="#VS-Graphics-Debugger" class="headerlink" title="VS Graphics Debugger"></a>VS Graphics Debugger</h4><p>VS提供的基于渲染API层面的调试器。<br>Unity Shader里要写#pragma enable_d3d11_debug_symbols开启DX11渲染</p>
<p>具体调试方法参考：<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-DebuggingD3D11ShadersWithVS.html">Implementing Fixed Function TexGen in Shaders Debugging DirectX 11 shaders with Visual Studio</a></p>
<p>Note:<br>Frames can only be captured if Unity is running under DirectX 11(只能基于DX11)</p>
<h3 id="NVIDIA-NSight"><a href="#NVIDIA-NSight" class="headerlink" title="NVIDIA NSight"></a>NVIDIA NSight</h3><p>NVIDIA公司提供的基于渲染API层面的调试器。<br>之前了解过，好像只支持N卡。具体没有使用过。</p>
<h2 id="Unity中的基础光照"><a href="#Unity中的基础光照" class="headerlink" title="Unity中的基础光照"></a>Unity中的基础光照</h2><h3 id="光照知识回顾"><a href="#光照知识回顾" class="headerlink" title="光照知识回顾"></a>光照知识回顾</h3><p>关于光照的基本学习参考之前OpenGL中的学习：<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Light_and_Shadow">Light and Shadow</a></p>
<p>从上面可以看出Light影响着每一个物体最终颜色的成像计算。</p>
<ol>
<li>环境光(Ambient) – 环境光与光照方向无关，只需考虑方向光的颜色和方向光所占比重，决定着物体的基本颜色。</li>
<li>漫反射(Diffuse) – 与光照的方向和顶点normal有关，决定着不同角度(顶点法线)的顶点反射能力。</li>
<li>镜面反射(Specular) – 与光照的方向和eye观察还有顶点normal有关，决定了不同观察位置的反射高光系数。</li>
</ol>
<h3 id="标准光照模型"><a href="#标准光照模型" class="headerlink" title="标准光照模型"></a>标准光照模型</h3><p>“光照模型 – 根据材质属性(如漫反射属性等)，光源信息(如光源方向，辐照度)，使用一个等式去计算沿某个方向的出射度的过程。”</p>
<p><strong>BRDF(Bidirectional Reflectance Distribution Function)光照模型</strong><br>“当给定射入光线的方向和辐射度后，BRDF可以给出在某个出射方向上的光照能量分布。”</p>
<p>那么什么是标准光照模型了？<br>“标准光照模型只关心直接光照，也就是那些直接从光源发射出来照射到物体表面后，经过物体表面的一次反射直接进入摄像机的光线。”</p>
<p>标准光照模型有四部分组成：</p>
<ol>
<li>自发光(emissive)</li>
<li>高光反射(specular)</li>
<li>漫反射(diffuse)</li>
<li>环境光(ambient)</li>
</ol>
<p>从这里可以看出之前学习OpenGL的光照计算可以算是基于标准光照模型来计算的，只是没有考虑自发光的光照运算。不难看出所谓的光照模型其实就是不同的光照计算公式。</p>
<p>在之前OpenGL的学习里，都是通过顶点法线插值后在Fragment Shader里计算Specular，Diffuse，Ambient来进行光照运算的，这种技术被称为Phong着色(Phong Shading)。(针对每一个fragment进行光照运算)</p>
<p>我们也可以针对每一个顶点进行光照运算，e.g. 高洛德着色(Gouraud shading)。针对每个顶点计算光照后，通过线性插值后最终输出显示。(因此不适合非线性的光照计算显示)</p>
<p>但上述标准光照模型(这里称为Blinn-Phong模型)无法模拟真实的物理现象的效果。<br>“Blinn-Phong模型是各项同性(isotropic)的，也就是说，当我们固定视角和光源方向旋转这个表面时，反射不会发生任何改变。各向异性(anisotropic)反射性质的效果需要机遇物理的光照模型来运算。”</p>
<h4 id="漫反射光照模型"><a href="#漫反射光照模型" class="headerlink" title="漫反射光照模型"></a>漫反射光照模型</h4><h5 id="兰伯特光照模型"><a href="#兰伯特光照模型" class="headerlink" title="兰伯特光照模型"></a>兰伯特光照模型</h5><p>c(light) – 光源颜色信息<br>m(diffuse) – 漫反射系数<br>n – 顶点法线<br>l – 光源方向</p>
<p>兰伯特光照模型:<br>c(diffuse) &#x3D; (c(light)  * m(diffuse)) * max(0, dot(n,l))</p>
<p>基于顶点的兰伯特光照模型Shader：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_World2Object&#x27; with &#x27;unity_WorldToObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 逐顶点的漫反射光照计算Shader</span></span><br><span class="line"><span class="comment">// 逐顶点是在vertex shader里针对每一个vert计算Diffuse光照然后通过顶点颜色插值显示出来</span></span><br><span class="line">Shader <span class="string">&quot;Custom/DiffuseVertexLevelShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Diffuse Light Model</span></span><br><span class="line">    <span class="comment">// c(light) -- 光源颜色信息</span></span><br><span class="line">    <span class="comment">// m(diffuse) -- 漫反射系数</span></span><br><span class="line">    <span class="comment">// n -- 顶点法线</span></span><br><span class="line">    <span class="comment">// l -- 光源方向_WorldToObject</span></span><br><span class="line">    <span class="comment">// c(diffuse) = (c(light)  * m(diffuse)) * max(0, dot(n, l))</span></span><br><span class="line"></span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露漫反射系数c(diffuse)用于动态控制漫反射系数</span></span><br><span class="line">        _Diffuse(<span class="string">&quot;Diffuse&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags &#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为是计算基于Vertex Level的漫反射光照模型计算</span></span><br><span class="line">            <span class="comment">// 所以在vertex shader里已经完成了对光照color的运算</span></span><br><span class="line">            <span class="comment">// 这里只需将结果通过插值传递给fragment shader即可</span></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;</span><br><span class="line">                float3 color : COLOR;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的漫反射系数</span></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 计算漫反射光</span></span><br><span class="line">                <span class="comment">// 为了确保法线从物体坐标系转换到世界坐标系正确，这里需要乘以object2world矩阵的逆矩阵的转置矩阵</span></span><br><span class="line">                <span class="comment">// _World2Object代表object2world的逆矩阵</span></span><br><span class="line">                <span class="comment">// 因为unity使用的是列向量，所以通过mul()_World2Object作为第二个参数相当于左乘_World2Object的转置矩阵</span></span><br><span class="line">                <span class="comment">// 之所以只乘以3x3的矩阵是因为平移变换不会影响法线方向</span></span><br><span class="line">                fixed3 worldnormal = normalize(mul(v.normal, (float3x3)unity_WorldToObject));</span><br><span class="line">                <span class="comment">// 假设只有一个全局direction light</span></span><br><span class="line">                fixed3 worldlightdir = normalize(_WorldSpaceLightPos0.xyz);</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(dot(worldnormal, worldlightdir));</span><br><span class="line">                o.color = ambient + diffuse;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将vertex shader计算出的环境光加漫反射颜色显示出来</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(i.color, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于片元计算的兰伯特光照模型Shader：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_World2Object&#x27; with &#x27;unity_WorldToObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 逐片元的漫反射光照计算Shader</span></span><br><span class="line"><span class="comment">// 逐片元是在fragment shader里针对每一个fragment计算Diffuse光照</span></span><br><span class="line">Shader <span class="string">&quot;Custom/DiffuseFragLevelShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Diffuse Light Model</span></span><br><span class="line">    <span class="comment">// c(light) -- 光源颜色信息</span></span><br><span class="line">    <span class="comment">// m(diffuse) -- 漫反射系数</span></span><br><span class="line">    <span class="comment">// n -- 顶点法线</span></span><br><span class="line">    <span class="comment">// l -- 光源方向</span></span><br><span class="line">    <span class="comment">// c(diffuse) = (c(light)  * m(diffuse)) * max(0, dot(n, l))</span></span><br><span class="line"></span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露漫反射系数c(diffuse)用于动态控制漫反射系数</span></span><br><span class="line">        _Diffuse(<span class="string">&quot;Diffuse&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为是计算基于Fragment Level的漫反射光照模型计算</span></span><br><span class="line">            <span class="comment">// 所以在vertex shader需要把world space的normal传给fragment shader进行diffuse光照运算</span></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;</span><br><span class="line">                float3 worldNormal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的漫反射系数</span></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 计算漫反射光</span></span><br><span class="line">                <span class="comment">// 为了确保法线从物体坐标系转换到世界坐标系正确，这里需要乘以object2world矩阵的逆矩阵的转置矩阵</span></span><br><span class="line">                <span class="comment">// _World2Object代表object2world的逆矩阵</span></span><br><span class="line">                <span class="comment">// 因为unity使用的是列向量，所以通过mul()_World2Object作为第二个参数相当于左乘_World2Object的转置矩阵</span></span><br><span class="line">                <span class="comment">// 之所以只乘以3x3的矩阵是因为平移变换不会影响法线方向</span></span><br><span class="line">                o.worldNormal = normalize(mul(v.normal, (float3x3)unity_WorldToObject));                            </span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 假设只有一个全局direction light</span></span><br><span class="line">                fixed3 worldlightdir = normalize(_WorldSpaceLightPos0.xyz);</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(dot(i.worldNormal, worldlightdir));</span><br><span class="line">                fixed3 color = ambient + diffuse;</span><br><span class="line">                <span class="comment">// 将计算出的环境光加漫反射颜色显示出来</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(color, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题:<br>背光区域没有明暗变化看起来像一个平面。</p>
<h5 id="半兰伯特-Half-Lambert-光照模型"><a href="#半兰伯特-Half-Lambert-光照模型" class="headerlink" title="半兰伯特(Half Lambert)光照模型"></a>半兰伯特(Half Lambert)光照模型</h5><p>c(light) – 光源颜色信息<br>m(diffuse) – 漫反射系数<br>n – 顶点法线<br>l – 光源方向<br>a – a倍漫反射辐射度<br>b – 漫反射辐射度偏移量</p>
<p>半兰伯特光照模型:<br>c(diffuse) &#x3D; c(light)  * m(diffuse) * (a * dot(n,l) + b)</p>
<p>基于片元的半拉伯特特光照模型：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_World2Object&#x27; with &#x27;unity_WorldToObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 逐片元的半兰伯特光照模型没有对漫反射辐射度负值做max处理，</span></span><br><span class="line"><span class="comment">// 而是通过a倍缩放加上b偏移量得出最终的漫反射辐射度，</span></span><br><span class="line"><span class="comment">// 这样一来背面漫反射辐射度也会被映射到不同的值而非0，从而拥有不同的漫反射效果。</span></span><br><span class="line">Shader <span class="string">&quot;Custom/HalfLambertShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Half Labert Model</span></span><br><span class="line">    <span class="comment">// c(light) -- 光源颜色信息</span></span><br><span class="line">    <span class="comment">// m(diffuse) -- 漫反射系数</span></span><br><span class="line">    <span class="comment">// n -- 顶点法线</span></span><br><span class="line">    <span class="comment">// l -- 光源方向</span></span><br><span class="line">    <span class="comment">// a -- a倍漫反射辐射度</span></span><br><span class="line">    <span class="comment">// b -- 漫反射辐射度偏移量</span></span><br><span class="line">    <span class="comment">// 半兰伯特光照模型 :</span></span><br><span class="line">    <span class="comment">// c(diffuse) = c(light)  * m(diffuse) * (a * dot(n, l) + b)</span></span><br><span class="line">        </span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露漫反射系数c(diffuse)用于动态控制漫反射系数</span></span><br><span class="line">        _Diffuse(<span class="string">&quot;Diffuse&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为是计算基于Fragment Level的漫反射光照模型计算</span></span><br><span class="line">            <span class="comment">// 所以在vertex shader需要把world space的normal传给fragment shader进行diffuse光照运算</span></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;</span><br><span class="line">                float3 worldNormal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的漫反射系数</span></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 计算漫反射光</span></span><br><span class="line">                <span class="comment">// 为了确保法线从物体坐标系转换到世界坐标系正确，这里需要乘以object2world矩阵的逆矩阵的转置矩阵</span></span><br><span class="line">                <span class="comment">// _World2Object代表object2world的逆矩阵</span></span><br><span class="line">                <span class="comment">// 因为unity使用的是列向量，所以通过mul()_World2Object作为第二个参数相当于左乘_World2Object的转置矩阵</span></span><br><span class="line">                <span class="comment">// 之所以只乘以3x3的矩阵是因为平移变换不会影响法线方向</span></span><br><span class="line">                o.worldNormal = normalize(mul(v.normal, (float3x3)unity_WorldToObject));</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 假设只有一个全局direction light</span></span><br><span class="line">                fixed3 worldlightdir = normalize(_WorldSpaceLightPos0.xyz);</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// (dot(i.worldNormal, worldlight) * 0.5 + 0.5)将漫反射辐射度映射到[0,1]，背面不再全是0</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * (dot(i.worldNormal, worldlightdir) * <span class="number">0.5</span> + <span class="number">0.5</span>);</span><br><span class="line">                fixed3 color = ambient + diffuse;</span><br><span class="line">                <span class="comment">// 将计算出的环境光加漫反射颜色显示出来</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(color, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:<br>半兰伯特光照模型没有对漫反射辐射度负值做max处理，而是通过a倍缩放加上b偏移量得出最终的漫反射辐射度，这样一来背面漫反射辐射度也会被映射到不同的值，从而拥有不同的漫反射效果。</p>
<h4 id="高光反射光照模型"><a href="#高光反射光照模型" class="headerlink" title="高光反射光照模型"></a>高光反射光照模型</h4><p>c(light) – 光源颜色信息<br>m(specular) – 材质高光反射系数<br>v – 视角方向<br>r – 反射方向<br>n – 顶点法线<br>l – 光源方向<br>m(gloss) – 发光系数</p>
<p>r可以通过n和l计算出来：<br>r &#x3D; 2 * dot(-n,l) * n + l<br>跟OpenGL一样，Unity提供了直接计算反射光线方向的API:reflect(i,n)</p>
<p>c(specular) &#x3D; (c(light) * m(specular)) * pow(max(0,dot(v,r)), m(gloss))<br>上面这个公式和之前在OpenGL之前学习的高光反射并没有太多出入，<a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Light_and_Shadow">详情参考</a></p>
<p>这里主要要区分Phong光照模型和Blinn-Phong光照模型：</p>
<ol>
<li>Phong光照模型<br>c(specular) &#x3D; (c(light) * m(specular)) * pow(max(0,dot(v,r)), m(gloss))<br>dot(v,r) – 是指观察者所在位置和完美反射光线之间夹角</li>
<li>Blinn-Phong光照模型<br>h &#x3D; (v + l) &#x2F; |v + l|<br>c(specular) &#x3D; (c(light) * m(specular)) * pow(max(0,dot(n,h)), m(gloss))<br>dot(n,h) – 是指将v和l向量归一化后的向量与n之间的夹角</li>
</ol>
<p>可以看出来两者在计算高光反射的发光基准系数时采用了不同的运算方式。虽然两者都是经验模型，但后者是对于前者的一种改进方式。</p>
<p>跟漫反射一样，高光反射的计算依然有基于顶点和基于片元之分。<br>基于片元的Phhong高光反射光照模型代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_World2Object&#x27; with &#x27;unity_WorldToObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 逐顶点的环境光+漫反射+Phong高光反射光照计算Shader</span></span><br><span class="line">Shader <span class="string">&quot;Custom/LightModel/PhongSpecularFragLevelShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Specular Light Model</span></span><br><span class="line">    <span class="comment">// c(light) -- 光源颜色信息</span></span><br><span class="line">    <span class="comment">// m(specular) -- 材质高光反射系数</span></span><br><span class="line">    <span class="comment">// v -- 视角方向</span></span><br><span class="line">    <span class="comment">// r -- 光线反射方向</span></span><br><span class="line">    <span class="comment">// n -- 顶点法线</span></span><br><span class="line">    <span class="comment">// l -- 光源方向</span></span><br><span class="line">    <span class="comment">// m(gloss) -- 发光系数</span></span><br><span class="line">    <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(v,r)), m(gloss))</span></span><br><span class="line"></span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露漫反射系数c(diffuse)用于动态控制漫反射系数</span></span><br><span class="line">        _Diffuse(<span class="string">&quot;Diffuse&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;           <span class="comment">// 投影坐标系的顶点位置</span></span><br><span class="line">                float3 worldNormal : NORMAL;        <span class="comment">// 世界坐标系的法线</span></span><br><span class="line">                float3 worldPos : TEXCOORD0;        <span class="comment">// 世界坐标系的顶点位置</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的漫反射系数</span></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 计算漫反射光</span></span><br><span class="line">                <span class="comment">// 为了确保法线从物体坐标系转换到世界坐标系正确，这里需要乘以object2world矩阵的逆矩阵的转置矩阵</span></span><br><span class="line">                <span class="comment">// _World2Object代表object2world的逆矩阵</span></span><br><span class="line">                <span class="comment">// 因为unity使用的是列向量，所以通过mul()_World2Object作为第二个参数相当于左乘_World2Object的转置矩阵</span></span><br><span class="line">                <span class="comment">// 之所以只乘以3x3的矩阵是因为平移变换不会影响法线方向</span></span><br><span class="line">                o.worldNormal = normalize(mul(v.normal, (float3x3)unity_WorldToObject));</span><br><span class="line"></span><br><span class="line">                o.worldPos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 假设只有一个全局direction light</span></span><br><span class="line">                fixed3 worldlightdir = normalize(_WorldSpaceLightPos0.xyz);</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(dot(i.worldNormal, worldlightdir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 光线反射方向</span></span><br><span class="line">                fixed3 reflectdir = normalize(reflect(-worldlightdir, i.worldNormal));</span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(_WorldSpaceCameraPos.xyz - i.worldPos.xyz);</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(v,r)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(reflectdir, viewdir)), _Gloss);</span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                fixed3 color = ambient + diffuse + specular;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将计算出的环境光+漫反射+Phong高光反射颜色显示出来</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(color, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于片元的Blinn-Phhong高光反射光照模型代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_World2Object&#x27; with &#x27;unity_WorldToObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 逐顶点的环境光+漫反射+BlinnPhong高光反射光照计算Shader</span></span><br><span class="line">Shader <span class="string">&quot;Custom/LightModel/BlinnPhongSpecularFragLevelShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Specular Light Model</span></span><br><span class="line">    <span class="comment">// c(light) -- 光源颜色信息</span></span><br><span class="line">    <span class="comment">// m(specular) -- 材质高光反射系数</span></span><br><span class="line">    <span class="comment">// v -- 视角方向</span></span><br><span class="line">    <span class="comment">// r -- 光线反射方向</span></span><br><span class="line">    <span class="comment">// n -- 顶点法线</span></span><br><span class="line">    <span class="comment">// l -- 光源方向</span></span><br><span class="line">    <span class="comment">// m(gloss) -- 发光系数</span></span><br><span class="line">    <span class="comment">// h = (v + l) / |v + l|</span></span><br><span class="line">    <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line"></span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露漫反射系数c(diffuse)用于动态控制漫反射系数</span></span><br><span class="line">        _Diffuse(<span class="string">&quot;Diffuse&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;           <span class="comment">// 投影坐标系的顶点位置</span></span><br><span class="line">                float3 worldNormal : NORMAL;        <span class="comment">// 世界坐标系的法线</span></span><br><span class="line">                float3 worldPos : TEXCOORD0;        <span class="comment">// 世界坐标系的顶点位置</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的漫反射系数</span></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 计算漫反射光</span></span><br><span class="line">                <span class="comment">// 为了确保法线从物体坐标系转换到世界坐标系正确，这里需要乘以object2world矩阵的逆矩阵的转置矩阵</span></span><br><span class="line">                <span class="comment">// _World2Object代表object2world的逆矩阵</span></span><br><span class="line">                <span class="comment">// 因为unity使用的是列向量，所以通过mul()_World2Object作为第二个参数相当于左乘_World2Object的转置矩阵</span></span><br><span class="line">                <span class="comment">// 之所以只乘以3x3的矩阵是因为平移变换不会影响法线方向</span></span><br><span class="line">                o.worldNormal = normalize(mul(v.normal, (float3x3)unity_WorldToObject));</span><br><span class="line"></span><br><span class="line">                o.worldPos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 假设只有一个全局direction light</span></span><br><span class="line">                fixed3 worldlightdir = normalize(_WorldSpaceLightPos0.xyz);</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(dot(i.worldNormal, worldlightdir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(_WorldSpaceCameraPos.xyz - i.worldPos.xyz);</span><br><span class="line">                <span class="comment">// h = (v + l) / |v + l| v和l向量归一化后的向量</span></span><br><span class="line">                fixed3 halfdir = normalize(worldlightdir + viewdir);</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(i.worldNormal, halfdir)), _Gloss);</span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                fixed3 color = ambient + diffuse + specular;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将计算出的环境光+漫反射+BlinnPhong高光反射颜色显示出来</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(color, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果图：<br><img src="/img/Unity/LightModelShader.JPG" alt="LightModelShader"></p>
<p>Note:<br>“如果没有全局光照技术，这些自发光的表面并不会真的着凉周围的物体，而是它本身看起来更亮了而已。”<br><strong>计算机图形学的第一定律：如果它看起来是对的，那么它就是对的。</strong></p>
<p>上面的运算都是我们通过基础的向量，矩阵运算来实现。在Unity中我们可以使用Unity内置的函数来帮助我们快速的计算得到指定结果。详情查看UnityCG.cginc。</p>
<p>Note:<br>“如果没有全局光照技术，这些自发光的表面并不会真的着凉周围的物体，而是它本身看起来更亮了而已。”<br><strong>计算机图形学的第一定律：如果它看起来是对的，那么它就是对的。</strong></p>
<h3 id="Lighting-in-Unity"><a href="#Lighting-in-Unity" class="headerlink" title="Lighting in Unity"></a>Lighting in Unity</h3><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/introduction-lighting-and-rendering?playlist=17102">Global illumination, or ‘GI’, is a term used to describe a range of techniques and mathematical models which attempt to simulate the complex behaviour of light as it bounces and interacts with the world.</a>(GI代表通过技术或者数学模型模拟光照运算交互。e.g. 半兰伯特(Half Lambert)光照模型</p>
<p>Light在Unity主要分为Realtime(相当于Forward Rendering)和Precomputed(预先生成相关光照贴图数据参与光照计算)</p>
<h4 id="Realtime-Lighting"><a href="#Realtime-Lighting" class="headerlink" title="Realtime Lighting"></a>Realtime Lighting</h4><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-lighting-technique?playlist=17102">directional, spot and point, are realtime. This means that they contribute direct light to the scene and update every frame.</a>(实时的顾名思义实时计算光照)</p>
<p>有了实时光照计算为什么还需要Precomputed了？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-lighting-technique?playlist=17102">Unfortunately, the light rays from Unity’s realtime lights do not bounce when they are used by themselves. In order to create more realistic scenes using techniques such as global illumination we need to enable Unity’s precomputed lighting solutions.</a>(从官方原文来看，实时光照并没有计算光照被其他物体反弹之后的运算量，要想更加真实的光照所以需要Precomputed Lighting)</p>
<h4 id="Precomputed-Lighting"><a href="#Precomputed-Lighting" class="headerlink" title="Precomputed Lighting"></a>Precomputed Lighting</h4><p>Static Lightmap(Baked GI Lighting):<br>Lightmap – <a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-lighting-technique?playlist=17102">When ‘baking’ a ‘lightmap’, the effects of light on static objects in the scene are calculated and the results are written to textures which are overlaid on top of scene geometry to create the effect of lighting.</a>(Bake GI Light会生成一张LightMap，这张Lightmap记录了场景里所有静态物体的光照运算结果。)</p>
<p>Note：<br>静态Lightmap一旦生成就不能再被运行时修改，实现不了场景里光照动态变化的效果</p>
<p>Realtime Lightmap(Baked Realtime GI Lighting):<br>Realtime GI Lightmap弥补了Static Lightmap的不足，可以实现预先计算所有实时光照(这里的实时光照是指全局光照(含间接光照的影响计算)))需要的数据去参与运行时全局光照计算。</p>
<p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-lighting-technique?playlist=17102">To speed up the precompute further Unity doesn’t directly work on lightmaps texels, but instead creates a low resolution approximation of the static geometry in the world, called ‘clusters’.</a>(Unity为了加快Precompute速度，Lightmap的运算并不是texels级而是clusters级，可以理解成相对粗糙一点的精确度)</p>
<p>具体使用哪种光照策略取决于用户实际情况(显存，内存，GPU，CPU等)。</p>
<p>Baked Light Rules:</p>
<ol>
<li>Only Static GameObject才会参与Baked Lighting。</li>
<li>Light Bake Mode取决于光照的Bake设置。</li>
<li>Mixed的Bake Mode即会参与Bake也会参与Realtime。</li>
<li>具体Bake设置见Window -&gt; Lighting(设置Bake Static Lightmap还是Realtime)</li>
</ol>
<p>Note:<br>Precomputed Lighting是个典型空间换时间的例子。通过预算生成大量的光照信息Lightmap来避免大量的实时光照运算。</p>
<p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-lighting-technique?playlist=17102">Using both Baked GI and Precomputed Realtime GI together in your scene can be detrimental to performance. A good practise is to ensure that only one system is used at a time, by disabling the other globally. </a>(官方建议，Baked GI和Precomputed Realtime GI两者选其一不建议同时使用，避免性能问题)</p>
<h5 id="Bake-Realtime-Lighting实战"><a href="#Bake-Realtime-Lighting实战" class="headerlink" title="Bake Realtime Lighting实战"></a>Bake Realtime Lighting实战</h5><ol>
<li>Realtime Resolution<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/realtime-resolution?playlist=17102">Realtime Resolution is the number of realtime lightmap texels (texture pixels) used per world unit.</a>(一个world unit使用多少个纹理贴图的像素)</li>
</ol>
<p>这个参数会影响最终Bake出来的光照采样计算结果，同时也会影响Precompute的时间消耗。合适的值取决于场景对于光照采样精度的需求与Bake时间之间的平衡。如果场景小(比如室内)且光源很多那么精度高一点Bake时间长一点是有意义的。如果场景大(比如室外)光源变化不大，那么精度高对最终的采样光照计算结果并没有太大影响只会增加Bake时间，那这样是不值得的。</p>
<ol start="2">
<li>Chart(光照图)<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/understanding-charts?playlist=17102">a Chart is an area of a lightmap texture to which we map the lightmap UVs of a given Scene object. We can think of this as a small tile containing an image of the lighting affecting that object.</a>(Chart表示一个光照贴图，用于映射特定Object的Lightmap UV的信息)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/understanding-charts?playlist=17102">A Chart is made up of two parts: irradiance (lighting) and directionality (encoding the dominant light direction).</a>(Chart由两部分组成:辐射度和光照方向)</p>
<p><img src="/img/Unity/LightmapChart.PNG" alt="LightmapChart"></p>
<p>Note:<br>Unity Unit设置的不同对于Realtime Resolution的选择也会有影响。</p>
<p>Baked GI是生成一张Lightmap Texture用于运行时参与光照计算。Baked Realtime Lighting是将信息存到Lighting Data Asset(包含了运行时生成低分辨率lightmap的相关信息)里用于运行时生成低解析度的光照图。</p>
<p>Chart is a minimum of 4x4 texels(Chart最小是4*4像素)。</p>
<p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/unwrapping-and-chart-reduction?playlist=17102">Charts are created to encompass the UV lightmap coordinates of a Static Mesh Renderer. The number of Charts that an object requires is therefore largely determined by the number of UV shells (pieces) needed to unwrap the object in question.</a>(光照图(Charts)的目的主要是用来包住静态网格着色器(Static Mesh Renderer)的UV贴图坐标。一个物件所需要的光照图数量主要是看物体有多少片UI Shell需要拆解。)</p>
<p>降低Chart的数量是减少Precompute Time的关键因素之一。<br>除了选择合适的Realtime Resolution，还有什么方式可以帮助我们降低Chart数量了？</p>
<ol>
<li>降低Static物体的UV Shells(相当于减少特定物体所需的Lightmap Chart)</li>
<li>减少Static物体(用Lighting Probe实现)</li>
<li>减少Clusters数量(PRGI基础运算单元)</li>
</ol>
<p>在减少UV Shells数量之前，先了解下背后的原理，以及相关帮助和查看窗口：<br>官方的UV Shells拆分示例：<br><img src="/img/Unity/MultipleUVShells.PNG" alt="MultipleUVShells"></p>
<p><img src="/img/Unity/SingleUIShell.PNG" alt="SingleUIShell"></p>
<p>查看LightmapChart:<br>Scene -&gt; Draw Mode -&gt; GI -&gt; UV Chart<br><img src="/img/Unity/UVChart.PNG" alt="UVChart"></p>
<p>查看特定物件的UV Chart:</p>
<ol>
<li>选中要查看的物体</li>
<li>Window -&gt; Lighting -&gt; Obejct</li>
<li>左上角选择Chart模式</li>
</ol>
<p><img src="/img/Unity/SpecificObjectUVChart.PNG" alt="SpecificObjectUVChart"><br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-6.html">Charting模式的预览视窗会用不同的颜色的格子表示光照图，并用浅蓝色的线表示UV贴图。</a></p>
<p>更多关于UV Chart生成相关的因素，参考:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/unwrapping-and-chart-reduction?playlist=17102">Unwrapping and Chart reduction</a></p>
<p>这里简单提一下:<br>Mesh Renderer上面的:</p>
<ol>
<li>Auto UV Max Distance(自動最大UV距離)</li>
<li>Auto UV Max Angle(自動最大UV角度)</li>
<li>Preserve UVs(保留UV)</li>
<li>Ignore Normals(忽略法線)</li>
</ol>
<p>开启Auto Lighting，然后调节相关数值通过UV Chart Preview帮助我们快速查看UV Chart实时效果。</p>
<p>如何通过UV Chats判定失真程度？<br><img src="/img/Unity/UVChartDistortionAnalysi.PNG" alt="UVChartDistortionAnalysi"><br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-6.html">当启用UI Charts绘制模式时，失真的程度能从场景里的棋盘圆拉扯状况来评估。</a></p>
<p>如何正确使用Probe Lighting减少Static物体参与PRGI？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/probe-lighting?playlist=17102">Probe lighting is a fast technique for approximating lighting in realtime rendering applications such as games.</a>(光照探测技术是一个能在游戏里让即时光照更逼真的快速演算法)</p>
<p>原理：<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/probe-lighting?playlist=17102">Probe lighting works by sampling the incoming lighting at a specific point in 3D space and encoding this information across a sphere using mathematical functions known as spherical harmonics. These coefficients have low storage cost and can be then be quickly ‘unpacked’ at gameplay and used by shaders within the Scene to approximate surface lighting.</a>(光照探测的原理是透过放在3D空间里的探针来接受照明信息，然后用像球鞋函数(spherical harmonics)的数学算法将结果编码在一个球体上，这些信息暂用空间很小，但在游戏运行时解包很快，并参与表面光照计算)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-5.html">我們的目的是取样场景里的间接或反射光照。为了让每个光照探头效能花在刀口上， 尽量确保他们对一些变化明显的地方进行采样</a></p>
<p>如何减少Cluster数量？<br>让我们先通过查看贴图了解下Cluster真实情况：<br><img src="/img/Unity/ClusterPicture.PNG" alt="ClusterPicture"></p>
<p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/understanding-clusters?playlist=17102">Clusters sample the albedo of the Static geometry to which they are mapped. Then, during the Light Transport stage of the precompute, the relationship between these Clusters is calculated so that light can be propagated throughout the Cluster network.</a><br>(Cluster会对静态物体表面的反射率(Albedo)进行采样，在光照传递计算阶段计算Cluster之间的关系好让光在整个Cluster网之间传递)</p>
<p><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-7.html">一旦与计算完成后，你就可以修改Skybox或光线的位置，强度和颜色，不需要重新与计算，光线就会透过这些Cluster网信息，联通场景材质和发光材质一并考虑计算光照反射。</a></p>
<p><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-7.html">Clustering或Lit Clustering Scene Mode模式来观察Cluster分布</a></p>
<p>了解了Cluster相关知识概念后，那么如何真正降低Cluster数量了？<br>Lightmap Parameters控制，用于公用。<br>Asset &gt; Create &gt; Lightmap Parameters<br>通过GameObejct -&gt; Mesh Renderer -&gt; Lightmao Parameters指定<br><img src="/img/Unity/LightMapParameter.PNG" alt="LightMapParameter"></p>
<p>具体参数详细学习参考:<br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-8.html">Unity預計算即時GI - 8.微調光照參數</a></p>
<p>PRGI实战：</p>
<ol>
<li>设置需要Bake的物体为Static(规划好层级可快速批量设置Static)</li>
<li>Window -&gt; Lighting -&gt; Build(勾选Auto，自动触发Precompute)</li>
<li>减少Lightmap Chart数量(部分物体(比如凸起的小物件)用Lighting Probe技术而非Static)</li>
<li>管理Lighting Probe(创建GameObject &gt; Light &gt; Light Probe Group)</li>
<li>放置Lighting Probe(GameObject &gt; Light &gt; Light Probe Group -&gt; Edit Light Probes)</li>
</ol>
<p>Baked Lighting AssetBundle实战：<br>目标：</p>
<ol>
<li>Baked Lighting，通过打包AB的形式加载还原Baked Lighting</li>
<li>支持Reflection Probe的AB加载还原(这个只是单纯加载了依赖的Cubemap没有做任何的还原操作，暂时表现是对的，具体待学习了解)</li>
</ol>
<p>实战：</p>
<ol>
<li>新建一个场景，添加必要的物件与光照</li>
<li>设置需要Bake的物体为Static</li>
<li>减少Lightmap Chart数量(部分物体(比如凸起的小物件)用Lighting Probe技术而非Static)</li>
<li>设置所有需要参与Bake的光照为Baked模式(只用于Baked Lighting)</li>
<li>Window -&gt; Lighting -&gt; Build(勾选Auto，自动触发Precompute Lightmap)</li>
<li>删除所有完成静态烘焙的Light</li>
<li>记录场景里所使用的光照信息(LightmapSettings.lightmaps)以及所有参与了静态光照的静态物体所使用的光照图信息(Renderer.lightmapIndex和Renderer.lightmapScaleOffset)</li>
<li>运行时加载所有依赖的光照贴图信息，并还原所有静态物体使用的光照贴图信息</li>
</ol>
<p>烘焙之后的场景光照使用信息:<br><img src="/img/Unity/LightmapBake.PNG" alt="LightmapBake"></p>
<p>烘焙之后记录下场景使用的光照信息运行时还原:</p>
<p>打包场景AB以及光照信息记录代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sceneasset = AssetDatabase.LoadAssetAtPath&lt;Object&gt;(abfullpath);</span><br><span class="line">AssetImporter assetimporter = AssetImporter.GetAtPath(abfullpath);</span><br><span class="line"><span class="keyword">var</span> abname = ABPackageHelper.Singleton.getABTypeCorrespondingName(EABType.E_AB_SCENE, sceneasset.name);</span><br><span class="line">assetimporter.assetBundleName = abname;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录Lightmap相关信息，加载场景时用于还原Lightmap</span></span><br><span class="line"><span class="keyword">var</span> scenename = Path.GetFileNameWithoutExtension(abfullpath);</span><br><span class="line"></span><br><span class="line"><span class="comment">//打开需要打包的场景</span></span><br><span class="line"><span class="keyword">var</span> scene = EditorSceneManager.OpenScene(abfullpath);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> scenego = GameObject.Find(scenename);</span><br><span class="line"><span class="keyword">var</span> lmr = scenego.GetComponent&lt;LightMapRestore&gt;();</span><br><span class="line"><span class="keyword">if</span> (lmr != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    GameObject.DestroyImmediate(lmr);</span><br><span class="line">&#125;</span><br><span class="line">lmr = scenego.AddComponent&lt;LightMapRestore&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录Lightmap使用信息</span></span><br><span class="line">Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;LightmapSettings.lightmaps.Length = &#123;0&#125;&quot;</span>, LightmapSettings.lightmaps.Length));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试目的，暂时只默认只有一个Lightmap</span></span><br><span class="line">lmr.LightMapColor = LightmapSettings.lightmaps[<span class="number">0</span>].lightmapColor == <span class="literal">null</span> ? <span class="built_in">string</span>.Empty : LightmapSettings.lightmaps[<span class="number">0</span>].lightmapColor.name;</span><br><span class="line">lmr.LightMapDir = LightmapSettings.lightmaps[<span class="number">0</span>].lightmapDir == <span class="literal">null</span> ? <span class="built_in">string</span>.Empty : LightmapSettings.lightmaps[<span class="number">0</span>].lightmapDir.name;</span><br><span class="line">lmr.LightMapDataList = <span class="keyword">new</span> List&lt;LightMapData&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印所有烘焙对象的Lightmap相关信息(测试查看)</span></span><br><span class="line"><span class="keyword">var</span> allrootgos = scene.GetRootGameObjects();</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> m = <span class="number">0</span>; m &lt; allrootgos.Length; m++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> allmeshcom = allrootgos[m].transform.GetComponentsInChildren&lt;Renderer&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> n = <span class="number">0</span>; n &lt; allmeshcom.Length; n++)</span><br><span class="line">    &#123;</span><br><span class="line">        LightMapData lmd = <span class="keyword">new</span> LightMapData();</span><br><span class="line">        lmd.RendererObject = allmeshcom[n];</span><br><span class="line">        lmd.LightMapIndex = allmeshcom[n].lightmapIndex;</span><br><span class="line">        lmd.LightMapScaleOffset = allmeshcom[n].lightmapScaleOffset;</span><br><span class="line">        lmr.LightMapDataList.Add(lmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存场景</span></span><br><span class="line">EditorSceneManager.SaveScene(scene);</span><br><span class="line"></span><br><span class="line">AssetDatabase.Refresh();</span><br></pre></td></tr></table></figure>

<p>还原代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line">[<span class="meta">System.Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LightMapData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Renderer RendererObject;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> LightMapIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector4 LightMapScaleOffset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 静态光照烘焙还原</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LightMapRestore</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LightMapColor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LightMapDir;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;LightMapData&gt; LightMapDataList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 还原各静态烘焙物体的lightmap信息</span></span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> lmd <span class="keyword">in</span> LightMapDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;还原&#123;0&#125;Lightmap信息:LightMapIndex:&#123;1&#125; LightMapScaleOffset:&#123;2&#125;&quot;</span>, lmd.RendererObject.name, lmd.LightMapIndex, lmd.LightMapScaleOffset));</span><br><span class="line">            lmd.RendererObject.lightmapIndex = lmd.LightMapIndex;</span><br><span class="line">            lmd.RendererObject.lightmapScaleOffset = lmd.LightMapScaleOffset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>光照信息记录:<br><img src="/img/Unity/LightMapData.PNG" alt="LightMapData"></p>
<p>加载还原后的效果:<br><img src="/img/Unity/LightMapRestore.PNG" alt="LightMapRestore"></p>
<p>那如何Bake多份Lightmap进行动态切换了？<br>Unity 5.X如果想Bake多份Lightmap，需要复制保留之前Bake出的Texture，然后通过修改LightmapSetting的值即可(因为是同一个场景，静态物体的lightmapIndex和lightmapScaleOffset值都没变，所以直接切换LightmapSetting里的lightmaps即可)。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lightmaptex = TextureResourceLoader.getInstance().loadTexture(newlightmapname);</span><br><span class="line"><span class="keyword">var</span> newlightmapdata = <span class="keyword">new</span> LightmapData();</span><br><span class="line">newlightmapdata.lightmapColor = lightmaptex;</span><br><span class="line">LightmapSettings.lightmaps = <span class="keyword">new</span> LightmapData[] &#123; newlightmapdata &#125;;</span><br></pre></td></tr></table></figure>

<p>参考文章：<br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unity-gi-1.html">Introduction to Precomputed Realtime GI</a><br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unity-gi-1.html">Unity預計算即時GI</a></p>
<h4 id="Render-Path"><a href="#Render-Path" class="headerlink" title="Render Path"></a>Render Path</h4><p>Forward Rendering<br>实时光照运算，计算量跟灯光数量成正比</p>
<p>Deffered Rendering<br>实时光照运算，计算量跟Pixels数量成正比而非光照</p>
<p>Edit -&gt; Project Setting -&gt; Player -&gt; Rendering -&gt; Rendering Path</p>
<h4 id="Color-Space"><a href="#Color-Space" class="headerlink" title="Color Space"></a>Color Space</h4><p>Linear Color Space<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-color-space?playlist=17102">A significant advantage of using Linear space is that the colors supplied to shaders within your scene will brighten linearly as light intensities increase.</a></p>
<p>Gamma Color Space<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-color-space?playlist=17102">Gamma’ Color Space, brightness will quickly begin to turn to white as values go up, which is detrimental to image quality.</a></p>
<p>Edit -&gt; Project Setting -&gt; Player -&gt; Rendering -&gt; Color Space</p>
<h3 id="High-Dynamic-Range"><a href="#High-Dynamic-Range" class="headerlink" title="High Dynamic Range"></a>High Dynamic Range</h3><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/high-dynamic-range-hdr?playlist=17102">HDR(High Dynamic Range) defines how extremely bright or dark colors are captured by scene cameras.</a>(HDR决定光照颜色信息精度)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/high-dynamic-range-hdr?playlist=17102"> HDR is unsupported by some mobile hardware. It is also not supported in Forward Rendering when using techniques such as multi-sample anti-aliasing (MSAA).</a>(Forward Rendering使用MSAA时不支持HDR)</p>
<p>待续</p>
<h2 id="基础纹理"><a href="#基础纹理" class="headerlink" title="基础纹理"></a>基础纹理</h2><h3 id="纹理类型分类"><a href="#纹理类型分类" class="headerlink" title="纹理类型分类"></a>纹理类型分类</h3><p>一下以Unity支持的导入设置纹理格式来分(一下只重点关注几个重要的)：<br>Note:<br>随着Unity版本的变化，以下格式可能有细微变化(比如5.4里面的Adavanced已经没有了，取而代之的是细分到其他几个类型里)</p>
<h4 id="Delfaut-Advanced"><a href="#Delfaut-Advanced" class="headerlink" title="Delfaut(Advanced)"></a>Delfaut(Advanced)</h4><p>这个是Unity在高版本默认的纹理格式，也是平时我们最常用的纹理格式之一。</p>
<p>如果要想将2D纹理图片作为纹理渲染到3D物体上，我们需要选择Default进行纹理格式的基本导入设置。</p>
<p>这里只提几个比较重要的设置，后续会讲到相关的概念。</p>
<ol>
<li>Non Power of 2(用于将不是2的倍数的纹理图片进行优化处理成2的倍数的宽高)</li>
<li>Generate Mip Maps(预生成多个不同大小的纹理图片，用于不同距离是显示，解决很大的纹理在显示很小的时候失真和浪费的问题)</li>
<li>Wrap Mode(用于设置处理在tiled纹理图片时的方式)</li>
</ol>
<h4 id="Normal-Map"><a href="#Normal-Map" class="headerlink" title="Normal Map"></a>Normal Map</h4><p>在之前的OpenGL学习中已经接触过Normal Map了，这里只是简单说一下什么是和为什么需要Normal Map。</p>
<p>什么是Normal Map?<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Normal_Mapping">Normal Mapping也叫做Dot3 Bump Mapping,它也是Bump Mapping的一种，区别在于Normal Mapping技术直接把Normal存到一张NormalMap里面，从NormalMap里面采回来的值就是Normal，不需要像HeightMap那样再经过额外的计算。<br>值得注意的是，NormalMap存的Normal是基于切线空间的，因此要进行光照计算时，需要把Normal,Light Direction,View direction统一到同一坐标空间中。</a></p>
<p>至于什么是Bump Mapping，为什么normal map的normal值是存在tangent space，什么是tangent space，详情参考：<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Normal_Mapping">Normal Map</a></p>
<p>为什么需要Normal Map？<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Normal_Mapping">如果要在几何体表面表现出凹凸不平的细节，那么在建模的时候就会需要很多的三角面，如果用这样的模型去实时渲染，出来的效果是非常好，只是性能上很有可能无法忍受。Bump Mapping不需要增加额外的几何信息,就可以达到增强被渲染物体的表面细节的效果，可以大大地提高渲染速度，因此得到了广泛的应用。</a></p>
<h4 id="Sprite"><a href="#Sprite" class="headerlink" title="Sprite"></a>Sprite</h4><p>这个是我们制作UI和2D游戏最常用的格式。</p>
<p>这里也将几个Sprite比较重要的设置：</p>
<ol>
<li>Packing Tag(Unity自带的打包图集工具所使用用于决定哪些图片时打在同一个图集里的标识。采用TexturePacker单独处理图片格式以及图集见后面)</li>
<li>Pixels Per Unit(用于决定图片在屏幕上的映射显示大小，这个以及Camera Orthographic Size会影响我们制作Sprite时的大小标准以及Pixel Perfect显示。详情参考之前的学习<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#Unity_Unit_&_Pixel_Per_Unit">Unity Unit &amp; Pixel Per Unit</a>和<a href="http://tonytang1990.github.io/2016/12/11/Unity-Plugins/#NGUI_2-7%E5%B1%8F%E5%B9%95%E8%87%AA%E9%80%82%E5%BA%94">NGUI 2.7屏幕自适应</a>)</li>
<li>Generate Mip Maps(这个概念和前面Default提到的一样，但大部分时候UI和2D游戏都不需要设置这个，因为UI一般不会有太大的大小变化，2D游戏里的图片同理)</li>
</ol>
<h4 id="Lightmap"><a href="#Lightmap" class="headerlink" title="Lightmap"></a>Lightmap</h4><p>待学习</p>
<p>更多的纹理格式还有Editor GUI and Legacy, Cursor, Cookier, Single Channel这里就不一一详解了，详情参见[TextureTypes]](<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TextureTypes.html">https://docs.unity3d.com/Manual/TextureTypes.html</a>)</p>
<h3 id="纹理大小"><a href="#纹理大小" class="headerlink" title="纹理大小"></a>纹理大小</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/ImportingTextures.html#TextureSizes">Ideally, Texture dimension sizes should be powers of two on each side (that is, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048 pixels (px), and so on). The Textures do not have to be square; that is the width can be different from height.</a></p>
<p>上面是Unity官方给出的建议，Texture纹理大小宽高最好是2的N次方倍数。</p>
<p>那么为什么会有Power Of 2这个原则了？</p>
<ol>
<li>硬件GPU(以前的GPU还不支持Non Power Of 2大小的Texture加载。现在虽然支持了但Power Of 2的加载速度始终要比Non Power Of 2快)</li>
<li>内存使用(None Power Of 2的Texture在分配内存时始终会分配最近的Power Of 2大小，如果不采用Power Of 2的Texture会浪费部分内存分配)</li>
<li>纹理压缩格式支持(有些纹理压缩格式只支持特定宽高的纹理图片，比如DXT1只支持mutilple of 4的Texture Size压缩)</li>
</ol>
<p>Texture的最大Size受限于渲染API(相当于硬件所支持的API)等级有关：<br><img src="/img/Unity/TextureMaxSize.JPG" alt="TextureMaxSize"></p>
<p>Note:<br>如果我们想在Unity里使用Non Power Of 2的Texture，我们需要在导入Texture时手动设置成NPO2，不然Unity会自动帮我们转换成Power Of 2的Texture。</p>
<p>参考文章：<br><a target="_blank" rel="noopener" href="https://software.intel.com/en-us/articles/opengl-performance-tips-power-of-two-textures-have-better-performance">OpenGL* Performance Tips: Power of Two Textures Have Better Performance</a></p>
<h3 id="图片格式"><a href="#图片格式" class="headerlink" title="图片格式"></a>图片格式</h3><p>图片是游戏里使用最基础也是最频繁的资源，图片的格式是决定内存占用多少的关键。</p>
<p>所以这里需要了解为什么图片格式会影响最终的内存占用以及如何选择正确的图片格式达到最低的内存占用实现我们所需的效果。以及相关工具帮助我们优化图片内存占用的问题。</p>
<p>图片加载内存计算方式？<br>图片宽度 * 图片高度 * 每个像素点的位数 &#x3D; 内存大小</p>
<p>图片格式决定了每个像素点的位数的多少，比如RGBA8888（32-bit图）代表每个像素点存储了8 bit的R,G,B,A(分别代表红绿蓝透明通道)，总共32 bit即4 byte大小。</p>
<p>所以1024 * 1024大小的RGBA8888的图片所需内存占用计算如下：<br>1024 * 1024 * 4byte &#x3D; 4M</p>
<p>图片格式有哪些？<br>以下引用至<a target="_blank" rel="noopener" href="http://blog.csdn.net/u011476173/article/details/38712031">图片格式及内存占用</a>:<br>(1)RGBA8888(32-bit)<br>    RGBA 4个通道各占8位，如果想获得最好的图片质量，使用这种格式最靠谱，但他占用的内存会比16位的纹理多一倍，加载速度相对较慢。<br>（2）RGBA4444(16-bit)<br>    RGBA 4个通道各占4位，他对每个通道都有不错的支持，还能保证相对良好的图片质量，以及加载速度和内存占用。<br>（3）RGB5A1   (16-bit)<br>    RGB 3个通道各占5位，A通道仅占一位，RGB通道表现良好，A通道只有透明和不透明两种，加载速度和内存占用表现良好。<br>（4）RGB565   (16-bit)<br>    RGB 3个通道分别占5、6、5位，没有A通道，在16为纹理中，图片质量最好。</p>
<p>如何选择正确的图片格式？<br>了解各个图片格式的详细信息后，图片格式的选取根据具体需求而定。取舍主要在于内存占用和显示质量。待深入度研究。</p>
<p>参考文章：<br><a target="_blank" rel="noopener" href="http://blog.csdn.net/u011476173/article/details/38712031">图片格式及内存占用</a></p>
<h3 id="纹理压缩方式"><a href="#纹理压缩方式" class="headerlink" title="纹理压缩方式"></a>纹理压缩方式</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/class-TextureImporterOverride.html">While Unity supports many common image formats as source files for importing your Textures (such as JPG, PNG, PSD and TGA), these formats are not used during realtime rendering by 3D graphics hardware such as a graphics card or mobile device. 3D graphics hardware requires Textures to be compressed in specialized formats which are optimised for fast Texture sampling. The various different platforms and devices available each have their own different proprietary formats.</a></p>
<p>从上述官网描述可以看出，我们游戏最终使用的纹理格式并非最初我们导入的JPG,PNG,PSD or TGA，而是经过特定压缩方式(ETC,PVRTC,ATC,DXT……)压缩后的指定纹理格式的Texture，目的是为了运行使用Texture时更高效，内存占用和显示质量上可以做取舍。</p>
<p>各平台主流通用的纹理压缩方式：<br>PC – DXT<br>Android – ETC<br>IOS – PVRTC</p>
<h3 id="Unity纹理使用"><a href="#Unity纹理使用" class="headerlink" title="Unity纹理使用"></a>Unity纹理使用</h3><p>下面是个人总结的部分知识点：<br>Unity最终使用的不是我们最初导入到项目工程里的JPG,PNG等，而是通过根据指定压缩方式(e.g. ETC)得到的特定纹理格式(e.g. RGBA8888)的纹理图片，目的是为了减少内存开销以及加快GPU的纹理采样速度。</p>
<p>如何选择正确的纹理格式？<br>了解各个纹理格式的详细信息后，纹理格式的选取根据具体需求而定。取舍主要在于内存占用和显示质量之间。</p>
<p>那么有什么相关工具可以帮助我们优化图片使用过程中的内存占用问题吗？<br>答案是：SpritePacker(Unity官方自带工具，最新的Unity 2017貌似推出了Sprite Atlas，打包图集更加灵活) 和 TexturePacker(第三方工具，打包图集(优化空白处减少内存开销，指定图集导出格式减少内存占用，减少drawcall等好处))</p>
<p>那么使用哪一个(Sprite Packer or Texture Packer)用于Unity图集打包工具更好了？<br>Unity通过SpritePacker模糊了图集的概念，通过Sprite Packer设置Tag打包的图集只有在最后打包的时候才会被打进包里。Sprite Packer虽然与Unity开发结合的比较紧密，但灵活度上有所欠缺，Unity 2017推出的Sprite Atlas在灵活度上加强了不少。<br>TexturePacker作为第三方工具，结合Unity使用灵活度更高，可以自定义图集打包的各项参数等，最终放到Unity里的图集是已经打包好的图集。<br>就当前5.4版本的Unity而言，在没有Sprite Altas的前提下，个人觉得采用Texture Packer会更灵活一些，通过Texture Packer我们可以预先打出图集，然后直接将图集打包成ab。</p>
<h4 id="纹理的基础使用"><a href="#纹理的基础使用" class="headerlink" title="纹理的基础使用"></a>纹理的基础使用</h4><p>纹理最基础的应用是用于模型外观。</p>
<p>我们直接来看看BlinnPhong光照模型结合纹理贴图的使用代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Blinn-Phong光照模型结合单独的纹理使用Shader</span></span><br><span class="line">Shader <span class="string">&quot;Custom/Texture/SingleTextureShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">        <span class="comment">// 给Material面板暴露纹理图片</span></span><br><span class="line">        _MainTex (<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line">            </span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;       <span class="comment">// 物体坐标系顶点位置</span></span><br><span class="line">                float3 normal : NORMAL;         <span class="comment">// 物体坐标系法线</span></span><br><span class="line">                float4 texcoord : TEXCOORD0;    <span class="comment">// 纹理</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;       <span class="comment">// 投影坐标系顶点位置</span></span><br><span class="line">                float3 worldnormal : TEXCOORD0; <span class="comment">// 世界坐标系法线</span></span><br><span class="line">                float3 worldpos : TEXCOORD1;    <span class="comment">// 世界坐标系顶点位置</span></span><br><span class="line">                float2 uv : TEXCOORD2;          <span class="comment">// 纹理映射信息</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss; </span><br><span class="line">            <span class="comment">// 对应材质面板的纹理贴图</span></span><br><span class="line">            sampler2D _MainTex;</span><br><span class="line">            <span class="comment">// 纹理材质的纹理属性(e.g. 纹理缩放值，偏移值)</span></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">            </span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                o.worldnormal = normalize(UnityObjectToWorldNormal(v.normal));</span><br><span class="line">                o.worldpos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                <span class="comment">// 通过纹理基础信息和纹理属性得出纹理映射UV坐标</span></span><br><span class="line">                <span class="comment">// TRANSFORM_TEX() == (tex.xy * name##_ST.xy + name##_ST.zw)</span></span><br><span class="line">                o.uv = TRANSFORM_TEX(v.texcoord, _MainTex);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 使用纹理贴图的颜色信息作为漫反射系数</span></span><br><span class="line">                fixed3 albedo = tex2D(_MainTex, i.uv).rgb;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz * albedo;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//漫反射</span></span><br><span class="line">                <span class="comment">// 顶点光线入射向量</span></span><br><span class="line">                fixed3 worldlightdir = normalize(UnityWorldSpaceLightDir(i.worldpos.xyz));</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * albedo * saturate(dot(i.worldnormal, worldlightdir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 高光反射</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(UnityWorldSpaceViewDir(i.worldpos.xyz));</span><br><span class="line">                <span class="comment">// h = (v + l) / |v + l| v和l向量归一化后的向量</span></span><br><span class="line">                fixed3 halfdir = normalize(worldlightdir + viewdir);</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(i.worldnormal, halfdir)), _Gloss);</span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Specular&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/SimpleTextureShader.JPG" alt="BlinnPhong光照模型的纹理使用"></p>
<h4 id="Mipmap"><a href="#Mipmap" class="headerlink" title="Mipmap"></a>Mipmap</h4><p>说到纹理的使用，这里不得不提的就是Mipmap的应用：<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Texture_Mapping">mipmap主要是由于物体在场景中因为距离的缘故会在屏幕显示的大小有变化，如果我们在物体很远，只需要显示很小一块的时候还依然采用很大的纹理贴图，最终显示在屏幕上的纹理会很不清晰（失真）。为了解决这个问题，mipmap应运而生，通过事先生成或指定多个级别的同一纹理贴图，然后在程序运作的过程中通过计算算出应该使用哪一个等级的纹理贴图来避免大纹理小色块失真的问题。</a></p>
<p>在Unity为Texture开启Mipmap，我们需要把纹理类型设置成Advanced，然后勾选Generate Mip Map即可：<br><img src="/img/Unity/TextureMipmapImportSetting.JPG" alt="TextureMipmapImportSetting"></p>
<p>需要注意的是，Unity开启Mipmap后会导致资源纹理内存占用增加。关于Advanced纹理的各个详细参数信息参考<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TextureTypes.html">Texture Import Setting</a></p>
<p>Note:<br>注意纹理在DX和OpenGL里的起点不一样，DX是左上角(0,0)，OpenGL和Unity是左下角(0,0)。</p>
<h4 id="凹凸映射"><a href="#凹凸映射" class="headerlink" title="凹凸映射"></a>凹凸映射</h4><p>这里的凹凸映射指的就是之前OpenGL学习的Normal Mapping和Bump Mapping，这里直接使用之前的总结：高模normal map用于低模模型上，即不增加渲染负担又能增加渲染细节。</p>
<p>还有一个凹凸映射叫做高度纹理(Height Map)，一般用于存储地形高度信息。</p>
<h5 id="Height-Map"><a href="#Height-Map" class="headerlink" title="Height Map"></a>Height Map</h5><p>用于存储高度信息，通常用于地形的Height Map。</p>
<h5 id="Normal-Mapping"><a href="#Normal-Mapping" class="headerlink" title="Normal Mapping"></a>Normal Mapping</h5><p>关于Normal Mapping要注意的地方主要是两点：</p>
<ol>
<li>存储的法线信息是基于切线空间的，需要转换计算位于世界坐标系的法线信息。</li>
<li>纹理贴图的信息范围是[0,1]，而法线信息时[-1,1]需要通过映射转换。</li>
</ol>
<p><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Normal_Mapping">Normal Mapping详细信息参考</a></p>
<p>这里直接给出使用Unity编写Normal Mapping的使用代码和效果(以下代码采用的是将切线空间的法线转换到世界坐标系参与光照计算的方法)：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line">Shader <span class="string">&quot;Custom/Texture/NormalMappingShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露主纹理</span></span><br><span class="line">        _MainTex(<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 给Material面板暴露法线贴图</span></span><br><span class="line">        <span class="comment">// bump是Unity自带的法线纹理</span></span><br><span class="line">        _NormalMap(<span class="string">&quot;Normal Map&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;bump&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 法线贴图的有效程度，用于控制凹凸程度</span></span><br><span class="line">        _BumpScale(<span class="string">&quot;Bump Scale&quot;</span>, Float) = <span class="number">1.0</span></span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;       <span class="comment">// 物体坐标系顶点位置</span></span><br><span class="line">                float3 normal : NORMAL;         <span class="comment">// 物体坐标系法线</span></span><br><span class="line">                float4 tangent : TANGENT;       <span class="comment">// 切线空间的顶点切线(用于计算切线空间的坐标系)</span></span><br><span class="line">                float4 texcoord : TEXCOORD0;    <span class="comment">// 纹理位置信息(用于通过采样获取纹理的UV信息)</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;       <span class="comment">// 投影坐标系顶点位置</span></span><br><span class="line">                float4 uv : TEXCOORD0;          <span class="comment">// 主纹理和法线纹理的UV坐标信息(xy为主纹理的UV，zw为法线纹理的UV，用于后续的纹理采样)</span></span><br><span class="line">                float4 ttow0 : TEXCOORD1;       <span class="comment">// 切线空间y轴转换到世界坐标系后的y轴</span></span><br><span class="line">                float4 ttow1 : TEXCOORD2;       <span class="comment">// 切线空间x轴转换到世界坐标系后的x轴</span></span><br><span class="line">                float4 ttow2 : TEXCOORD3;       <span class="comment">// 切线空间z轴转换到到世界坐标系后的z轴</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的纹理贴图</span></span><br><span class="line">            sampler2D _MainTex;</span><br><span class="line">            <span class="comment">// 纹理材质的纹理属性(e.g. 纹理缩放值，偏移值)</span></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">            <span class="comment">// 对应材质面板法线贴图</span></span><br><span class="line">            sampler2D _NormalMap;</span><br><span class="line">            <span class="comment">// 法线贴图材质的纹理属性(e.g. 纹理缩放值，偏移值)</span></span><br><span class="line">            float4 _NormalMap_ST;</span><br><span class="line">            <span class="comment">// 对应材质面板法线贴图有效程度参数</span></span><br><span class="line">            <span class="built_in">float</span> _BumpScale;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 通过tangent和normal值计算出将tangent转换到世界坐标系的矩阵(世界坐标系下的XYZ轴)</span></span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// **_ST</span></span><br><span class="line">                <span class="comment">// x contains X tiling value</span></span><br><span class="line">                <span class="comment">// y contains Y tiling value</span></span><br><span class="line">                <span class="comment">// z contains X offset value</span></span><br><span class="line">                <span class="comment">// w contains Y offset value</span></span><br><span class="line">                <span class="comment">// 主纹理的UV信息</span></span><br><span class="line">                o.uv.xy = v.texcoord.xy * _MainTex_ST.xy + _MainTex_ST.zw;</span><br><span class="line">                <span class="comment">// 法线纹理的UV信息</span></span><br><span class="line">                o.uv.zw = v.texcoord.xy * _NormalMap_ST.xy + _NormalMap_ST.zw;</span><br><span class="line"></span><br><span class="line">                float3 worldpos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                <span class="comment">// 世界坐标系下的normal(相当于y轴)</span></span><br><span class="line">                fixed3 worldnormal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line">                <span class="comment">// 世界坐标系下的tangent(相当于x轴)</span></span><br><span class="line">                fixed3 worldtangent = UnityObjectToWorldDir(v.tangent.xyz);</span><br><span class="line">                <span class="comment">// 世界坐标系下的normal和tangent计算出binormal</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的binormal(相当于z轴)</span></span><br><span class="line">                fixed3 worldbinormal = cross(worldnormal, worldtangent) * v.tangent.w;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 填充从tangent space转换到world space的矩阵</span></span><br><span class="line">                <span class="comment">// 注意因为是列向量，所以注意填充方式</span></span><br><span class="line">                <span class="comment">// worldpos填充在w后续使用</span></span><br><span class="line">                o.ttow0 = float4(worldtangent.x, worldbinormal.x, worldnormal.x, worldpos.x);</span><br><span class="line">                o.ttow1 = float4(worldtangent.y, worldbinormal.y, worldnormal.y, worldpos.y);</span><br><span class="line">                o.ttow2 = float4(worldtangent.z, worldbinormal.z, worldnormal.z, worldpos.z);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 世界坐标系顶点位置</span></span><br><span class="line">                fixed3 worldpos = float3(i.ttow0.w,i.ttow1.w,i.ttow2.w);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 计算世界坐标系的法线信息</span></span><br><span class="line">                <span class="comment">// bump为切线空间的法线信息</span></span><br><span class="line">                fixed3 bump = UnpackNormal(tex2D(_NormalMap, i.uv.zw));</span><br><span class="line"></span><br><span class="line">                bump.xy *= _BumpScale;</span><br><span class="line">                bump.z = sqrt(<span class="number">1.0</span> - saturate(dot(bump.xy, bump.xy)));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将切线空间空间的法线信息转换到世界坐标系下</span></span><br><span class="line">                bump = normalize(half3(dot(i.ttow0.xyz, bump), dot(i.ttow1.xyz, bump), dot(i.ttow2.xyz, bump)));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 利用转换到世界坐标系的法线信息，正式开始光照计算</span></span><br><span class="line">                <span class="comment">// 使用纹理贴图的颜色信息作为漫反射系数</span></span><br><span class="line">                fixed3 albedo = tex2D(_MainTex, i.uv).rgb;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz * albedo;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 漫反射</span></span><br><span class="line">                <span class="comment">// 顶点光线入射向量</span></span><br><span class="line">                fixed3 worldlightdir = normalize(UnityWorldSpaceLightDir(worldpos));</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * albedo * saturate(dot(bump, worldlightdir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 高光反射</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(UnityWorldSpaceViewDir(worldpos));</span><br><span class="line">                <span class="comment">// h = (v + l) / |v + l| v和l向量归一化后的向量</span></span><br><span class="line">                fixed3 halfdir = normalize(worldlightdir + viewdir);</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(bump, halfdir)), _Gloss);</span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Specular&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/NormalMappingTextureShader.PNG" alt="BlinnPhong光照模型的Normal Mapping纹理使用"></p>
<h5 id="Ramp-Texture-渐变纹理"><a href="#Ramp-Texture-渐变纹理" class="headerlink" title="Ramp Texture(渐变纹理)"></a>Ramp Texture(渐变纹理)</h5><p>比较普遍的用法是使用渐变纹理来控制漫反射光照运算。<br>让我们直接看代码和效果图。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/Texture/RampTextureShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露渐变纹理贴图</span></span><br><span class="line">        _RampTex(<span class="string">&quot;Ramp Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;       <span class="comment">// 物体坐标系顶点位置</span></span><br><span class="line">                float3 normal : NORMAL;         <span class="comment">// 物体坐标系法线</span></span><br><span class="line">                float4 texcoord : TEXCOORD0;    <span class="comment">// 纹理位置信息(用于通过采样获取纹理的UV信息)</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;       <span class="comment">// 投影坐标系顶点位置</span></span><br><span class="line">                float3 worldnormal : TEXCOORD0; <span class="comment">// 世界坐标系下的法线</span></span><br><span class="line">                float3 worldpos : TEXCOORD1;    <span class="comment">// 世界坐标系下的顶点位置</span></span><br><span class="line">                float2 uv : TEXCOORD2;          <span class="comment">// 渐变纹理的UV坐标信息</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板渐变纹理贴图</span></span><br><span class="line">            sampler2D _RampTex;</span><br><span class="line">            <span class="comment">// 渐变纹理贴图的纹理属性(e.g. 纹理缩放值，偏移值)</span></span><br><span class="line">            float4 _RampTex_ST;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 通过tangent和normal值计算出将tangent转换到世界坐标系的矩阵(世界坐标系下的XYZ轴)</span></span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                o.worldnormal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line">                o.worldpos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                o.uv = TRANSFORM_TEX(v.texcoord, _RampTex);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                fixed3 worldnormal = normalize(i.worldnormal);</span><br><span class="line">                fixed3 worldlightdir = normalize(UnityWorldSpaceLightDir(i.worldpos));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 半兰伯特反漫射光照模型</span></span><br><span class="line">                <span class="keyword">fixed</span> halflambert = dot(i.worldnormal, worldlightdir) * <span class="number">0.5</span> + <span class="number">0.5</span>;</span><br><span class="line">                <span class="comment">// 利用半兰伯特得到的[0,1]范围值渐变纹理采样</span></span><br><span class="line">                fixed3 diffusecolor = tex2D(_RampTex, fixed2(halflambert, halflambert)).rgb;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                fixed3 diffuse = _LightColor0 * diffusecolor;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 高光反射</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(UnityWorldSpaceViewDir(i.worldpos));</span><br><span class="line">                <span class="comment">// h = (v + l) / |v + l| v和l向量归一化后的向量</span></span><br><span class="line">                fixed3 halfdir = normalize(worldlightdir + viewdir);</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(i.worldnormal, halfdir)), _Gloss);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Specular&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RampTexture.PNG" alt="渐变纹理"><br>可以看出利用半兰伯特把法线映射到[0,1]后，作为渐变纹理采样的uv，这样一来面向光照方向的顶点会更靠纹理采样的1，反之完全与光照相反方向的顶点会更靠近纹理采样的0的位置，然后把渐变纹理的采样信息作为漫反射的基础颜色信息参与光照运算。</p>
<h5 id="Mask-Texture-遮罩纹理"><a href="#Mask-Texture-遮罩纹理" class="headerlink" title="Mask Texture(遮罩纹理)"></a>Mask Texture(遮罩纹理)</h5><p>“遮罩允许我们可以保护某些区域，使它们免于修改。遮罩纹理已经不止限于保护区域避免修改，而是存储我们希望逐像素控制的表面属性。”<br>让我们直接看代码和效果图：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line">Shader <span class="string">&quot;Custom/Texture/MaskTextureShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露主纹理</span></span><br><span class="line">        _MainTex(<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 给Material面板暴露法线贴图</span></span><br><span class="line">        <span class="comment">// bump是Unity自带的法线纹理</span></span><br><span class="line">        _NormalMap(<span class="string">&quot;Normal Map&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;bump&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 法线贴图的有效程度，用于控制凹凸程度</span></span><br><span class="line">        _BumpScale(<span class="string">&quot;Bump Scale&quot;</span>, Float) = <span class="number">1.0</span></span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射遮罩纹理</span></span><br><span class="line">        _SpecularMask(<span class="string">&quot;Specular Mask&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;       <span class="comment">// 物体坐标系顶点位置</span></span><br><span class="line">                float3 normal : NORMAL;         <span class="comment">// 物体坐标系法线</span></span><br><span class="line">                float4 tangent : TANGENT;       <span class="comment">// 切线空间的顶点切线(用于计算切线空间的坐标系)</span></span><br><span class="line">                float4 texcoord : TEXCOORD0;    <span class="comment">// 纹理位置信息(用于通过采样获取纹理的UV信息)</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;       <span class="comment">// 投影坐标系顶点位置</span></span><br><span class="line">                float2 uv : TEXCOORD0;          <span class="comment">// 主纹理和法线纹理和遮罩纹理公用一个UV坐标信息</span></span><br><span class="line">                float4 ttow0 : TEXCOORD1;       <span class="comment">// 切线空间y轴转换到世界坐标系后的y轴</span></span><br><span class="line">                float4 ttow1 : TEXCOORD2;       <span class="comment">// 切线空间x轴转换到世界坐标系后的x轴</span></span><br><span class="line">                float4 ttow2 : TEXCOORD3;       <span class="comment">// 切线空间z轴转换到到世界坐标系后的z轴</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的纹理贴图</span></span><br><span class="line">            sampler2D _MainTex;</span><br><span class="line">            <span class="comment">// 纹理材质的纹理属性(e.g. 纹理缩放值，偏移值)</span></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">            <span class="comment">// 对应材质面板法线贴图</span></span><br><span class="line">            sampler2D _NormalMap;</span><br><span class="line">            <span class="comment">// 对应材质面板法线贴图有效程度参数</span></span><br><span class="line">            <span class="built_in">float</span> _BumpScale;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射遮罩纹理</span></span><br><span class="line">            sampler2D _SpecularMask;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 通过tangent和normal值计算出将tangent转换到世界坐标系的矩阵(世界坐标系下的XYZ轴)</span></span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 公用的纹理UV信息</span></span><br><span class="line">                o.uv = TRANSFORM_TEX(v.texcoord, _MainTex);</span><br><span class="line"></span><br><span class="line">                float3 worldpos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                <span class="comment">// 世界坐标系下的normal(相当于y轴)</span></span><br><span class="line">                fixed3 worldnormal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line">                <span class="comment">// 世界坐标系下的tangent(相当于x轴)</span></span><br><span class="line">                fixed3 worldtangent = UnityObjectToWorldDir(v.tangent.xyz);</span><br><span class="line">                <span class="comment">// 世界坐标系下的normal和tangent计算出binormal</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的binormal(相当于z轴)</span></span><br><span class="line">                fixed3 worldbinormal = cross(worldnormal, worldtangent) * v.tangent.w;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 填充从tangent space转换到world space的矩阵</span></span><br><span class="line">                <span class="comment">// 注意因为是列向量，所以注意填充方式</span></span><br><span class="line">                <span class="comment">// worldpos填充在w后续使用</span></span><br><span class="line">                o.ttow0 = float4(worldtangent.x, worldbinormal.x, worldnormal.x, worldpos.x);</span><br><span class="line">                o.ttow1 = float4(worldtangent.y, worldbinormal.y, worldnormal.y, worldpos.y);</span><br><span class="line">                o.ttow2 = float4(worldtangent.z, worldbinormal.z, worldnormal.z, worldpos.z);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 世界坐标系顶点位置</span></span><br><span class="line">                fixed3 worldpos = float3(i.ttow0.w,i.ttow1.w,i.ttow2.w);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 计算世界坐标系的法线信息</span></span><br><span class="line">                <span class="comment">// bump为切线空间的法线信息</span></span><br><span class="line">                fixed3 bump = UnpackNormal(tex2D(_NormalMap, i.uv));</span><br><span class="line"></span><br><span class="line">                bump.xy *= _BumpScale;</span><br><span class="line">                bump.z = sqrt(<span class="number">1.0</span> - saturate(dot(bump.xy, bump.xy)));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将切线空间空间的法线信息转换到世界坐标系下</span></span><br><span class="line">                bump = normalize(half3(dot(i.ttow0.xyz, bump), dot(i.ttow1.xyz, bump), dot(i.ttow2.xyz, bump)));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 利用转换到世界坐标系的法线信息，正式开始光照计算</span></span><br><span class="line">                <span class="comment">// 使用纹理贴图的颜色信息作为漫反射系数</span></span><br><span class="line">                fixed3 albedo = tex2D(_MainTex, i.uv).rgb;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz * albedo;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 漫反射</span></span><br><span class="line">                <span class="comment">// 顶点光线入射向量</span></span><br><span class="line">                fixed3 worldlightdir = normalize(UnityWorldSpaceLightDir(worldpos));</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * albedo * saturate(dot(bump, worldlightdir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 高光反射</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(UnityWorldSpaceViewDir(worldpos));</span><br><span class="line">                <span class="comment">// h = (v + l) / |v + l| v和l向量归一化后的向量</span></span><br><span class="line">                fixed3 halfdir = normalize(worldlightdir + viewdir);</span><br><span class="line">                <span class="comment">// 高光遮罩纹理采样信息(这里只是用了r红色通道信息作为mask)</span></span><br><span class="line">                <span class="keyword">fixed</span> specularmask = tex2D(_SpecularMask, i.uv).r;</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息(高光遮罩纹理参与过滤)</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(bump, halfdir)), _Gloss) * specularmask;</span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Specular&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/MaskTexture.PNG" alt="高光遮罩纹理"><br>可以看到我们利用遮罩纹理的R颜色信息作为高光的过滤依据，也就是说遮罩纹理里R信息为0的顶点将不会计算高光反射。</p>
<h2 id="透明效果"><a href="#透明效果" class="headerlink" title="透明效果"></a>透明效果</h2><h1 id="Reference-Website"><a href="#Reference-Website" class="headerlink" title="Reference Website"></a>Reference Website</h1><p><a target="_blank" rel="noopener" href="http://www.alanzucconi.com/2015/06/17/surface-shaders-in-unity3d/">Surface shaders in Unity3D</a><br>[Unity Shader内置文件官网下载地址](<a target="_blank" rel="noopener" href="http://unity3d.com/cn/get-unity/download/">http://unity3d.com/cn/get-unity/download/</a><br>archive)<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-ShaderSemantics.html">Shader semantics官网查询</a><br><a target="_blank" rel="noopener" href="http://candycat1992.github.io/unity_shaders_book/unity_shaders_book_corrigenda.html">Unity Shader入门精要勘误</a><br><a target="_blank" rel="noopener" href="https://github.com/candycat1992/Unity_Shaders_Book">Unity Shader入门级你要源代码</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Gouraud_shading">Gouraud Shading</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Rendering/">Rendering</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Rendering/">Rendering</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/3/">&lt;span&gt;&lt;&#x2F;span&gt;Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next&lt;span&gt;&lt;&#x2F;span&gt;</a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2026 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
