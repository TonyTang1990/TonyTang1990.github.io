
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="走停人生路">
<meta property="og:url" content="http://tonytang1990.github.io/page/4/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tony Tang">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/03/18/导表工具/" title="导表工具" itemprop="url">导表工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2018-03-18T04:30:52.000Z" itemprop="datePublished"> 发表于 2018-03-18</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。</p>
<h1 id="Data-Config"><a href="#Data-Config" class="headerlink" title="Data Config"></a>Data Config</h1><h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>数据配置 – 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。</p>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>那么为什么需要数据配置了？</p>
<ol>
<li>数据是游戏最基本的单位 – 无论是炫酷的特效还是惊人的AI都是通过读取底层数据最终得出结论的。</li>
<li>协同工作 – 这里说的数据配置更多的是游戏逻辑层的数据，即类似游戏里的对话显示，背包单位格子数量上限等配置。有了数据配置，程序和策划很容易协同工作，程序负责数据读取实现功能，策划负责具体的数据配置实现想要的效果。</li>
<li>多语言显示 – 数据配置用于语言包显示也帮助我们很方便的实现多语言的版本(读取不同语言版本的数据配置即可)。</li>
</ol>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><p>实现数据配置读取原理上是把数据序列化导出保存在本地(.xml, .json .bytes……)，然后通过反序列化读取回来。<br>这里我们不单单是针对个别数据进行序列化反序列化。这里要实现的是一个针对表格配置，可以动态生成支持反序列化读取(非反射机制)读取到程序里的工具。</p>
<p>序列化相关知识学习参考<a href="http://tonytang1990.github.io/2015/08/15/CS%E5%AD%A6%E4%B9%A0/#Runtime_Serialization">Runtime Serialization</a><br>PC端Excel读取库选择参考:<a href="http://tonytang1990.github.io/2015/07/15/Unity%E5%AD%A6%E4%B9%A0/#Excel%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96">Excel数据读取</a></p>
<p>Note:<br>这里注意反射和反序列化不是一回事，反序列化可以用反射也可以不用反射来实现。</p>
<h3 id="Functional-Requirement-功能需求"><a href="#Functional-Requirement-功能需求" class="headerlink" title="Functional Requirement(功能需求)"></a>Functional Requirement(功能需求)</h3><ol>
<li>支持int，float，string基础数据配置</li>
<li>支持大于一个维度的数据读取(多余一个的数据)快速读取(比如配置:1;2;3;4分别代表物体随机的生命值选项)(这个算是<strong>基础需求功能</strong>)</li>
<li>支持列表数据自定义数据结构快速读取(<strong>高阶功能需求</strong>，方便列表数据复杂的时候能够抽象成数据结构快速读取。)<br>实际需求举列:<br>我们配置一个道具不同等级的属性加成数据：1+200|2+300;3+400|4+500|5+600 表示第一级加属性id为1的属性加200并且，属性id为2的加300。第二季加属性id为3,4,5的分别加400,500,600)<br>如果我们不能动态创建自定义结构数据，那么我们就需要在代码里写string.split()这种形式的分割数据去判定读取，不论是从性能开销还是代码编写都是很不划算的。<br>如果我们能自动创建自定义结构，生成如下代码:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Property</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Value</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Property[0].Length : 2</span></span><br><span class="line"><span class="comment">// Proeprty[1].Length : 3</span></span><br><span class="line">Property[<span class="number">2</span>][] mPropertyArray;   <span class="comment">// 存储表格数据的成员</span></span><br></pre></td></tr></table></figure>

<p>那么我们就能方便的编写代码去访问特定等级所加成的属性了：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//快速访问特定等级所加成的属性值</span></span><br><span class="line">mPropertyArray[<span class="number">1</span>][<span class="number">2</span>]表示第二级所加成的第二个属性数据</span><br></pre></td></tr></table></figure>

<pre><code>扩展内嵌多层的话(这样的需求应该很少，这里暂时就不考虑了)，此方案需要扩展多维数组来支持，并不是很友好
</code></pre>
<ol start="4">
<li>支持自动生成读表相关代码</li>
<li>内存开销要控制，读取速度要快</li>
<li>跨平台</li>
<li>跨语言</li>
<li>独立于Unity的工具(后期优化部分)</li>
<li>前后端表格数据区分(后期优化部分)(因为前后端往往是读不同的数据，并不需要导同一套表格数据)</li>
</ol>
<h3 id="原理思考"><a href="#原理思考" class="headerlink" title="原理思考"></a>原理思考</h3><p>流程：</p>
<ol>
<li>定义excel表格格式规则(这一步会影响后面所有步骤)</li>
<li>读取excel数据</li>
<li>生成可跨平台跨语言的序列化代码</li>
<li>序列化写入excel数据(这一步涉及跨语言问题)</li>
<li>反序列化读取数据</li>
</ol>
<ul>
<li><p>定义excel表格格式规则<br>这一步要决定我们excel长什么样子，决定不同数据不同的行号字段代表什么。</p>
</li>
<li><p>读取excel数据<br>通过第三方库(比如PC端跨平台的<a target="_blank" rel="noopener" href="http://exceldatareader.codeplex.com/">ExcelRead</a>)可以解决读取问题。</p>
</li>
<li><p>生成跨平台跨语言的序列化反序列化代码<br>这一步的重点在于跨平台和<br>跨平台这一点肯定不用说，要想在PC端序列化的数据在移动端使用，这一点是必须的也并不是难点。<br><strong>跨语言</strong>这一点上，试想如果前后端用的语言不同，但前后端想共用一份导表工具来生成需要的表格数据，那么跨语言这一点就是必须的了。<br>序列化数据和反序列化数据时，我们需要考虑跨语言的问题，后续的方案中就会强调这一点。</p>
</li>
<li><p>序列化写入excel数据<br>写入数据也就是序列化的过程，解决了前面提到的跨语言生成序列化代码问题后，这个问题也就迎刃而解。</p>
</li>
<li><p>反序列化读取数据<br>读数据就是反序列化的过程，同理序列化，解决了跨语言生成序列化代码的问题，这个问题依然不是问题。</p>
</li>
</ul>
<h3 id="方案比较"><a href="#方案比较" class="headerlink" title="方案比较"></a>方案比较</h3><ol>
<li>C# .Net BinaryFormatter(不夸语言，序列化后数据相对大，反序列化费时且内存开销大)</li>
<li>ProtoBuff(跨语言，序列化数据相对小，反序列化费时和内存开销相对好点。工具成熟，社区完善，自定义数据结构方便)</li>
<li>FlatBuff(跨语言，序列化数据小，反序列化费时少，编写自定义序列化和反序列化数据结构不方便)</li>
<li>XBuffer(之前一位同事写的基于C#的简化版FlatBuff，高效且高度支持扩展和配置)</li>
</ol>
<p>接下来针对各个方案进行简单学习，理解各自的优缺点。</p>
<h4 id="C-Net-BinaryFormatter"><a href="#C-Net-BinaryFormatter" class="headerlink" title="C# .Net BinaryFormatter"></a>C# .Net BinaryFormatter</h4><p>参考这篇文章：<a href="blog.csdn.net/qq_14903317/article/details/78637440">Unity C#配置表工具</a></p>
<p>我们可以看到，我们需要做的事情有以下几步：</p>
<ol>
<li>定义excel表格格式规则</li>
<li>从excel中读取数据</li>
<li>根据数据类型，动态生成每个表的C#类(用于反序列化读取数据)</li>
<li>动态编译C#类，输出一个动态库以及相关代码</li>
<li>实例化C#类，并且把数据填入到实例化对象中，序列化数据，保存在Untiy本地Resources目录中</li>
<li>运行时，通过生成的C#类反序列化加载并创建对应实例化对象去存储数据</li>
</ol>
<p>Utilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 工具静态类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Utilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 本机打开特定目录(暂时只用于Windows)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;folderPath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenFolder</span>(<span class="params"><span class="built_in">string</span> folderPath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(folderPath))</span><br><span class="line">        &#123;</span><br><span class="line">            ProcessStartInfo startInfo = <span class="keyword">new</span> ProcessStartInfo(folderPath, <span class="string">&quot;explorer.exe&quot;</span>);</span><br><span class="line">            Process.Start(startInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            UnityEngine.Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; Directory does not exist!&quot;</span>, folderPath));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查指定目录是否存在，不存在创建一个</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkOrCreateSpecificFolder</span>(<span class="params"><span class="built_in">string</span> folderpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.CreateDirectory(folderpath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 无论目录是否存在都删除所有文件重新创建一个目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">recreateSpecificFolder</span>(<span class="params"><span class="built_in">string</span> folderpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.Delete(folderpath, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Directory.CreateDirectory(folderpath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取文件的目录名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filepath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">getFileFolderName</span>(<span class="params"><span class="built_in">string</span> filepath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Path.GetFileName(Path.GetDirectoryName(filepath));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PathUtilites.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 路径静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PathUtilties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Excel Data</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据文件夹目录路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelFileFolderPath = Application.dataPath + <span class="string">&quot;/../ExcelDatas/Game/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据生成的对应代码目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 因为序列化反序列化时要求Assemble信息一致，所以如果反序列化使用Unity 编译后的C#无法成功反序列化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BinderToType低版本.Net可以用但BinderToName要求.Net 4.0</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所以这里放弃了直接生成新的cs表代码通过Unity编译使用的方案，选择依然采用直接编译表代码成dll来使用</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表代码依然生成，但放到Asset外部作为非有效代码存储方便查看</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 参考:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> https://stackoverflow.com/questions/505611/binary-deserialization-with-different-assembly-version</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> https://www.codeproject.com/Tips/1101106/How-to-serialize-across-assemblies-with-the-Binary</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptOutputFolderPath = Application.dataPath + <span class="string">&quot;/../DataConfigScripts/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据序列化后的文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelDataFileName = <span class="string">&quot;dataconfig.byte&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据序列化后的数据文件存储目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelDataFileOutputFolderPath = Application.dataPath + <span class="string">&quot;/Resources/DataConfig/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据序列化后的数据文件相对于Resource目录的相对目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelDataFileOutputFolderRelativePath = <span class="string">&quot;DataConfig/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据生成的对应Assembly&amp;Script临时文件临时目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptAssemblyFilePath = Application.dataPath + <span class="string">&quot;/Scripts/Core/DataConfig/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据生成的对应Assembly临时文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptAssemblyFileName = <span class="string">&quot;dataconfig.dll&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表格代码文件后缀</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptFilePostFix = <span class="string">&quot;.cs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表格生成数据管理读取代码文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptDataManagerFileName = <span class="string">&quot;DataManager.cs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表代码Container后缀名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelTableContainerPostfix = <span class="string">&quot;Container&quot;</span>;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ExportExcelData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Excel;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> Microsoft.CSharp;</span><br><span class="line"><span class="keyword">using</span> System.CodeDom.Compiler;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 表格数据抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConfigData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Type;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字段名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 导表工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExportExcelData</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字段名行号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> NameLineNumber = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字段类型行号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> TypeLineNumber = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据开始行号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> DataLineNumber = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 有效的数据类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="built_in">string</span>&gt; ValideTypesList =  <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;(<span class="keyword">new</span> <span class="built_in">string</span>[]&#123;<span class="string">&quot;int&quot;</span>, <span class="string">&quot;float&quot;</span>, <span class="string">&quot;string&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Tools/DataConfig/导出所有表格数据&quot;</span>, false, 100)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exportAllExcelData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span>[] excelfiles = Directory.GetFiles(PathUtilties.ExcelFileFolderPath, <span class="string">&quot;*.xlsx&quot;</span>);</span><br><span class="line">        <span class="comment">// 表格数据映射Map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为表格对应的数据列表，List的每一个元素代表一行的数据数组</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, List&lt;ConfigData[]&gt;&gt; datadic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;ConfigData[]&gt;&gt;();</span><br><span class="line">        <span class="comment">// 字段信息map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为对应表格的字段数据</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; namedic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;();</span><br><span class="line">        <span class="comment">// 字段类型信息map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为对应表格的字段类型数据</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; typedic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> excelfile <span class="keyword">in</span> excelfiles)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!readAllDataFromExcelFile(excelfile, <span class="keyword">ref</span> datadic, <span class="keyword">ref</span> typedic, <span class="keyword">ref</span> namedic))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 表格代码映射map</span></span><br><span class="line">        <span class="comment">// Key为类名字，Value为对应代码数据</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; codemap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="comment">//根据刚才记录的每一张表格数据生成对应代码数据</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datadic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> classname = data.Key;</span><br><span class="line">            DataConfigScriptGenerator dcsg = <span class="keyword">new</span> DataConfigScriptGenerator(classname, typedic[classname], namedic[classname]);</span><br><span class="line">            codemap.Add(classname, dcsg.generateCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除前一次所有相关文件</span></span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelScriptOutputFolderPath);</span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelDataFileOutputFolderPath);</span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelScriptAssemblyFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成dll，Assemble文件用于序列化数据</span></span><br><span class="line">        <span class="built_in">string</span>[] scripts = <span class="keyword">new</span> <span class="built_in">string</span>[codemap.Values.Count];</span><br><span class="line">        codemap.Values.CopyTo(scripts, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">var</span> assemblyfilepath = PathUtilties.ExcelScriptAssemblyFilePath + PathUtilties.ExcelScriptAssemblyFileName;</span><br><span class="line">        Assembly assembly = compileCode(scripts, assemblyfilepath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (assembly == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;编译dll失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用Assemble序列化数据</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datadic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">object</span> container = assembly.CreateInstance(data.Key + <span class="string">&quot;Container&quot;</span>);</span><br><span class="line">            Type classtype = assembly.GetType(data.Key);</span><br><span class="line">            <span class="keyword">if</span> (!serialize(container, classtype, data.Value, PathUtilties.ExcelDataFileOutputFolderPath))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对应Manager加载管理的cs代码文件</span></span><br><span class="line">        createDataManager(assembly, PathUtilties.ExcelScriptAssemblyFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对应cs代码文件(如果删除dll，使用cs编译的Assembly-CSharp.dll会导致反序列化出问题。猜测是因为Assemly名字改变后，默认的序列化和反序列化的部分信息(e.g. 比如assembly name)对不上。)</span></span><br><span class="line">        <span class="comment">// 所以这里生成的代码仅供查看，释放到Asset上层目录的</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> code <span class="keyword">in</span> codemap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (FileStream fs = File.Create(PathUtilties.ExcelScriptOutputFolderPath + code.Key + PathUtilties.ExcelScriptFilePostFix))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] info = <span class="keyword">new</span> UTF8Encoding(<span class="literal">true</span>).GetBytes(code.Value);</span><br><span class="line">                fs.Write(info, <span class="number">0</span>, info.Length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除Assemble文件</span></span><br><span class="line">        <span class="comment">//File.Delete(assemblyfilepath);</span></span><br><span class="line"></span><br><span class="line">        AssetDatabase.Refresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取excel里所有数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;excelfile&quot;&gt;</span>excel文件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datadic&quot;&gt;</span>表格数据<span class="doctag">&lt;/param&gt;</span>]</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;names&quot;&gt;</span>字段数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typs&quot;&gt;</span>类型数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">readAllDataFromExcelFile</span>(<span class="params"><span class="built_in">string</span> excelfile, <span class="keyword">ref</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;ConfigData[]&gt;&gt; datadic, <span class="keyword">ref</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; typesmap, <span class="keyword">ref</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; namesmap</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;excelfile: &#123;0&#125;&quot;</span>, excelfile));</span><br><span class="line">        FileStream fs = File.Open(excelfile, FileMode.Open, FileAccess.Read);</span><br><span class="line">        IExcelDataReader excelreader = ExcelReaderFactory.CreateOpenXmlReader(fs);</span><br><span class="line">        <span class="keyword">if</span> (!excelreader.IsValid)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel文件:&#123;0&#125;读取失败！&quot;</span>, excelfile));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel文件.Name:&#123;0&#125;&quot;</span>, excelreader.Name));</span><br><span class="line">            <span class="keyword">var</span> dataset = excelreader.AsDataSet();</span><br><span class="line">            <span class="keyword">if</span> (dataset.Tables.Count &gt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel文件:&#123;0&#125;,不允许一个Excel多张Table!&quot;</span>, excelreader.Name));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (datadic.ContainsKey(excelreader.Name))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;有同名的Excel Table存在!同名Excel:&#123;0&#125;!&quot;</span>, excelreader.Name));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> currentlinenumber = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">string</span>[] types = <span class="literal">null</span>;</span><br><span class="line">                <span class="built_in">string</span>[] names = <span class="literal">null</span>;</span><br><span class="line">                datadic.Add(excelreader.Name, <span class="keyword">new</span> List&lt;ConfigData[]&gt;());</span><br><span class="line">                <span class="keyword">while</span>(excelreader.Read())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//读取每一行的数据</span></span><br><span class="line">                    <span class="built_in">string</span>[] datas = <span class="keyword">new</span> <span class="built_in">string</span>[excelreader.FieldCount];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; excelreader.FieldCount; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        datas[i] = excelreader.GetString(i);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 字段信息</span></span><br><span class="line">                    <span class="keyword">if</span> (currentlinenumber == NameLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        names = datas;</span><br><span class="line">                        <span class="keyword">if</span>(checkRepeatedNameString(names))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel Table:&#123;0&#125;&quot;</span>, excelreader.Name));</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        namesmap.Add(excelreader.Name, names);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 字段类型信息</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>(currentlinenumber == TypeLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        types = datas;</span><br><span class="line">                        <span class="keyword">if</span> (checkInvalideType(types))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel Table:&#123;0&#125;&quot;</span>, excelreader.Name));</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        typesmap.Add(excelreader.Name, types);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>(currentlinenumber &gt;= DataLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 记录每一行所有数据的字段名，字段类型，字段数据</span></span><br><span class="line">                        ConfigData[] configdatas = <span class="keyword">new</span> ConfigData[datas.Length];</span><br><span class="line">                        <span class="keyword">for</span>(<span class="built_in">int</span> m = <span class="number">0</span>; m &lt; datas.Length; m++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            ConfigData cd = <span class="keyword">new</span> ConfigData();</span><br><span class="line">                            cd.Type = types[m];</span><br><span class="line">                            cd.Name = names[m];</span><br><span class="line">                            cd.Data = datas[m];</span><br><span class="line">                            <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(cd.Type))</span><br><span class="line">                            &#123;</span><br><span class="line">                                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;数据第&#123;0&#125;行，第&#123;1&#125;列字段类型不能为空!&quot;</span>, currentlinenumber, m));</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(cd.Name))</span><br><span class="line">                            &#123;</span><br><span class="line">                                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;数据第&#123;0&#125;行，第&#123;1&#125;列字段名字不能为空!&quot;</span>, currentlinenumber, m));</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            configdatas[m] = cd;</span><br><span class="line">                        &#125;</span><br><span class="line">                        datadic[excelreader.Name].Add(configdatas);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;无效的行号:&#123;0&#125;&quot;</span>, currentlinenumber));</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    currentlinenumber++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查是否有重复的字段名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;names&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">checkRepeatedNameString</span>(<span class="params"><span class="built_in">string</span>[] names</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> tempdic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> name <span class="keyword">in</span> names)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tempdic.ContainsKey(name))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;同名字段:&#123;0&#125;!&quot;</span>, name));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                tempdic.Add(name, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查是否有无效的字段类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;types&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">checkInvalideType</span>(<span class="params"><span class="built_in">string</span>[] types</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!ValideTypesList.Contains(type))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;无效类型:&#123;0&#125;&quot;</span>, type));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 编译代码到dll</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scripts&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputfile&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>返回Assembly<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Assembly <span class="title">compileCode</span>(<span class="params"><span class="built_in">string</span>[] scripts, <span class="built_in">string</span> outputfile</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//编译参数</span></span><br><span class="line">        CSharpCodeProvider codeprovider = <span class="keyword">new</span> CSharpCodeProvider();</span><br><span class="line">        CompilerParameters objcompilerparameters = <span class="keyword">new</span> CompilerParameters();</span><br><span class="line">        objcompilerparameters.ReferencedAssemblies.AddRange(<span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;System.dll&quot;</span> &#125;);</span><br><span class="line">        objcompilerparameters.OutputAssembly = outputfile;</span><br><span class="line">        objcompilerparameters.GenerateExecutable = <span class="literal">false</span>;</span><br><span class="line">        objcompilerparameters.GenerateInMemory = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始编译脚本</span></span><br><span class="line">        CompilerResults cr = codeprovider.CompileAssemblyFromSource(objcompilerparameters, scripts);</span><br><span class="line">        <span class="keyword">if</span> (cr.Errors.HasErrors)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;编译错误：&quot;</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (CompilerError err <span class="keyword">in</span> cr.Errors)</span><br><span class="line">                Debug.LogError(err.ErrorText);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cr.CompiledAssembly;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;container&quot;&gt;</span>数据容器对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>数据Class类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datalist&quot;&gt;</span>数据列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputpath&quot;&gt;</span>输出目录<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">serialize</span>(<span class="params"><span class="built_in">object</span> container, Type type, List&lt;ConfigData[]&gt; datalist, <span class="built_in">string</span> outputpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        FieldInfo dictInfo = container.GetType().GetField(<span class="string">&quot;Dict&quot;</span>);</span><br><span class="line">        <span class="built_in">object</span> dict = dictInfo.GetValue(container);</span><br><span class="line">        <span class="comment">//读取每一行数据并填充到实例对象里</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> datas <span class="keyword">in</span> datalist)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">object</span> instance = type.Assembly.CreateInstance(type.FullName);</span><br><span class="line">            <span class="comment">//填充实例对象数据</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datas)</span><br><span class="line">            &#123;</span><br><span class="line">                FieldInfo fieldinfo = type.GetField(data.Name);</span><br><span class="line">                fieldinfo.SetValue(instance, parseValue(data.Type, data.Data));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将实例对象数据添加到Container Map里，后续用于序列化数据</span></span><br><span class="line">            <span class="built_in">object</span> id = type.GetField(<span class="string">&quot;id&quot;</span>).GetValue(instance);</span><br><span class="line">            <span class="built_in">bool</span> isExist = (<span class="built_in">bool</span>)dict.GetType().GetMethod(<span class="string">&quot;ContainsKey&quot;</span>).Invoke(dict, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; id &#125;);</span><br><span class="line">            <span class="keyword">if</span> (isExist)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">&quot;Repetitive key &quot;</span> + id + <span class="string">&quot; in &quot;</span> + container.GetType().Name);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            dict.GetType().GetMethod(<span class="string">&quot;Add&quot;</span>).Invoke(dict, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; id, instance &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将数据序列化到本地文件</span></span><br><span class="line">        <span class="keyword">var</span> bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">        <span class="keyword">var</span> s = <span class="keyword">new</span> FileStream(outputpath + type.Name + <span class="string">&quot;.bytes&quot;</span>, FileMode.CreateNew, FileAccess.Write);</span><br><span class="line">        bf.Serialize(s, container);</span><br><span class="line">        s.Close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建生成反序列化加载接口代码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assembly&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputpath&quot;&gt;</span>输出路径<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">createDataManager</span>(<span class="params">Assembly assembly, <span class="built_in">string</span> outputpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        StringBuilder source = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        source.Append(<span class="string">&quot;/*\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\tAuto create\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\tDon&#x27;t Edit it\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;*/\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        source.Append(<span class="string">&quot;using System;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using UnityEngine;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using System.Runtime.Serialization;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using System.Runtime.Serialization.Formatters.Binary;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using System.IO;\n\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;[Serializable]\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;public class DataManager : SingletonTemplate&lt;DataManager&gt;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义所有Container的成员变量</span></span><br><span class="line">        <span class="keyword">var</span> types = assembly.GetTypes();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!type.Name.EndsWith(PathUtilties.ExcelTableContainerPostfix))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            source.Append(<span class="string">&quot;\tpublic &quot;</span> + type.Name + <span class="string">&quot; &quot;</span> + type.Name.Remove(<span class="number">0</span>, <span class="number">2</span>) + <span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        source.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//加载所有配置表</span></span><br><span class="line">        source.Append(<span class="string">&quot;\tpublic void loadAll()\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!type.Name.EndsWith(<span class="string">&quot;Container&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">string</span> typeName = type.Name.Remove(type.Name.IndexOf(<span class="string">&quot;Container&quot;</span>));</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&quot;</span> + type.Name.Remove(<span class="number">0</span>, <span class="number">2</span>) + <span class="string">&quot; = Load(&quot;</span> + <span class="string">&#x27;&quot;&#x27;</span> + typeName + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&quot;) as &quot;</span> + type.Name + <span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化接口方法</span></span><br><span class="line">        source.Append(<span class="string">&quot;\tprivate System.Object Load(string name)\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tvar bf = new BinaryFormatter();\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tTextAsset text = Resources.Load&lt;TextAsset&gt;(&quot;</span> + <span class="string">&#x27;&quot;&#x27;</span> + PathUtilties.ExcelDataFileOutputFolderRelativePath + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&quot; + name);\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tStream s = new MemoryStream(text.bytes);\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tSystem.Object obj = bf.Deserialize(s);\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\ts.Close();\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\treturn obj;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 数据加载接口</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (type.Name.EndsWith(<span class="string">&quot;Container&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> classname = type.Name;</span><br><span class="line">            source.Append(<span class="string">&quot;\t\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\tpublic &quot;</span> + classname + <span class="string">&quot; get&quot;</span> + classname.Substring(<span class="number">2</span>) + <span class="string">&quot;Data(int id)\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&quot;</span> + classname + <span class="string">&quot; data = null;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&quot;</span> + classname.Substring(<span class="number">2</span>) + <span class="string">&quot;Container.getMap().TryGetValue(id, out data);\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\tif(data == null)\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&#123;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t\tDebug.LogError(string.Format(\&quot;表格:&#123; 0&#125;找不到id: &#123; 1&#125;的数据!\&quot;, data.GetType().ToString(), id));\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&#125;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\treturn data;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        source.Append(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存脚本</span></span><br><span class="line">        StreamWriter sw = <span class="keyword">new</span> StreamWriter(outputpath + PathUtilties.ExcelScriptDataManagerFileName);</span><br><span class="line">        sw.WriteLine(source.ToString());</span><br><span class="line">        sw.Close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据字符串解析类型(暂时只支持基础类型)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">object</span> <span class="title">parseValue</span>(<span class="params"><span class="built_in">string</span> type, <span class="built_in">string</span> data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (type.Equals(<span class="string">&quot;string&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type.Equals(<span class="string">&quot;int&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">int</span>.Parse(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type.Equals(<span class="string">&quot;float&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">float</span>.Parse(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;类型字符串:&#123;0&#125;不支持该类型数据解析!&quot;</span>, type));</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataConfigScriptGenerator.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 导表代码生成工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataConfigScriptGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 类名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ClassName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 成员字段类型数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>[] TypeDatas</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 成员字段名字数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>[] TypeNameDatas</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataConfigScriptGenerator</span>(<span class="params"><span class="built_in">string</span> classname, <span class="built_in">string</span>[] typedatas, <span class="built_in">string</span>[] typenamedatas</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ClassName = classname;</span><br><span class="line">        TypeDatas = typedatas;</span><br><span class="line">        TypeNameDatas = typenamedatas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成对应表代码外部接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">generateCode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(ClassName) || TypeDatas == <span class="literal">null</span> || TypeNameDatas == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> generateRealCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成表代码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">generateRealCode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//生成类文件头</span></span><br><span class="line">        StringBuilder classsource = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        classsource.Append(<span class="string">&quot;/*\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tAuto create\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tDon&#x27;t Edit it\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;*/\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;using System;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;using System.Reflection;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;using System.Collections.Generic;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;[Serializable]\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;public class &quot;</span> + ClassName + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成成员声明数据</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; TypeDatas.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            classsource.Append(filedString(TypeDatas[i], TypeNameDatas[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成Container</span></span><br><span class="line">        classsource.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;[Serializable]\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;public class &quot;</span> + ClassName + PathUtilties.ExcelTableContainerPostfix + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tpublic &quot;</span> + <span class="string">&quot;Dictionary&lt;int, &quot;</span> + ClassName + <span class="string">&quot;&gt;&quot;</span> + <span class="string">&quot; Dict&quot;</span> + <span class="string">&quot; = new Dictionary&lt;int, &quot;</span> + ClassName + <span class="string">&quot;&gt;();\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tpublic &quot;</span> + <span class="string">&quot;Dictionary&lt;int, &quot;</span> + ClassName + <span class="string">&quot;&gt;&quot;</span> + <span class="string">&quot; getMap()\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\t\treturn Dict;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> classsource.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 成员声明数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>成员类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;field&quot;&gt;</span>成员名<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">filedString</span>(<span class="params"><span class="built_in">string</span> type, <span class="built_in">string</span> field</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(type) || <span class="built_in">string</span>.IsNullOrEmpty(field))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        StringBuilder sbProperty = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sbProperty.Append(<span class="string">&quot;\tpublic &quot;</span> + type + <span class="string">&quot; &quot;</span> + field + <span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sbProperty.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让我们来看看最终的结果：<br>game.xlsx<br><img src="/img/Unity/ExcelDataConfig.PNG" alt="ExcelDataConfig"></p>
<p><img src="/img/Unity/DataConfigData.PNG" alt="DataConfigData"></p>
<p>t_game.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Auto create</span></span><br><span class="line"><span class="comment">    Don&#x27;t Edit it</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> author;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> sex;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> money;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_gameContainer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_game&gt; Dict = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, t_game&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_game&gt; <span class="title">getMap</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Dict;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Auto create</span></span><br><span class="line"><span class="comment">    Don&#x27;t Edit it</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">DataManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> t_gameContainer gameContainer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        gameContainer = Load(<span class="string">&quot;t_game&quot;</span>) <span class="keyword">as</span> t_gameContainer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> System.<span class="function">Object <span class="title">Load</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">        TextAsset text = Resources.Load&lt;TextAsset&gt;(<span class="string">&quot;DataConfig/&quot;</span> + name);</span><br><span class="line">        Stream s = <span class="keyword">new</span> MemoryStream(text.bytes);</span><br><span class="line">        System.Object obj = bf.Deserialize(s);</span><br><span class="line">        s.Close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> t_game <span class="title">getgameData</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        t_game data = <span class="literal">null</span>;</span><br><span class="line">        gameContainer.getMap().TryGetValue(id, <span class="keyword">out</span> data);</span><br><span class="line">        <span class="keyword">if</span>(data == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;表格:&#123; 0&#125;找不到id: &#123; 1&#125;的数据!&quot;</span>, data.GetType().ToString(), id));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在Unity里测试读取和打印:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GUILayout.BeginHorizontal();</span><br><span class="line"><span class="keyword">if</span> (GUILayout.Button(<span class="string">&quot;加载所有表格数据&quot;</span>, GUILayout.MaxWidth(<span class="number">250.0f</span>), GUILayout.MaxHeight(<span class="number">50.0f</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">&quot;加载所有表格数据&quot;</span>);</span><br><span class="line">    DataManager.Singleton.loadAll();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (GUILayout.Button(<span class="string">&quot;打印所有表格数据&quot;</span>, GUILayout.MaxWidth(<span class="number">250.0f</span>), GUILayout.MinHeight(<span class="number">50.0f</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">&quot;打印所有表格数据&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt;= DataManager.Singleton.gameContainer.Dict.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> data = DataManager.Singleton.getgameData(i);</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;data.id : &#123;0&#125;, data.author : &#123;1&#125;, data.age : &#123;2&#125;, data.sex : &#123;3&#125;, data.money : &#123;4&#125;&quot;</span>, data.id, data.author, data.age, data.sex, data.money));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">GUILayout.EndHorizontal();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/DataConfigResult.PNG" alt="DataConfigResult"></p>
<p>就这样我们成功的通过读取表格数据，生成对应代码，序列化数据，然后通过生成的对应表代码反序列化读取出数据就基本完成了。</p>
<p>遇到的问题:<br>第三步动态编译dll进行序列化反序列化，这一步本来想最终不使用dll而是跟着Unity参与编译的代码来反序列化，但是反序列化出现了问题。</p>
<p>错误信息:<br>SerializationExeption: could not find type ‘System.Collections.Generic.Dictionary’ **</p>
<p>个人猜测因为序列化反序列化时要求Assemble信息一致，所以如果反序列化使用Unity 编译后的C#无法成功反序列化</p>
<p>网上相关问题:<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/505611/binary-deserialization-with-different-assembly-version">SerializationException: Could not find type ‘System.Collections.Generic.List’1 in c# untiy3d</a><br><a target="_blank" rel="noopener" href="https://www.codeproject.com/Tips/1101106/How-to-serialize-across-assemblies-with-the-Binary">How to Serialize Across Assemblies with the BinaryFormatter</a></p>
<p>但考虑到BinderToType低版本.Net可以用但BinderToName要求.Net 4.0，所以这里放弃了直接生成新的cs表代码通过Unity编译使用的方案，选择依然采用直接编译表代码成dll来使用。<br>表代码依然生成，但放到Asset外部作为非有效代码存储方便查看</p>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><ol>
<li>C#反序列化默认是反射实现的，速度会比较慢，可以考虑实现自定义反序列化加快读取速度，参考：<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Runtime_Serialization">Runtime_Serialization</a><br>测试方式:</li>
</ol>
<ul>
<li>序列化同一个类型对象500次并反序列化500次</li>
<li>打印记录反序列化的内存和时间开销<br>测试代码:</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">long</span> mHeapMemorySize;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 显示堆内存使用准备工作(在调用ShowHeapMemoryUsing打印堆内存分配之前调用此方法确保计算显示的堆内存数据申请正确)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TonyTangShowHeapMemoryUsingPrepration</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 确保得到正确的起始Heap Memory Size</span></span><br><span class="line">    GC.Collect();</span><br><span class="line">    mHeapMemorySize = GC.GetTotalMemory(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 显示堆内存使用情况</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;postfix&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TonyTangShowHeapMemoryUsing</span>(<span class="params"><span class="built_in">string</span> postfix</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> newestheapmemorysize = GC.GetTotalMemory(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">var</span> heapmemoryoffset = newestheapmemorysize - mHeapMemorySize;</span><br><span class="line">    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;Heap Memory Size = &#123;0&#125; Pre Memory Size = &#123;1&#125; Memory Offset = &#123;2&#125; -- &#123;3&#125;&quot;</span>, newestheapmemorysize, mHeapMemorySize, heapmemoryoffset, postfix));</span><br><span class="line">    mHeapMemorySize = newestheapmemorysize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Note:</span></span><br><span class="line"><span class="comment">//注释掉的部分就是自定义序列化和反序列化的代码部分</span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Map</span> <span class="comment">//: ISerializable, IDeserializationCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Special construct(required by ISerializable) to control deserialization</span></span><br><span class="line">    <span class="comment">//[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]</span></span><br><span class="line">    <span class="comment">//protected Map(SerializationInfo info, StreamingContext context)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    m_SiInfo = info;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]</span></span><br><span class="line">    <span class="comment">//public virtual void GetObjectData(SerializationInfo info, StreamingContext context)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    info.AddValue(&quot;mID&quot;, mID);</span></span><br><span class="line">    <span class="comment">//    info.AddValue(&quot;mMapName&quot;, mMapName);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//void IDeserializationCallback.OnDeserialization(Object sender)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    if (m_SiInfo == null)</span></span><br><span class="line">    <span class="comment">//    &#123;</span></span><br><span class="line">    <span class="comment">//        return;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    mID = m_SiInfo.GetInt32(&quot;mID&quot;);</span></span><br><span class="line">    <span class="comment">//    mMapName = m_SiInfo.GetString(&quot;mMapName&quot;);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//private SerializationInfo m_SiInfo;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Map</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mID = <span class="number">0</span>;</span><br><span class="line">        mMapName = <span class="string">&quot;DefaultMap&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mID;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mID = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> MapName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mMapName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMapName = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mMapName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Serialization</span></span><br><span class="line"><span class="built_in">string</span> mMapSavePath = <span class="string">&quot;./mapInfo.dat&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="built_in">int</span> id = <span class="number">0</span>; id &lt; <span class="number">500</span>; id++)</span><br><span class="line">&#123;</span><br><span class="line">    Map map = <span class="keyword">new</span> Map();</span><br><span class="line">    map.ID = id;</span><br><span class="line">    map.MapName = id.ToString();</span><br><span class="line">    BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">    <span class="keyword">var</span> mapsavepath = mMapSavePath + id;</span><br><span class="line">    <span class="keyword">if</span> (!File.Exists(mapsavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream fsc = File.Create(mapsavepath);</span><br><span class="line">        fsc.Close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileStream fs = File.Open(mapsavepath, FileMode.Open);</span><br><span class="line">    bf.Serialize(fs, map);</span><br><span class="line">    fs.Close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">ShowHeapMemoryUsingPrepration();</span><br><span class="line">TimeCounter.Singleton.Restart(<span class="string">&quot;Deserialization&quot;</span>);</span><br><span class="line">Map mDSMap;</span><br><span class="line">BinaryFormatter dsbf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> id = <span class="number">0</span>; id &lt; <span class="number">500</span>; id++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> mapsavepath = mMapSavePath + id;</span><br><span class="line">    <span class="keyword">if</span> (File.Exists(mapsavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream dsfs = File.Open(mapsavepath, FileMode.Open);</span><br><span class="line">        mDSMap = (Map)dsbf.Deserialize(dsfs);</span><br><span class="line">        dsfs.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">TimeCounter.Singleton.End();</span><br><span class="line">ShowHeapMemoryUsing(<span class="string">&quot;Serialization&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>自定义序列化反序列化开销:<br><img src="/img/Unity/CustomSerializationPerformance.PNG" alt="CustomSerializationPerformance"><br>默认序列化开销:<br><img src="/img/Unity/DefaultSerializationPerformance.PNG" alt="DefaultSerializationPerformance"><br>Note:<br>    <strong>实际测试以后发现，自定义并没有加快反序列化的速度，反而增加了内存开销</strong><br>    从上面的测试可以看出反序列化的速度没有加快，反倒是反序列化的内存开销增加了。<br>    这里的测试结果也和<a target="_blank" rel="noopener" href="https://theburningwork.com/2011/08/performance-test-binaryformatter-vs-protobuf-net/">Performance Test - BinaryFormatter vs Protobuf-Net</a>里的结论一致了。<strong>但至于为什么反序列化速度没有提升，这里不太明白，理论上避免了反射应该是有所提升才对。希望知道的朋友忘告知。</strong></p>
<ol start="2">
<li>序列化的数据仅仅是通过C#自身可以反序列化出来，不支持跨语言(比如服务器端使用Java的话，并不能直接使用同样的序列化数据)。</li>
</ol>
<h4 id="ProtoBuff"><a href="#ProtoBuff" class="headerlink" title="ProtoBuff"></a>ProtoBuff</h4><h5 id="ProtoBuff学习了解"><a href="#ProtoBuff学习了解" class="headerlink" title="ProtoBuff学习了解"></a>ProtoBuff学习了解</h5><p>Protocol Buffers是Google发布出来的开源项目。<br><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/overview">Protocol Buffers - a language-neutral, platform-neutral, extensible way of serializing structured data for use in communications protocols, data storage, and more. </a><br>从官网介绍可以看出Google Protocol Buffers(平台无关，语言无关)是针对序列化数据的存储和传输协议等。<br>既然都是用于数据存储，那么Protocol buffers相比传统的二进制和XML序列化有什么优势了？<br>相比XML序列化，Protocol buffers更高效，更灵活，更快，更小，更简单。<br>更方便简单在于 – PB只需定义一次data的数据结构就能自动生成对应语言的解析该数据结构的代码类。<br>更高效更小在于 – XML存储的数据量大，XML在解析的时候，空间开销大，内容多速度慢。(XML的好处 – 具有可读性)<br>更灵活在于 – 只需更新数据结构定义然后编译出对应语言的代码就能无缝衔接以前的版本。<br>既然Protocol buffers这么好，那么让我们看看他是怎么工作的？</p>
<ol>
<li>定义出我们需要序列化的数据结构，保存在.proto文件里。</li>
<li>运用Protocol buffer编译器编译出我们对应语言的解析该数据结构的代码类。<br>首先下载对应语言的<a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/tag/v3.0.0">Protocol buffer编译器</a><br>“There are two NuGet packages: Google.Protobuf (the support library) and Google.Protobuf.Tools (containing protoc)”<br>根据上面写的，C#现在貌似有两个版本支持Protocol Buffer，但原生的Protobuf版本支持的.NET版本很高，所以不适合Unity(Unity是基于Mono的，Mono现在对.NET的支持还停留在.NET 2.0和.NET 2.0 subset)。</li>
</ol>
<p>—————————–2018&#x2F;5&#x2F;6(新增)———————————–<br><img src="/img/Unity/UntiyDotNetVersion.PNG" alt="UntiyDotNetVersion"><br>虽然表面上Unity(5.6.4p4)写的.Net 2.0和.Net 2.0 Subnet，其实支持的算是.Net 2.0 + .Net 3.5<br>详情参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/myqtmacc/article/details/70500099">扒一扒.net、.net framework、mono和Unity</a><br><img src="/img/Unity/Unity2017DotNetVersion.PNG" alt="Unity2017DotNetVersion"><br>到了Unity 2017,Unity已经支持到.Net 3.5和测试版的.Net 4.6了(支持C# 6语法)<br>Mono逐渐被IL2CPP取代，MonoDevelop工具在Unity2018开始也正式废弃不再支持。<a target="_blank" rel="noopener" href="https://blogs.unity3d.com/cn/2018/01/05/discontinuing-support-for-monodevelop-unity-starting-in-unity-2018-1/">Replacing MonoDevelop-Unity with Visual Studio Community starting in Unity 2018.1</a><br>——————————2018&#x2F;5&#x2F;6(新增)———————————–</p>
<p>所以通过Google，我找到了以下两个开源项目：<br>    1. <a target="_blank" rel="noopener" href="https://github.com/jskeet/protobuf-csharp-port">Protobuf-csharp-port</a><br>    2. <a target="_blank" rel="noopener" href="https://github.com/mgravell/protobuf-net">Protobuf-net</a><br>    前者在Git上的描述不多，所以这里就以下面引用的话来了解两者之间的区别。<br>    <a target="_blank" rel="noopener" href="http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/">Protobuf-csharp-port is written by Jon Skeet and is a faithful port of Google’s java implementation that uses similar command-line tooling. You create the data definitions in text-based .proto files and use a code generation tool to create the C# classes.</a><br>    Protobuf-csharp-port是由Jon Skeet编写，利用原生工具去port的版本。在编译创建上都沿用了Protocol buffer的原始方式(通过编译.proto文件生成解析定义的Message数据结构的C#代码类)<br>    <a target="_blank" rel="noopener" href="http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/">Protobuf-net is written by Marc Gravell and will be more familiar to .Net developers. The implementation uses .Net classes and attributes to define data rather than .proto files. Overall, the code resembles existing .Net serializers such as the DataContractSerializer.</a><br>    Protobuf-net是由Marc Gravell编写，支持.NET的类和attributes去定义数据结构，也支持.proto文件预编译生成对应代码类。可以说是.NET风格的Protobuf。<br>    同时Github写明了支持：<br>    .net 2.0&#x2F;3.0&#x2F;3.5&#x2F;4.0<br>    Mono 2.x<br>    所以这里就决定使用Protobuf-net作为Unity C#序列化数据的存储和协议传输的库来学习。<br>        1. 安装Protobuf-net<br>        VS -&gt; Tools -&gt; Nuget Package Manager -&gt; Package Manager Console<br>        在Package Manager Console窗口输入下列命令就会自动去下载Protobuf-net包并安装了。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package protobuf-net</span><br></pre></td></tr></table></figure>

<pre><code>    也可以直接下载[Down load link of Protobuf-net](https://code.google.com/archive/p/protobuf-net/downloads)
    把Protobuf-net.dll放到Assets/Plugins目录下
    2. 定义可序列化的类
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> ProtoBuf;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ProtoContract</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerData</span> &#123;</span><br><span class="line">    [<span class="meta">ProtoMember(1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> SceneName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ProtoMember(2)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Scores</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ProtoMember(3)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过C#(对应语言)protocol buffer API去读写存储的数据。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line"></span><br><span class="line">    mProfilePath =  Application.persistentDataPath + <span class="string">&quot;/PlayerProile.bin&quot;</span>;</span><br><span class="line">    Debug.Log(<span class="string">&quot;mProfilePath = &quot;</span> + mProfilePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SavePlayerData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Do serialization for player data</span></span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Create(mProfilePath);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadPlayerData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.OpenRead(mProfilePath);</span><br><span class="line">        mPlayerData = Serializer.Deserialize&lt;PlayerData&gt;(profile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line">        mPlayerData.SceneName = Application.productName;</span><br><span class="line">        mPlayerData.Scores = <span class="number">0</span>;</span><br><span class="line">        mPlayerData.SpeedLevel = <span class="number">1</span>;</span><br><span class="line">        SavePlayerData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但只是这样的话，会报如下错误：<br>NotSupportException： …… System.Reflection.Emit is not supported<br>这里出现了Emit类的使用，显然是用到了动态生成代码，根据我们之前讲到的IOS是在Full-AOT模式下运行不允许动态生成代码的。<br>所以直接使用.NET风格的Attribute会触发动态代码生成，那么我们就需要想办法提前生成，这里就需要使用.proto文件然后通过预编译的方式生成对应的代码类。<br>所以现在我们需要先定义.proto文件(Protobuf-net只支持Proto2)，所以编写<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto">proto2参考</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PlayerData.proto</span></span><br><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line">package NGUI2DGame;</span><br><span class="line"></span><br><span class="line">message PlayerData&#123;</span><br><span class="line">    optional <span class="built_in">string</span> SceneName = <span class="number">1</span>;</span><br><span class="line">    optional int32 Scores = <span class="number">2</span>;</span><br><span class="line">    optional int32 SpeedLevel = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过Protogen.exe帮我们生成对应解析该数据结构所需要的代码类</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protogen -i:PlayerData.proto -o:PlayerData.cs -ns:NGUI2DGame</span><br></pre></td></tr></table></figure>

<p>-i是指明输入，这里可以通过-i指定多个输入proto文件。-o是指定输出文件，最终生成的对应信息的代码类。-ns是指定namespace</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PlayerData.cs</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//     This code was generated by a tool.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     Changes to this file may cause incorrect behavior and will be lost if</span></span><br><span class="line"><span class="comment">//     the code is regenerated.</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Generated from: PlayerData.proto</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NGUI2DGame</span></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="meta">global::System.Serializable, global::ProtoBuf.ProtoContract(Name=@<span class="string">&quot;PlayerData&quot;</span>)</span>]</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">PlayerData</span> : <span class="title">global</span>::<span class="title">ProtoBuf.IExtensible</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PlayerData</span>()</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _SceneName = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    [<span class="meta">global::ProtoBuf.ProtoMember(1, IsRequired = false, Name=@<span class="string">&quot;SceneName&quot;</span>, DataFormat = global::ProtoBuf.DataFormat.Default)</span>]</span><br><span class="line">    [<span class="meta">global::System.ComponentModel.DefaultValue(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> SceneName</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> _SceneName; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123; _SceneName = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _Scores = <span class="literal">default</span>(<span class="built_in">int</span>);</span><br><span class="line">    [<span class="meta">global::ProtoBuf.ProtoMember(2, IsRequired = false, Name=@<span class="string">&quot;Scores&quot;</span>, DataFormat = global::ProtoBuf.DataFormat.TwosComplement)</span>]</span><br><span class="line">    [<span class="meta">global::System.ComponentModel.DefaultValue(default(int))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Scores</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> _Scores; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123; _Scores = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _SpeedLevel = <span class="literal">default</span>(<span class="built_in">int</span>);</span><br><span class="line">    [<span class="meta">global::ProtoBuf.ProtoMember(3, IsRequired = false, Name=@<span class="string">&quot;SpeedLevel&quot;</span>, DataFormat = global::ProtoBuf.DataFormat.TwosComplement)</span>]</span><br><span class="line">    [<span class="meta">global::System.ComponentModel.DefaultValue(default(int))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> _SpeedLevel; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123; _SpeedLevel = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">global</span>::ProtoBuf.IExtension extensionObject;</span><br><span class="line">    <span class="keyword">global</span>::ProtoBuf.IExtension <span class="keyword">global</span>::ProtoBuf.IExtensible.GetExtensionObject(<span class="built_in">bool</span> createIfMissing)</span><br><span class="line">      &#123; <span class="keyword">return</span> <span class="keyword">global</span>::ProtoBuf.Extensible.GetExtensionObject(<span class="keyword">ref</span> extensionObject, createIfMissing); &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来把我们生成的代码通过VS编译成DLL</p>
<ol>
<li>新建C# Library工程</li>
<li>删掉原始cs添加刚才生成的PlayerData.cs</li>
<li>添加Protobuf-net库引用(用CoreOnly&#x2F;ios&#x2F;protobuf-net.dll)</li>
<li>编译出dll<br>最后我们需要通过上一步生成的信息类dll来编译出专门序列化该信息的类库。(添加precompile.exe的路径到环境变量确保找得到，这里要注意的是dll项目的.NET target设置成2.0，因为Unity Mono现在只支持到2.0)<br>在之前生成的PlayerData.dll目录下执行下列命令：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">precompile PlayerData.dll -o:ProtobufSerializer.dll -t:com.TonyTang.ProtobufSerializer</span><br></pre></td></tr></table></figure>

<p>-o指明输出文件 -t指明生成的序列化类的类名<br>最后利用生成的PlayerData.dll和ProtobufSerializer.dll到Unity里进行测试，编写对应代码即可，写法和之前的区别就是用我们生成好的类来完成序列化和反序列化。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Serialization</span></span><br><span class="line">ProtobufSerializer serializer = <span class="keyword">new</span> ProtobufSerializer();       </span><br><span class="line">profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">serializer.Serialize(profile, mPlayerData);</span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">profile = File.OpenRead(mProfilePath);</span><br><span class="line">mPlayerData = serializer.Deserialize(profile,<span class="literal">null</span>,<span class="keyword">typeof</span>(PlayerData)) <span class="keyword">as</span> PlayerData;</span><br></pre></td></tr></table></figure>

<p>因为需要编写.proto文件后编译生成对应的Serialization类的dll，所以最好通过shell脚本写成自动化。<br>还有一种方式是使用Probobuf-net源码的形式(貌似需要设定-unsafe和.NET 2 subset)，这里我没有尝试，下面给出链接：<br><a target="_blank" rel="noopener" href="http://www.ceeger.com/forum/read.php?tid=14359&fid=27">在ios android设备上使用 Protobuf (使用源码方式) </a></p>
<p>了解了什么(What)是Protobuf，如何(How)使用Protobuf，那么我们也应该大概了解下为什么(Why)Protobuf高效，更小，更快，更简单…..<br>参考下面两篇文章：<br><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/">Google Protocol Buffer 的使用和原理</a><br><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/encoding">官网讲到的Protocol buffer的Encode技术</a><br>从上面可以看出，更小更快是因为Protocol buffer采用了巧妙的Encoding方法。<br>而这个Encoding方法利用了Varint技术，那么什么是Varint了？<br>“Varints are a method of serializing integers using one or more bytes. Smaller numbers take a smaller number of bytes. “<br>Varints通过更少的字节来表达准确的数据，比如0-127只需要1个字节就能表示。<br>当需要多个字节表达的时候，通过利用1byte里的first bit来区分，如果first bit是1表示后续的7个bit都表示数据，如果first bit是0表示这是最后一个字节用于表示数据。<br>同时Protocol buffer在Encode的时候通过key和value来存储数据。key只包含filed的名字和类型，value包含数据。<br>类型数据映射<br><img src="/img/Unity/ProtocolBufferMessageValueType.PNG" alt="ProtocolBufferMessageValueType"><br>当Decode的时候，如果遇到不识别的key值，只需要skip即可，保证了程序的老版本兼容。<br>更方便在于，我们只需通过编写简单易懂的.proto文件然后通过ProtoGen，Precompile工具就能生成对应的Message，Encode和Decode类。<br>结合前面的事例，让我们窥探一下到底Protocol-net是如何实现编写.proto文件结合编译生成Message类和序列化类来实现数据的Encode和Decode的。<br>首先反编译的ProtovufSerializer.dll，查看Serialize方法<br><img src="/img/Unity/ProtobufSerializerSerialize.PNG" alt="ProtobufSerializerSerialize"><br>可以看到ProtobufSerializer调用了Write方法，接下来查看Write方法<br><img src="/img/Unity/ProtobufSerializerWrite.PNG" alt="ProtobufSerializerWrite"><br>可以看到我们ProtobufSerializer实际是通过调用ProtoBuf.ProtoWriter::WriteFieldHeader(Protobuf-net库)实现数据的Encode的。同时因为ProtobufSerializer是根据PlayerData.dll编译而成，所以Write方法里的实现针对每一个需要Encode的Message成员进行数据Encode写入。<br>这样一来就完成了通过编写.proto文件定义Message，然后生成对应的Message类和序列化类再结合Protocol-net库实现了自定义Message的Encode和Decode了，而最终数据的Encode，Decode实现就落实到Protocol-net的实现了。</p>
<p>那么为什么要用Protocol buffer了？<br>参考文章：<br><a target="_blank" rel="noopener" href="http://www.oschina.net/translate/choose-protocol-buffers">使用 Protocol Buffers 代替 JSON 的五个原因</a><br>Protocol buffer因为是存储在二进制文件，相比XML，Jason等技术不具可读性。</p>
<p>Note:<br>最初的Protocol Buffers只开发了针对Java,C++,Python的版本。后来开园后有了C#，Go等语言的支持。<br>Protocol Buffer存储的数据是以二进制的形式。<br>Protocol-net只支持<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto">proto2的语言编写规范</a>。</p>
<p>从之前的学习可以知道的是，ProtoBuf通过自定义了Encode和Decode，使用Varint技术，把数据成功压缩更小，实现了更小的数据量存储。</p>
<p>——————————-2018&#x2F;04&#x2F;22———————————–<br>关于ProtoBuf原理深度解析，这里找到一篇好文:<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/30ef9b3780d9">Protocol Buffer 序列化原理大揭秘 - 为什么Protocol Buffer性能这么好？</a>——————————-2018&#x2F;04&#x2F;22———————————–</p>
<p>前面提到的是Protocol Buffer 2的使用，那么我们能否集成使用Protocol Buffer 3吗？<br>答案是可以的，接下来我们学习Protocol Bufffer 3的集成使用。</p>
<h5 id="Protocol-Buffer-3-in-Unity"><a href="#Protocol-Buffer-3-in-Unity" class="headerlink" title="Protocol Buffer 3 in Unity"></a>Protocol Buffer 3 in Unity</h5><p>Protocok Buffer(高效的跨语言序列化反序列化数据以及数据结构向后扩展兼容)</p>
<p>问题：</p>
<ol>
<li>PB3对.Net版本的要求？<br>在前面的学习中，我们使用了Protobuf-net版本(支持.Net 2.0,3.0,4.0，但只支持PB2)，这里是学习了解PB3是否能在Unity中使用起来。</li>
</ol>
<p>Probuf官方Git链接：<br><a target="_blank" rel="noopener" href="https://github.com/google/protobuf">protobuf</a><br>Probuf最新压缩包链接：<br><a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/tag/v3.6.1">protobuf latest</a><br>从Git上下载的最新PB3要求.Net4.5，这是从Git上Protobuf CS源代码工程的Google.Protobuf.csproj文件里看出来的：<br><img src="/img/Unity/Data-Config-Automation/Protobuf3DotNetTargetNumber.png" alt="Protobuf3DotNetTargetNumber"></p>
<ol start="2">
<li><p>Unity支持的.Net版本?<br><img src="/img/Unity/Unity2017DotNetVersion.PNG" alt="Unity2017DotNetVersion"><br>到了Unity 2017,Unity已经支持到.Net 3.5和测试版的.Net 4.6了(支持C# 6语法)</p>
</li>
<li><p>Unity支持的PB版本？<br>通过前面两个问题可以知道，Unity要想支持PB3，我们需要把PB3编译成基于.Net 3.5(因为.Net 4.6还处于测试阶段，所以没选择.Net 4.6)来使用。看网上都有兼容PB3的版本了，理论上Unity是有办法支持PB3的。<br>兼容PB3的版本链接:<br><a target="_blank" rel="noopener" href="https://github.com/bitcraftCoLtd/protobuf3-for-unity">protobuf3-for-unity</a></p>
</li>
<li><p>Python对应需要的PB版本？<br>选择和前面CS版本相同版本的Python版本的PB3即可(PB3 3.6.1)</p>
</li>
<li><p>Protoc的选择？<br>直接下载编译好的对应版本的Protoc(3.6.1)压缩包即可</p>
</li>
</ol>
<p>流程：<br>Protobuf CSharp篇：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/tag/v3.6.1">下载新版Protobuf Csharp版</a></li>
<li>自己编译基于.Net 3.5版本Protobuf Csharp版dll(我的理解这一步的dll是Protobuf核心的模块，用于支持对数据编码存储)<br>打开下载的Protobuf Csharp源码里的Google.Protobuf.sln，修改里面Google.Protobuf.csproj工程的TargetFrameworks编译生成我们想要的基于.Net 3.5的Csharp版Protobuf-Csharp.dll<br><img src="/img/Unity/Data-Config-Automation/CompileProtobufCsharpForDoNet35.png" alt="CompileProtobufCsharpForDoNet35"><br><img src="/img/Unity/Data-Config-Automation/DoNet35ProtobufCsharpDll.png" alt="DoNet35ProtobufCsharpDll"><br>复制基于.Net 3.Google.Protobuf.dll到我们的Unity脚本目录下。</li>
</ol>
<p>Note:</p>
<ul>
<li>Protobuf 3.6.1的Google.Protobuf.sln工程需要VS2017才能正确打开，VS2015本人打开显示加载.csproj的C#项目都失败了</li>
</ul>
<ol start="3">
<li>使用Protoc.exe对*.proto文件进行解析生成对应的代码(我的理解，这一步是为了支持指定定义的数据格式的序列化和反序列化相关代码)<br>第一步需要添加Protoc.exe到环境变量里，方便快速访问调用Protoc.exe(这个就不细说了)<br>编写测试GameConfig.proto文件：</li>
</ol>
<figure class="highlight proto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用proto3</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="comment">// 指明namespace</span></span><br><span class="line"><span class="keyword">package</span> GameData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 游戏配置信息</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">GameConfig</span> &#123;</span><br><span class="line">  <span class="type">string</span> difficultyLevel = <span class="number">1</span>;           <span class="comment">// 游戏难度</span></span><br><span class="line">  <span class="type">int32</span> versionNumber = <span class="number">2</span>;              <span class="comment">// 游戏版本号</span></span><br><span class="line">  <span class="type">int32</span> resourceNumber = <span class="number">3</span>;             <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用protoc.exe生成用于序列化反序列化GameConfig的代码:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc.exe --csharp_out=CsharpCode -I=Proto GameConfig.proto</span><br></pre></td></tr></table></figure>

<p>–csharp_out指明CS脚本输出目录<br>-I指明Proto文件查找目录<br>GameConfig.proto表示protoc.exe编译该文件<br>最终得到我们Csharp序列化和反序列化GameConfig所需的代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//     Generated by the protocol buffer compiler.  DO NOT EDIT!</span></span><br><span class="line"><span class="comment">//     source: GameConfig.proto</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span> disable 1591, 0612, 3021</span></span><br><span class="line"><span class="meta">#<span class="keyword">region</span> Designer generated code</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> pb = <span class="keyword">global</span>::Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> pbc = <span class="keyword">global</span>::Google.Protobuf.Collections;</span><br><span class="line"><span class="keyword">using</span> pbr = <span class="keyword">global</span>::Google.Protobuf.Reflection;</span><br><span class="line"><span class="keyword">using</span> scg = <span class="keyword">global</span>::System.Collections.Generic;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GameData</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Holder for reflection information generated from GameConfig.proto<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GameConfigReflection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Descriptor</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>File descriptor for GameConfig.proto<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> pbr::FileDescriptor Descriptor &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> descriptor; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> pbr::FileDescriptor descriptor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">GameConfigReflection</span>()</span> &#123;</span><br><span class="line">      <span class="built_in">byte</span>[] descriptorData = <span class="keyword">global</span>::System.Convert.FromBase64String(</span><br><span class="line">          <span class="built_in">string</span>.Concat(</span><br><span class="line">            <span class="string">&quot;ChBHYW1lQ29uZmlnLnByb3RvEghHYW1lRGF0YSJUCgpHYW1lQ29uZmlnEhcK&quot;</span>,</span><br><span class="line">            <span class="string">&quot;D2RpZmZpY3VsdHlMZXZlbBgBIAEoCRIVCg12ZXJzaW9uTnVtYmVyGAIgASgF&quot;</span>,</span><br><span class="line">            <span class="string">&quot;EhYKDnJlc291cmNlTnVtYmVyGAMgASgFYgZwcm90bzM=&quot;</span>));</span><br><span class="line">      descriptor = pbr::FileDescriptor.FromGeneratedCode(descriptorData,</span><br><span class="line">          <span class="keyword">new</span> pbr::FileDescriptor[] &#123; &#125;,</span><br><span class="line">          <span class="keyword">new</span> pbr::GeneratedClrTypeInfo(<span class="literal">null</span>, <span class="keyword">new</span> pbr::GeneratedClrTypeInfo[] &#123;</span><br><span class="line">            <span class="keyword">new</span> pbr::GeneratedClrTypeInfo(<span class="keyword">typeof</span>(<span class="keyword">global</span>::GameData.GameConfig), <span class="keyword">global</span>::GameData.GameConfig.Parser, <span class="keyword">new</span>[]&#123; <span class="string">&quot;DifficultyLevel&quot;</span>, <span class="string">&quot;VersionNumber&quot;</span>, <span class="string">&quot;ResourceNumber&quot;</span> &#125;, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">          &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="keyword">region</span> Messages</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 游戏配置信息</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GameConfig</span> : <span class="title">pb</span>::<span class="title">IMessage</span>&lt;<span class="title">GameConfig</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> pb::MessageParser&lt;GameConfig&gt; _parser = <span class="keyword">new</span> pb::MessageParser&lt;GameConfig&gt;(() =&gt; <span class="keyword">new</span> GameConfig());</span><br><span class="line">    <span class="keyword">private</span> pb::UnknownFieldSet _unknownFields;</span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> pb::MessageParser&lt;GameConfig&gt; Parser &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> _parser; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> pbr::MessageDescriptor Descriptor &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">global</span>::GameData.GameConfigReflection.Descriptor.MessageTypes[<span class="number">0</span>]; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    pbr::MessageDescriptor pb::IMessage.Descriptor &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> Descriptor; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameConfig</span>()</span> &#123;</span><br><span class="line">      OnConstruction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">partial</span> <span class="keyword">void</span> <span class="title">OnConstruction</span>()</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameConfig</span>(<span class="params">GameConfig other</span>) : <span class="title">this</span>()</span> &#123;</span><br><span class="line">      difficultyLevel_ = other.difficultyLevel_;</span><br><span class="line">      versionNumber_ = other.versionNumber_;</span><br><span class="line">      resourceNumber_ = other.resourceNumber_;</span><br><span class="line">      _unknownFields = pb::UnknownFieldSet.Clone(other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameConfig <span class="title">Clone</span>()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> GameConfig(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Field number for the &quot;difficultyLevel&quot; field.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> DifficultyLevelFieldNumber = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> difficultyLevel_ = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏难度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DifficultyLevel &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> difficultyLevel_; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123;</span><br><span class="line">        difficultyLevel_ = pb::ProtoPreconditions.CheckNotNull(<span class="keyword">value</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Field number for the &quot;versionNumber&quot; field.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> VersionNumberFieldNumber = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> versionNumber_;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏版本号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> VersionNumber &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> versionNumber_; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123;</span><br><span class="line">        versionNumber_ = <span class="keyword">value</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Field number for the &quot;resourceNumber&quot; field.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> ResourceNumberFieldNumber = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> resourceNumber_;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏资源版本号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ResourceNumber &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> resourceNumber_; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123;</span><br><span class="line">        resourceNumber_ = <span class="keyword">value</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Equals</span>(<span class="params"><span class="built_in">object</span> other</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Equals(other <span class="keyword">as</span> GameConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Equals</span>(<span class="params">GameConfig other</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (ReferenceEquals(other, <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ReferenceEquals(other, <span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel != other.DifficultyLevel) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != other.VersionNumber) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != other.ResourceNumber) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">return</span> Equals(_unknownFields, other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">GetHashCode</span>()</span> &#123;</span><br><span class="line">      <span class="built_in">int</span> hash = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel.Length != <span class="number">0</span>) hash ^= DifficultyLevel.GetHashCode();</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != <span class="number">0</span>) hash ^= VersionNumber.GetHashCode();</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != <span class="number">0</span>) hash ^= ResourceNumber.GetHashCode();</span><br><span class="line">      <span class="keyword">if</span> (_unknownFields != <span class="literal">null</span>) &#123;</span><br><span class="line">        hash ^= _unknownFields.GetHashCode();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> pb::JsonFormatter.ToDiagnosticString(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WriteTo</span>(<span class="params">pb::CodedOutputStream output</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel.Length != <span class="number">0</span>) &#123;</span><br><span class="line">        output.WriteRawTag(<span class="number">10</span>);</span><br><span class="line">        output.WriteString(DifficultyLevel);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        output.WriteRawTag(<span class="number">16</span>);</span><br><span class="line">        output.WriteInt32(VersionNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        output.WriteRawTag(<span class="number">24</span>);</span><br><span class="line">        output.WriteInt32(ResourceNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (_unknownFields != <span class="literal">null</span>) &#123;</span><br><span class="line">        _unknownFields.WriteTo(output);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">CalculateSize</span>()</span> &#123;</span><br><span class="line">      <span class="built_in">int</span> size = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel.Length != <span class="number">0</span>) &#123;</span><br><span class="line">        size += <span class="number">1</span> + pb::CodedOutputStream.ComputeStringSize(DifficultyLevel);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        size += <span class="number">1</span> + pb::CodedOutputStream.ComputeInt32Size(VersionNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        size += <span class="number">1</span> + pb::CodedOutputStream.ComputeInt32Size(ResourceNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (_unknownFields != <span class="literal">null</span>) &#123;</span><br><span class="line">        size += _unknownFields.CalculateSize();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MergeFrom</span>(<span class="params">GameConfig other</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (other == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (other.DifficultyLevel.Length != <span class="number">0</span>) &#123;</span><br><span class="line">        DifficultyLevel = other.DifficultyLevel;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (other.VersionNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        VersionNumber = other.VersionNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (other.ResourceNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        ResourceNumber = other.ResourceNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      _unknownFields = pb::UnknownFieldSet.MergeFrom(_unknownFields, other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MergeFrom</span>(<span class="params">pb::CodedInputStream input</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">uint</span> tag;</span><br><span class="line">      <span class="keyword">while</span> ((tag = input.ReadTag()) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(tag) &#123;</span><br><span class="line">          <span class="literal">default</span>:</span><br><span class="line">            _unknownFields = pb::UnknownFieldSet.MergeFieldFrom(_unknownFields, input);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">10</span>: &#123;</span><br><span class="line">            DifficultyLevel = input.ReadString();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">16</span>: &#123;</span><br><span class="line">            VersionNumber = input.ReadInt32();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">24</span>: &#123;</span><br><span class="line">            ResourceNumber = input.ReadInt32();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span> Designer generated code</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用生成的代码进行序列化和反序列化数据测试<br>UIDebugMonoScript.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 快速访问UI组件测试挂在脚本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIDebugMonoScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建GameConfig按钮</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnCreateGameConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取GameConfig按钮</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnReadGameConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mBtnCreateGameConfig.onClick.AddListener(onCreateGameConfigClick);</span><br><span class="line">        mBtnReadGameConfig.onClick.AddListener(onReadGameConfigClick);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mBtnCreateGameConfig.onClick.RemoveAllListeners();</span><br><span class="line">        mBtnReadGameConfig.onClick.RemoveAllListeners();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCreateGameConfigClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onCreateGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.ProtobufDataFolderPath : &quot;</span> + PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        PathUtilities.checkAndCreateFolder(PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        GameConfig gameconfig = <span class="keyword">new</span> GameConfig();</span><br><span class="line">        gameconfig.DifficultyLevel = <span class="string">&quot;Easy&quot;</span>;</span><br><span class="line">        gameconfig.VersionNumber = <span class="number">1</span>;</span><br><span class="line">        gameconfig.ResourceNumber = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> output = File.Create(PathUtilities.ProtobufDataFolderPath + <span class="string">&quot;GameConfig.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            gameconfig.WriteTo(output);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onReadGameConfigClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onReadGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.ProtobufDataFolderPath : &quot;</span> + PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        GameConfig gameconfig;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.ProtobufDataFolderPath + <span class="string">&quot;GameConfig.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            gameconfig = GameConfig.Parser.ParseFrom(intput);</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.Log(<span class="string">&quot;gameconfig.DifficultyLevel : &quot;</span> + gameconfig.DifficultyLevel);</span><br><span class="line">        Debug.Log(<span class="string">&quot;gameconfig.VersionNumber : &quot;</span> + gameconfig.VersionNumber);</span><br><span class="line">        Debug.Log(<span class="string">&quot;gameconfig.ResourceNumber : &quot;</span> + gameconfig.ResourceNumber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PathUtilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             路径静态工具类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/03/12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 路径静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PathUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//******</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Protobuf</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Protobuf生成数据目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProtobufDataFolderPath = Application.dataPath + <span class="string">&quot;/Resources/ProtoData/&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> UNITY_ANDROID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProtobufDataFolderPath = Application.temporaryCachePath + <span class="string">&quot;/ProtoData/&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> UNITY_IOS</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProtobufDataFolderPath = Application.temporaryCachePath + <span class="string">&quot;/ProtoData/&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> 公用方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查并确保目录存在</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;folderpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkAndCreateFolder</span>(<span class="params"><span class="built_in">string</span> folderpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.CreateDirectory(folderpath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PC:<br><img src="/img/Unity/Data-Config-Automation/ProtobufSerialization.png" alt="ProtobufSerialization"><br>Android:<br><img src="/img/Unity/Data-Config-Automation/ProtobufSerializationAndroidPlatform.png" alt="ProtobufSerializationAndroidPlatform"><br>可以看到我们在PC和Android都成功使用Protobuf3进行了数据的序列化和反序列化。<br>接下来我们要完成的是测试同样的二进制序列化文件，通过Python版的Protobuf3是否能够正确的反序列化读取(验证跨语言数据存储读取)。</p>
<p>Protobuf Python篇：</p>
<ol>
<li>安装python</li>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/download/v3.6.1/protoc-3.6.1-win32.zip">Protoc.exe</a>用于安装生成python版proto文件对应的解析所需文件</li>
<li>下载对应版本的<a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/download/v3.6.1/protobuf-python-3.6.1.zip">Protobuf 3 Python版本</a>(这里我下的和Csharp版本的Protobuf3一样的版本3.6.1)</li>
<li>安装Protobuf 3 Python所需环境(在下载的Protobuf3 Python的Python原代码下运行python setup.py install)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<p>安装完成后会发现Protobuf 3 For Python相关的Package环境都被下载到了site-packages目录：<br><img src="/img/Unity/Data-Config-Automation/InstallProtobuf3EnviromentForPython.png" alt="Protobuf3ForPythonSetup"></p>
<ol start="5">
<li>编译Proto文件生成解析所需文件<br>依然使用protoc.exe，但这一次指定的输出代码是针对python的:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc.exe --python_out=PythonCode -I=Proto GameConfig.proto</span><br></pre></td></tr></table></figure>

<p>GameConfig_pb2.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generated by the protocol buffer compiler.  DO NOT EDIT!</span></span><br><span class="line"><span class="comment"># source: GameConfig.proto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">_b=sys.version_info[<span class="number">0</span>]&lt;<span class="number">3</span> <span class="keyword">and</span> (<span class="keyword">lambda</span> x:x) <span class="keyword">or</span> (<span class="keyword">lambda</span> x:x.encode(<span class="string">&#x27;latin1&#x27;</span>))</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> descriptor <span class="keyword">as</span> _descriptor</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> message <span class="keyword">as</span> _message</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> reflection <span class="keyword">as</span> _reflection</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> symbol_database <span class="keyword">as</span> _symbol_database</span><br><span class="line"><span class="comment"># @@protoc_insertion_point(imports)</span></span><br><span class="line"></span><br><span class="line">_sym_db = _symbol_database.Default()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DESCRIPTOR = _descriptor.FileDescriptor(</span><br><span class="line">  name=<span class="string">&#x27;GameConfig.proto&#x27;</span>,</span><br><span class="line">  package=<span class="string">&#x27;GameData&#x27;</span>,</span><br><span class="line">  syntax=<span class="string">&#x27;proto3&#x27;</span>,</span><br><span class="line">  serialized_options=<span class="literal">None</span>,</span><br><span class="line">  serialized_pb=_b(<span class="string">&#x27;\n\x10GameConfig.proto\x12\x08GameData\&quot;T\n\nGameConfig\x12\x17\n\x0f\x64ifficultyLevel\x18\x01 \x01(\t\x12\x15\n\rversionNumber\x18\x02 \x01(\x05\x12\x16\n\x0eresourceNumber\x18\x03 \x01(\x05\x62\x06proto3&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_GAMECONFIG = _descriptor.Descriptor(</span><br><span class="line">  name=<span class="string">&#x27;GameConfig&#x27;</span>,</span><br><span class="line">  full_name=<span class="string">&#x27;GameData.GameConfig&#x27;</span>,</span><br><span class="line">  filename=<span class="literal">None</span>,</span><br><span class="line">  file=DESCRIPTOR,</span><br><span class="line">  containing_type=<span class="literal">None</span>,</span><br><span class="line">  fields=[</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;difficultyLevel&#x27;</span>, full_name=<span class="string">&#x27;GameData.GameConfig.difficultyLevel&#x27;</span>, index=<span class="number">0</span>,</span><br><span class="line">      number=<span class="number">1</span>, <span class="built_in">type</span>=<span class="number">9</span>, cpp_type=<span class="number">9</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=_b(<span class="string">&quot;&quot;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;versionNumber&#x27;</span>, full_name=<span class="string">&#x27;GameData.GameConfig.versionNumber&#x27;</span>, index=<span class="number">1</span>,</span><br><span class="line">      number=<span class="number">2</span>, <span class="built_in">type</span>=<span class="number">5</span>, cpp_type=<span class="number">1</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;resourceNumber&#x27;</span>, full_name=<span class="string">&#x27;GameData.GameConfig.resourceNumber&#x27;</span>, index=<span class="number">2</span>,</span><br><span class="line">      number=<span class="number">3</span>, <span class="built_in">type</span>=<span class="number">5</span>, cpp_type=<span class="number">1</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">  ],</span><br><span class="line">  extensions=[</span><br><span class="line">  ],</span><br><span class="line">  nested_types=[],</span><br><span class="line">  enum_types=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_options=<span class="literal">None</span>,</span><br><span class="line">  is_extendable=<span class="literal">False</span>,</span><br><span class="line">  syntax=<span class="string">&#x27;proto3&#x27;</span>,</span><br><span class="line">  extension_ranges=[],</span><br><span class="line">  oneofs=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_start=<span class="number">30</span>,</span><br><span class="line">  serialized_end=<span class="number">114</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">DESCRIPTOR.message_types_by_name[<span class="string">&#x27;GameConfig&#x27;</span>] = _GAMECONFIG</span><br><span class="line">_sym_db.RegisterFileDescriptor(DESCRIPTOR)</span><br><span class="line"></span><br><span class="line">GameConfig = _reflection.GeneratedProtocolMessageType(<span class="string">&#x27;GameConfig&#x27;</span>, (_message.Message,), <span class="built_in">dict</span>(</span><br><span class="line">  DESCRIPTOR = _GAMECONFIG,</span><br><span class="line">  __module__ = <span class="string">&#x27;GameConfig_pb2&#x27;</span></span><br><span class="line">  <span class="comment"># @@protoc_insertion_point(class_scope:GameData.GameConfig)</span></span><br><span class="line">  ))</span><br><span class="line">_sym_db.RegisterMessage(GameConfig)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @@protoc_insertion_point(module_scope)</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>利用Python的Proto代码序列化(或者反序列化C#序列化的)数据<br>反序列化C#序列化的数据事例：<br>GameConfigSerialization.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File Name:        GameConfigSerialization.py</span></span><br><span class="line"><span class="comment"># Description:      This file is used to Serialize GameConfig Data</span></span><br><span class="line"><span class="comment"># Author:           TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:      2018/08/20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> GameConfig_pb2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">gameconfig = GameConfig_pb2.GameConfig()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read the existing GameConfig.data</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;GameConfig.data&quot;</span>, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line">gameconfig.ParseFromString(f.read())</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;gameconfig.difficultyLevel = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(gameconfig.difficultyLevel))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;gameconfig.versionNumber = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(gameconfig.versionNumber))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;gameconfig.resourceNumber = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(gameconfig.resourceNumber))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/PythonPB3DeserilizationFileStructure.png" alt="PythonPB3DeserilizationFileStructure"><br><img src="/img/Unity/Data-Config-Automation/PythonPB3Deserialization.png" alt="PythonPB3Deserialization"><br>可以看到我们成功的反序列化了C#序列化的数据(*证明了PB3跨语言的序列化反序列化支持)</p>
<p>Python PB3序列化数据事例:<br>GameConfigSerialization.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File Name:        GameConfigSerialization.py</span></span><br><span class="line"><span class="comment"># Description:      This file is used to Serialize GameConfig Data</span></span><br><span class="line"><span class="comment"># Author:           TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:      2018/08/20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> GameConfig_pb2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">gameconfig = GameConfig_pb2.GameConfig()</span><br><span class="line">gameconfig.difficultyLevel = <span class="string">&quot;Hard&quot;</span></span><br><span class="line">gameconfig.versionNumber = <span class="number">2</span></span><br><span class="line">gameconfig.resourceNumber = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Write the new GmaeConfig back to disk.</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;GameConfig_Py.data&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">f.write(gameconfig.SerializeToString())</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p>CSharp PB3反序列化:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GameConfig gameconfig;</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.ProtobufDataFolderPath + <span class="string">&quot;GameConfig_Py.data&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    gameconfig = GameConfig.Parser.ParseFrom(intput);</span><br><span class="line">&#125;</span><br><span class="line">Debug.Log(<span class="string">&quot;gameconfig.DifficultyLevel : &quot;</span> + gameconfig.DifficultyLevel);</span><br><span class="line">Debug.Log(<span class="string">&quot;gameconfig.VersionNumber : &quot;</span> + gameconfig.VersionNumber);</span><br><span class="line">Debug.Log(<span class="string">&quot;gameconfig.ResourceNumber : &quot;</span> + gameconfig.ResourceNumber);</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/CSharpPB3DeserilizationFileStructure.png" alt="CSharpPB3DeserilizationFileStructure"><br><img src="/img/Unity/Data-Config-Automation/CSharpPB3Deserialization.png" alt="CSharpPB3Deserialization"><br>可以看到我们也成功的通过C#的PB3反序列化了Python序列化的数据。这也验证了Protocol Buffer 3<em>跨语言的特性</em>。</p>
<p>Note:<br>Protocol Buffer很适合跨平台跨语言通信，用于网络通信定义数据结构。(待学习)</p>
<h4 id="FlatBuff"><a href="#FlatBuff" class="headerlink" title="FlatBuff"></a>FlatBuff</h4><p>在介绍FlatBuff前，让我们来看一张令人惊艳的各序列化方案测试性能对比图：<br><a target="_blank" rel="noopener" href="https://github.com/CodeZeg/xbuffer">图1来源至XBuffer的性能测试</a>:<br><img src="/img/Unity/Data-Config-Automation/SerializationPerformanceComparision.png" alt="SerializationPerformanceComparision"></p>
<p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/flatbuffers_benchmarks.html">图2来源至FlatBuff官方性能Benchmark</a>:<br><img src="/img/Unity/Data-Config-Automation/FlatBuffPerformanceBenchmark.png" alt="FlatBuffPerformanceBenchmark"></p>
<p>从上面两张图可以看到，令人惊讶的FlatBuff性能，无论是序列化还是反序列化，FlatBuff都相当高效，反序列化的时间居然几乎为0。</p>
<p>接下来我们深入学习了解FlatBuff，洞察其中的奥妙。</p>
<h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/">官网FlatBuffer</a><br><a href="google.github.io/flatbuffers">Represents hierachical data in a flat binary buffer in such a way that it can still be acecssed directly without parsing&#x2F;unpacking, while also still supporting data structure evolution(forwards&#x2F;backwards compatibility)</a><br>根据官方的介绍，FlatBuff把数据存储在一个扁平化的二进制Buffer里，这样一来FlatBuff访问和解析数据时可以向访问数据结构一样快速不需要解析或者解包(这应该就是为什么FlatBuff的反序列化时间几乎为0的原因)</p>
<p>这里简单列举下官方给出的FlatBuffer的好处:</p>
<ol>
<li>Access to serialized data without parsing&#x2F;unpacking(访问序列化数据块)</li>
<li>Memory efficiency and speed(内存和速度都很高效)</li>
<li>Flexible(向前向后兼容)</li>
<li>Tiny code footprint(生成代码量少且无依赖)</li>
<li>Strongly typed</li>
<li>Convenient to use(使用简单？)</li>
<li>Cross platform code with no dependencies(跨平台无依赖)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/">详情参考官网介绍</a></p>
<h5 id="实战使用"><a href="#实战使用" class="headerlink" title="实战使用"></a>实战使用</h5><p>接下来先按教程学习使用一波，再来看看底层的实现和优缺点：<br>使用步骤：</p>
<ol>
<li>编写schema文件(定义数据结构)<br>GameConfigFB.fbs</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">namespace GameData;</span><br><span class="line"></span><br><span class="line">table GameConfigFB&#123;</span><br><span class="line">  difficultyLevel:string;           // 游戏难度</span><br><span class="line">  versionNumber:int;                // 游戏版本号</span><br><span class="line">  resourceNumber:int;               // 游戏资源版本号</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root_type GameConfigFB;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html">schema文件编写参考</a></p>
<ol start="2">
<li>使用Flatc.exe(可以自己编译源码，也可以<a target="_blank" rel="noopener" href="https://github.com/google/flatbuffers/releases">下载现成的</a>)编译解析schema文件生成序列化和反序列化数据所需代码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./../flatc.exe --csharp .\GameConifgFB.fbs</span><br></pre></td></tr></table></figure>

<p>GameConfigFB.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//  automatically generated by the FlatBuffers compiler, do not modify</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GameData</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">global</span>::System;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">global</span>::FlatBuffers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> Table __p;</span><br><span class="line">  <span class="keyword">public</span> ByteBuffer ByteBuffer &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> __p.bb; &#125; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb</span>)</span> &#123; <span class="keyword">return</span> GetRootAsGameConfigFB(_bb, <span class="keyword">new</span> GameConfigFB()); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb, GameConfigFB obj</span>)</span> &#123; <span class="keyword">return</span> (obj.__assign(_bb.GetInt(_bb.Position) + _bb.Position, _bb)); &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> __init(<span class="built_in">int</span> _i, ByteBuffer _bb) &#123; __p.bb_pos = _i; __p.bb = _bb; &#125;</span><br><span class="line">  <span class="keyword">public</span> GameConfigFB __assign(<span class="built_in">int</span> _i, ByteBuffer _bb) &#123; __init(_i, _bb); <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> DifficultyLevel &#123; <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">4</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.__string(o + __p.bb_pos) : <span class="literal">null</span>; &#125; &#125;</span><br><span class="line">  <span class="keyword">public</span> ArraySegment&lt;<span class="built_in">byte</span>&gt;? GetDifficultyLevelBytes() &#123; <span class="keyword">return</span> __p.__vector_as_arraysegment(<span class="number">4</span>); &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> VersionNumber &#123; <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">6</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> ResourceNumber &#123; <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">8</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Offset&lt;GameConfigFB&gt; <span class="title">CreateGameConfigFB</span>(<span class="params">FlatBufferBuilder builder,</span></span></span><br><span class="line"><span class="params"><span class="function">      StringOffset difficultyLevelOffset = <span class="literal">default</span>(StringOffset</span>),</span></span><br><span class="line"><span class="function">      <span class="built_in">int</span> versionNumber</span> = <span class="number">0</span>,</span><br><span class="line">      <span class="built_in">int</span> resourceNumber = <span class="number">0</span>) &#123;</span><br><span class="line">    builder.StartObject(<span class="number">3</span>);</span><br><span class="line">    GameConfigFB.AddResourceNumber(builder, resourceNumber);</span><br><span class="line">    GameConfigFB.AddVersionNumber(builder, versionNumber);</span><br><span class="line">    GameConfigFB.AddDifficultyLevel(builder, difficultyLevelOffset);</span><br><span class="line">    <span class="keyword">return</span> GameConfigFB.EndGameConfigFB(builder);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StartGameConfigFB</span>(<span class="params">FlatBufferBuilder builder</span>)</span> &#123; builder.StartObject(<span class="number">3</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddDifficultyLevel</span>(<span class="params">FlatBufferBuilder builder, StringOffset difficultyLevelOffset</span>)</span> &#123; builder.AddOffset(<span class="number">0</span>, difficultyLevelOffset.Value, <span class="number">0</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddVersionNumber</span>(<span class="params">FlatBufferBuilder builder, <span class="built_in">int</span> versionNumber</span>)</span> &#123; builder.AddInt(<span class="number">1</span>, versionNumber, <span class="number">0</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddResourceNumber</span>(<span class="params">FlatBufferBuilder builder, <span class="built_in">int</span> resourceNumber</span>)</span> &#123; builder.AddInt(<span class="number">2</span>, resourceNumber, <span class="number">0</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Offset&lt;GameConfigFB&gt; <span class="title">EndGameConfigFB</span>(<span class="params">FlatBufferBuilder builder</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">int</span> o = builder.EndObject();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Offset&lt;GameConfigFB&gt;(o);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FinishGameConfigFBBuffer</span>(<span class="params">FlatBufferBuilder builder, Offset&lt;GameConfigFB&gt; offset</span>)</span> &#123; builder.Finish(offset.Value); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FinishSizePrefixedGameConfigFBBuffer</span>(<span class="params">FlatBufferBuilder builder, Offset&lt;GameConfigFB&gt; offset</span>)</span> &#123; builder.FinishSizePrefixed(offset.Value); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用FlatBufferBuilder(位于FlatBuff源码的&#x2F;net&#x2F;FlatBuffers目录下)根据schema生成代码序列化数据到二进制文件</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> FlatBuffers;</span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">FlatBufferStudy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> GameConfig数据全路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> GameConfigDataFullPath = <span class="string">&quot;./GameConfig.data&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 存储GameConfig数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SaveGameConfigData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Create a `FlatBufferBuilder`, which will be used to create our</span></span><br><span class="line">            <span class="comment">// GameConfigFB&#x27; FlatBuffers.</span></span><br><span class="line">            <span class="comment">// 定义FlatBufferBulder对象用于我们构建数据对象</span></span><br><span class="line">            <span class="keyword">var</span> builder = <span class="keyword">new</span> FlatBufferBuilder(<span class="number">4</span>);</span><br><span class="line">            <span class="keyword">var</span> difficultylevel = builder.CreateString(<span class="string">&quot;Hard-困难&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Use the `CreateGameConfigFB()` helper function to create the GameConfigFB, since we set every field.</span></span><br><span class="line">            <span class="comment">// 往GameConfigFB里填充数据</span></span><br><span class="line">            <span class="keyword">var</span> gameconfig = GameConfigFB.CreateGameConfigFB(builder, difficultylevel, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Call `Finish()` to instruct the builder that this GameConfigFB is complete.</span></span><br><span class="line">            <span class="comment">// 指定GameConfigFB数据构建完成</span></span><br><span class="line">            builder.Finish(gameconfig.Value);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This must be called after `Finish()`.</span></span><br><span class="line">            <span class="comment">// 包含GameConfigFB的二进制数据的数据对象</span></span><br><span class="line">            <span class="keyword">var</span> buf = builder.DataBuffer;</span><br><span class="line">            <span class="comment">// GameConfigFB的二进制数据</span></span><br><span class="line">            <span class="built_in">byte</span>[] bufbytes = builder.SizedByteArray();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//写入GameConfig二进制数据得到本地</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> filestream = <span class="keyword">new</span> FileStream(GameConfigDataFullPath, FileMode.Create))</span><br><span class="line">            &#123;</span><br><span class="line">                filestream.Write(bufbytes, <span class="number">0</span>, bufbytes.Length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 读取GameConfig数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ReadGameConfigData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//写入GameConfig二进制数据得到本地</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> filestream = <span class="keyword">new</span> FileStream(GameConfigDataFullPath, FileMode.Open))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] bufbytes = <span class="keyword">new</span> <span class="built_in">byte</span>[filestream.Length];</span><br><span class="line">                filestream.Read(bufbytes, <span class="number">0</span>, bufbytes.Length);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Get an accessor to the root object inside the buffer.</span></span><br><span class="line">                <span class="comment">// 通过字节流数据构建FlatBuff所需的Buf对象，然后使用该Buf对象通过FlatBuff构建GameConfigFB对象</span></span><br><span class="line">                <span class="keyword">var</span> buf = <span class="keyword">new</span> ByteBuffer(bufbytes);</span><br><span class="line">                <span class="keyword">var</span> gameconfig = GameConfigFB.GetRootAsGameConfigFB(buf);</span><br><span class="line"></span><br><span class="line">                Console.WriteLine(<span class="string">&quot;gameconfig.DifficultyLevel : &quot;</span> + gameconfig.DifficultyLevel);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;gameconfig.VersionNumber : &quot;</span> + gameconfig.VersionNumber);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;gameconfig.ResourceNumber : &quot;</span> + gameconfig.ResourceNumber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SaveGameConfigData();</span><br><span class="line"></span><br><span class="line">            ReadGameConfigData();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;结束!&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/FlatBuffGameConfigDataOutput.png" alt="FlatBuffGameConfigDataOutput"><br><img src="/img/Unity/Data-Config-Automation/FlatBuffOutput.png" alt="FlatBuffOutput"><br>可以看到我们成功通过FlatBuff序列化反序列化出了我们想要的数据。</p>
<p>通过上面的使用，可以看出FlatBuff在使用灵活度方面还是比较欠缺，对于数据的填充构建都是通过FlatBufferBuilder按指定填充方式构建数据并填充进去。</p>
<p>这里暂时没有对性能进行测试，具体性能对比参考前面给出过的对比图。</p>
<p>Note：<br>当我把FlatBuffer的.Net代码放进Unity时，我发现里面用到了C# 6.0的高阶语言特性，导致Unity里无法编译通过，所以上面的测试是脱离Unity基于.Net C#工程来测试的。</p>
<h5 id="深入探究"><a href="#深入探究" class="headerlink" title="深入探究"></a>深入探究</h5><p>这一步，让我们结合上面的学习用例来探究下FlatBuffer是如何实现高效的序列化和反序列化读取的。</p>
<p>通过学习了解FlatBuffer下面几个核心的类来理解学习:</p>
<ol>
<li>FlatBufferBuilder.cs(FlatBuffer构建填充数据的对外接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Responsible for building up and accessing a FlatBuffer formatted byte</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> array (via ByteBuffer).</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlatBufferBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _space;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer _bb;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _minAlign = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The vtable for the current table (if _vtableSize &gt;= 0)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] _vtable = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="comment">// The size of the vtable. -1 indicates no vtable</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _vtableSize = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// Starting offset of the current struct/table.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _objectStart;</span><br><span class="line">    <span class="comment">// List of offsets of all vtables.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] _vtables = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="comment">// Number of entries in `vtables` in use.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _numVtables = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// For the current vector being built.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _vectorNumElems = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Create a FlatBufferBuilder with a given initial size.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;initialSize&quot;&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The initial size to use for the internal buffer.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FlatBufferBuilder</span>(<span class="params"><span class="built_in">int</span> initialSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (initialSize &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">&quot;initialSize&quot;</span>,</span><br><span class="line">                initialSize, <span class="string">&quot;Must be greater than zero&quot;</span>);</span><br><span class="line">        _space = initialSize;</span><br><span class="line">        _bb = <span class="keyword">new</span> ByteBuffer(initialSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddInt</span>(<span class="params"><span class="built_in">int</span> o, <span class="built_in">int</span> x, <span class="built_in">int</span> d</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span> (ForceDefaults || x != d) </span><br><span class="line">        &#123; </span><br><span class="line">            AddInt(x); Slot(o); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>这里只截图了FlatBufferBuilder成员变量定义和部分函数定义。
</code></pre>
<ol start="2">
<li>ByteBuffer.cs(定义不同数据类型的byte数据分配以及填充，读取)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBuffer</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBufferAllocator _buffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _pos;  <span class="comment">// Must track start of the buffer.</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params">ByteBufferAllocator allocator, <span class="built_in">int</span> position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer = allocator;</span><br><span class="line">        _pos = position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="built_in">int</span> size</span>) : <span class="title">this</span>(<span class="params"><span class="keyword">new</span> <span class="built_in">byte</span>[size]</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="built_in">byte</span>[] buffer</span>) : <span class="title">this</span>(<span class="params">buffer, <span class="number">0</span></span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="built_in">int</span> pos</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer = <span class="keyword">new</span> ByteArrayAllocator(buffer);</span><br><span class="line">        _pos = pos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_buffer != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _buffer.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Position &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _pos; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; _pos = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Length &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> _buffer.Length; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Reset</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _pos = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Increases the size of the ByteBuffer, and copies the old data towards</span></span><br><span class="line">    <span class="comment">// the end of the new buffer.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="built_in">int</span> newSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer.GrowFront(newSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutStringUTF8</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        AssertOffsetAndLength(offset, <span class="keyword">value</span>.Length);</span><br><span class="line">        Encoding.UTF8.GetBytes(<span class="keyword">value</span>, <span class="number">0</span>, <span class="keyword">value</span>.Length,</span><br><span class="line">            _buffer.ByteArray, offset);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutInt</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        PutUint(offset, (<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteLittleEndian</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> count, <span class="built_in">ulong</span> data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (BitConverter.IsLittleEndian)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _buffer.Buffer[offset + i] = (<span class="built_in">byte</span>)(data &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _buffer.Buffer[offset + count - <span class="number">1</span> - i] = (<span class="built_in">byte</span>)(data &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ByteBufferAllocator.cs(抽象二进制byte数据的分配管理)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">ByteBufferAllocator</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNSAFE_BYTEBUFFER</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="built_in">byte</span>* Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">byte</span>[] Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Length</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="built_in">int</span> newSize</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !ENABLE_SPAN_T</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">byte</span>[] ByteArray &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Table.cs(抽象FlatBuffer自定义结构的数据存储以及读取)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> Table</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> bb_pos;</span><br><span class="line">    <span class="keyword">public</span> ByteBuffer bb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ByteBuffer ByteBuffer &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> bb; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据序列化存储部分：<br>可以看出我们所有的数据最终都被写入在一个一维的byte数组里，而Flatbuffer通过按指定方式往byte数组里填充数据实现对数据的序列化存储。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlatBufferBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer _bb;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBuffer</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBufferAllocator _buffer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutStringUTF8</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutInt</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        PutUint(offset, (<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteLittleEndian</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> count, <span class="built_in">ulong</span> data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteArrayAllocator</span> : <span class="title">ByteBufferAllocator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">byte</span>[] _buffer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="built_in">int</span> newSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer.GrowFront(newSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据反序列化读取部分；</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Table __p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ByteBuffer ByteBuffer </span><br><span class="line">    &#123; </span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> __p.bb; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">       <span class="keyword">return</span> GetRootAsGameConfigFB(_bb, <span class="keyword">new</span> GameConfigFB()); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb, GameConfigFB obj</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">return</span> (obj.__assign(_bb.GetInt(_bb.Position) + _bb.Position, _bb)); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> __init(<span class="built_in">int</span> _i, ByteBuffer _bb) </span><br><span class="line">    &#123; </span><br><span class="line">        __p.bb_pos = _i; __p.bb = _bb; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameConfigFB __assign(<span class="built_in">int</span> _i, ByteBuffer _bb) </span><br><span class="line">    &#123; </span><br><span class="line">        __init(_i, _bb); <span class="keyword">return</span> <span class="keyword">this</span>; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DifficultyLevel </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">4</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.__string(o + __p.bb_pos) : <span class="literal">null</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到当我们通过以下代码读取二进制数据构建我们自定义的GameConfigFB对象时,我们已经把二进制数据按FlatBuffer存储的方式读取进来:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> ByteBuffer(bufbytes);</span><br><span class="line"><span class="keyword">var</span> gameconfig = GameConfigFB.GetRootAsGameConfigFB(buf);</span><br></pre></td></tr></table></figure>

<p>然后通过Table按自定义的数据结构读取指定的偏移把数据成功读取出来(这应该也是为什么FlatBuffer反序列化读取能这么高效的原因):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> ArraySegment&lt;<span class="built_in">byte</span>&gt;? GetDifficultyLevelBytes() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">return</span> __p.__vector_as_arraysegment(<span class="number">4</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> VersionNumber </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">6</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ResourceNumber </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">8</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里放一张其他博客上给出的一张FlatBuffer数据存储图解加深印象，<a target="_blank" rel="noopener" href="https://www.race604.com/flatbuffers-intro/">下图来源</a>:<br><img src="/img/Unity/Data-Config-Automation/FlatBufferBytesStructure.png" alt="FlatBufferBytesStructure"></p>
<h4 id="Xbuffer"><a href="#Xbuffer" class="headerlink" title="Xbuffer"></a>Xbuffer</h4><p>公司一前同事写的基于C#的简化版的Flatbuffer。<br>这里重复再放一次前面放过的性能对比图：<br><img src="/img/Unity/Data-Config-Automation/SerializationPerformanceComparision.png" alt="SerializationPerformanceComparision"><br>可以看到Xbuffer序列化和反序列化性能也相当优秀。</p>
<p>接下来我们通过实战使用和深入探究来学习其中的奥妙。</p>
<h5 id="实战使用-1"><a href="#实战使用-1" class="headerlink" title="实战使用"></a>实战使用</h5><p>使用流程：</p>
<ol>
<li>定义数据结构文件<br>GameConfigXB.xb</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 游戏版本信息</span><br><span class="line">class GameConfigXB</span><br><span class="line">&#123;</span><br><span class="line">    difficultyLevel:string;             // 游戏难度</span><br><span class="line">    versionNumber:int;                  // 游戏版本号</span><br><span class="line">    resourceNumber:int;                 // 游戏资源版本号</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用xbuffer_parser.exe根据模板文件解析数据结构文件生成对应类文件以及对应类Xbuffer序列化反序列化所需的代码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xbuffer_parser.exe input=GameConfigXB.xb template=&quot;templates/csharp_class.ftl&quot; output_dir=&quot;output/csharp/csharp_class/&quot; suffix=&quot;.cs&quot;</span><br><span class="line">xbuffer_parser.exe input=GameConfigXB.xb template=&quot;templates/csharp_buffer.ftl&quot; output_dir=&quot;output/csharp/csharp_buffer/&quot; suffix=&quot;Buffer.cs&quot;</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>

<p>GameConfigXB.cs(对应数据结构文件)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 游戏版本信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GameConfigXB</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> difficultyLevel;              <span class="comment">// 游戏难度</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> versionNumber;               <span class="comment">// 游戏版本号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> resourceNumber;              <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameConfigXBBuffer.cs(对应数据结构Xbuffer序列化反序列化所需文件)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GameConfigXBBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigXB <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">int</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="built_in">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> _difficultyLevel = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            <span class="built_in">int</span> _versionNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            <span class="built_in">int</span> _resourceNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GameConfigXB() &#123;</span><br><span class="line">                difficultyLevel = _difficultyLevel,</span><br><span class="line"></span><br><span class="line">                versionNumber = _versionNumber,</span><br><span class="line"></span><br><span class="line">                resourceNumber = _resourceNumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">GameConfigXB <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="literal">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.difficultyLevel, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.versionNumber, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.resourceNumber, steam);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面生成默认的模板生成的GameConfigXBBuffer.cs貌似跟源码测试使用的接口对不上，需要把模板改成如下:<br>charp_buffer.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">namespace xbuffer</span><br><span class="line">&#123;</span><br><span class="line">    public static class #CLASS_NAME#Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        public static #CLASS_NAME# deserialize(byte[] buffer, ref uint offset)</span><br><span class="line">        &#123;</span><br><span class="line">#IF_DESERIALIZE_CLASS#</span><br><span class="line">            // null</span><br><span class="line">            bool _null = boolBuffer.deserialize(buffer, ref offset);</span><br><span class="line">            if (_null) return null;</span><br><span class="line">#END_DESERIALIZE_CLASS#</span><br><span class="line">#DESERIALIZE_PROCESS#</span><br><span class="line">            // #VAR_NAME#</span><br><span class="line">#IF_SINGLE#</span><br><span class="line">            #VAR_TYPE# _#VAR_NAME# = #VAR_TYPE#Buffer.deserialize(buffer, ref offset);</span><br><span class="line">#END_SINGLE#</span><br><span class="line">#IF_ARRAY#</span><br><span class="line">            int _#VAR_NAME#_length = intBuffer.deserialize(buffer, ref offset);</span><br><span class="line">            #VAR_TYPE#[] _#VAR_NAME# = new #VAR_TYPE#[_#VAR_NAME#_length];</span><br><span class="line">            for (int i = 0; i &lt; _#VAR_NAME#_length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _#VAR_NAME#[i] = #VAR_TYPE#Buffer.deserialize(buffer, ref offset);</span><br><span class="line">            &#125;</span><br><span class="line">#END_ARRAY#</span><br><span class="line">#DESERIALIZE_PROCESS#</span><br><span class="line"></span><br><span class="line">            // value</span><br><span class="line">            return new #CLASS_NAME#() &#123;</span><br><span class="line">#DESERIALIZE_RETURN#</span><br><span class="line">                #VAR_NAME# = _#VAR_NAME#,</span><br><span class="line">#DESERIALIZE_RETURN#</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static void serialize(#CLASS_NAME# value, XSteam steam)</span><br><span class="line">        &#123;</span><br><span class="line">#IF_SERIALIZE_CLASS#</span><br><span class="line">            // null</span><br><span class="line">            boolBuffer.serialize(value == null, steam);</span><br><span class="line">            if (value == null) return;</span><br><span class="line">#END_SERIALIZE_CLASS#</span><br><span class="line">#SERIALIZE_PROCESS#</span><br><span class="line">            // #VAR_NAME#</span><br><span class="line">#IF_SINGLE#</span><br><span class="line">            #VAR_TYPE#Buffer.serialize(value.#VAR_NAME#, steam);</span><br><span class="line">#END_SINGLE#</span><br><span class="line">#IF_ARRAY#</span><br><span class="line">            intBuffer.serialize(value.#VAR_NAME#.Length, steam);</span><br><span class="line">            for (int i = 0; i &lt; value.#VAR_NAME#.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                #VAR_TYPE#Buffer.serialize(value.#VAR_NAME#[i], steam);</span><br><span class="line">            &#125;</span><br><span class="line">#END_ARRAY#</span><br><span class="line">#SERIALIZE_PROCESS#</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>把Xbuffer核心代码xbuffer_runtime.dll放到项目目录下。</li>
<li>使用Xbuffer生成的对应Buffer类序列化和反序列化数据</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 快速访问UI组件测试挂在脚本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIDebugMonoScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Xbuffer内存存储抽象对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> XSteam mXbufferStream;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCreateGameConfigClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onCreateGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.XbufferDataFolderPath : &quot;</span> + PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        PathUtilities.checkAndCreateFolder(PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        <span class="comment">//固定一个内存分配，把数据往这里面填充，不够的画动态扩展</span></span><br><span class="line">        mXbufferStream = <span class="keyword">new</span> XSteam(<span class="number">1</span>, <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1000</span>);</span><br><span class="line">        GameConfigXB gameconfigxb = <span class="keyword">new</span> GameConfigXB();</span><br><span class="line">        gameconfigxb.difficultyLevel = <span class="string">&quot;Hard&quot;</span>;</span><br><span class="line">        gameconfigxb.versionNumber = <span class="number">1</span>;</span><br><span class="line">        gameconfigxb.resourceNumber = <span class="number">1</span>;</span><br><span class="line">        GameConfigXBBuffer.serialize(gameconfigxb, mXbufferStream);</span><br><span class="line">        <span class="keyword">var</span> bytes = mXbufferStream.getBytes();</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> output = File.Create(PathUtilities.XbufferDataFolderPath + <span class="string">&quot;GameConfigXB.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            output.Write(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onReadGameConfigClick</span>()</span> </span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onReadGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.XbufferDataFolderPath : &quot;</span> + PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.XbufferDataFolderPath + <span class="string">&quot;GameConfigXB.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[intput.Length];</span><br><span class="line">            intput.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">            <span class="built_in">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">var</span> gameconfig = GameConfigXBBuffer.deserialize(bytes, <span class="keyword">ref</span> offset);</span><br><span class="line">            Debug.Log(<span class="string">&quot;gameconfig.difficultyLevel : &quot;</span> + gameconfig.difficultyLevel);</span><br><span class="line">            Debug.Log(<span class="string">&quot;gameconfig.versionNumber : &quot;</span> + gameconfig.versionNumber);</span><br><span class="line">            Debug.Log(<span class="string">&quot;gameconfig.resourceNumber : &quot;</span> + gameconfig.resourceNumber);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/XbufferData.png" alt="XbufferData"><br><img src="/img/Unity/Data-Config-Automation/XbufferOutput.png" alt="XbufferOutput"><br>可以看到我们成功通过Xbuffer序列化反序列了数据。</p>
<h5 id="深入探究-1"><a href="#深入探究-1" class="headerlink" title="深入探究"></a>深入探究</h5><p>接下来结合源码，让我们深入Xbuffer内部去看看是如何实现高效的序列化和反序列以及挂镀可配置的。<br>Xbuffer提供了一下两个核心的部件：</p>
<ol>
<li>xbuffe_parser.exe</li>
<li>xbuffer_runtime.dll</li>
</ol>
<h6 id="xbuffer-parser"><a href="#xbuffer-parser" class="headerlink" title="xbuffer_parser"></a>xbuffer_parser</h6><p>xbuffer_parser负责根据模板自动化生成对应类以及Xbuffer序列化反序列化所需文件代码。</p>
<ol>
<li>Config.cs(负责参数的检查 – 这个就不详细介绍了)</li>
<li>Proto.cs(抽象数据结构文件的各个组成部分)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               Proto.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             原型语法解析工具</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2017/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Proto_Class[] class_protos;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto</span>(<span class="params"><span class="built_in">string</span> proto</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> matchs = Regex.Matches(proto, <span class="string">@&quot;//\s*(\S*)\s*((class)|(struct))\s*(\w+)\s*&#123;\s*((\w+):([\[|\]|\w]+);\s*//\s*(\S*)\s*)*&#125;&quot;</span>);</span><br><span class="line">            class_protos = <span class="keyword">new</span> Proto_Class[matchs.Count];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; matchs.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                class_protos[i] = <span class="keyword">new</span> Proto_Class(matchs[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 变量结构</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto_Variable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Var_Type;                             <span class="comment">// 变量类型</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Var_Name;                             <span class="comment">// 变量名</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> IsArray;                                <span class="comment">// 是否是数组</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Var_Comment;                          <span class="comment">// 变量注释</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto_Variable</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">string</span> type, <span class="built_in">string</span> comment</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Var_Name = name;</span><br><span class="line">            <span class="keyword">if</span> (type.Contains(<span class="string">&quot;[&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                Var_Type = type.Substring(<span class="number">1</span>, type.Length - <span class="number">2</span>);</span><br><span class="line">                IsArray = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Var_Type = type;</span><br><span class="line">                IsArray = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Var_Comment = comment;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 类结构</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto_Class</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Class_Comment;                            <span class="comment">// 注释</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Class_Type;                               <span class="comment">// 类型 例如 class struct</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Class_Name;                               <span class="comment">// 类名</span></span><br><span class="line">        <span class="keyword">public</span> Proto_Variable[] Class_Variables;                <span class="comment">// 变量列表</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto_Class</span>(<span class="params">Match match</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Class_Comment = match.Groups[<span class="number">1</span>].Value;</span><br><span class="line">            Class_Type = match.Groups[<span class="number">2</span>].Value;</span><br><span class="line">            Class_Name = match.Groups[<span class="number">5</span>].Value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> varNames = match.Groups[<span class="number">7</span>].Captures;</span><br><span class="line">            <span class="keyword">var</span> varTypes = match.Groups[<span class="number">8</span>].Captures;</span><br><span class="line">            <span class="keyword">var</span> varComments = match.Groups[<span class="number">9</span>].Captures;</span><br><span class="line">            Class_Variables = <span class="keyword">new</span> Proto_Variable[varNames.Count];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Class_Variables.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Class_Variables[i] = <span class="keyword">new</span> Proto_Variable(varNames[i].Value, varTypes[i].Value, varComments[i].Value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>核心思想是通过正则匹配文本内容后，分别将对应内容填充到抽象的Proto类对象里。
</code></pre>
<ol start="3">
<li>Parser.cs(负责将抽象后的数据结构数据结合模板文件转换成对应代码) &amp; Xtemplate.cs(负责模板与代码生成部分的逻辑处理)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               Parser.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             将类对象转化成代码文本</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2017/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Parser</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将类对象转化成代码文本</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;proto_class&quot;&gt;</span>类结构<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;template_str&quot;&gt;</span>模板文本<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">parse</span>(<span class="params">Proto_Class proto_class, <span class="built_in">string</span> template_str, <span class="built_in">bool</span> showHead</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> template = <span class="keyword">new</span> XTemplate(template_str);</span><br><span class="line"></span><br><span class="line">            template.setCondition(<span class="string">&quot;HEAD&quot;</span>, showHead);</span><br><span class="line">            template.setValue(<span class="string">&quot;#CLASS_TYPE#&quot;</span>, proto_class.Class_Type);</span><br><span class="line">            template.setValue(<span class="string">&quot;#CLASS_NAME#&quot;</span>, proto_class.Class_Name);</span><br><span class="line">            template.setValue(<span class="string">&quot;#CLASS_COMMENT#&quot;</span>, proto_class.Class_Comment);</span><br><span class="line"></span><br><span class="line">            template.setCondition(<span class="string">&quot;DESERIALIZE_CLASS&quot;</span>, proto_class.Class_Type == <span class="string">&quot;class&quot;</span>);</span><br><span class="line">            template.setCondition(<span class="string">&quot;SERIALIZE_CLASS&quot;</span>, proto_class.Class_Type == <span class="string">&quot;class&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#VARIABLES#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">&quot;SINGLE&quot;</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">&quot;ARRAY&quot;</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#DESERIALIZE_PROCESS#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">&quot;SINGLE&quot;</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">&quot;ARRAY&quot;</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#DESERIALIZE_RETURN#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#SERIALIZE_PROCESS#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">&quot;SINGLE&quot;</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">&quot;ARRAY&quot;</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> template.getContent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>核心依然是通过正则匹配替换模板文本内容。
</code></pre>
<p>上面几个文件就是解析模板文件以及根据数据结构定义文件生成对应Xbuffer所需代码的核心逻辑。可以看到模板的高自由度配置，让Xbuffer具备了对多语言的快速支持以及灵活配置的能力。</p>
<h6 id="xbuffer-runtime"><a href="#xbuffer-runtime" class="headerlink" title="xbuffer_runtime"></a>xbuffer_runtime</h6><p>xbuffer_runtime.dll是xbuffer对数据进行序列化和反序列化的核心类。</p>
<ol>
<li>XSteam.cs(Xbuffer核心字节流序列化反序列化的关键类)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               XSteam.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             一个简单的内存流实现 用于精准的控制内存管理</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/04/09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XSteam</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> index_group;            <span class="comment">// 当前组别序号 行</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> index_cell;             <span class="comment">// 当前单元序号 列</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> capacity_group;         <span class="comment">// 行的数量</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> capacity_cell;          <span class="comment">// 列的数量</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">byte</span>[][] contents;           <span class="comment">// 内容列表</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span>[] wastes;               <span class="comment">// 浪费列表 对应每一行</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">XSteam</span>(<span class="params"><span class="built_in">uint</span> capacity_group, <span class="built_in">uint</span> capacity_cell</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.capacity_group = capacity_group;</span><br><span class="line">            <span class="keyword">this</span>.capacity_cell = capacity_cell;</span><br><span class="line"></span><br><span class="line">            contents = <span class="keyword">new</span> <span class="built_in">byte</span>[capacity_group][];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; capacity_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                contents[i] = <span class="keyword">new</span> <span class="built_in">byte</span>[capacity_cell];</span><br><span class="line">            &#125;</span><br><span class="line">            wastes = <span class="keyword">new</span> <span class="built_in">uint</span>[capacity_group];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 申请空间</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 基本策略是不够了就申请一倍</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;size&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applySize</span>(<span class="params"><span class="built_in">uint</span> size</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (index_cell + size &gt; capacity_cell)</span><br><span class="line">            &#123;</span><br><span class="line">                wastes[index_group] = capacity_cell - index_cell;</span><br><span class="line">                index_cell = <span class="number">0</span>;</span><br><span class="line">                index_group++;</span><br><span class="line">                <span class="keyword">if</span> (index_group &gt;= capacity_group)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> nCapacity_Group = capacity_group + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> nContents = <span class="keyword">new</span> <span class="built_in">byte</span>[nCapacity_Group][];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">uint</span> i = <span class="number">0</span>; i &lt; nCapacity_Group; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (i &lt; capacity_group)</span><br><span class="line">                            nContents[i] = contents[i];</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            nContents[i] = <span class="keyword">new</span> <span class="built_in">byte</span>[capacity_cell];</span><br><span class="line">                    &#125;</span><br><span class="line">                    contents = nContents;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> nWastes = <span class="keyword">new</span> <span class="built_in">uint</span>[nCapacity_Group];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">uint</span> i = <span class="number">0</span>; i &lt; capacity_group; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nWastes[i] = wastes[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    wastes = nWastes;</span><br><span class="line"></span><br><span class="line">                    capacity_group = nCapacity_Group;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回输出字节流</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">getBytes</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> len = index_group * capacity_cell + index_cell;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; index_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                len -= wastes[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">byte</span>[len];</span><br><span class="line">            <span class="keyword">var</span> idx = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; index_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; capacity_cell - wastes[i]; j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    ret[idx++] = contents[i][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; index_cell; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                ret[idx++] = contents[index_group][i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>从上面源码可以看出，Xbuffer是采用了一个二维的byte数组来存储原始数据的(*实现固定内存大小的数据分配*)。空间容量不够的时候在扩容处理，这一点和Flatbuffer是类似的(Flatbuffer貌似是个一维数组)。当现有定义的空间不足时，Xbuffer采取的是翻倍处理(数据存储上是采用扩展二维数组的第二维度实现扩容)。这里可以想成，

举个例子，一开始是byte[1][1024]的byte数组容量。当不够的时候，会扩展成byte[2][1024]的容量，然后从byte[2][]开始填充新的数据，而byte[1][]里未填充完的部分，就当做浪费的部分不再使用。

*但最后返回Xstream的byte数据时，是返回的一个一维byte数组，并且是剔除了wast部分的byte分配，详情见Xstream的getBytes方法*
</code></pre>
<ol start="2">
<li>boolBuffer.cs &amp; byteBuffer.cs &amp; floatBuffer.cs &amp; intBuffer.cs &amp; longBuffer.cs &amp; stringBuffer.cs &amp; uintBuffer.cs(负责对各数据类型的数据序列化写入和反序列化读取进行实现)<br>下面以intBuffer.cs为例:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               intBuffer.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             基本类型处理</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2017/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">intBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">uint</span> size = <span class="keyword">sizeof</span>(<span class="built_in">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr = buffer)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> <span class="keyword">value</span> = *(<span class="built_in">int</span>*)(ptr + offset);</span><br><span class="line">                offset += size;</span><br><span class="line">                <span class="keyword">return</span> BitConverter.IsLittleEndian ? <span class="keyword">value</span> : (<span class="built_in">int</span>)utils.toLittleEndian((<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            steam.applySize(size);</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr = steam.contents[steam.index_group])</span><br><span class="line">            &#123;</span><br><span class="line">                *(<span class="built_in">int</span>*)(ptr + steam.index_cell) = BitConverter.IsLittleEndian ? <span class="keyword">value</span> : (<span class="built_in">int</span>)utils.toLittleEndian((<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">                steam.index_cell += size;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>从上面可以看出，底层的数据写入是根据数据类型大小，通过fixed使用非托管的内存分配方式进行指定内存位置指定数据byte的写入和读取。

举个例子，一开始分配了byte[1][1024*1024]也就是1M的内存，当我们写入一个int数据时，因为int类型的byte大小是4bytes也就是32bits，也就是说byte[1][0] - byte[1][4]的内存数据时用于存储这个int的值。其他类型同理。
</code></pre>
<ol start="3">
<li>utils.cs(负责一些细节处理，比如大小端问题，这里就不放源码了)</li>
<li>Serializer.cs(提供模板化的序列化反序列化读取加载接口)</li>
<li>***Buffer.cs(自动化生成的序列化反序列化所需的类代码)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GameConfigXBBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigXB <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="built_in">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            <span class="built_in">string</span> _difficultyLevel = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);            </span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            <span class="built_in">int</span> _versionNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            <span class="built_in">int</span> _resourceNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GameConfigXB()</span><br><span class="line">            &#123;</span><br><span class="line">                difficultyLevel = _difficultyLevel,</span><br><span class="line"></span><br><span class="line">                versionNumber = _versionNumber,</span><br><span class="line"></span><br><span class="line">                resourceNumber = _resourceNumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">GameConfigXB <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="literal">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.difficultyLevel, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.versionNumber, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.resourceNumber, steam);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>从上面可以看到，根据数据结构定义文件生成对应的序列化和反序列化代码核心是通过各成员数据按循序依次以各自类型的写入方式将数据写入XStream里。
反序列化时同理依次从byte数据里读取出来。
不难看出，数据存储确实和Flatbuffer类似，存储在一个固定的内存byte[]数组里，只不过是一维和二维数组的区别(*但实际上最后返回Xstream的byte数据时，是剔除了wast部分的一个一维的byte数组*)。数据序列化和反序列化都是读取指定内存位置按指定数据类型读取出来即可，这应该就是Xbuffer和Flatbuffer序列化和反序列化高效的原因吧。
</code></pre>
<h3 id="方案比较-1"><a href="#方案比较-1" class="headerlink" title="方案比较"></a>方案比较</h3><p>不同的序列化反序列化库的优劣比较:</p>
<ol>
<li>自定义数据填充和读取<br>优点：</li>
</ol>
<ul>
<li>实现简单<br>缺点:</li>
<li>序列化和反序列化速度慢，内存开销大</li>
<li>不适合数据量大和频繁使用的情况</li>
</ul>
<p><em>适用于数据量不大且不需要跨语言的情况，不适合对性能要求高的场合。</em></p>
<ol start="2">
<li>ProtoBuff<br>优点：</li>
</ol>
<ul>
<li>序列化和反序列化速度和内存开销都很不错</li>
<li>数据定义向后兼容</li>
<li>高度自定义配置数据结构(proto文件)</li>
<li>数据序列化反序列化代码简介，接口简单</li>
<li>社区强大<br>缺点:</li>
<li>相比FlatBuffer和Xbuffer速度和内存开销上不占优势</li>
</ul>
<p><em>很适合作为网络数据传输方案(向后兼容)。</em></p>
<ol start="3">
<li>FlatBuff<br>优点：</li>
</ol>
<ul>
<li>序列化和反序列化速度快，内存开销小</li>
<li>支持自定义配置数据结构(schema文件)<br>缺点:</li>
<li>序列化反序列化代码编写过于面向内存结构，不符合平时面向对象的编写风格，编写复杂(这一层被Xbuffer封装成自动化生成***Buffer.cs的代码类)</li>
</ul>
<ol start="4">
<li>XBuffer<br>优点:</li>
</ol>
<ul>
<li>序列化和反序列化速度快，内存开销小</li>
<li>高度自由配置(基于模板配置且自定义配置文件配置)</li>
<li>接口简单方便使用，支持泛型和非泛型序列化反序列化</li>
<li>根据需求可以快速修改来符合自身需求(比如要做导表工具，只需在上层再封一层即可)<br>缺点:</li>
<li>向后不兼容(因为数据是严格按照数据结构按顺序读取的，所以当已经存储进数据库的数据，在扩展字段内容后是无法正常反序列化读取出来的)</li>
</ul>
<p><em>不适合作为网络序列化数据方案，更适合表格数据序列化反序列化方案。</em></p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="方案选择"><a href="#方案选择" class="headerlink" title="方案选择"></a>方案选择</h3><p>学习了解了那么多序列化和反序列化的库，根据我现有的需求是制作一个导表工具(速度和内存开销以及配置灵活度都要求比较高)来看，个人认为基于Xbuffer来编写是比较适合的一种方案。</p>
<p>原因如下:</p>
<ol>
<li>速度快</li>
<li>内存开销小</li>
<li>高度可配置</li>
</ol>
<h3 id="基于Xbuffer的导表工具"><a href="#基于Xbuffer的导表工具" class="headerlink" title="基于Xbuffer的导表工具"></a>基于Xbuffer的导表工具</h3><p>流程：</p>
<ol>
<li>定义导表工具基础功能需求</li>
<li>XML配置导表相关路径数据(比如表格路径配置，输出目录配置等)</li>
<li>定义excel表格格式规则</li>
<li>读取excel数据(Window可以使用ExcelRead库)</li>
<li>创建excel对应Xbuffer数据结构文件(这一步需要自己去写)</li>
<li>使用Xbuffer_parser解析新生成的数据结构文件，生成所需类文件以及序列化相关文件(使用Xbuffer_parser解析即可)</li>
<li>使用生成的代码序列化excel数据到二进制数据流(这一步需要自己去写)</li>
<li>封装一层表格数据读取快速读取管理类，负责统一管理表格数据的加载和读取(这一步需要自己去写)</li>
<li>通过统一管理类使用Xbuffer去加载读取序列化的二进制数据(结合自身代码，使用Xbuffer_runtime.dll里的核心代码去反序列化)</li>
</ol>
<p>相关语言及工具：<br>C#(Unity客户端使用的语言)<br>Xbuffer(第三方序列化反序列化库)</p>
<p>接下将来针对每一步的实现进行实战学习。</p>
<h4 id="导表功能需求"><a href="#导表功能需求" class="headerlink" title="导表功能需求"></a>导表功能需求</h4><ol>
<li>支持int，float，long, string, bool基础数据配置</li>
<li>支持一维和多维数据配置(进阶功能，理论上，对于xbuffer而言，数组的维度扩展就能支持多维数据)</li>
<li>自动生成表格数据以及表格读取相关代码</li>
<li>工具独立于Unity存在使用</li>
<li>支持跨语言(xbuffer理论上通过模板生成不同语言版本的相关代码即可)</li>
<li>支持XML配置相关工具配置(比如表格路径配置，输出目录配置等。)</li>
</ol>
<h4 id="支持导表路径配置"><a href="#支持导表路径配置" class="headerlink" title="支持导表路径配置"></a>支持导表路径配置</h4><p>因为工具是独立于Unity所以不受Unity .Net版本的限制，这里决定使用.Net自身的XML解析库System.XML。</p>
<p>ExportConfig.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">ExportConfig</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">ExcelInputPath</span>&gt;</span>./Excels/<span class="tag">&lt;/<span class="name">ExcelInputPath</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">TemplatePath</span>&gt;</span>./Templates/<span class="tag">&lt;/<span class="name">TemplatePath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">DesFileOutputPath</span>&gt;</span>./DesFiles/<span class="tag">&lt;/<span class="name">DesFileOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">ByteDataOutputPath</span>&gt;</span>./../Assets/Resources/DataBytes/<span class="tag">&lt;/<span class="name">ByteDataOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">CSClassCodeOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSOutput/ClassCode/<span class="tag">&lt;/<span class="name">CSClassCodeOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">CSBufferCodeOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSOutput/BufferCode/<span class="tag">&lt;/<span class="name">CSBufferCodeOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">CSTemplateOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSTemplateOutput/<span class="tag">&lt;/<span class="name">CSTemplateOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">OtherLanguageCodeOutputPath</span>&gt;</span>./OtherOutput/<span class="tag">&lt;/<span class="name">OtherLanguageCodeOutputPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ExportConfig</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ExportConfig.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             导表工具导出配置数据抽象</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">XbufferExcelToData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExportConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 表格数据路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ExcelInputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Xbuffer模板路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> TemplatePath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 序列化数据输出路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ByteDataOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> CS代码输出路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> CSCodeOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 其他语言代码输出路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> OtherLanguageCodeOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打印所有信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printOutAllInfo</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;ExcelInputPath : &#123;0&#125;&quot;</span>, ExcelInputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;TemplatePath : &#123;0&#125;&quot;</span>, TemplatePath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;DesFileOutputPath : &#123;0&#125;&quot;</span>, DesFileOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;ByteDataOutputPath : &#123;0&#125;&quot;</span>, ByteDataOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;CSCodeOutputPath : &#123;0&#125;&quot;</span>, CSCodeOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;OtherLanguageCodeOutputPath : &#123;0&#125;&quot;</span>, OtherLanguageCodeOutputPath));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>XbufferExcelToDataConfig.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             导表工具相关配置单例类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> System.Xml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">XbufferExcelToData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 导表工具相关配置单例类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XbufferExcelToDataConfig</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">XbufferExcelToDataConfig</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> XML配置文件全路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> XMLConfigFileFullPath &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 导出配置数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> ExportConfig ExportConfigInfo &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">XbufferExcelToDataConfig</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            XMLConfigFileFullPath = <span class="string">&quot;./ExportConfig.xml&quot;</span>;</span><br><span class="line">            ExportConfigInfo = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 加载导出配置数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">LoadExportConfigData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(File.Exists(XMLConfigFileFullPath))</span><br><span class="line">            &#123;</span><br><span class="line">                XmlDocument xmldoc = <span class="keyword">new</span> XmlDocument();</span><br><span class="line">                xmldoc.Load(XMLConfigFileFullPath);</span><br><span class="line">                <span class="keyword">var</span> rootnode = xmldoc.DocumentElement;</span><br><span class="line">                <span class="keyword">var</span> rootnodename = rootnode.Name;</span><br><span class="line">                <span class="keyword">var</span> reflecttype = <span class="keyword">this</span>.GetType().Assembly.GetType(<span class="string">&quot;XbufferExcelToData.&quot;</span> + rootnodename);</span><br><span class="line">                <span class="keyword">if</span>(reflecttype ==  <span class="keyword">typeof</span>(ExportConfig))</span><br><span class="line">                &#123;</span><br><span class="line">                    ExportConfigInfo = <span class="keyword">new</span> ExportConfig();</span><br><span class="line">                    <span class="keyword">var</span> childnodes = rootnode.ChildNodes;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>, length = childnodes.Count; i &lt; length; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> property = ExportConfigInfo.GetType().GetProperty(childnodes[i].Name);</span><br><span class="line">                        <span class="keyword">if</span>(property != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            property.SetValue(ExportConfigInfo, childnodes[i].InnerText);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;不支持的属性配置 : &#123;0&#125;&quot;</span>, childnodes[i].Name));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;                    </span><br><span class="line">                    ExportConfigInfo.printOutAllInfo();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;找不到配置的类型数据信息 : &#123;0&#125;&quot;</span>, rootnodename));</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;当前只支持ExportConfig类型信息配置&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;导出配置文件不存在 : &#123;0&#125;&quot;</span>, XMLConfigFileFullPath));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/LoadXMLConfig.png" alt="LoadXMLConfig"><br>可以看到我们成功的读取了XML里配置的信息(后续的导表工具会用到)。</p>
<h4 id="定义表格规则"><a href="#定义表格规则" class="headerlink" title="定义表格规则"></a>定义表格规则</h4><ol>
<li>第一行定义字段</li>
<li>第二行写字段注释</li>
<li>第三行定义字段类型</li>
<li>第四行表示分割符(只对一维数组类型有用)</li>
<li>第五和第六行保留为未来扩展使用</li>
<li>第七行及以后正式填写数据(数据不填采用对应类型的默认值，比如int为0，bool为false，int[]为null)</li>
</ol>
<h4 id="读取excel数据"><a href="#读取excel数据" class="headerlink" title="读取excel数据"></a>读取excel数据</h4><p>Windows PC端决定使用ExcelRead库来解决excel读取问题。</p>
<p>核心代码是下面两个文件：<br>ExcelDataManager.cs<br>ExcelData.cs</p>
<p>考虑到博客暂时不支持代码折叠，这里就不直接放源代码了，整个工程源代码会在博客最后给出链接。<br>主要实现了以下功能：</p>
<ol>
<li>按表格规则解析</li>
<li>检查表格配置是否正确(1. 不允许同名excel sheet 2. 字段名不允许重复 3. 支持的数据类型检查 4. id第一列必须为int类型且不允许不填且同一个表格id不能重复 5. 支持的分隔符检查配置)</li>
</ol>
<p>这里直接验证下读取Excel数据的结果:<br><img src="/img/Unity/Data-Config-Automation/ExcelDatOutput.png" alt="ExcelDatOutput"></p>
<h4 id="创建对应数据结构文件"><a href="#创建对应数据结构文件" class="headerlink" title="创建对应数据结构文件"></a>创建对应数据结构文件</h4><p>这一步，我们需要自动化生成Xbuffer用于自动化生成相关序列化代码的数据结构定义文件。</p>
<p>还记的我们前面学习Xbuffer时定义的GameConfigXB.xb吗?<br>GameConfigXB.xb</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 游戏版本信息</span></span><br><span class="line"><span class="keyword">class</span> <span class="title">GameConfigXB</span></span><br><span class="line">&#123;</span><br><span class="line">    difficultyLevel:<span class="built_in">string</span>;             <span class="comment">// 游戏难度</span></span><br><span class="line">    versionNumber:<span class="built_in">int</span>;                  <span class="comment">// 游戏版本号</span></span><br><span class="line">    resourceNumber:<span class="built_in">int</span>;                 <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们现在的目标就是将我们的Excel定义的数据内容转换成对应的数据结构定义文件。</p>
<p>实现方案思考：<br>数据结构定义文件不需要考虑跨平台，真正跨平台的实现是在序列化模板文件那一步完成的，所以这里打算简单的通过字节流形式按顺序文本写入即可。</p>
<p>代码很简单，就是利用之前存储的表格数据信息，一次写入字符串信息，最后通过文件流写入文件，这里就不放源代码了。</p>
<p>核心类是:<br>XbufferExcelToDesFile.cs</p>
<p>直接来看下最终生成的结果:<br>t_AuthorInfo.xb</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t_AuthorInfo的注释</span></span><br><span class="line"><span class="keyword">class</span> <span class="title">t_AuthorInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    id:<span class="built_in">int</span>;                                      <span class="comment">//唯一id</span></span><br><span class="line">    author:<span class="built_in">string</span>;                                <span class="comment">//作者</span></span><br><span class="line">    age:<span class="built_in">int</span>;                                        <span class="comment">//年龄</span></span><br><span class="line">    money:<span class="built_in">float</span>;                                    <span class="comment">//拥有金钱</span></span><br><span class="line">    hashouse:<span class="built_in">bool</span>;                                <span class="comment">//拥有房子</span></span><br><span class="line">    pbutctime:<span class="built_in">long</span>;                              <span class="comment">//出版utc时间</span></span><br><span class="line">    luckynumber:[<span class="built_in">int</span>];                            <span class="comment">//幸运数字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一步，我们成功自动化生成了Xbuffer需要的Excel对应的数据结构定义文件。</p>
<h4 id="生成序列化所需文件"><a href="#生成序列化所需文件" class="headerlink" title="生成序列化所需文件"></a>生成序列化所需文件</h4><p>为了便于修改Xbuffer满足我们新的需求，这里直接把Xbuffer的两个核心工程(xbuffer_parser &amp; xbuffer_runtime)集成到我们的导表工具里来：<br><img src="/img/Unity/Data-Config-Automation/IntegrateXbuffer.png" alt="IntegrateXbuffer"></p>
<p>然后修改Xbuffer两个核心工程的输出路径和我们主工程一致(便于主工程使用):<br><img src="/img/Unity/Data-Config-Automation/ModifyXbufferOutputPath.png" alt="ModifyXbufferOutputPath"></p>
<p>然后编译出两个工程各自的核心文件:<br><img src="/img/Unity/Data-Config-Automation/CompileXbufferCSProjects.png" alt="CompileXbufferCSProjects"></p>
<p>为了不修改原有Xbuffer的使用方式，这里采用通过跨程序调用exe的方式来使用Xbuffer。<br>核心类是:<br>XbufferDesFileToCSCode.cs</p>
<p>成功生成序列化相关代码:<br>t_AuthorInfoBuffer.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">t_AuthorInfoBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> t_AuthorInfo <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="built_in">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// id</span></span><br><span class="line">            <span class="built_in">int</span> _id = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// author</span></span><br><span class="line">            <span class="built_in">string</span> _author = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// age</span></span><br><span class="line">            <span class="built_in">int</span> _age = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// money</span></span><br><span class="line">            <span class="built_in">float</span> _money = floatBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// hashouse</span></span><br><span class="line">            <span class="built_in">bool</span> _hashouse = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pbutctime</span></span><br><span class="line">            <span class="built_in">long</span> _pbutctime = longBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// luckynumber</span></span><br><span class="line">            <span class="built_in">int</span> _luckynumber_length = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="built_in">int</span>[] _luckynumber = <span class="keyword">new</span> <span class="built_in">int</span>[_luckynumber_length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; _luckynumber_length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _luckynumber[i] = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> t_AuthorInfo() &#123;</span><br><span class="line">                id = _id,</span><br><span class="line">                author = _author,</span><br><span class="line">                age = _age,</span><br><span class="line">                money = _money,</span><br><span class="line">                hashouse = _hashouse,</span><br><span class="line">                pbutctime = _pbutctime,</span><br><span class="line">                luckynumber = _luckynumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">t_AuthorInfo <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="literal">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// id</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.id, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// author</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.author, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// age</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.age, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// money</span></span><br><span class="line">            floatBuffer.serialize(<span class="keyword">value</span>.money, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// hashouse</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span>.hashouse, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pbutctime</span></span><br><span class="line">            longBuffer.serialize(<span class="keyword">value</span>.pbutctime, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// luckynumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.luckynumber.Length, steam);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">value</span>.luckynumber.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                intBuffer.serialize(<span class="keyword">value</span>.luckynumber[i], steam);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>t_AuthorInfo.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t_AuthorInfo的注释</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">t_AuthorInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> id;              <span class="comment">// 唯一id</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> author;               <span class="comment">// 作者</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> age;             <span class="comment">// 年龄</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> money;             <span class="comment">// 拥有金钱</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> hashouse;               <span class="comment">// 拥有房子</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> pbutctime;              <span class="comment">// 出版utc时间</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span>[] luckynumber;               <span class="comment">// 幸运数字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:<br>因为xbuffer_parser默认只支持一个一个文件解析，保留原始使用方法会导致弹过多的弹窗，所以这里把xbuffer_parser改成指定目录形式的自动化生成。</p>
<h4 id="序列化数据"><a href="#序列化数据" class="headerlink" title="序列化数据"></a>序列化数据</h4><p>Xbuffer序列化相关的代码自动生成完成后，下一步就是把Excel的数据序列化到我们指定的二进制文件流了。</p>
<p>实现方案思考：</p>
<ul>
<li>这一步主要依赖于最初存储的Excel数据以及前面生成的Xbuffer相关的序列化代码来进行序列化数据。</li>
<li>但序列化的代码是动态生成的没有被编译到工具代码里的，我们无法利用现成的序列化代码来进行数据序列化。</li>
<li>只能根据表格数据以及类型信息通过Xbuffer的基础数据类型写入对应数据，反序列化时再利用反序列化代码进行数据读取。</li>
<li>除了写入数据信息，我们还需要在写入数据信息之前，写入两个关键信息(1. 数据数量(行数) 2. 数据长度(字节数))，用于我们后面去读取加载存储数据时使用，后者如果完全是一个byte对应一个excel数据的话倒是可以不用存储，因为加载后就已经知道总长度了，但如果是所有byte通过zip压缩到一起的话就需要知道每个byte的数据长度。</li>
</ul>
<p>序列化的核心代码文件:<br>XbufferExcelDataToBytes.cs</p>
<p>Note:</p>
<ol>
<li>暂时是一个Excel文件对应一个bytes数据的方式进行存储。(<strong>2022&#x2F;1&#x2F;22完成了单Excel多Sheet导出的支持</strong>)</li>
<li>如果想对数据进行压缩或者加密验证，都可以在序列化这一步或者压缩之后写入数据，然后在加载时反向操作判定对比即可。(TODO:优化)</li>
</ol>
<h4 id="统一表格数据加载和读取"><a href="#统一表格数据加载和读取" class="headerlink" title="统一表格数据加载和读取"></a>统一表格数据加载和读取</h4><p>这一步是属于加载一测的了，是需要运用在Unity里的代码，统一表格加载管理是为了对于表格数据进行快速的访问和管理(一般都会有个GameDataManager之类的单例类负责管理)。<br>因为表格数据是动态生成的，所以加载的代码也需要动态生成。</p>
<p>实现方案思考:</p>
<ul>
<li>这一步因为涉及到自动化的加载代码生成，会涉及到多语言支持问题，所以如果想要支持多语言最好通过模板一类的方式来动态生成代码。</li>
<li>虽然Xbuffer里有一套根据模板生成代码的方案，但想自己尝试实现一下，所以不准备直接拿过来用，准备参考Xbuffer模板替换思路自己模仿写一份(尝试写了这个才发现正则的强大之处)。</li>
</ul>
<p>模板功能需求：</p>
<ul>
<li>支持模板内容基于占位符替换</li>
<li>支持模板内容基于占位符循环替换</li>
</ul>
<p>实现方案跟Xbuffer的一样，支持如下功能：</p>
<ol>
<li>支持两种替换规则(1. 占位符单次替换 2. 限定模板内容多次替换累加)</li>
<li>前者作用范围整个模板(不包含多次替换模板内容部分 – 通过定义不重复的占位符来实现)，后者允许指定局部内容作为模板用于多次替换累加</li>
<li>多次替换模板内容允许跨行</li>
<li>模板占位符可自定义名字，但格式必须是:#名字#</li>
<li>多次替换模板内可定义占位符，支持占位符单次替换</li>
</ol>
<p>比如如下定义方式:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated, do not edit it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> Xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#循环标签名1#</span></span><br><span class="line">        <span class="keyword">public</span> <span class="meta">#循环占位符名1#Container #循环占位符名1#Container = new #循环占位符名1#Container();</span></span><br><span class="line">        <span class="meta">#循环标签名1#</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#循环标签名2#</span></span><br><span class="line">        <span class="meta">#循环占位符名2#Container.loadDataFromBin();</span></span><br><span class="line">        <span class="meta">#循环标签名2#</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Instance = <span class="keyword">new</span> GameDataManager();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模板文件定义分析:</p>
<ol>
<li>整个文件内容是作为完整的模板内容。</li>
<li>在非循环占位符标签内的#占位符名#会用于作为单次替换占位符</li>
<li>循环标签名1和循环标签名2定义一个局部模板内容作为多次替换的模板(循环标签必须配对使用，且不允许同一个模板里重复使用)</li>
<li>循环占位符名1和循环占位符名2表示多次替换模板里的占位符(注意不能和单次占位符名字重复，不然会被单次替换掉)</li>
</ol>
<p>这里主要需要以下几个文件的模板:<br>先手写一版模板初稿</p>
<ol>
<li>GameDataManager.ftl – GameDataManager.cs(表数据统一加载管理类)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated, do not edit it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Singleton = <span class="keyword">new</span> GameDataManager();</span><br><span class="line"></span><br><span class="line">        <span class="meta">#CONTAINER_MEMBER_LOOP#</span></span><br><span class="line">        <span class="keyword">private</span> <span class="meta">#CLASS_NAME#Container m#CLASS_NAME#Container = new #CLASS_NAME#Container();</span></span><br><span class="line">        <span class="meta">#CONTAINER_MEMBER_LOOP#</span></span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="meta">#CONTAINER_LOAD_LOOP#</span></span><br><span class="line">			m<span class="meta">#LOOP_CLASS_NAME#Container.loadDataFromBin();</span></span><br><span class="line">			<span class="meta">#CONTAINER_LOAD_LOOP#</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">#CONTAINER_GET_LOOP#</span></span><br><span class="line">		<span class="keyword">public</span> List&lt;<span class="meta">#LOOP_CLASS_NAME#&gt; Get#LOOP_CLASS_NAME#List()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> m<span class="meta">#LOOP_CLASS_NAME#Container.getList();</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #LOOP_CLASS_NAME#&gt; Get#LOOP_CLASS_NAME#Map()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> m<span class="meta">#LOOP_CLASS_NAME#Container.getMap();</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">#CONTAINER_GET_LOOP#</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>excelContainer.ftl – excelContainer.cs(表格数据存储类)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated by XbufferExcelToData, do not edit it </span></span><br><span class="line"><span class="comment"> * 表格名字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> #<span class="title">CLASS_NAME</span>#<span class="title">Container</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;<span class="meta">#CLASS_NAME#&gt; list = null;</span></span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #CLASS_NAME#&gt; map = null;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="meta">#CLASS_NAME#&gt; getList()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="literal">null</span> || list.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #CLASS_NAME#&gt; getMap()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (map == <span class="literal">null</span> || map.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearList</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.Count &gt; <span class="number">0</span>)</span><br><span class="line">                list.Clear();</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="literal">null</span> &amp;&amp; map.Count &gt; <span class="number">0</span>)</span><br><span class="line">                map.Clear();</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadDataFromBin</span>()</span></span><br><span class="line">        &#123;   </span><br><span class="line">            Stream fs = ConfLoader.Singleton.getStreamByteName(<span class="keyword">typeof</span>(<span class="meta">#CLASS_NAME#).Name);</span></span><br><span class="line">            <span class="keyword">if</span>(fs != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                BinaryReader br = <span class="keyword">new</span> BinaryReader(fs);</span><br><span class="line">                <span class="built_in">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">bool</span> frist = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span> (fs.Length - fs.Position &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (frist)</span><br><span class="line">                        &#123;</span><br><span class="line">                            frist = <span class="literal">false</span>;</span><br><span class="line">                            ClearList();</span><br><span class="line">                            <span class="keyword">var</span> count = br.ReadInt32();</span><br><span class="line">                            list =  <span class="keyword">new</span> List&lt;<span class="meta">#CLASS_NAME#&gt;(count);</span></span><br><span class="line">                            map = <span class="keyword">new</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #CLASS_NAME#&gt;(count);</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> length = br.ReadInt32();</span><br><span class="line">                        <span class="keyword">var</span> data = br.ReadBytes(length);</span><br><span class="line">                        <span class="keyword">var</span> obj= <span class="meta">#CLASS_NAME#Buffer.deserialize(data, ref offset);</span></span><br><span class="line">                        offset = <span class="number">0</span>;</span><br><span class="line">                        list.Add(obj);</span><br><span class="line">                        map.Add(obj.<span class="meta">#ID_NAME#, obj); </span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.LogError(<span class="string">&quot;import data error: &quot;</span> + ex.ToString());</span><br><span class="line">                &#125;           </span><br><span class="line">                br.Close();</span><br><span class="line">                fs.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ConfLoader.cs(二进制配置数据文件加载类 - 这个不需要自动化生成)</li>
</ol>
<p>这里只支持了一维数组维度的配置:<br>来看下自动生成后的相关代码：<br>GameDataManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated, do not edit it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Instance = <span class="keyword">new</span> GameDataManager();</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> t_AuthorInfoContainer mt_AuthorInfoContainer = <span class="keyword">new</span> t_AuthorInfoContainer();</span><br><span class="line">        </span><br><span class="line">        ******</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> t_language_cnContainer mt_language_cnContainer = <span class="keyword">new</span> t_language_cnContainer();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> t_uiContainer mt_uiContainer = <span class="keyword">new</span> t_uiContainer();</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			</span><br><span class="line">			mt_AuthorInfoContainer.loadDataFromBin();</span><br><span class="line">			</span><br><span class="line">			******</span><br><span class="line">			</span><br><span class="line">			mt_language_cnContainer.loadDataFromBin();</span><br><span class="line">			</span><br><span class="line">			mt_uiContainer.loadDataFromBin();</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> List&lt;t_AuthorInfo&gt; <span class="title">Gett_AuthorInfoList</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_AuthorInfoContainer.getList();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt; <span class="title">Gett_AuthorInfoMap</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_AuthorInfoContainer.getMap();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">        ******</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> List&lt;t_ui&gt; <span class="title">Gett_uiList</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_uiContainer.getList();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, t_ui&gt; <span class="title">Gett_uiMap</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_uiContainer.getMap();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>t_AuthorInfoContainer.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated by XbufferExcelToData, do not edit it </span></span><br><span class="line"><span class="comment"> * 表格名字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_AuthorInfoContainer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;t_AuthorInfo&gt; list = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt; map = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;t_AuthorInfo&gt; <span class="title">getList</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="literal">null</span> || list.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt; <span class="title">getMap</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (map == <span class="literal">null</span> || map.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearList</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.Count &gt; <span class="number">0</span>)</span><br><span class="line">                list.Clear();</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="literal">null</span> &amp;&amp; map.Count &gt; <span class="number">0</span>)</span><br><span class="line">                map.Clear();</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadDataFromBin</span>()</span></span><br><span class="line">        &#123;   </span><br><span class="line">            Stream fs = ConfLoader.Singleton.getStreamByteName(<span class="keyword">typeof</span>(t_AuthorInfo).Name);</span><br><span class="line">            <span class="keyword">if</span>(fs != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                BinaryReader br = <span class="keyword">new</span> BinaryReader(fs);</span><br><span class="line">                <span class="built_in">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">bool</span> frist = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span> (fs.Length - fs.Position &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (frist)</span><br><span class="line">                        &#123;</span><br><span class="line">                            frist = <span class="literal">false</span>;</span><br><span class="line">                            ClearList();</span><br><span class="line">                            <span class="keyword">var</span> count = br.ReadInt32();</span><br><span class="line">                            list =  <span class="keyword">new</span> List&lt;t_AuthorInfo&gt;(count);</span><br><span class="line">                            map = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt;(count);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> length = br.ReadInt32();</span><br><span class="line">                        <span class="keyword">var</span> data = br.ReadBytes(length);</span><br><span class="line">                        <span class="keyword">var</span> obj= t_AuthorInfoBuffer.deserialize(data, <span class="keyword">ref</span> offset);</span><br><span class="line">                        offset = <span class="number">0</span>;</span><br><span class="line">                        list.Add(obj);</span><br><span class="line">                        map.Add(obj.id, obj); </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.LogError(<span class="string">&quot;import data error: &quot;</span> + ex.ToString());</span><br><span class="line">                &#125;           </span><br><span class="line">                br.Close();</span><br><span class="line">                fs.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note：</p>
<ol>
<li>占时我ConfLoad.cs加载二进制文件是通过放在Resources目录下以TextAsset形式加载进来，所以加载的时候是没带后缀的，具体ConfLoad代码根据不同的存储位置和加载方式会稍作改动。</li>
</ol>
<h4 id="读取序列化数据"><a href="#读取序列化数据" class="headerlink" title="读取序列化数据"></a>读取序列化数据</h4><p>终于走到最后一步了，完成这一步，导表工具的工具链基本就算打通了。</p>
<p>ConfLoader.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             配置表加载辅助单例类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 配置表加载辅助单例类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConfLoader</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">ConfLoader</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel表格数据存储目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ExcelDataFolderPath = <span class="string">&quot;DataBytes/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConfLoader</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取表格配置数据的二进制流数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bytefilename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Stream <span class="title">getStreamByteName</span>(<span class="params"><span class="built_in">string</span> bytefilename</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> textasset = Resources.Load(ExcelDataFolderPath + bytefilename) <span class="keyword">as</span> TextAsset;</span><br><span class="line">        <span class="keyword">var</span> memorystream = <span class="keyword">new</span> MemoryStream(textasset.bytes);</span><br><span class="line">        <span class="keyword">return</span> memorystream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合前面的GameManager.cs和所有对应的***Container.cs文件，完成我们对于序列化数据的加载。</p>
<p>激动人心的一刻，PC上成功加载表格数据代码并打印出来:<br><img src="/img/Unity/Data-Config-Automation/ExcelDataLoadAndPrint.png" alt="ExcelDataLoadAndPrint"></p>
<p>遇到个严峻的问题，真机上读取float数据时出了空引用:<br>？大写的问号脸，PC成功了但是真机Android报空？<br>问题猜想1:<br>是不是Xbuffer对于float的序列化或者反序列化没写对？<br>猜想1思考:<br>但仔细一想PC都是对的，这个猜测自然不成立了。</p>
<p>问题猜想2:<br>大小端数据存储的问题？<br>猜想2思考:<br>Windows PC(Intel)和Android Mix2手机(ARM)都是小端，同时真机不是数据错误而是报空，这个猜想也不成立。</p>
<p>问题猜想3:<br>根据报错是在var value &#x3D; <em>(float</em>)(ptr + offset);时报空，那肯定跟字节数据float解析有关。<br>猜想3思考:<br>结合万能的Google，貌似总算找到关键点了。[Google问答](<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a]">https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a]</a></p>
<p>原因:<br>上面那个问题提到了ARM设备上对于浮点数(比如floating，double)的值进行dereference要求内存地址必须是4-bytes对齐的形式才能正确解析。</p>
<p>相关知识储备:<br><a target="_blank" rel="noopener" href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html">浅谈字节序（Byte Order）及其相关操作</a><br><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/library/pa-dalign/">Data alignment: Straighten up and fly right</a></p>
<p>分析当前情况:<br>当前使用Xbuffer对于表格数据的存储只是单纯的按顺序填充数据，没有考虑任何的对齐问题，float数据也是前面的数据填到哪个字节数就在后面填入4bytes的float数据。</p>
<p>解决方案:<br>固定分配一个常驻的byte[4]作为中间缓冲区，在内存地址不满足4byte对齐时进行赋值byte数据然后对满足4byte对齐的常驻byte[4]对象进行解析。</p>
<p>floatBuffer.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">******</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">floatBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">uint</span> size = <span class="keyword">sizeof</span>(<span class="built_in">float</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//-------------------------------------------------</span></span><br><span class="line">        <span class="comment">// float在ARM机器上dereferencing浮点数(float,double等)强制要求内存地址4字节对齐，不然会报空</span></span><br><span class="line">        <span class="comment">// 参考链接:</span></span><br><span class="line">        <span class="comment">// https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a</span></span><br><span class="line">        <span class="comment">//-------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修复方案，定义一个全局的4字节byte数组，用于不满足内存地址4字节对齐时赋值用于解析float</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">byte</span>[] fourByteAlginedArray = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr = buffer)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">float</span> <span class="keyword">value</span>;</span><br><span class="line">                <span class="keyword">if</span> ((<span class="built_in">int</span>)(ptr + offset) % <span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">value</span> = *(<span class="built_in">float</span>*)(ptr + offset);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        fourByteAlginedArray[i] = (ptr + offset)[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr2 = fourByteAlginedArray)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">value</span> = *(<span class="built_in">float</span>*)(ptr2);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                offset += size;</span><br><span class="line">                <span class="keyword">return</span> BitConverter.IsLittleEndian ? <span class="keyword">value</span> : utils.toLittleEndian((<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>真正激动人心的时刻，真机运行反序列化数据:<br><img src="/img/Unity/Data-Config-Automation/AndroidDeviceExcelDataLoadAndPrint.png" alt="AndroidDeviceExcelDataLoadAndPrint"><br>可以看到我们成功反序列化了表格数据，同时解决了float在真机上dereference问题。</p>
<h4 id="性能和内存开销"><a href="#性能和内存开销" class="headerlink" title="性能和内存开销"></a>性能和内存开销</h4><p>工具链虽然打通了，但是我们我不只是要考虑能不能用，更多的我们还要关心内存开始以及序列化反序列化的速度性能问题。</p>
<p>接下来就是通过大数据配置来测试内存分配和序列化性能问题。</p>
<p>测试用例:<br>两张表（author_info.xlsx和global_config.xlsx），各配置了994行数据，然后复制两张表9次并改名(文件名和Excel内部sheet名都得改)(总计20张表 X 994行数据)。</p>
<p>测试平台：<br>PC Windows</p>
<p>导表耗时:<br><img src="/img/Unity/Data-Config-Automation/XbufferExcelToDataTimeConsume.png" alt="XbuuferExcelToDataTimeConsume"></p>
<p>导表后的二进制文件大小(未压缩):<br>二进制数据总大小我统计了下未压缩是1.3M。</p>
<p>表格数据读取内存以及反序列化时间开销：<br>我通过Unity的Profiler.GetMonoUsedSizeLong()统计计算堆内存的开销：<br>统计类:<br>MonoMeoryProfiler.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MemoryProfiler.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Profiling;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MemoryProfiler.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 简陋的内存统计工具(统计托管的Mono内存)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MonoMemoryProfiler</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">MonoMemoryProfiler</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 内存Profile类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> MemoryProfilerType</span><br><span class="line">    &#123;</span><br><span class="line">        CSharp_GC = <span class="number">1</span>,          <span class="comment">// CS GC统计</span></span><br><span class="line">        Unity_Profiler = <span class="number">2</span>      <span class="comment">// Unity Profiler接口统计</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前内存统计类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MemoryProfilerType mCurrentMemoryProfilerType = MemoryProfilerType.Unity_Profiler;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 内存标签名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mTagName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始统计时总共使用的Mono内存</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">long</span> mTotalUsedMonoMemory_Begin;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束统计时总共使用的Mono内存</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">long</span> mTotalUsedMonoMemory_End;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置当前内存统计类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mpt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMemoryProfilerType</span>(<span class="params">MemoryProfilerType mpt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentMemoryProfilerType = mpt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开启内存统计Tag</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;tag&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginMemorySample</span>(<span class="params"><span class="built_in">string</span> tag</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!tag.IsNullOrEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            mTagName = tag;</span><br><span class="line">            <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.CSharp_GC)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 确保得到正确的起始Heap Memory Size</span></span><br><span class="line">                mTotalUsedMonoMemory_Begin = GC.GetTotalMemory(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.Unity_Profiler)</span><br><span class="line">            &#123;</span><br><span class="line">                GC.Collect();</span><br><span class="line">                mTotalUsedMonoMemory_Begin = Profiler.GetMonoUsedSizeLong();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;MonoMemoryProfiler的Tag不能为空!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束内存统计</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endMemorySample</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!mTagName.IsNullOrEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.CSharp_GC)</span><br><span class="line">            &#123;</span><br><span class="line">                mTotalUsedMonoMemory_End = GC.GetTotalMemory(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.Unity_Profiler)</span><br><span class="line">            &#123;</span><br><span class="line">                GC.Collect();</span><br><span class="line">                mTotalUsedMonoMemory_End = Profiler.GetMonoUsedSizeLong();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> heapmemoryoffset = mTotalUsedMonoMemory_End - mTotalUsedMonoMemory_Begin;            </span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;内存统计标签 : &#123;0&#125;&quot;</span>, mTagName));</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;当前Mono内存大小 = &#123;0&#125; Bytes&quot;</span>, mTotalUsedMonoMemory_End));</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;之前Mono内存大小 = &#123;0&#125; Bytes&quot;</span>, mTotalUsedMonoMemory_Begin));</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;总共Mono内存占用 = &#123;0&#125; Bytes == &#123;1&#125; KB == &#123;2&#125; M&quot;</span>, heapmemoryoffset, heapmemoryoffset / <span class="number">1024</span> , heapmemoryoffset / (<span class="number">1024</span> * <span class="number">1024</span>)));</span><br><span class="line">            mTagName = <span class="built_in">string</span>.Empty;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PC:<br><img src="/img/Unity/Data-Config-Automation/Profiler_GetMonoUsedSizeLong_MemoryUsing.png" alt="Profiler_GetMonoUsedSizeLong_MemoryUsing"></p>
<p>Android真机:<br><img src="/img/Unity/Data-Config-Automation/AndroidDevice_Profiler_GetMonoUsedSizeLong_MemoryUsing.png" alt="AndroidDevice_Profiler_GetMonoUsedSizeLong_MemoryUsing"></p>
<p>可以看到两种方式统计有不少误差，在5M左右的堆内存开销。<br>时间开销PC在100ms左右,Android真机在200ms左右。</p>
<p>从20张表，每张表大概4-7个字段，各1000行数据来看，内存和序列化，反序列化速度都还是相当可观的。这里因为没有集成支持其他序列化方式，所以没法做详细的对比，详细各序列化库性能对比参考Xbuffer作者在Github上的对比<a target="_blank" rel="noopener" href="https://github.com/CodeZeg/xbuffer">Xbuffer</a>。</p>
<h4 id="优化点"><a href="#优化点" class="headerlink" title="优化点"></a>优化点</h4><p>未来需要支持和优化的工作点：</p>
<ol>
<li>支持多维数据的配置(放弃支持)<br>方案1：<br>- 扩展到多维不定长数组<br>问题：<br>- 每一个维度上的数组长度都是不定长的，用多维数组存储会伴随多维数组的维度以及各维度的数量级增长，导致各维度各数量级上的长度信息存储过多(占用过多的二进制字节数据)。<br>- 同时会需要不定长的多维数组来支持，序列化和反序列化都很复杂<br>- 需要扩展Xbuffer的维度支持<br>方案2：<br>- 扩展到多维定长数组<br>结论：<br>不太可行，空间不浪费，各维度数组长度信息过于复杂，实现过于复杂<br>问题：<br>- 只需要存储各个维度上的长度信息，维度长度信息和维度成正比，数量级小易存储<br>- 在配置复杂的不定长数据时，定长数组存储会造成大量的数据空间浪费<br>- 序列化代码依然复杂，反序列化代码相对简单<br>- 需要扩展Xbuffer的维度支持<br>结论：<br>可行，空间比较浪费，多维度数组信息存储简单，实现相对复杂<br>方案3：<br>- 多维数据依然存储在一个一维数组里，通过一维数组索引去访问<br>问题：<br>- 数据存储空间不存在浪费<br>- 不需要扩展Xbuffer多维度支持<br>- 序列化和反序列化代码简单<br>- 无法像多维数组形式方便快速索引数据，只能计算好对应索引值去访问索引数据(数据量配置一旦大了，访问复杂度成指数级成长)<br>- 对于数据配置的抽象不友好们无法快速访问指定部分数据(相当于一维数组的单个字符分割，这样一来没有意义了)<br>结论：<br>可行，空间不浪费，实现简单，访问和理解都不友好，配置复杂度影响访问复杂度。但变相成了一维数组的单个字符分割，没有意义了。<br>最终结论：<br>没有想到好的方式支持，最终放弃了支持多维数据的解析和快速访问。<br>多维数据配置建议:<br>- 可以采用配置多个一维数组映射来支持。<br>- 获取一维数组配置后，自己去split分割访问解析。</li>
<li>支持单列允许填写notation数据类型作为注释类型，单纯作为excel可查看的注释不序列化到数据里。(<strong>完成</strong>)<ul>
<li>修改导表工具支持notation数据类型配置作为注释类型</li>
<li>修改导表生成二进制数据那里不序列化注释类型数据</li>
</ul>
</li>
<li>支持个数据类型不配置，直接使用各类型默认值的方式(<strong>完成</strong>)<ul>
<li>修改导表公安局二进制数据序列化时判定书否有数据，没有数据用各类型默认数据</li>
</ul>
</li>
<li>二进制数据的压缩(暂时未做)<ul>
<li>对序列化好的二进制数据可以进行一些压缩格式的压缩后然后运行时解压的形式实现数据压缩</li>
</ul>
</li>
<li>支持单Excel多Sheet导出(<strong>2022&#x2F;1&#x2F;20完成</strong>)</li>
<li>支持Sheet黑名单，blacklist开头的Sheet名不参与导表(<strong>2022&#x2F;1&#x2F;20完成</strong>)</li>
<li>第一列字段名不限，同时类型支持int和string(<strong>2022&#x2F;1&#x2F;20完成</strong>)</li>
</ol>
<h4 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h4><p>最后给出工具的Github链接:<br><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/XbufferExcellToData">XbufferExcelToData</a><br>上面写了导表工具的详细支持和测试信息。</p>
<h4 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h4><ol>
<li>高效的数据序列化和反序列化不是语言自带的序列化和反序列化方式(很有可能默认使用了反射之类的)而是直接对于内存的数据的快速访问解析(比如flatbuffer，Xbuffer最终都是采用一个扁平化的字节数组对数据进行存储访问)</li>
<li>更进一步的数据压缩是对于基础数据类型的存储格式与数据解析定义(比如Protobuf里Varint数据存储方式)</li>
<li>跨语言的序列化反序列化只要定义统一的字节流写入和读取即可。</li>
<li>数据向后兼容问题(这里需要向Flatbuffer和Protobuf对于数据的存储做更多的处理才能做到)</li>
<li>完整的工具链要考虑的不仅仅是数据的存储和加载，还要关注自动化相关代码的生成(比如通过模板定义做到对多语言工具链的支持)。</li>
<li>二进制数据的处理需要关注大小端问题(不同CPU数据存储方式不一样)，内存对齐问题(不同架构比如ARM和Intel对于浮点数的dereference就有内存4字节对齐的要求)。</li>
<li>强大的正则表达式在做模板问题处理时，相当优秀。</li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://github.com/google/protobuf">protobuf</a><br><a target="_blank" rel="noopener" href="https://github.com/google/flatbuffers">FlatBuff</a><br><a target="_blank" rel="noopener" href="https://github.com/CodeZeg/xbuffer">Xbuffer</a></p>
<h2 id="Knowlodge-Part"><a href="#Knowlodge-Part" class="headerlink" title="Knowlodge Part"></a>Knowlodge Part</h2><p><a target="_blank" rel="noopener" href="https://www.race604.com/flatbuffers-intro/">FlatBuffers 体验</a><br><a target="_blank" rel="noopener" href="https://github.com/google/flatbuffers/releases">Flatc</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/30ef9b3780d9">Protocol Buffer 序列化原理大揭秘 - 为什么Protocol Buffer性能这么好？</a><br><a target="_blank" rel="noopener" href="https://www.xcode.me/more/microsoft-net-framework-version-define">Microsoft .NET Framework 版本定义</a><br><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/library/pa-dalign/">Data alignment: Straighten up and fly right</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/ce123_zhouwei/article/details/6971544">详解大端模式和小端模式</a><br><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/11/byte-order.html">理解字节序</a><br><a target="_blank" rel="noopener" href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html">浅谈字节序（Byte Order）及其相关操作</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a href="blog.csdn.net/qq_14903317/article/details/78637440">Unity C#配置表工具</a><br><a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-494944.html">Unity3D游戏开发之当游戏开发遇上Excel</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/2429">Unity3D研究院之MAC&amp;Windows跨平台解析Excel（六十五）</a><br><a target="_blank" rel="noopener" href="https://github.com/ExcelDataReader/ExcelDataReader">ExcelReader</a><br><a target="_blank" rel="noopener" href="https://www.race604.com/flatbuffers-intro/">FlatBuffers 体验</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Excel/">Excel</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Excel/">Excel</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/08/14/Unity中的Lua/" title="Unity中的Lua" itemprop="url">Unity中的Lua</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-08-14T14:19:01.000Z" itemprop="datePublished"> 发表于 2017-08-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h1><p>结合以前的初步学习了解，这一次要对Lua进行进一步的深入学习。</p>
<p>首先我们要知道Lua是脚本语言，是有自己的虚拟机，是解析执行而非像C#,C++,Java这些编译执行。同时Lua是弱类型语言。</p>
<p>这里不更多的讲解Lua虚拟机相关概念，详情参考[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]</a>(Scripting System)<br><img src="/img/Lua/Virtual_Machine_Working_Levels.PNG" alt="Virtual_Machine_Working_Levels"><br>这里只要知道Lua的虚拟机(程序模拟线程，堆栈等)是运行在程序里而非物理CPU上，因此只要虚拟机把Lua脚本解析成对应平台的机器码就能支持跨平台(好比Java的JVM)。</p>
<h1 id="Lua-Study"><a href="#Lua-Study" class="headerlink" title="Lua Study"></a>Lua Study</h1><p>以前的部分学习参考:<br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html">Scripting System &amp; Lua Study</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0rk.html">Lua – some important concept and knowledge</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zp.html">Lua - C API </a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zs.html">Lua - C call Lua &amp; Lua call C</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s9.html">Lua - Object Oriented Programming</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v1qg.html">Lua - Userdata</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v383.html">Lua - Managing Resources &amp; Threads and States</a></p>
<h2 id="Weak-Tables-And-Finalizers"><a href="#Weak-Tables-And-Finalizers" class="headerlink" title="Weak Tables And Finalizers"></a>Weak Tables And Finalizers</h2><p>“and Finalizers Lua  does  automatic  memory  management. Programs  create  objects  (tables, threads,  etc.),  but  there  is  no  function  to  delete  objects. Lua  automatically deletes  objects that become garbage,  using garbage  collection. “</p>
<p><strong>Weak Table</strong><br>“Weak tables allow the collection of Lua objects that are still accessible to the program”</p>
<p>“A weak reference is a reference to an object hat is not considered by the garbage collector”</p>
<p>“In weak tables,, both keys and values can be weak”(three kinds of week table:1. weak key 2. weak value 3. weak key and value)</p>
<p>Weak Table Using:</p>
<ol>
<li>释放使用不再使用的缓存数据(memorizing)<br>Auxiliary table(辅助表),Lua里有类似于C#里的internal hash table用于重用使用过的string和访问结果(C#里主要是使用过的string重用。Lua还能将访问过的string的table结果缓存返回)</li>
</ol>
<p>但Auxiliary table有个缺点就是使用不频繁的string和result会一直被缓存无法释放。weak table正是用于解决这一问题的方案之一。(因为weak table的weak reference一旦不再被使用就会被下一次GC释放)</p>
<ol start="2">
<li><p>Object Attributes Implemetation<br>Solution: use external table to associate objects with attributes<br>Drawback: external table reference prevent objects from being collected<br>Final solution: use weak keys for objects in external table</p>
</li>
<li><p>Tables with Default Values<br>这里有两种各有优缺点的实现方案：<br>方案1:</p>
</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> defaults = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(defaults, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;k&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">local</span> mt = &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t)</span></span> <span class="keyword">return</span> defaults[t] <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setDefault</span> <span class="params">(t, d)</span></span></span><br><span class="line">defaults[t] = d</span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>方案2:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> metas = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(metas, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;v&quot;</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setDefault</span> <span class="params">(t, d)</span></span></span><br><span class="line"><span class="keyword">local</span> mt = metas[d]</span><br><span class="line"><span class="keyword">if</span> mt == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">mt = &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="keyword">return</span> d <span class="keyword">end</span>&#125;</span><br><span class="line">metas[d] = mt <span class="comment">-- memorize</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>前者针对每一个不同的Table都会分配一个defaults入口,table作为key，default value作为value。这样的缺点就是当table数量很大的时候会需要分配很多内存去存储不同table的default value。</p>
<p>后者针对不同的default value分配了更多的内存(比如mt，entry on metas, closure……)，但优点是同样的default value只需要分配一次即可，所以后者更适用于table数量多但default value大都相同的情况。</p>
<ol start="4">
<li>Ephemeron Tables(声明短暂的table Lua 5.2里提供)<br>Ephemeron Table:<br>“In Lua 5.2, a table with weak keys and strong values is an ephemeron table. In an ephemeron table, the accessibility of a key controls the accessibility of its corresponding value.(只当有strong<br> reference to key时value才是strong的)”<br>e.g. constant-function factory</li>
</ol>
<p>Note:<br>“Only objects can be collected from a weak table. Values, such as numbers and booleans, are not collectible”(只有Objects在weak table里能被gc回收，number和booleans这种Value类型不能在weak table里被gc回收)</p>
<p>“strings are collectible, but string is not removed from weak table(unless its associated value is collected)”</p>
<p><strong>Finalizers</strong><br>“Finalizers allow the collection of externa objects that are not directly under control of the garbage collector”</p>
<p>“Finalizer is a function associated with an object that is called when that object is about to be collected.”(相当于C#里的Finalize,在GC object的时候会被调用。但只有一开始设置Metamethod的__gc时才能mark该object为可finalization的，否则就算后面在复制__gc也不会在调用该object的finalizer)</p>
<p>Lua里是通过Metamethod里的__gc实现。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试环境要求至少Lua 5.2</span></span><br><span class="line">o = &#123;x = <span class="string">&quot;hi&quot;</span>&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(o, &#123;<span class="built_in">__gc</span> = <span class="function"><span class="keyword">function</span> <span class="params">(o)</span></span> <span class="built_in">print</span>(o.x) <span class="keyword">end</span>&#125;)</span><br><span class="line">o = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">collectgarbage</span>() <span class="comment">--&gt; hi</span></span><br></pre></td></tr></table></figure>

<p>The order of finalization called:<br>“When the collector finalizes several obejcts in the same cycle, it calls their finalizers in the reverse order that the objects were marked for finalization”(先声明__gc被mark为可finalization的object的finalizer后被调用)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试环境要求至少Lua 5.2</span></span><br><span class="line">mt = &#123;<span class="built_in">__gc</span> = <span class="function"><span class="keyword">function</span> <span class="params">(o)</span></span> <span class="built_in">print</span>(o[<span class="number">1</span>]) <span class="keyword">end</span>&#125;</span><br><span class="line">list = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">3</span> <span class="keyword">do</span></span><br><span class="line">    list = <span class="built_in">setmetatable</span>(&#123;i, link = list&#125;, mt)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">list = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">collectgarbage</span>()</span><br><span class="line"><span class="comment">--&gt; 1</span></span><br><span class="line"><span class="comment">--&gt; 2</span></span><br><span class="line"><span class="comment">--&gt; 3</span></span><br></pre></td></tr></table></figure>

<p>对于被finalize的object，Finlization会使被finalize的object处于两个特殊的状态：</p>
<ol>
<li>transient resurrection(短暂的复苏)</li>
<li>permanent resurrection(永久的复苏)<br>前者因为在调用__gc的metamethod时我们会得到finalize的object，这样一来使得该object alive again，然后我们可以通过该object用于访问里面的对象。<br>finalizer被调用时，该alive again的object被存储在了global table里，导致该object在finalize后依然存在。<strong>要想使用finalize也真正回收obejct，我们需要调用两次gc，第一次用于回收原始object，第二次用于回收alive again的object。</strong></li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 因为当前测试环境是Lua 5.1(基于LuaTo#插件学习的，JIT支持到5.1的版本)所以不支持Talbe的__gc Metamethod，这里暂时没有写测试程序。</span></span><br></pre></td></tr></table></figure>

<p>Note:<br>“In lua 5.1 the only lua values that work with __gc metamethod is userdata. “(Lua 5.1不支持table的__gc metamethod，只支持userdata的__gc metamethod)</p>
<h2 id="Lua里的位运算"><a href="#Lua里的位运算" class="headerlink" title="Lua里的位运算"></a>Lua里的位运算</h2><p>在了解Lua里的位运算之前我们需要了解原码，反码，补码相关的概念，详情参考：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangziqiu/archive/2011/03/30/computercode.html">原码, 反码, 补码 详解</a></p>
<p>这里直接说结论：<br><strong>机器的数字存储采用补码的方式来编码存储的。</strong></p>
<p><strong>正数的反码 &#x3D; 自身</strong><br><strong>负数的反码 &#x3D; 符号位不变 + 其他位取反</strong></p>
<p><strong>正数的补码 &#x3D; 自身</strong><br><strong>负数的补码 &#x3D; 反码 + 1</strong></p>
<p><strong>移码 &#x3D; 2^n + 补码(真值为排开非符号位的值，n为真值的位数) &#x3D; 补码符号位取反</strong></p>
<p>为什么会需要原码，反码，补码?<br>个人总结原因有以下几点:</p>
<ol>
<li><strong>计算机运算设计为了简化让符号位直接参与运算，同时只有加法没有减法，减法用加一个负数的表示</strong></li>
<li><strong>直接用原码相加无法解决符号位相加问题，导致结果不正确</strong></li>
<li><strong>直接用反码相加无法解决0的准确表达，即1<em>0和0</em>0都表示0但区分了正负之分(有效范围127到-127)</strong></li>
<li><strong>用补码相加不仅解决了正负0的问题，同时1*0还能表示-128(扩展有效范围为127到-128。这也是为什么我们的int32的有效范围为2^31 - 1到(-2)^31的原因)</strong></li>
<li><strong>移码解决补码不能快速比较两个数大小的问题</strong></li>
</ol>
<p>了解了基础的理论知识，让我们再来看看Lua里的位运算。</p>
<h3 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i = <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line">	<span class="built_in">print</span>(i)</span><br><span class="line">	<span class="keyword">local</span> number = i</span><br><span class="line">	<span class="keyword">local</span> result = ~number</span><br><span class="line">	<span class="built_in">print</span>(result)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>让我们看下输出结果:<br><img src="/img/Lua/BitNotOperation.png" alt="BitNotOperation"><br>上面的结果出人意料，0取反为-1，1取反为-2,2取反为-3,3取反为-4，并不是我们想象中的0取反为-2^31</p>
<p>那么为什么会有这样的结果了，让我们结合前面学习的原码，反码，补码知识来破解其中的奥妙。<br>让我们来一步一步看看，0在取反的过程中是怎么一步一步变成-1的。<br>正向:<br>0000(原码)                    0<br>0000(反码)                    0<br>0000(补码)                    0<br>1111(补码取反)                -2^31 + 1</p>
<p>因为机器是以补码存储数字的，所以0的存储编码为0000<br>我们通过对0取反，得到1111(补码取反)<br>得到了取反后的补码，我们如何知道这个补码表达的是什么数值了？这个时候需要结合补码的计算方式逆向推导出原码值。</p>
<p>补码逆向:<br>1111 - 1 &#x3D; 1110(反码)          -2^31 + 1<br>1110(反码) &#x3D; 原码符号位不变 + 原码其他位取反 &#x3D; 1001(原码) &#x3D; -1</p>
<p>可以看到通过正向和逆向反推，我们成功得出了0取反后的值为-1而不是我们想象中的-2^31</p>
<h3 id="移位和异或"><a href="#移位和异或" class="headerlink" title="移位和异或"></a>移位和异或</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> num1 = <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(num1 &lt;&lt; <span class="number">1</span>)</span><br><span class="line"><span class="keyword">local</span> num2 = <span class="number">-1</span></span><br><span class="line"><span class="built_in">print</span>(num2 &lt;&lt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line"><span class="comment">-- 01101(原码)</span></span><br><span class="line"><span class="comment">-- 01101(补码)</span></span><br><span class="line"><span class="keyword">local</span> num3 = <span class="number">13</span></span><br><span class="line"><span class="comment">-- 11011(原码)</span></span><br><span class="line"><span class="comment">-- 10100(反码)</span></span><br><span class="line"><span class="comment">-- 10101(补码)</span></span><br><span class="line"><span class="keyword">local</span> num4 = <span class="number">-11</span></span><br><span class="line"><span class="comment">-- 01101(补码) &amp; 10011(补码)</span></span><br><span class="line"><span class="comment">-- 00101(异后补码)</span></span><br><span class="line"><span class="comment">-- 00101(异后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num3 &amp; num4)</span><br><span class="line"><span class="comment">-- 01101(补码) | 10101(补码)</span></span><br><span class="line"><span class="comment">-- 11101(或后补码)</span></span><br><span class="line"><span class="comment">-- 11100(或后反码)</span></span><br><span class="line"><span class="comment">-- 10011(或后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num3 | num4)</span><br><span class="line"><span class="comment">-- 01101(补码) ~ 10101(补码)</span></span><br><span class="line"><span class="comment">-- 11000(异或后)</span></span><br><span class="line"><span class="comment">-- 10111(异或后反码)</span></span><br><span class="line"><span class="comment">-- 11000(异或后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num3 ~ num4)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line"><span class="comment">-- 11001(原码)</span></span><br><span class="line"><span class="comment">-- 10111(补码)</span></span><br><span class="line"><span class="keyword">local</span> num5 = <span class="number">-9</span></span><br><span class="line"><span class="comment">-- 00011(原码)</span></span><br><span class="line"><span class="comment">-- 00011(补码)</span></span><br><span class="line"><span class="keyword">local</span> num6 = <span class="number">3</span></span><br><span class="line"><span class="comment">-- 10111(补码) ~ 00011(补码)</span></span><br><span class="line"><span class="comment">-- 10100(异或后)</span></span><br><span class="line"><span class="comment">-- 10011(异或后反码)</span></span><br><span class="line"><span class="comment">-- 11100(异或后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num5 ~ num6)</span><br></pre></td></tr></table></figure>
<p><img src="/img/Lua/BitwiseOperation.png" alt="BitwiseOperation"><br>可以看到num5和num6异或因为补码的影响得到-12的结果。<br>Note:<br>    1. <strong>有负数的情况，异和或操作都会受补码影响，整数补码等于原码，所以整数异和或操作等价于原码直接异或</strong><br>    2. <strong>异或操作对符号位会有影响，需要考虑补码影响</strong><br>    3. <strong>位移操作左移会替换符号位，右移会丢弃低位</strong></p>
<h2 id="Lua里的OOP"><a href="#Lua里的OOP" class="headerlink" title="Lua里的OOP"></a>Lua里的OOP</h2><p>OOP(Object Oriented Programming)<br>首先Lua里面编写更重要的是Think in Lua，所以这里我不是强调OOP的重要性，而是单纯因为OOP被更多的C#程序员所熟悉。</p>
<h3 id="Class抽象"><a href="#Class抽象" class="headerlink" title="Class抽象"></a>Class抽象</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:    Class.lua</span></span><br><span class="line"><span class="comment">-- Description:    模拟Lua里OOP特性(不支持多重继承)</span></span><br><span class="line"><span class="comment">-- Author:       TangHuan</span></span><br><span class="line"><span class="comment">-- Create Date:    2018/11/09</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用方法：</span></span><br><span class="line"><span class="comment">-- 1. 定义类</span></span><br><span class="line"><span class="comment">-- local ClassName = Class(&quot;ClassName&quot;, nil)</span></span><br><span class="line"><span class="comment">-- ***(自定义类数据方法等)</span></span><br><span class="line"><span class="comment">-- 参数说明：</span></span><br><span class="line"><span class="comment">-- clsname类名，super父类</span></span><br><span class="line"><span class="comment">-- 返回结果:</span></span><br><span class="line"><span class="comment">-- ClassName(含Class基本信息结构的table)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 实例化类对象</span></span><br><span class="line"><span class="comment">-- 参数说明：</span></span><br><span class="line"><span class="comment">-- BaseClass含类定义的Class Table</span></span><br><span class="line"><span class="comment">-- ...构造类实例对象的构造函数ctor()的参数</span></span><br><span class="line"><span class="comment">-- 返回结果：</span></span><br><span class="line"><span class="comment">-- 基于BaseClass的实例对象</span></span><br><span class="line"><span class="comment">-- new(BaseClass, ...)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---克隆对象(建议用于克隆Class对象)</span></span><br><span class="line"><span class="comment">---@param  any 对象</span></span><br><span class="line"><span class="comment">---@return  any 克隆对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Clone</span><span class="params">(object)</span></span></span><br><span class="line">    <span class="keyword">local</span> lookup_table = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_copy</span><span class="params">(object)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(object) ~= <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> object</span><br><span class="line">        <span class="keyword">elseif</span> lookup_table[object] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> lookup_table[object]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> new_table = &#123;&#125;</span><br><span class="line">        lookup_table[object] = new_table</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(object) <span class="keyword">do</span></span><br><span class="line">            new_table[_copy(key)] = _copy(value)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setmetatable</span>(new_table, <span class="built_in">getmetatable</span>(object))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> _copy(object)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---判定是否是指定类或者继承至该类</span></span><br><span class="line"><span class="comment">---@param self Class@类实例对象或者类</span></span><br><span class="line"><span class="comment">---@param cname string | Class@类名或者类定义table</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">IsClass</span><span class="params">(self, cname)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(<span class="built_in">self</span>) ~= <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(cname) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>.class == cname <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">elseif</span> <span class="built_in">self</span>.super <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">self</span>.super.IsClass(<span class="built_in">self</span>.super, cname);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">elseif</span> <span class="built_in">type</span>(cname) == <span class="string">&quot;string&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>.class.className == cname <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">elseif</span> <span class="built_in">self</span>.super <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">self</span>.super.IsClass(<span class="built_in">self</span>.super, cname);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 提供Lua的OOP实现，快速定义一个Class(不支持多重继承)</span></span><br><span class="line"><span class="comment">--- 模拟Class封装，继承，多态，类型信息，构造函数等</span></span><br><span class="line"><span class="comment">--- 模拟一个基础的Class需要的信息</span></span><br><span class="line"><span class="comment">---@param clsname string@类名</span></span><br><span class="line"><span class="comment">---@param super super@父类</span></span><br><span class="line"><span class="comment">---@return Class@含Class所需基本信息的Class table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Class</span><span class="params">(clsname, super)</span></span></span><br><span class="line">    <span class="keyword">local</span> classtable = &#123;&#125;</span><br><span class="line">    <span class="comment">-- ctor模拟构造函数</span></span><br><span class="line">    classtable.Ctor = <span class="literal">false</span></span><br><span class="line">    <span class="comment">-- className模拟类型信息，负责存储类名</span></span><br><span class="line">    classtable.className = clsname</span><br><span class="line">    <span class="comment">-- super模拟父类</span></span><br><span class="line">    <span class="comment">-- Note: 外部逻辑层不允许直接._super访问父类</span></span><br><span class="line">    classtable._super = super</span><br><span class="line">    <span class="comment">-- 自身class类table</span></span><br><span class="line">    classtable.class = classtable;</span><br><span class="line">    <span class="comment">-- 指定索引元方法__index为自身,模拟类访问</span></span><br><span class="line">    <span class="comment">-- 后面实例化对象时会将classtable作为元表，从而实现访问类封装的数据</span></span><br><span class="line">    classtable.<span class="built_in">__index</span> = classtable</span><br><span class="line">    <span class="comment">-- 是否是指定类或者继承至某类的方法接口</span></span><br><span class="line">    classtable.IsClass = IsClass;</span><br><span class="line">    <span class="comment">-- 如果指定了父类，通过设置Class的元表为父类模拟继承</span></span><br><span class="line">    <span class="keyword">if</span> super <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(classtable, super)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">--print(&quot;如果定义的不是最基类，请确认是否require了父类!&quot;)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> classtable</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 提供实例化对象的方法接口</span></span><br><span class="line"><span class="comment">--- 模拟构造函数的递归调用，从最上层父类构造开始调用</span></span><br><span class="line"><span class="comment">---@param cls cls@类定义</span></span><br><span class="line"><span class="comment">---@param ... ...@构造函数变长参数</span></span><br><span class="line"><span class="comment">---@return cls@cls类的实例对象table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">New</span><span class="params">(cls, ...)</span></span></span><br><span class="line">    <span class="comment">-- 实例对象表</span></span><br><span class="line">    <span class="keyword">local</span> instance = &#123;&#125;</span><br><span class="line">    <span class="comment">-- 设置实例对象元表为cls类模拟类的封装访问</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(instance, cls)</span><br><span class="line">    <span class="comment">-- create模拟面向对象里构造函数的递归调用(从父类开始构造)</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">create</span></span><br><span class="line">    <span class="built_in">create</span> = <span class="function"><span class="keyword">function</span><span class="params">(cls, ...)</span></span></span><br><span class="line">        <span class="keyword">if</span> cls._super <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">create</span>(cls._super, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> cls.Ctor <span class="keyword">then</span></span><br><span class="line">            cls.Ctor(instance, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">create</span>(cls, ...)</span><br><span class="line">    <span class="keyword">return</span> instance</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---静态类</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>  <span class="title">StaticClass</span><span class="params">(clsname)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>上面的代码注释已经很清楚了，就不一一解释了。</p>
<p>理解上面Lua实现OOP的关键在于通过table模拟Class的抽象以及数据封装，通过metatable模拟继承特性。</p>
<h3 id="Class定义"><a href="#Class定义" class="headerlink" title="Class定义"></a>Class定义</h3><p>定义一个类的方式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">类名 = Class(<span class="string">&quot;类名&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 类名:<span class="title">Ctor</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">--成员变量定义</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--方法定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 类名:方法名<span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Class继承"><a href="#Class继承" class="headerlink" title="Class继承"></a>Class继承</h3><p>继承一个类的方式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">子类名 = Class(<span class="string">&quot;子类名&quot;</span>, 父类名)</span><br><span class="line"></span><br><span class="line"><span class="comment">--构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 子类名:<span class="title">Ctor</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">--成员变量定义</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--方法定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 子类名:方法名<span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Class对象实例化"><a href="#Class对象实例化" class="headerlink" title="Class对象实例化"></a>Class对象实例化</h3><p>Lua OOP对象实例化方式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> 变量名 = New(类名)</span><br><span class="line">变量名.成员变量</span><br><span class="line">变量名:成员方法()</span><br><span class="line">变量名.静态方法()</span><br></pre></td></tr></table></figure>

<h2 id="Lua只读Table"><a href="#Lua只读Table" class="headerlink" title="Lua只读Table"></a>Lua只读Table</h2><p>在游戏开发里，配置表数据往往是固定不允许修改的，无论是C#还是Lua，对于对象修改限制都只能通过上层封装实现此功能。</p>
<p>而这里我要学习了解的就是在Lua里实现ReadOnly table用于配置表，确保开发人员不会出现对配置表的错误操作。</p>
<p>参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/tkokof1/article/details/112850563">Sweet Snippet 之 Lua readonly table</a></p>
<h3 id="基础版只读Table"><a href="#基础版只读Table" class="headerlink" title="基础版只读Table"></a>基础版只读Table</h3><p>在Lua官网上其实已经给出了一版ReadOnly的基础实现思路:</p>
<p><a target="_blank" rel="noopener" href="https://www.lua.org/pil/13.4.5.html">Read-Only Tables</a></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readOnly</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123;       <span class="comment">-- create metatable</span></span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="string">&quot;attempt to update a read-only table&quot;</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">days = readOnly&#123;<span class="string">&quot;Sunday&quot;</span>, <span class="string">&quot;Monday&quot;</span>, <span class="string">&quot;Tuesday&quot;</span>, <span class="string">&quot;Wednesday&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Thursday&quot;</span>, <span class="string">&quot;Friday&quot;</span>, <span class="string">&quot;Saturday&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(days[<span class="number">1</span>])     <span class="comment">--&gt; Sunday</span></span><br><span class="line">days[<span class="number">2</span>] = <span class="string">&quot;Noday&quot;</span>  <span class="comment">--&gt; stdin:1: attempt to update a read-only table</span></span><br></pre></td></tr></table></figure>

<p>通过上面的事例可以看出，设计Readonly table的核心思想是通过**__index**(访问不存在Key时触发)和**__newindex**(赋值不存在Key时触发)元方法来接手所有的table访问赋值。</p>
<p>为了确保**__index<strong>和</strong>__newindex<strong>的触发，我们需要通过实现一个空table作为代理table来实现所有的Key访问和赋值都能触发</strong>__index<strong>和</strong>__newindex**，然后通过实现**__index<strong>和</strong>__newindex**将数据访问赋值指向原始table来实现数据访问和ReadOnly功能。</p>
<h3 id="进阶版只读Table-支持-和pairs"><a href="#进阶版只读Table-支持-和pairs" class="headerlink" title="进阶版只读Table(支持#和pairs)"></a>进阶版只读Table(支持#和pairs)</h3><p>上面的事例代码虽然实现了基础的ReadOnly功能，但当我们采用#或pairs访问数据长度和数据时会发现，访问不到数据，原因是因为我们的代理table本来就没有数据并且我们也没有自己实现**__len<strong>和</strong>__pairs**元方法指向原始数据访问导致的。所以进阶版ReadOnly实现如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReadOnly</span> <span class="params">(t, name)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123;       <span class="comment">-- create metatable</span></span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;attempt to update a read-only table:%s&quot;</span>, name))</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        <span class="built_in">__len</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> #t</span><br><span class="line">	    <span class="keyword">end</span>,</span><br><span class="line">        __pairs = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">next</span>, t, <span class="literal">nil</span></span><br><span class="line">	    <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> originalTable = &#123;&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(originalTable, <span class="string">&quot;A&quot;</span>)</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(originalTable, <span class="string">&quot;C&quot;</span>)</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(originalTable, <span class="string">&quot;B&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> readOnlyTable = ReadOnly(originalTable, <span class="string">&quot;readOnlyTable&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(#readOnlyTable)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(readOnlyTable) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(key)</span><br><span class="line">	<span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(readOnlyTable) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(index)</span><br><span class="line">	<span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line">readOnlyTable[<span class="number">3</span>] = <span class="string">&quot;BB&quot;</span></span><br><span class="line"><span class="comment">--readOnlyTable[4] = &quot;D&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/ReadOnlyTableOutput.png" alt="ReadOnlyTableOutput"></p>
<p>可以看到，通过重写**__len<strong>和</strong>__pairs**我们已经支持了ReadOnly的长度获取和pairs遍历访问。</p>
<h3 id="完善版只读Table-支持递归ReadOnly"><a href="#完善版只读Table-支持递归ReadOnly" class="headerlink" title="完善版只读Table(支持递归ReadOnly)"></a>完善版只读Table(支持递归ReadOnly)</h3><p>经过上面的努力我们已经支持了#和pairs的遍历操作，但我们的只读Table还只支持了一层，也就是说嵌套的table并没有支持只读设定。</p>
<p>实现思路:</p>
<ol>
<li>递归对所有的table调用ReadOnly方法</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 转换table成只读table</span></span><br><span class="line"><span class="comment">---@param t table @需要变成ReadOnly的table</span></span><br><span class="line"><span class="comment">---@param name string @ReadOnly table的名字(方便报错打印定位)</span></span><br><span class="line"><span class="comment">---@param depth number @只读table深度</span></span><br><span class="line"><span class="comment">---@return table @转换后的只读table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReadOnlyTable</span><span class="params">(t, name, depth)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(t) ~= <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">&quot;not support none table to a recusive read-only table!&quot;</span>)</span><br><span class="line"> 		<span class="keyword">return</span> t</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	depth = depth <span class="keyword">or</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> depth &gt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    	<span class="keyword">local</span> nextDepth = depth - <span class="number">1</span></span><br><span class="line">	    <span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">	    	<span class="keyword">if</span> <span class="built_in">type</span>(value) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">	    		t[key] = ReadOnlyTable (t[key], name, nextDepth)</span><br><span class="line">	    	<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123;</span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;attempt to update a read-only table:%s&quot;</span>, name))</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        <span class="built_in">__len</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> #t</span><br><span class="line">	    <span class="keyword">end</span>,</span><br><span class="line">        __pairs = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">next</span>, t, <span class="literal">nil</span></span><br><span class="line">	    <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> originalTable = &#123;&#125;</span><br><span class="line">originalTable[<span class="string">&quot;A&quot;</span>] = <span class="string">&quot;A&quot;</span></span><br><span class="line">originalTable[<span class="string">&quot;NestTable&quot;</span>] = &#123;</span><br><span class="line">	[<span class="string">&quot;Nest_A&quot;</span>] = <span class="string">&quot;Nest_A&quot;</span>,</span><br><span class="line">	[<span class="string">&quot;Nest_B&quot;</span>] = <span class="string">&quot;Nest_B&quot;</span>,</span><br><span class="line">	[<span class="string">&quot;NestNestTable&quot;</span>] = &#123;</span><br><span class="line">		[<span class="string">&quot;Nest_Nest_A&quot;</span>] = <span class="string">&quot;Nest_Nest_A&quot;</span>,</span><br><span class="line">		[<span class="string">&quot;Nest_Nest_B&quot;</span>] = <span class="string">&quot;Nest_Nest_B&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">originalTable[<span class="string">&quot;B&quot;</span>] = <span class="string">&quot;B&quot;</span></span><br><span class="line"><span class="keyword">local</span> readOnlyTable = ReadOnlyTable(originalTable, <span class="string">&quot;readOnlyTable&quot;</span>, <span class="number">2</span>)</span><br><span class="line">print_table(readOnlyTable)</span><br><span class="line"><span class="built_in">print</span>(#readOnlyTable)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(readOnlyTable) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(key)</span><br><span class="line">	<span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="comment">--readOnlyTable[&quot;A&quot;] = &quot;AA&quot; --&gt; ReadOnly Error</span></span><br><span class="line"><span class="comment">--readOnlyTable[&quot;NestTable&quot;][&quot;Nest_A&quot;] = &quot;Nest_AA&quot; --&gt; ReadOnly Error</span></span><br><span class="line">readOnlyTable[<span class="string">&quot;NestTable&quot;</span>][<span class="string">&quot;NestNestTable&quot;</span>][<span class="string">&quot;Nest_Nest_A&quot;</span>] = <span class="string">&quot;Nest_Nest_AA&quot;</span></span><br><span class="line">print_table(readOnlyTable)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/RecusiveReadOnlyTableOuput.png" alt="RecusiveReadOnlyTableOuput"></p>
<p>通过上面的完善，我们成功的实现了支持指定深度的ReadOnly表实现。</p>
<h3 id="优化点"><a href="#优化点" class="headerlink" title="优化点"></a>优化点</h3><ol>
<li><strong>考虑到原表的性能开销，我们可以在开发期开启ReadOnly表的设计，发包后直接采用原始表访问的方式来优化掉这部分性能开销</strong></li>
</ol>
<h2 id="Lua回调绑定"><a href="#Lua回调绑定" class="headerlink" title="Lua回调绑定"></a>Lua回调绑定</h2><p>在Lua里函数有着第一类值的说法(在Lua中函数和其他值（数值、字符串）一样，函数可以被存放在变量中，也可以存放在表中，可以作为函数的参数，还可以作为函数的返回值。)。</p>
<p>很多时候我们想传递一个类方法作为回调方法，希望回来的时候是自带self，如果我们只按以下写法来使用，我们将丢掉self这个上下文:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> testHandler = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:FuncWithoutParams</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;testHandler:FuncWithoutParams()&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:TestHandler</span><span class="params">(cb)</span></span>    </span><br><span class="line">	cb()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">testHandler:TestHandler(testHandler.FuncWithoutParams)</span><br></pre></td></tr></table></figure>

<p>所以为了封装self的，我们需要通过闭包机制来实现一个handler，以下代码实现了带参和不带参的handler.lua版本:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:      Handler.lua</span></span><br><span class="line"><span class="comment">-- Description:    带self的回调绑定</span></span><br><span class="line"><span class="comment">-- Author:         TonyTang</span></span><br><span class="line"><span class="comment">-- Create Date:    2021/6/5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 无参委托绑定</span></span><br><span class="line"><span class="comment">---@param obj table @对象</span></span><br><span class="line"><span class="comment">---@param method func() @方法</span></span><br><span class="line"><span class="comment">---@return func() @委托绑定无参方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler</span><span class="params">(obj, method)</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">		method(obj)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 带参委托绑定</span></span><br><span class="line"><span class="comment">---@param obj table @对象</span></span><br><span class="line"><span class="comment">---@param method func() @方法</span></span><br><span class="line"><span class="comment">---@param ... any @参数</span></span><br><span class="line"><span class="comment">---@return func(...) @委托绑定带参方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlerBind</span><span class="params">(object, method, ...)</span></span></span><br><span class="line">	<span class="keyword">local</span> params = <span class="built_in">table</span>.pack(...)</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">		method(obj, <span class="built_in">table</span>.<span class="built_in">unpack</span>(params))</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> testHandler = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:FuncWithoutParams</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;testHandler:FuncWithoutParams()&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:FuncWithParams</span><span class="params">(param1, param2, param3)</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;testHandler:FuncWithParams(%s, %s, %s)&quot;</span>, param1, param2, param3))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:TestHandler</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">local</span> handler = <span class="built_in">_G</span>.handler(<span class="built_in">self</span>, <span class="built_in">self</span>.FuncWithoutParams)</span><br><span class="line">	handler()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:TestHandlerBind</span><span class="params">(param1, param2, param3)</span></span></span><br><span class="line">	<span class="keyword">local</span> handlerBind = <span class="built_in">_G</span>.handlerBind(<span class="built_in">self</span>, <span class="built_in">self</span>.FuncWithParams, param1, param2, param3)</span><br><span class="line">	handlerBind()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">testHandler:TestHandler()</span><br><span class="line">testHandler:TestHandlerBind(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">testHandler:TestHandlerBind(<span class="number">1</span>, <span class="literal">nil</span>, <span class="number">3</span>)</span><br><span class="line">testHandler:TestHandlerBind(<span class="literal">nil</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/HandlerOutput.PNG" alt="HandlerOutput"></p>
<p>但上面这种设计，还不支持自定义传参的基础上保留自定义函数传参：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function testHandler:FuncWithParams(...)</span><br><span class="line">	print(<span class="string">&quot;testHandler:FuncWithParams()&quot;</span>)</span><br><span class="line">    print(...)</span><br><span class="line">end</span><br><span class="line">    </span><br><span class="line">function testHandler:TestHandlerBind(...)</span><br><span class="line">	local handlerBind = _G.handlerBind(self, self.FuncWithParams, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>)</span><br><span class="line">	handlerBind(...)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">testHandler:TestHandlerBind(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>理论上上面这种情况，我们预期的testHandler:FuncWithParams()最终调用传入的参数为2+N个(“param1”+”param2”+…)</p>
<p><strong>实现上面的需求，核心我们需要利用table.pack和table.unpack的机制(但要注意table.unpack(tb)默认效果等价于table.unpack(tb, 1, #tb)即会被nil打断的，这个不是我们希望看到的)。</strong></p>
<p><strong>解决上述问题，我们只需要通过封装参数pack和unpack过程，并明确指定table.unpack(tb, 1, count)的方式来解决被nil打断的情况，最终handler.lua代码如下:</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">-- File Name:      Handler.lua</span><br><span class="line">-- Description:    带self的回调绑定</span><br><span class="line">-- Author:         TonyTang</span><br><span class="line">-- Create Date:    <span class="number">2021</span>/<span class="number">6</span>/<span class="number">5</span></span><br><span class="line"></span><br><span class="line">--- 无参委托绑定</span><br><span class="line">---@param obj table @对象</span><br><span class="line">---@param <span class="function">method <span class="title">func</span>() @方法</span></span><br><span class="line"><span class="function">---@<span class="keyword">return</span> <span class="title">func</span>() @委托绑定无参方法</span></span><br><span class="line"><span class="function">function <span class="title">handler</span>(<span class="params">obj, method</span>)</span></span><br><span class="line"><span class="function">	<span class="keyword">return</span> <span class="title">function</span>(<span class="params">...</span>)</span></span><br><span class="line"><span class="function">		<span class="title">method</span>(<span class="params">obj, ...</span>)</span></span><br><span class="line"><span class="function">	end</span></span><br><span class="line"><span class="function">end</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">--- 带参委托绑定</span></span><br><span class="line"><span class="function">---@param obj table @对象</span></span><br><span class="line"><span class="function">---@param method <span class="title">func</span>() @方法</span></span><br><span class="line"><span class="function">---@param ... any @可变长参数</span></span><br><span class="line"><span class="function">---@<span class="keyword">return</span> <span class="title">func</span>(<span class="params">...</span>) @委托绑定带参方法</span></span><br><span class="line"><span class="function">function <span class="title">handlerBind</span>(<span class="params"><span class="built_in">object</span>, method, ...</span>)</span></span><br><span class="line"><span class="function">	local <span class="keyword">params</span></span> = SafePack(...)</span><br><span class="line">	<span class="keyword">return</span> function(...)</span><br><span class="line">		local params2 = SafePack(...)</span><br><span class="line">		local concateParams = ConcatePack(<span class="keyword">params</span>, params2)</span><br><span class="line">		method(obj, SaveUnpack(concateParams))</span><br><span class="line">	end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--- 安全Pack(解决原生pack的nil截断问题, SafePack与SafeUnpack要成对使用)</span><br><span class="line">---@return table @pack后的参数<span class="function">table</span></span><br><span class="line"><span class="function">function <span class="title">SafePack</span>(<span class="params">...</span>)</span></span><br><span class="line"><span class="function">    local <span class="keyword">params</span></span> = &#123;...&#125;</span><br><span class="line">    <span class="keyword">params</span>.n = <span class="keyword">select</span>(<span class="string">&quot;#&quot;</span>, ...)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">params</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--- 安全Unpack(解决原生unpack被nil阶段问题, SafePack与SafeUnpack要成对使用)</span><br><span class="line">---@return ... @unpack后的参数列表</span><br><span class="line"><span class="function">function <span class="title">SaveUnpack</span>(<span class="params">parakParams</span>)</span></span><br><span class="line"><span class="function">	--- 使用table.<span class="title">unpack</span>()显示指定起始值和数量的方式避免被nil打断</span></span><br><span class="line"><span class="function">	<span class="keyword">return</span> table.<span class="title">unpack</span>(<span class="params">parakParams, <span class="number">1</span>, parakParams.n</span>)</span></span><br><span class="line"><span class="function">end</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">--- 合并参数</span></span><br><span class="line"><span class="function">---@param packParams1 table @已经pack的参数table1</span></span><br><span class="line"><span class="function">---@param packParams2 table @已经pack的参数table2</span></span><br><span class="line"><span class="function">---@<span class="keyword">return</span> table @合并pack后table</span></span><br><span class="line"><span class="function">function <span class="title">ConcatePack</span>(<span class="params">packParams1, packParams2</span>)</span></span><br><span class="line"><span class="function">	--- 基于table.pack和table.unpack机制合并参数</span></span><br><span class="line"><span class="function">	local finalParams</span> = &#123;&#125;</span><br><span class="line">	local params1Count = packParams1.n</span><br><span class="line">	<span class="keyword">for</span> i = <span class="number">1</span>, params1Count, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">		finalParams[i] = packParams1[i]</span><br><span class="line">	end</span><br><span class="line">	local params2Count = packParams2.n</span><br><span class="line">	<span class="keyword">for</span> i = <span class="number">1</span>, params2Count, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">		finalParams[params1Count + i] = packParams2[i]</span><br><span class="line">	end</span><br><span class="line">	finalParams.n = params1Count + params2Count</span><br><span class="line">	<span class="keyword">return</span> finalParams</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li><strong>table.unpack()默认是table.unpack(tb, 1, #tb),所以如果传递了nil的话是会被打断无法返回所有的</strong></li>
</ol>
<h2 id="Lua小知识"><a href="#Lua小知识" class="headerlink" title="Lua小知识"></a>Lua小知识</h2><ol>
<li><p>Lua里没有Class只有通过Table模拟的Class<br>参考前面的Lua OOP实现</p>
</li>
<li><p>Lua里没有this的概念，self不等价于this，函数调用传的是谁谁就是self。Lua里.定义和:定义相对于self的用法来说相当于静态和成员定义。<br>Lua里通过.调用的话是不会默认传递自身作为self的，不主动传的话self为空<br>Lua里通过:调用的话默认第一个参数就是调用者，既self</p>
</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tab.dotFunc</span><span class="params">(param)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;self = &quot;</span>, <span class="built_in">self</span>)</span><br><span class="line">    <span class="built_in">print</span>(param)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tab:colonFunc</span><span class="params">(param)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;self = &quot;</span>, <span class="built_in">self</span>)</span><br><span class="line">    <span class="built_in">print</span>(param)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">tab.dotFunc(<span class="number">1</span>)</span><br><span class="line">tab:colonFunc(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<pre><code>![LuaDotAndColon](/img/Lua/LuaDotAndColon.png)
Note:
:只是起了省略第一个参数self的作用，该self指向调用者本身，并没有其他特殊的地方。
</code></pre>
<ol start="3">
<li><p>Lua中的函数是带有词法定界（lexical scoping）的第一类值（first-class values）(在Lua中函数和其他值（数值、字符串）一样，函数可以被存放在变量中，也可以存放在表中，可以作为函数的参数，还可以作为函数的返回值)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class:Func</span><span class="params">(param1, func)</span></span></span><br><span class="line">    <span class="built_in">print</span>(param1)</span><br><span class="line">    func()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">myfunc = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;tempFunc()&quot;</span>) <span class="keyword">end</span></span><br><span class="line">class:Func(<span class="number">1</span>, myfunc)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaFirstClassValues.png" alt="LuaFirstClassValues"></p>
</li>
<li><p>指定Lua搜索文件路径</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">package</span>.<span class="built_in">path</span> = *</span><br></pre></td></tr></table></figure>

<p>package.path是在Lua触发require时会去搜索的路径，默认是LUA_PATH_5_3或者LUA_PATH，详情参考:<a target="_blank" rel="noopener" href="https://www.lua.org/manual/5.3/manual.html#pdf-package.path">Lua Manual</a></p>
</li>
<li><p>Lua文件热重载<br>Lua通过require加载进来的文件都会被记录在package.loaded里，所以Lua热重载的核心就是让pacakge.loaded里的对应Lua文件清除后重新加载。</p>
 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---热重载指定Lua脚本</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reloadLua</span><span class="params">(filename)</span></span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">package</span>.<span class="built_in">loaded</span>[filename] == <span class="literal">nil</span>) <span class="keyword">then</span></span><br><span class="line">        Log.<span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;lua脚本 : %s 未被加载&quot;</span>, filename))</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        Log.<span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;lua脚本 : %s 已加载&quot;</span>, filename))</span><br><span class="line">        <span class="comment">--重置loaded信息</span></span><br><span class="line">        <span class="built_in">package</span>.<span class="built_in">loaded</span>[filename] = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">--重新加载Lua脚本</span></span><br><span class="line">    <span class="built_in">require</span>(filename)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Lua里pairs和ipairs有区别。pairs是key，value的形式遍历所有值。ipairs是从1开始按顺序递增遍历。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">testtab = &#123;[<span class="number">1</span>] = <span class="string">&quot;Tony&quot;</span>, [<span class="number">4</span>] = <span class="string">&quot;Huan&quot;</span>, [<span class="number">2</span>] = <span class="string">&quot;Tang&quot;</span>, [<span class="number">5</span>] = <span class="literal">nil</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(testtab) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k)</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(testtab) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaPairsAndIpairs.png" alt="LuaPairsAndIpairs"></p>
<p>Note:<br><strong>pairs不会被nil打断但ipairs都会被nil打断</strong><br><strong>ipairs还会被不是按1递增的打断</strong></p>
</li>
<li><p>Lua参数传递<br>Lua里通过arg[?]的形式访问传入的参数，默认第一个参数是arg[1]，arg[0]是lua脚本自身</p>
</li>
<li><p>Lua里面可以通过#得到table长度<br>Note:<br><strong>#会被nil打断</strong></p>
</li>
<li><p>Lua里打印数据类型用type</p>
</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="string">&quot;Tony&quot;</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaType.png" alt="LuaType">  </p>
<h1 id="Lua常用插件"><a href="#Lua常用插件" class="headerlink" title="Lua常用插件"></a>Lua常用插件</h1><h2 id="luarocks"><a href="#luarocks" class="headerlink" title="luarocks"></a>luarocks</h2><p><a target="_blank" rel="noopener" href="https://luarocks.org/"><strong>LuaRocks</strong> is the package manager for Lua modules.</a></p>
<p>从官方的介绍可以看出，LuaRocks相对于Lua，就好比Package Ctronl在Sublime Text里的存在，主要目的就是包管理器，方便Lua快速安装各种第三方Lua库。</p>
<p>根据官方的教程，LuaRocks安装设置相当复杂，单纯下载一个exe还有很多环境问题要处理。</p>
<p>这里本人不想使用官方<a target="_blank" rel="noopener" href="https://github.com/luarocks/luarocks/wiki/Installation-instructions-for-Windows/_edit">Installation instructions for Windows</a><a target="_blank" rel="noopener" href="https://github.com/luarocks/luarocks/wiki/_new">New Page</a>]的一键安装方式，主要是希望能用Lua5.3，他一键安装的方式好像是Lua5.1，所以最后打算把Lua和LuaRocks都按照以下博主的方式从源码编译走一遍流程:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/techfield/article/details/82896403">Windows 平台 Luarocks 3.0.2 编译安装</a></p>
<ul>
<li><p>安装<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/mingw-w64/">MinGW</a>(用于编译源码)</p>
<p>添加**&#x2F;MinGW&#x2F;bin到环境变量，确保gcc编译器能找到.</p>
<p><img src="/img/Lua/WhereMinGW.png" alt="WhereMinGW"></p>
<p>关于MinGW和Cygwin的区别这里暂时不深入，详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1343059">MinGw与Cygwin的区别</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1343059">MinGW 的主要方向是让GCC的Windows移植版能使用Win32API来编程。 Cygwin 的目标是能让Unix-like下的程序代码在Windows下直接被编译。</a></p>
<p>这里考虑到这里的主要目的是编译Windows版的Lua5.3，用哪一个都行，暂时是用MinGW了。</p>
</li>
<li><p>编译Lua5.3</p>
<p>下载<a target="_blank" rel="noopener" href="https://www.lua.org/ftp/">Lua5.3源码</a></p>
<p>MinGW安装好后，编译Lua5.3就很容易了，因为Lua5.3里面自带了MakeFile(指定make如何编译的文件，这里暂时不深入学习)，通过命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mingw32-make mingw</span><br></pre></td></tr></table></figure>

<p>就能触发编译Lua5.3，但为了LuaSocks后续会用到的相关目录准备工作，这里还是采用前面<a target="_blank" rel="noopener" href="https://blog.csdn.net/techfield/article/details/82896403">博主</a>提供的build.bat:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">:: ========================</span><br><span class="line">:: build.bat</span><br><span class="line">::</span><br><span class="line">:: build lua to dist folder</span><br><span class="line">:: tested with lua-<span class="number">5</span>.<span class="number">3</span>.<span class="number">5</span></span><br><span class="line">:: based on:</span><br><span class="line">:: https://medium.com/@CassiusBenard/lua-basics-windows-<span class="number">7</span>-installation-and-running-lua-files-from-the-command-line-e8196e988d71</span><br><span class="line">:: ========================</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line">:: you may change the following variable’s value</span><br><span class="line">:: to suit the downloaded version</span><br><span class="line"><span class="built_in">set</span> work_dir=%~dp0</span><br><span class="line">:: Removes trailing backslash</span><br><span class="line">:: to enhance readability <span class="keyword">in</span> the following steps</span><br><span class="line"><span class="built_in">set</span> work_dir=<span class="variable">%work_dir:~0,-1%</span></span><br><span class="line"><span class="built_in">set</span> lua_install_dir=<span class="variable">%work_dir%</span>\dist</span><br><span class="line"><span class="built_in">set</span> compiler_bin_dir=<span class="variable">%work_dir%</span>\tdm-gcc\bin</span><br><span class="line"><span class="built_in">set</span> lua_build_dir=<span class="variable">%work_dir%</span></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">path</span>=<span class="variable">%compiler_bin_dir%</span>;<span class="variable">%path%</span></span><br><span class="line"><span class="built_in">cd</span> /D <span class="variable">%lua_build_dir%</span></span><br><span class="line">mingw32-make PLAT=mingw</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="built_in">echo</span> **** COMPILATION TERMINATED ****</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="built_in">echo</span> **** BUILDING BINARY DISTRIBUTION ****</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line">:: create a clean “binary” installation</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\doc</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\bin</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\include</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\lib</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\doc\*.* <span class="variable">%lua_install_dir%</span>\doc\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\*.exe <span class="variable">%lua_install_dir%</span>\bin\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\*.dll <span class="variable">%lua_install_dir%</span>\bin\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\luaconf.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lua.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lualib.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lauxlib.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lua.hpp <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\liblua.a <span class="variable">%lua_install_dir%</span>\lib\liblua.a</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="built_in">echo</span> **** BINARY DISTRIBUTION BUILT ****</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="variable">%lua_install_dir%</span>\bin\lua.exe -e &quot;<span class="built_in">print</span> [[Hello!]];<span class="built_in">print</span>[[Simple Lua test successful<span class="variable">!!!</span>]]&quot;</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"></span><br><span class="line">:: configure environment variable</span><br><span class="line">:: https://stackoverflow.com/a/<span class="number">21606502</span>/<span class="number">4394850</span></span><br><span class="line">:: http://lua-users.org/wiki/LuaRocksConfig</span><br><span class="line">:: SETX - <span class="built_in">Set</span> an environment variable permanently.</span><br><span class="line">:: /m <span class="built_in">Set</span> the variable <span class="keyword">in</span> the system environment HKLM.</span><br><span class="line">setx LUA &quot;<span class="variable">%lua_install_dir%</span>\bin\lua.exe&quot; /m</span><br><span class="line">setx LUA_BINDIR &quot;<span class="variable">%lua_install_dir%</span>\bin&quot; /m</span><br><span class="line">setx LUA_INCDIR &quot;<span class="variable">%lua_install_dir%</span>\include&quot; /m</span><br><span class="line">setx LUA_LIBDIR &quot;<span class="variable">%lua_install_dir%</span>\lib&quot; /m</span><br><span class="line"></span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure>

<p>这样一来Lua编译以及Lua环境变量设置就搞定了:</p>
<p><img src="/img/Lua/LuaBuildOutput.png" alt="LuaBuildOutput"></p>
<p><img src="/img/Lua/LuaEnvSetting.png" alt="LuaEnvSetting"></p>
<p>测试以下Lua使用：</p>
<p><img src="/img/Lua/MakeSureLuaExits.png" alt="MakeSureLuaExits"></p>
<p>Note：</p>
<ol>
<li><strong>因为我们使用的是MinGW，所以博客上的make命令是找不到的需要用mingw32-make</strong></li>
<li><strong>因为涉及到设置环境变量等操作所以启动cmd或者powershell运行bat时需要以管理员身份</strong></li>
<li><strong>上文的Lua环境变量设置并未设置Lua到Path中，所以还需要单独添加Lua&#x2F;bin到能确保Lua能被找到使用</strong></li>
</ol>
</li>
<li><p>编译LuaRocks</p>
<p>下载<a target="_blank" rel="noopener" href="http://luarocks.github.io/luarocks/releases/">LuaRocks源码</a>(下一键带Install.bat的)</p>
<p>执行Install.bat触发编译流程</p>
<p><img src="/img/Lua/LuaRocksInstallCommand.png" alt="LuaRocksInstallCommand"></p>
<p>详细参数介绍参考:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/luarocks/luarocks/wiki/Installation-instructions-for-Windows">Installation instructions for Windows</a></p>
<p>最后看到LuaRocks安装成功:</p>
<p><img src="/img/Lua/LuaRocksInstallSuccess.png" alt="LuaRocksInstallSuccess"></p>
<p>最后将LuaRocks&#x2F;systree&#x2F;bin所在目录添加到环境变量Path里，这样通过LuaRocks安装的第三方库就可以使用了(经测试单独只加到Path里还不行(好像是因为Lua和LuaRocks默认分开安装的)，package.path里默认是不会去LuaRocks&#x2F;systree&#x2F;bin下找的)，需要执行以下命令来查看手动设置LUA_PATH所需的位置信息：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luarocks <span class="built_in">path</span> --bin</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaRocksPathAndCPath.png" alt="LuaRocksPathAndCPath"></p>
<p>原本的LUA_PATH和LUACPATH信息：</p>
<p><img src="/img/Lua/OrignalLuaPathAndCPath.png" alt="OrignalLuaPathAndCPath"></p>
<p>把上面两个手动设置到环境变量LUA_PATH和LUA_CPATH里:</p>
<p><img src="/img/Lua/LuaEnviromentSetting.png" alt="LuaEnviromentSetting"></p>
</li>
</ul>
<p>接下来测试LuaRocks的使用：</p>
<p>我们尝试安装serpent：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luarocks install serpent</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/InstallSerpent.png" alt="InstallSerpent"></p>
<p><img src="/img/Lua/SerpentInstallatio.png" alt="SerpentInstallatio"></p>
<p>后续会讲到serpent的使用学习，到这里Lua5.3和LuaRocks以及serpent的LuaRocks快速安装就全部结束了。</p>
<h2 id="serpent"><a href="#serpent" class="headerlink" title="serpent"></a>serpent</h2><p><a target="_blank" rel="noopener" href="https://github.com/pkulchenko/serpent">Lua serializer and pretty printer.</a></p>
<p>从Git上的介绍可以看出，Serpent是一个支持序列化反序列化以及格式化打印的第三方库。</p>
<p>比如我们希望把内存里的某个Table序列化到本地，支持下一次反序列化加载：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SerpentStudy!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;DIYLog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> serpent = <span class="built_in">require</span> <span class="string">&quot;serpent&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> serializeDataTable = &#123;</span><br><span class="line">	[<span class="string">&quot;Name&quot;</span>] = <span class="string">&quot;TonyTang&quot;</span>,</span><br><span class="line">	detailInfo = &#123;</span><br><span class="line">		[<span class="string">&quot;Age&quot;</span>] = <span class="number">18</span>,</span><br><span class="line">		[<span class="string">&quot;BirthDate&quot;</span>] = <span class="string">&quot;2000/01/01&quot;</span>,</span><br><span class="line">		[<span class="string">&quot;Adrress&quot;</span>] = <span class="string">&quot;SiChuan&quot;</span>		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> serializeString = serpent.<span class="built_in">dump</span>(serializeDataTable)</span><br><span class="line"><span class="built_in">print</span>(serializeString)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> formatSerializeString = serpent.block(serializeDataTable)</span><br><span class="line"><span class="built_in">print</span>(formatSerializeString)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> result, deserializeDataTable = serpent.<span class="built_in">load</span>(formatSerializeString)</span><br><span class="line">print_table(deserializeDataTable)</span><br></pre></td></tr></table></figure>

<p>输出:</p>
<p><img src="/img/Lua/SerpentOutput.png" alt="SerpentOutput"></p>
<p>从上面测试用例结果可以看出，通过Serpent我们轻易的做到了Lua序列化反序列化以及格式化输出</p>
<h2 id="Lpeg"><a href="#Lpeg" class="headerlink" title="Lpeg"></a>Lpeg</h2><p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/"><em>LPeg</em> is a new pattern-matching library for Lua, based on Parsing Expression Grammars (PEGs). </a></p>
<p>从官方的介绍可以看出Lpeg是一个类似正则的但并不是正则的新一代(基于Parsing Expression Grammars)的模式匹配Lua库。</p>
<p>那么什么是Parsing Expression Grammars了？</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Parsing_expression_grammar"> a <strong>parsing expression grammar</strong> (<strong>PEG</strong>), is a type of analytic formal grammar, i.e. it describes a formal language in terms of a set of rules for recognizing strings in the language.</a></p>
<p>根据Wiki的介绍可以看出Parsing Expression Grammars就是我们编程语言里的解析表达式语法。</p>
<p>为了进一步的深入学习和使用，让我们先通过Luasocks安装Lpeg库。</p>
<p><img src="/img/Lua/LpegInstallation.png" alt="LpegInstallation"></p>
<p>接下来文档<a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/">Lpeg</a>和下面这篇文章<a target="_blank" rel="noopener" href="https://www.cnblogs.com/freeblues/p/8436523.html">通过 LPeg 介绍解析表达式语法(Parsing Expression Grammars)</a>来深入学习Lpeg的设计和使用:</p>
<h3 id="Pattern"><a href="#Pattern" class="headerlink" title="Pattern"></a>Pattern</h3><p>Pattern差不多可以理解成正则里的匹配表达式。</p>
<p>为了方便理解，这里先截图下Lpeg Pattern相关定义的基础介绍:</p>
<p><img src="/img/Lua/LpegPatternsDoc.png" alt="LpegPatternsDoc"></p>
<h3 id="Match"><a href="#Match" class="headerlink" title="Match"></a>Match</h3><p>Match也和正则里的概念差不多，就是触发指定字符串使用指定Pattern进行匹配的一个过程，同时返回匹配相关结果(比如返回匹配到的字符位置的下一个字符位置。或者通过Capture函数将匹配结果转换成指定值)</p>
<p>了解了Lpeg里面的一些基础Pattern定义后，让我们看看Lpeg里匹配函数match的介绍:</p>
<p>lpeg.match (pattern, subject [, init])</p>
<p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/">The matching function. It attempts to match the given pattern against the subject string. If the match succeeds, returns the index in the subject of the first character after the match, or the captured values(if the pattern captured any value).</a></p>
<p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/">Unlike typical pattern-matching functions, <code>match</code> works only in <em>anchored</em> mode; that is, it tries to match the pattern with a prefix of the given subject string (at position <code>init</code>), not with an arbitrary substring of the subject. So, if we want to find a pattern anywhere in a string, we must either write a loop in Lua or write a pattern that matches anywhere.</a></p>
<p>从上面的介绍可以看出，match匹配成功会返回匹配位置的下一个位置或者是捕获到的值(后续会讲到<strong>捕获函数</strong>相关)。同时match不想正则可以把所有匹配都找出来而是需要通过自行通过match的init方式来loop所有捕获后的子字符串来找出所有匹配的结果。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/freeblues/p/8436523.html">默认情况下，成功匹配时，<code>LPeg</code> 将返回字符消耗数(译者注: 也就是成功匹配子串之后的下一个字符的位置). 如果你只是想看看是否匹配这就足够好了，但如果你试图解析出字符串的结构来，你必须用一些 <code>LPeg</code> 的捕获(<code>capturing</code>)函数.</a></li>
</ol>
<h3 id="Capture"><a href="#Capture" class="headerlink" title="Capture"></a>Capture</h3><p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/#captures">A <em>capture</em> is a pattern that produces values (the so called <em>semantic information</em>) according to what it matches. LPeg offers several kinds of captures, which produces values based on matches and combine these values to produce new values. Each capture may produce zero or more values.</a></p>
<p>从介绍大概理解Capture也是一种Pattern，但它是一种基于Pattern匹配结果转换出结果值的Pattern而不是常规的匹配Pattern(个人理解就好比Pattern+转换函数)。</p>
<p>为了方便理解，这里先截图下Capture相关定义的基础介绍:</p>
<p><img src="/img/Lua/LpegCaptureDoc.png" alt="LpegCaptureDoc"></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/#captures">A capture pattern produces its values only when it succeeds.</a>(Capture Pattern只会在成功时计算值)</li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;LpegStudy&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;DIYLog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 最终目标：</span></span><br><span class="line"><span class="comment">--- 1. &#123;***&#125;占位替换 </span></span><br><span class="line"><span class="comment">--- 2. &#123;num string1 | string2 | string3 &#125;根据num选择对应字符串</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> lpeg = <span class="built_in">require</span>(<span class="string">&quot;lpeg&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> <span class="built_in">match</span> = lpeg.<span class="built_in">match</span></span><br><span class="line"><span class="keyword">local</span> P = lpeg.P</span><br><span class="line"><span class="keyword">local</span> R = lpeg.R</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 普通匹配</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;普通匹配:&quot;</span>)</span><br><span class="line"><span class="comment">--- 不匹配，返回nil</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(P(<span class="string">&quot;hello&quot;</span>), <span class="string">&quot;world&quot;</span>))</span><br><span class="line"><span class="comment">--- 一个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(P(<span class="string">&quot;hello&quot;</span>), <span class="string">&quot;hello&quot;</span>))</span><br><span class="line"><span class="comment">--- 一个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(P(<span class="string">&quot;hello&quot;</span>), <span class="string">&quot;helloworld&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 模式组合</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;模式组合:&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> helloPattern = P(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> worldPattern = P(<span class="string">&quot;world&quot;</span>)</span><br><span class="line"><span class="comment">--- *表示匹配pattern1后面跟随pattern2</span></span><br><span class="line"><span class="keyword">local</span> helloAndworldPattern = helloPattern * worldPattern</span><br><span class="line"><span class="comment">--- +表示匹配pattern1或者pattern2</span></span><br><span class="line"><span class="keyword">local</span> helloOrworldPattern = helloPattern + worldPattern</span><br><span class="line"><span class="comment">--- 一个匹配，返回11</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloAndworldPattern, <span class="string">&quot;helloworld&quot;</span>))</span><br><span class="line"><span class="comment">--- 不匹配，返回nil</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloAndworldPattern, <span class="string">&quot;worldhello&quot;</span>))</span><br><span class="line"><span class="comment">--- 1个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloOrworldPattern, <span class="string">&quot;helloworld&quot;</span>))</span><br><span class="line"><span class="comment">--- 1个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloOrworldPattern, <span class="string">&quot;worldhello&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 解析数字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;解析数字:&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> integerPattern = R(<span class="string">&quot;09&quot;</span>)^<span class="number">1</span></span><br><span class="line"><span class="comment">--- 解析数字带捕获函数</span></span><br><span class="line"><span class="keyword">local</span> integerCapturePattern = R(<span class="string">&quot;09&quot;</span>)^<span class="number">1</span> / <span class="built_in">tonumber</span></span><br><span class="line"><span class="comment">--- 匹配，返回5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(integerPattern, <span class="string">&quot;2923 2924&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，返回2923</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(integerCapturePattern, <span class="string">&quot;2923 2924&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 解析数字或者字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;解析数字或者字符：&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> charPattern = P(<span class="number">1</span>)</span><br><span class="line"><span class="comment">--- 匹配，返回2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(charPattern, <span class="string">&quot;hello 123&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> integerOrchaPattern = integerCapturePattern<span class="comment">-- + charPattern</span></span><br><span class="line"><span class="comment">--- 利用Capture.Ct函数存储所有匹配结果到表中</span></span><br><span class="line"><span class="keyword">local</span> integerOrcharCapture = lpeg.Ct(integerOrchaPattern^<span class="number">0</span>)</span><br><span class="line"><span class="comment">--- 未匹配输出 &#123;&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;hello!&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出：&#123;123&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;hello 123&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出：&#123;5,5,5,7,7,7&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;5 5 5 yeah 7 7 7&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出：&#123;5,5,5,7,7,7&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;5 5 5 a b c d 7 7 7&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 计算器语法解析器</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;计算器语法解析器:&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> white = lpeg.S(<span class="string">&quot; \t\r\n&quot;</span>) ^ <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> integer = white * lpeg.R(<span class="string">&quot;09&quot;</span>) ^ <span class="number">1</span> / <span class="built_in">tonumber</span></span><br><span class="line"><span class="keyword">local</span> muldiv = white * lpeg.C(lpeg.S(<span class="string">&quot;/*&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> addsub = white * lpeg.C(lpeg.S(<span class="string">&quot;+-&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> factor = integer * muldiv * integer + integer</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;5&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(lpeg.Ct(factor), <span class="string">&quot;5&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;2,&quot;*&quot;,1&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(lpeg.Ct(factor), <span class="string">&quot;2*1&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 字符串匹配替换</span></span><br><span class="line"><span class="comment">--- 实现类似gsub的方法的效果</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;字符串匹配替换：&quot;</span>)</span><br><span class="line"><span class="comment">--- lpeg.Ct -- 仅仅捕获到table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">(s, patt)</span></span></span><br><span class="line">	patt = P(patt) / <span class="built_in">tostring</span></span><br><span class="line">	<span class="keyword">local</span> p = lpeg.Ct((patt + <span class="number">1</span>)^<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">match</span>(p, s)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- lpeg.Cs -- 捕获并替换</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gsub</span><span class="params">(s, patt, repl)</span></span></span><br><span class="line">	patt = P(patt)</span><br><span class="line">	<span class="keyword">local</span> p = lpeg.Cs((patt / repl + <span class="number">1</span>)^<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">match</span>(p, s)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;&quot;dog&quot;,&quot;dog&quot;&#125;</span></span><br><span class="line">print_table(<span class="built_in">find</span>(<span class="string">&quot;hello dog, dog!&quot;</span>, <span class="string">&quot;dog&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;&quot;hello cat, cat!&quot;&#125;</span></span><br><span class="line">print_table(<span class="built_in">gsub</span>(<span class="string">&quot;hello dog, dog!&quot;</span>, <span class="string">&quot;dog&quot;</span>, <span class="string">&quot;cat&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 最终目标1: &#123;***&#125;占位替换</span></span><br><span class="line"><span class="comment">--- 指定字符串，采用table里的key替换&#123;key&#125;成key对应的value</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tableGsub</span><span class="params">(s, tb)</span></span></span><br><span class="line">	<span class="keyword">local</span> result = s</span><br><span class="line">	<span class="keyword">local</span> replaceKey = <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">local</span> replaceValue = <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(tb) <span class="keyword">do</span></span><br><span class="line">		replaceKey = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;&#123;%s&#125;&quot;</span>, key)</span><br><span class="line">		replaceValue = <span class="built_in">tostring</span>(value)</span><br><span class="line">		<span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;字符串:%s 替换:%s为%s&quot;</span>, result, replaceKey, replaceValue))</span><br><span class="line">		result = <span class="built_in">gsub</span>(result, replaceKey, replaceValue)</span><br><span class="line">		<span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;替换后结果:%s&quot;</span>, result))</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> content = <span class="string">&quot;测试table替换,名字:&#123;name&#125; 年龄:&#123;age&#125; 性别:&#123;sex&#125; 名字2:&#123;name&#125; 名字3:&#123;name&#125;&quot;</span></span><br><span class="line"><span class="keyword">local</span> replaceTable = &#123;</span><br><span class="line">	name = <span class="string">&quot;TonyTang&quot;</span>,</span><br><span class="line">	sex = <span class="string">&quot;Man&quot;</span>,</span><br><span class="line">	age = <span class="number">18</span>,</span><br><span class="line">	luckyNumber = <span class="number">7</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">local</span> timeCounter = New(TimeCounter, <span class="string">&quot;tableGsub&quot;</span>)</span><br><span class="line">timeCounter:Start()</span><br><span class="line">content = tableGsub(content, replaceTable)</span><br><span class="line">timeCounter:Stop()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;替换后结果:replaceValue&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;替换耗时:%s&quot;</span>, timeCounter.EllapseTime))</span><br></pre></td></tr></table></figure>









<h1 id="Lua-IDE"><a href="#Lua-IDE" class="headerlink" title="Lua IDE"></a>Lua IDE</h1><p>首先这里决定选一个相对轻量级的Lua IDE，VS因为太重量级了，这里不考虑。<br>其次考虑到跨平台和前端常用的(平时主要会用到C#和Lua)，最初决定选择VSCode作为Lua代码编写的IDE，VSCode丰富的插件库也是选择VSCode很重要的一个原因之一。经过调研发现VSCode第三方插件<a target="_blank" rel="noopener" href="https://www.showdoc.cc/luaide?page_id=1832520940259550">Luaide在VSCode 1.33.1以上版本有严重的内存暴涨问题</a>，所以最后笔者转向了VSCode + EmmyLua 插件的方式。</p>
<h2 id="VSCode"><a href="#VSCode" class="headerlink" title="VSCode"></a>VSCode</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Visual_Studio_Code">Visual Studio Code（简称VS Code）是一个由微软开发的，同时支持Windows、Linux、和macOS系统且开放源代码的代码编辑器[4]，它支持测试，并内置了Git 版本控制功能，同时也具有开发环境功能，例如代码补全（类似于 IntelliSense）、代码片段、和代码重构等，该编辑器支持用户个性化配置，例如改变主题颜色、键盘快捷方式等各种属性和参数，还在编辑器中内置了扩展程序管理的功能。</a></p>
<h3 id="设置同步"><a href="#设置同步" class="headerlink" title="设置同步"></a>设置同步</h3><p>VSCode支持高度自由的自定义插件和自定义设置，我们如何在不同的工作环境快速同步IDE信息(插件，自定义设置等)，避免每一次在不同工作环境下都重复下载插件设置等操作是一个需要解决的问题。</p>
<p>借助于第三方插件：<br>SettingsSync(使用了Github Gist)可以同步保存VSCode配置和扩展。</p>
<p>详细配置流程参考:<br><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=Shan.code-settings-sync">Settings Sync</a></p>
<p>上传快捷键：<br>Shift + Alt + U<br>下载同步快捷键：<br>Shift + Alt + D</p>
<h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><p>当拿到新的IDE时，为了工作效率，快捷键不熟是一个很影响开发效率的问题。<br>VSCode丰富的插件库和高度的可自定义可以轻松解决这个问题：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.vs-keybindings">Visual Studio Keymap</a>(第三方插件 – 快速导入VS的快捷键)</li>
<li>Custom Shortcup Keymap(自定义设置快捷键File -&gt; Preference -&gt; Keyboard Shortcuts – 用于满足自定义需求)</li>
</ol>
<h3 id="Snippets"><a href="#Snippets" class="headerlink" title="Snippets"></a>Snippets</h3><p>Snippets又名代码片段，主要目的是为了通过自定义关键词和模板，快速触发代码片段生成。<br>这里主要针对自定义代码片段的功能使用来学习。<br>File -&gt; Preference -&gt; User Snippets<br>e.g.个人文件署名的代码片段：<br>lua.json</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Lua File Title Sneppits&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;prefix&quot;</span>: <span class="string">&quot;LuaFileTitle&quot;</span>,</span><br><span class="line">        <span class="string">&quot;body&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;-- File Name:    $TM_FILENAME&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-- Description:    This file is used to $&#123;1:Staff&#125;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-- Author:       $&#123;2:TangHuan&#125;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-- Create Date:    $&#123;3:Year&#125;/$&#123;4:Month&#125;/$&#123;5:Day&#125;&quot;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Lua File Title Sneppits&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来当我们输入LuaFileTitle关键词时，VSCode就会自动触发提示，直接table键选择Snippets就能触发代码生成。<br>效果如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:    Base.lua</span></span><br><span class="line"><span class="comment">-- Description:    This file is used to Staff</span></span><br><span class="line"><span class="comment">-- Author:       TangHuan</span></span><br><span class="line"><span class="comment">-- Create Date:    Year/Month/Day</span></span><br></pre></td></tr></table></figure>

<p>详细使用Snippets参考:<br><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/editor/userdefinedsnippets">Creating your own snippets</a></p>
<h3 id="Lua调试"><a href="#Lua调试" class="headerlink" title="Lua调试"></a>Lua调试</h3><p>Lua作为解析执行的语言，调试相比其他高级语言比较麻烦一点，这里选择借助第三方(Luaide)插件作为辅助工具。</p>
<p>经过调研发现VSCode第三方插件<a target="_blank" rel="noopener" href="https://www.showdoc.cc/luaide?page_id=1832520940259550">Luaide在VSCode 1.33.1以上版本有严重的内存暴涨问题</a>，所以最后笔者转向了VSCode + EmmyLua 插件的方式。<br>这里就没有详细了解VSCode + LuaIde的调试方式了。</p>
<h4 id="EmmyLua"><a href="#EmmyLua" class="headerlink" title="EmmyLua"></a>EmmyLua</h4><p><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/annotation.html">EmmyLua</a><br>VSCode安装EmmyLua很简单，直接插件里搜索安装即可，这里就不多做说明。</p>
<p>接下来主要结合XLua+VSCode+EmmyLua实战使用EmmyLua提示和调试两大重要功能。</p>
<h5 id="VSCode配置"><a href="#VSCode配置" class="headerlink" title="VSCode配置"></a>VSCode配置</h5><p>安装EmmyLua插件后，VSCode基本就已经完成配置了，但要使用VSCode开始编写Lua代码，我们还需要把Lua代码导入到VSCode里来。</p>
<p>VSCode导入Lua代码是以目录的形式，我们导入的我们加载Lua文件所在的最上层目录即可：<br><img src="/img/Lua/LuaFolderStructure.png" alt="LuaFolderStructure"></p>
<h5 id="XLua"><a href="#XLua" class="headerlink" title="XLua"></a>XLua</h5><p><a target="_blank" rel="noopener" href="https://github.com/Tencent/xLua">XLua官网</a><br>XLua的集成很简单，从Git下下来，把关键的几个目录放到项目里即可。<br>主要是如下几个目录：</p>
<ol>
<li>Tools(打包时XLua代码注入需要的工具在这里 Note: 放Assets同一层不要放到Assets里了)</li>
<li>Assets&#x2F;XLua&#x2F;Src(XLua需要的CS源代码)</li>
<li>Assets&#x2F;XLua&#x2F;Editor&#x2F;ExampleConfig.cs(XLua默认给的一套纯Lua开发基于反射生成需要标记CSharpCallLua || LuaCallCSharp || BlackList || Hotfix的一套模板)</li>
<li>Assets&#x2F;Plugins(XLua编译多平台后的库文件)</li>
</ol>
<p>Unity加载Lua文件默认不认.lua后缀的文件，我们需要自定义CustomLoader去加载到我们想要加载的.lua文件。<br>LuaManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> XLua;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lua单例管理者</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LuaManager</span> : <span class="title">SingletonMonoBehaviourTemplate</span>&lt;<span class="title">LuaManager</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua环境(全局唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> LuaEnv LuaEnv</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua脚本默认创建目录路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> LuaScriptFolderPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua脚本文件后缀</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> LuaFilePostFix = <span class="string">&quot;.lua&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua脚本文件路径映射Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Key为文件名(不含.lua后缀)，Value为该文件的全路径(含.lua后缀)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; mLuaScriptFilePathMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;LuaManager:init()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (LuaEnv == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            LuaEnv = <span class="keyword">new</span> LuaEnv();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Lua环境已经初始化！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LuaScriptFolderPath = Application.dataPath + <span class="string">&quot;/Scripts/XLua/Lua/&quot;</span>;</span><br><span class="line">        mLuaScriptFilePathMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自定义CustomLoader</span></span><br><span class="line">        LuaEnv.AddLoader(LuaCustomLoader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取所有Lua文件</span></span><br><span class="line">        readAllLuaFiles();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载LuaMain.lua</span></span><br><span class="line">        LuaEnv.DoString(<span class="string">&quot;require &#x27;LuaMain&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readAllLuaFiles</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> allluafiles = Directory.GetFiles(LuaScriptFolderPath, <span class="string">&quot;*.lua&quot;</span>, SearchOption.AllDirectories);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> luafile <span class="keyword">in</span> allluafiles)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> luafilename = Path.GetFileNameWithoutExtension(luafile);</span><br><span class="line">            <span class="keyword">if</span>(!mLuaScriptFilePathMap.ContainsKey(luafilename))</span><br><span class="line">            &#123;</span><br><span class="line">                mLuaScriptFilePathMap.Add(luafilename, luafile);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;有重名的Lua文件,文件路径:&#123;0&#125;文件路径:&#123;1&#125;&quot;</span>,luafile, mLuaScriptFilePathMap[luafilename]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua自定义Loader</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">byte</span>[] <span class="title">LuaCustomLoader</span>(<span class="params"><span class="keyword">ref</span> <span class="built_in">string</span> filename</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;加载Lua文件 ： &#123;0&#125;&quot;</span>, filename));</span><br><span class="line">        <span class="keyword">var</span> scriptfullpath = <span class="built_in">string</span>.Empty;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        <span class="comment">//Editor走File加载</span></span><br><span class="line">        <span class="comment">//Unity不认Lua后缀的情况</span></span><br><span class="line">        <span class="keyword">var</span> luascriptfolderpath = <span class="built_in">string</span>.Empty;</span><br><span class="line">        <span class="built_in">byte</span>[] luafile = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mLuaScriptFilePathMap.TryGetValue(filename, <span class="keyword">out</span> scriptfullpath))</span><br><span class="line">        &#123;</span><br><span class="line">            luafile = File.ReadAllBytes(scriptfullpath);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">        <span class="comment">//真机走其他方式加载</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (luafile != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> luafile;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;找不到Lua文件 : &#123;0&#125;&quot;</span>, filename));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到为了成功加载.lua后缀的Lua文件我做了以下几件事：</p>
<ol>
<li>通过Directory.GetFiles()获取到所有*.lua文件的路径映射，用于加载时消除目录的概念</li>
<li>自定义CustomLoader，支持加载(通过File.ReadAllBytes).lua后缀文件</li>
</ol>
<h5 id="代码提示"><a href="#代码提示" class="headerlink" title="代码提示"></a>代码提示</h5><p>Test.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:    Test.lua</span></span><br><span class="line"><span class="comment">-- Description:    This file is used to Test EmmyLua</span></span><br><span class="line"><span class="comment">-- Author:       TangHuan</span></span><br><span class="line"><span class="comment">-- Create Date:    2019/04/29</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 自定义table类型，测试Emmylua注释提示</span></span><br><span class="line"><span class="comment">---@class diytable</span></span><br><span class="line"><span class="comment">---@field field1 number 字段1</span></span><br><span class="line"><span class="comment">---@field field2 string 字段2</span></span><br><span class="line"><span class="keyword">local</span> diytable = &#123;</span><br><span class="line">    field1 = <span class="number">321</span>,</span><br><span class="line">    field2 = <span class="string">&quot;field2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">---@param para1 number 参数1</span></span><br><span class="line"><span class="comment">---@return diytable 返回diytable</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Test</span><span class="params">(para1)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Test(&quot;</span> .. para1 .. <span class="string">&quot;)&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> diytable</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">table</span> = Test(<span class="number">123</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">table</span>.field1)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">table</span>.field2)</span><br></pre></td></tr></table></figure>

<p>输入table.时会看到成员变量提示:<br><img src="/img/Lua/EmmyLuaNotation.png" alt="EmmyLuaNotation"></p>
<p>EmmyLua提示详细使用参考：<br><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/annotations/class.html">@class类声明注解</a></p>
<h5 id="查找方法引用"><a href="#查找方法引用" class="headerlink" title="查找方法引用"></a>查找方法引用</h5><p>EmmyLua查找方法引用很简单，直接在方法上右键查找所有引用即可：<br><img src="/img/Lua/LuaMethodReference.png" alt="LuaMethodReference"></p>
<h5 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h5><p>EmmyLua插件装好后，VSCode导入了Lua加载最上层目录后，调试Lua就很简单了：<br>F5 -&gt; EmmyLua Attach Debug -&gt; 选择对应Unity进程<br>然后通过F9下断点就可以像VS一样给Lua下断点了。<br><img src="/img/Lua/VSCodeEmmyLuaDebug.png" alt="VSCodeEmmyLuaDebug"></p>
<h1 id="ToLua"><a href="#ToLua" class="headerlink" title="ToLua"></a>ToLua</h1><p>待续……</p>
<h1 id="Refrence"><a href="#Refrence" class="headerlink" title="Refrence"></a>Refrence</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/freeblues/p/8436523.html">通过 LPeg 介绍解析表达式语法(Parsing Expression Grammars)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg">lpeg</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangziqiu/archive/2011/03/30/computercode.html">原码, 反码, 补码 详解</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000024426172">谈谈二进制（四）——原码、补码、反码、移码</a></p>
<h2 id="以前学习笔记"><a href="#以前学习笔记" class="headerlink" title="以前学习笔记"></a>以前学习笔记</h2><p>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]</a>(Game Scripting Mastery)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0rk.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0rk.html]</a>(Lua – some important concept and knowledge)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s0.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s0.html]</a>(Lua - Coroutines Study )<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s5.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s5.html]</a>(Lua - Metatables and Metamethods)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s9.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s9.html]</a>(Lua - Object Oriented Programming)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zp.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0zp.html]</a>(Lua - C API)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zs.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0zs.html]</a>(Lua - C call Lua &amp; Lua call C )<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v1qg.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v1qg.html]</a>(Lua - Userdata )<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v383.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v383.html]</a>(Lua - Managing Resources &amp; Threads and States)</p>
<h2 id="官方网站"><a href="#官方网站" class="headerlink" title="官方网站"></a>官方网站</h2><p><a target="_blank" rel="noopener" href="https://github.com/Tencent/xLua">XLua</a><br><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/installation.html">EmmyLua</a></p>
<h2 id="参考书籍"><a href="#参考书籍" class="headerlink" title="参考书籍"></a>参考书籍</h2><p>《Programming in Lua third edition》 – Roberto Ierusalimschy<br>《Lua用户手册》<br>《Game Scripting Mastery》 – Alex Varanese</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Programming-Language/">Programming Language</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Lua/">Lua</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/06/14/Android自动化签包/" title="Android自动化签包" itemprop="url">Android自动化签包</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-06-14T02:12:01.000Z" itemprop="datePublished"> 发表于 2017-06-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Android-Sign-Study"><a href="#Android-Sign-Study" class="headerlink" title="Android Sign Study"></a>Android Sign Study</h1><p>这一章主要是学习Android签包相关的概念和方法。<br>通过采用原始签包工具(zipalign &amp; apksigner &amp; keytool)，使用命令行的形式对于已经经过Unity打包签名的包进行重签来学习理解相关概念。</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><h2 id="When"><a href="#When" class="headerlink" title="When"></a>When</h2><p><a target="_blank" rel="noopener" href="https://developer.android.com/studio/publish/app-signing.html">Android requires that all APKs be digitally signed with a certificate before they can be installed.</a><br>Android要求所有的APK都必须通过证书签名否则不能被安装到设备上。</p>
<h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p><a target="_blank" rel="noopener" href="https://developer.android.com/studio/publish/app-signing.html">When you sign an APK, the signing tool attaches the public-key certificate to the APK. The public-key certificate serves as as a “fingerprint” that uniquely associates the APK to you and your corresponding private key.</a><br>签名可以唯一标示我们自己的APK。每个签名的APK都会有对应的公钥证书,而这个公钥证书会与我们的private key唯一对应，我们只需保证private key不泄露，就能保证我们签名的程序的唯一性。(公钥证书和私钥是由有公信力的机构分发的确保了公钥的正确性，那么与之唯一对应的私钥就保证了APK的唯一性。详情见后面)</p>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>那么我们为什么需要签名了？<br>以下引用至<a target="_blank" rel="noopener" href="https://kknews.cc/tech/yxlvj.html">Android APK签名原理及方法</a>:</p>
<ol>
<li><p>应用程序升级<br>如果想无缝升级一个应用，Android系统要求应用程序的新版本与老版本具有相同的签名与包名。若包名相同而签名不同，系统会拒绝安装新版应用。</p>
</li>
<li><p>应用程序模块化<br>Android系统可以允许同一个证书签名的多个应用程序在一个进程里运行，系统实际把他们作为一个单个的应用程序。此时就可以把我们的应用程序以模块的方式进行部署，而用户可以独立的升级其中的一个模块。</p>
</li>
<li><p>代码或数据共享<br>Android提供了基于签名的权限机制，一个应用程序可以为另一个以相同证书签名的应用程序公开自己的功能与数据，同时其它具有不同签名的应用程序不可访问相应的功能与数据。</p>
</li>
<li><p>应用程序的可认定性<br>签名信息中包含有开发者信息，在一定程度上可以防止应用被伪造。例如网易云加密对Android APK加壳保护中使用的“校验签名（防二次打包）”功能就是利用了这一点。</p>
</li>
</ol>
<h2 id="Conceptions"><a href="#Conceptions" class="headerlink" title="Conceptions"></a>Conceptions</h2><h3 id="数据摘要-Message-Digest"><a href="#数据摘要-Message-Digest" class="headerlink" title="数据摘要(Message Digest)"></a>数据摘要(Message Digest)</h3><p>以下内容引用至<a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a><br>这个知识点很好理解，百度百科即可，其实他也是一种算法，就是对一个数据源进行一个算法之后得到一个摘要，也叫作数据指纹，不同的数据源，数据指纹肯定不一样，就和人一样。</p>
<p>消息摘要算法（Message Digest Algorithm）是一种能产生特殊输出格式的算法，其原理是根据一定的运算规则对原始数据进行某种形式的信息提取，被提取出的信息就被称作原始数据的消息摘要。<br>著名的摘要算法有RSA公司的MD5算法和SHA-1算法及其大量的变体。<br>消息摘要的主要特点有：<br>1）无论输入的消息有多长，计算出来的消息摘要的长度总是固定的。例如应用MD5算法摘要的消息有128个比特位，用SHA-1算法摘要的消息最终有160比特位的输出。<br>2）一般来说（不考虑碰撞的情况下），只要输入的原始数据不同，对其进行摘要以后产生的消息摘要也必不相同，即使原始数据稍有改变，输出的消息摘要便完全不同。但是，相同的输入必会产生相同的输出。<br>3）具有不可逆性，即只能进行正向的信息摘要，而无法从摘要中恢复出任何的原始消息。</p>
<p><strong>可以看出数据摘要确保了数据的完整性。</strong></p>
<h3 id="数字签名-Signature"><a href="#数字签名-Signature" class="headerlink" title="数字签名(Signature)"></a>数字签名(Signature)</h3><p>以下内容引用至<a target="_blank" rel="noopener" href="http://andrewlcgu.github.io/2016/04/17/apk-sign-theroy/">APK签名原理解析</a>:<br>数字签名是非对称密钥加密技术与数字摘要技术的应用。将信息摘要用发送者的私钥加密，与原文一起传送给接收者。接收者只有用发送者的公钥才能解密被加密的信息摘要，然后接收者用相同的Hash函数对收到的原文产生一个信息摘要，与解密的信息摘要做比对。如果相同，则说明收到的信息是完整的，在传输过程中没有被修改；不同则说明信息被修改过，因此数字签名能保证信息的完整性。并且由于只有发送者才有加密摘要的私钥，所以我们可以确定信息一定是发送者发送的(发送者的身份认证)。</p>
<p><strong>可以看出数字签名确保了数据的正确性(数据来源可靠性)，但需要确保公钥的安全传输问题。</strong></p>
<h3 id="CA机构-Certification-Authority"><a href="#CA机构-Certification-Authority" class="headerlink" title="CA机构(Certification Authority)"></a>CA机构(Certification Authority)</h3><p>以下内容引用至<a target="_blank" rel="noopener" href="http://andrewlcgu.github.io/2016/04/17/apk-sign-theroy/">APK签名原理解析</a>:<br>受信任的第三方，承担公钥体系中公钥的合法性检验的责任</p>
<h3 id="根证书"><a href="#根证书" class="headerlink" title="根证书"></a>根证书</h3><p>以下内容引用至<a target="_blank" rel="noopener" href="http://andrewlcgu.github.io/2016/04/17/apk-sign-theroy/">APK签名原理解析</a>:<br>是未被签名的公钥证书或自签名的证书;是CA认证中心给自己颁发的证书，是信任链的起始点。安装根证书意味着对这个CA认证中心的信任。用户在使用自己的数字证书之前必须先下载根证书。</p>
<h3 id="数字证书-Certification"><a href="#数字证书-Certification" class="headerlink" title="数字证书(Certification)"></a>数字证书(Certification)</h3><p>以下内容引用至<a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a>:<br>所谓数字证书，一般包含以下一些内容：</p>
<ol>
<li>证书的发布机构（Issuer）</li>
<li>证书的有效期（Validity）</li>
<li>消息发送方的公钥</li>
<li>证书所有者（Subject）</li>
<li>数字签名所使用的算法</li>
<li>数字签名<br>可以看出，数字证书其实也用到了数字签名技术。只不过要签名的内容是消息发送方的公钥，以及一些其它信息。但与普通数字签名不同的是，数字证书中签名者不是随随便便一个普通的机构，而是要有一定公信力的机构。这就好像你的大学毕业证书上签名的一般都是德高望重的校长一样。一般来说，这些有公信力机构的根证书已经在设备出厂前预先安装到了你的设备上了。所以，数字证书可以保证数字证书里的公钥确实是这个证书的所有者的，或者证书可以用来确认对方的身份。数字证书主要是用来解决公钥的安全发放问题。<br><img src="/img/Android/CertificationVerificationFlowChat.PNG" alt="CertificationVerificationFlowChat"></li>
</ol>
<p><strong>可以看出通过获得权威的机构获取到唯一的数字证书，这样一来解决了前面数字签名提到的公钥安全传输问题(数字证书能够确保公钥的正确性)</strong></p>
<h3 id="keystores"><a href="#keystores" class="headerlink" title="keystores"></a>keystores</h3><p>因为没有正确签名的应用，Android系统不会安装或者运行。所以我们通过有公信力机构得到公钥证书以及与之唯一对应的私钥，我们就能验证特定应用是否是特定私钥签名的应用()<br>接下来我们了解下Android签名过程中一个重要概念：<br>keystore存储着公信力机构分发的私钥和公钥证书。<br>通过使用keystore签名APK，我们能够确保APK的唯一性。</p>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><p>接下来通过使用相关签名工具来重签一个已经签过名的APK来实战学习理解签名过程。</p>
<h3 id="apktool"><a href="#apktool" class="headerlink" title="apktool"></a>apktool</h3><p>apktool是一个帮助我们编码和反编码APK的一个工具。<br>这里我有一个已经签过名的APK_Signed_Aligned.apk为例进行重签：<br>第一步：<br>准备好APK和apktool:<br><img src="/img/Android/apktoolprepare.PNG" alt="apktoolprepare"><br>第二步：<br>我们需要反编码APK：<br><img src="/img/Android/apktooldecode.PNG" alt="apktooldecode"><br>第三步:<br>替换APK_Signed_Aligned里的部分内容(比如替换Log之类的)然后进入刚才反编码的文件夹进行APK重编码(这时我们会得到一个重编码后APK_Unsigned_Unaligned.apk)：<br><img src="/img/Android/apktoolbuild.PNG" alt="apktoolbuild"><br>Note:<br><a target="_blank" rel="noopener" href="https://ibotpeaches.github.io/Apktool/documentation/#decoding">In order to run a rebuilt application. You must resign the application. Android documentation can help with this.</a><br>此时的APK_Unsigned_Unaligned.apk是处于未签名也未进行压缩数据对齐处理(后续会讲到)。</p>
<h3 id="zipalign"><a href="#zipalign" class="headerlink" title="zipalign"></a>zipalign</h3><p><a target="_blank" rel="noopener" href="https://developer.android.com/studio/command-line/zipalign.html">zipalign is an archive alignment tool that provides important optimization to Android application (APK) files. The purpose is to ensure that all uncompressed data starts with a particular alignment relative to the start of the file.</a><br>zipalign是一个对于APK压缩数据进行对齐处理的工具。<br>第四步：<br>对APK_Unsigned_Unaligned.apk进行压缩数据对齐处理得到压缩数据对齐的APK_Unsigned_Aligned.apk:<br><img src="/img/Android/zipalignalignment.PNG" alt="zipalignalignment"></p>
<p>Note:<br>zipalign位于Android SDK的build tools目录下。</p>
<h3 id="keytool"><a href="#keytool" class="headerlink" title="keytool"></a>keytool</h3><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/6/docs/technotes/tools/windows/keytool.html">Manages a keystore (database) of cryptographic keys, X.509 certificate chains, and trusted certificates.</a><br>keytool这里可以理解成有公信力的机构(工具)帮助我们生成唯一的公共证书和与之对应的私钥。</p>
<p>第五步：<br>在对我们进行压缩数据对齐后的APK_Unsigned_Aligned.apk进行重签之前，我们需要生成自己的keystore用于签名认证我们的APK。<br>使用keytool生成我们需要的公共证书和与之对应的私钥：<br><img src="/img/Android/keytoolgenerakeystore.PNG" alt="keytoolgenerakeystore"><br>上面要填的信息就是之前在数字证书里提到的生成公共秘钥和私钥需要的信息。<br>最后得到我们的TonyTangKeyStore.jks(签名需要的keystore，公共秘钥和私钥都在里面)<br><img src="/img/Android/keystore.PNG" alt="keystore"><br>接下来我们通过keytool查看我们刚生成的keystore信息(因为不是在同一台电脑上测试学习KeyStore，所以路径并不一致)：<br><img src="/img/Android/KeyStoreInfo.PNG" alt="KeyStoreInfo"><br>可以看到我们的Keystore是由Sun公司提供的，采用SHA1(前面提到的数字摘要算法之一e.g. MD5 or SHA1)算法计算私钥的数字摘要。</p>
<p>Note:<br>keytool位于JDK的bin目录下。<br>上面输入的Keystore密码后续签包时会用到。<br>上面生成keystore默认只有90天有效期，在开发过程中我们要保证keystore有效期远大于软件生命周期，不然期限到了就无法在继续使用同一个keystore，也就不能保证APK的唯一性了。<br>keytool貌似有个参数-validity是决定有效期的，这里就没有尝试了，详情参考keytool官网。</p>
<h3 id="apksigner"><a href="#apksigner" class="headerlink" title="apksigner"></a>apksigner</h3><p>第六步：<br>得到了keystore，那么我们就可以进行签名工作了。<br>使用apksigner进行签包：<br><img src="/img/Android/apksignersigne.PNG" alt="apksignersigne"><br>通过apksigner验证特定APK是否签名：<br><img src="/img/Android/apksignerverify.PNG" alt="apksignerverify"><br>最终我们得到了我们重新重签后的APK_Signed_Aligned.apk(与我们使用的keystore里的私钥唯一对应)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/command-line/apksigner.html#usage">The apksigner tool, available in revision 24.0.3 and higher of the Android SDK Build Tools</a><br>apksigner工具在AndroidSDK 24.0.3的Build Tool才可用。<br>其他签名工具还有jarsigner和signapk。</p>
<h2 id="Deep"><a href="#Deep" class="headerlink" title="Deep"></a>Deep</h2><p>深入学习理解签包里的相关文件：<br>这里主要参考别人的学习理解<a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a><br>通过上文我们可以看出签名后验证APK的相关文件主要有以下三个文件：</p>
<ol>
<li>MANIFEST.MF</li>
<li>CERT.SF</li>
<li>CERT.RSA</li>
</ol>
<p>打开MANIFEST.MF(以下只复制了很少一部分做验证使用):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Created-By: <span class="number">1.0</span> (Android)</span><br><span class="line"></span><br><span class="line">Name: assets/bin/Data/Managed/System.Core.dll</span><br><span class="line">SHA1-Digest: cBOiG0b7uqe/+kFj8qkmBvP2/zw=</span><br><span class="line"></span><br><span class="line">Name: AndroidManifest.xml</span><br><span class="line">SHA1-Digest: JYiwTP2AVjbfgZVkMuuhe/bPrf0=</span><br></pre></td></tr></table></figure>
<p>可以看出MANIFEST.MF文件记录了APK里文件内容的SHA1-Digest(数字摘要)，这个数字摘要通过上面博主找到的源码来看是通过对文件内容做一次SHA1算法后然后通过Base64 Encode得到的。</p>
<p>下面我们直接通过HashTable和Base64网站验证一下(这里以AndroidManifest.xml为例)：<br><img src="/img/Android/AndroidManifestHashValue.PNG" alt="AndroidManifestHashValue"><br>因为我们使用的是SHA1数字摘要算法，所以这里用AndroidManifest.xml的SHA1值ECFB805F9645FB3CDB7B29DB4529B6FD7545261D进行反推。<br>通过Base64 Encode后：<br><img src="/img/Android/SHA1AfterBase64.PNG" alt="SHA1AfterBase64"><br>把Base64 Encode后的值和我们在MANIFEST.MF里AndroidManifest.xml的SHA1-Digest进行对比，就会发现是一致的。</p>
<p>这里不再对三个文件做深入研究，上面那位博主已经做了很清晰的解释，详情参见<a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a>。<br>这里只记录下三个文件之间的关系以及在APK简明里起的作用做个总结：</p>
<ol>
<li>MANIFEST.MF(对APK里的部分文件通过SHA1和Base64 Encode后记录下对应的数字摘要，<strong>用于验证APK文件的完整性</strong>)</li>
<li>CERT.SF(对MANIFEST.MF文件进行一次SHA1和Basee64 Encode进行记录，并针对MANIFEST.MF里每一块进行SHA1和Base64 Encode并记录，<strong>用于验证MANIFEST.MF的完整性</strong>)</li>
<li>CERT.RSA(这里会包含我们通过keystore生成的私钥计算出的签名以及公钥信息等数字证书信息，<strong>用于验证APK的唯一性也就是我们一直强调的签名来源</strong>)</li>
</ol>
<p>那么上面三个文件就能确保APK的唯一性和安全性了吗？<br>一下来自<a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a>的总结：<br>首先，如果你改变了apk包中的任何文件，那么在apk安装校验时，改变后的文件摘要信息与MANIFEST.MF的检验信息不同，于是验证失败，程序就不能成功安装。<br>其次，如果你对更改的过的文件相应的算出新的摘要值，然后更改MANIFEST.MF文件里面对应的属性值，那么必定与CERT.SF文件中算出的摘要值不一样，照样验证失败。<br>最后，如果你还不死心，继续计算MANIFEST.MF的摘要值，相应的更改CERT.SF里面的值，那么数字签名值必定与CERT.RSA文件中记录的不一样，还是失败。<br>那么能不能继续伪造数字签名呢？不可能，因为没有数字证书对应的私钥。<br>所以，如果要重新打包后的应用程序能再Android设备上安装，必须对其进行重签名。</p>
<p>从上面的分析可以得出，只要修改了Apk中的任何内容，就必须重新签名，不然会提示安装失败，当然这里不会分析，后面一篇文章会注重分析为何会提示安装失败。</p>
<p>从上面的总结可以看出，Keystore的Private Key是作为我们APK签名安全的最后一道防线，确保数字签名不会被伪造。</p>
<h1 id="Android-Stuido-and-Gradle"><a href="#Android-Stuido-and-Gradle" class="headerlink" title="Android Stuido and Gradle"></a>Android Stuido and Gradle</h1><p>在开始实战APK重签之前，这里需要先学习了解Android Studio和Gradle，这一步可以帮助我们把java代码打包成jar来使用。<br>详情参考<a href="http://tonytang1990.github.io/2016/12/11/Unity%E5%8E%9F%E7%94%9F&%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8F%92%E4%BB%B6/#Android_Studio">Android Studio</a></p>
<h1 id="APK重签实战"><a href="#APK重签实战" class="headerlink" title="APK重签实战"></a>APK重签实战</h1><p>通过上面的学习，我们知道了APK的重签需要经过一下步骤:</p>
<ol>
<li>反解APK</li>
<li>修改内容</li>
<li>重新打包APK</li>
<li>APK数据对齐</li>
<li>重新签名APK</li>
</ol>
<p>接下来我们以实现以下几个功能作为实战重签APK的学习目标:</p>
<ol>
<li>修改AndroidManifest.xml内容(通过修改versioncode打印检验)</li>
<li>替换APK里的资源(替换streamingasset路径下的一个文本文件内容并打印检验)</li>
<li>替换签名重签APK(通过apksigner验证apk重签后的签名)</li>
</ol>
<p>我将会结合前面提到的工具利用Python完成这一次自动化重签功能学习:<br>直接上学习代码:<br>resignAPK.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 指定文件包含非anscii字符</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os  </span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">## Decompile APK(反编译APK)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DecompileAPK</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DecompileAPK()&quot;</span>)</span><br><span class="line">    apttooldecompilecmd = <span class="string">&quot;&#123;&#125;/apktool.bat -f d &#123;&#125;.apk&quot;</span>.<span class="built_in">format</span>(apktoolDir, apkName)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------excute cmd :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(apttooldecompilecmd))</span><br><span class="line">    os.system(apttooldecompilecmd)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Modify AndroidManifest File(修改AndroidMainifest.xml)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ModifyAndroidManifest</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ModifyAndroidManifest()&quot;</span>)</span><br><span class="line">    lines = []</span><br><span class="line">    androidManifestFile = <span class="built_in">open</span>(decompileAndroidManifestPath, mode=<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> androidManifestFile:</span><br><span class="line">        line = ReplaceVersionCode(line, newVersionCode)</span><br><span class="line">        lines.append(line)</span><br><span class="line">    androidManifestFile.close()</span><br><span class="line"></span><br><span class="line">    androidManifestFile = <span class="built_in">open</span>(decompileAndroidManifestPath, mode=<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        androidManifestFile.write(line)</span><br><span class="line">    androidManifestFile.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">## Template Replace(模板替换AndroidManifest.xml里的值)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CheckTemplateReplace</span>(<span class="params">line, qct, npn</span>):</span><br><span class="line">    <span class="comment"># Python 2.X string.find</span></span><br><span class="line">    <span class="comment">#result = string.find(line, qct)</span></span><br><span class="line">    <span class="comment"># Python 3.X str.find</span></span><br><span class="line">    result = line.find(qct)</span><br><span class="line">    <span class="keyword">if</span> result != -<span class="number">1</span>:</span><br><span class="line">        line = line.replace(qct, npn)</span><br><span class="line">    <span class="keyword">return</span> line</span><br><span class="line"></span><br><span class="line"><span class="comment">## Modify Version Code Value(修改AndroidManifest.xml里的version code值)</span></span><br><span class="line"><span class="comment">## 实际使用过程发现apktool反解APK后AndroidManifest.xmnl里没有对应versioncode值</span></span><br><span class="line"><span class="comment">## 但以下代码如果存在versioncode=&quot;*&quot;的话是能够替换成功的</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ReplaceVersionCode</span>(<span class="params">line, newverioncode</span>):</span><br><span class="line">    <span class="comment"># Python 2.X string.find</span></span><br><span class="line">    <span class="comment">#result = string.find(line, versionCodeTemplate)</span></span><br><span class="line">    <span class="comment"># Python 3.X str.find</span></span><br><span class="line">    result = line.find(versionCodeTemplate)</span><br><span class="line">    <span class="keyword">if</span> result != -<span class="number">1</span>:</span><br><span class="line">        line = re.sub(<span class="string">&#x27;(versionCode=&quot;[0-9]*&quot;)&#x27;</span>, <span class="string">&quot;versioncode=\&quot;&#123;&#125;\&quot;&quot;</span>.<span class="built_in">format</span>(newverioncode), line, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> line</span><br><span class="line"></span><br><span class="line"><span class="comment">## Copy new resource to APK(复制新资源到包内)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CopyNewResourceToAPK</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;CopyNewResourceToAPK()&quot;</span>)</span><br><span class="line">    shutil.copy(newResourceName, <span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(replaceResourceDestinationPath))</span><br><span class="line"></span><br><span class="line"><span class="comment">## Recompile APK(重新打包APK)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RecompileAPK</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;RecompileAPK()&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------os.chdir(./&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(apkName))</span><br><span class="line"></span><br><span class="line">    os.chdir(<span class="string">&quot;./&#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkName))</span><br><span class="line"></span><br><span class="line">    retval = os.getcwd()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------Current working directory &#123;&#125;&quot;</span>.<span class="built_in">format</span>(retval))</span><br><span class="line"></span><br><span class="line">    apttoolrecompilecmd = <span class="string">&quot;&#123;&#125;/apktool.bat b -o ../&#123;&#125;.apk&quot;</span>.<span class="built_in">format</span>(apktoolDir, apkUnsignedUnaglinedName)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------excute cmd :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(apttoolrecompilecmd))</span><br><span class="line"></span><br><span class="line">    os.system(apttoolrecompilecmd)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------os.chdir(./..)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    os.chdir(<span class="string">&quot;./..&quot;</span>)</span><br><span class="line"></span><br><span class="line">    retval = os.getcwd()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Current working directory &#123;&#125;&quot;</span>.<span class="built_in">format</span>(retval))</span><br><span class="line"></span><br><span class="line"><span class="comment">## Aligned APK(APK 4K对齐)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">AlignedAPK</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;AlignedAPK()&quot;</span>)</span><br><span class="line"></span><br><span class="line">    zalignedcmd = <span class="string">&quot;&#123;&#125;\\build-tools\\24.0.3\\zipalign.exe -f 4 &#123;&#125;.apk &#123;&#125;.apk&quot;</span>.<span class="built_in">format</span>(androidSDKDir, apkUnsignedUnaglinedName, apkUnsignedAglinedName)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------zalignedcmd :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(zalignedcmd))</span><br><span class="line"></span><br><span class="line">    os.system(zalignedcmd)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Resigned APK(重签APK)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResignedAPK</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ResignedAPK()&quot;</span>)</span><br><span class="line"></span><br><span class="line">    resignedcmd = <span class="string">&quot;&#123;&#125;\\build-tools\\24.0.3\\apksigner.bat sign --ks &#123;&#125; --ks-pass pass:&#123;&#125; --out &#123;&#125;.apk &#123;&#125;.apk&quot;</span>.<span class="built_in">format</span>(androidSDKDir, keystoreFilename, keystorePassword, apkResignedName, apkUnsignedAglinedName)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------resignedcmd :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(resignedcmd))</span><br><span class="line"></span><br><span class="line">    os.system(resignedcmd)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Repackage process</span></span><br><span class="line"><span class="comment"># argparse解析参数输入，需要先定义一个ArgumentParser对象</span></span><br><span class="line"><span class="comment"># description - -h的时候显示在最前面的信息</span></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Study argparse module.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add_argument - 定义如何解析一个参数</span></span><br><span class="line"><span class="comment"># 第一个参数代表参数名</span></span><br><span class="line"><span class="comment"># type - 指定参数数据类型</span></span><br><span class="line"><span class="comment"># help - -h时解释该参数的用意</span></span><br><span class="line"><span class="comment"># dest - 表示该参数最终在parser.parse_args()返回对象里的名字</span></span><br><span class="line"><span class="comment"># default - 表示该参数的默认值</span></span><br><span class="line"><span class="comment"># required - 表示该参数是不是必须填的参数</span></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--APKName&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;APK名字&#x27;</span>, dest=<span class="string">&#x27;APKName&#x27;</span>,</span><br><span class="line">                    required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--VersionCode&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;新的VersionCode&#x27;</span>, dest=<span class="string">&#x27;NewVersionCode&#x27;</span>,</span><br><span class="line">                    required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--ResourceName&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;新资源名字&#x27;</span>, dest=<span class="string">&#x27;NewResourceName&#x27;</span>,</span><br><span class="line">                    default=<span class="string">&#x27;default.aba&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--ResourcePath&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;新资源包内目录&#x27;</span>, dest=<span class="string">&#x27;NewResourcePath&#x27;</span>,</span><br><span class="line">                    default=<span class="string">&#x27;./assets/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析输入的参数</span></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印参数的详细信息，通过访问parser.parse_args()的对象去访问</span></span><br><span class="line"><span class="built_in">print</span>(args)</span><br><span class="line">apkName = args.APKName</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;apkName : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(apkName))</span><br><span class="line">newVersionCode = args.NewVersionCode</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;newVersionCode : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(newVersionCode))</span><br><span class="line">newResourceName = args.NewResourceName</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;newResourceName : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(newResourceName))</span><br><span class="line">newResourcePath = args.NewResourcePath</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;newResourcePath : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(newResourcePath))</span><br><span class="line"></span><br><span class="line">currentFolder = os.getcwd()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;currentFolder : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(currentFolder))</span><br><span class="line"></span><br><span class="line">apktoolDir = currentFolder</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;apktoolDir : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(apktoolDir))</span><br><span class="line"></span><br><span class="line">androidSDKDir = os.getenv(<span class="string">&quot;AndroidSDK&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;androidSDKDir : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(androidSDKDir))</span><br><span class="line"><span class="keyword">if</span> androidSDKDir == <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;androidSDKDir == None,请配置ANdroidSDK环境变量路径&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">150</span>)</span><br><span class="line">    exit()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;androidSDKDir != None&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># version code替换原模板</span></span><br><span class="line">versionCodeTemplate = <span class="string">&quot;versionCode=&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;versionCodeTemplate = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(versionCodeTemplate))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要替换的资源目录</span></span><br><span class="line">replaceResourcePath = <span class="string">&quot;./&#123;&#125;/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkName, newResourcePath)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;replaceResourcePath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(replaceResourcePath))</span><br><span class="line"></span><br><span class="line">keystoreFilename = <span class="string">&quot;TonyTangNewKeyStore.jks&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;keystoreFilename = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(keystoreFilename))</span><br><span class="line"></span><br><span class="line">keystorePassword = <span class="string">&quot;th13568582998&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;keystorePassword = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(keystorePassword))</span><br><span class="line"></span><br><span class="line">decompileFolderPath = <span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkName)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;decompileFolderPath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(decompileFolderPath))</span><br><span class="line"></span><br><span class="line">decompileAndroidManifestPath = <span class="string">&quot;./&#123;&#125;/AndroidManifest.xml&quot;</span>.<span class="built_in">format</span>(decompileFolderPath)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;decompileAndroidManifestPath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(decompileAndroidManifestPath))</span><br><span class="line"></span><br><span class="line">replaceResourceDestinationPath = <span class="string">&quot;&#123;&#125;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(replaceResourcePath, newResourceName)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;replaceResourceDestinationPath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(replaceResourceDestinationPath))</span><br><span class="line"></span><br><span class="line">apkUnsignedUnaglinedName = <span class="string">&quot;&#123;&#125;_Unsinged_Unaligned&quot;</span>.<span class="built_in">format</span>(apkName)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;apkUnsignedUnaglinedName = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkUnsignedUnaglinedName))</span><br><span class="line"></span><br><span class="line">apkUnsignedAglinedName = <span class="string">&quot;&#123;&#125;_Unsigned_Aligned&quot;</span>.<span class="built_in">format</span>(apkName)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;apkUnsignedAglinedName = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkUnsignedAglinedName))</span><br><span class="line"></span><br><span class="line">apkResignedName = <span class="string">&quot;&#123;&#125;_Signed_Aligned&quot;</span>.<span class="built_in">format</span>(apkName)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;apkResignedName = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(apkResignedName))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;.apk resigned start&quot;</span>.<span class="built_in">format</span>(apkName))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反解APK</span></span><br><span class="line">DecompileAPK()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改AndroidMainifest.xml里面的内容</span></span><br><span class="line">ModifyAndroidManifest()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制资源到指定目录</span></span><br><span class="line">CopyNewResourceToAPK()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新打包APK</span></span><br><span class="line">RecompileAPK()</span><br><span class="line"></span><br><span class="line"><span class="comment"># APK数据对齐</span></span><br><span class="line">AlignedAPK()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新签名APK</span></span><br><span class="line">ResignedAPK()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂停不关闭命令行窗口(仅限Windows)</span></span><br><span class="line">os.system(<span class="string">&#x27;pause&#x27;</span>) </span><br></pre></td></tr></table></figure>
<p>上面的注释都比较详细了，就不再细说每一步了。<br>这里直接来看下运行这个resignAPK.py的环境要求以及目录结构：<br><img src="/img/Android/AndroidResignAPKFolderStructure.png" alt="AndroidResignAPKFolderStructure"><br>以下是使用argparse作为参数解析库的帮助查看:<br><img src="/img/Android/AndroidResignAPKArgParse.png" alt="AndroidResignAPKArgParse"><br>以下是正式使用重签resignAPK.py用法:<br><img src="/img/Android/AndroidResignAPKCommandsUsing.png" alt="AndroidResignAPKCommandsUsing"><br>最后输出了一个叫apkName_Signed_Aligned的APK使我们最终重签后的APK:<br><img src="/img/Android/AndroidResignFinalAPK.png" alt="AndroidResignFinalAPK"><br>ABTestFile.text文件是位于StreamingAsset目录下的一个文件，原文是test，我覆盖后内容是test2。<br>配合测试访问代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             ResourceManager.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ResourceManager.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 资源加载管理单例类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ResourceManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">ResourceManager</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> AB资源路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ABPath</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mABPath = Application.streamingAssetsPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 测试资源文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mTestResourceFileName = <span class="string">&quot;/ABTestFile.text&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载AB测试资源</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadABTestResource</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;loadABTestResource()&quot;</span>);</span><br><span class="line">        CoroutineManager.Singleton.startCoroutine(loadTestResourceCoroutine());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载临时资源携程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function">IEnumerator <span class="title">loadTestResourceCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;loadTestResourceCoroutine()&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> testresourcefullpath = mABPath + mTestResourceFileName;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_ANDROID &amp;&amp; !UNITY_EDITOR</span></span><br><span class="line">        UnityEngine.Networking.UnityWebRequest www = UnityEngine.Networking.UnityWebRequest.Get(testresourcefullpath);</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> www.SendWebRequest();</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;ABTestFile Content : &#123;0&#125;&quot;</span>, www.downloadHandler.text));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="keyword">var</span> testresource = System.IO.File.ReadAllText(testresourcefullpath);</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;ABTestFile Content : &#123;0&#125;&quot;</span>, testresource));</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Android/AndroidResignAndReplaceResourceDynamically.png" alt="AndroidResignAndReplaceResourceDynamically"><br>至此我们成功完成了通过python编写了自动化重签APK，动态替换APK部分资源，动态修改AndroidManifest.xml内容的功能。</p>
<h1 id="Unity实战"><a href="#Unity实战" class="headerlink" title="Unity实战"></a>Unity实战</h1><p>待续……</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/6/docs/technotes/tools/windows/keytool.html">keytool</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/command-line/zipalign.html">zipalign</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/command-line/apksigner.html#usage">apksigner</a><br><a target="_blank" rel="noopener" href="https://ibotpeaches.github.io/Apktool/documentation/#decoding">Apktool</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/intro/">Android Studio</a><br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/userguide.html">Gradle</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Gradle">Gradle Wiki</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/30432152">如何通俗地理解 Gradle？</a><br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/tutorial_using_tasks.html">Build Script Basics</a><br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/more_about_tasks.html">Authoring Tasks</a></p>
<h2 id="Knowledge-Part"><a href="#Knowledge-Part" class="headerlink" title="Knowledge Part"></a>Knowledge Part</h2><p><a target="_blank" rel="noopener" href="https://developer.android.com/studio/publish/app-signing.html">Sign Your App</a><br><a target="_blank" rel="noopener" href="https://kknews.cc/tech/yxlvj.html">Android APK签名原理及方法</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000">Android签名机制之—签名过程详解</a><br><a target="_blank" rel="noopener" href="http://andrewlcgu.github.io/2016/04/17/apk-sign-theroy/">APK签名原理解析</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v7t7.html">JNI和NDK交叉编译进阶学习</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102vazu.html">NDK&amp;JNI&amp;Java&amp;Android初步学习总结归纳</a><br><a target="_blank" rel="noopener" href="http://google.github.io/android-gradle-dsl/current/index.html">Android DSL Android Plugin DSL Reference</a><br><a target="_blank" rel="noopener" href="https://guides.gradle.org/building-android-apps/?_ga=2.32380022.931589262.1533988091-1402562034.1533988091">Gradle - Building Android Apps</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a target="_blank" rel="noopener" href="http://implbits.com/products/hashtab/">HashTable</a><br><a target="_blank" rel="noopener" href="http://tomeko.net/online_tools/hex_to_base64.php?lang=en">Base64Website</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Native/">Native</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/06/12/Python使用/" title="Python使用" itemprop="url">Python使用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-06-12T14:45:55.000Z" itemprop="datePublished"> 发表于 2017-06-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Python-Study"><a href="#Python-Study" class="headerlink" title="Python Study"></a>Python Study</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h3 id="When"><a href="#When" class="headerlink" title="When"></a>When</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Python_(programming_language)">Python is a widely used high-level programming language for general-purpose programming, created by Guido van Rossum and first released in 1991.</a><br>Python第一版发布于1991年，由<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Guido_van_Rossum">Guido van Rossum</a>编写。</p>
<h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Python_(programming_language)">An interpreted language, Python has a design philosophy which emphasizes code readability (notably using whitespace indentation to delimit code blocks rather than curly brackets or keywords), and a syntax which allows programmers to express concepts in fewer lines of code than possible in languages such as C++ or Java.[22][23] The language provides constructs intended to enable writing clear programs on both a small and large scale.</a><br>首先我们要知道Python跟Lua一样，是解释型语言(不需要编译，通过解析执行，有自己的解析器)。Python设计理念强调可读性(通过缩进而非{}来表示代码块)。</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Python_(programming_language)">Python features a dynamic type system and automatic memory management and supports multiple programming paradigms, including object-oriented, imperative, functional programming, and procedural styles.</a><br>Python是动态类型语言，同时有自己的内存管理机制，支持多种编程范式(待深入学习了解)。</p>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p>了解了Python When &amp; What。那么我们Why什么要选择学习使用Python了？<br><a target="_blank" rel="noopener" href="https://www.python.org/about/">Python is powerful… and fast; plays well with others; runs everywhere; is friendly &amp; easy to learn; is Open. </a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Python_(programming_language)">supports multiple programming paradigms. It has a large and comprehensive standard library.[25]</a><br>把上面可以归纳如下:</p>
<ol>
<li>Run everywhere(跨平台)</li>
<li>Friendly &amp; easy to learn(学习更友好更容易(对于无编程经验的人更加友好，语法更nature))</li>
<li>Supports multiple programming paradigms(支持多种编程范式)</li>
<li>Large and comprehensive standard library(丰富的标准库和Package)</li>
</ol>
<p>Note:<br>这里提一句Python里很有名的一句话:<br>“Life is short, you need python.”</p>
<h2 id="IDE-Editor"><a href="#IDE-Editor" class="headerlink" title="IDE &amp; Editor"></a>IDE &amp; Editor</h2><p>学习任何一门编程语言，好的IDE或者Editor都能帮助我们更加快速的学习。<br>因为初学Python且Python是解析执行，这里暂时不考虑过于强大的IDE。<br>IDE详情选择可以参考<a target="_blank" rel="noopener" href="https://wiki.python.org/moin/IntegratedDevelopmentEnvironments">Python IDE</a><br>这里通过使用Sublime Text 3以及其Python相关的扩展插件作为学习Python的Editor。<br><a href="http://tonytang1990.github.io/2017/02/17/Editor-Sublime-Text-3/#Usefule_Commands">Sublime Text 3 Python相关插件设置详情</a></p>
<h2 id="Python-Version-Choosen"><a href="#Python-Version-Choosen" class="headerlink" title="Python Version Choosen"></a>Python Version Choosen</h2><p>Python有一个比较重要版本分割线2.x &amp; 3.x。<br>详情参见<a target="_blank" rel="noopener" href="https://wiki.python.org/moin/Python2orPython3">Python2orPython3</a><br>这里就不深入去了解2.x和3.x之间的区别了。<br>简单的理解就是3.x提供了更多更全的功能支持，同时有更多的丰富的库支持。如果作为初学者，并不需要维护老版本(2.x)的工具代码时，完全可以从3.x学起。</p>
<h2 id="Useful-Package"><a href="#Useful-Package" class="headerlink" title="Useful Package"></a>Useful Package</h2><h3 id="Pip"><a href="#Pip" class="headerlink" title="Pip"></a>Pip</h3><p>Python有丰富的标准库。而其中最重要也是新手第一时间就应该安装的就是Pip。<br>Pip对于Python就好比Package Control好比Sublime Text 3。<br>Pip(Python Package Index)是一个Python Package集中管理安装的扩展包。<br><a target="_blank" rel="noopener" href="https://pip.pypa.io/en/stable/installing/">Pip安装详情参考官方文档</a><br>Pip安装成功后我们就可以通过Pip去查看或安装丰富的Python Package了。<br>Package Install:<br><img src="/img/Python/PipPackageInstallation.PNG" alt="PipPackageInstallation"><br>Show Intalled Packages:<br><img src="/img/Python/PipListInstalledPackages.PNG" alt="PipListInstalledPackages"><br>安装之后的Package可以在安装目录查看到:<br><img src="/img/Python/PythonPackageLocation.PNG" alt="PythonPackageLocation"><br><a target="_blank" rel="noopener" href="https://pip.pypa.io/en/stable/user_guide/#installing-packages">更多关于Pip使用查看官方文档</a></p>
<h3 id="argparse"><a href="#argparse" class="headerlink" title="argparse"></a>argparse</h3><p>详细的介绍会在后面Tip的Command Line Args篇章</p>
<h2 id="Tutorial-基础篇"><a href="#Tutorial-基础篇" class="headerlink" title="Tutorial(基础篇)"></a>Tutorial(基础篇)</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><h4 id="Keywords-and-Identifier"><a href="#Keywords-and-Identifier" class="headerlink" title="Keywords and Identifier"></a>Keywords and Identifier</h4><p>Identifier(标识.e.g funcname, variable ……)定义规则:</p>
<ol>
<li>Keywords不能用做变量声明(这应该是任何语言都通用的规范了吧)</li>
<li>变量名不能以数字开头</li>
<li>变量名不能用特殊符号(e.g. !, @, #, $, %)<br>简单了解下Python的关键词：<br><img src="/img/Python/PythonKeywords.PNG" alt="PythonKeywords"></li>
</ol>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/keywords-identifier">Python is a case-sensitive language. This means, Variable and variable are not the same. Always name identifiers that make sense.</a><br>Python是大小写敏感的，大小写不同的变量名是不同变量。</p>
<h4 id="Statements-Comments"><a href="#Statements-Comments" class="headerlink" title="Statements &amp; Comments"></a>Statements &amp; Comments</h4><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/statement-indentation-comments">Instructions that a Python interpreter can execute are called statements.</a><br>Python可解析执行的语句叫做Statements。<br>多行Statements可以通过\或者[]或者{}或者()链接或封装：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> + <span class="number">2</span> + \</span><br><span class="line">    <span class="number">3</span> + <span class="number">4</span> + \</span><br><span class="line">    <span class="number">5</span> + <span class="number">6</span></span><br><span class="line"></span><br><span class="line">b = (<span class="number">1</span> + <span class="number">2</span> + <span class="number">3</span> + <span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>Python设计理念强调可读性(通过缩进而非{}来表示代码块)：<br>同时Python注释是通过# or ‘’’ or “””:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">if</span> i &gt;= <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;0&#125; &gt;= 5&quot;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># No break happends in for loop</span></span><br><span class="line">    <span class="comment"># Then execute this block</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No number is equal or greater than 5!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Docstring(Docstring is short for documentation string):<br>可以看出Docstring是一段文档描述(好比在C#里通过&#x2F;&#x2F;&#x2F;编写描述信息一样)。Python在书写格式上要求比较严，虽然不会导致报错，但会算作不是规范的写法，这也就是我们为什么会去安装Sublime Text 3 flake8这样的linter插件了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">addition</span>(<span class="params">par1, par2</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;This funtion is used to get result of (a + b).&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> par1 + par2</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(addition(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(addition.__doc__)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/DocString.PNG" alt="DocString"><br>可以看到我们定义了一个加法函数，并编写了docstring。<br>通过func_name.__doc__我们可以得到那段描述</p>
<h4 id="Python-I-O-and-Import"><a href="#Python-I-O-and-Import" class="headerlink" title="Python I&#x2F;O and Import"></a>Python I&#x2F;O and Import</h4><p>Python里的输入输出交互(好比C++里的cin,cout)是通过input和print。<br>因为需要交互所以需要在可执行Python代码的terminal里执行python脚本:<br><img src="/img/Python/PythonInputAndOutput.PNG" alt="PythonInputAndOutput"></p>
<p>因为Python的import是指import Module，我们需要知道Python里Module的定义，<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/modules">Modules refer to a file containing Python statements and definitions.</a><br>Modules在Python里是指一个文件所包含的所有定义和声明(以文件为单位划分，文件名即为import的名字)。</p>
<p>在import Module还有一个重要的点就是，我们需要知道Python查找所有*.py的搜索路径(跟环境变量有点像):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys.path:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(sys.path))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/ImoprtSearchPath.PNG" alt="ImoprtSearchPath"></p>
<p>我们可以指定只导入特定定义(e.g. from math import pi)</p>
<p>Note:<br>Python的Module和C#的namespace概念不一样，前者是以文件为单位，后者是以命名空间划分(支持在多个文件里定义在同一命名空间下)</p>
<h4 id="Python-Operators"><a href="#Python-Operators" class="headerlink" title="Python Operators"></a>Python Operators</h4><p>运算符跟大多数编程差不多，这里只讲几个比较特殊的:<br>Logical Operators:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="literal">True</span></span><br><span class="line">y = <span class="literal">False</span></span><br><span class="line"><span class="built_in">print</span>(x <span class="keyword">and</span> y)</span><br><span class="line"><span class="built_in">print</span>(x <span class="keyword">or</span> y)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonLogicalOperator.PNG" alt="PythonLogicalOperator"><br>或许跟Python提倡简洁明了有关，可以直接采用and or not之类的逻辑运算符</p>
<p>Identity operators：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">x1 = <span class="number">1</span></span><br><span class="line">y1 = <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;x1 is y1 = &quot;</span>, x1 <span class="keyword">is</span> y1)</span><br><span class="line">y1 = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;After y1 = 2. x1 is y1 = &quot;</span>, x1 <span class="keyword">is</span> y1)</span><br><span class="line"></span><br><span class="line">list1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">list2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;list1 is list2 = &quot;</span>, list1 <span class="keyword">is</span> list2)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonIdentityOperator.PNG" alt="PythonIdentityOperator"></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/operators">is and is not are used to check if two values (or variables) are located on the same part of the memory.</a><br><strong>List可以理解成分配了不同的内存去存储实际成员值所以是不同identity，上面x1 &#x3D; 1和y1 &#x3D; 1是located on the same part of the memory就需要理解后续会讲到的[Namespaces概念](<a href="http://tonytang1990.github.io/2017/06/12/Python-Study/#Object">http://tonytang1990.github.io/2017/06/12/Python-Study/#Object</a> &amp; Class)</strong></p>
<p>Membership operators:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">list3 = [<span class="number">1</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;H&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;T&#x27;</span> <span class="keyword">in</span> list3)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span> <span class="keyword">not</span> <span class="keyword">in</span> list3)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonMemberOperator.PNG" alt="PythonMemberOperator"></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/operators">in &amp; not in are used to test whether a value or variable is found in a sequence (string, list, tuple, set and dictionary).</a><br>in &amp; not in 主要是用于判断特定变量或者值是否存在于特定sequence里。</p>
<h3 id="Flow-Control"><a href="#Flow-Control" class="headerlink" title="Flow Control"></a>Flow Control</h3><p>if,elif,else,while,for这里主要记录一些Python相对于C++,C#,Java这些语言里的一些区别。</p>
<p>Python里是以:结束条件语句，以缩进表示层级。<br>while和for有一点比较特殊，支持else语句(没有break语句执行时)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">if</span> i &gt;= <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;0&#125; &gt;= 5&quot;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># No break happends in for loop</span></span><br><span class="line">    <span class="comment"># Then execute this block</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No number is equal or greater than 5!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/FlowControlForUsing.PNG" alt="FlowControlForUsing"></p>
<h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><p>Python的Function定义关键词是def，格式如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func_name</span>(<span class="params">paras</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Docstring&quot;&quot;&quot;</span></span><br><span class="line">    Statements</span><br></pre></td></tr></table></figure>

<p>Python支持显示传递参数，也支持默认参数和不限数量参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># User-defined functions</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_python_function</span>(<span class="params">para1, dp1=<span class="string">&quot;dp1&quot;</span>, dp2=<span class="string">&quot;dp2&quot;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;My Python Function Docstring.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Build-in functions</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;my_python_function(para1:&#123;0&#125; dp1:&#123;1&#125; dp2:&#123;2&#125;)&quot;</span>.<span class="built_in">format</span>(para1, dp1, dp2))</span><br><span class="line"></span><br><span class="line">my_python_function(<span class="string">&quot;Tony&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Keyword para call</span></span><br><span class="line">my_python_function(dp1=<span class="string">&quot;ndp1&quot;</span>, para1=<span class="string">&quot;Tang&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Parameters without length limited</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arbitrary_para_function</span>(<span class="params">*paras</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Python function without length of parameter limitation.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> para <span class="keyword">in</span> paras:</span><br><span class="line">        <span class="built_in">print</span>(para)</span><br><span class="line"></span><br><span class="line">arbitrary_para_function(<span class="string">&quot;para1&quot;</span>, <span class="string">&quot;para2&quot;</span>, <span class="string">&quot;para3&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonFunctionDefinition.PNG" alt="PythonFunctionDefinition"></p>
<p>Python也支持匿名函数(Lambda Function),只是不像C++，C#使用(x)&#x3D;&gt;表示而是lambda x:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqrfunc = <span class="keyword">lambda</span> x: x * <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(sqrfunc(<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonAnonymousFunction.PNG" alt="PythonAnonymousFunction"></p>
<h4 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h4><p>C,C++里有#include。C#有using。Java有import。Python里有Modules。<br>但Python里的Modules更像C,C++是针对文件为单位。<br>使用的时候通过import filename即可(也支持指定别名 as newname)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_first_python_func</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;MyFirstPython.py&#x27;s function.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;my_first_python_func() called&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> MyFirstPython <span class="keyword">as</span> MFP</span><br><span class="line"></span><br><span class="line">MFP.my_first_python_func()</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonModuleImportAndUsing.PNG" alt="PythonModuleImportAndUsing"></p>
<p>知道了Python是以文件为单位导入的，那么我们也需要知道Python导入文件时的搜索路径(通过打印sys.path即可)</p>
<p>Note:<br>Python也支持只导入指定文件里的指定对象<br>e.g.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> pi</span><br></pre></td></tr></table></figure>

<h4 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h4><p>C++，C#里有namespace。Java有package。Python里有Package(相当于Java里package和C#里namespace概念，负责抽象对应Directory到指定Package里)<br>Steps:</p>
<ol>
<li>创建文件夹(文件夹名作为Package Name)</li>
<li>文件夹目录下创建一个__init__.py文件(默认可以不写任何内容)</li>
<li>通过import PackageName.Module引入特定文件<br>e.g.</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> MyPackage.MyFirstPython</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonPackageUsing.PNG" alt="PythonPackageUsing"></p>
<p>Note:<br>Package是针对Directory而言，Module是针对file而言</p>
<h3 id="Datatypes"><a href="#Datatypes" class="headerlink" title="Datatypes"></a>Datatypes</h3><p>Variable变量赋值在Python里简单明了:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p1 = <span class="number">1</span></span><br><span class="line">p2, p3, p4 = <span class="number">2</span>, <span class="number">3</span>, <span class="string">&quot;Tony&quot;</span></span><br><span class="line"><span class="built_in">print</span>(p1, p2, p3, p4)</span><br></pre></td></tr></table></figure>

<p>判断数据类型Python是通过type()这个类似C#GetType()。<br>判断是否是某个类型实例Python是通过isinstance()，类似于Python里的is关键词。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;My first class.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    name</span><br><span class="line"></span><br><span class="line">myclassinstance = MyClass()</span><br><span class="line">myclassinstance.name = <span class="string">&quot;Tony&quot;</span></span><br><span class="line">mystring = <span class="string">&quot;Tony&quot;</span></span><br><span class="line"><span class="built_in">print</span>(myclassinstance, <span class="string">&quot; is typeof &quot;</span>, <span class="built_in">type</span>(myclassinstance))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;myclassinstance is typeof MyClass:&quot;</span>, <span class="built_in">isinstance</span>(myclassinstance, MyClass))</span><br><span class="line"><span class="built_in">print</span>(mystring, <span class="string">&quot; is typeof &quot;</span>, <span class="built_in">type</span>(mystring))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/DataTypeCheck.PNG" alt="DataTypeCheck"><br>可以看出在Python是弱语言类型，声明变量是无需显示指定变量类型。<br>同时通过type和isinstance可以判断实例对象类型。</p>
<p>Note:<br>这里的Data Type是指实例对象的类型，Python是弱类型语言。</p>
<h4 id="Basic-Data-Types"><a href="#Basic-Data-Types" class="headerlink" title="Basic Data Types"></a>Basic Data Types</h4><p>Python支持大部分基本数据类型，e.g. int, float等。<br>有一点比较特殊的是Python支持complex numbers(复数)：x + yj(x为实部，yj为虚部)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cn = <span class="number">2</span> + <span class="number">3j</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;cn = &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(cn))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/ComplexNumber.PNG" alt="ComplexNumber"><br>同时表示不同进制的Number只需添加不同前缀即可：<br><img src="/img/Python/NumberSystem.PNG" alt="NumberSystem"></p>
<h5 id="List"><a href="#List" class="headerlink" title="List"></a>List</h5><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">List is an ordered sequence of items. It is one of the most used datatype in Python and is very flexible. All the items in a list do not need to be of the same type.</a><br>Python的List好比数组，但是更灵活，可存储不同类型的对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pythonList = [<span class="number">1</span>, <span class="string">&quot;a&quot;</span>, <span class="number">3.0</span>, <span class="literal">True</span>]</span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> pythonList:</span><br><span class="line">    <span class="built_in">print</span>(member, <span class="string">&quot; is typof &quot;</span>, <span class="built_in">type</span>(member))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonList.PNG" alt="PythonList"></p>
<p>更多的List处理参见List.Method和其他Build-in Functions(比如len(),sorted()等)</p>
<p>Note：<br>List是通过[]定义。</p>
<h5 id="Tuple"><a href="#Tuple" class="headerlink" title="Tuple"></a>Tuple</h5><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">Tuple is an ordered sequence of items same as list.The only difference is that tuples are immutable. Tuples once created cannot be modified.</a><br>Tuple和List的唯一区别就是创建后不可再被改变，但如果内嵌可变的(e.g. List)那么List的数据是可以被改变的。Tuple是通过()定义内容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">my_tuple = (<span class="number">1</span>, <span class="string">&quot;string&quot;</span>, [<span class="number">1</span>, <span class="string">&quot;th&quot;</span>])</span><br><span class="line">my_tuple[<span class="number">2</span>][<span class="number">0</span>] = <span class="number">2</span></span><br><span class="line"><span class="keyword">for</span> tuplemember <span class="keyword">in</span> my_tuple:</span><br><span class="line">    <span class="built_in">print</span>(tuplemember)</span><br><span class="line"><span class="keyword">del</span> my_tuple</span><br><span class="line"><span class="comment"># my_tuple -- Error: name &#x27;my_tuple&#x27; is not defined</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/TupleUsing.PNG" alt="TupleUsing"><br>从上面可以看出del关键词可以删除变量的引用。</p>
<p>Note：<br>Tuple是通过()定义。<br>Tuple相比List更适合用于存储固定的不同数据类型的数据。<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/keyword-list#del">Everything is object in Python.</a>(这一点跟Java，C#一样)</p>
<h5 id="Strings"><a href="#Strings" class="headerlink" title="Strings"></a>Strings</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mypythonstring = <span class="string">&quot;我的名字是TonyTang&quot;</span></span><br><span class="line"><span class="built_in">print</span>(mypythonstring)</span><br><span class="line"><span class="built_in">print</span>(mypythonstring[<span class="number">0</span>])</span><br><span class="line">mypythonstring[<span class="number">0</span>] = <span class="string">&#x27;你&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonStrings.PNG" alt="PythonStrings"></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">String is sequence of Unicode characters. Strings are immutable</a><br>Python里是采用Unicode编码存储字符串。Strings可以通过[]访问，但是不可被改变的。<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/string">We cannot delete or remove characters from a string. But deleting the string entirely is possible using the keyword del.</a>因为string是immutable的，所以我们不能通过del删除string里面的个别character，但是我们可以删除对string的整个引用。</p>
<h5 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h5><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">Set is an unordered collection of unique items. Set is defined by values separated by comma inside braces { }. Items in a set are not ordered.</a><br>Set也是一系列数据的集合类型，但是是无序的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mySet1 = &#123;<span class="number">1</span>, <span class="string">&quot;a&quot;</span>, <span class="number">2</span>, <span class="string">&quot;b&quot;</span>, <span class="number">1</span>&#125;</span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> mySet1:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;member in mySet1:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(member))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonSet.PNG" alt="PythonSet"><br>可以看出因为Set是无序的，连循环遍历出来的结果也是不确定的。所以针对Set，[]访问就是无意义也是不被允许的。</p>
<p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/set">Every element is unique (no duplicates) and must be immutable (which cannot be changed).</a><br>Set还有一点特性就是成员是唯一且不可变的同时支持类似于集合与或等操作:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mySet2 = &#123;<span class="string">&quot;a&quot;</span>, <span class="number">2</span>, <span class="string">&quot;b&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> (mySet1 &amp; mySet2):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;member in (mySet1 &amp; mySet2):&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(member))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> (mySet1 - mySet2):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;member in (mySet1 - mySet2):&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(member))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/SetStudy.PNG" alt="SetStudy"></p>
<p>Note：<br>Set是通过{}定义。<br>更多操作参考Set.API</p>
<h5 id="Dictionary"><a href="#Dictionary" class="headerlink" title="Dictionary"></a>Dictionary</h5><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">Dictionary is an unordered collection of key-value pairs.</a><br>Python里的Dictionary跟C#里的Dictionary差不多，代表无序的Key-Value主键值对。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myDictionary = &#123;<span class="number">1</span>: <span class="string">&quot;Tony&quot;</span>, <span class="string">&quot;Tang&quot;</span>: <span class="number">2</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(myDictionary[<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(myDictionary[<span class="string">&quot;Tang&quot;</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonDictionary.PNG" alt="PythonDictionary"><br>可以看出Python里Dictionary的键值对定义时通过:分割，然后通过[]去方案对应Key得到Value值。</p>
<p>Note：<br>Dictionary是通过{}定义。<br>更多操作参考Dictionary.API</p>
<h4 id="Conversion-between-data-types"><a href="#Conversion-between-data-types" class="headerlink" title="Conversion between data types"></a>Conversion between data types</h4><p>基础数据类型转换通过int,float,complex显示转换即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">myint = <span class="built_in">int</span>(<span class="number">2.5</span>)</span><br><span class="line"><span class="built_in">print</span>(myint)</span><br><span class="line">mylist = <span class="built_in">list</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> mylist:</span><br><span class="line">    <span class="built_in">print</span>(member)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonDataConversion.PNG" alt="PythonDataConversion"></p>
<h3 id="Files"><a href="#Files" class="headerlink" title="Files"></a>Files</h3><h4 id="File-Operation"><a href="#File-Operation" class="headerlink" title="File Operation"></a>File Operation</h4><p>首先看看最新官方文档给出的API说明:<br><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/functions.html#open">open(file, mode&#x3D;’r’, buffering&#x3D;-1, encoding&#x3D;None, errors&#x3D;None, newline&#x3D;None, closefd&#x3D;True, opener&#x3D;None)</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># try: finally: Make sure f close successfully</span></span><br><span class="line"><span class="comment"># specify encoding=&#x27;utf-8&#x27; is used to avoid platform dependent problems</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;./FilesFolder/TonyTangFile.txt&quot;</span>, mode=<span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        <span class="built_in">print</span>(line)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Another way to make sure file close successfully</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./FilesFolder/TonyTangFile.txt&quot;</span>, mode=<span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># Do file operation here</span></span><br><span class="line">    f.write(<span class="string">&quot;Flow my heart!\nI have a dream!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonFileOperation.PNG" alt="PythonFileOperation"><br>从上面可以看到，open的几个关键参数，mode决定了可读还是可写等模式，encoding决定编码格式是为了确保不同平台脚本的一致性。</p>
<h4 id="Directory"><a href="#Directory" class="headerlink" title="Directory"></a>Directory</h4><p>Python提供了<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/os.html">os module</a>支持很多文件夹目录操作的API</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(os.getcwd())</span><br><span class="line"><span class="built_in">print</span>(os.listdir())</span><br><span class="line">os.chdir(<span class="string">&quot;./FilesFolder&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(os.getcwd())</span><br><span class="line"><span class="keyword">if</span> os.path.exists(<span class="string">&quot;MyNewFilesFolder&quot;</span>) == <span class="literal">False</span>:</span><br><span class="line">    os.mkdir(<span class="string">&quot;MyNewFilesFolder&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(os.listdir())</span><br><span class="line"><span class="keyword">if</span> os.path.exists(<span class="string">&quot;MyRenameFilesFolder&quot;</span>) == <span class="literal">True</span>:</span><br><span class="line">    os.removedirs(<span class="string">&quot;MyRenameFilesFolder&quot;</span>)</span><br><span class="line">os.rename(<span class="string">&#x27;MyNewFilesFolder&#x27;</span>, <span class="string">&#x27;MyRenameFilesFolder&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(os.listdir())</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonDirectory.PNG" alt="PythonDirectory"><br>从上面可以看出Python的API都很简洁明了，跟bat，shell很像，具体使用过程中主要还是按需求差文档写自己的自动化即可。</p>
<h4 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h4><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/exceptions">Python Exception</a><br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/exception-handling">Exception Handling</a><br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/user-defined-exception">User-defined Exception</a></p>
<h3 id="Object-Class"><a href="#Object-Class" class="headerlink" title="Object &amp; Class"></a>Object &amp; Class</h3><h4 id="Name"><a href="#Name" class="headerlink" title="Name"></a>Name</h4><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/namespace">Name (also called identifier) is simply a name given to objects.</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(2) = &#x27;</span>, <span class="built_in">id</span>(<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(a) = &#x27;</span>, <span class="built_in">id</span>(a))</span><br><span class="line"></span><br><span class="line">a = a + <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(a) = &#x27;</span>, <span class="built_in">id</span>(a))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(3) = &#x27;</span>, <span class="built_in">id</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(2) = &#x27;</span>, <span class="built_in">id</span>(<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;id(b) = &#x27;</span>, <span class="built_in">id</span>(b))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonNameOutput.PNG" alt="PythonNamespaceOutput"><br>id()适用于打印object地址，从上面的输出可以看到只要Name指向Object的值是一致的，那么他们所指向的地址就是一致的。详情参考下图:<br><img src="/img/Python/PythonName.PNG" alt="PythonName"><br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/namespace">This is efficient as Python doesn’t have to create a new duplicate object. This dynamic nature of name binding makes Python powerful; a name could refer to any type of object.</a></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/namespace">Everything in Python is an object.</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> this</span><br></pre></td></tr></table></figure>

<p>上面这段代码很有意思，会在控制台打印出Python的编程哲学:<br><img src="/img/Python/TheZenOfPython.PNG" alt="TheZenOfPython"></p>
<h4 id="Namepsace-Scope"><a href="#Namepsace-Scope" class="headerlink" title="Namepsace &amp; Scope"></a>Namepsace &amp; Scope</h4><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/namespace">namespace is a collection of names.</a>(前面讲解了什么是Name，接下来要理解的Namespace就好比一系列Name的集合)<br>我们平时用到的Build-in Functions就属于Build-in Namespace里。<br>让我们结合下图看看Python里Namespace的层级：<br><img src="/img/Python/PythonNamespaceHierarchical.PNG" alt="PythonNamespaceHierarchical"></p>
<p>讲完Namespace，Python里还有一点跟Namespace密切相关的Scope:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/namespace">Scope is the portion of the program from where a namespace can be accessed directly without any prefix.</a>(Namespace在Python就好比C++,C#里的namespace。Scope就好比C++,C#里变量的有效区域。)</p>
<p>现阶段主要分为3中Scope:</p>
<ol>
<li>Scope of the current function which has local names(当前function scope)</li>
<li>Scope of the module which has global names(全局scope)</li>
<li>Outermost scope which has build-in names(最外层Build-in scope)</li>
</ol>
<p>接下来透过实例学习理解Python里的Scope:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">outer_function</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Outer Function.&quot;&quot;&quot;</span></span><br><span class="line">    a = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner_function</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Inner Function.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">global</span> a</span><br><span class="line">        a = <span class="number">30</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;a = &quot;</span>, a)</span><br><span class="line"></span><br><span class="line">    inner_function()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;a = &quot;</span>, a)</span><br><span class="line"></span><br><span class="line">a = <span class="number">10</span></span><br><span class="line">outer_function()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a = &quot;</span>, a)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonScope.PNG" alt="PythonScope"><br>可以看出在Function内的定义因为在不同的Scope不会覆盖Global Scope的a定义。当我们显示指定Function Scope里的a为global的a时，我们可以在Function Scope内引用到Global的a。</p>
<h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h4><p>接触过面向对象编程的人应该对Class都不陌生，他是我们抽象对象定义的关键类型。<br>在面向对象编程语言的Python里Class也起着同样的作用，只不过定义的方式有所区别，详情如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyFirstClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;docstring for MyClass&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Class Constructor.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>(MyFirstClass, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.name = arg</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sayhi</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Class Member Function.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">printname</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Print name member.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;self.name = &quot;</span>, <span class="variable language_">self</span>.name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里因为我是定义在MyFirstPython.py文件里的，所以导入的是MyFirstPython</span></span><br><span class="line"><span class="keyword">import</span> MyFirstPython</span><br><span class="line">mfp = MyFirstPython.MyFirstClass(<span class="string">&quot;Tony&quot;</span>)</span><br><span class="line">mfp.sayhi()</span><br><span class="line">mfp.printname()</span><br><span class="line"><span class="built_in">print</span>(mfp.name)</span><br><span class="line">mfp.age = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(mfp.age)</span><br><span class="line"><span class="keyword">del</span> mfp.name</span><br><span class="line"><span class="comment"># mfp.printname() AttributeError: &#x27;MyFirstClass&#x27; object has no attribute &#x27;name&#x27;</span></span><br><span class="line"><span class="keyword">del</span> mfp</span><br><span class="line"><span class="comment"># mfp.sayhi() NameError: name &#x27;mfp&#x27; is not defined</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PythonClassDefinition.PNG" alt="PythonClassDefinition"><br>从上面可以看出Python里Class的定义格式如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">classname</span>(<span class="params">父类</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Docstring Class description.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Docstring Constructor description.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># constructor&#x27;s body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">functionname</span>(<span class="params">arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;DocString Member Function description.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># body</span></span><br></pre></td></tr></table></figure>

<p>__init__就好比C++里的构造函数。<br>Python里的继承写法:classname()括号里面跟的是父类，在子类可以通过super去访问父类。<br>值得一提的是Docstring，每一个类或者方法都有Docstring，我们可以通过classname.__doc__的方式去访问。<br>同时我们看到Python里还可以在运行时动态定义成员变量(e.g. mfp.age)<br>Python里不是通过new关键词去实例化类对象，但del关键词就好比C++里和new配对的delete，但这里的delete不仅是针对new出来的实例化对象进行回收，还能针对特定实例化成员进行删除。(当我们del mfp实例对象时，我们只是把mfp的对于Object的引用从corresponding namespace里移除而非真的销毁内存里Object。真正的销毁是发生在没有人在绑定到该Object时。)</p>
<p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/class">This automatic destruction of unreferenced objects in Python is also called garbage collection.</a>(真正的销毁就好比C++里的GC对内存进行释放)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/class">Python is an object oriented programming language.</a></p>
<h4 id="Inheritance"><a href="#Inheritance" class="headerlink" title="Inheritance"></a>Inheritance</h4><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/multiple-inheritance">Like C++, a class can be derived from more than one base classes in Python. This is called multiple inheritance.</a></p>
<p>关于继承这里就不多讲了，大家参考文档介绍。</p>
<h4 id="Operator-Overloading"><a href="#Operator-Overloading" class="headerlink" title="Operator Overloading"></a>Operator Overloading</h4><p>Operator Overloading翻译过来应该是运算符重载。</p>
<p>在了解Operator Overloading之前，让我们来了解下Python Class里的一些特殊方法。</p>
<p>这里的特殊方法学过lua的同学应该会感到很亲切:</p>
<ol>
<li><strong>new</strong> – New一个Class的实例对象时会被调用</li>
<li><strong>init</strong> – Class的构造函数(父类构造函数需要手动调用，默认不递归调用)</li>
<li><strong>del</strong> – Class实例对象销毁时调用(类似C#析构函数)</li>
<li><strong>class</strong> – 访问类的静态变量的时候(实例对象可以直接通过self访问)</li>
<li><strong>str</strong> – str()，format()以及print()函数触发Class获取字符串表达方法</li>
<li><strong>lt</strong> – &lt;运算符操作时调用</li>
<li><strong>le</strong> – &#x3D;&#x3D;运算法操作时调用</li>
<li><strong>hash</strong> – hash()方法计算Class实例对象Hash值时</li>
<li><strong>getattr</strong> – 访问Class成员不能存在时调用(类似Lua的__index元方法)</li>
<li><strong>setattr</strong> – 设置Class成员值时调用(类似Lua的__newindex元方法)</li>
<li>……</li>
</ol>
<p>更多特殊方法参考:<a target="_blank" rel="noopener" href="https://docs.python.org/3/reference/datamodel.html#special-method-names">Special method names</a></p>
<p>从上面可以看出Python和Lua有很多相似的地方。</p>
<p>接下来让我们看看实战效果:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MyFirstPython.py</span></span><br><span class="line"><span class="comment"># File Name: 		MyFirstPython.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study python</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2017/6/5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyFirstClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="string">&quot;&quot;&quot;docstring for MyClass&quot;&quot;&quot;</span></span><br><span class="line">	<span class="comment"># class Static Member</span></span><br><span class="line">	age = <span class="number">10</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 构造函数</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">		<span class="string">&quot;&quot;&quot;Class Constructor.&quot;&quot;&quot;</span></span><br><span class="line">		<span class="built_in">super</span>().__init__()</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;MyFirstClass:__init__(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">		<span class="variable language_">self</span>.name = name</span><br><span class="line"></span><br><span class="line">	<span class="comment"># str()，format()以及print()函数触发</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;MyFirstClass name:&#123;&#125; age:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>.name, <span class="variable language_">self</span>.age)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 获取不存在成员时触发</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;MyFirstClass:__getattr__(&#123;&#125;) not exist!&quot;</span>.<span class="built_in">format</span>(name))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 设置成员值时触发</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name, value</span>):</span><br><span class="line">		<span class="built_in">super</span>().__setattr__(name, value)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;MyFirstClass:__setattr__(&#123;&#125;, &#123;&#125;)!&quot;</span>.<span class="built_in">format</span>(name, value))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 加号运算符重载</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">		newName = <span class="variable language_">self</span>.name + other.name</span><br><span class="line">		<span class="keyword">return</span> MyFirstClass(newName)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">sayhi</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="string">&quot;&quot;&quot;Class Member Function.&quot;&quot;&quot;</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;MyFirstClass:sayhi() Hello World!&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">printname</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="string">&quot;&quot;&quot;Print name member.&quot;&quot;&quot;</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;MyFirstClass:printname() self.name = &quot;</span>, <span class="variable language_">self</span>.name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_first_python_func</span>():</span><br><span class="line">	<span class="string">&quot;&quot;&quot;MyFirstPython.py&#x27;s function.&quot;&quot;&quot;</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;my_first_python_func() called&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Class e.g.</span></span><br><span class="line">mfp = MyFirstPython.MyFirstClass(<span class="string">&quot;Tony&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(mfp.__class__.age)</span><br><span class="line">mfp.sayhi()</span><br><span class="line">mfp.printname()</span><br><span class="line"><span class="built_in">print</span>(mfp.name)</span><br><span class="line"><span class="built_in">print</span>(mfp.noneexitname)</span><br><span class="line">mfp.age = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(mfp.age)</span><br><span class="line"><span class="built_in">print</span>(mfp)</span><br><span class="line">mfp2 = MyFirstPython.MyFirstClass(<span class="string">&quot;Tang&quot;</span>)</span><br><span class="line">tempMfp = mfp + mfp2</span><br><span class="line"><span class="built_in">print</span>(tempMfp)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/ClassSpecialFunctionsOutput.png" alt="ClassSpecialFunctionsOutput"></p>
<p>通过上面的学习用例，可以看到我们通过自定义__init__,<strong>str</strong>,<strong>getattr</strong>,<strong>setattr</strong>,__add__等特殊方法实现了类构造，类成员自定义访问设置，类+运算符重载，类print()等方法自定义输出等效果。看到这里，不得不说Python特殊方法和Lua的元方法概念很像。</p>
<h3 id="Iterator"><a href="#Iterator" class="headerlink" title="Iterator"></a>Iterator</h3><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/iterator">Iterator in Python is simply an <a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/class">object</a> that can be iterated upon. An object which will return data, one element at a time.</a></p>
<p>这里的Iterator和C#里的迭代器应该是一个概念。实现迭代器需要实现两个特殊方法(<strong>iter__和__next</strong>)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Name: 		IteratorStudy.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study python iterator</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2021/5/25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 迭代器类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IteratorClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="string">&quot;&quot;&quot;Class to implement an iterator&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 构造函数</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, <span class="built_in">max</span></span>):</span><br><span class="line">		<span class="built_in">super</span>().__init__()</span><br><span class="line">		<span class="variable language_">self</span>.<span class="built_in">max</span> = <span class="built_in">max</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 返回迭代器</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;IteratorClass:__iter__()&quot;</span>)</span><br><span class="line">		<span class="variable language_">self</span>.n = <span class="number">0</span></span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 迭代器MoveNext</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;IteratorClass:__next__()&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="variable language_">self</span>.n &lt;= <span class="variable language_">self</span>.<span class="built_in">max</span>:</span><br><span class="line">			value = <span class="variable language_">self</span>.n</span><br><span class="line">			<span class="variable language_">self</span>.n += <span class="number">1</span></span><br><span class="line">			<span class="keyword">return</span> value</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">raise</span> StopIteration</span><br><span class="line"></span><br><span class="line">iteratorClassInstance = IteratorClass(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">iter</span> <span class="keyword">in</span> iteratorClassInstance:</span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">iter</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/IteratorOuput.png" alt="IteratorOuput"></p>
<h3 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h3><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/generator">Python generators are a simple way of creating iterators. Simply speaking, a generator is a function that returns an object (iterator) which we can iterate over (one value at a time). </a></p>
<p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/generator">It is fairly simple to create a generator in Python. It is as easy as defining a normal function, but with a <code>yield</code> statement instead of a <code>return</code> statement.</a></p>
<p>看介绍Generators的概念和C#的携程差不多。</p>
<p>Generator和普通方法的区别:</p>
<ol>
<li>Generator function contains one or more <code>yield</code> statements.</li>
<li>When called, it returns an object (iterator) but does not start execution immediately.</li>
<li>Methods like <code>__iter__()</code> and <code>__next__()</code> are implemented automatically. So we can iterate through the items using <code>next()</code>.</li>
<li>Once the function yields, the function is paused and the control is transferred to the caller.</li>
<li>Local variables and their states are remembered between successive calls.</li>
<li>Finally, when the function terminates, <code>StopIteration</code> is raised automatically on further calls.</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generator</span></span><br><span class="line">GeneratorVariable = <span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GeneratorFunction</span>():</span><br><span class="line">	<span class="keyword">global</span> GeneratorVariable</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;GeneratorFunction() &#123;&#125;&quot;</span>.<span class="built_in">format</span>(GeneratorVariable))</span><br><span class="line">	<span class="keyword">yield</span> GeneratorVariable</span><br><span class="line">	GeneratorVariable += <span class="number">1</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;GeneratorFunction() &#123;&#125;&quot;</span>.<span class="built_in">format</span>(GeneratorVariable))</span><br><span class="line">	<span class="keyword">yield</span> GeneratorVariable</span><br><span class="line">	GeneratorVariable += <span class="number">1</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;GeneratorFunction() &#123;&#125;&quot;</span>.<span class="built_in">format</span>(GeneratorVariable))</span><br><span class="line">	<span class="keyword">yield</span> GeneratorVariable</span><br><span class="line">	</span><br><span class="line">GeneratorFunc = GeneratorFunction()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;GeneratorFunction Start&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> generator <span class="keyword">in</span> GeneratorFunc:</span><br><span class="line">	<span class="built_in">print</span>(generator)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/GeneratorOuput.png" alt="GeneratorOuput"></p>
<p>可以看到Generator在Python里还能直接通过for循环的形式便利这一点和C#的携程还不太一样。</p>
<p>通过Generator我们可以简化自定义Iterator的写法，无需自定义__iter__和__next__方法，通过自定义的Generator方法即可实现迭代效果。Generator更多好处参考:<a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/generator">Generator</a></p>
<h3 id="Closure"><a href="#Closure" class="headerlink" title="Closure"></a>Closure</h3><p>Closure指类似传统语言里的闭包，但在Python里有几个较大的区别：</p>
<ol>
<li>闭包访问外围变量时，默认是只读的，需要通过nonlocal关键字来标识闭包内部可写。</li>
<li>闭包必须是嵌套函数定义</li>
<li>嵌套函数必须访问外部成员</li>
<li>外围函数必须返回嵌套函数自身</li>
</ol>
<p>Python里用闭包的好处：</p>
<p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/closure">Closures can avoid the use of global values and provides some form of data hiding. It can also provide an object oriented solution to the problem.</a></p>
<h3 id="Decorators"><a href="#Decorators" class="headerlink" title="Decorators"></a>Decorators</h3><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/decorator">A decorator takes in a function, adds some functionality and returns it.</a></p>
<p>看介绍Decorator像是设计模式里的修饰器概念，能够做到给现有功能添加额外功能的作用。</p>
<p>看介绍利用万物皆object的概念(类似Lua里第一类值)的概念，实现封装函数调用实现扩展函数功能。</p>
<p>还有更多更复杂的使用方式，详情参考:<a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/decorator">Decorators</a></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/decorator">everything in Python (Yes! Even classes), are [objects].</a></li>
</ol>
<h3 id="Property"><a href="#Property" class="headerlink" title="Property"></a>Property</h3><p>Property类似于C#里的属性概念。Python通过关键字@property实现属性的快速定义。</p>
<p><img src="/img/Python/PropertyKeywordDefinition.png" alt="PropertyKeywordDefinition"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Name: 		PropertyStudy.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study python property</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2021/5/25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 属性类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PropertyClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="string">&quot;&quot;&quot;Class to implement an property&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 构造函数</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, propertyvalue</span>):</span><br><span class="line">		<span class="built_in">super</span>().__init__()</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;PropertyClass.__init__()&quot;</span>)</span><br><span class="line">		<span class="variable language_">self</span>.Property = propertyvalue</span><br><span class="line"></span><br><span class="line"><span class="meta">	@property</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">Property</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Getting Property Value : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>._Property))</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">self</span>._Property</span><br><span class="line"></span><br><span class="line"><span class="meta">	@Property.setter</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">Property</span>(<span class="params">self, value</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Setting Property Value : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(value))</span><br><span class="line">		<span class="variable language_">self</span>._Property = value</span><br><span class="line"></span><br><span class="line">propertyClassInstance = PropertyClass(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(propertyClassInstance.Property)</span><br><span class="line">propertyClassInstance.Property = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(propertyClassInstance.Property)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PropertyOutput.png" alt="PropertyOutput"></p>
<p>更多学习参考:[Property][<a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/property]">https://www.programiz.com/python-programming/property]</a></p>
<h3 id="RegEx"><a href="#RegEx" class="headerlink" title="RegEx"></a>RegEx</h3><h3 id="Date-and-Time"><a href="#Date-and-Time" class="headerlink" title="Date and Time"></a>Date and Time</h3><h3 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h3><p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/multiprocessing.html">multiprocessing is a package that supports spawning processes using an API similar to the threading module.</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/threading.html#module-threading">threading module constructs higher-level threading interfaces on top of the lower level _thread module.</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/subprocess.html">The subprocess module allows you to spawn new processes, connect to their input&#x2F;output&#x2F;error pipes, and obtain their return codes. This module intends to replace several older modules and functions：os.system os.spawn*</a></p>
<p>从介绍可以看出，multiprocessing包是用于支持多进程类似多线程功能的模块。</p>
<p>threading是多线程的一个上层抽象模块。</p>
<p>multiprocessing是多进程的一个上层抽象模块(相比threading，不受限于**Global Interpreter Lock(多线程锁，限定同时只有一个Thread执行)**可以真正利用多核来跑多进程功能。</p>
<p>subprocess模块是封装的更好的一个创建使用子进程的模块，同时提供了和子进程处理交互相关的接口。</p>
<p>这里我们重点学习process相关即multiprocessing和subprocess相关概念和使用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">	File Name: 		MultiProcessStudy.py</span></span><br><span class="line"><span class="string">	Description: 		This file is used to study python subprocess</span></span><br><span class="line"><span class="string">	Author:  			TangHuan</span></span><br><span class="line"><span class="string">	Create Date:  	2021/8</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_task</span>(<span class="params">subProcessName</span>):</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;subProcessName:&#123;0&#125; Process pid:&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(subProcessName, os.getpid()))</span><br><span class="line">	start = time.time()</span><br><span class="line">	time.sleep(random.random())</span><br><span class="line">	end = time.time()</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;SubProcess:&#123;0&#125; Process pid:&#123;1&#125; runs:&#123;2&#125; seconds!&quot;</span>.<span class="built_in">format</span>(subProcessName, os.getpid(), end - start))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;MultiProcessStudy&quot;</span>)</span><br><span class="line">	<span class="comment"># 打印主进程id</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;Current Process pid:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid()))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 创建4个多进程(子进程)的进程池</span></span><br><span class="line">	p = Pool(<span class="number">4</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">		p.apply_async(process_task, args=(<span class="string">&quot;SubProcess&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(i),))</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;Waiting for all subprocesses done.&quot;</span>)</span><br><span class="line">	<span class="comment"># 停止提交更多的任务到p里</span></span><br><span class="line">	p.close()</span><br><span class="line">	<span class="comment"># 等待p里的所有子线程任务完成</span></span><br><span class="line">	p.join()</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;All subprocesses done.&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># SubProcess的方式开启子进程1</span></span><br><span class="line">	subProcess1 = subprocess.Popen([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;SubProcess1.py&#x27;</span>])</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;start SubProcess1&quot;</span>)</span><br><span class="line">	<span class="comment"># SubProcess的方式开启子进程2</span></span><br><span class="line">	subProcess2 = subprocess.Popen([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;SubProcess2.py&#x27;</span>])</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;start SubProcess2&quot;</span>)</span><br><span class="line">	<span class="comment"># 等待子进程1完成</span></span><br><span class="line">	subProcess1.wait()</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;SubProcess1 complete&quot;</span>)</span><br><span class="line">	<span class="comment"># 等待子进程2完成</span></span><br><span class="line">	subProcess2.wait()</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;SubProcess2 complete&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Name: 		SubProcess1.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study python subprocess</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2021/8/7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess1-1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess1 parent pid:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(os.getppid()))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess1 pid:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid()))</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess1-2&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Name: 		SubProcess2.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study python subprocess</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2021/8/7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess2-1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess2 parent pid:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(os.getppid()))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess2 pid:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid()))</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SubProcess2-2&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/MultiProcessingOutput.png" alt="MultiProcessingOutput"></p>
<p>从上面的测试代码可以看出，我们通过mutilprocessing模块提供的Pool(用于控制一组子进程的创建使用)成功创建了4个多进程池开启5个多进程任务(其中有一个任务需要等待一个可用的进程才能执行)。</p>
<p>通过SubProcess模块，我们实现了开启多个进程执行不同Python脚本的功能，从而实现多进程执行多Python脚本任务的需求。</p>
<p>更多更细节的学习参考:</p>
<p><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017628290184064">多进程</a></p>
<p>Note：</p>
<ol>
<li><strong>multiprocessing和subprocess是提供了多进程而非多线程</strong></li>
<li>Unix&#x2F;Linux操作系统多进程是采用fork()实现真正的进程复制，而Windows不支持fork()函数，Windows上多进程是通过在子进程里创建新的Python解析器来实现的(来源:<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/28744046/multiprocessing-python-not-running-in-parallel">On Windows, there is no such system call. Python needs to perform the quite heavy task of creating a fresh Python interpreter session in the child, and re-create (step by step) the state of the parent.</a>)，所以我们执行多进程时要通过命令行而非Sumblime等软件。</li>
</ol>
<p>待续……</p>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><h3 id="encode-and-decode"><a href="#encode-and-decode" class="headerlink" title="encode and decode"></a>encode and decode</h3><p>字符编码问题，无论是shell，python都是需要考虑的，不然会出现乱码的情况。</p>
<p>encode(编码)和decode(解码)是需要一一对应的，不然同一个二进制数据，通过不同的编码和解码会得出不一样的结果。</p>
<p>首先我们来看看Python官网对于Encode和Decode的介绍:<br><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/codecs.html#encodings-and-unicode">Strings are stored internally as sequences of code points in range 0x0–0x10FFFF. (See PEP 393 for more details about the implementation.) Once a string object is used outside of CPU and memory, endianness and how these arrays are stored as bytes become an issue. As with other codecs, serialising a string into a sequence of bytes is known as encoding, and recreating the string from the sequence of bytes is known as decoding.</a></p>
<p>从上面可以看出，我们的string最终都是以字节码形式存储起来的。我们指定如何编码字符串到字节码的方法叫做编码。我们制定如何解析字节码到字符串的方法叫做解码。</p>
<p>关于字符编码的详细学习，这里参考以前转载的一片文章来加深理解:<br><a target="_blank" rel="noopener" href="http://www.imkevinyang.com/2010/06/%E5%85%B3%E4%BA%8E%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%EF%BC%8C%E4%BD%A0%E6%89%80%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84.html">关于字符编码，你所需要知道的（ASCII,Unicode,Utf-8,GB2312…）</a></p>
<p>不难看出，编码和解码方式要是不一致，最终字节码数据解析出来就会出现不正确(比如乱码)的情况。</p>
<p>这里需要提一下Python 3.X里有提供codecs的Package专门负责处理encode，decode问题。<br><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/codecs.html#standard-encodings">codecs深入了解链接</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 指定文件包含非anscii字符</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印系统默认编码</span></span><br><span class="line"><span class="built_in">print</span>(sys.getdefaultencoding())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果默认编码不是utf-8，强制设置成utf8去支持文本内非anscii字符</span></span><br><span class="line"><span class="comment"># 下面这段代码针对Python 2.X</span></span><br><span class="line"><span class="comment"># Phtyon 3.X默认就是utf-8编码不需要自己设定utf-8编码</span></span><br><span class="line"><span class="comment">#reload(sys)</span></span><br><span class="line"><span class="comment">#sys.setdefaultencoding(&#x27;utf-8&#x27;)</span></span><br><span class="line"></span><br><span class="line">s=<span class="string">&quot;English-中文&quot;</span></span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line"></span><br><span class="line">s2=codecs.encode(s,<span class="string">&quot;gb2312&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(codecs.decode(s2,<span class="string">&quot;gb2312&quot;</span>))</span><br><span class="line"><span class="comment">#解码格式与编码格式gb2312不一致，报错，无法解析</span></span><br><span class="line"><span class="comment">#print(codecs.decode(s2,&quot;utf-8&quot;))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要指定和文件一样的编码格式才能正确解析文件里的内容</span></span><br><span class="line"><span class="comment"># 读取解码格式与inputfile.txt保存的编码格式utf-8不一致报错</span></span><br><span class="line"><span class="comment">#f = open(&#x27;inputfile.txt&#x27;,&#x27;r&#x27;,encoding=&#x27;gb2312&#x27;)</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;inputfile.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">content = f.read()</span><br><span class="line"><span class="built_in">print</span>(content)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/EncodeAndDecode.png" alt="EncodeAndDecode"></p>
<p>可以看到当我们把通过gb2312编码的字符串通过对应的gb2312解析时能正确显示，但用utf-8去解析时就出现了问题。同理文件读取指定的解码格式与文件自身的编码格式不一致也会出现无法读取的情况。</p>
<p>结论：<br>编码和解码格式要一一对应才能正确解析显示。<br><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/variables-datatypes">String is sequence of Unicode characters. Strings are immutable. We cannot delete or remove characters from a string. But deleting the string entirely is possible using the keyword del.</a><br>Python里是采用Unicode编码存储字符串。Strings可以通过[]访问，但是不可被改变的。<br>因为string是immutable的，所以我们不能通过del删除string里面的个别character，但是我们可以删除对string的整个引用。</p>
<h3 id="main"><a href="#main" class="headerlink" title="main"></a><strong>main</strong></h3><p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/__main__.html"><code>&#39;__main__&#39;</code> is the name of the scope in which top-level code executes. A module’s <strong>name</strong> is set equal to <code>&#39;__main__&#39;</code> when read from standard input, a script, or from an interactive prompt. A module can discover whether or not it is running in the main scope by checking its own <code>__name__</code>, which allows a common idiom for conditionally executing code in a module when it is run as a script or with <code>python -m</code> but not when it is imported:</a></p>
<p>从上面的介绍可以看出__main__表示是否是从最上层执行(比如直接执行脚本，命令行执行脚本)代码的名字。</p>
<p>如何判定是否是从最上层执行当前python脚本了？</p>
<p>从上面的介绍可以看出，__name__变量标识了当前python脚本是通过什么方式执行的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Name: 		MainName.py</span></span><br><span class="line"><span class="comment"># Description: 		This file is used to study __name__ and __main__ using</span></span><br><span class="line"><span class="comment"># Author:  			TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:  	2021/5/22</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;MainName.py&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(__name__)</span><br></pre></td></tr></table></figure>

<p>比如上面这段代码，在通过脚本直接执行时，我们会看到打印输出:</p>
<p><img src="/img/Python/DirectExecuteNameOuput.png" alt="DirectExecuteNameOuput"></p>
<p>如果我们通过以下代码导入MainName.py会看到打印输出:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> MyPackage.MainName</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/ImportNameOutput.png" alt="ImportNameOutput"></p>
<p>在命令行执行脚本和直接执行脚本同理。</p>
<p>可以看出当我们通过非import方式导入脚本时，__name__的值为__main__这个特殊的值，我们可以通过判定这个值来判定当前python脚本的执行方式，因此我们经常会看到以下代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;DoSomething()&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这样就能做到只有通过非import方式执行当前python脚本时才执行某些东西。</p>
<h3 id="Command-Line-Args"><a href="#Command-Line-Args" class="headerlink" title="Command Line Args"></a>Command Line Args</h3><h4 id="os-argv"><a href="#os-argv" class="headerlink" title="os.argv"></a>os.argv</h4><p>很多时候作为脚本语言Python，我们写的Python脚本更多是用于自动化流程(比如打包签包等)，而调用此Python脚本的方式大多为命令行调用。这里就引出了如何通过命令行将我们所需的参数传递进我们Python脚本的问题。</p>
<p>Python自带了一个os.argv的参数用于获取命令行传入参数数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> arg <span class="keyword">in</span> sys.argv:</span><br><span class="line">	<span class="built_in">print</span>(arg)</span><br></pre></td></tr></table></figure>

<p>如果我们通过命令执行以下脚本传入参数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">***.py param1 param2 param3</span><br></pre></td></tr></table></figure>

<p>我们会看到以下输出:</p>
<p><img src="/img/Python/PythonArgsOutput.png" alt="PythonArgsOutput"></p>
<p>可以看到第0个参数表示当前python脚本执行的文件路径。</p>
<p>但上面这种方式，虽然能获得命令行传入的参数，但对于参数的格式以及参数的要求对于用的人来说都还是不透明且未做任何安全检查也未给与任何提示信息的，这样会导致Python脚本内部还需要自行做这些参数检查。这里就要引出接下来要提到的模块功能:<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/argparse.html">argparse</a></p>
<p>Note:</p>
<ol>
<li>如果以-c的参数触发python，os.argv的第一个参数是-c,详情参考:<a target="_blank" rel="noopener" href="https://docs.python.org/3/using/cmdline.html#cmdoption-c">-c</a></li>
</ol>
<h4 id="argparse-1"><a href="#argparse-1" class="headerlink" title="argparse"></a>argparse</h4><p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/argparse.html">The argparse module makes it easy to write user-friendly command-line interfaces. The program defines what arguments it requires, and argparse will figure out how to parse those out of sys.argv. The argparse module also automatically generates help and usage messages and issues errors when users give the program invalid arguments.</a></p>
<p>argparse是Python里帮助我们引导输入参数和快速解析参数的模块。</p>
<p>接下来我们直接上学习Demo，简单学习了解下如何使用argparse帮助我们快速引导输入参数和快速解析参数:<br>argparsestudy.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 指定文件包含非anscii字符</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># argparse解析参数输入，需要先定义一个ArgumentParser对象</span></span><br><span class="line"><span class="comment"># description - -h的时候显示在最前面的信息</span></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Study argparse module.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add_argument - 定义如何解析一个参数</span></span><br><span class="line"><span class="comment"># 第一个参数代表参数名</span></span><br><span class="line"><span class="comment"># type - 指定参数数据类型</span></span><br><span class="line"><span class="comment"># help - -h时解释该参数的用意</span></span><br><span class="line"><span class="comment"># dest - 表示该参数最终在parser.parse_args()返回对象里的名字</span></span><br><span class="line"><span class="comment"># default - 表示该参数的默认值</span></span><br><span class="line"><span class="comment"># required - 表示该参数是不是必须填的参数</span></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--APKName&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;APK名字&#x27;</span>, dest=<span class="string">&#x27;APKName&#x27;</span>,</span><br><span class="line">                    required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--ClientChId&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;新的ClientChId值&#x27;</span>, dest=<span class="string">&#x27;New_Clientchid&#x27;</span>,</span><br><span class="line">                    default=<span class="string">&#x27;com.default.com&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--LEBIAN_VERCODE&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                     <span class="built_in">help</span>=<span class="string">&#x27;新的LEBIAN_VERCODE值&#x27;</span>, dest=<span class="string">&#x27;New_Lebian_Vercode&#x27;</span>,</span><br><span class="line">                     default=<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--TemplateValue&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;替换AndroidManifest.xml里quicksdk_packName字段为新的*&#x27;</span>, dest=<span class="string">&#x27;NewTemplateValue&#x27;</span>,</span><br><span class="line">                    default=<span class="string">&#x27;com.defaulttemplatevalue.com&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">&#x27;--ResourcePath&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&#x27;放入新资源到指定包内目录&#x27;</span>, dest=<span class="string">&#x27;NewResourcePath&#x27;</span>,</span><br><span class="line">                    default=<span class="string">&#x27;./default.aba&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析输入的参数</span></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印参数的详细信息，通过访问parser.parse_args()的对象去访问</span></span><br><span class="line"><span class="built_in">print</span>(args)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;APKName : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(args.APKName))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;New_Clientchid : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(args.New_Clientchid))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;New_Lebian_Vercode : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(args.New_Lebian_Vercode))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NewTemplateValue : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(args.NewTemplateValue))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NewResourcePath : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(args.NewResourcePath))</span><br></pre></td></tr></table></figure>

<p>命令行输入:<br>Python .\argparsestudy.py -h<br>会看到每个参数的详细信息<br><img src="/img/Python/ArgparseHelpInfo.png" alt="ArgparseHelpInfo"></p>
<p>真正使用时因为–APKName是必传参数，所以按下面方式调用即可:<br>Python .\argparsestudy.py –APKName com.tonytang.com<br><img src="/img/Python/ArgparseUsing.png" alt="ArgparseUsing"><br>可以看到我们通过argparse模块轻松的完成参数输入引导以及参数解析的任务。</p>
<p>更多详细学习参考:<br><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/argparse.html#the-add-argument-method">argparse — Parser for command-line options, arguments and sub-commands</a></p>
<h3 id="Path"><a href="#Path" class="headerlink" title="Path"></a>Path</h3><p>关于Path模块，这里需要先了解一下跟语言无关的一个基础知识。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zlwzlwzlw/article/details/7768313/">路径中斜杠&#x2F;和反斜杠\的区别</a></p>
<p>从博客介绍中可以看出，斜杠和反斜杠主要是Windows路径和Unix路径里区分，大部分情况(无论是浏览器还是html url都是反斜杠)。</p>
<p>这里就引出了在自动化流程里涉及路径时，我们需要兼容Windows，Mac，Android或者IOS时候路径问题需要处理。而Path模块正是能够处理这一问题的现有模块功能。</p>
<h4 id="os-path"><a href="#os-path" class="headerlink" title="os.path"></a>os.path</h4><p>这里只是简单示范几个常规API用法，详情参考:<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/os.path.html">os.path</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">FilePath = sys.argv[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;FilePath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(FilePath))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前工作目录</span></span><br><span class="line">WorkingFolder = os.getcwd()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;WorkingFolder = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件所在文件夹名</span></span><br><span class="line">FileFolderName = os.path.dirname(FilePath)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;FileFolderName = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(FileFolderName))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.path.isdir(WorkingFolder):</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is directory!&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is not directory!&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/OSPathAPIOutput.png" alt="OSPathAPIOutput"></p>
<h4 id="pathlib"><a href="#pathlib" class="headerlink" title="pathlib"></a>pathlib</h4><p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pathlib.html#module-pathlib">This module offers classes representing filesystem paths with semantics appropriate for different operating systems. Path classes are divided between <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pathlib.html#pure-paths">pure paths</a>, which provide purely computational operations without I&#x2F;O, and <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pathlib.html#concrete-paths">concrete paths</a>, which inherit from pure paths but also provide I&#x2F;O operations.</a></p>
<p>上面提到了两种概念PurePath和Concrete Paths，前者只是提供路径概念(比如区分Windows还是Unix文件系统以及路径相关操作)不和文件系统挂钩。后者就是Pathlib提供的OOP文件路径系统抽象，提供了一系列的文件操作接口(Pathlib相当于进阶版的Path抽象模块)。</p>
<p><img src="/img/Python/UMLPathDesgin.png" alt="UMLPathDesgin"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">FilePath = sys.argv[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;FilePath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(FilePath))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前工作目录</span></span><br><span class="line">WorkingFolder = os.getcwd()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;WorkingFolder = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件所在文件夹名</span></span><br><span class="line">FileFolderName = os.path.dirname(FilePath)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;FileFolderName = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(FileFolderName))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.path.isdir(WorkingFolder):</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is directory!&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is not directory!&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这一步可以自动转化成对应平台的路径格式(最后需要str的时候需要转化成str)</span></span><br><span class="line">PathWorkingFolder = Path(WorkingFolder)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;PathWorkingFolder = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(PathWorkingFolder))</span><br><span class="line"></span><br><span class="line">WorkingFolderJoinPath = PathWorkingFolder.joinpath(<span class="string">&quot;joinpath&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;WorkingFolderJoinPath = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(WorkingFolderJoinPath))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> PathWorkingFolder.exists():</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; exists!&quot;</span>.<span class="built_in">format</span>(PathWorkingFolder))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/PathLibAPIOutput.png" alt="PathLibAPIOutput"></p>
<p>这里用Pathlib除了他提供了更多的文件路径操作外，还有就是它继承了PurePath跨平台文件路径处理的特性，让我们可以在处理文件路径时无需关心平台。</p>
<h3 id="Bat-and-Shell"><a href="#Bat-and-Shell" class="headerlink" title="Bat and Shell"></a>Bat and Shell</h3><p>Bat和Shell在<a href="http://tonytang1990.github.io/2017/04/29/Unity%E8%87%AA%E5%8A%A8%E5%8C%96&IOS%E8%87%AA%E5%8A%A8%E5%8C%96%E7%AD%BE%E5%8C%85/">Unity自动化&amp;IOS自动化签包</a>文章中已经了解过了，这里主要是介绍如何在python里和bat，shell交互(比如我们想获取环境变量里的数据，执行shell命令等)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">androidhome = os.getenv(<span class="string">&quot;ANDROID_HOME&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> androidhome == <span class="literal">None</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;未配置ANDROID_HOME环境变量路径，请先配置ANDROID_HOME环境变量&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;ANDROID_HOME = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(androidhome))</span><br><span class="line"></span><br><span class="line">WorkingFolder = os.getcwd()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;WorkingFolder = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(WorkingFolder))</span><br><span class="line"></span><br><span class="line">CmdCommand = <span class="string">&quot;echo Hello World&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;CmdCommand = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(CmdCommand))</span><br><span class="line"><span class="comment"># 执行CDM命令</span></span><br><span class="line">os.system(CmdCommand)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保不自动关闭</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;请按任意键继续...&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Python/SystemInfoOutput.png" alt="SystemInfoOutput"></p>
<p>注释和用法都很详细了，这里就不多介绍了。</p>
<h2 id="Python-GUI"><a href="#Python-GUI" class="headerlink" title="Python GUI"></a>Python GUI</h2><p>GUI(Graphic User Interface)可视化用户界面。<br>Python实现GUI有很多选择，这里参考一位博主的分享：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/22619896">Python 的图形界面（GUI）编程？</a></p>
<p>学习需要从需求出发，这里本人主要是想用Python写点简单的GUI来满足可视化即可，所以对GUI要求不高，本人不是以Python为主，只是用Python写点周边小工具，所以这里本人考虑的是学习了解Python自带的TKinter。</p>
<p>如果对GUI要求比较高，有比较常用Python，根据上面那位博主的建议来看，PyQT是个不错的选择。</p>
<h3 id="TKinter"><a href="#TKinter" class="headerlink" title="TKinter"></a>TKinter</h3><p>官方介绍：<br><a target="_blank" rel="noopener" href="https://wiki.python.org/moin/TkInter/">Tkinter is Python’s de-facto standard GUI (Graphical User Interface) package. It is a thin object-oriented layer on top of Tcl&#x2F;Tk.</a></p>
<p>接下来将根据<a target="_blank" rel="noopener" href="http://infohost.nmt.edu/tcc/help/pubs/tkinter/web/index.html">Tkinter 8.5 reference: a GUI for Python</a>去学习了解TKinter的概念以及使用。</p>
<p>待续……</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://www.python.org/">Python</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Guido_van_Rossum">Guido van Rossum</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.python.org/moin/TkInter/">Tkinter</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/codecs.html#encodings-and-unicode">Encode and Decode in Python</a></p>
<h2 id="Tutorial-Part"><a href="#Tutorial-Part" class="headerlink" title="Tutorial Part"></a>Tutorial Part</h2><p><a target="_blank" rel="noopener" href="https://www.programiz.com/python-programming/keywords-identifier">Python Tutorial</a><br><a target="_blank" rel="noopener" href="https://pip.pypa.io/en/stable/user_guide/#installing-packages">Python Package Index</a></p>
<p><a target="_blank" rel="noopener" href="http://infohost.nmt.edu/tcc/help/pubs/tkinter/web/index.html">Tkinter 8.5 reference: a GUI for Python</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/codecs.html#standard-encodings">codecs</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/argparse.html">argparse</a></p>
<p><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1016959663602400">Python教程</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a target="_blank" rel="noopener" href="https://wiki.python.org/moin/Python2orPython3">Python2orPython3</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/22619896">Python 的图形界面（GUI）编程？</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Programming-Language/">Programming Language</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Python/">Python</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/29/Unity自动化&IOS自动化签包/" title="Unity自动化&amp;IOS自动化签包" itemprop="url">Unity自动化&amp;IOS自动化签包</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-04-29T07:17:56.000Z" itemprop="datePublished"> 发表于 2017-04-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Unity自动化打包"><a href="#Unity自动化打包" class="headerlink" title="Unity自动化打包"></a>Unity自动化打包</h1><p>本章节主要是为了学习Unity自动化打包相关知识以及运用。<br>本文大部分属于本人学习理解的东西，如有不对欢迎指出，学习交流，共同进步。</p>
<p>本章节的流程如下：</p>
<ol>
<li>了解什么是打包以及打包过程中的一些相关概念</li>
<li>了解什么是自动化以及帮助我们快速完成一键打包的工具</li>
<li>自动化打包工具或编程语言的选取</li>
<li>Unity自动化打包过程中的相关工具</li>
<li>实战集成运用到Unity构建一键打包</li>
<li>更多学习程序发布以及相关概念</li>
</ol>
<p>在了解相关自动化工具之前，我们需要先简单了解下什么是版本控制。在我们的日常开发工作中必不可少。</p>
<h2 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h2><p><a href="http://tonytang1990.github.io/2019/04/19/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/">版本控制相关概念学习</a></p>
<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>平时做游戏开发，在完成整个游戏功能开发后，需要通过打包上真机测试。<br>把所有游戏资源代码打包成安装包的过程称为打包。</p>
<h3 id="多平台"><a href="#多平台" class="headerlink" title="多平台"></a>多平台</h3><p>在多平台的处理上，Unity已经帮我们做了很大一部分工作了。让我们大部分时间只需关心游戏核心开发(Unity部分API在不同平台有差异)，在打包这一块只需打选择对应平台即可。</p>
<p>但Unity自带的打包，终究只包含最基本的打包流程，当我们有特殊需求时，我们需要通过Unity以及相关工具完成支持我们自定义的打包流程。</p>
<h3 id="自动化"><a href="#自动化" class="headerlink" title="自动化"></a>自动化</h3><p>在了解什么是自动化之前，让我们看看打包的基本流程。<br>在打包过程中，打包往往包含4个步骤。</p>
<ol>
<li>Preprocess(打包准备步骤)<br>这一步主要是为正式打包编译做准备，比如做一些平台相关设置，资源打包处理，文件复制等</li>
<li>Build(打包编译步骤)<br>这一步是程序代码和资源正式打包成安装包的步骤，主要是通过指定打包参数执行打包。<br>Unity在打包到Android和IOS平台时有差异。Android是直接就打包出APK，而IOS要先打包成XCode工程，然后在通过编译XCode工程打包出Ipa安装包。</li>
<li>Postprocess(打包结束后期处理步骤)<br>这一步是打包完成后负责后续的自动化操作以及善后工作，比如在打包IOS时打包出XCode工程后，可以在这一步进行XCode工程的自动化处理部分(比如动态添加info.plist文件信息，动态插入代码等)</li>
<li>Deploy(安装步骤)<br>这一步主要是打包好的安装包安装到真机的步骤</li>
</ol>
<p>如果没有自动化，我们需要一步一步人工手动去完成上面的步骤。<br>而自动化就是只需人工设置打包最基本的参数信息，然后通过一步就自动化完成上述步骤的过程。</p>
<h4 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h4><p><strong>Introduction</strong><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Jenkins_(%E8%BD%AF%E4%BB%B6)">Jenkins是一个用Java编写的开源的持续集成工具。Jenkins提供了软件开发的持续集成服务。它运行在Servlet容器中（例如Apache Tomcat）。它支持软件配置管理（SCM）工具（包括AccuRev SCM、CVS、Subversion、Git、Perforce、Clearcase和RTC），可以执行基于Apache Ant和Apache Maven的项目，以及任意的Shell脚本和Windows批处理命令。Jenkins的主要开发者是川口耕介。</a></p>
<p>本人使用目的：<br>做Unity游戏打包机，持续集成自动化打包流程，做到一键打包。</p>
<p><a target="_blank" rel="noopener" href="https://jenkins.io/doc/"><strong>Deployment</strong></a></p>
<ol>
<li>Download Jeakins</li>
<li>Open up a terminal in the download directory and run java -jar jenkins.war</li>
<li>Browse to <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080</a> and follow the instructions to complete the installation.(安装插件)</li>
</ol>
<h4 id="Jenkins实战"><a href="#Jenkins实战" class="headerlink" title="Jenkins实战"></a>Jenkins实战</h4><h5 id="自由风格构建系统"><a href="#自由风格构建系统" class="headerlink" title="自由风格构建系统"></a>自由风格构建系统</h5><p>主要是采用特定的构建系统去构建自动化。(比如java通过ant||Maven，windows通过bat||python等)<br><img src="/img/Unity/OpenAutomation.PNG" alt="OpenAutomation"></p>
<p>如果不想采用Pipeline编写自动化流程，也可以通过直接编写调用Windows Bat或者Python等命令触发自动化流程。<br><img src="/img/Unity/OpenAutomationWithCommands.PNG" alt="OpenAutomationWithCommands"></p>
<p>Unity3d Plugin不支持Pipeline，所以为了使用Unity3d Plugins,这里采用自由风格构建系统来搭建Unity3D的自动化打包。</p>
<ol>
<li>Create Free Style(创建自由风格项目)<br>新建 -&gt; 构建一个自由风格的软件项目<br><img src="/img/Unity/JenkinsFreeStyleProject.PNG" alt="JenkinsFreeStyleProject"></li>
<li>设置参数构造(用于自定义参数添加)<br><img src="/img/Unity/FreeStyleWithParametersSetting.PNG" alt="FreeStyleWithParametersSetting"></li>
<li>设置代码来源<br><img src="/img/Unity/FreeStyleWithSourceSetting.PNG" alt="FreeStyleWithSourceSetting"></li>
<li>设置构建命令(bat || python || unity3d……)<br><img src="/img/Unity/FreeStyleWithCommandsSetting.PNG" alt="FreeStyleWithCommandsSetting"></li>
<li>设置构建完毕后的一些行为(比如邮件通知)<br><img src="/img/Unity/FreeStyleWithPostProcessing.PNG" alt="FreeStyleWithPostProcessing"></li>
</ol>
<p>Note:<br>想要改变默认的workspace路径的话。<br>设置-&gt;使用自定义的工作空间(只针对当前设置的自由风格项目有效)<br><img src="/img/Unity/FreeStyleWithOwnWorkspace.PNG" alt="FreeStyleWithOwnWorkspace"></p>
<h5 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h5><h6 id="What"><a href="#What" class="headerlink" title="What"></a>What</h6><p><a target="_blank" rel="noopener" href="https://jenkins.io/doc/">Jenkins Pipeline is a suite of plugins which supports implementing and integrating continuous delivery pipelines into Jenkins. Pipeline provides an extensible set of tools for modeling simple-to-complex delivery pipelines “as code”.</a>(这里的Pipeline是一套插件，用于支持持续自动化集成编写。好比脚本文件定义一系列的自动化流程，但并不等价于脚本。)</p>
<p>那么Pipeline是用什么语言编写了？<br>Jenkins是基于Java的，Pipeline的编写是基于Groovy。<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Groovy">Groovy是Java平台上设计的面向对象编程语言。这门动态语言拥有类似Python、Ruby和Smalltalk中的一些特性，可以作为Java平台的脚本语言使用。</a></p>
<h6 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h6><p>为什么需要Pipeline？</p>
<ol>
<li>Code – 可管理可编辑可视化的自动化流程脚本</li>
<li>Durable – 可持续化开发</li>
<li>Pausable – 可以自动也可以停止等待输入</li>
<li>Versatile – 支持复杂的持续交付需求</li>
<li>Extensible – “The Pipeline plugin supports custom extensions to its DSL [5: Domain-Specific<br>Language] and multiple options for integration with other plugins.”</li>
</ol>
<h6 id="How"><a href="#How" class="headerlink" title="How"></a>How</h6><p>接下来让我们看看如何创建一个Pipeline。</p>
<ol>
<li>下载Pipeline插件<br><img src="/img/Unity/DownloadPipelinePlugin.PNG" alt="DownloadPipelinePlugin"></li>
<li>New Item – 新建Pipeline(选择Pipeline类型)<br><img src="/img/Unity/CreatePipelineStep1.PNG" alt="CreatePipeline"></li>
<li>Configure Pipeline<ul>
<li>配置Pipeline的名字<br><img src="/img/Unity/CreatePipelineStep2.PNG" alt="ConfigurePipeline"></li>
<li>设置Jenkins Pipeline Code的来源<ul>
<li>网页版编写<br><img src="/img/Unity/SetPipelineSourceFromWeb.PNG" alt="CreatePipelineSetPipelineSource"></li>
<li>SVN下含Jenksfile文件<br><img src="/img/Unity/SetPipelineSourceFromSVN.PNG" alt="CreatePipelineSetPipelineSourceSVN"><br>这里不深入讨论Jenkins的各种设置，详情查看官方文档<a target="_blank" rel="noopener" href="https://jenkins.io/user-handbook.pdf">Jenkins User Handbook</a></li>
</ul>
</li>
</ul>
</li>
</ol>
<p>Note:<br>Pipeline supports two syntaxes, Declarative and Scripted Pipeline</p>
<h6 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h6><p>除了直接在网页上编写Pipeline自动化流程。我们也可以指定Jenkinsfile文件作为编写Pipeline的地方。</p>
<p>为什么需要Jenkinsfile？<br>主要还是为了放入版本管理，方便所有人可视化看到自动化流程代码。</p>
<p>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!groovy</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    <span class="comment">//agent指定jenkins从哪里以及如何执行pipeline</span></span><br><span class="line">    <span class="comment">//any表示从any available agent处执行</span></span><br><span class="line">    agent any</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//看定义在那一层，就只针对那一层起作用(pipeline一层针对pipeline。stage一层针对特定stage)</span></span><br><span class="line">    <span class="comment">//也可以修改已定义的环境变量值</span></span><br><span class="line">    environment &#123;</span><br><span class="line">        UNITY_PROJECT_PATH = <span class="string">&#x27;E:\\TonyTang\\Work\\Projects\\TGame_code&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义参数</span></span><br><span class="line">    <span class="comment">//可以通过pipeline代码编写，也可以直接在web UI界面上添加</span></span><br><span class="line">    parameters&#123;</span><br><span class="line">        <span class="built_in">string</span>(name: <span class="string">&#x27;Platform&#x27;</span>, defaultValue: <span class="string">&#x27;Android&#x27;</span>, description: <span class="string">&#x27;Which plaftform is using?&#x27;</span>)</span><br><span class="line">        booleanParam(name: <span class="string">&#x27;DEBUG_BUILD&#x27;</span>, defaultValue: <span class="literal">true</span>, description: <span class="string">&#x27;Is debug version?&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;postprocess&#x27;</span>)&#123;</span><br><span class="line">            <span class="comment">//when表示执行条件判断</span></span><br><span class="line">            <span class="comment">//决定stage是否应该执行</span></span><br><span class="line">            <span class="keyword">when</span>&#123;</span><br><span class="line">                expression</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">params</span>.DEBUG_BUILD</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps&#123;</span><br><span class="line">                <span class="comment">//params是访问pipeline里定义的所有parameters入口</span></span><br><span class="line">                echo <span class="string">&quot;Current platform is $&#123;params.Platform&#125;&quot;</span></span><br><span class="line">                echo <span class="string">&#x27;postprocess&#x27;</span></span><br><span class="line">                echo UNITY_PROJECT_PATH</span><br><span class="line">                <span class="comment">//env是jenkins定义的全局的环境变量</span></span><br><span class="line">                <span class="comment">//http://localhost:8080/job/TonyTangPipeline/pipeline-syntax/globals</span></span><br><span class="line">                echo env.WORKSPACE</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">//Windows调用bat</span></span><br><span class="line">                <span class="comment">//Mac Linux采用sh</span></span><br><span class="line">                bat <span class="string">&#x27;TonyTangPipeline&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;deploy&#x27;</span>)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                echo <span class="string">&#x27;deploy&#x27;</span></span><br><span class="line">                <span class="comment">//支持调用python</span></span><br><span class="line">                bat <span class="string">&#x27;python FirstPython.py&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//post表示Pipeline执行完之后执行，做一些clean up操作</span></span><br><span class="line">    post &#123;</span><br><span class="line">        <span class="comment">//根据pipeline的结果做特定操作</span></span><br><span class="line">        always&#123;</span><br><span class="line">            echo <span class="string">&#x27;Always!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo <span class="string">&#x27;Success!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        failure&#123;</span><br><span class="line">            echo <span class="string">&#x27;Failed!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Script Pipeline(Optional)</span></span><br><span class="line"><span class="comment">//在pipeline执行完成之后执行</span></span><br><span class="line"><span class="comment">//支持大部分Groovy</span></span><br><span class="line"><span class="comment">//Script Pipeline的参数定义需要在properties里</span></span><br><span class="line">properties([parameters([<span class="built_in">string</span>(defaultValue: <span class="string">&#x27;Android&#x27;</span>, description: <span class="string">&#x27;Which platform is using?&#x27;</span>, name: <span class="string">&#x27;Platform&#x27;</span>)])])</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    <span class="comment">//定义字符串</span></span><br><span class="line">    def Date = <span class="string">&#x27;2017//4//26&#x27;</span></span><br><span class="line">    stage(<span class="string">&#x27;postprocess&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">//要使用$&#123;&#125;访问string，需要用&quot;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;Date = $&#123;Date&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;Current platform is $&#123;params.Platform&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&#x27;postprocess....&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;build&#x27;</span>) &#123;</span><br><span class="line">        echo <span class="string">&#x27;build....&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;deploy&#x27;</span>) &#123;</span><br><span class="line">        echo <span class="string">&#x27;deploy....&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li>指定使用版本管理后，Jenkinsfile必须放到版本管理里才能找到。</li>
<li>Jenkinsfile必需放到前面设置的本机相对路径下才能找到。</li>
</ol>
<h6 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h6><ol>
<li>构建参数一旦通过代码指定添加后，代码删除了依然存在</li>
<li>No valid crumb was included in the request</li>
</ol>
<p>Solutions:</p>
<ol>
<li>通过Pipeline -&gt; Setting的UI界面手动删除参数</li>
<li>在系统管理 –&gt; Configure Global Security<br>取消“防止跨站点请求伪造（Prevent Cross Site Request Forgery exploits）”的勾选。</li>
</ol>
<h5 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h5><h6 id="Pipeline-Tools"><a href="#Pipeline-Tools" class="headerlink" title="Pipeline Tools"></a>Pipeline Tools</h6><p><a target="_blank" rel="noopener" href="http://localhost:8080/pipeline-syntax/">Snippet Generator</a><br><img src="/img/Unity/PipelineSnippetGenerator.PNG" alt="PipelineSnippetGenerator"><br>这是一个很有用帮助快速编写Pipeline的工具,他可以帮助我们把我们熟悉的自动化脚本转换成Pipeline格式的语句，也可以快速生成一些特定功能的脚本(比如邮件功能等)。(Jenkins提供)</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/pipeline-syntax/globals">Pipiline全局环境变量</a></p>
<h6 id="Email-Plugin"><a href="#Email-Plugin" class="headerlink" title="Email Plugin"></a>Email Plugin</h6><p>利用现有的SMTP(腾讯，网易等)服务进行搭建邮件提醒，详情参见如下：<br><a target="_blank" rel="noopener" href="http://blog.csdn.net/houyefeng/article/details/50914582">Jenkins——应用篇——插件使用——Mailer Plugin</a><br>Jenkins自带Email配置如下:<br>Manage Jenkins -&gt; Configure System -&gt; E-mail Notification<br><img src="/img/Unity/EmailNotificationSetting.png" alt="EmailNotificationSetting"><br>Jenkins自带的Mailer提供的功能很有限，为了提供更多更广的功能，这里我们需要用到<a href="wiki.jenkins-ci.org/display/JENKINS/Email-ext+plugin">Jenkins Email Extension Plugin</a><br><a target="_blank" rel="noopener" href="http://m.v4.cc/News-966281.html">Jenkins进阶系列之——01使用email-ext替换Jenkins的默认邮件通知</a><br>Email Extension Plugin配置详情参见如下：<br>Manage Jenkins -&gt; Configure System -&gt; Extended E-mail Notification<br><img src="/img/Unity/ExtendedEmailNotificationPart1.png" alt="ExtendedEmailNotificationPart1"><br>针对workspace自定义邮件内容配置如下：<br><img src="/img/Unity/WorkspaceExtendedEmailSetting.png" alt="WorkspaceExtendedEmailSetting"><br>最终收到Email提醒:<br><img src="/img/Unity/EmailResult.PNG" alt="EmailResult"></p>
<h6 id="Unity3D-Plugin"><a href="#Unity3D-Plugin" class="headerlink" title="Unity3D Plugin"></a>Unity3D Plugin</h6><p>管理插件-&gt;<a target="_blank" rel="noopener" href="https://plugins.jenkins.io/unity3d-plugin">Unity3d Plugin</a><br>Unity本身是支持从命令行启动U3D，执行Editor特定方法的。<br>但Unity3D Plugin是一个针对Jenkins集成Unity命令行的插件，可以帮助我们直接在Jenkins上编写U3D命令，对于Jenkins更加友好。<br>好处如下:</p>
<ol>
<li>Log file redirection(Log重定位到Jenkins界面)</li>
<li>Distributed builds(分布式编译)</li>
</ol>
<p><strong>Unity3D Plugin实战配置</strong></p>
<ol>
<li>Configure Unity Installation Path<br>System Setting -&gt; Global Tool Configuration<br><img src="/img/Unity/JenkinsUnityPathConfiguration.PNG" alt="JenkinsUnityPathConfiguration"></li>
<li>编写Unity下可通过命令行调用的代码</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UnityBuild</span> &#123;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Custom/UnityBuild/OneKeyBuild&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OneKeyBuild</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;OneKeyBuild() Called!&quot;</span>);   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置Unity命令行运行启动以及参数<br><img src="/img/Unity/JenkinsUnityMethodCall.PNG" alt="JenkinsUnityMethodCall"><br><img src="/img/Unity/JenkinsUnityMethodCallOutput.PNG" alt="JenkinsUnityMethodCallOutput"><br>从上面可以看出我们成功的配置了Jenkins以及对于Unity打包方法的调用(在这一步我们可以做很多我们自己对于Unity打包的流程设置，资源打包或者其他的预处理等)</li>
<li>编写完整的打包设置以及相关预处理代码<br>待续…….<br>接下来是为了在IOS进行Jenkins自动化打包而设置的步骤</li>
<li>在IOS搭配SmartSVN拉VisualSVN上的文件(Windows上用TortoiseSVN作为SVN客户端即可)</li>
<li>在IOS上配置Jenkins(和Windows上类似，需要下载Java支持Jenkins运行)<br>这里讲几个配置搭建Mac OSX的Jenkins时遇到的坑：<ol>
<li>配置Unity插件Unity安装路径问题<br>Windows上是到Editor上一层即可。IOS是到Unity.app这一层(Unity.app(e.g. &#x2F;Applications&#x2F;Unity&#x2F;Unity.app&#x2F;)在命令行里可以往里访问)</li>
<li>指定IOS Subversion URL(e.g. <a target="_blank" rel="noopener" href="https://192.168.1.3/svn/***)%E6%97%B6%E6%98%BE%E7%A4%BA%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E6%88%96%E8%80%85%E4%B8%8D%E6%AD%A3%E7%A1%AE%E7%9A%84credential">https://192.168.1.3/svn/***)时显示无法访问或者不正确的credential</a>(这里是因为默认的Mac SVN版本过低需要更新Mac OSX自带的SVN)</li>
<li>更新Mac OSX自带SVN时在添加新装的SVN到环境变量里后依然显示是老版的SVN<br>在~&#x2F;目录下touch .bash_profile(创建.bash_profile)<br>然后添加环境变量路径export PATH&#x3D;”&#x2F;opt&#x2F;subversion&#x2F;bin;$PATH”<br>使其环境变量路径设置生效source .bash_profile<br>查看当前SVN版本svn –version<br>如果上一步依然显示是旧版SVN且当前系统是10.11<br>那么我们就需要删除Mac OSX上原本的SVN以实现更新SVN的目的<br>查看旧版SVN路径which svn<br>删除旧版SVN(sudo -s rm -rf &#x2F;svnpath&#x2F;svn*)(此时如果出现No Permission to remove，那么恭喜，你是用的10.11系统。10.11推出了SIP(System Integrity Protection)机制去防止root用户对于部分文件的操作权限限制用于防止病毒破坏或修改重要文件)<br>为了能够删除旧版SVN，这里我们需要进到Recover Mode去临时关闭SIP(重启电脑一直按住cmd+R，然后在terminal里执行csrutil disable，关闭成功后就可以重启电脑去删除旧版svn了)<br>然后将新版SVN链接到旧版SVN执行路径(sudo -s ln -s &#x2F;opt&#x2F;subversion&#x2F;bin&#x2F;svn* &#x2F;svnpath)<br>最后到Recover Mode里恢复SIP(csrutil enable)</li>
<li>打包IOS时报错：_RegisterApplication(), FAILED TO establish the default connection to the WindowServer, _CGSDefaultConnection() is NULL.<br>这是因为Jenkins默认安装时是以Jenkins作为用户和组。开机自启动时也是以Jenkins用户和组来运行的。而Unity我是默认安装在我自己的用户apple和admin组下。所以在Jenkins需要启动Unity时应该是没有权限调用 Unity Editor 的命令行。所以我们要做的就是确保Unity和Jenkins运行在同一个User和Group下。<br>以下采用把Jenkins改到apple和wheel下运行以支持Unity的命令行运行。<br>详情参见<a target="_blank" rel="noopener" href="http://7dot9.com/2016/11/18/macos-jenkins-ci-unity-setup-config-guide/">macOS 安装配置 Jenkins 持续集成 Unity 项目指南</a></li>
<li>指定Custom Workspace(自定义到桌面特定目录后每次都报Failed to mkdir，这个跟第四个问题是同一个问题，默认Jenkins用户权限问题)</li>
</ol>
</li>
</ol>
<p>Note:<br>很多文件是Unity自动生成的(比如Library目录)，我们无需加入版本管理(SVN只要不加入版本管理即可)</p>
<p>Note:<br>Unity3d Plugin不支持在Pipeline里添加。<br>同时Unity3d Plugin只在3.4.2 to 5.0.1的版本下测试过。(经本人测试在Unity5.4.0f3的版本也能正常使用)</p>
<h4 id="Jenkins从零搭建"><a href="#Jenkins从零搭建" class="headerlink" title="Jenkins从零搭建"></a>Jenkins从零搭建</h4><p>这里的从零搭建，在借助Jenkins插件的基础上，尽量采用Pipeline编写为主，插件UI为辅的方式来实现一整套完整的Jenkins自动化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">#!groovy</span><br><span class="line">pipeline &#123;</span><br><span class="line">    //agent指定jenkins从哪里以及如何执行pipeline</span><br><span class="line">    //any表示从any available agent处执行</span><br><span class="line">    agent any</span><br><span class="line">    </span><br><span class="line">    //看定义在那一层，就只针对那一层起作用(pipeline一层针对pipeline。stage一层针对特定stage)</span><br><span class="line">    //也可以修改已定义的环境变量值</span><br><span class="line">    environment &#123;</span><br><span class="line">        UNITY_PROJECT_PATH = &#x27;E:\\TonyTang\\Work\\Projects\\MyGitHubProjects\\GitStudy2&#x27;</span><br><span class="line">        GIT_URL = &#x27;git@github.com:TonyTang1990/GitStudy.git&#x27;</span><br><span class="line">        GIT_AUTH = &#x27;7d947f92-1e9c-44ba-9a80-9744f92f2ff6&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //自定义参数</span><br><span class="line">    //可以通过pipeline代码编写，也可以直接在web UI界面上添加</span><br><span class="line">    parameters&#123;</span><br><span class="line">        string(name: &#x27;Platform&#x27;, defaultValue: &#x27;Android&#x27;, description: &#x27;Which plaftform is using?&#x27;)</span><br><span class="line">        booleanParam(name: &#x27;DEBUG_BUILD&#x27;, defaultValue: true, description: &#x27;Is debug version?&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;postprocess&#x27;)&#123;</span><br><span class="line">            //when表示执行条件判断</span><br><span class="line">            //决定stage是否应该执行</span><br><span class="line">            when&#123;</span><br><span class="line">                expression</span><br><span class="line">                &#123;</span><br><span class="line">                    return params.DEBUG_BUILD</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps&#123;</span><br><span class="line">                //params是访问pipeline里定义的所有parameters入口</span><br><span class="line">                echo &quot;Current platform is $&#123;params.Platform&#125;&quot;</span><br><span class="line">                echo &#x27;postprocess&#x27;</span><br><span class="line">                echo &quot;$&#123;env.UNITY_PROJECT_PATH&#125;&quot;</span><br><span class="line">                echo &quot;$&#123;env.GIT_URL&#125;&quot;</span><br><span class="line">                echo &quot;$&#123;env.GIT_AUTH&#125;&quot;</span><br><span class="line">                //env是jenkins定义的全局的环境变量</span><br><span class="line">                //http://localhost:8080/job/TonyTangPipeline/pipeline-syntax/globals</span><br><span class="line">                echo env.WORKSPACE</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Git&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Git operation&#x27;</span><br><span class="line">                checkout([$class: &#x27;GitSCM&#x27;, </span><br><span class="line">                        userRemoteConfigs: [[url: &quot;$&#123;env.GIT_URL&#125;&quot;, credentialsId: &quot;$&#123;env.GIT_AUTH&#125;&quot;]],</span><br><span class="line">                        extensions: [[$class: &#x27;CleanBeforeCheckout&#x27;, $class: &#x27;GitLFSPull&#x27;]]</span><br><span class="line">                        ])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                //Windows调用bat</span><br><span class="line">                //Mac Linux采用sh</span><br><span class="line">                bat &#x27;BatAutomation&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;deploy&#x27;)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                echo &#x27;deploy&#x27;</span><br><span class="line">                //支持调用python</span><br><span class="line">                bat &#x27;python PythonAutomation.py&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //post表示Pipeline执行完之后执行，做一些clean up操作</span><br><span class="line">    post &#123;</span><br><span class="line">        //根据pipeline的结果做特定操作</span><br><span class="line">        always&#123;</span><br><span class="line">            echo &#x27;Always!&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo &#x27;Success!&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">        failure&#123;</span><br><span class="line">            echo &#x27;Failed!&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Script Pipeline(Optional)</span><br><span class="line">//在pipeline执行完成之后执行</span><br><span class="line">//支持大部分Groovy</span><br><span class="line">//Script Pipeline的参数定义需要在properties里</span><br><span class="line">properties([parameters([string(defaultValue: &#x27;Android&#x27;, description: &#x27;Which platform is using?&#x27;, name: &#x27;Platform&#x27;)])])</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    //定义字符串</span><br><span class="line">    def Date = &#x27;2017//4//26&#x27;</span><br><span class="line">    stage(&#x27;postprocess&#x27;) &#123;</span><br><span class="line">        //要使用$&#123;&#125;访问string，需要用&quot;&quot;</span><br><span class="line">        echo &quot;Date = $&#123;Date&#125;&quot;</span><br><span class="line">        echo &quot;Current platform is $&#123;params.Platform&#125;&quot;</span><br><span class="line">        echo &#x27;postprocess....&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&#x27;build&#x27;) &#123;</span><br><span class="line">        echo &#x27;build....&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&#x27;deploy&#x27;) &#123;</span><br><span class="line">        echo &#x27;deploy....&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>













<h4 id="脚本语言"><a href="#脚本语言" class="headerlink" title="脚本语言"></a>脚本语言</h4><p>为了快速编写一些自动化任务，我们往往需要用到脚本语言。</p>
<h5 id="bat"><a href="#bat" class="headerlink" title="bat"></a>bat</h5><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%89%B9%E6%AC%A1%E6%AA%94">批处理文件（英语：Batch file），又称批次档，在DOS、OS&#x2F;2、微软视窗系统中，是一种用来当成脚本语言运作程序的文件。它本身是文本文件，其中包含了一系列让具备命令行界面的解释器读取并运行的指令。它相当于是类Unix系统下的Shell script。</a></p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">:: 关闭命令输出打印</span><br><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">:: UTF8</span><br><span class="line"><span class="built_in">chcp</span> <span class="number">65001</span></span><br><span class="line">:: 清除命令行界面内容</span><br><span class="line"><span class="built_in">CLS</span></span><br><span class="line">:: 输出打印信息</span><br><span class="line"><span class="built_in">echo</span> Tony Tang bat study</span><br><span class="line">:: 设置打印传入参数</span><br><span class="line"><span class="built_in">set</span> par1=%<span class="number">1</span></span><br><span class="line"><span class="built_in">set</span> par2=%<span class="number">2</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%par1%</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%par2%</span></span><br><span class="line">:: 输出打印当前目录路径</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%cd%</span></span><br><span class="line">:: 切换到上一层路径</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">:: 输出打印当前目录路径</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%cd%</span></span><br><span class="line">:: 切换到BatStudy目录</span><br><span class="line"><span class="built_in">cd</span> BatStudy</span><br><span class="line">:: 输出打印当前目录路径</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%cd%</span></span><br><span class="line">:: 打印帮助信息</span><br><span class="line">::<span class="built_in">HELP</span></span><br><span class="line">:: 自定义变量(定义变量时=号两边不能有空格)</span><br><span class="line"><span class="built_in">set</span> batvariable=tonytang</span><br><span class="line">:: 打印自定义变量</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%batvariable%</span></span><br><span class="line">:: 自定义数字变量</span><br><span class="line"><span class="built_in">set</span> number=<span class="number">3</span></span><br><span class="line">:: 打印自定义数字变量</span><br><span class="line"><span class="built_in">echo</span> number = <span class="variable">%number%</span></span><br><span class="line">:: 条件语句</span><br><span class="line"><span class="keyword">if</span> <span class="variable">%number%</span>==<span class="number">2</span> (<span class="built_in">echo</span> <span class="variable">%number%</span>==<span class="number">2</span>) <span class="keyword">else</span> (<span class="built_in">echo</span> <span class="variable">%number%</span>!=<span class="number">2</span>)</span><br><span class="line">:: 检查文件是否存在</span><br><span class="line"><span class="built_in">set</span> filename=batcontent.txt</span><br><span class="line"><span class="built_in">echo</span> filename=<span class="variable">%filename%</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">EXIST</span> ./<span class="variable">%filename%</span> (<span class="built_in">echo</span> <span class="variable">%filename%</span> exits) <span class="keyword">else</span> (<span class="built_in">echo</span> <span class="variable">%filename%</span> <span class="keyword">not</span> <span class="keyword">exist</span>)</span><br><span class="line">:: 普通循环语句</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%i</span> <span class="keyword">in</span> (<span class="number">1</span> <span class="number">2</span> <span class="number">3</span>) <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">%%i</span></span><br><span class="line">:: 当前目录文件循环遍历语句</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%f</span> <span class="keyword">in</span> (*) <span class="keyword">do</span> @<span class="built_in">echo</span> <span class="variable">%%f</span></span><br><span class="line">:: 启用变量执行时解析</span><br><span class="line"><span class="built_in">SetLocal</span> EnableDelayedExpansion</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%i</span> <span class="keyword">in</span> (<span class="number">1</span> <span class="number">2</span> <span class="number">3</span>) <span class="keyword">do</span> (</span><br><span class="line">	<span class="built_in">set</span> numberVariable=<span class="variable">%%i</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">!numberVariable!</span></span><br><span class="line">	<span class="built_in">set</span> numberVariable=<span class="variable">!numberVariable!</span>+<span class="variable">!numberVariable!</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">!numberVariable!</span></span><br><span class="line">)</span><br><span class="line">:: 暂停等待输入</span><br><span class="line"><span class="built_in">pause</span></span><br><span class="line">:: 退出命令界面 <span class="number">0</span>代表正常退出</span><br><span class="line"><span class="keyword">EXIT</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Bash/BatStudyOutput.png" alt="BatStudyOutput"></p>
<p>这里只列举一些常用基础的，详细Windows Batch学习参考:<br><a target="_blank" rel="noopener" href="http://www.trytoprogram.com/batch-file/">Batch file – Programming tutorial</a><br><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/batch_script/index.htm">Batch Script Tutorial</a></p>
<h5 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h5><p>Windows上的bat，power shell<br>Linux上的shell<br>好处：<br>简单快速的编写一些系统相关的任务(比如文件复制等)<br>缺点：<br>有平台差异</p>
<p>在正式学习Shell之前，让我们依然从What，How，Why，When这四个问题着手：<br>What?<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix_shell">Unix shell，一种壳层与命令行界面，是UNIX操作系统下传统的用户和计算机的交互界面。第一个用户直接输入命令来执行各种各样的任务。</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix_shell">第一个Unix shell是由肯·汤普逊，仿效Multic上的shell所实现出来，称为sh。</a></p>
<p>后续出了其他的Shell:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Bash">Bourne-Again shell - bash</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Debian_Almquist_shell">Debian Almquist shell - dash</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Korn_shell">Korn shell - ksh</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Z_shell">Z shell - zsh</a></li>
</ol>
<p>上面的几个Shell都可以看作是后续发展功能越来越强大的Shell解析器，至于具体分别包含些什么功能就不在本文讨论的范围内了。这里我们主要以bash和shell作为解析器来学习编写shell脚本。</p>
<p>How?<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Shell%E8%84%9A%E6%9C%AC">Shell脚本（英语：Shell script），又称Shell命令稿、程序化脚本，是一种计算机程序与文本文件，内容由一连串的shell命令组成，经由Unix Shell直译其内容后运作。被当成是一种脚本语言来设计，其运作方式与解释型语言相当，由Unix shell扮演命令行解释器的角色，在读取shell脚本之后，依序运行其中的shell命令，之后输出结果。利用shell脚本可以进行系统管理，文件操作等。</a></p>
<p>可以看出Shell脚本是被当做脚本语言来解释执行，通过调用系统内核的一些工具来实现特定功能任务的。</p>
<p>Why?<br>Shell并不适合编写复杂的程序任务，因为他只提供了一些比较基础的工具，并且不具备面向对象编程等高级语言的特性。<br>既然如此那我们为何还要坚持使用Shell了？为何不直接选择Python，Ruby，Perl这些相对高级一点的解释性语言了？<br>理论上是可以的，但Shell属于原生就具备提供的工具，可以很快捷的编写出一些看似简单但却方便的工具脚本。即使Python可以实现，但针对特定的功能可能没有Shell来的那么快捷方便，根据需求选择合适的脚本语言也是很重要的。后续我会结合Python夸平台的特性，使用Python结合Shell编写一些自动化相关的工具。</p>
<p>Note:<br>Shell跟操作系统紧密相关，原本并非跨系统平台的，但通过移植很多shell具备了跨系统平台的能力(Windows上通过Cygwin与MinGW可以模拟执行Unix Shell)。</p>
<p>When?<br>那么什么时候适合用Shell了？从前面三个问题不难看出，Shell只适合用于一些不复杂的功能任务里，无论是语言特性还是跨平台都没有Python那些高级语言支持的好。如果需要实现复杂的且跨平台，需要高级语言特性(面向对象等)时，不应该考虑Shell而是Python，Perl，Ruby这些。 </p>
<p>Note:<br>这里所说的shell和Window的batch并不是同一个东西。</p>
<h6 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h6><ul>
<li>指定解析器</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Proper header for a Bash script</span><br></pre></td></tr></table></figure>

<p>**#!**是two-byte的magic number<br>表示这个文本是executable shell script，后面紧跟的&#x2F;bin&#x2F;bash表示shell解析器是用的bash</p>
<ul>
<li>输出打印<br>学程序，最初开始的地方肯定是Hello World。<br>在bash里打印输出是通过<strong>echo</strong>指令。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Proper header for a Bash script</span><br><span class="line">echo &quot;Hello World&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Bash/BashEcho.png" alt="Bash echo"></p>
<ul>
<li>特殊符号</li>
</ul>
<ol>
<li>井号(#) – 注释符号</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Proper header for a Bash script(这一行#号开头表示注释)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>; – 命令分隔符(允许同一行多个指令)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#! /bin.bash</span><br><span class="line">echo &quot;Hello&quot;; echo &quot;World&quot;</span><br></pre></td></tr></table></figure>

<pre><code>![CommandSeparator](/img/Bash/CommandSeparator.png)
</code></pre>
<ol start="3">
<li>;; – 跳出case语句</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">variable=&quot;TonyTang&quot;</span><br><span class="line">case &quot;$variable&quot; in</span><br><span class="line">    TonyTang) echo &quot;TonyTang1&quot;;;</span><br><span class="line">    TonyTang) echo &quot;TonyTang2&quot;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<pre><code>![TerminateCommand](/img/Bash/TerminateCommand.png)
</code></pre>
<ol start="4">
<li>.<ul>
<li>表示文件是隐藏的</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">touch .hidden-file</span><br><span class="line">ls -l</span><br><span class="line">ls -al</span><br></pre></td></tr></table></figure>

<pre><code>![HidenProfileCommand](/img/Bash/HidenProfileCommand.png)
- 表示当前目录
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwd</span><br><span class="line">cd .</span><br><span class="line">pwd</span><br></pre></td></tr></table></figure>

<pre><code>![CurrentDirectoryCommand](/img/Bash/CurrentDirectoryCommand.png)
- 正则里面表示匹配单个字母
</code></pre>
<ol start="5">
<li>“” - 字符串(保留大部分特殊符号)</li>
<li>‘’ - 字符串(保留所有特殊符号)</li>
<li>,</li>
<li>\ - 反斜杠，忽略特殊符号</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">echo &quot;\&quot;Hello World&quot;\&quot;</span><br></pre></td></tr></table></figure>

<pre><code>![Backslash](/img/Bash/Backslash.png)
</code></pre>
<ol start="9">
<li>&#x2F; - 文件路径分隔符</li>
<li>: - 相当于内置true</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">while :</span><br><span class="line">do</span><br><span class="line">    echo &quot;Number 1&quot;</span><br><span class="line">    echo &quot;Number 2&quot;</span><br><span class="line">    echo &quot;Number 3&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<pre><code>![ColonOperator](/img/Bash/ColonOperator.png)
</code></pre>
<ol start="11">
<li>! - 取反</li>
<li>星号(*) - 通配符或者乘法</li>
<li>? - 三目运算符或者表示测试条件</li>
<li>$<ul>
<li>$ 变量取值符号</li>
<li>$? 退出状态码</li>
<li>$$ 进程号</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">var1=100</span><br><span class="line">echo &quot;var1 = $var1&quot;</span><br><span class="line">echo $?</span><br><span class="line">echo $$</span><br></pre></td></tr></table></figure>

<pre><code>![VariableSubstitution](/img/Bash/VariableSubstitution.png)
</code></pre>
<ol start="15">
<li><blockquote>
<p>&amp;&gt; &gt;&amp; &gt;&gt; &lt; &lt;&gt; </p>
</blockquote>
<ul>
<li><blockquote>
<p>&amp;&gt; 重定向输出到指定文件</p>
</blockquote>
</li>
<li><p>&lt;&gt; 文件读取</p>
</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">ls -l</span><br><span class="line">echo &quot;Hello World&quot; &gt;HelloWorldFile.txt</span><br><span class="line">ls -l</span><br><span class="line">cat HelloWorldFile.txt</span><br></pre></td></tr></table></figure>

<pre><code>![RedirectionCommand](/img/Bash/RedirectionCommand.png)
</code></pre>
<ol start="16">
<li>~ ~+ - home目录和当前目录</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo ~</span><br><span class="line">echo $HOME</span><br><span class="line">echo ~+</span><br><span class="line">echo $PWD</span><br></pre></td></tr></table></figure>

<pre><code>![FolderCommands](/img/Bash/FolderCommands.png)
</code></pre>
<ol start="17">
<li>&#96; - 命令执行符号(可以用于快速执行命令并将结果复制)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Date=`date +%Y%m%d%H%M%S`</span><br><span class="line">echo $Date</span><br></pre></td></tr></table></figure>

<pre><code>![CommandsSubstitution](/img/Bash/CommandsSubstitution.png)
</code></pre>
<ul>
<li>Shell小知识</li>
</ul>
<ol>
<li><p>$0 - $9<br>$0表示Shell文件名<br>$1-$9表示Shell的第一个到第九个参数</p>
</li>
<li><p>ls -l<br>查看文件详细信息(比如读写权限等)<br><img src="/img/Bash/LSCommand.png" alt="LSCommand"><br>具体如何理解最前面的权限信息，参考<a target="_blank" rel="noopener" href="http://cn.linux.vbird.org/linux_basic/0210filepermission.php">第六章、Linux 的文件权限与目录配置</a></p>
</li>
<li><p>chmod<br>修改文件权限</p>
</li>
<li><p>cd<br>切换目录</p>
</li>
<li><p>pwd or ~+<br>当前所在目录</p>
</li>
<li><p>echo<br>输出信息</p>
</li>
<li><p>exit<br>退出shell</p>
</li>
<li><p>$?<br>前一段shell的返回输出值</p>
</li>
<li><p>$ or ${}<br>去变量值</p>
</li>
<li><p><br>多行shell支持</p>
</li>
<li><p>$SHELL<br>从当前Shell执行结束的地方打开一个新的terminal窗口(能保持之前所有的输出信息都在)</p>
</li>
</ol>
<p>待续……</p>
<h5 id="Python-严格意义上不算脚本语言"><a href="#Python-严格意义上不算脚本语言" class="headerlink" title="Python(严格意义上不算脚本语言)"></a>Python(严格意义上不算脚本语言)</h5><p>好处：</p>
<ol>
<li>跨平台</li>
<li>解释性语言，开发方便快速</li>
<li>库丰富<br>待续……</li>
</ol>
<h4 id="IOS自动化打包"><a href="#IOS自动化打包" class="headerlink" title="IOS自动化打包"></a>IOS自动化打包</h4><h5 id="IOS打包准备"><a href="#IOS打包准备" class="headerlink" title="IOS打包准备"></a>IOS打包准备</h5><ol>
<li><p>Apple Account(发布到IOS设备上需要)<br>任何账号都可以发布到自己的设备测试，但是如果要使用GC or In-App Purchases或者发布到App Store的话需要注册Apple Developer Program。</p>
</li>
<li><p>Xcode(up-to-date version)<br>因为Xcode是Mac上的软件，所以这里需要Mac电脑或者是黑苹果。(开发所需的SDK，IDE套装都在这)</p>
</li>
<li><p>Adding your Apple ID to Xcode<br>Open Xcode -&gt; Xcode -&gt; Preferences -&gt; Account -&gt; </p>
</li>
<li><p>在开发之前，Mac需要获得IOS Certificartes(用于对Mac开发授权，程序签名等)<br>登陆Apple Developer Program -&gt; Certificates ,identifiers &amp; Profiles -&gt; Certificate Signing Request<br>Create CSR(Certificate Signing Request):</p>
<ol>
<li>Folder -&gt; Utilities Folder -&gt; Keychain Access</li>
<li>Keychain Access -&gt; Certificate Assistant -&gt; Request a Certificate from a Certificate Authority -&gt; 填完内容存储到本地<br>CSR里包含了public key和private key。<br>当CSR创建以后，需要使用CSR去请求一个Certificate:</li>
<li>上传CSR</li>
<li>下载Certificate</li>
<li>运行安装Certificate<br>安装Certificate后public和private key pair就生成了(在Keychain Access下可以查看)<a target="_blank" rel="noopener" href="http://www.cnblogs.com/zhaoyang/p/3582436.html">而我们的应用程序签名是使用私钥来签名用公钥来进行验证,  而苹果生成的Certificate 只包含了公钥,当你用自己的私钥签名后,苹果会用公钥来进行验证,确保是你自己对程序签名而不是别人冒充的</a><br>通过导出共享公钥和私钥，可以实现共同开发(Mac开发授权，程序签名等)。</li>
</ol>
</li>
<li><p>设置App ID(相当于Android包名，用于识别App)<br>App ID包含以下组成部分：</p>
<ol>
<li>Prefix – 作为Team ID</li>
<li>Suffix – 作为Build ID的搜索字符串(可指定通配符)</li>
<li>AppServices – 指定包含的Service(比如Game Center， IAP， iCloud等服务)，只有指定了这些，使用包含了此APP ID的Provision Profile才能使用特定服务</li>
</ol>
</li>
<li><p>添加设备列表(只有被添加了的设备列表才能用于安装和测试程序)<br>需要通过Itunes查看UDID，然后添加到设备列表。</p>
</li>
<li><p>用上述我们创建的Certificate, Apple ID, Devices List等生成我们的Provision Profile(Unity Cloud Build的时候需要指定)<br>不同的Provision Profile有不同的用处，比如iPhone Developer证书用于测试设备上运行，iPhone Distribution证书用于提交应用到App Store。<br>让我们来理解一些相关概念，下文引用至<a target="_blank" rel="noopener" href="http://www.cnblogs.com/zhaoyang/p/3582436.html">IOS开发 证书总结</a><br> Identifier:<br> 顾名思义App ID（application id, not apple id）, 对于你的一个或者一组app他们的唯一标识, 这个App ID跟你Xcode中的Targets —–&gt; General—–&gt; Identity中的Bundle Identifier是匹配的,(其余的那些推送服务啊什么的都是配置在APP ID下面的) 如下图:</p>
<p> Provisioning Profile<br> 一个Provisioning Profile包含了上述所有内容 Certificate &amp;&amp; App ID &amp;&amp; Device, 这个Provisioning Profile文件会在打包时嵌入到.ipa的包里,如下图: </p>
<p> 所以一台设备上运行应用程序的过程如下(以Developer Provisioning Profile为例):<br> 1 检查app 的 bunld ID 是否 matches Provisioning Profile 的 App ID<br> 2 检查 app 的 entitements 是否 matches Provisioning Profile 的 entitements<br> 3 用Certificate来验证签名签名<br> 4 检查此设备的UDID是否存在于 Provisioning Profiles中 （仅在 非发布证书中）</p>
<p> 如何创建?<br> 在 Provisioning Profiles 中点加号,然后依次选择App ID, Certificate, Devices(development),再指定名称,最后下载, 双击则安装到Xcode中</p>
<p> Xcode中的配置<br> Project &amp;&amp; Target 的 build settings 中搜索Code sign…<br> 然后分别选好对应的证书,如果选择列表中没有刚才创建的证书可以双击直接复制名字上去 </p>
<p> 关于推送服务<br> 基于上面的操作，如果需要推送服务我们还需要申请一个推送证书<br> 依次进入 Certificates —&gt;Production —&gt;Apple Push Notification service SSL (Production)<br> 然后选择需要推送服务的App ID<br> 再选择前面创建的.cerSigningRequest文件<br> 最后点击generated生成推送证书<br>IOS开发流程大致如下：<br><img src="/img/Unity/IOSAppDistributionWorkflows.PNG" alt="IOSAppDistributionWorkflows"></p>
</li>
</ol>
<h5 id="XUPorter-or-Unity-API-PBXFroject"><a href="#XUPorter-or-Unity-API-PBXFroject" class="headerlink" title="XUPorter or Unity API(PBXFroject)"></a>XUPorter or Unity API(PBXFroject)</h5><p>PBXFroject是Unity 5.X版本加进来的。因为5.X以前没有关于XCode自动化修改的相关接口，所以以前的版本用的都是XUPoter这个第三方插件工具来实现自动化修改info.plist文件，自动添加library之类的功能。</p>
<p>本人只使用过XUPoter还没详细使用PBXProject，但XUPoter的作者在Unity 5.X开始已经不在更新支持了，因为有了PBXProject，所以可以这样说，Unity 5.X版本开始可以直接使用Unity 5.X不需要再使用XUPoter了。</p>
<h6 id="XUPoter"><a href="#XUPoter" class="headerlink" title="XUPoter"></a>XUPoter</h6><p>这里直接给出作者工具链接，就不详细讲解如何集成使用了，具体参考官方作者网站。<br><a target="_blank" rel="noopener" href="https://github.com/onevcat/XUPorter">onevcat&#x2F;XUPorter</a></p>
<h6 id="PBXProject"><a href="#PBXProject" class="headerlink" title="PBXProject"></a>PBXProject</h6><p>对IOS的打包后的XCode工程做后处理，我们需要在代码里实现IPostProcessBuild接口的OnPostProcessBuild方法。</p>
<p>XcodePostProcess.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">UnityEditor.iOS.Xcode</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">XCodePostProcess</span> : <span class="title">IPostprocessBuild</span></span><br><span class="line"></span><br><span class="line">    <span class="title">public</span> <span class="title">void</span> <span class="title">OnPostprocessBuild</span>(<span class="title">BuildTarget</span> <span class="title">target</span>, <span class="title">string</span> <span class="title">path</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;XCodePostProcess.OnPostprocessBuild for target &quot;</span> + target + <span class="string">&quot; at path &quot;</span> + path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过PBXProject访问并修改XCode工程相关的设置</span></span><br><span class="line">        <span class="built_in">string</span> projpath = path + <span class="string">&quot;/Unity-iPhone.xcodeproj/project.pbxproj&quot;</span>;</span><br><span class="line">        PBXProject proj = <span class="keyword">new</span> PBXProject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取XCode项目的数据</span></span><br><span class="line">        proj.ReadFromString(File.ReadAllText(projPath));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取XCode项目的Unity Target名字</span></span><br><span class="line">        <span class="built_in">string</span> nativetargetname = PBXProject.GetUnityTargetName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取XCode项目的Unity Target的GUID</span></span><br><span class="line">        <span class="built_in">string</span> nativeTarget = proj.TargetGuidByName(nativetargetname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取XCode项目的Test Target名字</span></span><br><span class="line">        <span class="built_in">string</span> testTarget = proj.TargetGuidByName(PBXProject.GetUnityTestTargetName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置需要设定的target列表</span></span><br><span class="line">        <span class="built_in">string</span>[] buildTargets = <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; nativeTarget, testTarget &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//BitCode是用于提交AppStore后优化数据用的，IOS上是optional，但watchOS和tvOS是必须的。动态设置BitCode值</span></span><br><span class="line">        proj.SetBuildProperty(buildTargets, <span class="string">&quot;ENABLE_BITCODE&quot;</span>, <span class="string">&quot;NO&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//动态修改UnityAppController.mm文件的arc编译参数</span></span><br><span class="line">        ArcOnFileByProjectPath(proj, nativetargetname, <span class="string">&quot;Classes/UnityAppController.mm&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自动化删除ReleaseForProfiling和ReleaseForRunning两个Configuration</span></span><br><span class="line">        proj.RemoveBuildConfig(<span class="string">&quot;ReleaseForProfiling&quot;</span>);</span><br><span class="line">        proj.RemoveBuildConfig(<span class="string">&quot;ReleaseForRunning&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//整个XCode项目数据写回去</span></span><br><span class="line">        File.WriteAllText(projPath, proj.WriteToString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开启或关闭指定target的指定文件的arc(Automatic Reference Counting)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;proj&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;targetname&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filepath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isenablearc&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ArcOnFileByProjectPath</span>(<span class="params">PBXProject proj, <span class="built_in">string</span> targetname, <span class="built_in">string</span> filepath, <span class="built_in">bool</span> isenablearc</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> targetguid = proj.TargetGuidByName(targetname);</span><br><span class="line">        <span class="keyword">var</span> fileguid = proj.FindFileGuidByProjectPath(filepath);</span><br><span class="line">        Debug.Log(<span class="string">&quot;targetguid = &quot;</span> + targetguid);</span><br><span class="line">        Debug.Log(<span class="string">&quot;fileguid = &quot;</span> + fileguid);</span><br><span class="line">        <span class="keyword">var</span> compileflaglist = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="keyword">if</span>(isenablearc)</span><br><span class="line">        &#123;</span><br><span class="line">            compileflaglist.Add(<span class="string">&quot;-fobjc-arc&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            compileflaglist.Add(<span class="string">&quot;-fno-objc-arc&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        proj.SetCompileFlagsForFile(targetguid, fileguid, compileflaglist);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就不一一截Mac对应的图了，示例代码对XCode的各种参数设置都进行了修改，注释也很清楚了，具体详细的使用，请参考官网API解释。</p>
<h4 id="IOS自动化签包"><a href="#IOS自动化签包" class="headerlink" title="IOS自动化签包"></a>IOS自动化签包</h4><p><a target="_blank" rel="noopener" href="https://developer.apple.com/legacy/library/documentation/Darwin/Reference/ManPages/man1/xcodebuild.1.html">Xcodebuild</a>是XCode上编译Xcode工程的工具。</p>
<p>所以接下来我们主要是要学习的是使用Xcodebuild去编写自动化签包的工具。</p>
<p>学习XCode Project项目里的一些相关概念。<br>一下概念来源<a target="_blank" rel="noopener" href="https://www.cnblogs.com/cy568searchx/p/5781717.html">iOS系统提供开发环境下命令行编译工具：xcodebuild</a>:</p>
<ol>
<li>Workspace：简单来说，Workspace就是一个容器，在该容器中可以存放多个你创建的Xcode Project， 以及其他的项目中需要使用到的文件。<br>使用Workspace的好处有：<ul>
<li>扩展项目的可视域，即可以在多个项目之间跳转，重构，一个项目可以使用另一个项目的输出。Workspace会负责各个Project之间提供各种相互依赖的关系;</li>
<li>多个项目之间共享Build目录。</li>
</ul>
</li>
<li>Project：指一个项目，该项目会负责管理生成一个或者多个软件产品的全部文件和配置，一个Project可以包含多个Target。</li>
<li>Target：一个Target是指在一个Project中构建的一个产品，它包含了构建该产品的所有文件，以及如何构建该产品的配置。</li>
<li>Scheme：一个定义好构建过程的Target成为一个Scheme。可在Scheme中定义的Target的构建过程有：Build&#x2F;Run&#x2F;Test&#x2F;Profile&#x2F;Analyze&#x2F;Archive</li>
<li>BuildSetting：配置产品的Build设置，比方说，使用哪个Architectures？使用哪个版本的SDK？。在Xcode Project中，有Project级别的Build Setting，也有Target级别的Build Setting。Build一个产品时一定是针对某个Target的，因此，XCode中总是优先选择Target的Build Setting，如果Target没有配置，则会使用Project的Build Setting。</li>
</ol>
<p>了解了XCode Project中的一些概念，让我们看看Xcodebuild到底是什么样的工具了？<br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/technotes/tn2339/_index.html">xcodebuild is a command-line tool that allows you to perform build, query, analyze, test, and archive operations on your Xcode projects and workspaces from the command line. It operates on one or more targets contained in your project, or a scheme contained in your project or workspace. </a></p>
<p>如果想查看xcodebuild的详细说明，我们可以通过命令行输入:man xcodebuild查看即可:<br><img src="/img/Bash/XcodebuildManualPage.png" alt="XcodebuildManualPage"></p>
<p>首先以XcodeProject为例，我们来看看上面的概念在实际操作过程中对应的东西:<br><img src="/img/Bash/XcodeProjectDemo.png" alt="XcodeProjectDemo"><br>从上面可以看出，我们的Demo Xcode Project是没有workspace的，只有一个叫做Unity-iPhone.xcodeproj的Xcode工程文件，而这个文件对应的就是我们前面提到的Project的概念。</p>
<p>如果我们想查看Xcode Project里面的相关schemes或者target信息，我们可以通过命令行切换到Xcode Project目录下然后输入xcodebuild -list -project *.xcodeproj命令来查看:<br><img src="/img/Bash/XcodeProjectListInfo.png" alt="XcodeProjectListInfo"><br>从上面的信息我们可以看到，我们的Unity-iPhone.xcodeproj项目里有两个Targets分别为:Unity-iPhone和Unity-iPhone Tests以及一个Schemes:Unity-iPhone。这些都分别对应了我们前面最初所了解的相关Xcode Project的概念。</p>
<p>如果想要查看Xcode Project的详细Build Setting设置信息，我们可以通过输入xcodebuild -showBuildSettings来查看：<br><img src="/img/Bash/XcodeProjectBuildSettingsInfo.png" alt="XcodeProjectBuildSettingsInfo"><br>-showBuildSettings有不少东西，很多概念需要对比着Xcode工程里的设置来看，这里暂时不深究每一个代表什么意思。</p>
<p>了解了Workspace,Project,Target,Scheme,BuildSetting等等概念以及如何通过xcodebuild工具查看Xcode工程相关信息后，接下来我们看一下xcodebuild是如何编译打包导出IPA的。</p>
<p>这里参考网上，我发现Xcode9以后有两种方式来实现自动化打包。</p>
<ol>
<li>Automatic</li>
<li>Manual</li>
</ol>
<p>这里我先以Manual的形式来学习打包，后续再学习了解Automatic的形式打包。</p>
<p>首先我们来看看官方对xcodebuild工具的介绍:<br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/technotes/tn2339/_index.html">xcodebuild is a command-line tool that allows you to perform build, query, analyze, test, and archive operations on your Xcode projects and workspaces from the command line.</a><br>可以看出xcodebuild正式苹果官方给出的通过命令行触发打包编译导出一系列操作的工具。</p>
<p>具体想知道xcodebuild的详细使用介绍，可以在shell里输入man xcodebuild查看即可：<br><img src="/img/XcodeAutoSign/ManXcodeBuild.png" alt="ManXcodebuild"></p>
<p>Manual:<br>手动打包之前，我们要用到下面几个比较重要的xcodebuild命令参数:</p>
<ol>
<li>clean – Remove build products and intermediate files from the build root(SYMROOT)(清楚通过build触发编译的所有中间文件)</li>
<li>build – Build the target in the build root(SYMROOT). This is the default action, and is used if no action is given.(build指定target)</li>
<li>archive – Archive a scheme from the build root(SYMROOT). This requires specifying a scheme.(打包指定scheme)</li>
<li>exportArchive – Specifies that an archive should be exported. Requires -archivePath, -exportPath, and -exportOptionsPlist.  Cannot be passed along with an action.(指定Archive文件导出IPA)</li>
</ol>
<p>下面以工作中完整的命令行编译打包导出IPA为例来讲解学习(敏感信息中文代替):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line"># 检查并创建文件夹</span><br><span class="line">CheckAndCreateFolder()</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;CheckOrCreateFolder parameter1 : $1&quot;</span><br><span class="line">    if [ -d $1 ]</span><br><span class="line">    then </span><br><span class="line">        echo &quot;$1 exits!&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;$1 not exits!&quot;</span><br><span class="line">        mkdir -p $1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">currentfolder=~+</span><br><span class="line">homefolderpath=~</span><br><span class="line">xcodeexportoptionfolderpath=&quot;$&#123;homefolderpath&#125;/Desktop/XcodeAutoSign/&quot;</span><br><span class="line">currentdatetime=`date +%Y%m%d%H%M%S`</span><br><span class="line"></span><br><span class="line">#签包相关信息(默认大陆Appstore)</span><br><span class="line"># 包名</span><br><span class="line">bundleid=&quot;对应包名&quot;</span><br><span class="line"># 大陆</span><br><span class="line">areas=&quot;dalu&quot;</span><br><span class="line">#证书类型</span><br><span class="line">provisionprofiletype=&quot;AppStore&quot;</span><br><span class="line"># 证书名字</span><br><span class="line">codesignidentity=&quot;对应证书名字&quot;</span><br><span class="line"># 描述文件名字</span><br><span class="line">provisioningprofile=&quot;对应描述文件名字&quot;</span><br><span class="line"># Deployment最低版本指定</span><br><span class="line">deploymenttarget=&quot;对应最低IOS支持版本&quot;</span><br><span class="line"># 打包导出配置文件</span><br><span class="line"># 最终签名相关信息都是以配置文件为准</span><br><span class="line">exportoptionsplist=&quot;对应签名配置文件&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;--------------------&quot;</span><br><span class="line">echo &quot;1. 大陆Appstore&quot;</span><br><span class="line">echo &quot;2. 大陆AdHoc&quot;</span><br><span class="line">echo &quot;3. 台湾Appstore&quot;</span><br><span class="line">echo &quot;4. 台湾AdHoc&quot;</span><br><span class="line">echo &quot;--------------------&quot;</span><br><span class="line">echo &quot;输入打包类型数字id(默认不输入是大陆AppStore):&quot;</span><br><span class="line">read countrynumber</span><br><span class="line"># 默认大陆</span><br><span class="line">echo &quot;countrynumber = $&#123;countrynumber:=1&#125;&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;输入工程文件夹全路径:&quot;</span><br><span class="line">read xcodeprojectfolderpath</span><br><span class="line">xcodeprojectfullpath=&quot;$&#123;xcodeprojectfolderpath&#125;/Unity-iPhone.xcodeproj&quot;</span><br><span class="line">echo &quot;xcodeprojectfullpath : $&#123;xcodeprojectfullpath&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 检查工程Xcode项目文件是否存在</span><br><span class="line">if [ -d $&#123;xcodeprojectfullpath&#125; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;Xcode项目文件存在!&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;Xcode项目:$&#123;xcodeprojectfullpath&#125;文件不存在!签包IPA失败!&quot; &gt; ErrorLog.txt</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $countrynumber -eq 1 ]</span><br><span class="line">then    </span><br><span class="line">    #大陆Appstore</span><br><span class="line">    echo &quot;大陆AppStore&quot;</span><br><span class="line">    areas=&quot;dalu&quot;</span><br><span class="line">    provisionprofiletype=&quot;AppStore&quot;</span><br><span class="line">    bundleid=&quot;对应包名&quot;</span><br><span class="line">    codesignidentity=&quot;对应证书名字&quot;</span><br><span class="line">    provisioningprofile=&quot;对应描述文件名&quot;</span><br><span class="line">    deploymenttarget=&quot;对应最低IOS支持版本&quot;</span><br><span class="line">    exportoptionsplist=&quot;对应签名配置文件&quot;</span><br><span class="line">elif [ $countrynumber -eq 2 ]</span><br><span class="line">then</span><br><span class="line">    #大陆Ad Hoc</span><br><span class="line">    echo &quot;大陆AdHoc&quot;</span><br><span class="line">    areas=&quot;dalu&quot;</span><br><span class="line">    provisionprofiletype=&quot;AdHoc&quot;</span><br><span class="line">    bundleid=&quot;对应包名&quot;</span><br><span class="line">    codesignidentity=&quot;对应证书名字&quot;</span><br><span class="line">    provisioningprofile=&quot;对应描述文件名&quot;</span><br><span class="line">    deploymenttarget=&quot;对应最低IOS支持版本&quot;</span><br><span class="line">    exportoptionsplist=&quot;对应签名配置文件&quot;</span><br><span class="line">elif [ $countrynumber -eq 3 ]</span><br><span class="line">then</span><br><span class="line">    #台湾Appstore</span><br><span class="line">    echo &quot;台湾Appstore&quot;</span><br><span class="line">    areas=&quot;taiwan&quot;</span><br><span class="line">    provisionprofiletype=&quot;AppStore&quot;</span><br><span class="line">    bundleid=&quot;对应包名&quot;</span><br><span class="line">    codesignidentity=&quot;对应证书名字&quot;</span><br><span class="line">    provisioningprofile=&quot;对应描述文件名&quot;</span><br><span class="line">    deploymenttarget=&quot;对应最低IOS支持版本&quot;</span><br><span class="line">    exportoptionsplist=&quot;对应签名配置文件&quot;</span><br><span class="line">elif [ $countrynumber -eq 4 ]</span><br><span class="line">then</span><br><span class="line">    #台湾AdHoc</span><br><span class="line">    echo &quot;台湾AdHoc&quot;</span><br><span class="line">    areas=&quot;taiwan&quot;</span><br><span class="line">    provisionprofiletype=&quot;AdHoc&quot;</span><br><span class="line">    bundleid=&quot;对应包名&quot;</span><br><span class="line">    codesignidentity=&quot;对应证书名字&quot;</span><br><span class="line">    provisioningprofile=&quot;对应描述文件名&quot;</span><br><span class="line">    deploymenttarget=&quot;对应最低IOS支持版本&quot;</span><br><span class="line">    exportoptionsplist=&quot;对应签名配置文件&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;请输入1或者2或者3或者4!签包失败!&quot; &gt; ErrorLog.txt</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># IPA文件名</span><br><span class="line">ipadname=&quot;$&#123;areas&#125;_$&#123;provisionprofiletype&#125;_$currentdatetime&quot;</span><br><span class="line"># IPA输出目录全路径</span><br><span class="line">ipaexportpath=&quot;/Users/Shared/build-ios/$&#123;areas&#125;/$&#123;provisionprofiletype&#125;/$&#123;currentdatetime&#125;&quot;</span><br><span class="line"># Archive文件名</span><br><span class="line">archivefilename=&quot;$&#123;xcodeprojectfolderpath&#125;/$&#123;areas&#125;_archive.xcarchive&quot;</span><br><span class="line"></span><br><span class="line"># 切换到对应工程目录下</span><br><span class="line">cd $xcodeprojectfolderpath</span><br><span class="line">echo &quot;切换到对应工程目录后当前目录:&quot;</span><br><span class="line">echo ~+</span><br><span class="line"></span><br><span class="line"># 检查输出目录是否存在，不存在则创建一个</span><br><span class="line">CheckAndCreateFolder $ipaexportpath</span><br><span class="line"></span><br><span class="line">#检查导出配置文件是否路径正确且存在</span><br><span class="line">echo &quot;导出配置文件路径:&quot;</span><br><span class="line">echo &quot;$&#123;xcodeexportoptionfolderpath&#125;/$&#123;exportoptionsplist&#125;&quot;</span><br><span class="line">if [ -f $&#123;xcodeexportoptionfolderpath&#125;/$&#123;exportoptionsplist&#125; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;导出配置文件存在!&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;导出配置文件不存在!签包IPA失败!&quot; &gt; ErrorLog.txt</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 判定符合条件的Archive文件是否存在，</span><br><span class="line"># 存在则直接Export，</span><br><span class="line"># 不存在则完全重新签包</span><br><span class="line">if [ ! -d $&#123;archivefilename&#125; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;$&#123;archivefilename&#125;文件不存在!&quot;</span><br><span class="line">    #clean下工程</span><br><span class="line">    echo &quot;开始清理工程&quot;</span><br><span class="line">    xcodebuild  clean \</span><br><span class="line">                -project Unity-iPhone.xcodeproj \</span><br><span class="line">                -configuration Release -alltargets \</span><br><span class="line">                PRODUCT_BUNDLE_IDENTIFIER=&quot;$bundleid&quot;</span><br><span class="line"></span><br><span class="line">    #开始编译</span><br><span class="line">    echo &quot;开始编译打包&quot;</span><br><span class="line">    xcodebuild -project Unity-iPhone.xcodeproj \</span><br><span class="line">                -scheme Unity-iPhone \</span><br><span class="line">                -configuration Release \</span><br><span class="line">                PRODUCT_BUNDLE_IDENTIFIER=&quot;$bundleid&quot; \</span><br><span class="line">                CODE_SIGN_STYLE=&quot;Manual&quot; \</span><br><span class="line">                CODE_SIGN_IDENTITY=&quot;$codesignidentity&quot; \</span><br><span class="line">                PROVISIONING_PROFILE=&quot;$provisioningprofile&quot; \</span><br><span class="line">                IPHONEOS_DEPLOYMENT_TARGET=&quot;$deploymenttarget&quot; \</span><br><span class="line">                -archivePath &quot;$&#123;archivefilename&#125;&quot; \</span><br><span class="line">                archive</span><br><span class="line">else</span><br><span class="line">    echo &quot;$&#123;archivefilename&#125;文件存在!&quot;</span><br><span class="line">fi</span><br><span class="line">            </span><br><span class="line">#开始打包Archive</span><br><span class="line">echo &quot;开始导出IPA&quot;</span><br><span class="line">xcodebuild -exportArchive \</span><br><span class="line">           -archivePath &quot;$&#123;archivefilename&#125;&quot; \</span><br><span class="line">           -exportOptionsPlist &quot;$&#123;xcodeexportoptionfolderpath&#125;/$&#123;exportoptionsplist&#125;&quot; \</span><br><span class="line">           -exportPath &quot;$&#123;ipaexportpath&#125;&quot;</span><br><span class="line"></span><br><span class="line">#修改最终输出的ipa文件名</span><br><span class="line">mv -f &quot;$&#123;ipaexportpath&#125;/Unity-iPhone.ipa&quot; &quot;$&#123;ipaexportpath&#125;/$&#123;ipadname&#125;.ipa&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;xcodeprojectfolderpath : $xcodeprojectfolderpath&quot;</span><br><span class="line">echo &quot;homefolderpath : $homefolderpath&quot;</span><br><span class="line">echo &quot;ipaexportpath : $ipaexportpath&quot;</span><br><span class="line">echo &quot;bundleid : $bundleid&quot;</span><br><span class="line">echo &quot;codesignidentity : $codesignidentity&quot;</span><br><span class="line">echo &quot;provisioningprofile : $provisioningprofile&quot;</span><br><span class="line">echo &quot;deploymenttarget : $deploymenttarget&quot;</span><br><span class="line">echo &quot;exportoptionsplist : $exportoptionsplist&quot;</span><br><span class="line">echo &quot;xcodeexportoptionfolderpath : $xcodeexportoptionfolderpath&quot;</span><br><span class="line">echo &quot;currentdatetime : $currentdatetime&quot;</span><br><span class="line">echo &quot;ipadname : $ipadname&quot;</span><br><span class="line">echo &quot;archivefilename : $archivefilename&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;签包结束.&quot;</span><br><span class="line">$SHELL</span><br></pre></td></tr></table></figure>

<p>这里针对上面的自动化签包脚本，我们需要理解几个关键概念：</p>
<ol>
<li>包名 – 我们平时说的包名，Unity里平台设置那里设置的包名<br>Xcode里显示参考下图：<br> <img src="/img/XcodeAutoSign/XcodeBundleId.png" alt="XcodeBundleId"></li>
<li>证书名字 – IOS开发打包需要的证书文件(比如:Development,Distribution证书)<br>因为Apple Developer Account最近刚到期，无法截后台账号的图，这里只放一张Keychain里面显示已经安装在本地的Certificate图:<br><img src="/img/XcodeAutoSign/KeyChainCertificates.png" alt="KeyChainCertificates"><br>证书名字通过右键对应Certificate后选择Get Info可查看:<br> <img src="/img/XcodeAutoSign/CertificateDetail.png" alt="CertificateDetail"></li>
<li>描述文件 – 是指后台指定了Certificate,Apple Id, Device List等信息的描述文件<br><img src="/img/XcodeAutoSign/ProvisioningProfile.png" alt="ProvisioningProfile"><br>如果想详细查看里面的信息，可以通过下面这个命令:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">security cmd -D -i *.mobileprovision</span><br></pre></td></tr></table></figure>

<p>这里面就包含了很多信息，这里我们暂时需要通过这个找到描述文件的名字:<br>    <img src="/img/XcodeAutoSign/ProvisionProfileName.png" alt="ProvisionProfileName"></p>
<ol start="4">
<li>IOS最低版本支持 – 这个是对应Xcode里设置Deployment Target的那个参数，表示打包支持的最低IOS版本<br><img src="/img/XcodeAutoSign/DeploymentTarget.png" alt="DeploymentTarget"></li>
<li>签名配置文件 – 关于导出IPA时的签名信息以及相关参数等的配置文件<br><img src="/img/XcodeAutoSign/ExportOptionFile.png" alt="ExportOptionFile"><br>让我们看下里面的详细信息:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version=&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">    &lt;key&gt;method&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;app-store&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;provisioningProfiles&lt;/key&gt;</span><br><span class="line">    &lt;dict&gt;</span><br><span class="line">        &lt;key&gt;对应包名&lt;/key&gt;</span><br><span class="line">        &lt;string&gt;对应描述文件名&lt;/string&gt;</span><br><span class="line">    &lt;/dict&gt;</span><br><span class="line">    &lt;key&gt;signingCertificate&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;***&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;signingStyle&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;manual&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;stripSwiftSymbols&lt;/key&gt;</span><br><span class="line">    &lt;true/&gt;</span><br><span class="line">    &lt;key&gt;teamID&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;***&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;uploadSymbols&lt;/key&gt;</span><br><span class="line">    &lt;false/&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到签名配置文件里面指定了导出类型(app-store or development等)，证书名以及包名，描述文件信息等信息。<br>那么这个配置文件哪里来的了？<br>手动Archive后，我们会在*.ipa的同层文件目录下得到一个叫ExportOption.plist的文件，这个就是那个配置文件。</p>
<p>Note：<br>如果我们的程序开启了苹果相关的服务，比如Apple Wallet等，那这些服务会以参数的信息显示在上面的配置文件里，如果后台证书配置了使用特定服务，但该配置文件里没有，就会提示特定字段信息对不上或者遗漏而报错。</p>
<p>可以看出通过上面的自动化，我们可以命令行指定以下内容:</p>
<ol>
<li>包名</li>
<li>证书</li>
<li>描述文件</li>
<li>IOS最低支持版本号</li>
<li>签名证书</li>
</ol>
<p>接下来我们看看xcodebuild编译里是如何指定这些信息并成功导出IPA的:</p>
<ol>
<li>清理工程</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild  clean \                              # 指定了清理工程</span><br><span class="line">            -project Unity-iPhone.xcodeproj \    # 指定清理哪一个project</span><br><span class="line">            -configuration Release -alltargets \ # 指定清理Release下的所有targets</span><br><span class="line">            PRODUCT_BUNDLE_IDENTIFIER=&quot;$bundleid&quot;# 指定了包名(这一个可能不需要)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编译打包</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild -project Unity-iPhone.xcodeproj \                # 指定打包哪个project</span><br><span class="line">            -scheme Unity-iPhone \                          # 指定打包哪个scheme</span><br><span class="line">            -configuration Release \                        # 指定编译Release</span><br><span class="line">            PRODUCT_BUNDLE_IDENTIFIER=&quot;$bundleid&quot; \         # 指定包名</span><br><span class="line">            CODE_SIGN_STYLE=&quot;Manual&quot; \                      # 指定手动签名</span><br><span class="line">            CODE_SIGN_IDENTITY=&quot;$codesignidentity&quot; \        # 指定证书</span><br><span class="line">            PROVISIONING_PROFILE=&quot;$provisioningprofile&quot; \   # 指定描述文件</span><br><span class="line">            IPHONEOS_DEPLOYMENT_TARGET=&quot;$deploymenttarget&quot; \# 指定IOS最低版本</span><br><span class="line">            -archivePath &quot;$&#123;archivefilename&#125;&quot; \             # 指定生成的Archive文件路径</span><br><span class="line">            archive                                         # 指定编译打包</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>导出IPA</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild -exportArchive \                                         # 指定导出IPA</span><br><span class="line">           -archivePath &quot;$&#123;archivefilename&#125;&quot; \                      # 指定Archive文件路径</span><br><span class="line">           -exportOptionsPlist &quot;$&#123;xcodeexportoptionfolderpath&#125;/$&#123;exportoptionsplist&#125;&quot; \ # 指定签名配置文件路径</span><br><span class="line">           -exportPath &quot;$&#123;ipaexportpath&#125;&quot;                           # 指定IPA输出路径</span><br></pre></td></tr></table></figure>

<p>上面的注释已经很详细了，这里就不在详细讲解了。<br>通过archive命令，我们得到了一个*.xcarchive的文件。<br><img src="/img/XcodeAutoSign/ArchiveFile.png" alt="ArchiveFile"><br>通过这个*.xcarchive文件，我们可以通过指定签名配置文件导出我们想要的IPA文件。</p>
<p>Automatic:<br>待续……</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a target="_blank" rel="noopener" href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/001374027586935cf69c53637d8458c9aec27dd546a6cd6000">http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/001374027586935cf69c53637d8458c9aec27dd546a6cd6000</a>)</p>
<h2 id="Jenkins-Part"><a href="#Jenkins-Part" class="headerlink" title="Jenkins Part"></a>Jenkins Part</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Groovy">Groovy</a><br><a target="_blank" rel="noopener" href="https://wiki.jenkins-ci.org/display/JENKINS/Unity3dBuilder+Plugin#Unity3dBuilderPlugin-Usageguide">Uniy3d Plugin</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/houyefeng/article/details/50914582">Jenkins——应用篇——插件使用——Mailer Plugin</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/zz0412/p/jenkins_jj_01.html">Jenkins进阶系列之——01使用email-ext替换Jenkins的默认邮件通知</a><br><a target="_blank" rel="noopener" href="http://7dot9.com/2016/11/18/macos-jenkins-ci-unity-setup-config-guide/">macOS 安装配置 Jenkins 持续集成 Unity 项目指南</a><br><a target="_blank" rel="noopener" href="http://www.it610.com/article/3905365.htm">MAC EI Capitan上更新系统自带SVN版本(关闭SIP方能sudo rm)</a><br><a target="_blank" rel="noopener" href="https://support.apple.com/en-us/HT204899">About System Integrity Protection on your Mac</a><br><a target="_blank" rel="noopener" href="https://wiki.jenkins-ci.org/display/JENKINS/Email-ext+plugin#Email-extplugin-TemplateExamples">Email-ext plugin</a></p>
<h2 id="Shell-Part"><a href="#Shell-Part" class="headerlink" title="Shell Part"></a>Shell Part</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix_shell">Unix shell</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Shell%E8%84%9A%E6%9C%AC">Shell脚本</a><br><a target="_blank" rel="noopener" href="http://tldp.org/LDP/abs/html/">Advanced Bash-Scripting Guide</a></p>
<h2 id="Xcodebuild-Part"><a href="#Xcodebuild-Part" class="headerlink" title="Xcodebuild Part"></a>Xcodebuild Part</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e691a81d576c">Xcode 9 最新 最准确 的自动化打包</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cy568searchx/p/5781717.html">iOS系统提供开发环境下命令行编译工具：xcodebuild</a><br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/technotes/tn2339/_index.html">Building from the Command Line with Xcode FAQ</a><br><a target="_blank" rel="noopener" href="https://help.apple.com/xcode/mac/current/#/itcaec37c2a6">Build settings reference</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a href=""></a><br><a href=""></a><br><a href=""></a><br><a href=""></a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Automation/">Automation</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/17/SublimeText3使用/" title="SublimeText3使用" itemprop="url">SublimeText3使用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-02-17T15:59:11.000Z" itemprop="datePublished"> 发表于 2017-02-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Editor"><a href="#Editor" class="headerlink" title="Editor"></a>Editor</h1><h2 id="Editor-Comparison"><a href="#Editor-Comparison" class="headerlink" title="Editor Comparison"></a>Editor Comparison</h2><p>先如今有很多优秀的编辑器(有些近乎IDE的水准):</p>
<ol>
<li>Sublime Text 3</li>
<li>Vim</li>
<li>Emacs</li>
<li>VS Code</li>
<li>Notepade++<br>……</li>
</ol>
<p>每一种都各有各的优势，作为一个小白用户，连Sublime Text 3和VS Code都算不上使用熟悉，所以这里并不能做详细的比较。</p>
<h2 id="Editor-Chosen"><a href="#Editor-Chosen" class="headerlink" title="Editor Chosen"></a>Editor Chosen</h2><p>How to choose editor?<br>在选择自己的IDE或则编辑器的时候，我很赞同一句话“没有最厉害最优秀的只有最适合。”<br>所以哪一种最好最适合取决于我们用它做什么。</p>
<p>What do I need?<br>作为一个前端程序员，大部分时间是在做手游或者PC端的开发，需要和Android，IOS，PC打交道。<br>在Windows上主要使用VS，Android Studio作为IDE。<br>在Mac上使用XCode作为IDE。<br>主要使用C++,C#,Java,Python,bat,Lua等编程语言。<br>但VS，Android Studio，XCode都属于比较大型的IDE，这里主要是需要一个轻量级的编辑器。<br>主要希望有下列功能：</p>
<ol>
<li>跨平台(跨Mac和Windows开发)</li>
<li>语法高亮</li>
<li>代码补充</li>
<li>调试(option)</li>
<li>快速切换，查询，跳转等方便快捷的快捷修改</li>
<li>快速启动</li>
<li>方便自定义(比如背景，快捷键设置等)</li>
<li>扩展性强(方便添加支持更多功能)<br>……</li>
</ol>
<p>Why choose Sublime Text 3?<br>这里就不一一说明Sublime Text 3的好处了，几乎上面我需要的都可以很方便的扩展支持，这也就是为什么选择Sublime Text 3的原因。</p>
<h1 id="Sublime-Text-3"><a href="#Sublime-Text-3" class="headerlink" title="Sublime Text 3"></a>Sublime Text 3</h1><p><a target="_blank" rel="noopener" href="https://www.sublimetext.com/">Sublime Text 3官网</a></p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><p><a target="_blank" rel="noopener" href="https://www.sublimetext.com/3">Download Sublime Text 3</a></p>
<h2 id="Useful-Package"><a href="#Useful-Package" class="headerlink" title="Useful Package"></a>Useful Package</h2><ol>
<li>Package Control<br>Sublime Text 3扩展性强就在于通过安装扩展包，可以得到很多有用的功能支持。<br>而帮助快速安装和查找有用的Package，就不得不提Package Control，有了它我们可以快速的搜索和安装想要的Package。<br>如何安装Package Control：<br><a target="_blank" rel="noopener" href="https://packagecontrol.io/installation">Package Control Installation</a><br>如果不知道有哪些Package，可以在下面官网查询：<br><a target="_blank" rel="noopener" href="https://packagecontrol.io/">Package Control Package</a></li>
<li>Terminal<br>偶尔会需要打开命令行窗口，这个插件可以帮助我们直接在Sublime里通过快捷键快速打开系统自带命令行<br><a target="_blank" rel="noopener" href="https://github.com/wbond/sublime_terminal">Terminal</a><br>Note:<br>虽然Sublime Text 3也有Git相关的插件，但是考虑已经添加了快速打开命令行的插件，并且Git使用不会太频繁，所以不单独添加Git扩展。</li>
<li>Markdown<br>Markdown是我们经常会去编写文档的一类格式，语法高亮，快速浏览效果是效率的关键。<ol>
<li><p><a target="_blank" rel="noopener" href="https://packagecontrol.io/packages/MarkdownEditing">Markdown Edit</a><br> Better syntax understanding and good color schemes.</p>
</li>
<li><p>Markdown Preview<br> ctrl+shift+p，然后输入Markdown Preview: Preview in Browser<br> 我们去Preference -&gt; Key Binding里去改快速生成Markdown HTML的快捷键</p>
</li>
</ol>
</li>
</ol>
<p><img src="/img/Editors/SublimeText3/MarkPreviewShortCut.PNG" alt="MarkPreviewShortCut"><br>    最后得到我们Markdown的网页版：<br><img src="/img/Editors/SublimeText3/MarkDownPreviewOnBrowser.PNG" alt="MarkDownPreviewOnBrowser"></p>
<ol start="4">
<li><a target="_blank" rel="noopener" href="https://packagecontrol.io/packages/SublimeCodeIntel">SublimeCodeIntel</a><br><a target="_blank" rel="noopener" href="https://www.oschina.net/news/71008/8-sublime-text-3-plugins">SublimeCodeIntel 作为一个代码提示和补全插件，支持 JavaScript、Mason、XBL、XUL、RHTML、SCSS、Python、HTML、Ruby、Python3、XML、Sass、XSLT、Django、HTML5、Perl、CSS、Twig、Less、Smarty、Node.js、Tcl、TemplateToolkit 和 PHP 等所有语言，是 Sublime Text 自带代码提示功能基础上一个更好的扩展，自带代码提示功能只可提示系统代码，而SublimeCodeIntel则可以提示用户自定义代码。</a><br>这里本人主要是为了配置Python<br>因为官网提到Default Settings在更新时会被覆盖，如果要修改设置应该写在User里。<br>Preferences -&gt; Package Settings -&gt; SublimeCodeIntel -&gt; Setting User<br>配置Python如下：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">   SublimeCodeIntel user settings</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">       Defines a configuration for each language.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="string">&quot;codeintel_language_settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Python&quot;</span>: &#123; </span><br><span class="line">           <span class="comment">// For Windows Python 2.7</span></span><br><span class="line">           <span class="string">&quot;python&quot;</span>: <span class="string">&quot;H:/StudyTools/Phyton2_7/python.exe&quot;</span>,</span><br><span class="line">           <span class="string">&quot;pythonExtraPaths&quot;</span>:[</span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Phyton2_7&quot;</span>,</span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Phyton2_7/DLLs&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Phyton2_7/Lib&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Phyton2_7/Lib/lib-tk&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Phyton2_7/Lib/site-packages&quot;</span>,  </span><br><span class="line">           ],</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;Python3&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;python&quot;</span>: <span class="string">&quot;H:/StudyTools/Python3_6/python.exe&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pythonExtraPaths&quot;</span>: [</span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Python3_6&quot;</span>,</span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Python3_6/DLLs&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Python3_6/Lib&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Python3_6/Lib/tkinter&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;H:/StudyTools/Python3_6/Lib/site-packages&quot;</span>,  </span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>其中是Python和Python3分别代表Python2.x和Python3.x的安装路径
如果需要配置其他语言，也写在&quot;codeintel_language_settings&quot;里即可。
这个由于还没正式开始学习使用Python，但测试无论配没配置上面，系统提示和自定义方法都会有自动提示和补全功能和函数跳转(Alt+click)(不确定是Sublime Text 3自带的还是SublimeCodeIntel的功能，暂时先按上面的方式设置)
</code></pre>
<ol start="5">
<li><a target="_blank" rel="noopener" href="http://www.sublimelinter.com/en/latest/installation.html">SublimeLinter</a><br>SublimeLinter是一个 framework for linters(静态代码检查的框架)。要支持不同的语言需要额外装对应的扩展包。<br>主要是为了装Python的静态代码和代码规范检查。<br>现在SublimeLinter上Python的Linter有很多，比如pep8,pylint,flake8,bandit等<br>作为Python初学者这里暂时不纠结哪一个更好，暂时使用flake作为尝试。<br>因为SublimeLinterFlake8会用到flake，所以需要安装flake先：<br>打开terminal，输入pip install flake<br>python3自带pip<br>低于python2.7.9的好像要自己装pip<br>pip可以理解成类似于Package Control帮助快速安装Python工具包的工具。<br>确认flake8.exe在环境变量中：<br><img src="/img/Editors/SublimeText3/WhereFlake8.PNG" alt="WhereFlake8"><br>然后通过PackageControl安装SublimeLinterFlake8即可。<br>这样一来就有静态代码和代码规范检查了:<br><img src="/img/Editors/SublimeText3/SublimeLinterFlake8.PNG" alt="SublimeLinterFlake8"></li>
<li><a target="_blank" rel="noopener" href="https://packagecontrol.io/packages/Git">Git</a><br>Git是程序员经常打交道的东西。为了在Sublime Text 3里快速的使用Git提高效率。安装Git插件可以支持我们在Ctrl+Shift+P里直接调用Git命令。<br>安装步骤还是通过Package Control这里就不再重述。<br>直接看看安装好后的效果：<br><img src="/img/Editors/SublimeText3/GitPlugin.PNG" alt="GitPlugin"></li>
<li><a target="_blank" rel="noopener" href="https://packagecontrol.io/packages/GitGutter">GitGutter</a><br>GitGutter主要是提供了Git提交时在Sublime Text 3里支持高亮显示增删改查等变化。<br>老规矩安装(Packgage Control)<br>直接看看使用GitGutter提交时的高亮显示变化效果:<br><img src="/img/Editors/SublimeText3/GitGutter.PNG" alt="GitGutter"></li>
</ol>
<h2 id="Custom-Sublime-Text-3"><a href="#Custom-Sublime-Text-3" class="headerlink" title="Custom Sublime Text 3"></a>Custom Sublime Text 3</h2><ol>
<li><p>Key Binding<br>自定义快捷键。打开Preference -&gt; Key Binding进行快捷键修改(这里以打开修改方法跳转，文件搜索等快捷键跟VS番茄插件一致为例)<br><img src="/img/Editors/SublimeText3/KeyBinding.PNG" alt="KeyBinding"><br>Note:<br>改快捷键绑定只是让新的快捷键覆盖相同快捷键但并不关闭原始快捷键设置，要想默认快捷键不起作用还得设置相同的快捷键覆盖。</p>
</li>
<li><p>Sublime Text 3 Setting<br>字体大小，行号显示，拼写检查等设置。<br>修改默认设置跟自定义快捷键差不多。<br>比如我们想默认字体大小改大一点：<br>Preference -&gt; Settings<br><img src="/img/Editors/SublimeText3/SublimeText3Setting.PNG" alt="SublimeText3Setting"><br>我们希望修改只针对MarkDown文件的语法高亮规则：<br>打开*.md文件<br>Preference -&gt; Settings - Syntax Specific</p>
</li>
<li><p>Theme</p>
</li>
<li><p>Custom Snippets<br>自定义快速填充片段。帮助我们在快速编写重复的代码或者注释。<br>Tools -&gt; Developer -&gt; New Snippets<br>放在:C:\Users\mshz\AppData\Roaming\Sublime Text 3\Packages\User下<br>貌似每一个Snippets文件只能编写一个对应的Snippet。<br>所以要想管理不同编程语言之间的Snippets，我们可以通过建立不同的文件夹进行管理分类。<br>接下来看看Snippet事例和使用效果：</p>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;snippet&gt;</span><br><span class="line">  &lt;content&gt;&lt;![CDATA[</span><br><span class="line"><span class="meta"># File Name:    $TM_FILENAME</span></span><br><span class="line"><span class="meta"># Description:    This file is used to $&#123;1:Staff&#125;</span></span><br><span class="line"><span class="meta"># Author:       $&#123;2:TangHuan&#125;</span></span><br><span class="line"><span class="meta"># Create Date:    $&#123;3:Year&#125;/$&#123;4:Month&#125;/$&#123;5:Day&#125;</span></span><br><span class="line">]]&gt;&lt;/content&gt;</span><br><span class="line">  &lt;!-- Optional: Set a tabTrigger to define how to trigger the snippet --&gt;</span><br><span class="line">  &lt;tabTrigger&gt;PyFileHeader&lt;/tabTrigger&gt;</span><br><span class="line">  &lt;!-- Optional: Set a scope to limit <span class="keyword">where</span> the snippet will trigger --&gt;</span><br><span class="line">  &lt;scope&gt;source.python&lt;/scope&gt;</span><br><span class="line">&lt;/snippet&gt;</span><br></pre></td></tr></table></figure>
<p><content><![CDATA[这里的内容是我们自定义快速生成的模板]]></content><br><tabTrigger>这里的内容是触发当前Snippet的输入内容</tabTrigger><br><scop>这里的内容是当前Snippet支持的文件类型</scop><br>看看使用效果:<br><img src="/img/Editors/SublimeText3/SublimeText3SnippetsTrigger.PNG" alt="SublimeText3SnippetsTrigger"><br><img src="/img/Editors/SublimeText3/SublimeText3SnippetsUsing.PNG" alt="SublimeText3SnippetsUsing"></p>
<h2 id="Useful-Shortcut"><a href="#Useful-Shortcut" class="headerlink" title="Useful Shortcut"></a>Useful Shortcut</h2><h3 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h3><ol>
<li>Open Package Control - Ctrl + Shift + P<br><img src="/img/Editors/SublimeText3/PackageControl.PNG" alt="PackageControl"></li>
<li>Open Console - Ctrl + &#96;<br><img src="/img/Editors/SublimeText3/ShowCommands.PNG" alt="Console"></li>
<li>Open CMD Console - Ctrl + Shift + T<br><img src="/img/Editors/SublimeText3/ShowCommands.PNG" alt="ShowCommands"><br>Windows上默认是打开的power shell，如果希望打开普通的cmd窗口，可以在Preferences &gt; Package Settings &gt; Terminal &gt; Settings – Default 里指定terminal路径参数等<br><img src="/img/Editors/SublimeText3/TerminalSetting.PNG" alt="TerminalSetting"></li>
</ol>
<h3 id="Editing"><a href="#Editing" class="headerlink" title="Editing"></a>Editing</h3><ol>
<li>Go Anything - Ctrl + P<br>平时打开一个工程或则大的文件目录，我们想要快速定位特定文件里的特定内容。<br>这时Go Anything能满足需求。<br>比如查找FPSDisplay.cs文件里Init()符号：<br>FPSDisplay.cs @Init<br>查找FPSDisplay.cs文件里的特定文字：<br>FPSDisplay.cs #Hello<br>跳转特定文件特定行：<br>FPSDisplay.cs :1(行号)</li>
<li>Multiple Selections<br>当我们需要在文本中找到特定文本并进行修改时，我们可以通过Multiple Selections进行选中我们想要选中的文本然后进行一次修改多行改变，而不用修改多次。<br>Ctrl+D：选中当前光标所在位置的单词。连续使用时，进行多光标选择，选中下一个同名单词。<br>Ctrl+K：配合Ctrl+D可以跳过下一个同名单词。<br>下面是选择替换FPSDisplay.cs中的mTestSublimeGoAnything为例(只替换第一个和第三个匹配的)：<br><img src="/img/Editors/SublimeText3/MutilpleSelection.PNG" alt="MutilpleSelection"></li>
</ol>
<h2 id="Usefule-Commands"><a href="#Usefule-Commands" class="headerlink" title="Usefule Commands"></a>Usefule Commands</h2><ol>
<li>sublime.log_commands(True) – 在console窗口显示当前操作的命令(可以针对特定命令修改成我们自己想要的快捷键)<br><img src="/img/Editors/SublimeText3/ShowCommands.PNG" alt="ShowCommands"></li>
</ol>
<h2 id="Usefule-Setting"><a href="#Usefule-Setting" class="headerlink" title="Usefule Setting"></a>Usefule Setting</h2><ol>
<li>Split Editing<br>View -&gt; Layout -&gt; **<br>很多时候我们需要同时查看多个文件，方便对照查看并修改。<br>分割出来的窗口在窗口操作上是独立的，但同样的文件在两个窗口是同一份。<br><img src="/img/Editors/SublimeText3/SplitEdit.PNG" alt="SplitEdit"></li>
</ol>
<h2 id="User-Setting-Backup"><a href="#User-Setting-Backup" class="headerlink" title="User Setting Backup"></a>User Setting Backup</h2><p>备份Sublime Text 3所有的Package和个性化设置。<br>我们只需要保存一下目录即可:<br>C:\Users\user\AppData\Roaming\Sublime Text 3\Packages<br>当需要同步的时候，把上面的内容覆盖到新的电脑上Sublime Text 3对应的目录即可。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://www.sublimetext.com/">Sublime Text 3</a><br><a target="_blank" rel="noopener" href="http://blog.guowenfh.com/2015/12/26/SublimeText/">一个前端程序猿的Sublime Text3的自我修养</a><br><a target="_blank" rel="noopener" href="https://www.sublimetext.com/docs/3/">Sublime Text 3 Documentation</a><br><a target="_blank" rel="noopener" href="https://www.oschina.net/news/71008/8-sublime-text-3-plugins">开发者最常用的 8 款 Sublime text 3 插件</a><br><a target="_blank" rel="noopener" href="http://tanchao90.com/sublime/">Sublime Text 使用小结</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Other/">Other</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/SubmlineText3/">SubmlineText3</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/20/Unity-Shader/" title="Unity Shader" itemprop="url">Unity Shader</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-12-19T16:35:50.000Z" itemprop="datePublished"> 发表于 2016-12-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>参考书籍《Unity Shader 入门精要》 – 冯乐乐(一位在图形渲染方面很厉害的女生)</p>
<p>使用的Unity版本：<br>Unity 5.4.0f3</p>
<h1 id="Rendering"><a href="#Rendering" class="headerlink" title="Rendering"></a>Rendering</h1><p>关于图形渲染相关知识以及OpenGL相关学习参见：<br><a href="http://tonytang1990.github.io/2015/08/29/Computer-Graphic-Study/">Computer_Graphic_Study</a><br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/">OpenGL_Study</a></p>
<h1 id="Unity-Shader"><a href="#Unity-Shader" class="headerlink" title="Unity Shader"></a>Unity Shader</h1><p>首先让我们通过官网的一张图来看看Unity Shader里面占据重要地位的3D Model,Material,Shader之间的关系：<br><img src="/img/Unity/UnityShaderFundamention.PNG" alt="UnityShaderFundamention"><br>可以看出Material会决定使用哪些Texture和Shader去渲染Model。<br>Shader是针对Texture和Model去做运算的地方。</p>
<p>Unity Shader最主要的有两种(还有Image Effect Shader,Computer Shader等后续会学习)：</p>
<ol>
<li>Surface shader<br>Time to use – “Whenever the material you want to simulate needs to be affected by lights in a realistic way, chances are you’ll need a surface shader. Surface shaders hide the calculations of how light is reflected and allows to specify “intuitive” properties such as the albedo, the normals, the reflectivity and so on in a function called surf.”<br>可以看出Unity的Surface Shader帮我们把光照对物体的影响的计算抽象了出来。我们只需设定一些控制系数，然后通过Surface Shader的surf方法就能触发光照作用对表面的运算。<br>下面简单看下官网给出的Surface Shader Code：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CGPROGRAM</span><br><span class="line"><span class="comment">// Uses the Lambertian lighting model</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> surface surf Lambert</span></span><br><span class="line"></span><br><span class="line">sampler2D _MainTex; <span class="comment">// The input texture</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> Input &#123;</span><br><span class="line">    float2 uv_MainTex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutput o</span>)</span> &#123;</span><br><span class="line">    o.Albedo = tex2D (_MainTex, IN.uv_MainTex).rgb;</span><br><span class="line">&#125;</span><br><span class="line">ENDCG</span><br></pre></td></tr></table></figure>
<pre><code>Note:
必须使用#pragma surface去表示是surface shader
Surface Shader的Code是包含在SubShader里的并且必须写在CGPROGRAM和ENDCG标识之间。
</code></pre>
<ol start="2">
<li>Fragment and Vertex Shaders<br>Fragment and Vertex Shaders就跟OpenGL里差不多，model的vertex会经历完整的Shader Pipeline，最终通过计算得出最终的颜色。<br>让我们来看看官网给出的Fragment and Vertex Shaders Code:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Pass &#123;</span><br><span class="line">    CGPROGRAM</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> vertex vert             </span></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> vertInput &#123;</span><br><span class="line">        float4 pos : POSITION;</span><br><span class="line">    &#125;;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> vertOutput &#123;</span><br><span class="line">        float4 pos : SV_POSITION;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function">vertOutput <span class="title">vert</span>(<span class="params">vertInput input</span>)</span> &#123;</span><br><span class="line">        vertOutput o;</span><br><span class="line">        o.pos = mul(UNITY_MATRIX_MVP, input.pos);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">half4 <span class="title">frag</span>(<span class="params">vertOutput output</span>) : COLOR</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> half4(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    ENDCG</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出vert方法好比OpenGL里vertex shader的main函数入口。<br>frag方法好比OpenGL里fragment shader的main函数入口。<br>这里frag方法return的half4相当于OpenGL FS里的FragColor。<br>可以看出我们还是需要在VS里先将vertex变换到透视投影坐标系，然后最后传递给FS，FS计算出最终的颜色。<br>Note：<br>这里需要注意的一点是，在VS和FS Shader里，code是包含在Pass {…..}里的。</p>
<p>让我们来看看官网给出的Shader的大体结构：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;MyShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// The properties of your shaders</span></span><br><span class="line">        <span class="comment">// - textures</span></span><br><span class="line">        <span class="comment">// - colours</span></span><br><span class="line">        <span class="comment">// - parameters</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// The code of your shaders</span></span><br><span class="line">        <span class="comment">// - surface shader</span></span><br><span class="line">        <span class="comment">//    OR</span></span><br><span class="line">        <span class="comment">// - vertex and fragment shader</span></span><br><span class="line">        <span class="comment">//    OR</span></span><br><span class="line">        <span class="comment">// - fixed function shader</span></span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Properties:<br>“The properties of your shader are somehow equivalent to the public fields in a C# script; they’ll appear in the inspector of your material, giving you the chance to tweak them.”<br>从这里看出Properties在Unity里相当于OPENGL Shader里定义的Uniform，Sampler，全局变量等，用于作为可控的输入。<br>让我们来看看官网给出的例子</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Properties</span><br><span class="line">&#123;</span><br><span class="line">    _MyTexture (<span class="string">&quot;My texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">    _MyNormalMap (<span class="string">&quot;My normal map&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;bump&quot;</span> &#123;&#125;  <span class="comment">// Grey</span></span><br><span class="line"></span><br><span class="line">    _MyInt (<span class="string">&quot;My integer&quot;</span>, Int) = <span class="number">2</span></span><br><span class="line">    _MyFloat (<span class="string">&quot;My float&quot;</span>, Float) = <span class="number">1.5</span></span><br><span class="line">    _MyRange (<span class="string">&quot;My range&quot;</span>, Range(<span class="number">0.0</span>, <span class="number">1.0</span>)) = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    _MyColor (<span class="string">&quot;My colour&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)    <span class="comment">// (R, G, B, A)</span></span><br><span class="line">    _MyVector (<span class="string">&quot;My Vector4&quot;</span>, Vector) = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// (x, y, z, w)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们先看看对应显示在Unity面板是什么模样：<br><img src="/img/Unity/UnityShaderProperty.PNG" alt="UnityShaderProperty"><br>2D代表_MyTexture,_MyNormalMap是texture类型.Color代表颜色。Range代表范围值……<br>可以看到Properties里定义的变量都显示在了Unity面板里用于控制。但是真正通过Shader去访问，我们还需要在SubShader里重新定义对应的变量。<br>SubShader：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SubShader</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Code of the shader</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    sampler2D _MyTexture;</span><br><span class="line">    sampler2D _MyNormalMap;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> _MyInt;</span><br><span class="line">    <span class="built_in">float</span> _MyFloat;</span><br><span class="line">    <span class="built_in">float</span> _MyRange;</span><br><span class="line">    half4 _MyColor;</span><br><span class="line">    float4 _MyVector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Code of the shader</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出Texture在Unity Shader里面的定义和在OpenGL Shader里差不多，也是通过sampler2D，只是不再需要加uniform修饰了。<br>这里值得注意的是Color对应的不是Vector4而是half4。<br>还有就是在Properties里定义的变量名在SubShader要一一对应。</p>
<p>接下来让我们看看官网给出的SubShader里Shader具体是怎样的格式：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SubShader</span><br><span class="line">&#123;</span><br><span class="line">    Tags</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Queue&quot;</span> = <span class="string">&quot;Geometry&quot;</span></span><br><span class="line">        <span class="string">&quot;RenderType&quot;</span> = <span class="string">&quot;Opaque&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    CGPROGRAM</span><br><span class="line">    <span class="comment">// Cg / HLSL code of the shader</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    ENDCG</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>真正的Shader Code是在CGPROGRAM和ENGCG里。<br>这里需要先提一下Tags的作用，Tags是为了告诉Unity我们Shader的特定属性(比如RenderType-渲染类型，Queue–渲染顺序)。</p>
<h2 id="Surface-Shaders"><a href="#Surface-Shaders" class="headerlink" title="Surface Shaders"></a>Surface Shaders</h2><p>让我们看看Surface Shader的大体流程：<br><a target="_blank" rel="noopener" href="http://www.alanzucconi.com/2015/06/17/surface-shaders-in-unity3d/">下图来源</a><br><img src="/img/Unity/SurfaceShaderFlowChart.PNG" alt="SurfaceShaderFlowChart"><br>从上图可以看出，Surace Shader通过Surface function生成最终参与光照计算所需的数据(rendering properties – e.g. texture……)。</p>
<p>让我们来看看Surface Shader里的关键组成部分：</p>
<ol>
<li>Surface function<br>Surface function把model data作为输入，把rendering properties作为输出，这些rendering properties最后会参与光照的计算得到最终颜色。</li>
<li>Input<br>Input structure一般包含了texture相关的信息(比如 UV坐标信息)，也可以包含一些额外信息(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-SurfaceShaders.html">参见</a>)<br>Note:<br>定义texture coordinate的时候必须以uv或者uv2开头加texture名字。</li>
<li>SurfaceOutput<br>SurfaceOutput描述了surface的属性，这些属性最终会参与光照计算。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> SurfaceOutput</span><br><span class="line">&#123;</span><br><span class="line">    fixed3 Albedo;  <span class="comment">// diffuse color</span></span><br><span class="line">    fixed3 Normal;  <span class="comment">// tangent space normal, if written</span></span><br><span class="line">    fixed3 Emission;</span><br><span class="line">    half Specular;  <span class="comment">// specular power in 0..1 range</span></span><br><span class="line">    <span class="keyword">fixed</span> Gloss;    <span class="comment">// specular intensity</span></span><br><span class="line">    <span class="keyword">fixed</span> Alpha;    <span class="comment">// alpha for transparencies</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<pre><code>我们可以通过Shader去计算上面参与光照计算的属性去影响Surface的最终效果，从而达到Surface Shader的真正目的。
</code></pre>
<ol start="4">
<li>Light Model<br>Light Model是真正通过SurfaceOutput属性去计算光照的地方，通过使用或编写不同的Light Model我们可以实现不同的光照影响效果。<br>那么如何定义光照运算函数了？<ol>
<li>half4 Lighting<Name> (SurfaceOutput s, half3 lightDir, half atten);<br>因为没有viewDir所以这里是用于不需要知道观察点的Ambient光照计算</li>
<li>half4 Lighting<Name> (SurfaceOutput s, half3 lightDir, half3 viewDir, half atten);<br>因为有了viewDir，知道了观察点信息，我们可以计算出需要知道观察点的Diffuse和Specular光照。</li>
<li>half4 Lighting<Name>_PrePass (SurfaceOutput s, half4 light);<br>这个用于Deferer Shading(但这里我比较好奇的是如果要计算Diffuse和Specular光照还是需要知道lightDir和viewDir等信息才对。)<br>Note：<br>自定义光照模型的时候，我们不需要定义所有的光照函数，只需定义我们需要的即可。</li>
</ol>
</li>
<li>Vertex Function<br>Provide the ability to change vertices before sending them to surf.<br>定义方式如下：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vert</span>(<span class="params">inout appdata_full v</span>)</span>&#123;......&#125;</span><br></pre></td></tr></table></figure>
<pre><code>appdata_full包含了所有vertex相关的信息
</code></pre>
<ol start="6">
<li>Finalcolor Function<br>用于对经过Surface Shader处理后的pixel进行最后的处理。<br>格式如下：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> surface surf Lambert finalcolor:mycolor</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mycolor</span> (<span class="params">Input IN, SurfaceOutput o, inout fixed4 color</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    color *= _ColorTint;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>接下来让我们通过创建自己的Surface Shader来感受下Surface Shader实际运用效果(这里我拿了SurviveShooter里的模型做输入)：</strong><br>以下学习参考至<a target="_blank" rel="noopener" href="http://www.alanzucconi.com/2015/06/17/surface-shaders-in-unity3d/">Surface shaders in Unity3D</a><br>我们删掉默认创建的Shader Code，只简单输出Albedo(Diffuse Color)看看效果:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    SubShader &#123;</span><br><span class="line">        <span class="comment">// 定义渲染顺序 - RenderType</span></span><br><span class="line">        Tags &#123; <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Opaque&quot;</span> &#125;</span><br><span class="line">        </span><br><span class="line">        CGPROGRAM</span><br><span class="line">        <span class="comment">// #pragma surface指明是surface shader</span></span><br><span class="line">        <span class="comment">// surf Lambert指明用的光照模式是Lambert(会决定光照是如何计算的)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">pragma</span> surface surf Lambert</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> Input &#123;</span><br><span class="line">            float2 color : COLOR;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutput o</span>)</span> &#123;</span><br><span class="line">            o.Albedo = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125; </span><br><span class="line">    FallBack <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/SurfaceShaderWithAlbedoSetting.PNG" alt="SurfaceShaderWithAlbedoSetting"><br><strong>接下来让我们给Hellephant加上纹理图案：</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        <span class="comment">// 为了在编辑器里提供控制纹理输入，Properties必须和struct Input里的uv_MainTex对应</span></span><br><span class="line">        _MainTex(<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader&#123;</span><br><span class="line">        Tags&#123; <span class="string">&quot;RenderType&quot;</span> = <span class="string">&quot;Opaque&quot;</span>&#125;</span><br><span class="line">        CGPROGRAM</span><br><span class="line">        <span class="meta">#<span class="keyword">pragma</span> surface surf Lambert</span></span><br><span class="line">        <span class="comment">// 提供纹理输入</span></span><br><span class="line">        <span class="keyword">struct</span> Input&#123;</span><br><span class="line">            float2 uv_MainTex</span><br><span class="line">        &#125;;</span><br><span class="line">        sampler2D _MainTex;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutputStandard o</span>)</span> &#123;</span><br><span class="line">            o.Albedo = tex2D(_MainTex, IN.uv_MainTex).rgb;</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/SurfaceShaderWithTexture.PNG" alt="SurfaceShaderWithTexture"><br>让我们看看现在对应的Unity Material Editor：<br><img src="/img/Unity/SurfaceShaderMaterialEditorWithTexture.PNG" alt="SurfaceShaderMaterialEditorWithTexture"><br><strong>图像看起来还不真实，没有深度感，接下来我们添加<a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Light_and_Shadow">Normal Mapping 参见</a>：</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        .....</span><br><span class="line">        _BumpMap(<span class="string">&quot;Bumpmap&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;bump&quot;</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader&#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> Input&#123;</span><br><span class="line">            ......</span><br><span class="line">            float2 uv_BumpMap;</span><br><span class="line">        &#125;;</span><br><span class="line">        ......</span><br><span class="line">        sampler2D _BumpMap;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutputStandard o</span>)</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            o.Normal = UnpackNormal(tex2D(_BumpMap, IN.uv_Bumpmap));</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UnpackNormal接受一个fixed4的输入，并将其转换为所对应的法线值（fixed3）<br>比较有无Normal map的效果，见如下：<br><img src="/img/Unity/SurfaceShaderWithNormalMap.PNG" alt="SurfaceShaderWithNormalMap"><br><img src="/img/Unity/SurfaceShaderWithTexture.PNG" alt="SurfaceShaderWithTexture"><br><strong>接下来让我们通过计算Normal和Viedir的情况去高亮物体：</strong><br>这里需要用到build-in variable viewDir(代表观察者看顶点的方向)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        ......</span><br><span class="line">        _RimColor(<span class="string">&quot;Rim Color&quot;</span>, Color) = (<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span><br><span class="line">        _RimPower(<span class="string">&quot;Rim Power&quot;</span>, Range(<span class="number">0.5</span>, <span class="number">8.0</span>)) = <span class="number">3.0</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader &#123;</span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">struct</span> Input &#123;</span><br><span class="line">            .....</span><br><span class="line">            float3 viewDir;</span><br><span class="line">        &#125;;</span><br><span class="line">        ......</span><br><span class="line">        float4 _RimColor;</span><br><span class="line">        <span class="built_in">float</span> _RimPower;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutput o</span>)</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            half rim = <span class="number">1.0</span> - saturate(dot(normalize(IN.viewDir), o.Normal));</span><br><span class="line">            o.Emission = _RimColor.rgb * pow(rim, _RimPower);</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125; </span><br><span class="line">    FallBack <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>saturate的作用是把观察者方向和顶点法线夹角Cos值限定在[0,1]，再用1减去这个值，表明观察者方向和顶点法线夹角越小rim值越小，当夹角大于等于90度的时候达到rim最大值。从而实现高亮边缘的效果(周边和观察者角度往往比较大)。<br><img src="/img/Unity/SurfaceShaderWithEmssion.PNG" alt="SurfaceShaderWithEmssion"><br><strong>接下来我们看看通过vertex function去动态计算新vertex值的效果(这里我们根据顶点法线方向去收缩顶点postion)：</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        ......</span><br><span class="line">        _Amount(<span class="string">&quot;Extrusion Amount&quot;</span>, Range(<span class="number">-0.5</span>,<span class="number">0.5</span>)) = <span class="number">0.0</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader &#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        CGPROGRAM</span><br><span class="line">        <span class="comment">// vertex:vert定义了vert方法名</span></span><br><span class="line">        <span class="meta">#<span class="keyword">pragma</span> surface surf Lambert vertex:vert</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">float</span> _Amount;</span><br><span class="line">        <span class="comment">// vert方法定义，根据顶点法线去计算新的顶点位置</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">vert</span>(<span class="params">inout appdata_full v</span>)</span>&#123;</span><br><span class="line">            v.vertex.xyz += v.normal * _Amount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutput o</span>)</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125; </span><br><span class="line">    FallBack <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/SurfaceShaderWithNegativeExtrusion.PNG" alt="SurfaceShaderWithNegativeExtrusion"><br><img src="/img/Unity/SurfaceShaderWithPositiveExtrusion.PNG" alt="SurfaceShaderWithPositiveExtrusion"><br>在vert function里我们也可以自定义一些成员在surface shader里传递，但这样的话vert必须有两个参数，一个inout appdata_full v,一个out Input o，这里的out Input o回座位surf function的Input IN参数作为输入。<a target="_blank" rel="noopener" href="http://docs.unity3d.com/Manual/SL-SurfaceShaderExamples.html">Custom Input Member详细用法参见</a><br><strong>接下来让我们看看Light Model对于最终颜色计算的影响：</strong><br>待学习了解<br><strong>最后我们来看看Final Color Function是如何影响最终颜色计算的：</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/TonyShader&quot;</span> &#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        ......</span><br><span class="line">        _ColorTint(<span class="string">&quot;Tint&quot;</span>, Color) = (<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Tags &#123; <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Opaque&quot;</span> &#125;</span><br><span class="line">        </span><br><span class="line">        CGPROGRAM</span><br><span class="line">        <span class="comment">// finalcolor:mycolor定义final function name</span></span><br><span class="line">        <span class="meta">#<span class="keyword">pragma</span> surface surf Lambert vertex:vert finalcolor:mycolor</span></span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        fixed4 _ColorTint;</span><br><span class="line">        <span class="comment">// final color function格式， color会影响所有lightmaps,light probes等的颜色信息</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">mycolor</span>(<span class="params">Input IN, SurfaceOutput o, inout fixed4 color</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            color *= _ColorTint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span> (<span class="params">Input IN, inout SurfaceOutput o</span>)</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ENDCG</span><br><span class="line">    &#125; </span><br><span class="line">    FallBack <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/SurfaceShaderWithFinalColorFunction.PNG" alt="SurfaceShaderWithFinalColorFunction"></p>
<h2 id="Vertex-and-Fragment-Shaders"><a href="#Vertex-and-Fragment-Shaders" class="headerlink" title="Vertex and Fragment Shaders"></a>Vertex and Fragment Shaders</h2><p>见后续Shader学习</p>
<h1 id="Unity-Shader入门精要"><a href="#Unity-Shader入门精要" class="headerlink" title="Unity Shader入门精要"></a>Unity Shader入门精要</h1><h2 id="渲染管线"><a href="#渲染管线" class="headerlink" title="渲染管线"></a>渲染管线</h2><p>参考以前的学习：<br><a href="http://tonytang1990.github.io/2015/08/29/Computer-Graphic-Study/">Computer_Graphic_Study</a><br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/">OpenGL_Study</a></p>
<h2 id="Unity-Shader基础"><a href="#Unity-Shader基础" class="headerlink" title="Unity Shader基础"></a>Unity Shader基础</h2><h3 id="材质和Unity-Shader"><a href="#材质和Unity-Shader" class="headerlink" title="材质和Unity Shader"></a>材质和Unity Shader</h3><p>结合前面的学习，我们知道了在Unity里Material会决定使用那些Texture和Shader去渲染Model。</p>
<p>这里再简单梳理下他们之间的关系：</p>
<ol>
<li>Model(模型) – 最终我们需要通过渲染去实现特定效果的模型。(提供模型数据 e.g. 顶点，法线等)</li>
<li>Texture(贴图数据) – 这里没有直接说成纹理是因为Texture不仅能提供纹理数据，还能提供作为其他计算的数据(e.g. 光照方面的数据等)</li>
<li>Material(材质) – 会决定使用哪些Texture作为数据输入(e.g. 纹理数据，光照计算相关数据等)。通过指定Shader去处理Model和Texture等传入的数据进行处理。而材质面板是与Shader沟通的桥梁，允许我们通过面板暴露Shader暴露出的参数进行渲染控制。</li>
<li>Shader – 处理前面传入的Model，Texture等数据加以处理计算实现各式各样的渲染效果。</li>
</ol>
<p>Unity Shader分类：</p>
<ol>
<li>Standard Surface Shader – 前面我们提到的提供了一个包含标准光照模型计算的表面着色器。(最终还是会被编译成对应图形API接口的Vertex and Fragment Shader)</li>
<li>Unlit Shader – 不包含光照的Vertex and Fragment 。Shader,需要自己编写完整的渲染管线流程代码。</li>
<li>Image Effect Shader – 主要用于实现各种屏幕后处理效果。</li>
<li>Compute Shader – 利用GPU的并行性进行一些与常规渲染流水线无关的计算。</li>
</ol>
<p>这里我们主要学习Unlit Shader。</p>
<p>Shader对于Unity而言也是一种资源文件，所以依然有导入设置：<br><img src="/img/Unity/UnityShaderSettingPanel.PNG" alt="UnityShaderSettingPanel"><br>Note:<br>Unity Shader最终还是会被编译成对应图形编程接口(e.g. DX,OpenGL……)的Shader代码实现真正的渲染。</p>
<h3 id="ShaderLab"><a href="#ShaderLab" class="headerlink" title="ShaderLab"></a>ShaderLab</h3><p>“ShaderLab是Unity提供的编写Unity Shader的一种说明性语言。ShaderLab类似于CgFX和DX Effects语言。<br>“(引用自《Unity Shader入门精要》)</p>
<p>ShaderLab帮助我们快速定义Shader编写过程中需要资源和设置等。Unity会最终把ShaderLab编写的Shader编译成对应平台的真正代码和Shader文件，实现跨平台。</p>
<h3 id="Unity-Shader结构"><a href="#Unity-Shader结构" class="headerlink" title="Unity Shader结构"></a>Unity Shader结构</h3><p>这里我们创建一个基本的UnlitShader，结合里面的代码来学习理解(详情参考代码里的注释)：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 材质索引Shader时的路径</span></span><br><span class="line">Shader <span class="string">&quot;Custom/UnlitShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Shader暴露给材质面板的属性用于动态修改控制</span></span><br><span class="line">    <span class="comment">// Properties在Unity里相当于OPENGL Shader里定义的Uniform，Sampler，全局变量等，用于作为可控的输入</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2D代表_MyTexture,_MyNormalMap是texture类型.Color代表颜色。Range代表范围值，更多内容查官网</span></span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每一个Unity Shader至少要包含一个SubShader(Unity会使用第一个可以在目标平台运行的SubShader用于渲染，如果都不支持则会使用Fallback语义指定的Unity Shader)</span></span><br><span class="line">    <span class="comment">// SubShader定义了真正的Shader相关代码(渲染流程，渲染状态设置等)</span></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Tags是为了告诉Unity我们Shader的特定属性(比如RenderType - 渲染类型，Queue—渲染顺序)。</span></span><br><span class="line">        <span class="comment">// Note:</span></span><br><span class="line">        <span class="comment">// Tag也可以在Pass里声明，但SubShader里的Tags相当于针对所有Pass的Tag设置，优先于Tag本身的Tag设置</span></span><br><span class="line">        Tags &#123; <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Opaque&quot;</span> &#125;</span><br><span class="line">        LOD <span class="number">100</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pass代表一次完成的渲染流程</span></span><br><span class="line">        <span class="comment">// 这个好比OpenGL里实现Shadow Map效果时需要先通过First Pass生成光源点角度的Depth Texture，</span></span><br><span class="line">        <span class="comment">// 然后Second Pass通过比较摄像机角度的Depth Texture得出哪些点是Shadow的结论里的Pass一样</span></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Pass支持定义名字</span></span><br><span class="line">            <span class="comment">// Name &quot;PassName&quot;</span></span><br><span class="line">            <span class="comment">// 我们可以通过这个名字去指定使用特定Pass</span></span><br><span class="line">            <span class="comment">// UsePass &quot;ShaderName/PassName&quot;</span></span><br><span class="line">            <span class="comment">// GrabPass负责抓取屏幕并存储在一张纹理中用于后续Pass处理</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Unity Shader采用的是类似CG的Shader语言编写</span></span><br><span class="line">            <span class="comment">// Shader代码被包含在CGPROGRAM和ENDCG之间</span></span><br><span class="line">            <span class="comment">// Note:</span></span><br><span class="line">            <span class="comment">// 如果想要使用GLSL来编写需要包含在GLSLPROGRAM和ENDGLSL之间</span></span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="comment">// 真正的Shader代码从这里开始</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line">            <span class="comment">// make fog work</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> multi_compile_fog</span></span><br><span class="line">            </span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> appdata</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">                UNITY_FOG_COORDS(<span class="number">1</span>)</span><br><span class="line">                float4 vertex : SV_POSITION;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 映射Properties里暴露给Material材质面板的对象</span></span><br><span class="line">            sampler2D _MainTex;</span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Vertex Shader入口</span></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">appdata v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.vertex = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                o.uv = TRANSFORM_TEX(v.uv, _MainTex);</span><br><span class="line">                UNITY_TRANSFER_FOG(o,o.vertex);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Fragment Shader入口</span></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// sample the texture</span></span><br><span class="line">                fixed4 col = tex2D(_MainTex, i.uv);</span><br><span class="line">                <span class="comment">// apply fog</span></span><br><span class="line">                UNITY_APPLY_FOG(i.fogCoord, col);</span><br><span class="line">                <span class="keyword">return</span> col;</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在所有Pass都不被支持时，我们可以指定最终使用的Pass</span></span><br><span class="line">    <span class="comment">// Fallback &quot;PassName&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数学相关知识"><a href="#数学相关知识" class="headerlink" title="数学相关知识"></a>数学相关知识</h2><p>参考书籍:<br>《3D数学基础:图形与游戏开发》<br>《Fundamentals of Computer Graphics (3rd Edition)》 — Peter Shirley, Steve Marschnner<br>《Real-Time Rendering, Third Edition》 — Tomas Akenine-Moller, Eric Haines, Naty Hoffman</p>
<p>这里只说几点DX和OpenGL还有Unity之间需要注意的特殊点:</p>
<ol>
<li>坐标系<br>DX和Unity使用的是左手坐标系。<br>OpenGL使用的是右手坐标系。</li>
<li>行列向量<br>DX使用的是行向量(矩阵乘法是右乘)<br>OpenGL和Unity使用的是列向量(矩阵乘法是左乘)</li>
<li>正交矩阵<br>因为正交矩阵M(T)&#x3D;M(-1)<br>在提前得知是正交矩阵的前提下可以直接使用M(T)(转置矩阵)快速求的M(-1)(逆矩阵)(e.g. 旋转是正交的)<br>逆矩阵可以用于快速回复之前的矩阵变化</li>
<li>4<em>4矩阵<br>| M(3</em>3)  t(3<em>1)|<br>|  0(1</em>3)    1  |<br>M(3<em>3)代表线性变换(e.g. 旋转，缩放，错切，径向，正交投影…..)<br>t(3</em>1)代表平移变换<br>0(1*3)代表零矩阵<br>1代表标量1</li>
<li>纹理坐标<br>OpenGL中(0,0)是左下角<br>DX中(0,0)是左上角</li>
</ol>
<p>关于渲染流程里的坐标系转换相关知识参考之前的学习:<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Coordinate_Transformations_&_Perspective_Projection">Coordinate Transformations &amp; Perspective Projection</a></p>
<p>Unity Shader的内置变量参考:<br>UnityShaderVariables.cginc</p>
<h2 id="Unity-Shader学习之旅"><a href="#Unity-Shader学习之旅" class="headerlink" title="Unity Shader学习之旅"></a>Unity Shader学习之旅</h2><p>本人使用的Unity版本为5.4.0f3 Personal</p>
<h3 id="一个最简单的顶点-片元着色器"><a href="#一个最简单的顶点-片元着色器" class="headerlink" title="一个最简单的顶点&#x2F;片元着色器"></a>一个最简单的顶点&#x2F;片元着色器</h3><p>依然采用代码实战，跟之前Unity Shader结构讲的类似，但更细节一些，相关解释都写在注释里了:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/SimpleShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 定义Material材质与Shader的交流面板</span></span><br><span class="line">    Properties&#123;</span><br><span class="line">        <span class="comment">// 声明一个Color类型的属性</span></span><br><span class="line">        _Color(<span class="string">&quot;Color Tint&quot;</span>, Color) = (<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 定义一个与Material面板交流控制的对应属性</span></span><br><span class="line">            fixed4 _Color;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 自定义结构体定义vertex shader输入</span></span><br><span class="line">            <span class="keyword">struct</span> a2v &#123;</span><br><span class="line">                <span class="comment">// POSITION告诉Unity，用模型空间的顶点坐标填充vertex变量</span></span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                <span class="comment">// NORMAL告诉Unity，用模型空间的法线方向填充normal变量</span></span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">                <span class="comment">// TEXTURE0告诉Unity，用模型的第一套纹理坐标填充texcoord变量</span></span><br><span class="line">                float4 texcoord : TEXCOORD0;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 自定义结构体用于vertex shader和fragment shader之间数据传入</span></span><br><span class="line">            <span class="keyword">struct</span> v2f &#123;</span><br><span class="line">                <span class="comment">// SV_POSITION告诉Unity，pos是裁剪空间中的顶点坐标位置信息</span></span><br><span class="line">                float4 pos : SV_POSITION;</span><br><span class="line">                <span class="comment">// color存储颜色信息</span></span><br><span class="line">                fixed3 color : COLOR0;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 声明输出结构体实例</span></span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 将v.normal的顶点法线信息从[-1.0,1.0]到[0.0, 1.0]并存储在颜色信息中</span></span><br><span class="line">                o.color = v.normal * <span class="number">0.5</span> + fixed3(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// SV_Target告诉渲染器把用户的输出颜色存储到一个渲染目标中，这里默认是帧缓存中</span></span><br><span class="line">            <span class="comment">// 因为vertex shader是针对顶点运算，fragment shader是针对fragment</span></span><br><span class="line">            <span class="comment">// 所以fragment的输入是顶点数据进行插值后得到的</span></span><br><span class="line">            <span class="comment">// 顶点数据只有三角形的三个顶点，中间的fragment信息通过插值得到</span></span><br><span class="line">            <span class="comment">// i是vertex shader输出后通过插值传递过来的</span></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// v.normal映射后的颜色信息</span></span><br><span class="line">                fixed3 c = i.color;</span><br><span class="line">                <span class="comment">// 使用Material面板控制的_Color参与最终的fragment颜色运算</span></span><br><span class="line">                c *= _Color.rgb;</span><br><span class="line">                <span class="keyword">return</span> fixed4(c, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Unity内置文件和变量"><a href="#Unity内置文件和变量" class="headerlink" title="Unity内置文件和变量"></a>Unity内置文件和变量</h3><p>[Unity Shader内置文件官网下载地址](<a target="_blank" rel="noopener" href="http://unity3d.com/cn/get-unity/download/">http://unity3d.com/cn/get-unity/download/</a><br>archive)</p>
<p>内置文件包含文件：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#include &quot;**.cginc&quot;</span></span><br></pre></td></tr></table></figure>

<p>内置Shader目录结构：<br><img src="/img/Unity/UnityBuildInShaderFolderStructure.PNG" alt="UnityBuildInShaderFolderStructure"></p>
<ol>
<li>CGIncludes – 包含所有的内置包含文件</li>
<li>DefaultResources – 包含了一些内置组件或者功能需要的Unity Shader</li>
<li>DefaultResourcesExtra – 包含了所有的Unity中内置的Unity Shader</li>
<li>Editor – 只有一个脚本，定义了Unity 5引入的Standard Shader所有的材质面板</li>
</ol>
<p>常用包含文件介绍：</p>
<ol>
<li>UnityCG.cginc – 包含了常用的帮助函数，宏和结构体等</li>
<li>UnityShaderVariables.cginc – 包含了许多内置的全局变量,e.g. UNITY_MATRIX_MVP</li>
<li>Lighting.cginc – 包含了各种内置的光照模型</li>
<li>HLSLSupport.cginc – 声明了很多用于跨平台编译的宏和定义</li>
</ol>
<p>Note:<br>Unity Shader内置文件如果安装时下载安装了，也可以在Editor\Data\CGIncludes目录下找到所有内置文件</p>
<h3 id="CG-HLSL语义"><a href="#CG-HLSL语义" class="headerlink" title="CG&#x2F;HLSL语义"></a>CG&#x2F;HLSL语义</h3><p>“语义实际上就是让Shader知道从哪里读取数据，并把数据输出到哪里。”</p>
<p>“SV代表的含义是系统数据(system-value)。DX10以后引入的。大部分时候SV_POSITION和POSITION是等价的。但为了更好的跨平台最好尽量采用SV开头的语义来修饰。”</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-ShaderSemantics.html">Shader semantics官网查询</a></p>
<h3 id="Shader-Debugger"><a href="#Shader-Debugger" class="headerlink" title="Shader Debugger"></a>Shader Debugger</h3><p>欲善其事，必先利其器。<br>在学习Unity Shader之前我们需要知道如何去调试Unity Shader。</p>
<h4 id="Color-Info"><a href="#Color-Info" class="headerlink" title="Color Info"></a>Color Info</h4><p>在渲染的时候把数据信息以颜色的方式渲染到物体上，用于了解特定数据信息。</p>
<h4 id="Unity-Frame-Debugger"><a href="#Unity-Frame-Debugger" class="headerlink" title="Unity Frame Debugger"></a>Unity Frame Debugger</h4><p>Unity提供的的帧调试器，是基于Unity API层面。(Window -&gt; Frame Debug)</p>
<h4 id="VS-Graphics-Debugger"><a href="#VS-Graphics-Debugger" class="headerlink" title="VS Graphics Debugger"></a>VS Graphics Debugger</h4><p>VS提供的基于渲染API层面的调试器。<br>Unity Shader里要写#pragma enable_d3d11_debug_symbols开启DX11渲染</p>
<p>具体调试方法参考：<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-DebuggingD3D11ShadersWithVS.html">Implementing Fixed Function TexGen in Shaders Debugging DirectX 11 shaders with Visual Studio</a></p>
<p>Note:<br>Frames can only be captured if Unity is running under DirectX 11(只能基于DX11)</p>
<h3 id="NVIDIA-NSight"><a href="#NVIDIA-NSight" class="headerlink" title="NVIDIA NSight"></a>NVIDIA NSight</h3><p>NVIDIA公司提供的基于渲染API层面的调试器。<br>之前了解过，好像只支持N卡。具体没有使用过。</p>
<h2 id="Unity中的基础光照"><a href="#Unity中的基础光照" class="headerlink" title="Unity中的基础光照"></a>Unity中的基础光照</h2><h3 id="光照知识回顾"><a href="#光照知识回顾" class="headerlink" title="光照知识回顾"></a>光照知识回顾</h3><p>关于光照的基本学习参考之前OpenGL中的学习：<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Light_and_Shadow">Light and Shadow</a></p>
<p>从上面可以看出Light影响着每一个物体最终颜色的成像计算。</p>
<ol>
<li>环境光(Ambient) – 环境光与光照方向无关，只需考虑方向光的颜色和方向光所占比重，决定着物体的基本颜色。</li>
<li>漫反射(Diffuse) – 与光照的方向和顶点normal有关，决定着不同角度(顶点法线)的顶点反射能力。</li>
<li>镜面反射(Specular) – 与光照的方向和eye观察还有顶点normal有关，决定了不同观察位置的反射高光系数。</li>
</ol>
<h3 id="标准光照模型"><a href="#标准光照模型" class="headerlink" title="标准光照模型"></a>标准光照模型</h3><p>“光照模型 – 根据材质属性(如漫反射属性等)，光源信息(如光源方向，辐照度)，使用一个等式去计算沿某个方向的出射度的过程。”</p>
<p><strong>BRDF(Bidirectional Reflectance Distribution Function)光照模型</strong><br>“当给定射入光线的方向和辐射度后，BRDF可以给出在某个出射方向上的光照能量分布。”</p>
<p>那么什么是标准光照模型了？<br>“标准光照模型只关心直接光照，也就是那些直接从光源发射出来照射到物体表面后，经过物体表面的一次反射直接进入摄像机的光线。”</p>
<p>标准光照模型有四部分组成：</p>
<ol>
<li>自发光(emissive)</li>
<li>高光反射(specular)</li>
<li>漫反射(diffuse)</li>
<li>环境光(ambient)</li>
</ol>
<p>从这里可以看出之前学习OpenGL的光照计算可以算是基于标准光照模型来计算的，只是没有考虑自发光的光照运算。不难看出所谓的光照模型其实就是不同的光照计算公式。</p>
<p>在之前OpenGL的学习里，都是通过顶点法线插值后在Fragment Shader里计算Specular，Diffuse，Ambient来进行光照运算的，这种技术被称为Phong着色(Phong Shading)。(针对每一个fragment进行光照运算)</p>
<p>我们也可以针对每一个顶点进行光照运算，e.g. 高洛德着色(Gouraud shading)。针对每个顶点计算光照后，通过线性插值后最终输出显示。(因此不适合非线性的光照计算显示)</p>
<p>但上述标准光照模型(这里称为Blinn-Phong模型)无法模拟真实的物理现象的效果。<br>“Blinn-Phong模型是各项同性(isotropic)的，也就是说，当我们固定视角和光源方向旋转这个表面时，反射不会发生任何改变。各向异性(anisotropic)反射性质的效果需要机遇物理的光照模型来运算。”</p>
<h4 id="漫反射光照模型"><a href="#漫反射光照模型" class="headerlink" title="漫反射光照模型"></a>漫反射光照模型</h4><h5 id="兰伯特光照模型"><a href="#兰伯特光照模型" class="headerlink" title="兰伯特光照模型"></a>兰伯特光照模型</h5><p>c(light) – 光源颜色信息<br>m(diffuse) – 漫反射系数<br>n – 顶点法线<br>l – 光源方向</p>
<p>兰伯特光照模型:<br>c(diffuse) &#x3D; (c(light)  * m(diffuse)) * max(0, dot(n,l))</p>
<p>基于顶点的兰伯特光照模型Shader：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_World2Object&#x27; with &#x27;unity_WorldToObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 逐顶点的漫反射光照计算Shader</span></span><br><span class="line"><span class="comment">// 逐顶点是在vertex shader里针对每一个vert计算Diffuse光照然后通过顶点颜色插值显示出来</span></span><br><span class="line">Shader <span class="string">&quot;Custom/DiffuseVertexLevelShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Diffuse Light Model</span></span><br><span class="line">    <span class="comment">// c(light) -- 光源颜色信息</span></span><br><span class="line">    <span class="comment">// m(diffuse) -- 漫反射系数</span></span><br><span class="line">    <span class="comment">// n -- 顶点法线</span></span><br><span class="line">    <span class="comment">// l -- 光源方向_WorldToObject</span></span><br><span class="line">    <span class="comment">// c(diffuse) = (c(light)  * m(diffuse)) * max(0, dot(n, l))</span></span><br><span class="line"></span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露漫反射系数c(diffuse)用于动态控制漫反射系数</span></span><br><span class="line">        _Diffuse(<span class="string">&quot;Diffuse&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags &#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为是计算基于Vertex Level的漫反射光照模型计算</span></span><br><span class="line">            <span class="comment">// 所以在vertex shader里已经完成了对光照color的运算</span></span><br><span class="line">            <span class="comment">// 这里只需将结果通过插值传递给fragment shader即可</span></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;</span><br><span class="line">                float3 color : COLOR;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的漫反射系数</span></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 计算漫反射光</span></span><br><span class="line">                <span class="comment">// 为了确保法线从物体坐标系转换到世界坐标系正确，这里需要乘以object2world矩阵的逆矩阵的转置矩阵</span></span><br><span class="line">                <span class="comment">// _World2Object代表object2world的逆矩阵</span></span><br><span class="line">                <span class="comment">// 因为unity使用的是列向量，所以通过mul()_World2Object作为第二个参数相当于左乘_World2Object的转置矩阵</span></span><br><span class="line">                <span class="comment">// 之所以只乘以3x3的矩阵是因为平移变换不会影响法线方向</span></span><br><span class="line">                fixed3 worldnormal = normalize(mul(v.normal, (float3x3)unity_WorldToObject));</span><br><span class="line">                <span class="comment">// 假设只有一个全局direction light</span></span><br><span class="line">                fixed3 worldlightdir = normalize(_WorldSpaceLightPos0.xyz);</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(dot(worldnormal, worldlightdir));</span><br><span class="line">                o.color = ambient + diffuse;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将vertex shader计算出的环境光加漫反射颜色显示出来</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(i.color, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于片元计算的兰伯特光照模型Shader：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_World2Object&#x27; with &#x27;unity_WorldToObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 逐片元的漫反射光照计算Shader</span></span><br><span class="line"><span class="comment">// 逐片元是在fragment shader里针对每一个fragment计算Diffuse光照</span></span><br><span class="line">Shader <span class="string">&quot;Custom/DiffuseFragLevelShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Diffuse Light Model</span></span><br><span class="line">    <span class="comment">// c(light) -- 光源颜色信息</span></span><br><span class="line">    <span class="comment">// m(diffuse) -- 漫反射系数</span></span><br><span class="line">    <span class="comment">// n -- 顶点法线</span></span><br><span class="line">    <span class="comment">// l -- 光源方向</span></span><br><span class="line">    <span class="comment">// c(diffuse) = (c(light)  * m(diffuse)) * max(0, dot(n, l))</span></span><br><span class="line"></span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露漫反射系数c(diffuse)用于动态控制漫反射系数</span></span><br><span class="line">        _Diffuse(<span class="string">&quot;Diffuse&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为是计算基于Fragment Level的漫反射光照模型计算</span></span><br><span class="line">            <span class="comment">// 所以在vertex shader需要把world space的normal传给fragment shader进行diffuse光照运算</span></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;</span><br><span class="line">                float3 worldNormal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的漫反射系数</span></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 计算漫反射光</span></span><br><span class="line">                <span class="comment">// 为了确保法线从物体坐标系转换到世界坐标系正确，这里需要乘以object2world矩阵的逆矩阵的转置矩阵</span></span><br><span class="line">                <span class="comment">// _World2Object代表object2world的逆矩阵</span></span><br><span class="line">                <span class="comment">// 因为unity使用的是列向量，所以通过mul()_World2Object作为第二个参数相当于左乘_World2Object的转置矩阵</span></span><br><span class="line">                <span class="comment">// 之所以只乘以3x3的矩阵是因为平移变换不会影响法线方向</span></span><br><span class="line">                o.worldNormal = normalize(mul(v.normal, (float3x3)unity_WorldToObject));                            </span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 假设只有一个全局direction light</span></span><br><span class="line">                fixed3 worldlightdir = normalize(_WorldSpaceLightPos0.xyz);</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(dot(i.worldNormal, worldlightdir));</span><br><span class="line">                fixed3 color = ambient + diffuse;</span><br><span class="line">                <span class="comment">// 将计算出的环境光加漫反射颜色显示出来</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(color, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题:<br>背光区域没有明暗变化看起来像一个平面。</p>
<h5 id="半兰伯特-Half-Lambert-光照模型"><a href="#半兰伯特-Half-Lambert-光照模型" class="headerlink" title="半兰伯特(Half Lambert)光照模型"></a>半兰伯特(Half Lambert)光照模型</h5><p>c(light) – 光源颜色信息<br>m(diffuse) – 漫反射系数<br>n – 顶点法线<br>l – 光源方向<br>a – a倍漫反射辐射度<br>b – 漫反射辐射度偏移量</p>
<p>半兰伯特光照模型:<br>c(diffuse) &#x3D; c(light)  * m(diffuse) * (a * dot(n,l) + b)</p>
<p>基于片元的半拉伯特特光照模型：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_World2Object&#x27; with &#x27;unity_WorldToObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 逐片元的半兰伯特光照模型没有对漫反射辐射度负值做max处理，</span></span><br><span class="line"><span class="comment">// 而是通过a倍缩放加上b偏移量得出最终的漫反射辐射度，</span></span><br><span class="line"><span class="comment">// 这样一来背面漫反射辐射度也会被映射到不同的值而非0，从而拥有不同的漫反射效果。</span></span><br><span class="line">Shader <span class="string">&quot;Custom/HalfLambertShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Half Labert Model</span></span><br><span class="line">    <span class="comment">// c(light) -- 光源颜色信息</span></span><br><span class="line">    <span class="comment">// m(diffuse) -- 漫反射系数</span></span><br><span class="line">    <span class="comment">// n -- 顶点法线</span></span><br><span class="line">    <span class="comment">// l -- 光源方向</span></span><br><span class="line">    <span class="comment">// a -- a倍漫反射辐射度</span></span><br><span class="line">    <span class="comment">// b -- 漫反射辐射度偏移量</span></span><br><span class="line">    <span class="comment">// 半兰伯特光照模型 :</span></span><br><span class="line">    <span class="comment">// c(diffuse) = c(light)  * m(diffuse) * (a * dot(n, l) + b)</span></span><br><span class="line">        </span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露漫反射系数c(diffuse)用于动态控制漫反射系数</span></span><br><span class="line">        _Diffuse(<span class="string">&quot;Diffuse&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为是计算基于Fragment Level的漫反射光照模型计算</span></span><br><span class="line">            <span class="comment">// 所以在vertex shader需要把world space的normal传给fragment shader进行diffuse光照运算</span></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;</span><br><span class="line">                float3 worldNormal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的漫反射系数</span></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 计算漫反射光</span></span><br><span class="line">                <span class="comment">// 为了确保法线从物体坐标系转换到世界坐标系正确，这里需要乘以object2world矩阵的逆矩阵的转置矩阵</span></span><br><span class="line">                <span class="comment">// _World2Object代表object2world的逆矩阵</span></span><br><span class="line">                <span class="comment">// 因为unity使用的是列向量，所以通过mul()_World2Object作为第二个参数相当于左乘_World2Object的转置矩阵</span></span><br><span class="line">                <span class="comment">// 之所以只乘以3x3的矩阵是因为平移变换不会影响法线方向</span></span><br><span class="line">                o.worldNormal = normalize(mul(v.normal, (float3x3)unity_WorldToObject));</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 假设只有一个全局direction light</span></span><br><span class="line">                fixed3 worldlightdir = normalize(_WorldSpaceLightPos0.xyz);</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// (dot(i.worldNormal, worldlight) * 0.5 + 0.5)将漫反射辐射度映射到[0,1]，背面不再全是0</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * (dot(i.worldNormal, worldlightdir) * <span class="number">0.5</span> + <span class="number">0.5</span>);</span><br><span class="line">                fixed3 color = ambient + diffuse;</span><br><span class="line">                <span class="comment">// 将计算出的环境光加漫反射颜色显示出来</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(color, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:<br>半兰伯特光照模型没有对漫反射辐射度负值做max处理，而是通过a倍缩放加上b偏移量得出最终的漫反射辐射度，这样一来背面漫反射辐射度也会被映射到不同的值，从而拥有不同的漫反射效果。</p>
<h4 id="高光反射光照模型"><a href="#高光反射光照模型" class="headerlink" title="高光反射光照模型"></a>高光反射光照模型</h4><p>c(light) – 光源颜色信息<br>m(specular) – 材质高光反射系数<br>v – 视角方向<br>r – 反射方向<br>n – 顶点法线<br>l – 光源方向<br>m(gloss) – 发光系数</p>
<p>r可以通过n和l计算出来：<br>r &#x3D; 2 * dot(-n,l) * n + l<br>跟OpenGL一样，Unity提供了直接计算反射光线方向的API:reflect(i,n)</p>
<p>c(specular) &#x3D; (c(light) * m(specular)) * pow(max(0,dot(v,r)), m(gloss))<br>上面这个公式和之前在OpenGL之前学习的高光反射并没有太多出入，<a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Light_and_Shadow">详情参考</a></p>
<p>这里主要要区分Phong光照模型和Blinn-Phong光照模型：</p>
<ol>
<li>Phong光照模型<br>c(specular) &#x3D; (c(light) * m(specular)) * pow(max(0,dot(v,r)), m(gloss))<br>dot(v,r) – 是指观察者所在位置和完美反射光线之间夹角</li>
<li>Blinn-Phong光照模型<br>h &#x3D; (v + l) &#x2F; |v + l|<br>c(specular) &#x3D; (c(light) * m(specular)) * pow(max(0,dot(n,h)), m(gloss))<br>dot(n,h) – 是指将v和l向量归一化后的向量与n之间的夹角</li>
</ol>
<p>可以看出来两者在计算高光反射的发光基准系数时采用了不同的运算方式。虽然两者都是经验模型，但后者是对于前者的一种改进方式。</p>
<p>跟漫反射一样，高光反射的计算依然有基于顶点和基于片元之分。<br>基于片元的Phhong高光反射光照模型代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_World2Object&#x27; with &#x27;unity_WorldToObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 逐顶点的环境光+漫反射+Phong高光反射光照计算Shader</span></span><br><span class="line">Shader <span class="string">&quot;Custom/LightModel/PhongSpecularFragLevelShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Specular Light Model</span></span><br><span class="line">    <span class="comment">// c(light) -- 光源颜色信息</span></span><br><span class="line">    <span class="comment">// m(specular) -- 材质高光反射系数</span></span><br><span class="line">    <span class="comment">// v -- 视角方向</span></span><br><span class="line">    <span class="comment">// r -- 光线反射方向</span></span><br><span class="line">    <span class="comment">// n -- 顶点法线</span></span><br><span class="line">    <span class="comment">// l -- 光源方向</span></span><br><span class="line">    <span class="comment">// m(gloss) -- 发光系数</span></span><br><span class="line">    <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(v,r)), m(gloss))</span></span><br><span class="line"></span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露漫反射系数c(diffuse)用于动态控制漫反射系数</span></span><br><span class="line">        _Diffuse(<span class="string">&quot;Diffuse&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;           <span class="comment">// 投影坐标系的顶点位置</span></span><br><span class="line">                float3 worldNormal : NORMAL;        <span class="comment">// 世界坐标系的法线</span></span><br><span class="line">                float3 worldPos : TEXCOORD0;        <span class="comment">// 世界坐标系的顶点位置</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的漫反射系数</span></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 计算漫反射光</span></span><br><span class="line">                <span class="comment">// 为了确保法线从物体坐标系转换到世界坐标系正确，这里需要乘以object2world矩阵的逆矩阵的转置矩阵</span></span><br><span class="line">                <span class="comment">// _World2Object代表object2world的逆矩阵</span></span><br><span class="line">                <span class="comment">// 因为unity使用的是列向量，所以通过mul()_World2Object作为第二个参数相当于左乘_World2Object的转置矩阵</span></span><br><span class="line">                <span class="comment">// 之所以只乘以3x3的矩阵是因为平移变换不会影响法线方向</span></span><br><span class="line">                o.worldNormal = normalize(mul(v.normal, (float3x3)unity_WorldToObject));</span><br><span class="line"></span><br><span class="line">                o.worldPos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 假设只有一个全局direction light</span></span><br><span class="line">                fixed3 worldlightdir = normalize(_WorldSpaceLightPos0.xyz);</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(dot(i.worldNormal, worldlightdir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 光线反射方向</span></span><br><span class="line">                fixed3 reflectdir = normalize(reflect(-worldlightdir, i.worldNormal));</span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(_WorldSpaceCameraPos.xyz - i.worldPos.xyz);</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(v,r)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(reflectdir, viewdir)), _Gloss);</span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                fixed3 color = ambient + diffuse + specular;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将计算出的环境光+漫反射+Phong高光反射颜色显示出来</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(color, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于片元的Blinn-Phhong高光反射光照模型代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_World2Object&#x27; with &#x27;unity_WorldToObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 逐顶点的环境光+漫反射+BlinnPhong高光反射光照计算Shader</span></span><br><span class="line">Shader <span class="string">&quot;Custom/LightModel/BlinnPhongSpecularFragLevelShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Specular Light Model</span></span><br><span class="line">    <span class="comment">// c(light) -- 光源颜色信息</span></span><br><span class="line">    <span class="comment">// m(specular) -- 材质高光反射系数</span></span><br><span class="line">    <span class="comment">// v -- 视角方向</span></span><br><span class="line">    <span class="comment">// r -- 光线反射方向</span></span><br><span class="line">    <span class="comment">// n -- 顶点法线</span></span><br><span class="line">    <span class="comment">// l -- 光源方向</span></span><br><span class="line">    <span class="comment">// m(gloss) -- 发光系数</span></span><br><span class="line">    <span class="comment">// h = (v + l) / |v + l|</span></span><br><span class="line">    <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line"></span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露漫反射系数c(diffuse)用于动态控制漫反射系数</span></span><br><span class="line">        _Diffuse(<span class="string">&quot;Diffuse&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;           <span class="comment">// 投影坐标系的顶点位置</span></span><br><span class="line">                float3 worldNormal : NORMAL;        <span class="comment">// 世界坐标系的法线</span></span><br><span class="line">                float3 worldPos : TEXCOORD0;        <span class="comment">// 世界坐标系的顶点位置</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的漫反射系数</span></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                <span class="comment">// 计算漫反射光</span></span><br><span class="line">                <span class="comment">// 为了确保法线从物体坐标系转换到世界坐标系正确，这里需要乘以object2world矩阵的逆矩阵的转置矩阵</span></span><br><span class="line">                <span class="comment">// _World2Object代表object2world的逆矩阵</span></span><br><span class="line">                <span class="comment">// 因为unity使用的是列向量，所以通过mul()_World2Object作为第二个参数相当于左乘_World2Object的转置矩阵</span></span><br><span class="line">                <span class="comment">// 之所以只乘以3x3的矩阵是因为平移变换不会影响法线方向</span></span><br><span class="line">                o.worldNormal = normalize(mul(v.normal, (float3x3)unity_WorldToObject));</span><br><span class="line"></span><br><span class="line">                o.worldPos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 假设只有一个全局direction light</span></span><br><span class="line">                fixed3 worldlightdir = normalize(_WorldSpaceLightPos0.xyz);</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(dot(i.worldNormal, worldlightdir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(_WorldSpaceCameraPos.xyz - i.worldPos.xyz);</span><br><span class="line">                <span class="comment">// h = (v + l) / |v + l| v和l向量归一化后的向量</span></span><br><span class="line">                fixed3 halfdir = normalize(worldlightdir + viewdir);</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(i.worldNormal, halfdir)), _Gloss);</span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                fixed3 color = ambient + diffuse + specular;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将计算出的环境光+漫反射+BlinnPhong高光反射颜色显示出来</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(color, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Diffuse&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果图：<br><img src="/img/Unity/LightModelShader.JPG" alt="LightModelShader"></p>
<p>Note:<br>“如果没有全局光照技术，这些自发光的表面并不会真的着凉周围的物体，而是它本身看起来更亮了而已。”<br><strong>计算机图形学的第一定律：如果它看起来是对的，那么它就是对的。</strong></p>
<p>上面的运算都是我们通过基础的向量，矩阵运算来实现。在Unity中我们可以使用Unity内置的函数来帮助我们快速的计算得到指定结果。详情查看UnityCG.cginc。</p>
<p>Note:<br>“如果没有全局光照技术，这些自发光的表面并不会真的着凉周围的物体，而是它本身看起来更亮了而已。”<br><strong>计算机图形学的第一定律：如果它看起来是对的，那么它就是对的。</strong></p>
<h3 id="Lighting-in-Unity"><a href="#Lighting-in-Unity" class="headerlink" title="Lighting in Unity"></a>Lighting in Unity</h3><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/introduction-lighting-and-rendering?playlist=17102">Global illumination, or ‘GI’, is a term used to describe a range of techniques and mathematical models which attempt to simulate the complex behaviour of light as it bounces and interacts with the world.</a>(GI代表通过技术或者数学模型模拟光照运算交互。e.g. 半兰伯特(Half Lambert)光照模型</p>
<p>Light在Unity主要分为Realtime(相当于Forward Rendering)和Precomputed(预先生成相关光照贴图数据参与光照计算)</p>
<h4 id="Realtime-Lighting"><a href="#Realtime-Lighting" class="headerlink" title="Realtime Lighting"></a>Realtime Lighting</h4><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-lighting-technique?playlist=17102">directional, spot and point, are realtime. This means that they contribute direct light to the scene and update every frame.</a>(实时的顾名思义实时计算光照)</p>
<p>有了实时光照计算为什么还需要Precomputed了？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-lighting-technique?playlist=17102">Unfortunately, the light rays from Unity’s realtime lights do not bounce when they are used by themselves. In order to create more realistic scenes using techniques such as global illumination we need to enable Unity’s precomputed lighting solutions.</a>(从官方原文来看，实时光照并没有计算光照被其他物体反弹之后的运算量，要想更加真实的光照所以需要Precomputed Lighting)</p>
<h4 id="Precomputed-Lighting"><a href="#Precomputed-Lighting" class="headerlink" title="Precomputed Lighting"></a>Precomputed Lighting</h4><p>Static Lightmap(Baked GI Lighting):<br>Lightmap – <a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-lighting-technique?playlist=17102">When ‘baking’ a ‘lightmap’, the effects of light on static objects in the scene are calculated and the results are written to textures which are overlaid on top of scene geometry to create the effect of lighting.</a>(Bake GI Light会生成一张LightMap，这张Lightmap记录了场景里所有静态物体的光照运算结果。)</p>
<p>Note：<br>静态Lightmap一旦生成就不能再被运行时修改，实现不了场景里光照动态变化的效果</p>
<p>Realtime Lightmap(Baked Realtime GI Lighting):<br>Realtime GI Lightmap弥补了Static Lightmap的不足，可以实现预先计算所有实时光照(这里的实时光照是指全局光照(含间接光照的影响计算)))需要的数据去参与运行时全局光照计算。</p>
<p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-lighting-technique?playlist=17102">To speed up the precompute further Unity doesn’t directly work on lightmaps texels, but instead creates a low resolution approximation of the static geometry in the world, called ‘clusters’.</a>(Unity为了加快Precompute速度，Lightmap的运算并不是texels级而是clusters级，可以理解成相对粗糙一点的精确度)</p>
<p>具体使用哪种光照策略取决于用户实际情况(显存，内存，GPU，CPU等)。</p>
<p>Baked Light Rules:</p>
<ol>
<li>Only Static GameObject才会参与Baked Lighting。</li>
<li>Light Bake Mode取决于光照的Bake设置。</li>
<li>Mixed的Bake Mode即会参与Bake也会参与Realtime。</li>
<li>具体Bake设置见Window -&gt; Lighting(设置Bake Static Lightmap还是Realtime)</li>
</ol>
<p>Note:<br>Precomputed Lighting是个典型空间换时间的例子。通过预算生成大量的光照信息Lightmap来避免大量的实时光照运算。</p>
<p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-lighting-technique?playlist=17102">Using both Baked GI and Precomputed Realtime GI together in your scene can be detrimental to performance. A good practise is to ensure that only one system is used at a time, by disabling the other globally. </a>(官方建议，Baked GI和Precomputed Realtime GI两者选其一不建议同时使用，避免性能问题)</p>
<h5 id="Bake-Realtime-Lighting实战"><a href="#Bake-Realtime-Lighting实战" class="headerlink" title="Bake Realtime Lighting实战"></a>Bake Realtime Lighting实战</h5><ol>
<li>Realtime Resolution<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/realtime-resolution?playlist=17102">Realtime Resolution is the number of realtime lightmap texels (texture pixels) used per world unit.</a>(一个world unit使用多少个纹理贴图的像素)</li>
</ol>
<p>这个参数会影响最终Bake出来的光照采样计算结果，同时也会影响Precompute的时间消耗。合适的值取决于场景对于光照采样精度的需求与Bake时间之间的平衡。如果场景小(比如室内)且光源很多那么精度高一点Bake时间长一点是有意义的。如果场景大(比如室外)光源变化不大，那么精度高对最终的采样光照计算结果并没有太大影响只会增加Bake时间，那这样是不值得的。</p>
<ol start="2">
<li>Chart(光照图)<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/understanding-charts?playlist=17102">a Chart is an area of a lightmap texture to which we map the lightmap UVs of a given Scene object. We can think of this as a small tile containing an image of the lighting affecting that object.</a>(Chart表示一个光照贴图，用于映射特定Object的Lightmap UV的信息)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/understanding-charts?playlist=17102">A Chart is made up of two parts: irradiance (lighting) and directionality (encoding the dominant light direction).</a>(Chart由两部分组成:辐射度和光照方向)</p>
<p><img src="/img/Unity/LightmapChart.PNG" alt="LightmapChart"></p>
<p>Note:<br>Unity Unit设置的不同对于Realtime Resolution的选择也会有影响。</p>
<p>Baked GI是生成一张Lightmap Texture用于运行时参与光照计算。Baked Realtime Lighting是将信息存到Lighting Data Asset(包含了运行时生成低分辨率lightmap的相关信息)里用于运行时生成低解析度的光照图。</p>
<p>Chart is a minimum of 4x4 texels(Chart最小是4*4像素)。</p>
<p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/unwrapping-and-chart-reduction?playlist=17102">Charts are created to encompass the UV lightmap coordinates of a Static Mesh Renderer. The number of Charts that an object requires is therefore largely determined by the number of UV shells (pieces) needed to unwrap the object in question.</a>(光照图(Charts)的目的主要是用来包住静态网格着色器(Static Mesh Renderer)的UV贴图坐标。一个物件所需要的光照图数量主要是看物体有多少片UI Shell需要拆解。)</p>
<p>降低Chart的数量是减少Precompute Time的关键因素之一。<br>除了选择合适的Realtime Resolution，还有什么方式可以帮助我们降低Chart数量了？</p>
<ol>
<li>降低Static物体的UV Shells(相当于减少特定物体所需的Lightmap Chart)</li>
<li>减少Static物体(用Lighting Probe实现)</li>
<li>减少Clusters数量(PRGI基础运算单元)</li>
</ol>
<p>在减少UV Shells数量之前，先了解下背后的原理，以及相关帮助和查看窗口：<br>官方的UV Shells拆分示例：<br><img src="/img/Unity/MultipleUVShells.PNG" alt="MultipleUVShells"></p>
<p><img src="/img/Unity/SingleUIShell.PNG" alt="SingleUIShell"></p>
<p>查看LightmapChart:<br>Scene -&gt; Draw Mode -&gt; GI -&gt; UV Chart<br><img src="/img/Unity/UVChart.PNG" alt="UVChart"></p>
<p>查看特定物件的UV Chart:</p>
<ol>
<li>选中要查看的物体</li>
<li>Window -&gt; Lighting -&gt; Obejct</li>
<li>左上角选择Chart模式</li>
</ol>
<p><img src="/img/Unity/SpecificObjectUVChart.PNG" alt="SpecificObjectUVChart"><br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-6.html">Charting模式的预览视窗会用不同的颜色的格子表示光照图，并用浅蓝色的线表示UV贴图。</a></p>
<p>更多关于UV Chart生成相关的因素，参考:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/unwrapping-and-chart-reduction?playlist=17102">Unwrapping and Chart reduction</a></p>
<p>这里简单提一下:<br>Mesh Renderer上面的:</p>
<ol>
<li>Auto UV Max Distance(自動最大UV距離)</li>
<li>Auto UV Max Angle(自動最大UV角度)</li>
<li>Preserve UVs(保留UV)</li>
<li>Ignore Normals(忽略法線)</li>
</ol>
<p>开启Auto Lighting，然后调节相关数值通过UV Chart Preview帮助我们快速查看UV Chart实时效果。</p>
<p>如何通过UV Chats判定失真程度？<br><img src="/img/Unity/UVChartDistortionAnalysi.PNG" alt="UVChartDistortionAnalysi"><br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-6.html">当启用UI Charts绘制模式时，失真的程度能从场景里的棋盘圆拉扯状况来评估。</a></p>
<p>如何正确使用Probe Lighting减少Static物体参与PRGI？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/probe-lighting?playlist=17102">Probe lighting is a fast technique for approximating lighting in realtime rendering applications such as games.</a>(光照探测技术是一个能在游戏里让即时光照更逼真的快速演算法)</p>
<p>原理：<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/probe-lighting?playlist=17102">Probe lighting works by sampling the incoming lighting at a specific point in 3D space and encoding this information across a sphere using mathematical functions known as spherical harmonics. These coefficients have low storage cost and can be then be quickly ‘unpacked’ at gameplay and used by shaders within the Scene to approximate surface lighting.</a>(光照探测的原理是透过放在3D空间里的探针来接受照明信息，然后用像球鞋函数(spherical harmonics)的数学算法将结果编码在一个球体上，这些信息暂用空间很小，但在游戏运行时解包很快，并参与表面光照计算)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-5.html">我們的目的是取样场景里的间接或反射光照。为了让每个光照探头效能花在刀口上， 尽量确保他们对一些变化明显的地方进行采样</a></p>
<p>如何减少Cluster数量？<br>让我们先通过查看贴图了解下Cluster真实情况：<br><img src="/img/Unity/ClusterPicture.PNG" alt="ClusterPicture"></p>
<p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/understanding-clusters?playlist=17102">Clusters sample the albedo of the Static geometry to which they are mapped. Then, during the Light Transport stage of the precompute, the relationship between these Clusters is calculated so that light can be propagated throughout the Cluster network.</a><br>(Cluster会对静态物体表面的反射率(Albedo)进行采样，在光照传递计算阶段计算Cluster之间的关系好让光在整个Cluster网之间传递)</p>
<p><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-7.html">一旦与计算完成后，你就可以修改Skybox或光线的位置，强度和颜色，不需要重新与计算，光线就会透过这些Cluster网信息，联通场景材质和发光材质一并考虑计算光照反射。</a></p>
<p><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-7.html">Clustering或Lit Clustering Scene Mode模式来观察Cluster分布</a></p>
<p>了解了Cluster相关知识概念后，那么如何真正降低Cluster数量了？<br>Lightmap Parameters控制，用于公用。<br>Asset &gt; Create &gt; Lightmap Parameters<br>通过GameObejct -&gt; Mesh Renderer -&gt; Lightmao Parameters指定<br><img src="/img/Unity/LightMapParameter.PNG" alt="LightMapParameter"></p>
<p>具体参数详细学习参考:<br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unitygi-8.html">Unity預計算即時GI - 8.微調光照參數</a></p>
<p>PRGI实战：</p>
<ol>
<li>设置需要Bake的物体为Static(规划好层级可快速批量设置Static)</li>
<li>Window -&gt; Lighting -&gt; Build(勾选Auto，自动触发Precompute)</li>
<li>减少Lightmap Chart数量(部分物体(比如凸起的小物件)用Lighting Probe技术而非Static)</li>
<li>管理Lighting Probe(创建GameObject &gt; Light &gt; Light Probe Group)</li>
<li>放置Lighting Probe(GameObject &gt; Light &gt; Light Probe Group -&gt; Edit Light Probes)</li>
</ol>
<p>Baked Lighting AssetBundle实战：<br>目标：</p>
<ol>
<li>Baked Lighting，通过打包AB的形式加载还原Baked Lighting</li>
<li>支持Reflection Probe的AB加载还原(这个只是单纯加载了依赖的Cubemap没有做任何的还原操作，暂时表现是对的，具体待学习了解)</li>
</ol>
<p>实战：</p>
<ol>
<li>新建一个场景，添加必要的物件与光照</li>
<li>设置需要Bake的物体为Static</li>
<li>减少Lightmap Chart数量(部分物体(比如凸起的小物件)用Lighting Probe技术而非Static)</li>
<li>设置所有需要参与Bake的光照为Baked模式(只用于Baked Lighting)</li>
<li>Window -&gt; Lighting -&gt; Build(勾选Auto，自动触发Precompute Lightmap)</li>
<li>删除所有完成静态烘焙的Light</li>
<li>记录场景里所使用的光照信息(LightmapSettings.lightmaps)以及所有参与了静态光照的静态物体所使用的光照图信息(Renderer.lightmapIndex和Renderer.lightmapScaleOffset)</li>
<li>运行时加载所有依赖的光照贴图信息，并还原所有静态物体使用的光照贴图信息</li>
</ol>
<p>烘焙之后的场景光照使用信息:<br><img src="/img/Unity/LightmapBake.PNG" alt="LightmapBake"></p>
<p>烘焙之后记录下场景使用的光照信息运行时还原:</p>
<p>打包场景AB以及光照信息记录代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sceneasset = AssetDatabase.LoadAssetAtPath&lt;Object&gt;(abfullpath);</span><br><span class="line">AssetImporter assetimporter = AssetImporter.GetAtPath(abfullpath);</span><br><span class="line"><span class="keyword">var</span> abname = ABPackageHelper.Singleton.getABTypeCorrespondingName(EABType.E_AB_SCENE, sceneasset.name);</span><br><span class="line">assetimporter.assetBundleName = abname;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录Lightmap相关信息，加载场景时用于还原Lightmap</span></span><br><span class="line"><span class="keyword">var</span> scenename = Path.GetFileNameWithoutExtension(abfullpath);</span><br><span class="line"></span><br><span class="line"><span class="comment">//打开需要打包的场景</span></span><br><span class="line"><span class="keyword">var</span> scene = EditorSceneManager.OpenScene(abfullpath);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> scenego = GameObject.Find(scenename);</span><br><span class="line"><span class="keyword">var</span> lmr = scenego.GetComponent&lt;LightMapRestore&gt;();</span><br><span class="line"><span class="keyword">if</span> (lmr != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    GameObject.DestroyImmediate(lmr);</span><br><span class="line">&#125;</span><br><span class="line">lmr = scenego.AddComponent&lt;LightMapRestore&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录Lightmap使用信息</span></span><br><span class="line">Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;LightmapSettings.lightmaps.Length = &#123;0&#125;&quot;</span>, LightmapSettings.lightmaps.Length));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试目的，暂时只默认只有一个Lightmap</span></span><br><span class="line">lmr.LightMapColor = LightmapSettings.lightmaps[<span class="number">0</span>].lightmapColor == <span class="literal">null</span> ? <span class="built_in">string</span>.Empty : LightmapSettings.lightmaps[<span class="number">0</span>].lightmapColor.name;</span><br><span class="line">lmr.LightMapDir = LightmapSettings.lightmaps[<span class="number">0</span>].lightmapDir == <span class="literal">null</span> ? <span class="built_in">string</span>.Empty : LightmapSettings.lightmaps[<span class="number">0</span>].lightmapDir.name;</span><br><span class="line">lmr.LightMapDataList = <span class="keyword">new</span> List&lt;LightMapData&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印所有烘焙对象的Lightmap相关信息(测试查看)</span></span><br><span class="line"><span class="keyword">var</span> allrootgos = scene.GetRootGameObjects();</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> m = <span class="number">0</span>; m &lt; allrootgos.Length; m++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> allmeshcom = allrootgos[m].transform.GetComponentsInChildren&lt;Renderer&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> n = <span class="number">0</span>; n &lt; allmeshcom.Length; n++)</span><br><span class="line">    &#123;</span><br><span class="line">        LightMapData lmd = <span class="keyword">new</span> LightMapData();</span><br><span class="line">        lmd.RendererObject = allmeshcom[n];</span><br><span class="line">        lmd.LightMapIndex = allmeshcom[n].lightmapIndex;</span><br><span class="line">        lmd.LightMapScaleOffset = allmeshcom[n].lightmapScaleOffset;</span><br><span class="line">        lmr.LightMapDataList.Add(lmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存场景</span></span><br><span class="line">EditorSceneManager.SaveScene(scene);</span><br><span class="line"></span><br><span class="line">AssetDatabase.Refresh();</span><br></pre></td></tr></table></figure>

<p>还原代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line">[<span class="meta">System.Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LightMapData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Renderer RendererObject;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> LightMapIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector4 LightMapScaleOffset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 静态光照烘焙还原</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LightMapRestore</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LightMapColor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LightMapDir;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;LightMapData&gt; LightMapDataList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 还原各静态烘焙物体的lightmap信息</span></span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> lmd <span class="keyword">in</span> LightMapDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;还原&#123;0&#125;Lightmap信息:LightMapIndex:&#123;1&#125; LightMapScaleOffset:&#123;2&#125;&quot;</span>, lmd.RendererObject.name, lmd.LightMapIndex, lmd.LightMapScaleOffset));</span><br><span class="line">            lmd.RendererObject.lightmapIndex = lmd.LightMapIndex;</span><br><span class="line">            lmd.RendererObject.lightmapScaleOffset = lmd.LightMapScaleOffset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>光照信息记录:<br><img src="/img/Unity/LightMapData.PNG" alt="LightMapData"></p>
<p>加载还原后的效果:<br><img src="/img/Unity/LightMapRestore.PNG" alt="LightMapRestore"></p>
<p>那如何Bake多份Lightmap进行动态切换了？<br>Unity 5.X如果想Bake多份Lightmap，需要复制保留之前Bake出的Texture，然后通过修改LightmapSetting的值即可(因为是同一个场景，静态物体的lightmapIndex和lightmapScaleOffset值都没变，所以直接切换LightmapSetting里的lightmaps即可)。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lightmaptex = TextureResourceLoader.getInstance().loadTexture(newlightmapname);</span><br><span class="line"><span class="keyword">var</span> newlightmapdata = <span class="keyword">new</span> LightmapData();</span><br><span class="line">newlightmapdata.lightmapColor = lightmaptex;</span><br><span class="line">LightmapSettings.lightmaps = <span class="keyword">new</span> LightmapData[] &#123; newlightmapdata &#125;;</span><br></pre></td></tr></table></figure>

<p>参考文章：<br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unity-gi-1.html">Introduction to Precomputed Realtime GI</a><br><a target="_blank" rel="noopener" href="http://unitytaiwan.blogspot.co.uk/2016/12/unity-gi-1.html">Unity預計算即時GI</a></p>
<h4 id="Render-Path"><a href="#Render-Path" class="headerlink" title="Render Path"></a>Render Path</h4><p>Forward Rendering<br>实时光照运算，计算量跟灯光数量成正比</p>
<p>Deffered Rendering<br>实时光照运算，计算量跟Pixels数量成正比而非光照</p>
<p>Edit -&gt; Project Setting -&gt; Player -&gt; Rendering -&gt; Rendering Path</p>
<h4 id="Color-Space"><a href="#Color-Space" class="headerlink" title="Color Space"></a>Color Space</h4><p>Linear Color Space<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-color-space?playlist=17102">A significant advantage of using Linear space is that the colors supplied to shaders within your scene will brighten linearly as light intensities increase.</a></p>
<p>Gamma Color Space<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/choosing-color-space?playlist=17102">Gamma’ Color Space, brightness will quickly begin to turn to white as values go up, which is detrimental to image quality.</a></p>
<p>Edit -&gt; Project Setting -&gt; Player -&gt; Rendering -&gt; Color Space</p>
<h3 id="High-Dynamic-Range"><a href="#High-Dynamic-Range" class="headerlink" title="High Dynamic Range"></a>High Dynamic Range</h3><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/high-dynamic-range-hdr?playlist=17102">HDR(High Dynamic Range) defines how extremely bright or dark colors are captured by scene cameras.</a>(HDR决定光照颜色信息精度)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/graphics/high-dynamic-range-hdr?playlist=17102"> HDR is unsupported by some mobile hardware. It is also not supported in Forward Rendering when using techniques such as multi-sample anti-aliasing (MSAA).</a>(Forward Rendering使用MSAA时不支持HDR)</p>
<p>待续</p>
<h2 id="基础纹理"><a href="#基础纹理" class="headerlink" title="基础纹理"></a>基础纹理</h2><h3 id="纹理类型分类"><a href="#纹理类型分类" class="headerlink" title="纹理类型分类"></a>纹理类型分类</h3><p>一下以Unity支持的导入设置纹理格式来分(一下只重点关注几个重要的)：<br>Note:<br>随着Unity版本的变化，以下格式可能有细微变化(比如5.4里面的Adavanced已经没有了，取而代之的是细分到其他几个类型里)</p>
<h4 id="Delfaut-Advanced"><a href="#Delfaut-Advanced" class="headerlink" title="Delfaut(Advanced)"></a>Delfaut(Advanced)</h4><p>这个是Unity在高版本默认的纹理格式，也是平时我们最常用的纹理格式之一。</p>
<p>如果要想将2D纹理图片作为纹理渲染到3D物体上，我们需要选择Default进行纹理格式的基本导入设置。</p>
<p>这里只提几个比较重要的设置，后续会讲到相关的概念。</p>
<ol>
<li>Non Power of 2(用于将不是2的倍数的纹理图片进行优化处理成2的倍数的宽高)</li>
<li>Generate Mip Maps(预生成多个不同大小的纹理图片，用于不同距离是显示，解决很大的纹理在显示很小的时候失真和浪费的问题)</li>
<li>Wrap Mode(用于设置处理在tiled纹理图片时的方式)</li>
</ol>
<h4 id="Normal-Map"><a href="#Normal-Map" class="headerlink" title="Normal Map"></a>Normal Map</h4><p>在之前的OpenGL学习中已经接触过Normal Map了，这里只是简单说一下什么是和为什么需要Normal Map。</p>
<p>什么是Normal Map?<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Normal_Mapping">Normal Mapping也叫做Dot3 Bump Mapping,它也是Bump Mapping的一种，区别在于Normal Mapping技术直接把Normal存到一张NormalMap里面，从NormalMap里面采回来的值就是Normal，不需要像HeightMap那样再经过额外的计算。<br>值得注意的是，NormalMap存的Normal是基于切线空间的，因此要进行光照计算时，需要把Normal,Light Direction,View direction统一到同一坐标空间中。</a></p>
<p>至于什么是Bump Mapping，为什么normal map的normal值是存在tangent space，什么是tangent space，详情参考：<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Normal_Mapping">Normal Map</a></p>
<p>为什么需要Normal Map？<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Normal_Mapping">如果要在几何体表面表现出凹凸不平的细节，那么在建模的时候就会需要很多的三角面，如果用这样的模型去实时渲染，出来的效果是非常好，只是性能上很有可能无法忍受。Bump Mapping不需要增加额外的几何信息,就可以达到增强被渲染物体的表面细节的效果，可以大大地提高渲染速度，因此得到了广泛的应用。</a></p>
<h4 id="Sprite"><a href="#Sprite" class="headerlink" title="Sprite"></a>Sprite</h4><p>这个是我们制作UI和2D游戏最常用的格式。</p>
<p>这里也将几个Sprite比较重要的设置：</p>
<ol>
<li>Packing Tag(Unity自带的打包图集工具所使用用于决定哪些图片时打在同一个图集里的标识。采用TexturePacker单独处理图片格式以及图集见后面)</li>
<li>Pixels Per Unit(用于决定图片在屏幕上的映射显示大小，这个以及Camera Orthographic Size会影响我们制作Sprite时的大小标准以及Pixel Perfect显示。详情参考之前的学习<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#Unity_Unit_&_Pixel_Per_Unit">Unity Unit &amp; Pixel Per Unit</a>和<a href="http://tonytang1990.github.io/2016/12/11/Unity-Plugins/#NGUI_2-7%E5%B1%8F%E5%B9%95%E8%87%AA%E9%80%82%E5%BA%94">NGUI 2.7屏幕自适应</a>)</li>
<li>Generate Mip Maps(这个概念和前面Default提到的一样，但大部分时候UI和2D游戏都不需要设置这个，因为UI一般不会有太大的大小变化，2D游戏里的图片同理)</li>
</ol>
<h4 id="Lightmap"><a href="#Lightmap" class="headerlink" title="Lightmap"></a>Lightmap</h4><p>待学习</p>
<p>更多的纹理格式还有Editor GUI and Legacy, Cursor, Cookier, Single Channel这里就不一一详解了，详情参见[TextureTypes]](<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TextureTypes.html">https://docs.unity3d.com/Manual/TextureTypes.html</a>)</p>
<h3 id="纹理大小"><a href="#纹理大小" class="headerlink" title="纹理大小"></a>纹理大小</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/ImportingTextures.html#TextureSizes">Ideally, Texture dimension sizes should be powers of two on each side (that is, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048 pixels (px), and so on). The Textures do not have to be square; that is the width can be different from height.</a></p>
<p>上面是Unity官方给出的建议，Texture纹理大小宽高最好是2的N次方倍数。</p>
<p>那么为什么会有Power Of 2这个原则了？</p>
<ol>
<li>硬件GPU(以前的GPU还不支持Non Power Of 2大小的Texture加载。现在虽然支持了但Power Of 2的加载速度始终要比Non Power Of 2快)</li>
<li>内存使用(None Power Of 2的Texture在分配内存时始终会分配最近的Power Of 2大小，如果不采用Power Of 2的Texture会浪费部分内存分配)</li>
<li>纹理压缩格式支持(有些纹理压缩格式只支持特定宽高的纹理图片，比如DXT1只支持mutilple of 4的Texture Size压缩)</li>
</ol>
<p>Texture的最大Size受限于渲染API(相当于硬件所支持的API)等级有关：<br><img src="/img/Unity/TextureMaxSize.JPG" alt="TextureMaxSize"></p>
<p>Note:<br>如果我们想在Unity里使用Non Power Of 2的Texture，我们需要在导入Texture时手动设置成NPO2，不然Unity会自动帮我们转换成Power Of 2的Texture。</p>
<p>参考文章：<br><a target="_blank" rel="noopener" href="https://software.intel.com/en-us/articles/opengl-performance-tips-power-of-two-textures-have-better-performance">OpenGL* Performance Tips: Power of Two Textures Have Better Performance</a></p>
<h3 id="图片格式"><a href="#图片格式" class="headerlink" title="图片格式"></a>图片格式</h3><p>图片是游戏里使用最基础也是最频繁的资源，图片的格式是决定内存占用多少的关键。</p>
<p>所以这里需要了解为什么图片格式会影响最终的内存占用以及如何选择正确的图片格式达到最低的内存占用实现我们所需的效果。以及相关工具帮助我们优化图片内存占用的问题。</p>
<p>图片加载内存计算方式？<br>图片宽度 * 图片高度 * 每个像素点的位数 &#x3D; 内存大小</p>
<p>图片格式决定了每个像素点的位数的多少，比如RGBA8888（32-bit图）代表每个像素点存储了8 bit的R,G,B,A(分别代表红绿蓝透明通道)，总共32 bit即4 byte大小。</p>
<p>所以1024 * 1024大小的RGBA8888的图片所需内存占用计算如下：<br>1024 * 1024 * 4byte &#x3D; 4M</p>
<p>图片格式有哪些？<br>以下引用至<a target="_blank" rel="noopener" href="http://blog.csdn.net/u011476173/article/details/38712031">图片格式及内存占用</a>:<br>(1)RGBA8888(32-bit)<br>    RGBA 4个通道各占8位，如果想获得最好的图片质量，使用这种格式最靠谱，但他占用的内存会比16位的纹理多一倍，加载速度相对较慢。<br>（2）RGBA4444(16-bit)<br>    RGBA 4个通道各占4位，他对每个通道都有不错的支持，还能保证相对良好的图片质量，以及加载速度和内存占用。<br>（3）RGB5A1   (16-bit)<br>    RGB 3个通道各占5位，A通道仅占一位，RGB通道表现良好，A通道只有透明和不透明两种，加载速度和内存占用表现良好。<br>（4）RGB565   (16-bit)<br>    RGB 3个通道分别占5、6、5位，没有A通道，在16为纹理中，图片质量最好。</p>
<p>如何选择正确的图片格式？<br>了解各个图片格式的详细信息后，图片格式的选取根据具体需求而定。取舍主要在于内存占用和显示质量。待深入度研究。</p>
<p>参考文章：<br><a target="_blank" rel="noopener" href="http://blog.csdn.net/u011476173/article/details/38712031">图片格式及内存占用</a></p>
<h3 id="纹理压缩方式"><a href="#纹理压缩方式" class="headerlink" title="纹理压缩方式"></a>纹理压缩方式</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/class-TextureImporterOverride.html">While Unity supports many common image formats as source files for importing your Textures (such as JPG, PNG, PSD and TGA), these formats are not used during realtime rendering by 3D graphics hardware such as a graphics card or mobile device. 3D graphics hardware requires Textures to be compressed in specialized formats which are optimised for fast Texture sampling. The various different platforms and devices available each have their own different proprietary formats.</a></p>
<p>从上述官网描述可以看出，我们游戏最终使用的纹理格式并非最初我们导入的JPG,PNG,PSD or TGA，而是经过特定压缩方式(ETC,PVRTC,ATC,DXT……)压缩后的指定纹理格式的Texture，目的是为了运行使用Texture时更高效，内存占用和显示质量上可以做取舍。</p>
<p>各平台主流通用的纹理压缩方式：<br>PC – DXT<br>Android – ETC<br>IOS – PVRTC</p>
<h3 id="Unity纹理使用"><a href="#Unity纹理使用" class="headerlink" title="Unity纹理使用"></a>Unity纹理使用</h3><p>下面是个人总结的部分知识点：<br>Unity最终使用的不是我们最初导入到项目工程里的JPG,PNG等，而是通过根据指定压缩方式(e.g. ETC)得到的特定纹理格式(e.g. RGBA8888)的纹理图片，目的是为了减少内存开销以及加快GPU的纹理采样速度。</p>
<p>如何选择正确的纹理格式？<br>了解各个纹理格式的详细信息后，纹理格式的选取根据具体需求而定。取舍主要在于内存占用和显示质量之间。</p>
<p>那么有什么相关工具可以帮助我们优化图片使用过程中的内存占用问题吗？<br>答案是：SpritePacker(Unity官方自带工具，最新的Unity 2017貌似推出了Sprite Atlas，打包图集更加灵活) 和 TexturePacker(第三方工具，打包图集(优化空白处减少内存开销，指定图集导出格式减少内存占用，减少drawcall等好处))</p>
<p>那么使用哪一个(Sprite Packer or Texture Packer)用于Unity图集打包工具更好了？<br>Unity通过SpritePacker模糊了图集的概念，通过Sprite Packer设置Tag打包的图集只有在最后打包的时候才会被打进包里。Sprite Packer虽然与Unity开发结合的比较紧密，但灵活度上有所欠缺，Unity 2017推出的Sprite Atlas在灵活度上加强了不少。<br>TexturePacker作为第三方工具，结合Unity使用灵活度更高，可以自定义图集打包的各项参数等，最终放到Unity里的图集是已经打包好的图集。<br>就当前5.4版本的Unity而言，在没有Sprite Altas的前提下，个人觉得采用Texture Packer会更灵活一些，通过Texture Packer我们可以预先打出图集，然后直接将图集打包成ab。</p>
<h4 id="纹理的基础使用"><a href="#纹理的基础使用" class="headerlink" title="纹理的基础使用"></a>纹理的基础使用</h4><p>纹理最基础的应用是用于模型外观。</p>
<p>我们直接来看看BlinnPhong光照模型结合纹理贴图的使用代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Blinn-Phong光照模型结合单独的纹理使用Shader</span></span><br><span class="line">Shader <span class="string">&quot;Custom/Texture/SingleTextureShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">        <span class="comment">// 给Material面板暴露纹理图片</span></span><br><span class="line">        _MainTex (<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line">            </span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;       <span class="comment">// 物体坐标系顶点位置</span></span><br><span class="line">                float3 normal : NORMAL;         <span class="comment">// 物体坐标系法线</span></span><br><span class="line">                float4 texcoord : TEXCOORD0;    <span class="comment">// 纹理</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;       <span class="comment">// 投影坐标系顶点位置</span></span><br><span class="line">                float3 worldnormal : TEXCOORD0; <span class="comment">// 世界坐标系法线</span></span><br><span class="line">                float3 worldpos : TEXCOORD1;    <span class="comment">// 世界坐标系顶点位置</span></span><br><span class="line">                float2 uv : TEXCOORD2;          <span class="comment">// 纹理映射信息</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss; </span><br><span class="line">            <span class="comment">// 对应材质面板的纹理贴图</span></span><br><span class="line">            sampler2D _MainTex;</span><br><span class="line">            <span class="comment">// 纹理材质的纹理属性(e.g. 纹理缩放值，偏移值)</span></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">            </span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                o.worldnormal = normalize(UnityObjectToWorldNormal(v.normal));</span><br><span class="line">                o.worldpos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                <span class="comment">// 通过纹理基础信息和纹理属性得出纹理映射UV坐标</span></span><br><span class="line">                <span class="comment">// TRANSFORM_TEX() == (tex.xy * name##_ST.xy + name##_ST.zw)</span></span><br><span class="line">                o.uv = TRANSFORM_TEX(v.texcoord, _MainTex);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 使用纹理贴图的颜色信息作为漫反射系数</span></span><br><span class="line">                fixed3 albedo = tex2D(_MainTex, i.uv).rgb;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz * albedo;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//漫反射</span></span><br><span class="line">                <span class="comment">// 顶点光线入射向量</span></span><br><span class="line">                fixed3 worldlightdir = normalize(UnityWorldSpaceLightDir(i.worldpos.xyz));</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * albedo * saturate(dot(i.worldnormal, worldlightdir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 高光反射</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(UnityWorldSpaceViewDir(i.worldpos.xyz));</span><br><span class="line">                <span class="comment">// h = (v + l) / |v + l| v和l向量归一化后的向量</span></span><br><span class="line">                fixed3 halfdir = normalize(worldlightdir + viewdir);</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(i.worldnormal, halfdir)), _Gloss);</span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Specular&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/SimpleTextureShader.JPG" alt="BlinnPhong光照模型的纹理使用"></p>
<h4 id="Mipmap"><a href="#Mipmap" class="headerlink" title="Mipmap"></a>Mipmap</h4><p>说到纹理的使用，这里不得不提的就是Mipmap的应用：<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Texture_Mapping">mipmap主要是由于物体在场景中因为距离的缘故会在屏幕显示的大小有变化，如果我们在物体很远，只需要显示很小一块的时候还依然采用很大的纹理贴图，最终显示在屏幕上的纹理会很不清晰（失真）。为了解决这个问题，mipmap应运而生，通过事先生成或指定多个级别的同一纹理贴图，然后在程序运作的过程中通过计算算出应该使用哪一个等级的纹理贴图来避免大纹理小色块失真的问题。</a></p>
<p>在Unity为Texture开启Mipmap，我们需要把纹理类型设置成Advanced，然后勾选Generate Mip Map即可：<br><img src="/img/Unity/TextureMipmapImportSetting.JPG" alt="TextureMipmapImportSetting"></p>
<p>需要注意的是，Unity开启Mipmap后会导致资源纹理内存占用增加。关于Advanced纹理的各个详细参数信息参考<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TextureTypes.html">Texture Import Setting</a></p>
<p>Note:<br>注意纹理在DX和OpenGL里的起点不一样，DX是左上角(0,0)，OpenGL和Unity是左下角(0,0)。</p>
<h4 id="凹凸映射"><a href="#凹凸映射" class="headerlink" title="凹凸映射"></a>凹凸映射</h4><p>这里的凹凸映射指的就是之前OpenGL学习的Normal Mapping和Bump Mapping，这里直接使用之前的总结：高模normal map用于低模模型上，即不增加渲染负担又能增加渲染细节。</p>
<p>还有一个凹凸映射叫做高度纹理(Height Map)，一般用于存储地形高度信息。</p>
<h5 id="Height-Map"><a href="#Height-Map" class="headerlink" title="Height Map"></a>Height Map</h5><p>用于存储高度信息，通常用于地形的Height Map。</p>
<h5 id="Normal-Mapping"><a href="#Normal-Mapping" class="headerlink" title="Normal Mapping"></a>Normal Mapping</h5><p>关于Normal Mapping要注意的地方主要是两点：</p>
<ol>
<li>存储的法线信息是基于切线空间的，需要转换计算位于世界坐标系的法线信息。</li>
<li>纹理贴图的信息范围是[0,1]，而法线信息时[-1,1]需要通过映射转换。</li>
</ol>
<p><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/#Normal_Mapping">Normal Mapping详细信息参考</a></p>
<p>这里直接给出使用Unity编写Normal Mapping的使用代码和效果(以下代码采用的是将切线空间的法线转换到世界坐标系参与光照计算的方法)：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line"></span><br><span class="line">Shader <span class="string">&quot;Custom/Texture/NormalMappingShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露主纹理</span></span><br><span class="line">        _MainTex(<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 给Material面板暴露法线贴图</span></span><br><span class="line">        <span class="comment">// bump是Unity自带的法线纹理</span></span><br><span class="line">        _NormalMap(<span class="string">&quot;Normal Map&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;bump&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 法线贴图的有效程度，用于控制凹凸程度</span></span><br><span class="line">        _BumpScale(<span class="string">&quot;Bump Scale&quot;</span>, Float) = <span class="number">1.0</span></span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;       <span class="comment">// 物体坐标系顶点位置</span></span><br><span class="line">                float3 normal : NORMAL;         <span class="comment">// 物体坐标系法线</span></span><br><span class="line">                float4 tangent : TANGENT;       <span class="comment">// 切线空间的顶点切线(用于计算切线空间的坐标系)</span></span><br><span class="line">                float4 texcoord : TEXCOORD0;    <span class="comment">// 纹理位置信息(用于通过采样获取纹理的UV信息)</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;       <span class="comment">// 投影坐标系顶点位置</span></span><br><span class="line">                float4 uv : TEXCOORD0;          <span class="comment">// 主纹理和法线纹理的UV坐标信息(xy为主纹理的UV，zw为法线纹理的UV，用于后续的纹理采样)</span></span><br><span class="line">                float4 ttow0 : TEXCOORD1;       <span class="comment">// 切线空间y轴转换到世界坐标系后的y轴</span></span><br><span class="line">                float4 ttow1 : TEXCOORD2;       <span class="comment">// 切线空间x轴转换到世界坐标系后的x轴</span></span><br><span class="line">                float4 ttow2 : TEXCOORD3;       <span class="comment">// 切线空间z轴转换到到世界坐标系后的z轴</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的纹理贴图</span></span><br><span class="line">            sampler2D _MainTex;</span><br><span class="line">            <span class="comment">// 纹理材质的纹理属性(e.g. 纹理缩放值，偏移值)</span></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">            <span class="comment">// 对应材质面板法线贴图</span></span><br><span class="line">            sampler2D _NormalMap;</span><br><span class="line">            <span class="comment">// 法线贴图材质的纹理属性(e.g. 纹理缩放值，偏移值)</span></span><br><span class="line">            float4 _NormalMap_ST;</span><br><span class="line">            <span class="comment">// 对应材质面板法线贴图有效程度参数</span></span><br><span class="line">            <span class="built_in">float</span> _BumpScale;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 通过tangent和normal值计算出将tangent转换到世界坐标系的矩阵(世界坐标系下的XYZ轴)</span></span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// **_ST</span></span><br><span class="line">                <span class="comment">// x contains X tiling value</span></span><br><span class="line">                <span class="comment">// y contains Y tiling value</span></span><br><span class="line">                <span class="comment">// z contains X offset value</span></span><br><span class="line">                <span class="comment">// w contains Y offset value</span></span><br><span class="line">                <span class="comment">// 主纹理的UV信息</span></span><br><span class="line">                o.uv.xy = v.texcoord.xy * _MainTex_ST.xy + _MainTex_ST.zw;</span><br><span class="line">                <span class="comment">// 法线纹理的UV信息</span></span><br><span class="line">                o.uv.zw = v.texcoord.xy * _NormalMap_ST.xy + _NormalMap_ST.zw;</span><br><span class="line"></span><br><span class="line">                float3 worldpos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                <span class="comment">// 世界坐标系下的normal(相当于y轴)</span></span><br><span class="line">                fixed3 worldnormal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line">                <span class="comment">// 世界坐标系下的tangent(相当于x轴)</span></span><br><span class="line">                fixed3 worldtangent = UnityObjectToWorldDir(v.tangent.xyz);</span><br><span class="line">                <span class="comment">// 世界坐标系下的normal和tangent计算出binormal</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的binormal(相当于z轴)</span></span><br><span class="line">                fixed3 worldbinormal = cross(worldnormal, worldtangent) * v.tangent.w;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 填充从tangent space转换到world space的矩阵</span></span><br><span class="line">                <span class="comment">// 注意因为是列向量，所以注意填充方式</span></span><br><span class="line">                <span class="comment">// worldpos填充在w后续使用</span></span><br><span class="line">                o.ttow0 = float4(worldtangent.x, worldbinormal.x, worldnormal.x, worldpos.x);</span><br><span class="line">                o.ttow1 = float4(worldtangent.y, worldbinormal.y, worldnormal.y, worldpos.y);</span><br><span class="line">                o.ttow2 = float4(worldtangent.z, worldbinormal.z, worldnormal.z, worldpos.z);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 世界坐标系顶点位置</span></span><br><span class="line">                fixed3 worldpos = float3(i.ttow0.w,i.ttow1.w,i.ttow2.w);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 计算世界坐标系的法线信息</span></span><br><span class="line">                <span class="comment">// bump为切线空间的法线信息</span></span><br><span class="line">                fixed3 bump = UnpackNormal(tex2D(_NormalMap, i.uv.zw));</span><br><span class="line"></span><br><span class="line">                bump.xy *= _BumpScale;</span><br><span class="line">                bump.z = sqrt(<span class="number">1.0</span> - saturate(dot(bump.xy, bump.xy)));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将切线空间空间的法线信息转换到世界坐标系下</span></span><br><span class="line">                bump = normalize(half3(dot(i.ttow0.xyz, bump), dot(i.ttow1.xyz, bump), dot(i.ttow2.xyz, bump)));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 利用转换到世界坐标系的法线信息，正式开始光照计算</span></span><br><span class="line">                <span class="comment">// 使用纹理贴图的颜色信息作为漫反射系数</span></span><br><span class="line">                fixed3 albedo = tex2D(_MainTex, i.uv).rgb;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz * albedo;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 漫反射</span></span><br><span class="line">                <span class="comment">// 顶点光线入射向量</span></span><br><span class="line">                fixed3 worldlightdir = normalize(UnityWorldSpaceLightDir(worldpos));</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * albedo * saturate(dot(bump, worldlightdir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 高光反射</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(UnityWorldSpaceViewDir(worldpos));</span><br><span class="line">                <span class="comment">// h = (v + l) / |v + l| v和l向量归一化后的向量</span></span><br><span class="line">                fixed3 halfdir = normalize(worldlightdir + viewdir);</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(bump, halfdir)), _Gloss);</span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Specular&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/NormalMappingTextureShader.PNG" alt="BlinnPhong光照模型的Normal Mapping纹理使用"></p>
<h5 id="Ramp-Texture-渐变纹理"><a href="#Ramp-Texture-渐变纹理" class="headerlink" title="Ramp Texture(渐变纹理)"></a>Ramp Texture(渐变纹理)</h5><p>比较普遍的用法是使用渐变纹理来控制漫反射光照运算。<br>让我们直接看代码和效果图。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/Texture/RampTextureShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露渐变纹理贴图</span></span><br><span class="line">        _RampTex(<span class="string">&quot;Ramp Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;       <span class="comment">// 物体坐标系顶点位置</span></span><br><span class="line">                float3 normal : NORMAL;         <span class="comment">// 物体坐标系法线</span></span><br><span class="line">                float4 texcoord : TEXCOORD0;    <span class="comment">// 纹理位置信息(用于通过采样获取纹理的UV信息)</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;       <span class="comment">// 投影坐标系顶点位置</span></span><br><span class="line">                float3 worldnormal : TEXCOORD0; <span class="comment">// 世界坐标系下的法线</span></span><br><span class="line">                float3 worldpos : TEXCOORD1;    <span class="comment">// 世界坐标系下的顶点位置</span></span><br><span class="line">                float2 uv : TEXCOORD2;          <span class="comment">// 渐变纹理的UV坐标信息</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板渐变纹理贴图</span></span><br><span class="line">            sampler2D _RampTex;</span><br><span class="line">            <span class="comment">// 渐变纹理贴图的纹理属性(e.g. 纹理缩放值，偏移值)</span></span><br><span class="line">            float4 _RampTex_ST;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 通过tangent和normal值计算出将tangent转换到世界坐标系的矩阵(世界坐标系下的XYZ轴)</span></span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">                o.worldnormal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line">                o.worldpos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                o.uv = TRANSFORM_TEX(v.texcoord, _RampTex);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                fixed3 worldnormal = normalize(i.worldnormal);</span><br><span class="line">                fixed3 worldlightdir = normalize(UnityWorldSpaceLightDir(i.worldpos));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">                <span class="comment">// 半兰伯特反漫射光照模型</span></span><br><span class="line">                <span class="keyword">fixed</span> halflambert = dot(i.worldnormal, worldlightdir) * <span class="number">0.5</span> + <span class="number">0.5</span>;</span><br><span class="line">                <span class="comment">// 利用半兰伯特得到的[0,1]范围值渐变纹理采样</span></span><br><span class="line">                fixed3 diffusecolor = tex2D(_RampTex, fixed2(halflambert, halflambert)).rgb;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                fixed3 diffuse = _LightColor0 * diffusecolor;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 高光反射</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(UnityWorldSpaceViewDir(i.worldpos));</span><br><span class="line">                <span class="comment">// h = (v + l) / |v + l| v和l向量归一化后的向量</span></span><br><span class="line">                fixed3 halfdir = normalize(worldlightdir + viewdir);</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(i.worldnormal, halfdir)), _Gloss);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Specular&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RampTexture.PNG" alt="渐变纹理"><br>可以看出利用半兰伯特把法线映射到[0,1]后，作为渐变纹理采样的uv，这样一来面向光照方向的顶点会更靠纹理采样的1，反之完全与光照相反方向的顶点会更靠近纹理采样的0的位置，然后把渐变纹理的采样信息作为漫反射的基础颜色信息参与光照运算。</p>
<h5 id="Mask-Texture-遮罩纹理"><a href="#Mask-Texture-遮罩纹理" class="headerlink" title="Mask Texture(遮罩纹理)"></a>Mask Texture(遮罩纹理)</h5><p>“遮罩允许我们可以保护某些区域，使它们免于修改。遮罩纹理已经不止限于保护区域避免修改，而是存储我们希望逐像素控制的表面属性。”<br>让我们直接看代码和效果图：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;_Object2World&#x27; with &#x27;unity_ObjectToWorld&#x27;</span></span><br><span class="line">Shader <span class="string">&quot;Custom/Texture/MaskTextureShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给Material面板暴露主纹理</span></span><br><span class="line">        _MainTex(<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 给Material面板暴露法线贴图</span></span><br><span class="line">        <span class="comment">// bump是Unity自带的法线纹理</span></span><br><span class="line">        _NormalMap(<span class="string">&quot;Normal Map&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;bump&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 法线贴图的有效程度，用于控制凹凸程度</span></span><br><span class="line">        _BumpScale(<span class="string">&quot;Bump Scale&quot;</span>, Float) = <span class="number">1.0</span></span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射遮罩纹理</span></span><br><span class="line">        _SpecularMask(<span class="string">&quot;Specular Mask&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光反射系数</span></span><br><span class="line">        _Specular(<span class="string">&quot;Specular&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 给Material面板暴露高光范围</span></span><br><span class="line">        _Gloss(<span class="string">&quot;Gloss&quot;</span>, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 指定Pass用于Forward Rendering中的Light计算</span></span><br><span class="line">        Tags&#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;ForwardBase&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;       <span class="comment">// 物体坐标系顶点位置</span></span><br><span class="line">                float3 normal : NORMAL;         <span class="comment">// 物体坐标系法线</span></span><br><span class="line">                float4 tangent : TANGENT;       <span class="comment">// 切线空间的顶点切线(用于计算切线空间的坐标系)</span></span><br><span class="line">                float4 texcoord : TEXCOORD0;    <span class="comment">// 纹理位置信息(用于通过采样获取纹理的UV信息)</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 pos : SV_POSITION;       <span class="comment">// 投影坐标系顶点位置</span></span><br><span class="line">                float2 uv : TEXCOORD0;          <span class="comment">// 主纹理和法线纹理和遮罩纹理公用一个UV坐标信息</span></span><br><span class="line">                float4 ttow0 : TEXCOORD1;       <span class="comment">// 切线空间y轴转换到世界坐标系后的y轴</span></span><br><span class="line">                float4 ttow1 : TEXCOORD2;       <span class="comment">// 切线空间x轴转换到世界坐标系后的x轴</span></span><br><span class="line">                float4 ttow2 : TEXCOORD3;       <span class="comment">// 切线空间z轴转换到到世界坐标系后的z轴</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应材质面板的纹理贴图</span></span><br><span class="line">            sampler2D _MainTex;</span><br><span class="line">            <span class="comment">// 纹理材质的纹理属性(e.g. 纹理缩放值，偏移值)</span></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">            <span class="comment">// 对应材质面板法线贴图</span></span><br><span class="line">            sampler2D _NormalMap;</span><br><span class="line">            <span class="comment">// 对应材质面板法线贴图有效程度参数</span></span><br><span class="line">            <span class="built_in">float</span> _BumpScale;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射遮罩纹理</span></span><br><span class="line">            sampler2D _SpecularMask;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光反射系数</span></span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="comment">// 对应材质面板的高光范围</span></span><br><span class="line">            <span class="built_in">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span>(<span class="params">a2v v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 通过tangent和normal值计算出将tangent转换到世界坐标系的矩阵(世界坐标系下的XYZ轴)</span></span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 公用的纹理UV信息</span></span><br><span class="line">                o.uv = TRANSFORM_TEX(v.texcoord, _MainTex);</span><br><span class="line"></span><br><span class="line">                float3 worldpos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">                <span class="comment">// 世界坐标系下的normal(相当于y轴)</span></span><br><span class="line">                fixed3 worldnormal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line">                <span class="comment">// 世界坐标系下的tangent(相当于x轴)</span></span><br><span class="line">                fixed3 worldtangent = UnityObjectToWorldDir(v.tangent.xyz);</span><br><span class="line">                <span class="comment">// 世界坐标系下的normal和tangent计算出binormal</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的binormal(相当于z轴)</span></span><br><span class="line">                fixed3 worldbinormal = cross(worldnormal, worldtangent) * v.tangent.w;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 填充从tangent space转换到world space的矩阵</span></span><br><span class="line">                <span class="comment">// 注意因为是列向量，所以注意填充方式</span></span><br><span class="line">                <span class="comment">// worldpos填充在w后续使用</span></span><br><span class="line">                o.ttow0 = float4(worldtangent.x, worldbinormal.x, worldnormal.x, worldpos.x);</span><br><span class="line">                o.ttow1 = float4(worldtangent.y, worldbinormal.y, worldnormal.y, worldpos.y);</span><br><span class="line">                o.ttow2 = float4(worldtangent.z, worldbinormal.z, worldnormal.z, worldpos.z);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span>(<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 世界坐标系顶点位置</span></span><br><span class="line">                fixed3 worldpos = float3(i.ttow0.w,i.ttow1.w,i.ttow2.w);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 计算世界坐标系的法线信息</span></span><br><span class="line">                <span class="comment">// bump为切线空间的法线信息</span></span><br><span class="line">                fixed3 bump = UnpackNormal(tex2D(_NormalMap, i.uv));</span><br><span class="line"></span><br><span class="line">                bump.xy *= _BumpScale;</span><br><span class="line">                bump.z = sqrt(<span class="number">1.0</span> - saturate(dot(bump.xy, bump.xy)));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将切线空间空间的法线信息转换到世界坐标系下</span></span><br><span class="line">                bump = normalize(half3(dot(i.ttow0.xyz, bump), dot(i.ttow1.xyz, bump), dot(i.ttow2.xyz, bump)));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 利用转换到世界坐标系的法线信息，正式开始光照计算</span></span><br><span class="line">                <span class="comment">// 使用纹理贴图的颜色信息作为漫反射系数</span></span><br><span class="line">                fixed3 albedo = tex2D(_MainTex, i.uv).rgb;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 环境光</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz * albedo;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 漫反射</span></span><br><span class="line">                <span class="comment">// 顶点光线入射向量</span></span><br><span class="line">                fixed3 worldlightdir = normalize(UnityWorldSpaceLightDir(worldpos));</span><br><span class="line">                <span class="comment">// 得到世界坐标系的顶点法线和direction light方向后可以开始计算漫反射</span></span><br><span class="line">                <span class="comment">// _LightColor0代表全局唯一的direction light光照的颜色信息</span></span><br><span class="line">                <span class="comment">// 点乘世界坐标系的法线和光源方向得到漫反射辐射度</span></span><br><span class="line">                <span class="comment">// saturate防止负值</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * albedo * saturate(dot(bump, worldlightdir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 高光反射</span></span><br><span class="line">                <span class="comment">// 世界坐标系下的从顶点到观察点的观察方向v</span></span><br><span class="line">                fixed3 viewdir = normalize(UnityWorldSpaceViewDir(worldpos));</span><br><span class="line">                <span class="comment">// h = (v + l) / |v + l| v和l向量归一化后的向量</span></span><br><span class="line">                fixed3 halfdir = normalize(worldlightdir + viewdir);</span><br><span class="line">                <span class="comment">// 高光遮罩纹理采样信息(这里只是用了r红色通道信息作为mask)</span></span><br><span class="line">                <span class="keyword">fixed</span> specularmask = tex2D(_SpecularMask, i.uv).r;</span><br><span class="line">                <span class="comment">// 计算高光反射的颜色信息(高光遮罩纹理参与过滤)</span></span><br><span class="line">                <span class="comment">// c(specular) = (c(light) * m(specular)) * pow(max(0, dot(n,h)), m(gloss))</span></span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(saturate(dot(bump, halfdir)), _Gloss) * specularmask;</span><br><span class="line">                <span class="comment">// 将高光反射的颜色信息输出到最终的顶点颜色</span></span><br><span class="line">                <span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback <span class="string">&quot;Specular&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/MaskTexture.PNG" alt="高光遮罩纹理"><br>可以看到我们利用遮罩纹理的R颜色信息作为高光的过滤依据，也就是说遮罩纹理里R信息为0的顶点将不会计算高光反射。</p>
<h2 id="透明效果"><a href="#透明效果" class="headerlink" title="透明效果"></a>透明效果</h2><h1 id="Reference-Website"><a href="#Reference-Website" class="headerlink" title="Reference Website"></a>Reference Website</h1><p><a target="_blank" rel="noopener" href="http://www.alanzucconi.com/2015/06/17/surface-shaders-in-unity3d/">Surface shaders in Unity3D</a><br>[Unity Shader内置文件官网下载地址](<a target="_blank" rel="noopener" href="http://unity3d.com/cn/get-unity/download/">http://unity3d.com/cn/get-unity/download/</a><br>archive)<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-ShaderSemantics.html">Shader semantics官网查询</a><br><a target="_blank" rel="noopener" href="http://candycat1992.github.io/unity_shaders_book/unity_shaders_book_corrigenda.html">Unity Shader入门精要勘误</a><br><a target="_blank" rel="noopener" href="https://github.com/candycat1992/Unity_Shaders_Book">Unity Shader入门级你要源代码</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Gouraud_shading">Gouraud Shading</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Rendering/">Rendering</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Rendering/">Rendering</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/11/Unity原生/" title="Unity原生" itemprop="url">Unity原生</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-12-11T15:46:11.000Z" itemprop="datePublished"> 发表于 2016-12-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="原生知识"><a href="#原生知识" class="headerlink" title="原生知识"></a>原生知识</h1><h2 id="Plugins分类"><a href="#Plugins分类" class="headerlink" title="Plugins分类"></a>Plugins分类</h2><p>Unity Plugins主要分为两类：</p>
<ol>
<li>Managed Plugins</li>
<li>Native Plugins</li>
</ol>
<h3 id="Managed-Plugins"><a href="#Managed-Plugins" class="headerlink" title="Managed Plugins"></a>Managed Plugins</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Plugins.html">Managed plugins are managed .NET assemblies created with tools like Visual Studio or MonoDevelop. They contain only .NET code which means that they can’t access any features that are not supported by the .NET libraries</a><br>可以看出Managed Plugins是基于.NET的，只含有.NET code(因为Unity只支持.net 2.0，所以并非所有的.NET库和特性都支持)。</p>
<h3 id="Natiev-Plugins"><a href="#Natiev-Plugins" class="headerlink" title="Natiev Plugins"></a>Natiev Plugins</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Plugins.html">Native plugins are platform-specific native code libraries. They can access features like OS calls and third-party code libraries that would otherwise not be available to Unity.</a><br>Native Plugins可以理解成.NET以外的平台相关的本地代码库(比如c++(unmanaged code),java等等编写的库)，通过编译使用这些平台相关的bendi 代码我们可以去得到一些Unity不支持的一些功能特性，同时Native Plugins允许我们去重用那些平台相关的库。</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Plugins.html">if you forget to add a managed plugin file to the project, you will get standard compiler error messages. If you do the same with a native plugin, you will only see an error report when you try to run the project.</a>(Managed Plugin是基于.NET的，Unity<br>直接识别，所以在编译时就会报错。而Native Plugin只会在运行时报错。)</p>
<h2 id="Plugins文件扩展名和支持平台"><a href="#Plugins文件扩展名和支持平台" class="headerlink" title="Plugins文件扩展名和支持平台"></a>Plugins文件扩展名和支持平台</h2><p>Unity支持的Plugins文件扩展名如下：<br>.dll(这里要分Managed还是Native，支持多个平台)<br>.so(Android上使用的代码库文件类型)<br>.a(IOS上使用的代码库文件类型)<br>.jar(java文件打包(不包含Android资源文件)<br>.swift(IOS上新语言swift)<br>.aar(打包Android包含代码文件和所有Android资源文件)<br>.framework<br>.bundle<br>.plugin<br>……(这里只列举了比较典型的一些插件文件扩展名)</p>
<p>Unity支持的平台：<br>Unity是支持多平台的：</p>
<ol>
<li>Editor(Unity Editor)</li>
<li>Windows</li>
<li>IOS</li>
<li>Android<br>……(上述只列举了一部分)</li>
</ol>
<p>那么为什么需要了解这么多不同扩展名和不同的支持平台了？<br>因为不同的文件扩展名是针对不同的平台而运用的。<br>比较典型的就是:<br>.dll(多平台)<br>.so .jar .aar(Android)<br>.a .m .mm .swift .framework(IOS)</p>
<p>那么是不是只要随便编译一个.so文件就能在所有的Android机器上运行了了？<br>答案是否定的。因为不同的CPU处理器所支持的指令集是不一样的</p>
<h3 id="处理器与Plugins"><a href="#处理器与Plugins" class="headerlink" title="处理器与Plugins"></a>处理器与Plugins</h3><p>不同的CPU处理器所支持的指令集是不一样的，也就是说要想我们编译的Plugins要在对应机器上运行起来，我们必须确保我们编译的Plugins支持该设备处理器所支持的指令集。</p>
<p>接下来以Android平台.so为例来学习：<br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/cb05698a1968">Android系统目前支持以下七种不同的CPU架构：ARMv5，ARMv7 (从2010年起)，x86 (从2011年起)，MIPS (从2012年起)，ARMv8，MIPS64和x86_64 (从2014年起)，每一种都关联着一个相应的ABI。</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/cb05698a1968">应用程序二进制接口（Application Binary Interface）定义了二进制文件（尤其是.so文件）如何运行在相应的系统平台上，从使用的指令集，内存对齐到可用的系统函数库。在Android系统上，每一个CPU架构对应一个ABI：armeabi，armeabi-v7a，x86，mips，arm64-v8a，mips64，x86_64。</a></p>
<p>从上面的引用可以看出，要想在编译的.so文件在不同的Android处理器上运行起来，我们必须保证编译的.so支持该设备的指令集。</p>
<p>但有一点要注意，并不是说每一种CPU都只支持一种架构：<br><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/abis.html#sa">armeabi. By contrast, a typical, ARMv7-based device would define the primary ABI as armeabi-v7a and the secondary one as armeabi, since it can run application native binaries generated for each of them.</a>(ARMv7的机器的第一选择是armabi-v7a,但ARMv7也同时支持armeabi(第二选择))</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/abis.html#sa">Many x86-based devices can also run armeabi-v7a and armeabi NDK binaries. For such devices, the primary ABI would be x86, and the second one, armeabi-v7a.</a>(大部分x86机器都支持armeabi-v7a和armeabi，但x86的第一选择是x86)</p>
<p>那么接下来我们通过学习编译和使用.so来加深理解。</p>
<h3 id="so文件"><a href="#so文件" class="headerlink" title=".so文件"></a>.so文件</h3><p>首先让我们认识一下什么是.so文件？<br><a target="_blank" rel="noopener" href="http://linux-wiki.cn/wiki/zh-hans/%E5%8A%A8%E6%80%81%E5%BA%93(.so)/">Linux中的.so文件类似于Windows中的DLL，是动态链接库，也有人译作共享库</a></p>
<p>为什么我们需要编译成.so文件？<br><a target="_blank" rel="noopener" href="http://linux-wiki.cn/wiki/zh-hans/%E5%8A%A8%E6%80%81%E5%BA%93(.so)/">当多个程序使用同一个动态链接库时，既能节约可执行文件的大小，也能减少运行时的内存占用。</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/index.html">Squeeze extra performance out of a device to achieve low latency or run computationally intensive applications, such as games or physics simulations. </a>(压榨机器性能)<br><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/index.html">Reuse your own or other developers’ C or C++ libraries. </a>(重用C和C++库)</p>
<h3 id="so与ELF"><a href="#so与ELF" class="headerlink" title=".so与ELF"></a>.so与ELF</h3><p>在了解.so文件结构之前，我们需要了解一下什么是ELF文件？<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">ELF(Executable and Linking Format)是一种对象文件的格式，用于定义不同类型的对象文件(Object files)中都放了什么东西、以及都以什么样的格式去放这些东西。它自最早在 System V 系统上出现后，被 xNIX 世界所广泛接受，作为缺省的二进制文件格式来使用</a></p>
<p>ELF文件主要分为三类：</p>
<ol>
<li>Relocatable file(可重定位对象文件 e.g. 汇编生成的.o文件)</li>
<li>Executable file(可执行文件)</li>
<li>Shared object file(动态库文件 e.g. .so文件)</li>
</ol>
<p>接下来让我们看看ELF Object file的构成：<br><img src="/img/Unity/ELFFileStructure.PNG" alt="ELFFileStructure"><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">为什么会有左右两个很类似的图来说明ELF的组成格式？这是因为ELF格式需要使用在两种场合：</a><br>a) <a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">组成不同的可重定位文件，以参与可执行文件或者可被共享的对象文件的链接构建；</a><br>b) <a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">组成可执行文件或者可被共享的对象文件，以在运行时内存中进程映像的构建。</a></p>
<p>如果想知道ELF文件属于哪一类ELF，并且采用了大端还是小段模式，以及支持的架构等信息的话可以通过fiel命令(貌似属于Linux上的命令，Windows上可以通过Cygwin来模拟Linux环境)<br><img src="/img/Unity/ELFFileCommand.PNG" alt="ELFFileCommand"><br>可以看到libBugly.so是属于shared objectt，target架构是ARM，是小端(LSB)32位结构</p>
<p>接下来我们关注一下ELF文件具体的组成部分：<br><img src="/img/Unity/ELFFileStructureDetail.PNG" alt="ELFFileStructureDetail"></p>
<p>主要由三部分组成：</p>
<ol>
<li>the ELF header</li>
<li>the Program Header Table</li>
<li>the Section Header Table</li>
</ol>
<p>ELF header除了包含前面file命令打印出的一些信息外，还包括更多描述ELF各文件部分的相关信息。<br>我们可以通过readelf命令来查看(Windows上除了通过Cygwin，这里我们还可以使用NDK里的arm-linux-androideabi-readelf.exe来查看ELF Header信息)<br><img src="/img/Unity/ELFHeaderReadelfCommand.PNG" alt="ELFHeaderReadelfCommand"><br>具体每一个字段的含义可以查看<a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man5/elf.5.html">ELF</a><br>这里我比较关注的是：<br>Machine  – 表示当前的ELF文件支持的架构。从上面可以看出libBugly.so支持ARM架构<br>Entry point address – 描述程序入口的虚拟地址，如果没有入口则为0x0(这里因为libBugly.so是提供再链接，所以不存在入口点)<br>Start of *** – 描述了特定headers内容的内存偏移<br>Size of *** – 描述了特定header所占字节大小<br>……</p>
<p>从上面的readelf输出结果可以看出libBugly.so包含了9个program headers，25个section headers。</p>
<p>这里暂时不深入去了解ELF文件了，如需了解，可以查看下面给出的链接。<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">可执行文件（ELF）格式的理解</a>:</p>
<p>这里因为我在Android 7.0(API 24)遇到了一个问题：<br>Missing Section Headers<br>后来了解到在Android 7.0开始，Google做了很多改动和要求，包括下面这一项：<br>Missing Section Headers (Enforced since API 24)<br>而因为Section Headers在.so中被移除了所以报出了这个问题。(好像是为了增加破解难度)</p>
<p>这里让我们来了解一个命令工具strip – 用于移除ELF文件中一些不必要的信息。(比如 debug symbol, section headers……)</p>
<p>首先让我们通过readelf –section-headers查看section headers的信息：<br><img src="/img/Unity/SectionHeadersInfo.PNG" alt="SectionHeadersInfo"><br>可以看到libSubly.so有24个section headers</p>
<p>然后通过strip –remove-sections&#x3D;.* libBugly.so尝试移除所有sections(这里注意Cygwin strip无法识别.so，但NDK strip却可以，不知道是不是需要)<br><img src="/img/Unity/StripSectionsAfter.PNG" alt="StripSectionsAfter"><br>可以看到我们成功的移除了所有section header(除了.shstrtab)。</p>
<p>我想这应该就是前面遇到Missing Section Headers的原因，Android 7.0上强制要求不能Missing Section Header。(待确认)</p>
<p>这里主要知道如何去查看.so文件的架构等信息以及ELF文件的大概组成以及如何通过strip命令去移除一些ELF文件里不必要的信息即可。</p>
<h3 id="编译和使用-so"><a href="#编译和使用-so" class="headerlink" title="编译和使用.so"></a>编译和使用.so</h3><p>结合以前学习的一些知识：<br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v7t7.html">JNI和NDK交叉编译进阶学习</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102vazu.html">NDK&amp;JNI&amp;Java&amp;Android初步学习总结归纳</a></p>
<p>要想在Windows上编译出在Android处理器使用的.so文件，我需要通过<a target="_blank" rel="noopener" href="https://developer.android.com/ndk/downloads/index.html">NDK</a>(一系列工具的集合，帮助开发者快速开发C(或C++)的动态库。集成了交叉编译器)或者Android Studio配合CMake进行编译。</p>
<p>待续…..</p>
<h3 id="so架构的抉择"><a href="#so架构的抉择" class="headerlink" title=".so架构的抉择"></a>.so架构的抉择</h3><p>还记得前面提到的关于.so架构兼容的问题吗。<br>按照前面的理论是不是说我们只需要支持armeabi或者armeabi-v7架构，就能在大部分机器上跑了了？<br>答案是肯定的，这也是为什么有些人通过减少.so的种类来达到减少APK大小。但值得注意的一点是兼容并不是说100%不会出问题，同时兼容的.so并不一定能使使用性能达到最佳。</p>
<p>所以最好的方法还是通过想办法使用正确架构的.so才是上上之策。</p>
<p>至于即想减少APK大小又想完美使用正确的.so架构的方式，可以参考下面这位博主的一些提议：<br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000005646078">ANDROID动态加载 使用SO库时要注意的一些问题</a></p>
<h3 id="Unity-Android-IOS-Plugin"><a href="#Unity-Android-IOS-Plugin" class="headerlink" title="Unity Android &amp; IOS Plugin"></a>Unity Android &amp; IOS Plugin</h3><p>接下来让我们结合Unity对Android和IOS平台架构的支持来学习理解CPU架构与Unity之间的关系。<br>Android:<br><img src="/img/Unity/AndroidSupportedArchitectures.PNG" alt="AndroidSupportedArchitectures"></p>
<p>IOS(mono):<br><img src="/img/Unity/IOSMonoSupportedArchitectures.PNG" alt="IOSMonoSupportedArchitectures"></p>
<p>IOS(IL2CPP):<br><img src="/img/Unity/IOSIL2CPPSupportedArchitectures.PNG" alt="IOSIL2CPPSupportedArchitectures"></p>
<p>可以看到Android上只支持ARMv7和x86<br>IOS上支持的情况要根据编译后端设置而定(这里提一下Mac上查看.a文件架构的命令是lipo)：<br>Mono只支持IOS ARMv7<br>IL2CPP支持IOS ARMv7和ARM64</p>
<p>Android因为前面提到的armeabi-v7和x86几乎兼容了所有Android机器，所以只支持这两个是说的过去的。</p>
<p>armv7支持了IOS 4 - 5的大部分机器<br>但IOS 5之后基本都要求arm64，也就是说要支持IOS新机器我们必须使用IL2CPP作为后端编译工具(Unity 4.6之后开始支持的)</p>
<p>对应平台的Plugin需要放到对应文件目录下。<br>Android:<br>Assets&#x2F;Plugins&#x2F;Android<br>IOS:<br>Assets&#x2F;Plugins&#x2F;IOS<br>Windows:<br>Assets&#x2F;Plugins</p>
<h4 id="Android实战"><a href="#Android实战" class="headerlink" title="Android实战"></a>Android实战</h4><p>实战Android前，让我们先了解下Android重要的IDE以及代码相关知识。</p>
<h5 id="Android-Studio"><a href="#Android-Studio" class="headerlink" title="Android Studio"></a>Android Studio</h5><p>以前设计到Android开发的时候，都是使用的Eclipse配合ADT插件来弄得。但Eclipse已经被Google放弃了，Google推出了Android Studio作为新一代Android的IDE，所以学习Android Studio用于Android开发是有必要的。</p>
<p>先让我们来了解下什么是Android Studio:<br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/intro/">Android Studio 是基于 IntelliJ IDEA 的官方 Android 应用开发集成开发环境 (IDE)。</a></p>
<p>这里本人使用Android Studio的需求是为了做移动平台游戏开发时用于Android原生开发。<br>接下来以使用Android Studio配合Unity开发Android为例来学习。</p>
<p>这里放一张Android官网的Android构建流程图加深印象:<br><img src="/img/Android/AndroidBuildFlowChart.png" alt="AndroidBuildFlowChart"></p>
<h5 id="JNI-Java交互"><a href="#JNI-Java交互" class="headerlink" title="JNI(Java交互)"></a>JNI(Java交互)</h5><p>Unity开发搞Android原生开发，主要是通过JNI(Java Native Interface)去访问JVM和Java代码交互。(更多内容见后面的实战学习)<br>详细的JNI，JVM，Java，Android，NDK等概念学习，参考以前的学习:<br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v7t7.html">JNI和NDK交叉编译进阶学习</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102vazu.html">NDK&amp;JNI&amp;Java&amp;Android初步学习总结归纳</a></p>
<h5 id="Android项目相关概念"><a href="#Android项目相关概念" class="headerlink" title="Android项目相关概念"></a>Android项目相关概念</h5><p>接下来让我们看看Android Studio创建Android工程之后的基本结构:<br><img src="/img/Android/AndroidStudioAndroidProjectStucture.png" alt="AndroidStudioAndroidProjectStucture"></p>
<p>接下来我们需要理解一个Android Studio里很重要的同一个概念:<br><strong>模块</strong><br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/projects/">模块是源文件和构建设置的集合，允许您将项目分成不同的功能单元。您的项目可以包含一个或多个模块，并且一个模块可以将其他模块用作依赖项。每个模块都可以独立构建、测试和调试。</a></p>
<p>Android Studio提供了一下集中不同类型的模块：</p>
<ol>
<li>Android应用模块(就是上面我们创建Android Project时看到的app就是我们的Android应用模块)</li>
<li>库模块(unityandroidlib就是我单独创建的Android库模块–目的是为了单独导出jar或者aar)</li>
<li>Google Cloud模块</li>
</ol>
<h5 id="Android库模块实战"><a href="#Android库模块实战" class="headerlink" title="Android库模块实战"></a>Android库模块实战</h5><p>在通过Android库模块导出AAR或者Jar前，我们需要弄学习了解一个自动化构建工具：Gradle</p>
<h6 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h6><p><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/userguide.html">Gradle is an open-source build automation tool focused on flexibility and performance. Gradle build scripts are written using a Groovy or Kotlin DSL.</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Gradle">Gradle是一个基于Apache Ant和Apache Maven概念的项目自动化建构工具。</a></p>
<p>这里直接引用别人的对Gradle的总结，来简单了解下Gradle:<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/30432152">Gradle是一种构建工具,它可以帮你管理项目中的差异,依赖,编译,打包,部署……,你可以定义满足自己需要的构建逻辑,写入到build.gradle中供日后复用.</a></p>
<p>这里暂时需要了解知道的是，Gradle有两大概念:</p>
<ol>
<li>Project<br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/tutorial_using_tasks.html">Every Gradle build is made up of one or more projects. What a project represents depends on what it is that you are doing with Gradle. For example, a project might represent a library JAR or a web application. It might represent a distribution ZIP assembled from the JARs produced by other projects. </a></li>
<li>Tasks<br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/tutorial_using_tasks.html">Each project is made up of one or more tasks. A task represents some atomic piece of work which a build performs. This might be compiling some classes, creating a JAR, generating Javadoc, or publishing some archives to a repository.</a></li>
</ol>
<p>详细的Gradle学习，参考官网内容:<br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/tutorial_using_tasks.html">Build Script Basics</a></p>
<h6 id="Android库模块"><a href="#Android库模块" class="headerlink" title="Android库模块"></a>Android库模块</h6><p><a target="_blank" rel="noopener" href="https://developer.android.com/studio/projects/android-library">Android 库在结构上与 Android 应用模块相同。它可以提供构建应用所需的一切内容，包括源代码、资源文件和 Android 清单。不过，Android 库将编译到您可以用作 Android 应用模块依赖项的 Android 归档 (AAR) 文件，而不是在设备上运行的 APK。</a></p>
<p>这里简单理解下aar和jar的区别就是，AAR是带了所有资源(包括res，AndroidManifest.xml等APK需要的资源+代码Jar的集合)。</p>
<h6 id="Jar库模块"><a href="#Jar库模块" class="headerlink" title="Jar库模块"></a>Jar库模块</h6><p>Studio如何导出库模块作为学习对象，因为我们的目标就是通过Android Studio导出AAR或者Jar给Unity使用:<br>来看看Android库模块是如何新建的：<br>Project右键-&gt;New-&gt;Module-&gt;Android Library<br><img src="/img/Android/AndroidStuidoAndroidModule.png" alt="AndroidStuidoAndroidModule"></p>
<p>通过查看Android应用模块和Android库模块的build.gradle，我们可以通过Gradle是如何定义的：<br>Android应用模块:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Android库模块:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.android.library&#x27;</span></span><br></pre></td></tr></table></figure>

<p>接下来我们目标是在如何把我们想要的java代码通过Android模块导出成Jar：<br>让我们看下Android模块的结构：<br><img src="/img/Android/AndroidStudioAndroidModule.png" alt="AndroidStudioAndroidModule"><br>把相关jar和java代码导入到我们的：<br><img src="/img/Android/AndroidStudioAndroidMudleImportCode.png" alt="AndroidStudioAndroidMudleImportCode"></p>
<p>我们现在需要做的就是通过编写我们unityandroidlib这个Android库模块下的build.gradle去支持导出我们想要的jar:<br>在写出我们需要的Android模块build.gradle构建文件之前，我们先来了解下Android模块构建的build.gradle里每一个标签的意义：<br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/build/#module-level">详细的Android模块构建gradle标签学习</a><br><a target="_blank" rel="noopener" href="http://google.github.io/android-gradle-dsl/current/index.html">详细的Android DSL标签参考</a><br><a target="_blank" rel="noopener" href="https://guides.gradle.org/building-android-apps/?_ga=2.32380022.931589262.1533988091-1402562034.1533988091">Android Gradle的详细学习参考Building Android Apps</a></p>
<p>实战Android模块的build.gradle：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 表示使用Android插件进行gradle的Android自动化构建</span></span><br><span class="line"><span class="comment"> * com.android.library表示是构建成一个Android模块</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">apply plugin: <span class="string">&#x27;com.android.library&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// android &#123;&#125;指定如何配置android相关编译构建</span></span><br><span class="line">android &#123;</span><br><span class="line">    <span class="comment">// 指定Android API编译版本</span></span><br><span class="line">    compileSdkVersion <span class="number">27</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//defaultConfig &#123;&#125;指定Android部分默认设置，可以通过这里的指定覆盖AndroidManifest.xml里的部分内容</span></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion <span class="number">15</span>            <span class="comment">// 最低支持的Android API版本</span></span><br><span class="line">        targetSdkVersion <span class="number">27</span>         <span class="comment">// 目标Android API版本</span></span><br><span class="line">        versionCode <span class="number">1</span>               <span class="comment">// App的version number</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span>           <span class="comment">// App的version name</span></span><br><span class="line"></span><br><span class="line">        testInstrumentationRunner <span class="string">&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// buildTypes &#123;&#125;指定编译类型的详细信息，比如release和debug的详细编译设定</span></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        <span class="comment">// release的编译设定</span></span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">false</span>                                                                         <span class="comment">// 是否开启代码精简</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span>    <span class="comment">// 代码混淆相关设置</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dependencies &#123;&#125;指定编译依赖信息(比如我们的项目需要依赖unity的classes.jar库)</span></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="comment">// fileTree - 指定目录(libs)下符合条件(*.jar)的文件添加到编译路径下</span></span><br><span class="line">    implementation <span class="keyword">fileTree</span>(<span class="keyword">include</span>: [<span class="string">&#x27;*.jar&#x27;</span>], dir: <span class="string">&#x27;libs&#x27;</span>)</span><br><span class="line">    <span class="comment">// com.android.support:appcompat-v7:27.1.1 - 添加Android兼容模式库到项目，用于支持更多的theme和兼容老的部分功能</span></span><br><span class="line">    implementation <span class="string">&#x27;com.android.support:appcompat-v7:27.1.1&#x27;</span></span><br><span class="line">    testImplementation <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line">    androidTestImplementation <span class="string">&#x27;com.android.support.test:runner:1.0.2&#x27;</span></span><br><span class="line">    androidTestImplementation <span class="string">&#x27;com.android.support.test.espresso:espresso-core:3.0.2&#x27;</span></span><br><span class="line">    <span class="comment">// files - 猜测是指定需要依赖的jar库(没找到官方解释)</span></span><br><span class="line">    implementation files(<span class="string">&#x27;libs/classes.jar&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// task - 添加自定义的构建任务</span></span><br><span class="line"><span class="comment">// 这里是增加一个删除旧的jar的任务</span></span><br><span class="line"><span class="comment">// type:指定任务的类型delete删除</span></span><br><span class="line"><span class="keyword">task</span> deleteOldJar(type: <span class="keyword">Delete</span>) &#123;</span><br><span class="line">    <span class="comment">// 指定删除release/AndroidPlugin.jar文件</span></span><br><span class="line">    <span class="keyword">delete</span> <span class="string">&#x27;build/libs/classes.jar&#x27;</span></span><br><span class="line">    <span class="keyword">delete</span> <span class="string">&#x27;release/AndroidPlugin.jar&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// task - 添加自定义的构建任务</span></span><br><span class="line"><span class="comment">// 这里增加一个从新打包jar的任务，目的是为了去除默认build里打包的BuildConfig.class(会导致Unity使用jar时报错)</span></span><br><span class="line"><span class="comment">// type: 指定任务类型是Jar打包</span></span><br><span class="line"><span class="keyword">task</span> makeJar(type: Jar) &#123;</span><br><span class="line">    <span class="comment">// 指定jar来源(文件或者目录)</span></span><br><span class="line">    <span class="keyword">from</span> <span class="keyword">file</span>(<span class="string">&#x27;build/intermediates/classes/release&#x27;</span>)</span><br><span class="line">    <span class="comment">// 指定需要重新打包后的jar名字</span></span><br><span class="line">    archiveName = <span class="string">&#x27;classes.jar&#x27;</span></span><br><span class="line">    <span class="comment">// 输出目录</span></span><br><span class="line">    <span class="keyword">destinationDir</span> = <span class="keyword">file</span>(<span class="string">&#x27;build/libs/&#x27;</span>)</span><br><span class="line">    <span class="comment">// 过滤不需要的class文件</span></span><br><span class="line">    <span class="keyword">exclude</span>(<span class="string">&#x27;com/tonytang/unityandroidproject/BuildConfig.class&#x27;</span>)</span><br><span class="line">    <span class="keyword">exclude</span>(<span class="string">&#x27;com/tonytang/unityandroidproject/BuildConfig\$*.class&#x27;</span>)</span><br><span class="line">    <span class="keyword">exclude</span>(<span class="string">&#x27;com/tonytang/unityandroidproject/R.class&#x27;</span>)</span><br><span class="line">    <span class="keyword">exclude</span>(<span class="string">&#x27;com/tonytang/unityandroidproject/R\$*.class&#x27;</span>)</span><br><span class="line">    <span class="comment">// 需要包含打包到jar中的文件</span></span><br><span class="line">    <span class="keyword">include</span>(<span class="string">&#x27;com/tonytang/unityandroidproject/**&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定makeJar任务依赖的任务build(依赖的任务先执行)</span></span><br><span class="line">makeJar.dependsOn(build)</span><br><span class="line"></span><br><span class="line"><span class="comment">// task - 添加自定义的构建任务</span></span><br><span class="line"><span class="comment">// 这里是增加一个到处jar的任务</span></span><br><span class="line"><span class="comment">// type:指定任务类型为Copy复制</span></span><br><span class="line"><span class="keyword">task</span> exportJar(type: <span class="keyword">Copy</span>) &#123;</span><br><span class="line">    <span class="comment">// 从哪里复制</span></span><br><span class="line">    <span class="keyword">from</span>(<span class="string">&#x27;build/libs/&#x27;</span>)</span><br><span class="line">    <span class="comment">// 复制到哪里</span></span><br><span class="line">    <span class="keyword">into</span>(<span class="string">&#x27;release/&#x27;</span>)</span><br><span class="line">    <span class="comment">/// 重命名文件</span></span><br><span class="line">    rename(<span class="string">&#x27;classes.jar&#x27;</span>, <span class="string">&#x27;AndroidPlugin.jar&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定exportJar任务依赖的任务deleteOldJar,build,makeJar(依赖的任务先执行)</span></span><br><span class="line">exportJar.dependsOn(deleteOldJar, makeJar)</span><br></pre></td></tr></table></figure>
<p>完成build.gradle编写后，我们打开Gradle Project就可以选中我们新写的exportJar任务，双击执行:<br><img src="/img/Android/AndroidStudioGradleProjectView.png" alt="AndroidStudioGradleProjectView"><br><img src="/img/Android/AndroidStudioGraduleBuildProccess.png" alt="AndroidStudioGraduleBuildProccess"></p>
<p>上面的注释很详细了，就不过多描述了，直接来看下我们在release下生成的新得AndroidPlugin.jar吧：<br><img src="/img/Android/AndroidModuleJar.png" alt="AndroidModuleJar"><br>我们成功得到了过滤掉BuildConfig.class,R.class等文件的jar代码包。<br>得到jar包后，我们还需要把我们的Android相关的资源以及jar包放到我们的Unity对应项目目录才行（Plugins&#x2F;Android&#x2F;）:<br><img src="/img/Android/UnityAndroidFolderStructure.png" alt="UnityAndroidFolderStructure"></p>
<p>接下来我们需要的是通过Unity封装的JNI去访问Java代码：<br>AndroidNativeManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             AndroidNativeManager.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_ANDROID</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> AndroidNativeManager.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Android原生管理类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AndroidNativeManager</span> : <span class="title">NativeManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Android主Activity对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> AndroidJavaObject mAndroidActivity;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.<span class="keyword">init</span>();</span><br><span class="line">        Debug.Log(<span class="string">&quot;init()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (Application.platform == RuntimePlatform.Android)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//这里使用using的目的是确保AndroidJavaClass对象尽快被删除</span></span><br><span class="line">            <span class="keyword">using</span> (AndroidJavaClass jc = <span class="keyword">new</span> AndroidJavaClass(<span class="string">&quot;com.unity3d.player.UnityPlayer&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//获得当前Activity(这里是为了获得MainActivity)</span></span><br><span class="line">                mAndroidActivity = jc.GetStatic&lt;AndroidJavaObject&gt;(<span class="string">&quot;currentActivity&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (mAndroidActivity == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">&quot;获取UnityMainActivity::mAndroidActivity成员失败！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">&quot;获取UnityMainActivity::mAndroidActivity成员成功!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 调用原生方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">callNativeMethod</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.callNativeMethod();</span><br><span class="line">        Debug.Log(<span class="string">&quot;callNativeMethod()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (mAndroidActivity != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mAndroidActivity.Call(<span class="string">&quot;javaMethod&quot;</span>, <span class="string">&quot;cs param&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>NativeMessageHandler.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             NativeMessageHandler.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NativeMessageHandler.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 原生消息相应处理器</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NativeMessageHandler</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 接收原生消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resUnityMsg</span>(<span class="params"><span class="built_in">string</span> msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;resUnityMsg : &#123;0&#125;&quot;</span>, msg));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MainActivity.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tonytang.unityandroidproject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.Configuration;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.DisplayMetrics;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unity3d.player.UnityPlayer;</span><br><span class="line"><span class="keyword">import</span> com.unity3d.player.UnityPlayerActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">UnityPlayerActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unity那一侧相应Java回调的GameObject名字</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">mUnityCallBackHandler</span> <span class="operator">=</span> <span class="string">&quot;GameLauncher&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Android上下文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">Context</span> <span class="variable">mContext</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">Activity</span> <span class="variable">mCurrentActivity</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">&quot;JNI&quot;</span>, <span class="string">&quot;onCreate()&quot;</span>);</span><br><span class="line">        mContext = <span class="built_in">this</span>.getApplicationContext();</span><br><span class="line">        mCurrentActivity = <span class="built_in">this</span>;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Unity call part</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">javaMethod</span><span class="params">(String csparam)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;JNI&quot;</span>, <span class="string">&quot;javaMethod() with parameter:&quot;</span> + csparam);</span><br><span class="line">        UnityPlayer.UnitySendMessage(mUnityCallBackHandler,<span class="string">&quot;resUnityMsg&quot;</span>, <span class="string">&quot;java param&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Android/UnityJNICall.png" alt="UnityJNICall"></p>
<p>至此我们成功完成了使用Android Studio通过编写Gradule导出我们需要的jar代码包，然后通过Unity封装的JNI访问java方法并通过Unity的方法UnityPlayer.UnitySendMessage()方法成功返回调用了CS代码。</p>
<p>关于Unity使用AAR的学习:<br>待续……</p>
<p>详细的Android DSL标签学习:<br><a target="_blank" rel="noopener" href="http://google.github.io/android-gradle-dsl/current/index.html">Android Plugin DSL Reference</a><br>详细的Gradle task学习：<br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Task.html">Gradle Task</a></p>
<p>待续……</p>
<h6 id="AAR库模块"><a href="#AAR库模块" class="headerlink" title="AAR库模块"></a>AAR库模块</h6><p>这里再次说一下AAR和Jar的区别：<br>AAR是带了所有资源(包括res，AndroidManifest.xml等APK需要的资源+代码Jar的集合)。</p>
<p>Unity是可以使用AAR作为资源的使用的，导出AAR和Jar没有太多区别，这里注重讲下Unity使用Android Studio导出的Jar需要注意的地方和坑点。</p>
<p>导出Jar的同时其实已经导出了AAR，AAR存在下面这个目录:<br><img src="/img/Android/AndroidAAROutput.png" alt="AndroidAAROutput"></p>
<p>但如果我们直接把res和aar以及AndroidManifest拷贝到Plugins插件目下，打包会发现报错：<br>错误的意思大致是classes.jar代码已存在有重复。</p>
<p>classes.jar代码重复是因为我们前面导出jar的build.gradle配置了:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dependencies &#123;&#125;指定编译依赖信息(比如我们的项目需要依赖unity的classes.jar库)</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// fileTree - 指定目录(libs)下符合条件(*.jar)的文件添加到编译路径下</span></span><br><span class="line">    <span class="function">implementation <span class="title">fileTree</span>(<span class="params">include: [<span class="string">&#x27;*.jar&#x27;</span>], dir: <span class="string">&#x27;libs&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    ******</span></span><br><span class="line"><span class="function">    <span class="comment">// files - 指定需要依赖的库文件(没找到官方解释)</span></span></span><br><span class="line"><span class="function">    implementation <span class="title">files</span>(<span class="params"><span class="string">&#x27;libs/classes.jar&#x27;</span></span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这里的两句implementation，前者是表示libs下的jar作为引用并一起打包输出到aar里，后者表示要引用并一起打包classes.jar库。</p>
<p>所以这里就是导致我们的AAR里有一份classes.jar库代码存在的原因。</p>
<p>改写build.gradle避免classes.jar被一起打包到AAR里:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dependencies &#123;&#125;指定编译依赖信息(比如我们的项目需要依赖unity的classes.jar库)</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// fileTree - 指定目录(libs)下符合条件(*.jar)的文件添加到编译路径下</span></span><br><span class="line">    <span class="comment">// 因为项目依赖了Unity的class.jar但又不希望classes.jar跟着aar一起导出(会导致unity打包报错 -- classes.jar包重复问题)</span></span><br><span class="line">    <span class="comment">// 所以这里不能使用fileTree包含lib目录下所有jar，需要修改成不包含classes.jar的形式</span></span><br><span class="line">    <span class="function">implementation <span class="title">fileTree</span>(<span class="params">include: [<span class="string">&#x27;*.jar&#x27;</span>], dir: <span class="string">&#x27;libs/include&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    ******</span></span><br><span class="line"><span class="function">    <span class="comment">// files - 猜测是显示指定依赖文件(没找到官方解释)</span></span></span><br><span class="line"><span class="function">    <span class="comment">// 这里专门用compileOnly是为了避免classes.jar进aar包</span></span></span><br><span class="line"><span class="function">    compileOnly <span class="title">files</span>(<span class="params"><span class="string">&#x27;libs/exclude/classes.jar&#x27;</span></span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>implementation – Gradle 会将依赖项添加到编译类路径，并将依赖项打包到构建输出<br>compileOnly – Gradle 只会将依赖项添加到编译类路径（即不会将其添加到构建输出）<br>通过修改build.gradle和调整目录：<br><img src="/img/Android/AndroidGradleLibsFolderStructure.png" alt="AndroidGradleLibsFolderStructure"><br>我们避免了classes.jar被打进AAR里，这样一来就不会在Unity打包时有classes.jar代码重复的问题了。</p>
<p>Note:<br><strong>AAR可以通过修改后缀成.zip通过解压软件插件内部详情</strong><br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/build/dependencies">dependencies模块详细说明参考</a></p>
<h3 id="IOS实战"><a href="#IOS实战" class="headerlink" title="IOS实战"></a>IOS实战</h3><p>IOS实战学习前，我们需要了解IOS的开发语言，以前是Objective-C，后来苹果推出了switf。<br>这里针对Unity而言，我们主要用到的还是以Objective-C为主。</p>
<h4 id="Objective-C语法"><a href="#Objective-C语法" class="headerlink" title="Objective-C语法"></a>Objective-C语法</h4><p>*.h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">///所需其他头文件</span><br><span class="line">#import &quot;*.h&quot;</span><br><span class="line"></span><br><span class="line">//&lt;Protocol&gt; OC里的Protocol相当于Interface，需要实现接口方法</span><br><span class="line">//但有一点不同的是Protocol里并不是所有的接口方法都必须实现</span><br><span class="line">//@required -- 必须实现的部分</span><br><span class="line">//@optional -- 可选实现的部分</span><br><span class="line">@interface *:NSObject&lt;*&gt;&#123;</span><br><span class="line"></span><br><span class="line">    // 类变量声明</span><br><span class="line">    //......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//类属性声明</span><br><span class="line">@property (nonatomic, strong) * *属性名;</span><br><span class="line">//Unity回调GameObject名字</span><br><span class="line">@property (nonatomic, strong) NSString *mGameObjectHandler;</span><br><span class="line"></span><br><span class="line">//类方法声明</span><br><span class="line">//+代表属于类方法，相当于静态</span><br><span class="line">//-代表属于对象，相当于类成员</span><br><span class="line">//方法定义格式如下:</span><br><span class="line">//(+ or -)(return 返回类型)方法名:(参数1类型) 参数1名 : (参数2类型) 参数2名;</span><br><span class="line">+(类型*) Instance;</span><br><span class="line"></span><br><span class="line">-(void)方法名;</span><br><span class="line"></span><br><span class="line">-(void)方法名:(参数类型 *)参数名;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>*.mm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;*.h&quot;</span><br><span class="line"></span><br><span class="line">//定义全局的静态变量</span><br><span class="line">static 类型名* 变量名 = nil;</span><br><span class="line"></span><br><span class="line">//声明UnitySendMessage为外部方法，用于native code和C＃发消息交互</span><br><span class="line">#if defined(__cpluscplus)</span><br><span class="line">//确保函数的编译方式</span><br><span class="line">//确保找到正确的函数名</span><br><span class="line">//这一点好比C++指定不同的调用约定(stdcall(C++默认使用)和cdecl(C默认使用))</span><br><span class="line">//会决定函数名生成，参数入栈顺序，堆栈维护等</span><br><span class="line">//在读取的时候也需要指定同样编译方式</span><br><span class="line">extern &quot;C&quot;&#123;</span><br><span class="line">#endif  </span><br><span class="line">    extern void UnitySendMessage(const char *, const char *, const char *);</span><br><span class="line"></span><br><span class="line">#if defined(__cpluscplus)</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">//指定实现的类型</span><br><span class="line">@implementation 类型名</span><br><span class="line"></span><br><span class="line">//获取单例对象</span><br><span class="line">+(返回类型*) Instance</span><br><span class="line">&#123;</span><br><span class="line">    return *;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)方法名</span><br><span class="line">&#123;</span><br><span class="line">    //方法实现</span><br><span class="line">    NSLog(@&quot;initSDK&quot;);</span><br><span class="line">    self.mGameObjectHandler = @&quot;响应原生消息的GameObejct名字&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)方法名:(参数1类型 *)key value:(参数2类型 *)value</span><br><span class="line">&#123;</span><br><span class="line">    //Log打印方式</span><br><span class="line">    NSLog(@&quot;参数设置：key = %@ value = %@&quot;, key,value);</span><br><span class="line">    //字符串拼接方式</span><br><span class="line">    NSString *msg = [NSString stringWithFormat:@&quot;%@ %@ %s&quot;, key, value, issuccess ? &quot;true&quot; : &quot;false&quot;];</span><br><span class="line">    //原生发送消息给CS一侧</span><br><span class="line">    UnitySendMessage([self.mGameObjectHandler UTF8String], &quot;CS回调响应方法名&quot;, [msg UTF8String]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//用于C#和Objective C交互的代码</span><br><span class="line">extern &quot;C&quot;&#123;</span><br><span class="line">    void CS方法名()</span><br><span class="line">    &#123;</span><br><span class="line">        [[类型名 类型静态变量] 成员方法];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void CS方法名(char* key, char* value)</span><br><span class="line">    &#123;</span><br><span class="line">        //CS char*到NSString转换方式</span><br><span class="line">        NSString* parameterkey = [NSString stringWithUTF8String:key];</span><br><span class="line">        NSString* parametervalue = [NSString stringWithUTF8String:value];</span><br><span class="line">        [[类型名 类型静态变量] 成员方法:参数1值 参数2名字:参数2值];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<h4 id="Unity与IOS的交互"><a href="#Unity与IOS的交互" class="headerlink" title="Unity与IOS的交互"></a>Unity与IOS的交互</h4><p>了解Unity与IOS交互前，让我们先了解部分IOS相关概念：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lixiaojian/p/3336653.html">UIView是一个视图,UIViewController是一个控制器,每一个viewController管理着一个view。</a></p>
<p>IOS和UIViewController的交互就好比Android里和Activity的交互。</p>
<p>结合Unity官方讲解:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2017.4/Documentation/Manual/StructureOfXcodeProject.html">Customizing an iOS Splash Screen Other Versions Leave feedback Structure of a Unity XCode Project</a></p>
<p>我们可以知道IOS里，UnityAppController.mm是整个程序的入口。如果我们想要自定义入口，我们需要继承至UnityAppController。<br>AppController.h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 自定义Unity AppCOntroller</span><br><span class="line">//导入Unity的UnityAppController.h，自定义AppController需要继承至UnityAppController</span><br><span class="line">#import &quot;UnityAppController.h&quot;</span><br><span class="line"></span><br><span class="line">@interface AppController : UnityAppController</span><br><span class="line">@property(nonatomic,strong) UINavigationController *naVC;</span><br><span class="line">-(void) createUI;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>AppController.mm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">//自身的头文件</span><br><span class="line">#import &quot;AppController.h&quot;</span><br><span class="line">//导入我们自己写接口的类的.h文件，用于实现自定义的UIViewController</span><br><span class="line">#import &quot;UnityViewController.h&quot;</span><br><span class="line">//其他文件</span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">@implementation AppController</span><br><span class="line">-(void) createUI</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;AppController:createUI()&quot;);</span><br><span class="line">    _rootController = [[UIViewController alloc]init];</span><br><span class="line">    _rootView = [[UIView alloc]initWithFrame:[UIScreen mainScreen].bounds];</span><br><span class="line">    _rootController.view = _rootView;</span><br><span class="line">        </span><br><span class="line">    //自定义viewcontroller添加到现有的viewcontroller上</span><br><span class="line">    UnityViewController *vc = [[UnityViewController alloc]init];</span><br><span class="line">    self.naVC =[[UINavigationController alloc]initWithRootViewController:vc];</span><br><span class="line">    </span><br><span class="line">    //添加自定义view到rootView上</span><br><span class="line">    [_rootView addSubview:self.naVC.view];</span><br><span class="line"></span><br><span class="line">    _window.rootViewController = _rootController;</span><br><span class="line">    [_window bringSubviewToFront:_rootView];</span><br><span class="line">    [_window makeKeyAndVisible];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//这是一个固定写法，因为这个代码，所以启动界面是从这里启动</span><br><span class="line">IMPL_APP_CONTROLLER_SUBCLASS(AppController);</span><br></pre></td></tr></table></figure>
<p>通过上面的代码，我们完成了下面两件事：</p>
<ol>
<li>自定义Unity IOS程序入口</li>
<li>添加了自定义的View(绑定到自定义UIViewController上)到rootView上</li>
</ol>
<p>成功绑定到自定义UIViewController上后，我们就能通过自定义的UIViewController去和IOS打交道了。<br>接下来看看自定义的UIViewController是如何定义的，结合权限申请实战学习：<br>UnityViewController.h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//自定义的UIViewController</span><br><span class="line">#import &quot;UnityAppController.h&quot;</span><br><span class="line"></span><br><span class="line">@interface UnityViewController : UIViewController</span><br><span class="line">//权限申请</span><br><span class="line">- (void)audioAuthAction;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>UnityViewController.mm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">//包含自身头文件</span><br><span class="line">#import &quot;UnityViewController.h&quot;</span><br><span class="line"></span><br><span class="line">//其他头文件</span><br><span class="line">#import &quot;UnityAppController+ViewHandling.h&quot;</span><br><span class="line">#import &lt;UI/UnityView.h&gt;</span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &lt;AVFoundation/AVFoundation.h&gt;</span><br><span class="line"></span><br><span class="line">@implementation UnityViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;UnityViewController:viewDidLoad()&quot;);</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    [self.view addSubview:GetAppController().unityView];</span><br><span class="line">    GetAppController().unityView.frame = self.view.frame;</span><br><span class="line">    </span><br><span class="line">    // Do any additional setup after loading the view.</span><br><span class="line">    // 权限申请相关</span><br><span class="line">    [self audioAuthAction];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//权限申请</span><br><span class="line">- (void)audioAuthAction</span><br><span class="line">&#123;</span><br><span class="line">    //麦克风权限申请</span><br><span class="line">    NSLog(@&quot;UnityViewController:audioAuthAction()&quot;);</span><br><span class="line">    [AVCaptureDevice requestAccessForMediaType:AVMediaTypeAudio completionHandler:^(BOOL granted) &#123;</span><br><span class="line">       NSLog(@&quot;%@&quot;,granted ? @&quot;麦克风准许&quot;:@&quot;麦克风不准许&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)viewWillAppear:(BOOL)animated&#123;</span><br><span class="line">    //隐藏导航条view</span><br><span class="line">    NSLog(@&quot;UnityViewController:viewWillAppear()&quot;);</span><br><span class="line">    self.navigationController.navigationBar.hidden = YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)viewDidDisappear:(BOOL)animated</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;UnityViewController:viewDidDisappear()&quot;);</span><br><span class="line">    self.navigationController.navigationBar.hidden = NO;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>可以看到通过自定义的UIViewController，我们就可以直接编写对应原生功能(e.g. 权限申请)代码了。</p>
<h4 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2017.4/Documentation/Manual/StructureOfXcodeProject.html">Customizing an iOS Splash Screen Other Versions Leave feedback Structure of a Unity XCode Project</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vsirWaiter/p/8383408.html">Unity-IOS交互整理</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/bd944258105f">iOS 系统权限</a></p>
<p>待续……</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Unity-Official-Website-Part"><a href="#Unity-Official-Website-Part" class="headerlink" title="Unity Official Website Part"></a>Unity Official Website Part</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Plugins.html">Unity Plugin</a></p>
<h2 id="Knowledge-Part"><a href="#Knowledge-Part" class="headerlink" title="Knowledge Part"></a>Knowledge Part</h2><p><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/cb05698a1968">关于Android的.so文件你所需要知道的</a><br><a target="_blank" rel="noopener" href="http://linux-wiki.cn/wiki/zh-hans/%E5%8A%A8%E6%80%81%E5%BA%93(.so)">动态库(.so)</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/index.html">Getting Started with the NDK</a><br><a target="_blank" rel="noopener" href="http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/readelf.html">readelf elf文件格式分析</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/abis.html">ABI Management</a><br><a target="_blank" rel="noopener" href="https://android-developers.googleblog.com/2016/06/android-changes-for-ndk-developers.html">Android changes for NDK developers </a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">可执行文件（ELF）格式的理解</a><br><a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0101a/DUI0101A_Elf.pdf">ARM ELF File Format</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Native/">Native</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Native/">Native</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/11/Unity第三方插件/" title="Unity第三方插件" itemprop="url">Unity第三方插件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-12-11T15:46:11.000Z" itemprop="datePublished"> 发表于 2016-12-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Unity第三方插件"><a href="#Unity第三方插件" class="headerlink" title="Unity第三方插件"></a>Unity第三方插件</h1><p>本章节主要讲解学习Unity第三方工具插件(比如NGUI，Dotween，2DToolkit……)。</p>
<h2 id="NGUI"><a href="#NGUI" class="headerlink" title="NGUI"></a>NGUI</h2><p>NGUI是C#写的第三方插件，堪称Unity 4.6之前最完美的GUI解决方案(NGUI 2.7及之前貌似是免费)，复杂的UI都能在一个Draw Call完成渲染。<br>出于学习目的下载NGUI 2.7试试：<br><a target="_blank" rel="noopener" href="http://forum.unity3d.com/threads/ngui-free-edition.124032/">NGUI 2.7 Download</a><br>一下学习都是基于NGUI 2.7版本学习的，新的版本特性这里没有涉及到。</p>
<h3 id="Tutorials"><a href="#Tutorials" class="headerlink" title="Tutorials"></a>Tutorials</h3><p><a target="_blank" rel="noopener" href="http://www.tasharen.com/?page_id=197">以下学习参考</a></p>
<h4 id="Creating-Your-UI"><a href="#Creating-Your-UI" class="headerlink" title="Creating Your UI"></a>Creating Your UI</h4><p>这里就不再一一讲述步骤了，主要记录一些重要的概念。<br>先来看看我们创建出UI之后的UI层次结构：<br><img src="/img/Unity/NGUIUIHierachy.PNG" alt="NGUIUIHierachy"><br>看看各组成部分的作用：</p>
<ol>
<li>UI Root<br>上面挂载UIRoot Script，这个脚本的主要目的是把所有挂载在UI Root下的object 所在屏幕比例根据屏幕大小变化而变化<br><a target="_blank" rel="noopener" href="http://www.tasharen.com/?page_id=619">When attached to the root object of the UI, it will scale that object by the inverse of the screen’s height, thus maintaining a 1 pixel &#x3D; 1 unit ratio, ensuring pixel-perfect UIs.</a><br>UIStretch – <a target="_blank" rel="noopener" href="http://www.tasharen.com/?page_id=619">This script is capable of stretching the widget relative to the size of the screen (or, if specified — panel or widget size).</a><br>UIStretch是自适应的关键，根据屏幕或特定panel长宽变化去做适应。但后来的NGUI版本好像对自适应这一块做了很大修改，UIStretch貌似不再支持。</li>
<li>Camera<br>上面挂载了UICamera Script，这个脚本的主要目的是”contains NGUI’s event system”，至于消息是如何传递的这里先暂时不管，以后会深入学习。</li>
<li>Anchor<br>上面挂载了UIAnchor Script，这个脚本的主要目的是”apply a half-pixel offset on Windows machines, for pixel-perfect results.”(把UI限定在窗口特定位置，当窗口变化的时候会依然处于相对窗口的位置)</li>
<li>Panel<br>上面挂载了UIPanel，这个脚本的主要目的是”container that will collect all UI widgets under it and will combine them into as few draw calls as possible.”(这里相当于UI的管理容器，负责以最少的draw call去管理UI)</li>
</ol>
<h4 id="Sprite"><a href="#Sprite" class="headerlink" title="Sprite"></a>Sprite</h4><p>创建了UI，那么接下来就是增加我们的UI组件。<br>通过Widget Tool可以创建一系列不同类型的组件，这里有两个概念比较重要。<br>Atlas(图集) – Atlas好比我们的图片库，因为组件会需要选择图案，而Atlas定义了切割好的图集可供选择<br>Font(字体库) – 正如其名，字体库，至于字体库是怎么制作的这里暂时不得而知(待学习)<br>让我们简单看一下创建一个Sprite后的显示面板：<br><img src="/img/Unity/SpriteControlPanel.PNG" alt="SpriteControlPanel"><br>这里Sprite有深度的概念，通过调节Depth我们可以实现层次排序。<br>还值得注意的一点是Sprite有个属性Sprite Type，这里的Sprite Type不仅可以决定Sprite如何显示，还会影响Sprite如何去适应显示区域。</p>
<h5 id="9-Sliced-Sprite"><a href="#9-Sliced-Sprite" class="headerlink" title="9-Sliced Sprite"></a>9-Sliced Sprite</h5><p>Sliced技术会决定如何去拉伸图案去适应显示区域而不至于看起来变形。<br><a target="_blank" rel="noopener" href="http://www.unityrealm.com/unity-9-slice-advantages/">9-Sliced详解</a></p>
<h5 id="Tiled-Sprite"><a href="#Tiled-Sprite" class="headerlink" title="Tiled Sprite"></a>Tiled Sprite</h5><p>Tiled Sprite是用原始sprite大小去铺满显示区域</p>
<p>Note:<br>这里有一个官网说是显示Debug Info的东西，通过把Panel的Debug Info设置成Geometry，场景里会增加一个叫_UIDrawCall的对象。<br><img src="/img/Unity/UIDrawCall.PNG" alt="UIDrawCall"><br>(这里还不太明白是什么，但看起来是把UI更新整合到一个Draw Call里了)</p>
<h4 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h4><p>Lable里的字来源于我们之前选的字库。<br>在Label里填写文本有个比较方便的设定，可以通过[hex color]改变后续文本的颜色e.g. [FF0000]代表红色。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FF0000</span>]NGUI<span class="string">&#x27;s [FFFFFF]lables can have [00FF00]embedded </span></span><br><span class="line"><span class="string">[0000FF]colors.</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/LabelFont.PNG" alt="LabelFont"></p>
<h4 id="Button"><a href="#Button" class="headerlink" title="Button"></a>Button</h4><p>当我们添加了Button后，如何响应事件了？<br>“anything with a collider on it will receive all of the events.”</p>
<p>还记得之前说UICamera负责发送所有事件吗？所有在Camera(绑定了UICamera)下的UI都会接受到Event(前提是设置了event发送到UI层)。<br>让我们来看下UICamera的一些public可控变量：<br><img src="/img/Unity/UICameraPanel.PNG" alt="UICameraPanel"><br>让我们关注一些比较重要的点：<br>Event Receive Mask – 控制了接受events的layer层<br>Debug – debug模式下可以让我们看到哪一个game objec<br>t接收到了event<br>Range Distance – 控制raycast的有效范围<br>Scroll Axis Name – 设定横向控制来源<br>Vertical Axis Name – 设定纵向控制来源<br>……</p>
<p>接下来让我们看看UICamera都负责发送哪些事件？(具体可以参见UICamera源码)<br>    OnHover (isOver) is sent when the mouse hovers over a collider or moves away.<br>    OnPress (isDown) is sent when a mouse button gets pressed on the collider.<br>    OnSelect (selected) is sent when a mouse button is first pressed on a game object. Repeated presses on the same object won’t result in a new OnSelect.<br>    OnClick () is sent with the same conditions as OnSelect, with the added check to see if the mouse has not moved much. UICamera.currentTouchID tells you which button was clicked.<br>    OnDoubleClick () is sent when the click happens twice within a fourth of a second. UICamera.currentTouchID tells you which button was clicked.<br>    OnDragStart () is sent to a game object under the touch just before the OnDrag() notifications begin.<br>    OnDrag (delta) is sent to an object that’s being dragged.<br>    OnDragOver (draggedObject) is sent to a game object when another object is dragged over its area.<br>    OnDragOut (draggedObject) is sent to a game object when another object is dragged out of its area.<br>    OnDragEnd () is sent to a dragged object when the drag event finishes.<br>    OnInput (text) is sent when typing (after selecting a collider by clicking on it).<br>    OnTooltip (show) is sent when the mouse hovers over a collider for some time without moving.<br>    OnScroll (float delta) is sent out when the mouse scroll wheel is moved.<br>    OnKey (KeyCode key) is sent when keyboard or controller input is used.</p>
<p>那么知道了发送哪些事件，那么我们如何通过添加的控件去响应事件了？</p>
<ol>
<li>控件要处于Camera(含UICamera脚本)之下</li>
<li>Layer处于UICamera的Event Receiver Mask</li>
<li>接受事件的控件必须包含Collider</li>
<li>自定义响应方法<ol>
<li>定义对应事件响应的方法并挂载到需要响应的Game Object上</li>
</ol>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnPress</span>(<span class="params"><span class="built_in">bool</span> isPressed</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(isPressed)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;Exit button is pressed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;Exit button is unpressed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>2. 通过UIListener，直接添加delegate去监听事件
</code></pre>
<p>首先现在需要实现delegate监听事件的控件上添加一个UIListener脚本(Component -&gt; NGUI -&gt; Internal -&gt; Event Listener)。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UIListener Soure Code</span></span><br><span class="line"><span class="comment">//----------------------------------------------</span></span><br><span class="line"><span class="comment">//            NGUI: Next-Gen UI kit</span></span><br><span class="line"><span class="comment">// Copyright © 2011-2013 Tasharen Entertainment</span></span><br><span class="line"><span class="comment">//----------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Event Hook class lets you easily add remote event listener functions to an object.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Example usage: UIEventListener.Get(gameObject).onClick += MyClickFunction;</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line">[<span class="meta">AddComponentMenu(<span class="string">&quot;NGUI/Internal/Event Listener&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIEventListener</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">VoidDelegate</span> (<span class="params">GameObject go</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">BoolDelegate</span> (<span class="params">GameObject go, <span class="built_in">bool</span> state</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">FloatDelegate</span> (<span class="params">GameObject go, <span class="built_in">float</span> delta</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">VectorDelegate</span> (<span class="params">GameObject go, Vector2 delta</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">StringDelegate</span> (<span class="params">GameObject go, <span class="built_in">string</span> text</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">ObjectDelegate</span> (<span class="params">GameObject go, GameObject draggedObject</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">KeyCodeDelegate</span> (<span class="params">GameObject go, KeyCode key</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> parameter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> VoidDelegate onSubmit;</span><br><span class="line">    <span class="keyword">public</span> VoidDelegate onClick;</span><br><span class="line">    <span class="keyword">public</span> VoidDelegate onDoubleClick;</span><br><span class="line">    <span class="keyword">public</span> BoolDelegate onHover;</span><br><span class="line">    <span class="keyword">public</span> BoolDelegate onPress;</span><br><span class="line">    <span class="keyword">public</span> BoolDelegate onSelect;</span><br><span class="line">    <span class="keyword">public</span> FloatDelegate onScroll;</span><br><span class="line">    <span class="keyword">public</span> VectorDelegate onDrag;</span><br><span class="line">    <span class="keyword">public</span> ObjectDelegate onDrop;</span><br><span class="line">    <span class="keyword">public</span> StringDelegate onInput;</span><br><span class="line">    <span class="keyword">public</span> KeyCodeDelegate onKey;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnSubmit</span> ()</span>                &#123; <span class="keyword">if</span> (onSubmit != <span class="literal">null</span>) onSubmit(gameObject); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnClick</span> ()</span>                 &#123; <span class="keyword">if</span> (onClick != <span class="literal">null</span>) onClick(gameObject); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDoubleClick</span> ()</span>           &#123; <span class="keyword">if</span> (onDoubleClick != <span class="literal">null</span>) onDoubleClick(gameObject); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnHover</span> (<span class="params"><span class="built_in">bool</span> isOver</span>)</span>      &#123; <span class="keyword">if</span> (onHover != <span class="literal">null</span>) onHover(gameObject, isOver); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnPress</span> (<span class="params"><span class="built_in">bool</span> isPressed</span>)</span>   &#123; <span class="keyword">if</span> (onPress != <span class="literal">null</span>) onPress(gameObject, isPressed); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnSelect</span> (<span class="params"><span class="built_in">bool</span> selected</span>)</span>   &#123; <span class="keyword">if</span> (onSelect != <span class="literal">null</span>) onSelect(gameObject, selected); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnScroll</span> (<span class="params"><span class="built_in">float</span> delta</span>)</span>     &#123; <span class="keyword">if</span> (onScroll != <span class="literal">null</span>) onScroll(gameObject, delta); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDrag</span> (<span class="params">Vector2 delta</span>)</span>     &#123; <span class="keyword">if</span> (onDrag != <span class="literal">null</span>) onDrag(gameObject, delta); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDrop</span> (<span class="params">GameObject go</span>)</span>     &#123; <span class="keyword">if</span> (onDrop != <span class="literal">null</span>) onDrop(gameObject, go); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnInput</span> (<span class="params"><span class="built_in">string</span> text</span>)</span>      &#123; <span class="keyword">if</span> (onInput != <span class="literal">null</span>) onInput(gameObject, text); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnKey</span> (<span class="params">KeyCode key</span>)</span>        &#123; <span class="keyword">if</span> (onKey != <span class="literal">null</span>) onKey(gameObject, key); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Get or add an event listener to the specified game object.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> UIEventListener <span class="title">Get</span> (<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UIEventListener listener = go.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        <span class="keyword">if</span> (listener == <span class="literal">null</span>) listener = go.AddComponent&lt;UIEventListener&gt;();</span><br><span class="line">        <span class="keyword">return</span> listener;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出通过UIListener，该控件已经具备了响应UI Event的能力，而且每一个UI Event都定义了对应的delegate，这样一来我们就可以通过动态的添加修改每一个UI event的delegate实现控制UI Event响应了。<br>那么接下来我们只需在任何一个Game Object挂载下列代码就能响应特定控件的特定UI事件了。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RemoveExitButtonListener</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        GameObject exitbutton = GameObject.Find(<span class="string">&quot;UI Root (2D)/Camera/Anchor/Panel/Exit&quot;</span>);</span><br><span class="line">        <span class="comment">// 这里的回调方法要和delegate签名一致</span></span><br><span class="line">        UIEventListener.Get(exitbutton).onPress = RemoteExitButtonClick;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RemoteExitButtonClick</span>(<span class="params">GameObject go, <span class="built_in">bool</span> state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;RemoteExitButtonClick button is pressed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;RemoteExitButtonClick button is unpressed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIEventCall.PNG" alt="UIEventCall"><br>同时NGUI还为Button控制添加了很多可自定义的脚本：</p>
<ol>
<li>UIButton – 自定义控件被点击或处于控件之上等颜色信息</li>
<li>UIButtonScale – 自定义焦点处于控件之上时的scale变换</li>
<li>UIButtonOffset – 自定义控件被点击后的位移</li>
<li>UIButtonSound – 自定义控件被点击时播放的声音</li>
<li>UIButtonMessage – 自定义控件触发事件</li>
<li>UIButtonTween – 自定义控件触发tween</li>
<li>UIButtonPlayAnimation – 自定义控件触发动画</li>
</ol>
<h4 id="Slider"><a href="#Slider" class="headerlink" title="Slider"></a>Slider</h4><p>通过传递接受Slider Event的Game Object，我们可以去对应物体上定义OnSliderChange(float stepvalue)去响应slider事件，这样一来响应了Slider Event的物体就可以根据Slider的拖拽去做对应的事情了。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DisplayTextListener</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector3 m_OriginalPosition;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        <span class="comment">// 这里获取的postion不是世界坐标系的，不知道为什么</span></span><br><span class="line">        m_OriginalPosition = transform.position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnSliderChange</span>(<span class="params"><span class="built_in">float</span> stepvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Vector3 temp = m_OriginalPosition;</span><br><span class="line">        temp.y *= stepvalue;</span><br><span class="line">        transform.position = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/OnSliderChangeBegin.PNG" alt="OnSliderChangeBegin"><br><img src="/img/Unity/OnSliderChangeEnd.PNG" alt="OnSliderChangeEnd"></p>
<h4 id="Checkbox"><a href="#Checkbox" class="headerlink" title="Checkbox"></a>Checkbox</h4><p>通过把一组Checkbox放到同一个Game Object，然后设定所有UICheckbox的Radio Button Root到同一个Game Object可以实现一组单选按钮。<br>然后通过添加UICheckboxControlledComponent到Checkbox上，我们可以指定当该Checkbox激活或未激活时去enable的Game Object(做到根据Checkbox状态响应)。<br><img src="/img/Unity/CheckBoxWithWrongAnswer.PNG" alt="CheckBoxWithWrongAnswer"><br><img src="/img/Unity/CheckBoxWithCorrectAnswer.PNG" alt="CheckBoxWithCorrectAnswer"></p>
<h4 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h4><p>Label要具有而输入的特性需要确保以下几点：</p>
<ol>
<li>父节点或自身包含Box Collider</li>
<li>父节点或自身包含UIInput Script(所有的Input相关的东西都抽象到这里了e.g. IME，键盘弹出，平台相关输入等)</li>
<li>指定需要增加Input功能的Laybel到UIInput的Laybel属性<br>Note：<br>两者必须都在同一个Game Object上才能起作用，因为UIInput要通过Box Collider去接收OnSelect等事件。</li>
</ol>
<p>NGUI为我们提供了方便的控件类，Input – 直接用于创建可接收输入的Laybel模板<br><img src="/img/Unity/InputUsing.PNG" alt="InputUsing"></p>
<h4 id="3D"><a href="#3D" class="headerlink" title="3D"></a>3D</h4><p>将2D UI变换到3D UI很容易。<br>步骤如下：</p>
<ol>
<li>去掉Anchor，直接把panel挂载在UIRoot(2D)上<br>还记得最初创建NGUI UI的时候Anchor上面挂载的UIAnchor Script的作用吗？因为变换到3D后我们不需要在控制相对窗口的位置，所以不需要UIAnchor了。</li>
<li>设置Camera的投影方式到Perspective(为了3D显示)<br>就这么简单，通过这样设置后，UI就完全当做3D Game Object显示在scene里了。<br><img src="/img/Unity/3DUI.PNG" alt="3DUI"></li>
</ol>
<h4 id="Atlas-Maker"><a href="#Atlas-Maker" class="headerlink" title="Atlas Maker"></a>Atlas Maker</h4><p>声明：后续用到的UI素材来源于COC，仅用于学习目的。<br>首先要知道为什么要使用图集？<br>减少纹理的使用，比如当多个材质只是纹理不同的时候，我们可以合并纹理到一个大的纹理，给材质指定对应的UV坐标即可。另外合并多个小的纹理到大的纹理图集也可以减少Memory使用。详情见<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Texture_atlas">Texture atlas</a>。<br>这一节讲一下图集的制作。</p>
<ol>
<li>准备好所有图片素材(可以通过PS等工具制作)</li>
<li>打开NGUI Atlas Maker<br>NGUI -&gt; Open the Altas Maker</li>
<li>设置一个Atlas名字，点击Create，选中要放到一张图集里的所有纹理图片，然后等Altas Maker切割完成后点击Add&#x2F;Update All<br><img src="/img/Unity/AtlasMaker.PNG" alt="AtlasMaker"><br><img src="/img/Unity/UIAtlas.PNG" alt="UIAtlas"><br>Note:<br>NGUI也支持导入Texture Packer导出的文件<br>NGUI Atlas Maker支持多种图片格式(e.g. PNG, psd……)<br>一旦Sprite导入并生成UI Atlas后，我们可以直接在Atlas Maker里添加并更新该Atlas即可。</li>
</ol>
<h4 id="Font-Maker"><a href="#Font-Maker" class="headerlink" title="Font Maker"></a>Font Maker</h4><p>Font Maker里的字体是由什么制作而来的了？<br>“All fonts are created using the free BMFont program, or the more advanced Glyph Designer.”(NGUI使用的Font是由BMFont program或Glyph Designer制作的)</p>
<p>那么BMFont program又是什么了？<br><a target="_blank" rel="noopener" href="http://www.angelcode.com/products/bmfont/">This program will allow you to generate bitmap fonts from TrueType fonts. The application generates both image files and character descriptions that can be read by a game for easy rendering of fonts.</a>BMFont program通过TrueType fonts生成bitmap fonts(一个是Font的image file文件，一个是描述了每一个字符渲染所需的信息文件))</p>
<p>那么这里提到了两个概念：</p>
<ol>
<li><p>TrueType Font<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/TrueType">TrueType is an outline font</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_font#OUTLINE">Outline fonts (also called vector fonts) use Bézier curves, drawing instructions and mathematical formulae to describe each glyph, which make the character outlines scalable to any size.</a><br>可以看出TrueType是outline font，outline font是一种vector font(可以理解成矢量字体，放大缩小不会出现锯齿和模糊。之所以称作vector font是因为TrueType记录每一个字符的轮廓信息，通过这些信息可以计算出如何绘制字符)<br>以下引用至<a target="_blank" rel="noopener" href="http://computer.howstuffworks.com/question460.htm">What are TrueType fonts?</a><br>TrueType technology actually involves two parts:<br>The TrueType Rasterizer<br>TrueType fonts – “The fonts themselves contain data that describes the outline of each character in the typeface. “</p>
</li>
<li><p>Bitmap Font<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_font#OUTLINE">Bitmap fonts consist of a matrix of dots or pixels representing the image of each glyph in each face and size.</a><br>可以看出Bitmap Font是记录的每一个字符的像素和位置等信息。<br>以下引用至<a target="_blank" rel="noopener" href="https://71squared.com/blog/what-is-a-bitmap-font">What is a Bitmap Font?</a><br>A bitmap font is essentially an image file containing a bunch of characters and a control file detailing the size and location of each character within the image. Each character is represented by a number of dots or pixels, rendered in a particular font and size.<br>可以看出Bitmap Font包含两部分：</p>
</li>
<li><p>Image file – 包含了所有文字的纹理图片</p>
</li>
<li><p>Control file – 包含了字体大小，每一个字符所在位置等信息<br>Bitmap Font因为不是outline font(vector font)，所以在字体拉伸变换的时候会出现失真的情况。<br>既然这样我们为什么还要使用Bitmap Font了？<br><a target="_blank" rel="noopener" href="https://71squared.com/blog/what-is-a-bitmap-font">OpenGL itself doesn’t even understand fonts(e.g. vector font), so in order to display text in your game you would need to use whats known as a bitmap font.</a><br>当计算去利用vector font渲染字体的时候，不会失真。但是在游戏里，如果我们还想对vector font做进一步的处理就显得心有余而力不足了。<br><a target="_blank" rel="noopener" href="https://71squared.com/blog/what-is-a-bitmap-font">The major benefit of using bitmap fonts is that each character can be pre-rendered using multiple effects, loaded into OpenGL as a texture, and rendered to the screen using very little resources.</a><br>但Bitmap Font不一样，Bitmap Font存储的就是字体的纹理图片，纹理图片在OpenGL里做额外的效果处理就容易的多了。</p>
</li>
</ol>
<p>说了这么多让我们看看BMFon program是如何制作Bitmap Font的？</p>
<ol>
<li>下载BitMap Font Program<br><a target="_blank" rel="noopener" href="http://www.angelcode.com/products/bmfont/">Bitmap Font Program Download Link</a></li>
<li>通过Font Settings我可以选择我们要导入的ttf字库，是否采用unicode编码等。</li>
<li>然后选中我们要导出的字符集(这里主要选择了英文和中文字符集)<br><img src="/img/Unity/BMFontMakerFontSetting.PNG" alt="BMFontMakerFontSetting"></li>
<li>设置export option，为导出的文件设置相关配置<br><img src="/img/Unity/BMFontExportOptions.PNG" alt="BMFontExportOptions"><br>Note：<br><a target="_blank" rel="noopener" href="http://www.angelcode.com/products/bmfont/doc/export_options.html">If you’re importing colored icons, or planning on using post processing to add colors to the characters, then you’ll want to choose the 32bit format, otherwise the 8bit format may be sufficient.</a><br>官网提到如果要后期再对字符做颜色等处理，需要选择32bit的存储模式(应该是为了能存储颜色信息)<br>同时File Format会决定我们导出的字符集纹理图片和Font descriptor的格式。<br>为了将字符都导出到一张纹理图片我们需要定义合适的Texture Size。</li>
<li>最后点击存储为Bitmap导出字符集(Option -&gt; Save Bitmap Font As)<br>这里就会生成对应的字符集纹理图片和Font Descriptor文件。<br><img src="/img/Unity/MyAtlasFont.PNG" alt="MyAtlasFont"><br>Note:<br>但我发现由于包含了大量中文字符，字符纹理比较大，包括中文和英文就有10M了，如果文字比较多比如做本地化，静态字体(我们这里提前生成字符集纹理就是静态字体)不适合。</li>
</ol>
<p>NGUI支持动态字体的生成：<br>让我们先看看什么是动态字体？<br>“When you set the Characters drop-down in the Import Settings to Dynamic, Unity will not pre-generate a texture with all font characters. Instead, it will use the FreeType font rendering engine to create the texture on the fly.”(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/class-Font.html">https://docs.unity3d.com/Manual/class-Font.html</a>)<br>可以看出动态字体不需提前生成字符集纹理，而是通过导入的ttf动态的在游戏里生成对应字体纹理。这样做的好处就是减少了像静态字体这样的纹理内存开销，我们只需指定使用哪些ttf并确保用户包含了该ttf就能正确显示所有语言。<br>个人认为动态字体是本地化的一个解决方案。<br>动态字体直接从ttf文件生成。<br><img src="/img/Unity/DynamicFont.PNG" alt="DynamicFont"><br>Note:<br>值得注意的是动态字体下写的那个警告”Please note that dynamic fonts can’t be made a part of an atlas, and they will always be draw in a speparate draw call. You will need to adjust transform position’s Z rather than depth.”<br>使用动态字体后会增加一个draw call，而且动态字体的深度不再是有depth来控制而是z值。</p>
<p>Bitmap Font制作好了，那么接下来我就应该用制作好的Bitmap Font去通过Font Maker制作我们的字符集(Atlas)了。</p>
<ol>
<li>打开Font Maker</li>
<li>选定我们刚才制作的Font Texture和Font Descriptor作为输入，指定生成的字符集名字</li>
<li>点击创建<br><img src="/img/Unity/FontMakerProcess.PNG" alt="FontMakerProcess"></li>
</ol>
<p>这里看一下用自己制作的字体集和UI图片集做的登陆界面：<br><img src="/img/Unity/LoginScene.PNG" alt="LoginScene"></p>
<h4 id="NGUI-2-7屏幕自适应"><a href="#NGUI-2-7屏幕自适应" class="headerlink" title="NGUI 2.7屏幕自适应"></a>NGUI 2.7屏幕自适应</h4><p>下文主要参考：<br><a target="_blank" rel="noopener" href="http://dsqiu.iteye.com/blog/1964679">NGUI所见即所得之UIRoot</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/cqgreen/p/3348154.html">Unity3d + NGUI 的多分辨率适配</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/onerain88/article/details/11713299">Unity3D开发（一）：NGUI之UIRoot屏幕分辨率自适应 </a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/2536">NGUI研究院之自适应屏幕（十）</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/cqgreen/p/3348154.html">Unity3d + NGUI 的多分辨率适配</a><br>屏幕自适应是UI在所难免会遇到的问题。<br>那么为什么需要做屏幕自适应了？<br>美术在做UI的时候，程序需要确定我们资源的最基本的分辨率，比如我们是基于1024 * 768（1.3333比例）。<br>在屏幕分辨率为1024 * 768(1.333比例)的时候完美显示如下：<br><img src="/img/Unity/1024Multiple768.PNG" alt="1024Multiple768"><br>当我们把屏幕分辨率设置成800 * 800(1.0比例)的时候显示如下：<br><img src="/img/Unity/800Multiple800.PNG" alt="800Multiple800"><br>当我们把屏幕分辨率设置成960 * 640(1.5比例)的时候显示如下：<br><img src="/img/Unity/960Multiple640.PNG" alt="960Multiple640"><br>Note:<br>UIRoot的Manual Height设置为768，Scaling Stype为FixedSize(后续会讲到UIRoot的缩放自适应原理)<br>从上面可以看出当分辨率比例降低的时候，会出现图像显示不全，这是因为NGUI是基于高度去缩放的。(后续会详细讲解)<br>所以当比例从1.33变到1.0的时候，768&#x2F;800&#x3D;0.96的缩放比例，宽度应该是1024&#x2F;0.96&#x3D;1066.66大于800这也就是为什么会出现图像显示不全的原因了。<br>再来看看从1.33变到1.5的时候，同理768&#x2F;640&#x3D;1.2缩放比例，宽度应该是1024&#x2F;1.2&#x3D;853.33小于960这也就是为什么会出现宽度铺不满的情况。<br>所以在这个时候为了不去做多套不同分辨率的资源去适应各种分辨率的机型，我们需要使用NGUII里的自适应。<br>当下移动设备的主流分辨率，数据来源<a target="_blank" rel="noopener" href="http://djt.qq.com/article/view/399">腾讯分析移动设备屏幕分辨率分析报告</a>：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">iOS设备的分辨率主要有：</span><br><span class="line">宽　  高   宽高比</span><br><span class="line"><span class="number">960</span>     <span class="number">640</span>     <span class="number">1.5</span></span><br><span class="line"><span class="number">1136</span>    <span class="number">640</span>     <span class="number">1.775</span></span><br><span class="line"><span class="number">1024</span>    <span class="number">768</span>     <span class="number">1.3333</span></span><br><span class="line"><span class="number">2048</span>    <span class="number">1536</span>    <span class="number">1.3333</span></span><br><span class="line"> </span><br><span class="line">Android设备的分辨率则相对纷杂，主流的分辨率有：</span><br><span class="line">宽   高   宽高比</span><br><span class="line"><span class="number">800</span>     <span class="number">480</span>     <span class="number">1.6667</span></span><br><span class="line"><span class="number">854</span>     <span class="number">480</span>     <span class="number">1.7792</span></span><br><span class="line"><span class="number">1280</span>    <span class="number">720</span>     <span class="number">1.7778</span></span><br><span class="line"><span class="number">960</span>     <span class="number">540</span>     <span class="number">1.7778</span></span><br><span class="line"><span class="number">1280</span>    <span class="number">800</span>     <span class="number">1.6</span></span><br><span class="line"><span class="number">960</span>     <span class="number">640</span>     <span class="number">1.5</span></span><br><span class="line"><span class="number">1184</span>    <span class="number">720</span>     <span class="number">1.6444</span></span><br><span class="line"><span class="number">1920</span>    <span class="number">1080</span>    <span class="number">1.7778</span></span><br></pre></td></tr></table></figure>

<p>那么让我们进入正题，NGUI是如何实现屏幕自适应的了？<br>这里有三个最重要的脚本需要学习：</p>
<ol>
<li>UIRoot</li>
<li>UIStretch</li>
<li>Anchor<br>让我们先来看看UIRoot的界面：<br><img src="/img/Unity/UIRootPanel.PNG" alt="UIRootPanel"><br>还记得之前提到UIRoot的功能吗？<br><a target="_blank" rel="noopener" href="http://www.tasharen.com/?page_id=185">This script rescales the object it’s on to be 2&#x2F;ScreenHeight in size, letting you specify widget coordinates in pixels and still have them be relatively small when compared to the rest of your game world.</a><br>可以看出UIRoot通过scale UIRoot到2&#x2F;ScreenHeight比例后，使得所有控件的坐标与像素一一对应。那么为什么这样能实现控件坐标与像素一一对应了？这个问题后面会讲到。<br>让我们先分别看看具体参数的含义:<br>Scaling Style</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> Scaling</span><br><span class="line">&#123;</span><br><span class="line">    PixelPerfect,</span><br><span class="line">    FixedSize,</span><br><span class="line">    FixedSizeOnMobiles,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而已看出NGUI 2.7给我们提供了3种scale方式。<br>那么三种方式是如何起作用的了？</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> activeHeight</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> height = Mathf.Max(<span class="number">2</span>, Screen.height);</span><br><span class="line">        <span class="keyword">if</span> (scalingStyle == Scaling.FixedSize) <span class="keyword">return</span> manualHeight;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_IPHONE || UNITY_ANDROID</span></span><br><span class="line">        <span class="keyword">if</span> (scalingStyle == Scaling.FixedSizeOnMobiles)</span><br><span class="line">            <span class="keyword">return</span> manualHeight;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (height &lt; minimumHeight) <span class="keyword">return</span> minimumHeight;</span><br><span class="line">        <span class="keyword">if</span> (height &gt; maximumHeight) <span class="keyword">return</span> maximumHeight;</span><br><span class="line">        <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mTrans != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> calcActiveHeight = activeHeight;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (calcActiveHeight &gt; <span class="number">0f</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> size = <span class="number">2f</span> / calcActiveHeight;</span><br><span class="line">            </span><br><span class="line">            Vector3 ls = mTrans.localScale;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!(Mathf.Abs(ls.x - size) &lt;= <span class="built_in">float</span>.Epsilon) ||</span><br><span class="line">                !(Mathf.Abs(ls.y - size) &lt;= <span class="built_in">float</span>.Epsilon) ||</span><br><span class="line">                !(Mathf.Abs(ls.z - size) &lt;= <span class="built_in">float</span>.Epsilon))</span><br><span class="line">            &#123;</span><br><span class="line">                mTrans.localScale = <span class="keyword">new</span> Vector3(size, size, size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看出PixelPerfect，FixedSize(FixedSizeOnMobile是移动平台的FixedSize设置)主要是缩放标准的选取。<br>当设置为PixelPerfect的时候会根据ScreenHeight与minmumHeight和maxmumHeight的比较来决定是以ScreenHeight为基准按2&#x2F;ScreenHeight比例缩放还是2&#x2F;minmumHeight or 2&#x2F;maxmumHeight为比例缩放。<br>当设置FixedSize的时候只根据我们设定的manualHeight作为参考标准去缩放UIRoot，缩放比例为2&#x2F;manualHeight。<br>根据缩放标准的选取去设定UIRoot localScale的值以实现UI缩放。<br>那么这里就有个疑问，为什么是2&#x2F;manualHeight而不是1&#x2F;manualHeight了？<br>要明白2这个常数的含义，我们先要看看Camera设定为Orthographic类型中的Orthographic Size的含义。<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Camera-orthographicSize.html">Camera’s half-size when in orthographic mode. This is half of the vertical size of the viewing volume. Horizontal viewing size varies depending on viewport’s aspect ratio. Orthographic size is ignored when camera is not orthographic (see orthographic). See Also: camera component.</a><br>可以看出Orthographic Size是指摄像机所观察垂直区域的一半。(前提是设置了orthographic camera)。如果Size设置为1，那么Camera所看到的高度为2 Unit。摄像机所看到的垂直区域一半也就是屏幕高度的一半,Orthographic Size所指示的1个Unit的高度为Screen.Height&#x2F;2。(结合Orthographic Size和Pixel Per Unit设置，我们可以实现Sprite的Pixels Perfect显示)<br><a target="_blank" rel="noopener" href="http://dsqiu.iteye.com/blog/1964679">如果屏幕高度为1000个像素，Size设置的值为1表示1000&#x2F;2&#x3D;500个像素。所以，我们通过整个关系计算UIRoot下的GameObject的实际对应屏幕的高度：从GameObject向上一直到UIRoot，将它们的loaclScal相乘得到的乘积除以Size乘以屏幕高度的一半，即（localScale*….localScale)&#x2F;Size*Screen.height&#x2F;2。</a><br>如果屏幕分辨率为1024 * 768，那么如果我们把Size设置为1，那么1 Unit就对应屏幕分辩率高度的一半即384，也就是说UIRoot下Gameobject实际对应屏幕的高度应该按照384来计算即Screen.height&#x2F;2来计算，因为Size的大小会使物体所占比例成倍缩小，所以我们还需要除以Size。<br>最终得出UIRoot下GameObject的实际对应屏幕的高度计算如下：<br>(localScale *…….*localScale)<em>Screen.height&#x2F;2&#x2F;Size<br>(这也就是为什么UIRoot缩放比例是2&#x2F;manuaHeight里常数为2的原因，这样一来localScale的值就和屏幕所占比例一一对应了(前提是Size为1))<br><a target="_blank" rel="noopener" href="http://dsqiu.iteye.com/blog/1964679">这可以解释UIRoot的localStyle为啥都是很小的小数，因为这样可以保证UIRoot的子节点都可以以原来的大小作为localScale，比如一张图片是20*20的，我们可以直接设置localScale为（20,20,1）不用进行换算，直观方便。（NGUI3.0（or 2.7)以后的版本已经不再使用localScale来表示UISprite ，UILable（UIWidget的子类）的大小了，而是在UIWidget的width和height来设置，这样做的好处就是一个gameObject节点可以挂多个UISprite或UILabel了，而不会受localScale的冲突影响    2013&#x2F;11&#x2F;16增补）。</a><br>这样一来控件坐标与像素一一对应了。这也就是为什么在缩放UIRoot的时候采用2f &#x2F; calcActiveHeight的原因。<br>那么如何让我们的制作的Sprite的像素完美一一对应显示在屏幕上了？<br>我们知道了屏幕分辨率为1024</em>768且Orthographic Size设置为1时，1个Unit对应的高度是384，那么也就是说要想让Sprite像素完美一一对应屏幕显示，我们要确保Sprite的Pixel Per Unit设定为Screen.height&#x2F;2&#x2F;Size。<br>之前提到当我们的常数是2来除以Screen.height的时候需要把Camera的Orthographic Size设置成1才能实现控件坐标与像素的一一对应，让我们看看UIRoot的源码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Start</span> ()</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    UIOrthoCamera oc = GetComponentInChildren&lt;UIOrthoCamera&gt;();  </span><br><span class="line">    <span class="keyword">if</span> (oc != <span class="literal">null</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;UIRoot should not be active at the same time as UIOrthoCamera. Disabling UIOrthoCamera.&quot;</span>, oc);  </span><br><span class="line">        Camera cam = oc.gameObject.GetComponent&lt;Camera&gt;();  </span><br><span class="line">        oc.enabled = <span class="literal">false</span>;  </span><br><span class="line">        <span class="keyword">if</span> (cam != <span class="literal">null</span>) cam.orthographicSize = <span class="number">1f</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">else</span> Update();  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>看得出NGUI并没有为我们强制设置为1，只是警告我们不能把UIRoot和UIOrthoCamera一起使用，如果使用了会自动剔除UIOrthoCamera，并设置orthographicSize为1。我们可以去设置orthographicSize实现不同的效果。<br>了解了UIRoot的实现，那么回到我们原始的话题，如何通过UIRoot实现屏幕自适应了？<br>当屏幕分辨率变化的时候UIRoot下的UI会出现显示不全或者两边有黑边的问题，因为FixedSize结合Manual Height而已控制UIRoot的按比例缩放，所以我们只需把两边未能显示全的UI以宽为基准按比例缩放即可(通过动态计算Manual Height的值)。<br><a target="_blank" rel="noopener" href="http://www.ceeger.com/forum/read.php?tid=9230&ds=1">UIRoot分辨率自适应代码</a><br>ManualWidth和ManualHeight是我们最初美术设计所针对的分辨率，修改到对应的即可。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIRootExtend</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ManualWidth = <span class="number">640</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ManualHeight = <span class="number">960</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> UIRoot _UIRoot;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _UIRoot = <span class="keyword">this</span>.GetComponent&lt;UIRoot&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (System.Convert.ToSingle(Screen.height) / Screen.width &gt; System.Convert.ToSingle(ManualHeight) / ManualWidth)</span><br><span class="line">            _UIRoot.manualHeight = Mathf.RoundToInt(System.Convert.ToSingle(ManualWidth) / Screen.width * Screen.height);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            _UIRoot.manualHeight = ManualHeight;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自适应后在屏幕分辨率为1024<em>768(1.333比例)的时候完美显示如下：<br><img src="/img/Unity/1024Multiple768SelfAdaption.PNG" alt="1024Multiple768SelfAdaption"><br>自适应后在屏幕分辨率为800</em>800(1.0比例)的时候显示如下：<br><img src="/img/Unity/800Multiple800SelfAdaption.PNG" alt="800Multiple800SelfAdaption"><br>自适应后在屏幕分辨率设置为960*640(1.5比例)的时候显示如下：<br><img src="/img/Unity/960Multiple640SelfAdaption.PNG" alt="960Multiple640SelfAdaption"><br>这样一来就实现了保持比例自适应。因为UIRoot是基于高度来缩放的，所以在低分辨率变到高分辨率的时候会出现左右黑边，这在横版游戏里是肯定不行的，所以我们需要做到以宽为基准的自适应。<br>那么基于宽度缩放的代码如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> activeHeight</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> height = Mathf.Max(<span class="number">2</span>, Screen.height);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Base on width instead of height</span></span><br><span class="line">        manualHeight = Screen.height * UIRootExtend.ManualWidth / Screen.width;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (scalingStyle == Scaling.FixedSize) <span class="keyword">return</span> manualHeight;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">if</span> UNITY_IPHONE || UNITY_ANDROID</span></span><br><span class="line">        <span class="keyword">if</span> (scalingStyle == Scaling.FixedSizeOnMobiles)</span><br><span class="line">            <span class="keyword">return</span> manualHeight;</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (height &lt; minimumHeight) <span class="keyword">return</span> minimumHeight;</span><br><span class="line">        <span class="keyword">if</span> (height &gt; maximumHeight) <span class="keyword">return</span> maximumHeight;</span><br><span class="line">        <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但上述在低分辨率变到高分辨率的时候会因为以宽为基准导致高度的自适应超出范围，见下图：<br><img src="/img/Unity/960Multiple640BaseOnWidth.PNG" alt="960Multiple640BaseOnWidth"><br>这种情况只能通过拉伸背景来铺满屏幕，但会失去原始比例(UIStretch可以实现基于屏幕或容器的自适应，不建议使用，后续NGUI都放弃了)。<br>我们肯定不希望我们的主要的UI都被拉伸变形，所以这里需要提到的是UIAnchor，<br>让我们在回忆下UIAnchor的作用：<br>“apply a half-pixel offset on Windows machines, for pixel-perfect results.”(把UI限定在窗口特定位置，当窗口变化的时候会依然处于相对窗口的位置)<br>待续……</p>
<p>关于UI制作尺寸的选择以及UI自适应相关设置：<br>前面的学习结合<a href="">Unity Unit Pixel Per Unit</a>的学习，可以看出，UI自适应和Pixel显示我們需要考虑的点有以下几个:<br>UI需要考虑的点：</p>
<ol>
<li>Canvas Render Mode(Canvas) – Screen Space Camera(一般来说不是作为3D UI摄像机的话，都会选择Screen Space Camera去自己指定一個UI Camera)</li>
<li>UI Scale Mode(Canvas Scaler) – Scale With Screen Size(一般来说为了根据不同设备分辨率进行自适应，我們都会选择这种模式(跟物理size无关))</li>
<li>Project(Camera) – 不是用于3D UI的话，一般来说UI Camera都是设置成Orthographic(正交投影)</li>
<li>Screen Match Mode(Canvas Scaler) – 一般都选择Match Width Or Height指定是以宽为主还是以高为主(影响最终黑边情况 – 是上下黑边还是左右黑边)</li>
<li>Reference Size(Canvas Scaler) – 影响不同机器上的自适应情况(分辨率降低或者升高会影响自适应结果 – 比如居中满屏显示的UI，以高分辨Reference Size在低分辨率Screen Size上以高度自适应会导致左右两侧的UI超出显示范围)(主流手机分辨率比例都在1.333 - 1.778，大部分是1.778)</li>
<li>UI Anchors – 主要影響UI的自適應佈局方式(是自适应缩放还是相对位置)</li>
</ol>
<p>Note:<br>横版2D和竖版2D游戏选择时，主要要考虑Screen Match Mode和Reference Size的选择，因为前者是不允许左右黑边，后者是不允许上下黑边的，两者同时也不允许超出的情况，所以个人认为横版2D应该选择Match Width Or Height值为0(以宽为主不让左右有黑边)，同时Reference Size选择高分辨率，在低分辨率机器上显示时不至于超出高度(只是上下有黑边，这个问题可以通过用背景结合UI Anchors自适应的方式避免)。普通的2D UI，我们最主要要考虑的是Refrence Size的选择(选择高分辨率Reference Size和以宽度为基准自适应，然后结合UI Anchor<br>s布局和拉升背景即可)，这样居中的物体不会被切割显示不全，在低分辨率Screen Size上只是显示高度缩小而已，UI Anchor靠边布局的UI依然正常显示。</p>
<p>Pixel Perfect显示考虑的点：</p>
<ol>
<li>Reference Size(Canvas Scaler) – 我们作为基准计算PPU的分辨率</li>
<li>Orthographic Size(Camera) – 参与Pixel Perfect显示计算，同时把屏幕划分成Orthographci Size * 2个高Unit</li>
<li>Reference Pixels Per Unit(Canvas Scaler) – 参与SpriteRectSize显示计算的参数(SpriteRectSize &#x3D; SpriteSize * SpritePPU &#x2F; CanvaReferencePPU)，一般设置跟Sprite PPU一样保证Sprite按原始大小显示即可</li>
<li>Pixels Per Unit(Asset) – Asset相对一个屏幕Unit显示的Pixels，用于确保Asset Pixel Perfect显示</li>
</ol>
<p>Pixel Perfect显示公式：<br>Orthographic Size &#x3D; Screen.height &#x2F; 2 &#x2F; PPU;<br>从前面的学习我们知道了，要想Pixel Perfect显示，除了动态修正Orthographic Size以外就是针对不同分辨率机器做多套PPU的资源去使用。<br>如果想Pixel Perfect显示，那么UI尺寸的选择就要参考计算出的PPU来设计。</p>
<h2 id="DOTween"><a href="#DOTween" class="headerlink" title="DOTween"></a>DOTween</h2><h3 id="DOTween-Instroduction"><a href="#DOTween-Instroduction" class="headerlink" title="DOTween Instroduction"></a>DOTween Instroduction</h3><p><a target="_blank" rel="noopener" href="http://dotween.demigiant.com/">DOTween is a fast, efficient, fully type-safe object-oriented animation engine for Unity, optimized for C# users, free and open-source, with tons of advanced features</a></p>
<p>简单看一下官网提到的Features(这里只Copy一部分)：<br>Speed and efficiency:<br>    Not only very fast, but also very efficient: everything is cached and reused to avoid useless GC allocations.<br>Shortcuts:<br>    Shortcut extensions that directly extend common objects<br>Extremely accurate:<br>    Time is calculated in a very precise way. This means that 1000 loops of 1 second each will play exactly as long as a single loop of 1000 seconds.<br>Animate everything (almost)<br>    DOTween can animate every numeric value and also some non-numeric ones. It can even animate strings, with support for rich-text.<br>Full control<br>    Play, Pause, Rewind, Restart, Complete, Goto and tons of other useful methods to control your tweens.<br>Grouping<br>    Combine tweens into Sequences to create complex animations (which don’t need to be in a, uh, sequence: they can also overlap each other).<br>Blendable tweens<br>    Some tweens can blend between each other in realtime, thanks to powerful DOBlendable shortcuts.<br>Paths<br>    Animate stuff along both linear and curved paths, with additional options for the orientation of your traveling agents.<br>Change values and duration while playing<br>    Change a tween’s start&#x2F;end values or duration at any moment, even while playing.<br>Yield for coroutines<br>    Various “WaitFor…” methods to use inside coroutines, that allow you to wait for a tween to be completed, killed, started, or for it to reach a given position or loops.<br>Plugins<br>    DOTween is built with an extensible architecture in mind, which allows you to create your own tween plugins as separate files.<br>Extras<br>    Extra virtual methods to do stuff like calling a function after a given delay.<br>…….<br>总的来说DOTween可以满足我们做动画的任何要求且高效快速方便使用。</p>
<h3 id="DOTween-Install"><a href="#DOTween-Install" class="headerlink" title="DOTween Install"></a>DOTween Install</h3><p>看得出DOTween的定位是一个动画引擎。<br>首先是<a target="_blank" rel="noopener" href="http://dotween.demigiant.com/download.php#download">DOTween下载</a><br>其次是DOTween加入到我们的工程项目里(Assets下)，然后DOTween被自动加载。<br>DOTween加载进来后会弹出设置界面：<br><img src="/img/Unity/DOTweenSetting.PNG" alt="DOTweenSetting"><br>点击Setup DOTween进行设置，设置DOTween好使DOTween根据我们的Unity版本去导入一些特定库。<br>接下来我们就可以使用DOTween里的库函数做动画了。</p>
<h3 id="DOTween-Nomenclature-and-Prefixes"><a href="#DOTween-Nomenclature-and-Prefixes" class="headerlink" title="DOTween Nomenclature and Prefixes"></a>DOTween Nomenclature and Prefixes</h3><p>深入学习DOTween之前，让我们先了解下DOTween里的命名方式和一些关键术语：<br>以下学习源于<a target="_blank" rel="noopener" href="http://dotween.demigiant.com/documentation.php#globalSettings">DOTween官网</a><br><strong>Nomenclature</strong>:<br><em>Tweener</em> – A tween that takes control of a value and animates it.(Tweener是控制动画细节参数和播放的)<br><em>Sequence</em> – A special tween that, instead of taking control of a value, takes control of other tweens and animates them as a group.(Sequence可以理解成负责对tweens进行动画而非对属性比如position做动画)<br><em>Tween</em> – A generic word that indicates both a Tweener and a Sequence.<br><em>Nested tween</em> – A tween contained inside a Sequence.</p>
<p><strong>Prefixes</strong>:<br><em>DO</em> – Prefix for all tween shortcuts (operations that can be started directly from a known object, like a transform or a material). Also the prefix of the main DOTween class.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">transform.DOMoveX(<span class="number">100</span>, <span class="number">1</span>);</span><br><span class="line">transform.DORestart();</span><br><span class="line">DOTween.Play();</span><br></pre></td></tr></table></figure>

<p><em>Set</em> – Prefix for all settings that can be chained to a tween (except for From, since it’s applied as a setting but is not really a setting).(tween的setting函数)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myTween.SetLoops(<span class="number">4</span>, LoopType.Yoyo).SetSpeedBased();</span><br></pre></td></tr></table></figure>

<p><em>On</em> – Prefix for all callbacks that can be chained to a tween.(tween的一些回调设定函数)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myTween.OnStart(myStartFunction).OnComplete(myCompleteFunction);</span><br></pre></td></tr></table></figure>

<h3 id="DOTween使用学习"><a href="#DOTween使用学习" class="headerlink" title="DOTween使用学习"></a>DOTween使用学习</h3><p>在使用DOTween之前，我们需要在项目添加命名空间并对DOTween的初始化(初始化这一步不是必须的，不手动初始化也会自动初始化，官网推荐手动初始化设定)：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DG.Tweening;</span><br><span class="line"></span><br><span class="line">DOTween.Init();</span><br></pre></td></tr></table></figure>

<p>让我们来看看DOTween里的函数定义：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Tweener <span class="title">DOMove</span>(<span class="params"><span class="keyword">this</span> Transform target, Vector3 endValue, <span class="built_in">float</span> duration, <span class="built_in">bool</span> snapping = <span class="literal">false</span></span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Sequence <span class="title">DOJump</span>(<span class="params"><span class="keyword">this</span> Transform target, Vector3 endValue, <span class="built_in">float</span> jumpPower, <span class="built_in">int</span> numJumps, <span class="built_in">float</span> duration, <span class="built_in">bool</span> snapping = <span class="literal">false</span></span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">DOKill</span>(<span class="params"><span class="keyword">this</span> Component target, <span class="built_in">bool</span> complete = <span class="literal">false</span></span>)</span>;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>可以看出DOTween里面的大量方法都是通过C#里extend method的方式添加进去的。<br>所以我们要使用特定DOTween方法，我只需要在对应类的实例调用扩展方法即可。<br>接下来看看我们如何创建自定义的Tween。<br>有三中方式可供选择：</p>
<ol>
<li>The generic way<br>DOTween.TO(getter, setter, to float duration)<br>Changes the given property from its current value to the given one.<br>getter A delegate that returns the value of the property to tween. Can be written as a lambda like this: ()&#x3D;&gt; myValue<br>where myValue is the name of the property to tween.<br>setter A delegate that sets the value of the property to tween. Can be written as a lambda like this: x&#x3D;&gt; myValue &#x3D; x<br>where myValue is the name of the property to tween.<br>to The end value to reach.<br>duration The duration of the tween.</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tween a Vector3 called myVector to 3,4,8 in 1 second</span></span><br><span class="line">DOTween.To(()=&gt; myVector, x=&gt; myVector = x, <span class="keyword">new</span> Vector3(<span class="number">3</span>,<span class="number">4</span>,<span class="number">8</span>), <span class="number">1</span>);</span><br><span class="line"><span class="comment">// Tween a float called myFloat to 52 in 1 second</span></span><br><span class="line">DOTween.To(()=&gt; myFloat, x=&gt; myFloat = x, <span class="number">52</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>The shortcuts way(Extension method)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform.DOMove(<span class="keyword">new</span> Vector3(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>), <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<pre><code>在shortcuts方法后面调用From()的话，就会初始位置当做dest，把dest当做初始绘制来做动画。
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform.DOMove(<span class="keyword">new</span> Vector3(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>), <span class="number">1</span>).From();</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Additional generic ways<br>这种没太看明白</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> DOTween.Punch(getter, setter, Vector3 direction, <span class="built_in">float</span> duration, <span class="built_in">int</span> vibrato, <span class="built_in">float</span> elasticity)</span><br><span class="line"><span class="keyword">static</span> DOTween.Shake(getter, setter, <span class="built_in">float</span> duration, <span class="built_in">float</span>/Vector3 strength, <span class="built_in">int</span> vibrato, <span class="built_in">float</span> randomness, <span class="built_in">bool</span> ignoreZAxis)</span><br><span class="line"><span class="keyword">static</span> DOTween.ToAlpha(getter, setter, <span class="built_in">float</span> to, <span class="built_in">float</span> duration)</span><br><span class="line"><span class="keyword">static</span> DOTween.ToArray(getter, setter, <span class="built_in">float</span> to, <span class="built_in">float</span> duration)</span><br><span class="line"><span class="keyword">static</span> DOTween.ToAxis(getter, setter, <span class="built_in">float</span> to, <span class="built_in">float</span> duration, AxisConstraint axis)</span><br></pre></td></tr></table></figure>

<p>貌似是会对Tween做特殊的限制，比如DOTween.Shake延axis轴变化vector3。</p>
<p>接下来让我们看看如何使用Sequence：<br>The sequenced tweens don’t have to be one after each other. You can overlap tweens with the Insert method.(sequence可包含其他sequence，可以通过Insert把tween插入到特定时间执行)<br>A tween (Sequence or Tweener) can be nested only inside a single other Sequence, meaning you can’t reuse the same tween in multiple Sequences. (同一个tween不能被多个sequence使用)<br>创建一个Sequence:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOTween.Sequence();</span><br></pre></td></tr></table></figure>

<p>我们可以通过添加tweens，callback到sequence里去做一些特别的动画。<br>Note:<br>“ all these methods need to be applied before the Sequence starts (usually the next frame after you create it, unless it’s paused), or they won’t have any effect.”(添加tweens，callback这些都必须在Sequence开始之前，可以理解为同一帧里)</p>
<p>接下来我们看看Tween的一些设置：<br>这些设置分为针对全局，tweens，sequence，tweener设置。<br>举个简单的例子，比如我们在初始化DOTween的时候设置了tween在同一时刻激活的最大数量。我超过这个数量后想要修改，我们可以通过:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOTween.SetTweensCapacity(***);</span><br></pre></td></tr></table></figure>

<p>上述这个方法就是针对全局设置的</p>
<p>接下来我们看看如何动态的控制tween动画的：<br>有三种方式：</p>
<ol>
<li>Via Static methods and filters<br>DOTween class给我们提供了大量的静态方法去控制tween动画。<br>比如我们想暂停某个tween动画或暂停所有tween：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DOTween.Pause(tweenname);</span><br><span class="line">DOTween.PauseAll();</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Directly from the tween<br>我们也可以通过保存的tween动画引用去调用控制相关的动画</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myTween.Pause();</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>From a shortcut-enhanced reference<br>直接通过扩展方法去停止对应的物体上的tween(这里要注意的是，所有控制tween的扩展方法都带DO前缀)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transfrom.DOPause();</span><br></pre></td></tr></table></figure>

<p>Note:<br>“IMPORTANT: remember that to use these methods on a tween after it has ended, you have to disable its autoKill behaviour, otherwise a tween is automatically killed at completion.”(对tween设置的时候一定要disable automatically kill，否则在tween完成的时候tween会被销毁)<br>同时DOTween还给我们提供了很多静态方法去获取tween的信息(比如Delay(),Duration()等)</p>
<p>Tween结合Coroutines的使用：<br>Tween提供了一些YieldInstructions的方法，可以让我们结合Coroutines去方便快速的实现一些对调用时机有讲究的动画:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要等到tween结束</span></span><br><span class="line"><span class="function">IEnumerator <span class="title">SomeCoroutine</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Tween myTween = transform.DOMoveX(<span class="number">45</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> myTween.WaitForCompletion();</span><br><span class="line">    <span class="comment">// This log will happen after the tween has completed</span></span><br><span class="line">    Debug.Log(<span class="string">&quot;Tween completed!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：<br>给我的感觉，DOTween是一个基于Unity扩展的强大的数学动画库。<br>通过DOTween我们可以快速的去针对Unity里的一些属性比如位置，材质，UI等做动画，可以说是属于程序员的动画制作工具。</p>
<p><a target="_blank" rel="noopener" href="https://www.codeandweb.com/texturepacker">TexturePacker官网</a></p>
<p>待续……</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://www.codeandweb.com/texturepacker">TexturePacker官网</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Plugin/">Plugin</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Plugin/">Plugin</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/21/数据结构与算法/" title="数据结构与算法" itemprop="url">数据结构与算法</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-10-21T06:04:40.000Z" itemprop="datePublished"> 发表于 2016-10-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>写这一篇文章的目的是出于自己一直以来基础都比较弱，特别是数据结构和算法，但数据结构和算法确实程序里很核心的部分，只有了解各种数据结构和算法的基本思想，才能针对实际问题做出最好的选择，写出最优的程序。工作两年多了，但感觉自己再这方面还是依然原地踏步，了解的一知半解。为了避免多年以后还来学习这些本应该在学校学好的知识，从而有了这一次学习计划。</p>
<p>在看了这位博主的<a target="_blank" rel="noopener" href="http://www.cnblogs.com/figure9/archive/2014/05/05/3708351.html">我的算法学习之路</a>之后，深深的感受到了数据结构和算法的魅力和重要性。虽然不知道自己还能为游戏梦想坚持多久，但当下，制定一个完整的数据结构和算法的学习计划是当务之急。</p>
<p>现在有点理解别人说过的”编程语言只是工具，编程思想，数据结构和算法才是核心。”</p>
<p>以下学习主要是对于数据结构和算法的回顾和进阶学习计划。准备用C++来写。</p>
<p>参考书籍：<br>编程语言：<br>《C++ Primer》Fifth Edition – Stanley B.Lippman Josee Lajoie Barbara E.Moo<br>《Effective C++》Third Edition – Scott Meyers<br>最初学习C++是看的《Thinking in C++》和《Professional C++》，但后来看了部分《C++ Primer》之后觉得，这本书在细节方面讲解的更细致到位。而《Effective C++》是从我们平时容易忽略或错误理解的点，以一条条规则的形式，讲述背后的道理，可以作为C++编程指南。</p>
<p>数据结构和算法：<br>《数据结构与算法 - C语言描述》 – Mark Allen Weiss<br><a target="_blank" rel="noopener" href="http://wenku.baidu.com/link?url=3xIVKWrL5_o5rBlEsr5j-1Es983eN4n00LwX9dyOH41Vm7ErO7RpoyHR389A_FP0O665guNIjbxbLzM7cu38QZlRN1xqIo0XUnfDPCZ6No3">数据结构与算法 - C语言描述课后习题在线答案参考</a><br>《算法设计与分析》 Third Edition – 王晓东<br>《Introduction To Algorithm》(算法导论) Third Edition– Thomas H.Cormen &amp; ……<br><a target="_blank" rel="noopener" href="https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-006-introduction-to-algorithms-fall-2011/lecture-videos/">Introduction To Algorithm MIT课程视频</a></p>
<p>前两者是我在大学时候学习的关于数据结构和算法的书籍，作为基础知识回顾来学习。<br>第三个在网络上的评价褒贬不一，但作为国外的优秀教材来使用，可以看出是很有分量的，作为进阶学习书籍。最后一个是麻省理工对于算法导论教材的上课视频可以作为学习《Introduction To Algorithm》的学习资料。</p>
<p>编程艺术和思考：<br>《The Progmatic Programmer》(程序员修炼之道) – Andrew Hunt &amp; David Thomas<br>此书并非将编程技巧而是讲程序员应该如何去思考，如何高效的开发。</p>
<p>STL深入学习：<br>《C++标准程序库》<br>此书虽然比较老，但貌似是C++标准库学习的经典书籍，里面对STL进行基本的讲解学习。<br>《STL源码剖析》<br>此书乃侯捷所著，对于STL进行了深入的讲解学习，属于对STL的深入学习的一本参考书籍。</p>
<h1 id="欲善其事必先利其器"><a href="#欲善其事必先利其器" class="headerlink" title="欲善其事必先利其器"></a>欲善其事必先利其器</h1><p>单纯学习数据结构和算法是比较枯燥的，<a target="_blank" rel="noopener" href="https://visualgo.net/">算法可视化的神奇网站</a>，这个网站可以让我们在学习数据结构和算法的时候可视化的看到每一步的变化，更加形象生动。</p>
<h1 id="数学知识"><a href="#数学知识" class="headerlink" title="数学知识"></a>数学知识</h1><h2 id="指数"><a href="#指数" class="headerlink" title="指数"></a>指数</h2><p>Power(X,A) X Power(X,B) &#x3D; Power(X,A+B)<br>Power(X,A) &#x2F; Power(X,B) &#x3D; Power(X,A-B)</p>
<h2 id="对数"><a href="#对数" class="headerlink" title="对数"></a>对数</h2><p>LogA(B) &#x3D; LogC(B) &#x2F; LogC(A); C &gt; 0<br>Log(AB) &#x3D; Log(A) + Log(B)<br>Log(A&#x2F;B) &#x3D; Log(A) - Log(B)<br>Log(Power(A,B)) &#x3D; B X Log(A)<br>Log(X) &lt; X(X &gt; 0)</p>
<h2 id="级数"><a href="#级数" class="headerlink" title="级数"></a>级数</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> N</span><br><span class="line"> ∑  (Power(<span class="number">2</span>, i)) =  Power(<span class="number">2</span>, N+<span class="number">1</span>) - <span class="number">1</span>;</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"> N</span><br><span class="line"> ∑ (Power(A, i)) = (Power(<span class="number">2</span>, N+<span class="number">1</span>) - <span class="number">1</span>) / (A - <span class="number">1</span>)</span><br><span class="line">i=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="模运算"><a href="#模运算" class="headerlink" title="模运算"></a>模运算</h2><p>如果N整除A-B,那么A与B模N同余，记为A≡B(mod N)</p>
<h2 id="证明方法"><a href="#证明方法" class="headerlink" title="证明方法"></a>证明方法</h2><ol>
<li>归纳法<br>第一步证明基准情形(对于某些小的值的正确性，比如1)<br>第二步，假设直到k也成立<br>最后，证明k+1的时候也成立即可</li>
<li>反证法<br>首先假设定力不成立<br>然后证明该假设导致的某个已知的性质不成立，从而证明原假设是错误的。</li>
</ol>
<h2 id="递归简论"><a href="#递归简论" class="headerlink" title="递归简论"></a>递归简论</h2><p>基本法则：</p>
<ol>
<li>基准情形<br>必须要有某些基准的情形，它们不用递归就能求解</li>
<li>不断推进<br>对于那些递归求解的情形，递归调用必须总能够朝着产生基准情形的方向推进</li>
<li>设计法则<br>假设所有的递归调用都能运行</li>
<li>合成效益法则<br>在求解一个问题的同一个实例时，切勿在不同的递归调用中做重复性的工作</li>
</ol>
<h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><p>抽象数据类型(Abstract data type, ADT)是一些操作的集合。</p>
<h2 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h2><p>链表是由一系列不必在内存中向连的结构组成。每一个结构均含有表元素和指向包含该元素后继元的结构的指针。最后一个单元的后继元指向NULL。</p>
<p>链表分类：</p>
<ol>
<li>单向链表<br> 只能从前往后访问节点<br> 以下实现了简单的单向链表，允许头插入Node，删除第一个满足条件的Node，打印所有成员，判断是否为空，得到Node节点数等。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SingleLinkNode</span></span><br><span class="line">&#123;</span><br><span class="line">	T mElement;</span><br><span class="line">	SingleLinkNode* Next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SingleLinkList</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">SingleLinkList</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		mHeadNode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		mLength = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">SingleLinkList</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		SingleLinkNode&lt;T&gt; *tempnode;</span><br><span class="line">		<span class="keyword">while</span> (mHeadNode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			tempnode = mHeadNode-&gt;Next;</span><br><span class="line">			<span class="keyword">delete</span> mHeadNode;</span><br><span class="line">			mLength--;</span><br><span class="line">			mHeadNode = tempnode;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//ADT</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">FrontInsert</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		SingleLinkNode&lt;T&gt; *tempnode = <span class="keyword">new</span> <span class="built_in">SingleLinkNode</span>&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">		tempnode-&gt;mElement = v;</span><br><span class="line"></span><br><span class="line">		tempnode-&gt;Next = mHeadNode;</span><br><span class="line"></span><br><span class="line">		mHeadNode = tempnode;</span><br><span class="line"></span><br><span class="line">		mLength++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">IsEmpty</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mLength;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Delete</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mHeadNode == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		SingleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line"></span><br><span class="line">		SingleLinkNode&lt;T&gt; *prenode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">bool</span> find = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//remove first v element</span></span><br><span class="line">			<span class="keyword">if</span> (tempnode-&gt;mElement == v)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//when remove first node, move forward mHeadNode</span></span><br><span class="line">				<span class="keyword">if</span> (tempnode == mHeadNode)</span><br><span class="line">				&#123;</span><br><span class="line">					mHeadNode = tempnode-&gt;Next;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					prenode-&gt;Next = tempnode-&gt;Next;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">delete</span> tempnode;</span><br><span class="line">				mLength--;</span><br><span class="line">				find = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//Record pre node for later operation</span></span><br><span class="line">			prenode = tempnode;</span><br><span class="line">			tempnode = tempnode-&gt;Next;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (find)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Delete &quot;</span> &lt;&lt; v &lt;&lt; <span class="string">&quot; successfully!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Delete &quot;</span> &lt;&lt; v &lt;&lt; <span class="string">&quot; failed! Not find it in list!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Find</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="type">int</span> position = <span class="number">0</span>;</span><br><span class="line">		SingleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			position++;</span><br><span class="line">			<span class="keyword">if</span> (tempnode-&gt;mElement == v)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> position;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				tempnode = tempnode-&gt;Next;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">SingleLinkNode&lt;T&gt;* <span class="title">GetNodeAt</span><span class="params">(<span class="type">int</span> position)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (position &lt; <span class="number">1</span> || position &gt; mLength)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; position &lt;&lt; <span class="string">&quot; Out of range of link list!&quot;</span> &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Current length of link list = &quot;</span> &lt;&lt; mLength &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Insert failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//链表是非连续的存储方式，所以需要通过循环访问到特定位置</span></span><br><span class="line">			SingleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (position == <span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> mHeadNode;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; position; i++)</span><br><span class="line">				&#123;</span><br><span class="line">					tempnode = tempnode-&gt;Next;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> tempnode;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">TraversAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		SingleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; tempnode-&gt;mElement &lt;&lt; endl;</span><br><span class="line">			tempnode = tempnode-&gt;Next;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Length</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mLength;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	SingleLinkNode&lt;T&gt; *mHeadNode;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mLength;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<pre><code>测试程序：
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vld.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SingleLinkList.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//Single Link List part</span></span><br><span class="line">	SingleLinkList&lt;<span class="type">int</span>&gt; *singlelinklist = <span class="keyword">new</span> <span class="built_in">SingleLinkList</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">	singlelinklist-&gt;<span class="built_in">FrontInsert</span>(<span class="number">3</span>);</span><br><span class="line">	singlelinklist-&gt;<span class="built_in">FrontInsert</span>(<span class="number">1</span>);</span><br><span class="line">	singlelinklist-&gt;<span class="built_in">FrontInsert</span>(<span class="number">4</span>);</span><br><span class="line">	singlelinklist-&gt;<span class="built_in">FrontInsert</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	singlelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	singlelinklist-&gt;<span class="built_in">Delete</span>(<span class="number">1</span>);</span><br><span class="line">	singlelinklist-&gt;<span class="built_in">Delete</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	singlelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span> singlelinklist;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>可以看到链表的节点是通过SingleLinkNode抽象出来。
</code></pre>
<p><img src="/img/Algorithem/SingleLinkList.PNG" alt="SingleLinkList"></p>
<ol start="2">
<li>双向链表<br> 可以从前往后也可以从后往前访问节点<br> 为了从后往前访问，我们需要改写SingleLinkNode支持从当前Node访问前一Node</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DoubleLinkNode</span></span><br><span class="line">&#123;</span><br><span class="line">	T mElement;</span><br><span class="line">	</span><br><span class="line">	DoubleLinkNode *Pre;</span><br><span class="line"></span><br><span class="line">	DoubleLinkNode *Next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<pre><code>同时为了快速从尾部访问，SingleLinkList需要增加mTailNode去指向链表尾部Node，同时支持从尾部插入
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//DoubleLinkNode definition</span></span><br><span class="line"><span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DoubleLinkList</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">DoubleLinkList</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		mHeadNode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		mTailNode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		mLength = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">DoubleLinkList</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode;</span><br><span class="line">		<span class="keyword">while</span> (mHeadNode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			tempnode = mHeadNode-&gt;Next;</span><br><span class="line">			<span class="keyword">delete</span> mHeadNode;</span><br><span class="line">			mLength--;</span><br><span class="line">			mHeadNode = tempnode;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//ADT</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">FrontInsert</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode = <span class="keyword">new</span> <span class="built_in">DoubleLinkNode</span>&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">		tempnode-&gt;mElement = v;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//when insert first element, tail node equals to head node</span></span><br><span class="line">		<span class="keyword">if</span> (mLength == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			tempnode-&gt;Pre = <span class="literal">NULL</span>;</span><br><span class="line">			tempnode-&gt;Next = <span class="literal">NULL</span>;</span><br><span class="line">			mHeadNode = tempnode;</span><br><span class="line">			mTailNode = mHeadNode;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			mHeadNode-&gt;Pre = tempnode;</span><br><span class="line">			tempnode-&gt;Next = mHeadNode;</span><br><span class="line">			mHeadNode = tempnode;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mLength++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">InsertAtPosition</span><span class="params">(<span class="type">int</span> position, T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (position &lt; <span class="number">1</span> || position &gt; mLength + <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; position &lt;&lt; <span class="string">&quot; Out of range of link list!&quot;</span> &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Current length of link list = &quot;</span> &lt;&lt; mLength &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Insert failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//when insert element as first element.</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">FrontInsert</span>(v);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//when insert at final position</span></span><br><span class="line">		<span class="comment">//when position is larger than length of link list,</span></span><br><span class="line">		<span class="comment">//we insert it at the end of the link list</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (position == mLength + <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">TailInsert</span>(v);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//insert element between head and last element</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			DoubleLinkNode&lt;T&gt; *tempnode = <span class="keyword">new</span> <span class="built_in">DoubleLinkNode</span>&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">			tempnode-&gt;mElement = v;</span><br><span class="line"></span><br><span class="line">			DoubleLinkNode&lt;T&gt; *prenode = <span class="built_in">GetNodeAt</span>(position - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (prenode != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				tempnode-&gt;Pre = prenode;</span><br><span class="line"></span><br><span class="line">				tempnode-&gt;Next = prenode-&gt;Next;</span><br><span class="line"></span><br><span class="line">				prenode-&gt;Next-&gt;Pre = tempnode;</span><br><span class="line"></span><br><span class="line">				prenode-&gt;Next = tempnode;</span><br><span class="line"></span><br><span class="line">				mLength++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">TailInsert</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode = <span class="keyword">new</span> <span class="built_in">DoubleLinkNode</span>&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">		tempnode-&gt;mElement = v;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//when insert first element, tail node equals to head node</span></span><br><span class="line">		<span class="keyword">if</span> (mLength == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			tempnode-&gt;Pre = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			tempnode-&gt;Next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			mHeadNode = tempnode;</span><br><span class="line"></span><br><span class="line">			mTailNode = mHeadNode;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			tempnode-&gt;Pre = mTailNode;</span><br><span class="line"></span><br><span class="line">			tempnode-&gt;Next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			mTailNode-&gt;Next = tempnode;</span><br><span class="line"></span><br><span class="line">			mTailNode = tempnode;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mLength++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">DoubleLinkNode&lt;T&gt;* <span class="title">GetNodeAt</span><span class="params">(<span class="type">int</span> position)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (position &lt; <span class="number">1</span> || position &gt; mLength)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; position &lt;&lt; <span class="string">&quot; Out of range of link list!&quot;</span> &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Current length of link list = &quot;</span> &lt;&lt; mLength &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Insert failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//链表是非连续的存储方式，所以需要通过循环访问到特定位置</span></span><br><span class="line">			DoubleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (position == <span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> mHeadNode;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (position == mLength)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> mTailNode;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; position; i++)</span><br><span class="line">				&#123;</span><br><span class="line">					tempnode = tempnode-&gt;Next;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> tempnode;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">IsEmpty</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mLength;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Delete</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mHeadNode == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line"></span><br><span class="line">		DoubleLinkNode&lt;T&gt; *prenode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">bool</span> find = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//remove first v element</span></span><br><span class="line">			<span class="keyword">if</span> (tempnode-&gt;mElement == v)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//when remove first node, move forward mHeadNode</span></span><br><span class="line">				<span class="keyword">if</span> (tempnode == mHeadNode)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (mLength &lt;= <span class="number">1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						mHeadNode = <span class="literal">NULL</span>;</span><br><span class="line">						mTailNode = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						mHeadNode = tempnode-&gt;Next;</span><br><span class="line">						mHeadNode-&gt;Pre = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (tempnode == mTailNode)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (mLength &lt;= <span class="number">1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						mHeadNode = <span class="literal">NULL</span>;</span><br><span class="line">						mTailNode = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						mTailNode = prenode;</span><br><span class="line">						mTailNode-&gt;Next = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					prenode-&gt;Next = tempnode-&gt;Next;</span><br><span class="line">					tempnode-&gt;Next-&gt;Pre = prenode;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">delete</span> tempnode;</span><br><span class="line">				mLength--;</span><br><span class="line">				find = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//Record pre node for later operation</span></span><br><span class="line">			prenode = tempnode;</span><br><span class="line">			tempnode = tempnode-&gt;Next;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (find)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Delete &quot;</span> &lt;&lt; v &lt;&lt; <span class="string">&quot; successfully!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Delete &quot;</span> &lt;&lt; v &lt;&lt; <span class="string">&quot; failed! Not find it in list!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Find</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="type">int</span> position = <span class="number">0</span>;</span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			position++;</span><br><span class="line">			<span class="keyword">if</span> (tempnode-&gt;mElement == v)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> position;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				tempnode = tempnode-&gt;Next;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">TraversAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; tempnode-&gt;mElement &lt;&lt; endl;</span><br><span class="line">			tempnode = tempnode-&gt;Next;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Length</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mLength;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	DoubleLinkNode&lt;T&gt; *mHeadNode;</span><br><span class="line"></span><br><span class="line">	DoubleLinkNode&lt;T&gt; *mTailNode;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mLength;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<pre><code>测试程序
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vld.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SingleLinkList.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//Double link list part</span></span><br><span class="line">	DoubleLinkList&lt;<span class="type">int</span>&gt; *doublelinklist = <span class="keyword">new</span> <span class="built_in">DoubleLinkList</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TailInsert</span>(<span class="number">2</span>);</span><br><span class="line">	doublelinklist-&gt;<span class="built_in">FrontInsert</span>(<span class="number">3</span>);</span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TailInsert</span>(<span class="number">4</span>);</span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TailInsert</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">Delete</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Complete doublelinklist-&gt;Delete(4);&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">InsertAtPosition</span>(<span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Complete doublelinklist-&gt;InsertAtPosition(3, 6);&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">InsertAtPosition</span>(<span class="number">5</span>, <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Complete doublelinklist-&gt;InsertAtPosition(5, 7);&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">InsertAtPosition</span>(<span class="number">9</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Complete doublelinklist-&gt;InsertAtPosition(9, 10);&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span> doublelinklist;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>测试结果：
</code></pre>
<p><img src="/img/Algorithem/DoubleLinkList.PNG" alt="DoubleLinkList"></p>
<ol start="3">
<li>循环链表<br> 双向链表的基础上，可以从头直接访问尾也可以从尾直接访问头<br> 出于测试目的，为了验证是否至此从尾访问到头部，在TraversAll的方法里，我从第二个节点开始访问进行打印数据直到回到头节点</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TraversAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CircleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line">	tempnode = tempnode-&gt;Next;</span><br><span class="line">	cout &lt;&lt; mHeadNode-&gt;mElement &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">while</span> (tempnode != mHeadNode)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; tempnode-&gt;mElement &lt;&lt; endl;</span><br><span class="line">		tempnode = tempnode-&gt;Next;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>因为Head节点的Pre指向Tail节点，Tail节点的Next指向Head，所以这里在析构释放内存的时候需要注意判断条件：
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~<span class="built_in">CircleLinkList</span>()</span><br><span class="line">&#123;</span><br><span class="line">	CircleLinkNode&lt;T&gt; *	tempnode = mHeadNode;</span><br><span class="line">	<span class="keyword">while</span> (mLength != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		mHeadNode = mHeadNode-&gt;Next;</span><br><span class="line">		<span class="keyword">delete</span> tempnode;</span><br><span class="line">		tempnode = mHeadNode;</span><br><span class="line">		mLength--;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>其他情况主要注意在Head和Tail的极端顶点时的判断处理：
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ADT</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FrontInsert</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CircleLinkNode&lt;T&gt; *tempnode = <span class="keyword">new</span> <span class="built_in">CircleLinkNode</span>&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">	tempnode-&gt;mElement = v;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//when insert first element, tail node equals to head node</span></span><br><span class="line">	<span class="keyword">if</span> (mLength == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		tempnode-&gt;Pre = tempnode;</span><br><span class="line">		tempnode-&gt;Next = tempnode;</span><br><span class="line">		mHeadNode = tempnode;</span><br><span class="line">		mTailNode = mHeadNode;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeadNode-&gt;Pre = tempnode;</span><br><span class="line">		tempnode-&gt;Pre = mTailNode;</span><br><span class="line">		tempnode-&gt;Next = mHeadNode-&gt;Next;</span><br><span class="line">		mHeadNode = tempnode;</span><br><span class="line">		mTailNode-&gt;Next = mHeadNode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mLength++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//......</span></span><br></pre></td></tr></table></figure>
<pre><code>测试结果：
</code></pre>
<p><img src="/img/Algorithem/CircleLinkList.PNG" alt="CircleLinkList"></p>
<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><p>栈是限制插入和删除只能在一个位置上进行的表，该位置是表的末端，叫做栈的顶。<br>栈的ADT：<br>Push(进栈)<br>Pop(出栈)</p>
<p>栈是LIFO(后进先出)</p>
<p>栈的实现：<br>栈是一个表，因此任何实现表的方法都能实现栈(比如数组，链表)。<br>下面以前面实现的链表为例来实现栈：<br>因为栈只允许顶端Push，Pop以及Top查看顶端元素并返回值，所以这里采用单向链表即可。</p>
<p>待续……</p>
<h1 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h1><h2 id="算法与程序"><a href="#算法与程序" class="headerlink" title="算法与程序"></a>算法与程序</h2><p>算法是由若干条指令组成的又有穷序列，且满足下述4条性质：</p>
<ol>
<li>输入：有零个或多个由外部提供的量作为算法的输入。</li>
<li>输出：算法产生至少一个量作为输出。</li>
<li>确定性：组成算法的每条指令是清晰的，无歧义的。</li>
<li>有限性：算法中每条指令的执行次数是有限的，执行每条指令的时间也是有限的。</li>
</ol>
<p>区分程序和算法：<br>程序与算法不同。程序是算法用某种程序设计语言的具体实现。</p>
<h2 id="算法复杂性"><a href="#算法复杂性" class="headerlink" title="算法复杂性"></a>算法复杂性</h2><p>算法复杂性体现在运行该算法所需的计算机资源(时间和空间)的多少上。</p>
<p>所以算法复杂性主要是体现的时间复杂度和空间复杂度上。<br>C表示复杂度，N表示问题的规模，I表示算法的输入，A表示算法本身。<br>C &#x3D; F(N,I,A)<br>T表示时间复杂度，S表示空间复杂度。<br>T &#x3D; F(N,I,A)<br>S &#x3D; F(N,I,A)</p>
<h3 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h3><p>时间复杂度 — 指执行算法所需要的计算工作量<br>时间复杂度分为下列三种：</p>
<ol>
<li>平均时间复杂度 — 理论上一般情况的时间复杂度</li>
<li>最坏时间复杂度 — 特殊情况下（导致时间耗费最多的数据输入）</li>
<li>最优时间复杂度 — 特殊情况下（导致时间耗费最少的数据输入）</li>
</ol>
<h3 id="空间复杂度"><a href="#空间复杂度" class="headerlink" title="空间复杂度"></a>空间复杂度</h3><p>空间复杂度 — 指执行算法所需要的内存空间</p>
<h2 id="程序算法思想"><a href="#程序算法思想" class="headerlink" title="程序算法思想"></a>程序算法思想</h2><h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><p>定义：<br>直接或间接地调用自身的算法称为递归算法。<br>用函数自身给出定义的函数称为递归函数。</p>
<p>基本思想：<br>每个递归函数都必须有非递归定义的初始值，否则，递归函数就无法计算。<br>递归式的第二式用较小自变量的函数值来表示较大自变量的函数值的方式来定义。</p>
<p>事例：<br>无穷数列1,1,2,3,5,8,13，,2,34,55……，称为Fibonacci数列。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">       &#123;  <span class="number">1</span>                         n = <span class="number">0</span></span><br><span class="line"><span class="built_in">F</span>(n) = &#123;  <span class="number">1</span>                         n = <span class="number">1</span></span><br><span class="line">       &#123;  <span class="built_in">F</span>(n - <span class="number">1</span>) + <span class="built_in">F</span>(n - <span class="number">2</span>)       n &gt; <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>代码实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AlgorithmStudy.cpp : 定义控制台应用程序的入口点。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Fibonacci</span><span class="params">(<span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>( n &lt;= <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">Fibonacci</span>(n - <span class="number">1</span>) + <span class="built_in">Fibonacci</span>(n - <span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> n;</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;Please Enter the Fibonacci&#x27;s n:&quot;</span>&lt;&lt;endl;</span><br><span class="line">	cin&gt;&gt;n;</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;Fibonacci(&quot;</span>&lt;&lt;n&lt;&lt;<span class="string">&quot;) = &quot;</span>&lt;&lt;<span class="built_in">Fibonacci</span>(n)&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Algorithem/FabonacciRecursion.PNG" alt="FabonacciRecursion"></p>
<p>还有一个典型的问题，汉诺塔问题。<br>问题描述：<br>a，b，c三个塔座。塔座a上共n个圆盘，圆盘至下而上从大到小的叠放在一起，圆盘编号从小到大为1,2,3……n。要求将塔座a上的这一叠圆盘移动到塔座b上，并按同样顺序叠放。移动规则如下：</p>
<ol>
<li>每次只能移动一个圆盘</li>
<li>任何时时刻都不允许将较大的圆盘压在较小的圆盘会上</li>
<li>在满足移动规则1和2的前提下，将圆盘至a，b，c中任意塔座上。</li>
</ol>
<p>解题思想：<br>若是奇数次移动，则将最小的圆盘移到顺时针方向的下一座塔上。若是偶数次移动，则保持最小的圆盘不动，而在其他两个塔座之间，将较小的圆盘移动到另一个塔座上。</p>
<p>那么如何用递归来实现这个解题思想了。<br>当n &#x3D; 1时，将编号1的圆盘从塔座a移动到塔座b即可。<br>当n &gt; 1时，需要利用塔座c作为辅助塔座。此时要设法将n - 1个较小的圆盘依照移动规则从塔座a移至塔座c上，然后，将剩下的最大圆盘从塔座a移至塔座b上，最后，再设法将n - 1个较小的圆盘你依照移动规则从塔座c移至塔座b上。(由此可见，n个圆盘的移动问题分解成为了两次n - 1个圆盘的移动问题，这就可以通过递归的方式解决)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Hanoi</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(n &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="built_in">Hanoi</span>(n - <span class="number">1</span>, a, c, b); <span class="comment">// 将n - 1个圆盘按移动规则从a移动到c</span></span><br><span class="line">        <span class="built_in">move</span>(a,b);             <span class="comment">// 将圆盘n从a移动到b</span></span><br><span class="line">        <span class="built_in">Hanoi</span>(n <span class="number">-1</span>, c,  b, a); <span class="comment">// 将n - 1个圆盘按移动规则从c移动到b</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>递归算法好处：<br>结构清晰，可读性强，且容易用数学归纳法证明算法的正确性，方便调试。</p>
<p>递归算法坏处：<br>运行效率低，时间复杂度和空间复杂度都很大。</p>
<p>针对Fabonacci方法，我们可以写一个非递归的方法，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">FibonacciNoRecursion</span><span class="params">(<span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> temp[<span class="number">2</span>];</span><br><span class="line">	temp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">	temp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(n &lt;= <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">2</span>; i &lt; n; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">int</span> tp = temp[<span class="number">0</span>] + temp[<span class="number">1</span>];</span><br><span class="line">			temp[<span class="number">1</span>]= temp[<span class="number">0</span>];</span><br><span class="line">			temp[<span class="number">0</span>] = tp;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> temp[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来，递归调用导致的调用栈深度问题就没有了，而是通过临时变量把数据存储了起来。</p>
<h3 id="分治"><a href="#分治" class="headerlink" title="分治"></a>分治</h3><p>基本思想：<br>将一个规模为n的问题分解为k个(一般划分成n&#x2F;2 – 二分细分)规模较小的子问题，这些子问题互相独立且与原问题相同。递归的解这些子问题，然后将各子问题的解合并得到原问题的解。</p>
<p>在排序算法学习中，<a href="http://tonytang1990.github.io/2015/07/11/Sort-Algorithm/">快速排序(Quick Sort)和归并排序(Merge Sort)</a>就用到了分治的思想。</p>
<h3 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h3><p>基本思想：<br>动态规划与分治思想类似，但动态规划里经分解得到的子问题往往不是互相独立的。如果我们能够保存已解决的子问题的答案，而在需要时再找出已求得的答案，会这样就可以避免大量的重复计算，从而得到多项式时间算法。</p>
<p>动态规划适用于解最优化问题。一般有4个步骤设计：</p>
<ol>
<li>找出最优解的性质，并刻画其结构特征。</li>
<li>递归地定义最优值。</li>
<li>以自底向上的方式计算出最优值。</li>
<li>根据计算最优值时得到的信息，构造最优解。</li>
</ol>
<p>动态规划的基本要素：</p>
<ol>
<li>最优子结构<br>当问题的最优解包含其子问题的最优解时，称该问题具有最优子结构性质</li>
<li>重叠子问题<br>在递归算法自顶向下解此问题时，每次产生的子问题并不总是新问题，有些子问题被反复运算。</li>
<li>备忘录方法<br>备忘录方法是动态规划的变形，唯一不同的是递归方式是至顶向下。</li>
</ol>
<p>接下来以求解最长公共子序列来分析动态规划算法。<br>问题描述：<br>X &#x3D; {x1, x2, x3,…..xn}<br>Z &#x3D; {z1, z2, z3,…..zn}<br>存在一个递增序列，即Z是X的子序列。</p>
<p>X &#x3D; {x1, x2, x3,….. xm}<br>Y &#x3D; {y1, y2, y3,….. yn}<br>求解X和Y的最长公共子序列Z：<br>Z &#x3D; {z1, z2, z3,…zk}</p>
<p>分析最优子结构性质：<br>若X(m) &#x3D; Y(n)，则Z(k) &#x3D; X(m) &#x3D; Y(n)，且Z(k-1)是X(m-1)和Y(n-1)的最长公共子序列<br>若X(m) !&#x3D; Y(n)且Z(k)  !&#x3D; X(m)，则Z是X(m-1)和Y的最长公共子序列<br>若X(m) !&#x3D; Y(n)且Z(k) !&#x3D; Y(n)，则Z是X和Y(n-1)的最长公共子序列</p>
<p>c[i][j]记录序列X(i)和Y(j)的最长公共子序列的长度<br>从上面的最优子结构性质我们可以得出下列结论：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">          &#123;         <span class="number">0</span>                       i = <span class="number">0</span>, j = <span class="number">0</span></span><br><span class="line">c[i][j] = &#123;    c[i<span class="number">-1</span>][j<span class="number">-1</span>] + <span class="number">1</span>              i,j &gt; <span class="number">0</span>; <span class="built_in">X</span>(i) = <span class="built_in">Y</span>(j)</span><br><span class="line">          &#123; <span class="built_in">Max</span>(c[i][j<span class="number">-1</span>], c[i<span class="number">-1</span>][j])       i,j &gt; <span class="number">0</span>; <span class="built_in">X</span>(i) != <span class="built_in">Y</span>(j)</span><br></pre></td></tr></table></figure>
<p>从上面而已看出，在递归求的时候，很多子问题是重叠的。</p>
<p>b[i][j]用于记录c[i][j]的值是由哪一个子问题的解得到的。b最后会用于构建最优解。<br>我们把上面的情况分别分为1,2,3。在递归求解的时候存储的b[i][j]里。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">GetArrayLength</span><span class="params">(T &amp;array)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">sizeof</span>(array) / <span class="built_in">sizeof</span>(array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LCSLength</span><span class="params">(<span class="type">int</span> m, <span class="type">int</span> n, <span class="type">char</span> *x, <span class="type">char</span> *y, <span class="type">int</span> **c, <span class="type">int</span> **b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i,j;</span><br><span class="line">	<span class="comment">// i = 0, j = 0的情况</span></span><br><span class="line">	c[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		c[i][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		c[<span class="number">0</span>][i] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//自底向上的填充最优解</span></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// X(i) == Y(j)的情况</span></span><br><span class="line">			<span class="keyword">if</span>(x[i] == y[j])</span><br><span class="line">			&#123;</span><br><span class="line">				c[i][j] = c[i<span class="number">-1</span>][j<span class="number">-1</span>] + <span class="number">1</span>;</span><br><span class="line">				b[i][j] = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// X(i) != Y(j) 且 Max&#123;&#125;取c[i][j-1]</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(c[i<span class="number">-1</span>][j] &gt;= c[i][j - <span class="number">1</span>])</span><br><span class="line">			&#123;</span><br><span class="line">				c[i][j] = c[i<span class="number">-1</span>][j];</span><br><span class="line">				b[i][j] = <span class="number">2</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// X(i) != Y(j) 且 Max&#123;&#125;取c[i-1][j]</span></span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				c[i][j] = c[i][j<span class="number">-1</span>];</span><br><span class="line">				b[i][j] = <span class="number">3</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LCS</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j, <span class="type">char</span> *x, <span class="type">int</span> **b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(i == <span class="number">0</span> || j == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//根据前面LCSLength的分解情况，自底向上的递归构建最长公共子序列</span></span><br><span class="line">	<span class="keyword">if</span>(b[i][j] == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">LCS</span>(i<span class="number">-1</span>, j<span class="number">-1</span>, x, b);</span><br><span class="line">		cout&lt;&lt;x[i]&lt;&lt;endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(b[i][j] == <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">LCS</span>(i<span class="number">-1</span>, j, x, b);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">LCS</span>(i, j<span class="number">-1</span>, x, b);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//LCS,因为LCSLength里面都是以1作为索引来访问x和y的第一个字母，</span></span><br><span class="line">	<span class="comment">//所以这里增加一个额外的&quot; &quot;便于1作为第一个字母的索引</span></span><br><span class="line">	<span class="type">char</span> x[] = &#123;<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>&#125;;</span><br><span class="line">	<span class="type">char</span> y[] = &#123;<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;F&#x27;</span>&#125;;</span><br><span class="line">	<span class="type">int</span> **c = <span class="keyword">new</span> <span class="type">int</span>*[<span class="built_in">GetArrayLength</span>(x)];</span><br><span class="line">	<span class="type">int</span> **b = <span class="keyword">new</span> <span class="type">int</span>*[<span class="built_in">GetArrayLength</span>(x)];</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">GetArrayLength</span>(x); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		c[i] = <span class="keyword">new</span> <span class="type">int</span>[<span class="built_in">GetArrayLength</span>(y)];</span><br><span class="line">		b[i] = <span class="keyword">new</span> <span class="type">int</span>[<span class="built_in">GetArrayLength</span>(y)];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//因为前面我们额外增加了一个&quot; &quot;，所以这里要减少一个长度计算</span></span><br><span class="line">	<span class="built_in">LCSLength</span>(<span class="built_in">GetArrayLength</span>(x) - <span class="number">1</span>, <span class="built_in">GetArrayLength</span>(y) - <span class="number">1</span>, x, y, c, b);</span><br><span class="line">	<span class="built_in">LCS</span>(<span class="built_in">GetArrayLength</span>(x) - <span class="number">1</span>, <span class="built_in">GetArrayLength</span>(y) - <span class="number">1</span>, x, b);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Algorithem/LCSLength.PNG" alt="LCSLength"></p>
<p>算法时间复杂度分析：<br>计算最长公共序列的LCSLength耗时O(m x n);<br>构建最长公共序列的LCS递归调用自身使i和j - 1,时间复杂度为O(m + n)</p>
<p>算法改进：<br>c[i][j]可以由c[i-1][j-1],c[i-1][j]和c[i][j-1]推断出来，所以可以节省数组b的空间，但数组c仍需要m x n的空间，所以空间复杂度仍然是O(m x n)</p>
<p>另一个很典型的动态规划事例是0-1背包问题：<br>问题描述：<br>给定n种物品和一背包。物品i的重量是w(i)，其价值为v(i)，背包容量为c。应如何选择装入背包中的物品，使得装入背包中物品的总价值最大？</p>
<p>形式化描述：<br>给定c &gt; 0,w(i) &gt; 0, v(i) &gt; 0, i &lt;&#x3D; i &lt;&#x3D;n,要求找出一个n元0-1向量(x1,x2,x3…..,xn), x(i) ∈ {0, 1}, 1 &lt;&#x3D; i &lt;&#x3D; n,使得∑(i&#x3D; 1 - n)(w(i) x x(i)) &lt;&#x3D; c，而且∑(i&#x3D; 1 - n)(v(i) x x(i))达到最大。<br>转换成式子如下：<br>   max(∑( 1 &lt;&#x3D; i &lt;&#x3D; n)(v(i) x x(i)))<br>{  ∑(i&#x3D; 1 - n)(w(i) x x(i)) &lt;&#x3D; c<br>{  x(i) ∈ {0, 1}, 1 &lt;&#x3D; i &lt;&#x3D; n</p>
<p>分析：<br>最优子结构性质：<br>设(y1,y2……yn)是所给0-1背包问题的一个最优解，则(y2,y3…..yn)是下面相应子问题的一个最优解：<br>   max(∑(2 &lt;&#x3D; i &lt;&#x3D; n)(v(i) x x(i)))<br>{  ∑(2 &lt;&#x3D; i &lt;&#x3D; n)(w(i) x x(i)) &lt;&#x3D; c - w(1) x y(1)<br>{  x(i) ∈ {0, 1}, 2 &lt;&#x3D; i &lt;&#x3D; n</p>
<p>递归关系：<br>0-1背包问题的子问题：<br>   max(∑(i &lt;&#x3D; k &lt;&#x3D; n)(v(k) x x(k)))<br>{  ∑(i &lt;&#x3D; k &lt;&#x3D; n)(w(k) x x(k)) &lt;&#x3D; j<br>{  x(k) ∈ {0, 1}, i &lt;&#x3D; k &lt;&#x3D; n<br>m(i,j)是背包容量为j，可选物品为i,i+1…..n时0-1背包问题的最优解。<br>x(i)表示背包i的选择∈ {0, 1}<br>根据最优子结构性质，可以建立就按m(i,j)的递归式如下：<br>         {  max{m((i+1,j), m(i+1, j - w(i)) + v(i))}    j &gt;&#x3D; w(i)<br>m(i,j) &#x3D; {<br>         {  m(i+1,j)                                    0 &lt;&#x3D; j &lt;&#x3D; w(i)</p>
<pre><code>     &#123;  v(n)   j &gt;= w(n)
</code></pre>
<p>m(n,j) &#x3D; {<br>         {   0     0 &lt;&#x3D; j &lt; w(n)</p>
<p>计算出所有m[i][j]后，我们可以通过判断m[i][c]和m[i+1]<a href="c%E4%B8%BA%E5%BD%93%E5%89%8D%E8%83%8C%E5%8C%85%E5%89%A9%E4%BD%99%E5%AE%B9%E9%87%8F">c</a>是否相同来判断x(i)的值。</p>
<p>算法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vld.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">GetArrayLength</span><span class="params">(T &amp;array)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> length = <span class="built_in">sizeof</span>(array) / <span class="built_in">sizeof</span>(array[<span class="number">0</span>]);</span><br><span class="line">	<span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Knapsack</span><span class="params">(<span class="type">float</span> *v, <span class="type">int</span> *w, <span class="type">int</span> c, <span class="type">int</span> n, <span class="type">float</span> **m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> jmax = <span class="built_in">fmin</span>(w[n] - <span class="number">1</span>,c);</span><br><span class="line">	<span class="comment">//根据最优子结构性质，m[n - 1][j]的最优解是m[n][j]最优解的子集，</span></span><br><span class="line">	<span class="comment">//我们先构建出m[n][j]时的数据,然后利用m[n][j]的数据去构建m[i][c]  1 &lt;= i &lt; n</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt;= jmax; j++)</span><br><span class="line">	&#123;</span><br><span class="line">		m[n][j] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = w[n]; j &lt;= c; j++)</span><br><span class="line">	&#123;</span><br><span class="line">		m[n][j] = v[n];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//利用m[n][j]去构建m[i][j]   1 &lt;= i &lt; n</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = n - <span class="number">1</span>; i &gt; <span class="number">1</span>; i--)</span><br><span class="line">	&#123;</span><br><span class="line">		jmax = <span class="built_in">fmin</span>(w[i] - <span class="number">1</span>, c);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt;= jmax; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			m[i][j] = m[i + <span class="number">1</span>][j];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> j = w[i]; j &lt;= c; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			m[i][j] = <span class="built_in">fmax</span>(m[i + <span class="number">1</span>][j], m[i + <span class="number">1</span>][j - w[i]] + v[i]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Finally, we can get m[1][c] from c[2][c]</span></span><br><span class="line">	m[<span class="number">1</span>][c] = m[<span class="number">2</span>][c];</span><br><span class="line">	<span class="keyword">if</span> (c &gt;= w[<span class="number">1</span>])</span><br><span class="line">	&#123;</span><br><span class="line">		m[<span class="number">1</span>][c] = <span class="built_in">fmax</span>(m[<span class="number">2</span>][c], m[<span class="number">2</span>][c - w[<span class="number">1</span>]] + v[<span class="number">1</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Traceback</span><span class="params">(<span class="type">float</span> **m, <span class="type">int</span> *w, <span class="type">int</span> c, <span class="type">int</span> n, <span class="type">int</span> *x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (m[i][c] == m[i + <span class="number">1</span>][c])</span><br><span class="line">		&#123;</span><br><span class="line">			x[i] = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			x[i] = <span class="number">1</span>;</span><br><span class="line">			c -= w[i];</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Put &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot; into the bag!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//check for last one</span></span><br><span class="line">	x[n] = m[n][c] ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (x[n] == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;Put &quot;</span> &lt;&lt; n &lt;&lt; <span class="string">&quot; into the bag!&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//0-1背包问题</span></span><br><span class="line">	<span class="comment">//因为我们从v[1]开始访问当做第一个背包的价值，</span></span><br><span class="line">	<span class="comment">//所以这里加一个0在最前面方便从1开始索引</span></span><br><span class="line">	<span class="type">float</span> v[] = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">3</span> &#125;;</span><br><span class="line">	<span class="type">int</span> w[] = &#123; <span class="number">0</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span> &#125;;</span><br><span class="line">	<span class="type">int</span> c = <span class="number">20</span>;</span><br><span class="line">	<span class="comment">//减掉我们额外增加的第一个</span></span><br><span class="line">	<span class="type">int</span> n = <span class="built_in">GetArrayLength</span>(v) - <span class="number">1</span>;</span><br><span class="line">	<span class="type">float</span> **m = <span class="keyword">new</span> <span class="type">float</span>*[<span class="built_in">GetArrayLength</span>(v)];</span><br><span class="line">	<span class="comment">//为了从1开始索引</span></span><br><span class="line">	<span class="type">int</span> *x = <span class="keyword">new</span> <span class="type">int</span>[n + <span class="number">1</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">GetArrayLength</span>(v); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//m[i][j]    1 &lt;= j &lt;= n用于表示背包容量为j，可选物品为i,i+1....n是0-1背包问题的最优解</span></span><br><span class="line">		<span class="comment">//为了m[i][c]来访问背包重量为c的时候的最优解，这里需要额外增加数组长度1</span></span><br><span class="line">		m[i] = <span class="keyword">new</span> <span class="type">float</span>[c + <span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Knapsack</span>(v, w, c, n, m);</span><br><span class="line">	<span class="built_in">Traceback</span>(m, w, c, n, x);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">GetArrayLength</span>(v); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">delete</span> m[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span> x;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Algorithem/01Knapsack.PNG" alt="01Knapsack"></p>
<p>算法复杂度分析：<br>计算m[i][j]的递归式可以看出，算法Knapsack需要O(nc)计算时间，Traceback需要O(n)计算时间</p>
<p>算法缺点：</p>
<ol>
<li>w[i]要求是整数</li>
<li>当c很大的时候，算法Knapsack时间复杂度很大</li>
</ol>
<p>算法改进：<br>详情参考计算机算法设计与分析(第3版)</p>
<h3 id="贪心算法"><a href="#贪心算法" class="headerlink" title="贪心算法"></a>贪心算法</h3><p>基本思想：<br>贪心算法通过一系列的选择来得到问题的解。它所做的每一个选择都是当前状态下局部最好选择，即贪心选择。</p>
<p>基本要素：</p>
<ol>
<li>贪心选择性质<br>贪心选择性质是指所求问题的整体最优解可以通过一系列局部最优的选择，即贪心选择来达到。(贪心算法以自顶向下的方式进行，以迭代的方式做出相继的贪心选择，每做一次贪心选择就将所求问题简化为规模更小的子问题)</li>
<li>最优子结构性质<br>最优解包含其子问题的最优解时，称此问题具有最优子结构性质。</li>
</ol>
<p>下面结合背包问题来区分动态规划和贪心算法在实际应用中的区别：<br>问题描述：<br>背包问题与0-1背包问题类似，所不同的是在选择物品i装入背包时，可以选择物品i的一部分，而不一定要全部装入背包，1 &lt;&#x3D; i &lt;&#x3D; n。</p>
<p>最优子结构性质分析：<br>若它的一个最优解包含物品j，则从该最优解中拿出所含的物品j的那部分重量w，剩余的将是n-1个原重量物品1,2,…,j-1,j+1,…,n及重为w(j)-w的物品j中可装入容量为c-w的背包且具有最大价值的物品。</p>
<p>贪心选择性质分析：<br>按单位价值为依据(局部最优)进行选择(贪心选择)，可使最终装满背包时，价值最大。</p>
<p>贪心算法解背包问题的基本步骤：</p>
<ol>
<li>计算每种物品单位重量的价值v(i)&#x2F;w(i)</li>
<li>依贪心选择策略，将尽可能多的单位重量价值最高的物品装入背包。</li>
<li>若将这种物品全部装入背包后，背包内的物品总重量未超过c，则选择单位重量价值次高的物品并尽可能多的装入背包。</li>
<li>依次策略，直到背包装满为止。</li>
</ol>
<p>贪心选择对于0-1背包问题就不能得到最优解，因为它无法保证最终背包能装满，部分闲置的背包空间使每千克背包空间的价值降低了。所以在考虑0-1背包问题时，应比较选择该物品和不选择该物品所导致的最终方案，然后做出最好选择，而不是按最优单位价值(局部最优)来选。</p>
<h3 id="回溯法算法"><a href="#回溯法算法" class="headerlink" title="回溯法算法"></a>回溯法算法</h3><p>回溯法的算法框架：</p>
<ol>
<li>问题的解空间<br>解空间包含所有可能的答案</li>
<li>回溯法的基本思想<br>在问题的解空间树种，按深度优先策略，从根节点触发搜索解空间树。算法搜索到任一节点时，先判断该节点是否包含问题的解，如果不包含，则以该节点为根节点以深度优先搜索。直到搜索到叶节点也没找到问题解时，回溯到最近一个非叶节点继续搜索，知道所有节点都搜索完成为止。</li>
</ol>
<p>接下来以0-1背包问题为例来学习理解回溯法：<br>假设0-1背包n &#x3D; 3，w &#x3D; [16, 15, 15] v &#x3D; [45, 25, 25] c&#x3D; 30<br>解空间为：<br>{(0,0,0), (0,1,0), (0,0,1), (1,0,0), (0,1,1), (1,0,1), (1,1,0), (1,1,1)}<br><img src="/img/Algorithem/Backtracking.PNG" alt="Backtracking"><br>因为是以深度优先搜索，所以是延A -&gt; B -&gt; D -&gt; H -&gt; D -&gt; I -&gt; D -&gt; B -&gt; E -&gt; J -&gt; K的顺序来搜索，直到回溯完所有的解空间节点或找到答案为止。</p>
<p>问题:<br>上述回溯法把所有的解空间都搜索了一遍，时间和空间复杂度大。</p>
<p>优化：<br>回溯法通常采用两种策略避免无效搜索，提高回溯法的搜索效率：</p>
<ol>
<li>用约束函数在扩展结点处剪去不满足约束条件的子树。</li>
<li>用限界函数剪去得不到最优解的子树。(两个函数统称为剪枝函数)</li>
</ol>
<p>在0-1背包里左子树表示装载当前背包，右子树表示不装载当前背包。<br>所以在针对剪枝函数的优化上，我们可以在判断只有在右子树中有可能包含最优解时才进入。设r是当前剩余物品价值总和；cp是当前价值；bestp是当前最优价值。当cp + r &lt;&#x3D; bestp时，可剪去右子树。</p>
<p>正确的选取r是优化的关键之一：<br>我们可以通过按背包问题里贪心算法的方式计算出当前剩余物品的最优值(算出当前剩余物品最多还能增加的价值)作为上界剪枝。</p>
<p>代码实现:<br>Utilites.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GetArrayLength</span><span class="params">(T &amp;array)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> length = <span class="built_in">sizeof</span>(array) / <span class="built_in">sizeof</span>(array[<span class="number">0</span>]);</span><br><span class="line">	<span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Knap.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Knap</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Knap</span>(<span class="type">float</span> *v, <span class="type">int</span> *w, <span class="type">int</span> c, <span class="type">int</span> n);</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">Knap</span>();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Backtrack</span><span class="params">(<span class="type">int</span> i)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">float</span> <span class="title">GetBestp</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="type">float</span> <span class="title">Bound</span><span class="params">(<span class="type">int</span> i)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//把物品按单位价值降序排列</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Sort</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mC; <span class="comment">//背包容量</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mN; <span class="comment">//物品数量</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> *mW; <span class="comment">//物品重量</span></span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> *mV; <span class="comment">//物品价值</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mCW; <span class="comment">//当前重量</span></span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> mCV; <span class="comment">//当前价值</span></span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> mBestp; <span class="comment">//当前最优价值</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Knap.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Knap.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Utilties.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Knap::<span class="built_in">Knap</span>(<span class="type">float</span> *v, <span class="type">int</span> *w, <span class="type">int</span> c, <span class="type">int</span> n)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">assert</span>(c &gt; <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">assert</span>(n &gt; <span class="number">0</span>);</span><br><span class="line">	mC = c;</span><br><span class="line">	mN = n;</span><br><span class="line">	mW = w;</span><br><span class="line">	mV = v;</span><br><span class="line">	mCW = <span class="number">0</span>;</span><br><span class="line">	mCV = <span class="number">0</span>; </span><br><span class="line">	mBestp = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">Sort</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Knap::Backtrack</span><span class="params">(<span class="type">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//到达叶节点</span></span><br><span class="line">	<span class="keyword">if</span> (i &gt; mN)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//到了叶节点后记录最优值</span></span><br><span class="line">		mBestp = mCV;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//进入左子树</span></span><br><span class="line">	<span class="keyword">if</span> (mCW + mW[i] &lt;= mC)</span><br><span class="line">	&#123;</span><br><span class="line">		mCW += mW[i];</span><br><span class="line">		mCV += mV[i];</span><br><span class="line">		<span class="comment">//深度优先扩张</span></span><br><span class="line">		<span class="built_in">Backtrack</span>(i + <span class="number">1</span>);</span><br><span class="line">		<span class="comment">//回溯到i时，我们需要在判断是否进入右子树之前把mCW和mCV的值回复到正确的值。</span></span><br><span class="line">		mCW -= mW[i];</span><br><span class="line">		mCV -= mV[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//进入右子树</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">Bound</span>(i + <span class="number">1</span>) &gt; mBestp)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//继续深度优先扩张</span></span><br><span class="line">		<span class="built_in">Backtrack</span>(i + <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">Knap::GetBestp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mBestp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//计算cp + r &lt;= bestp中r的值</span></span><br><span class="line"><span class="comment">//通过把剩余物品按贪心算法的背包问题来计算出最优值上界</span></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">Knap::Bound</span><span class="params">(<span class="type">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> cleft = mC - mCW; <span class="comment">//剩余容量</span></span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> b = mCV; <span class="comment">//当前价值</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//以物品单位重量价值递减序装入物品</span></span><br><span class="line">	<span class="keyword">while</span> (i &lt;= mN &amp;&amp; mW[i] &lt;= cleft)</span><br><span class="line">	&#123;</span><br><span class="line">		cleft -= mW[i];</span><br><span class="line">		b += mV[i];</span><br><span class="line">		i++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//装满背包</span></span><br><span class="line">	<span class="keyword">if</span> (i &lt;= mN)</span><br><span class="line">	&#123;</span><br><span class="line">		b += mV[i] * cleft / mW[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Knap::Sort</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">assert</span>(mN &gt; <span class="number">0</span>);</span><br><span class="line">	<span class="type">float</span> *pervalue = <span class="keyword">new</span> <span class="type">float</span>[mN];</span><br><span class="line">	pervalue[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= mN; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		pervalue[i] = mV[i] / mW[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//双重循环都跟数据大小有关</span></span><br><span class="line">	<span class="comment">//所以冒泡排序平均时间复杂度是O(square(n))</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= mN; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> j = i + <span class="number">1</span>; j &lt;= mN; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (pervalue[i] &lt; pervalue[j])</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">swap</span>(mV[i], mV[j]);</span><br><span class="line">				<span class="built_in">swap</span>(mW[i], mW[j]);</span><br><span class="line">				<span class="built_in">swap</span>(pervalue[i], pervalue[j]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Knap::~<span class="built_in">Knap</span>()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>main.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;	</span><br><span class="line">	<span class="comment">//0-1背包回溯算法</span></span><br><span class="line">	<span class="comment">//因为我们从v[1]开始访问当做第一个背包的价值，</span></span><br><span class="line">	<span class="comment">//所以这里加一个0在最前面方便从1开始索引</span></span><br><span class="line">	<span class="type">float</span> v[] = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">3</span> &#125;;</span><br><span class="line">	<span class="type">int</span> w[] = &#123; <span class="number">0</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span> &#125;;</span><br><span class="line">	<span class="type">int</span> c = <span class="number">20</span>;</span><br><span class="line">	<span class="comment">//减掉我们额外增加的第一个</span></span><br><span class="line">	<span class="type">int</span> n = <span class="built_in">GetArrayLength</span>(v) - <span class="number">1</span>;</span><br><span class="line">	Knap *knap = <span class="keyword">new</span> <span class="built_in">Knap</span>(v, w, c, n);</span><br><span class="line"></span><br><span class="line">	knap-&gt;<span class="built_in">Backtrack</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;knap-&gt;GetBestp() = &quot;</span> &lt;&lt; knap-&gt;<span class="built_in">GetBestp</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span> knap;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Algorithem/BacktrackingResult.PNG" alt="BacktrackingResult"></p>
<p>时间复杂度分析：<br>Knap::Sort()排序采用冒泡排序，时间复杂度为：<br>平均时间复杂度：O(square(n))<br>最坏时间复杂度：O(square(n)) （每一次比较都需要交换）<br>最优时间复杂度：O(n) （第一次循环就完成所有排序而无需进行后面的，需要判断结束条件）</p>
<p>Knap::Bound()计算上界剪枝需要O(n)<br>最坏情况下有O(Pow(2,n))个右节点，所以回溯算法的最坏时间复杂度为O(n x Pow(2,n))<br>跟动态规划解0-1背包的O(nc)时间复杂度相比，回溯算法的时间复杂度大得多。</p>
<p>Note:<br>剪枝函数(约束函数和上界函数)的选取是回溯法性能的关键。</p>
<h3 id="分支限界法"><a href="#分支限界法" class="headerlink" title="分支限界法"></a>分支限界法</h3><p>待续…..</p>
<h1 id="STL"><a href="#STL" class="headerlink" title="STL"></a>STL</h1><p>C++里将数据结构和算法运用的比较好的就不得不提STL了。</p>
<h2 id="STL-1"><a href="#STL-1" class="headerlink" title="STL"></a>STL</h2><p>STL(标准模板库)是C++标准程序库的核心，是一个泛型程序库，利用先进，高效的算法来管理数据。</p>
<h2 id="STL组件"><a href="#STL组件" class="headerlink" title="STL组件"></a>STL组件</h2><ol>
<li>容器(Containers)<br>用来管理某类对象的集合。</li>
<li>迭代器(Iterators)<br>用来在一个对象群集(Collection of objects)的元素上进行遍历动作</li>
<li>算法(Algorithoms)<br>用来处理群集内的元素。(比如搜寻，排序，修改，使用等)</li>
</ol>
<p>“STL的基本观念就是将数据和操作分离。数据由容器类加以管理，操作则由可定制的算法定义。迭代器在两者之间充当粘合剂是的任何算法都可以和任何容器运作。”<br><img src="/img/CPP/STLComponentsRelationship.PNG" alt="STLComponentsRelationship"></p>
<p>STL将数据和算法分开对待，这和面向对象设计(OOP)的思想是矛盾的。<br>但这么做的好处是：<br>可以将各容器与各算法结合起来。</p>
<p>STL的特性一：<br>泛型，可以针对任意类型运作</p>
<p>Note:<br>“STL甚至提供更泛型化的组件。通过特定的适配器(adapters)和仿函数(functors)，你可以补充，约束或定制算法，以满足特别需求。”</p>
<h3 id="容器-Containers"><a href="#容器-Containers" class="headerlink" title="容器(Containers)"></a>容器(Containers)</h3><p>容器可分为两类：</p>
<ol>
<li>Sequence Containers<br>“可序(ordered)群集，每个元素均有固定位置–取决于插入时机和地点，和元素值无关。”<br>vector，deque，list<br>Vectors特点(Vector将其元素置于一个dynamic array)：<ol>
<li>允许随机存储。</li>
<li>非尾部插入会比较费时(要保持原本的相对次序，导致元素移动)</li>
<li>动态扩容<br>Deques特点(double-ended queue是一个dynamic array，可以向两端发展)：</li>
<li>允许随机存储</li>
<li>头部和尾部插入迅速</li>
<li>中间部分插入费时(导致元素移动)</li>
<li>动态扩容<br>Lists特点(doubly linked list，分散存储内存):</li>
<li>不提供随机存取(因为是分散存储的)</li>
<li>访问元素费时(沿着链表节点访问)</li>
<li>插入和删除快速(因为只需要改变链接点即可)</li>
<li>动态扩容</li>
</ol>
</li>
<li>Associative Containers<br>“已序(sorted)群集，元素位置取决于特定的排序准则。”<br>set，multiset，map，multimap<br>Sets特点:<ol>
<li>依据值自动排序</li>
<li>每个元素值只允许出现一次</li>
<li>动态扩容<br>Multisets特点：</li>
<li>依据值自动排序</li>
<li>允许重复元素</li>
<li>动态扩容<br>Maps特点：</li>
<li>采用键值对存储，根据键值排序</li>
<li>键值不允许重复</li>
<li>动态扩容<br>Multimaps特点：</li>
<li>采用键值对存储，根据键值排序</li>
<li>允许键值重复</li>
<li>动态扩容</li>
</ol>
</li>
</ol>
<p>除了上述容器，C++标准成宿还提供了一些特别的Container Adapters。<br>Container Adapaters：</p>
<ol>
<li>Stacks<br>LIFO(后进先出)</li>
<li>Queues<br>FIFO(先进先出)</li>
<li>Priority Queues<br>元素按优先级排序</li>
</ol>
<p>Note:<br>“通常关联式容器由二叉树(binary tree)实现。”</p>
<p>容器的共同能力：</p>
<ol>
<li>所有容器提供的都是“Value语意”而非“Reference语意”<br>Value语意 VS Reference语意<br>“STL只支持value语意，不支持reference语意”<br>好处：<ol>
<li>元素拷贝简单</li>
<li>使用references时容易导致错误<br>缺点：</li>
<li>“拷贝元素”可能导致不好的性能</li>
<li>无法在数个不同的容器中管理同一份对象</li>
</ol>
</li>
<li>所有元素形成一个次序(返回iterator的接口用于访问所有元素)</li>
<li>各项操作并非绝对安全。调用者必须确保传给操作函数的参数符合需求。</li>
</ol>
<p>Note:<br>实现Reference语意需要通过智能指针(e.g. share_ptr)</p>
<p>容器的共同操作：</p>
<ol>
<li>初始化</li>
<li>大小相关操作函数(size(),empty(),max_size())</li>
<li>比较(&#x3D;&#x3D;,!&#x3D;,&lt;,&lt;&#x3D;,&gt;,&gt;&#x3D;)</li>
</ol>
<p>Value语意也就引出了容器元素的条件：</p>
<ol>
<li>必须可透过copy构造函数进行复制</li>
<li>必须可以透过assignment操作符完成赋值动作</li>
<li>必须可以透过析构函数完成销毁动作</li>
</ol>
<p>如何选择合适的Container？<br>根据以下规则：</p>
<ol>
<li>缺省情况下使用vector，vector内部结构简单，支持随机存储</li>
<li>如果经常要在头部和尾部安插和移除元素，采用deque</li>
<li>如果需要经常在容器的中段执行元素的插入，移除和移动，可以考虑使用list</li>
<li>如果经常需要根据某个准则来搜寻元素，那么应当使用“以该排序准则对元素进行排序”的set或multiset(hash table比二叉树更快，对于无需排序的元素，推荐用hash table)</li>
<li>如果想处理key&#x2F;value pair，采用map或multimap</li>
<li>如果需要关联式数组，应用map</li>
<li>如果需要字典结构，应用multimap</li>
</ol>
<p>STL Container能力详情参见：<br><img src="/img/CPP/STLContainerCapabilities.PNG" alt="STLContainerCapabilities"></p>
<h4 id="容器内的类型和成员"><a href="#容器内的类型和成员" class="headerlink" title="容器内的类型和成员"></a>容器内的类型和成员</h4><p>容器内的类型：<br>container::value_type – 元素类型<br>container::reference –元素的引用类型<br>container::const_reference – 常数元素的引用类型<br>container::iterator – 迭代器类型<br>container::const_iterator – 常数迭代器的类型<br>container::const_reverse_iteator – 常数反向迭代器的类型<br>container::size_type – 无符号整数类型，用以定义容器大小<br>container::difference_type – 正整数类型，用以定义距离<br>container::key_type – 用以定义关联式容器的元素内的key类型<br>container::mapped_type – 用以定义关联式容器的元素内的value类型<br>container::key_compare – 关联式容器内的“比较准则”的类型<br>container::value_compare – 整个元素”比较准则”的类型<br>container::allocator_type – 配置器类型</p>
<p>生成，复制，销毁,非变动性操作,赋值,元素存储,返回迭代器操作,元素insert和remove:<br>……<br>……</p>
<h3 id="迭代器-Iterators"><a href="#迭代器-Iterators" class="headerlink" title="迭代器(Iterators)"></a>迭代器(Iterators)</h3><p>什么是迭代器(Iteratos)？<br>“迭代器是一个“可遍历STL容器内全部或部分元素”的对象。”</p>
<p>Note:<br>“迭代器奉行一个村抽象概念：任何东西，只要行为类似迭代器，就是一种迭代器。不同的迭代器具有不同的“能力”(指行进和存储能力)”</p>
<p>迭代器分类：<br><img src="/img/CPP/STLIteratorClassification.PNG" alt="STLIteratorClassification"></p>
<p>迭代器的能力取决于容器的内部结构，所以根据能力来分类的话：</p>
<ol>
<li>双向迭代器(Bidirectional iterator)<br>支持双向行进(++ –)(list, set, multiset, map, multimap)</li>
<li>随机存取迭代器(Random access iterator)<br>支持双向行进同时具备随机访问(&lt; &gt;等)(vector, deque)</li>
</ol>
<p>“为了编写与容器类型无关的泛型程序编码，最好不要使用随机存取迭代器。(因为不是所有的容器都支持随机迭代器)”</p>
<p>比如如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(pos = coll.<span class="built_in">begin</span>(); pos &lt; col.<span class="built_in">end</span>(); ++pos)</span><br><span class="line">&#123;</span><br><span class="line">	.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面使用的&lt;就是随机存储迭代器才支持的。</p>
<p>Note:<br>是否支持特定迭代器跟迭代器的能力和容器的内部结构挂钩(比如List因为是链接形式所以肯定不支持Random access iterator的随机访问的)。</p>
<p>迭代器操作：</p>
<ol>
<li>Operator *<br>返回当前元素值</li>
<li>Operator ++<br>访问下一个元素</li>
<li>Operators &#x3D;&#x3D;<br>判断迭代器是否指向同一位置</li>
<li>Operators ！&#x3D;<br>判断迭代器是否指向同一位置</li>
<li>Operator &#x3D;<br>为迭代器赋值</li>
</ol>
<p>“迭代器是个所谓的smart pointers，具有遍历复杂数据结构的能力。其下层运行机制取决于其所遍历的数据结构。因此，每一种容器类型都必须提供自己的迭代器。”</p>
<p>容器类提供的迭代器访问相关函数：</p>
<ol>
<li>begin()<br>返回一个迭代器，指向容器的起始点</li>
<li>end()<br>返回一个迭代器，指向容器结束点(最后一个元素之后)</li>
</ol>
<p>读写方式区分：</p>
<ol>
<li>iterator<br>支持读&#x2F;写模式</li>
<li>const_iterator<br>只读模式</li>
</ol>
<p>这里通过简单的使用Set container为例，对iterator和自定义比较函数做个了解：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STLStudy.cpp : Defines the entry point for the console application.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Greater</span><span class="params">(<span class="type">const</span> T&amp; p1, <span class="type">const</span> T&amp; p2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> p1 &gt; p2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//Associative Container</span></span><br><span class="line">	<span class="built_in">bool</span>(*fn_pt)(<span class="type">const</span> <span class="type">int</span>&amp;,<span class="type">const</span> <span class="type">int</span>&amp;) = Greater&lt;<span class="type">int</span>&gt;;</span><br><span class="line">	<span class="function">set&lt;<span class="type">int</span>, <span class="title">bool</span><span class="params">(*)</span><span class="params">(<span class="type">const</span> <span class="type">int</span>&amp;,<span class="type">const</span> <span class="type">int</span>&amp;)</span>&gt; <span class="title">s</span><span class="params">(fn_pt)</span></span>;</span><br><span class="line"></span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">4</span>);</span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">3</span>);</span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">2</span>);</span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">6</span>);</span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">5</span>);</span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	set&lt;<span class="type">int</span>&gt;::const_iterator set_const_iterator;</span><br><span class="line">	<span class="keyword">for</span> (set_const_iterator = s.<span class="built_in">begin</span>(); set_const_iterator != s.<span class="built_in">end</span>(); ++set_const_iterator)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; *set_const_iterator&lt;&lt;endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/SetIteratorAndCompareFunction.PNG" alt="SetIteratorAndCompareFunction"><br>从上面可以看到set有自己对应的iterator去访问set container里的元素，同时我们也可以传递一个自定义的比较函数作为set container排序的依据。</p>
<p>迭代器相关辅助函数：</p>
<ol>
<li>advance() – 可令迭代器前进</li>
<li>distance() – 计算两个迭代器之间的距离</li>
<li>iter_swap() – 交换两个迭代器所指内容</li>
</ol>
<p>Iterator Adapter：</p>
<ol>
<li>Insert iterators<br>使算法以安插(insert)方式而非覆写(overwrite)方式运作<ol>
<li>Back inserters(安插于容器最尾端)</li>
<li>Front inserters(安插于容器最前端)</li>
<li>General inserters(安插到指定位置)</li>
</ol>
</li>
<li>Stream iterators<br>用于读写stream的迭代器。</li>
<li>Reverse iterators<br>以逆方向进行所有操作(++相当于–  –相当于++)<br>通过容器的rbegin()，rend()可以获得Reverse iterators</li>
</ol>
<p>迭代器特性(Iterator Traits):<br>“迭代器可以区分为不同类型，每个类型都具有特定的迭代器功能。如果能根据不同的迭代器类型，将操作行为重载，将会很有用，甚至很必要。透过迭代器标记(tags)和特性(traits)可以实现这样的重载。”</p>
<p>首先来看看迭代器标志的定义：<br><img src="/img/CPP/STLIteratorTags.PNG" alt="STLIteratorTags"></p>
<p>接下来是迭代器特性(包含迭代器相关的所有信息)的定义：<br><img src="/img/CPP/STLIteratorTraits.PNG" alt="STLIteratorTraits"><br>“有了上面这个template，T表示迭代器类型，我们就可以撰写任何运用“迭代器类型或其元素类型”等特征的泛型程序代码”</p>
<p>iterator_traits<T>结构描述了迭代器相关的类型信息。<br>针对特定的迭代器(一般指针作为迭代器时)需要特化版本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> std&#123;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">iterator_traits</span>&lt;T*&gt;&#123;</span><br><span class="line">		<span class="keyword">typedef</span> T                            value_type;</span><br><span class="line">		<span class="keyword">typedef</span> <span class="type">ptrdiff_t</span>                    difference_type;</span><br><span class="line">		<span class="keyword">typedef</span> random_access_iterator_tag   iterator_category</span><br><span class="line">		<span class="keyword">typedef</span> T*                           pointer;</span><br><span class="line">		<span class="keyword">typedef</span> T&amp;                           reference;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如元素环形移动：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Forwarditerator&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shift_left</span><span class="params">(Forwarditerator beg, Forwarditerator end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//temporary variable for first element</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">typename</span> std::iterator_traits&lt;Forwarditerator&gt;::value_type value_type;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(beg != end)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//save value of first element</span></span><br><span class="line">		<span class="function">value_type <span class="title">temp</span><span class="params">(*beg)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//shift following values</span></span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过把迭代器类型作为模板参数通过iterator_traits访问该迭代器类型的value_type。</p>
<p>iterator_traits里的iterator_category可以帮助我们写出针对不同迭代器类型的函数。<br>接下来结合distance()的实现来学习理解</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">iterator</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> std::iterator_traits&lt;iterator&gt;::<span class="function">difference_type <span class="title">distance</span><span class="params">(iterator pos1, iterator pos2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">distance</span>(pos1, pos2, std::iterator_traits&lt;iterator&gt;::<span class="built_in">iterator_category</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Raiterator</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> std::iterator_traits&lt;Raiterator&gt;::<span class="function">difference_type <span class="title">foo</span><span class="params">(Raiterator pos1, Raiterator pos2, std::random_access_iterator_tag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> pos2 - pos1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Initerator</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> std::iterator_traits&lt;Initerator&gt;::<span class="function">difference_type <span class="title">foo</span><span class="params">(Initerator pos1, Initerator pos2, std::input_iterator_tag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">typename</span> std::iterator_traits&lt;Initerator&gt;::difference_type d;</span><br><span class="line">	<span class="keyword">for</span>(d = <span class="number">0</span>; pos1 != pos2; ++pos1, ++d)</span><br><span class="line">	&#123;</span><br><span class="line">		;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据传递迭代器类型iterator_category()作为第三个参数，我们可以写出针对不同迭代器类型的distance方法实现。根据迭代器是否支持随机访问，我们写出了不同的distance计算实现。<br>Note：<br>difference_type代表迭代器距离类型。同时std::tag对于子类同时有效。</p>
<p>如何自定义迭代器？<br>可以看出迭代器必须具有iterator_traits结构所描述的类型定义，用于描述迭代器相关类型信息。</p>
<ol>
<li>提供必要的五种类型定义(iterator_traits里定义的)</li>
<li>提供一个特化版本(用于一般指针迭代器)的iterator_traits结构</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Container&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyInsertIterator</span> : <span class="keyword">public</span> std::iterator&lt;std::output_iterator_tag, <span class="type">void</span>, <span class="type">void</span>, <span class="type">void</span>, <span class="type">void</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	Container&amp; container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">MyInsertIterator</span><span class="params">(Container&amp; c)</span> : container(c)</span></span><br><span class="line"><span class="function">	&#123;</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MyInsertIterator&lt;Container&gt;&amp; <span class="keyword">operator</span>= (<span class="type">const</span> <span class="keyword">typename</span> Container::value_type&amp; value)</span><br><span class="line">	&#123;</span><br><span class="line">		container.<span class="built_in">insert</span>(value);</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MyInsertIterator&lt;Container&gt;&amp; <span class="keyword">operator</span>* ()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MyInsertIterator&lt;Container&gt;&amp; <span class="keyword">operator</span>++ ()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MyInsertIterator&lt;Container&gt;&amp; <span class="keyword">operator</span>++ (<span class="type">int</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//convenience function to create the MyInsertIterator</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Container&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> MyInsertIterator&lt;Container&gt; <span class="title">MyInsert</span><span class="params">(Container&amp; c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">MyInsertIterator</span>&lt;Container&gt;(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试程序</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MyInsertIterator.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//My own Iterator part</span></span><br><span class="line">	set&lt;<span class="type">int</span>&gt; coll;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//create MyInsertIterator for coll</span></span><br><span class="line">	MyInsertIterator&lt;set&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">iter</span>(coll);</span><br><span class="line">	*iter = <span class="number">1</span>;</span><br><span class="line">	iter++;</span><br><span class="line">	*iter = <span class="number">2</span>;</span><br><span class="line">	iter++;</span><br><span class="line">	*iter = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">PrintAll</span>(coll);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">MyInsert</span>(coll) = <span class="number">44</span>;</span><br><span class="line">	<span class="built_in">MyInsert</span>(coll) = <span class="number">55</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">PrintAll</span>(coll);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLOwnIterator.PNG" alt="STLOwnIterator"><br>把iterator作为父类，通过设定模板参数设置iterator_traits里需要设定的类型相关信息。<br>通过重载各个运算符实现我们自己的迭代器支持的操作。</p>
<p>Note：<br>“Iterator traits是掌握STL编程技术的关键。”</p>
<h3 id="算法-Algorithms"><a href="#算法-Algorithms" class="headerlink" title="算法(Algorithms)"></a>算法(Algorithms)</h3><p>“算法并非容器类的成员函数，而是一种搭配迭代器使用的全局函数。”</p>
<p>这样做的好处：<br>“不必为每一种容器量身定制算法，所有算法只需一份。”</p>
<p>先来看看实战使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//cout &lt;&lt; MyClass::mID &lt;&lt; endl;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//Sequence container</span></span><br><span class="line">	vector&lt;<span class="type">int</span>&gt; v;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		v.<span class="built_in">push_back</span>(i);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">reverse</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">	vector&lt;<span class="type">int</span>&gt;::const_iterator vector_const_iterator;</span><br><span class="line">	<span class="keyword">for</span> (vector_const_iterator = v.<span class="built_in">begin</span>(); vector_const_iterator != v.<span class="built_in">end</span>(); ++vector_const_iterator)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; *vector_const_iterator &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLAlgorithems.PNG" alt="STLAlgorithems"><br>从上面reverse的调用可以看出，用户需要负责传入两个iterator作为访问区间。<br>但这样做的话接口虽然灵活，但是确需要用户去保证传入的两个iterator的有效性。</p>
<p>算法分类：</p>
<ol>
<li>Manipulating Algorithms<br> 是指会“删除或重排或修改元素”的算法<br> remmove,resort,modify……<br> 下面以remove算法为例：</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintAll</span><span class="params">(T container)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">typename</span> T::const_iterator const_iterator;</span><br><span class="line">	<span class="keyword">for</span> (const_iterator = container.<span class="built_in">begin</span>(); const_iterator != container.<span class="built_in">end</span>(); ++const_iterator)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; *const_iterator &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;-------------------------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//cout &lt;&lt; MyClass::mID &lt;&lt; endl;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//Sequence container</span></span><br><span class="line">	vector&lt;<span class="type">int</span>&gt; v;</span><br><span class="line">	vector&lt;<span class="type">int</span>&gt; v2;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		v.<span class="built_in">push_back</span>(i);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">reverse</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//PrintAll&lt;vector&lt;int&gt;::const_iterator&gt;(v.begin(), v.end());</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">copy</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>(), <span class="built_in">inserter</span>(v2, v<span class="number">2.</span><span class="built_in">begin</span>()));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//PrintAll&lt;vector&lt;int&gt;::const_iterator&gt;(v2.begin(), v2.end());</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//注意remove不会改变container数量，只是用后面的覆盖符合规则的元素</span></span><br><span class="line">	<span class="comment">//同时返回新的最尾端元素iterator</span></span><br><span class="line">	vector&lt;<span class="type">int</span>&gt;::iterator v2end = <span class="built_in">remove</span>(v<span class="number">2.</span><span class="built_in">begin</span>(), v<span class="number">2.</span><span class="built_in">end</span>(), <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	PrintAll&lt;vector&lt;<span class="type">int</span>&gt;&gt;(v2);</span><br><span class="line"></span><br><span class="line">	PrintAll&lt;vector&lt;<span class="type">int</span>&gt;&gt;(v2);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//要想删除container里的元素，需要使用容器的erase</span></span><br><span class="line">	v<span class="number">2.</span><span class="built_in">erase</span>(v2end, v<span class="number">2.</span><span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">	PrintAll&lt;vector&lt;<span class="type">int</span>&gt;&gt;(v2);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLRemove.PNG" alt="STLRemove"><br>	从上面看到，我们无法通过迭代器本身去删除容器的元素而需要通过容器本身去删除。<br>	为什么会这样了？<br>	“STL将数据结构和算法分离开来。然而，迭代器只不过是“容器中某一位置”的抽象概念而已。一般来说，迭代器对自己所属容器一无所知。任何“以迭代器访问容器元素”的算法，都不得透过迭代器条用容器类提供的任何成员方法。”<br>	但正因为这样的设计，算法只需要操作与迭代器上而不需要了解容器细节。<br>	那么这里有一个问题，Manipulating Algorithms会修改或移除或重排容器元素，那么他们可以作用于Associative Containers(按特定规则对元素进行了排序)上吗？<br>	答案是不能，为了保证Associative Containers已序的特性，Associative Containers只提供了const_iterator的迭代器，从而防止了Manipulating Algorithms的使用。<br>	算法 VS 容器成员函数？<br>	算法只是做一些通用的工作，本不能完美针对各个容器使用最优的方式。<br>	比如针对list，如果采用算法remove，会导致删除第一个元素后，后面所有的元素都分别设给前一个元素，这就违背了list的通过修改链接而非实值来安插，移动，移除元素的优点。在这种情况下，使用list自身的成员函数更优于通用算法。</p>
<pre><code>自定义泛型函数：
参见前面我们自定义的PrintAll泛型模板函数，把container作为参数传递，从而打印出所有元素。

以函数作为算法的参数：
一些算法可以接受用户定义的辅助性函数，由此提高其灵活性和能力。这些函数将在算法内部被调用。
下面以for_each为例：
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Print</span><span class="params">(T elem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cout &lt;&lt; elem &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;foreach-------------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">	for_each(v<span class="number">2.</span><span class="built_in">begin</span>(), v<span class="number">2.</span><span class="built_in">end</span>(), Print&lt;<span class="type">int</span>&gt;);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLForEach.PNG" alt="STLForEach"><br>	“运用这些辅助函数，我们可以指定搜寻准则，排序准则或定义某种操作等。”<br>	Predicates：<br>	“Predicates是一种特殊的辅助函数。返回bool的函数，通常被用来指定排序准则和搜寻准则。(STL要求，面对相同的值，predicates必须得出相同的结果)”<br>	下面以find_if为例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IsEven</span><span class="params">(T number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	number = <span class="built_in">abs</span>(number);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (number % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	for_each(v<span class="number">2.</span><span class="built_in">begin</span>(), v<span class="number">2.</span><span class="built_in">end</span>(), Print&lt;<span class="type">int</span>&gt;);</span><br><span class="line"></span><br><span class="line">	vector&lt;<span class="type">int</span>&gt;::iterator pos = <span class="built_in">find_if</span>(v<span class="number">2.</span><span class="built_in">begin</span>(), v<span class="number">2.</span><span class="built_in">end</span>(), IsEven&lt;<span class="type">int</span>&gt;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pos != v<span class="number">2.</span><span class="built_in">end</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; *pos &lt;&lt; <span class="string">&quot; is first even number in v2!&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;No even number found!&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLPredicates.PNG" alt="STLPredicates"><br>	更多的predicates参考STL Algorithms的使用。<br>2. Nonmodifying Algorithms<br>	是指不会变动元素值，也不会改变元素次序的算法。<br>	e.g. count, min_element, max_element, find……</p>
<p>仿函数(Functors):<br>什么是Functors？<br>“Functors是泛型编程强大为例和纯粹抽象概念的又一个例证。你可以说，任何东西，只要其行为像函数，它就是函数。因此，如果你定义了一个对象，行为像函数，它就可以被当做函数来用。”</p>
<p>那么什么才算是具备函数行为了？<br>“是指可以“使用小括号传递参数，籍以调用某个东西”。”<br>e.g.<br>function(arg1,arg2);</p>
<p>如何实现？<br>通过自定义operator()即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//functors</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FunctorClass</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(T elem)</span> <span class="type">const</span></span>&#123;</span><br><span class="line">		cout &lt;&lt; elem &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	FunctorClass&lt;<span class="type">int</span>&gt; func;</span><br><span class="line"></span><br><span class="line">	for_each(v<span class="number">2.</span><span class="built_in">begin</span>(), v<span class="number">2.</span><span class="built_in">end</span>(), func);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLFunctors.PNG" alt="STLFunctors"><br>让我们看看for_each源码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> InputIterator, <span class="keyword">class</span> Function&gt;</span></span><br><span class="line"><span class="function">  Function <span class="title">for_each</span><span class="params">(InputIterator first, InputIterator last, Function fn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (first!=last) &#123;</span><br><span class="line">    <span class="built_in">fn</span> (*first);</span><br><span class="line">    ++first;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fn;      <span class="comment">// or, since C++11: return move(fn);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出我们传递的FunctorClass<int>实例对象通过fn(*first)的方式调用了我们定义的operator()函数</p>
<p>Functor好处：</p>
<ol>
<li>smart functions(智能型函数)<br>““行为类似指针”的对象。拥有成员函数和成员变量，意味着functor拥有状态。”</li>
<li>每个functor都有自己的类型</li>
<li>functor通常比一般函数速度快<br>“就template概念而言，由于更多细节在编译器就已确定，所以通常可能进行更好的最佳化。”</li>
</ol>
<p>预定义的Functor：<br>C++标准库里包含了一些预先定义的仿函数：<br>less&lt;&gt;,negate&lt;&gt;……</p>
<p>什么是Function Adaptors？<br>所谓的Function Adaptors是指能够将仿函数和另一个仿函数(或某个值，或某个一般函数)结合起来的仿函数。<br>比如：<br>bind2nd(greater<int>(),42) – 检查某个int值大于42.bind2nd把二元仿函数转换为一元仿函数。<br>“通过Function Adaptors，我们可以把多个仿函数结合起来，形成强大的表达式，这种编程方式称为functional composition。”</p>
<p>那么成员函数能当做Function Adaptors使用吗？<br>答案是可以。C++里提供了将成员函数转换成Function Adaptors的方法(mem_fun_ref()和mem_fun())<br>Note:<br>mem_fun_ref和mem_fun调用的成员函数必须是const。</p>
<p>那么非成员函数是否能当做Function Adaptors了？<br>答案是可以的。C++里提供了ptr_fun将非成员函数转换为Functor Object。<br>详细内容参见《C++标准程序库》第8章</p>
<p>接下来让我们看看如何使自定义的Functor也可以使用Function Adaptors。<br>要想使自定义Functor使用Function Adaptors需要满足下列条件：</p>
<ol>
<li>必须提供一些类型成员来反映其参数和返回值的类型。<br>C++标准程序库提供了一些结构如下：<br><img src="/img/CPP/STLFunctionAdaptorsStructor.PNG" alt="STLFunctionAdaptorsStructor"><br>如果自定义Functor想要支持Functor Adaptors，我们只需要定义struct继承至unary_function或binary_function，同时定义operator()的Functor行为即可。</li>
</ol>
<p>更多一元，二元组合函数配接器参见《C++标准程序库》第8章</p>
<p>Note：<br>算法参数传递的区间是半开区间[begin, end)(包含begin，不包含end)</p>
<h2 id="STL内部的错误处理和异常处理"><a href="#STL内部的错误处理和异常处理" class="headerlink" title="STL内部的错误处理和异常处理"></a>STL内部的错误处理和异常处理</h2><h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>“STL的设计原则是效率优先，安全次之。错误检查相当花时间，所以几乎没有。”<br>原因：</p>
<ol>
<li>错误检验会降低效率，而速度始终是程序的总体目标。</li>
<li>不加入的话，用户可以通过封装自己写错误检查的版本，但反过来却不行。</li>
</ol>
<p>使用STL需要注意的点：</p>
<ol>
<li>迭代器务必合法而有效</li>
<li>一个迭代器如果只想”end”位置，它并不指向任何对象，因而不能对它调用operator*或operator-&gt;</li>
<li>区间必须是合法的</li>
<li>如果涉及的区间不止一个，第二区间及后继各区间必须拥有“至少和第一区间一样多”的元素</li>
<li>覆盖动作中的“目标区间”必须拥有足够的元素，否则就必须采用insert iterators</li>
</ol>
<p>Note:<br>含错误处理版本的STL，<a target="_blank" rel="noopener" href="http://www.stlport.org/">STLport</a></p>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>……</p>
<h2 id="扩展STL"><a href="#扩展STL" class="headerlink" title="扩展STL"></a>扩展STL</h2><p>“STL被涉及成一个框架，可以向任何方向扩展。你可以提供自己的容器，迭代器，算法，Functor…..，只要你满足条件即可。”</p>
<p>待续……</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Algorithm/">Algorithm</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Algorithm/">Algorithm</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/3/">&lt;span&gt;&lt;&#x2F;span&gt;Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next&lt;span&gt;&lt;&#x2F;span&gt;</a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2025 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
