
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Lua_In_Unity | 走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta name="description" content="Lua结合以前的初步学习了解，这一次要对Lua进行进一步的深入学习。
首先我们要知道Lua是脚本语言，是有自己的虚拟机，是解析执行而非像C#,C++,Java这些编译执行。同时Lua是弱类型语言。
这里不更多的讲解Lua虚拟机相关概念，详情参考http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html这里只要知道Lua的虚拟机(程序模拟线程，堆栈等)是">
<meta property="og:type" content="article">
<meta property="og:title" content="Lua_In_Unity">
<meta property="og:url" content="http://tonytang1990.github.io/2017/08/14/Lua-In-Unity/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:description" content="Lua结合以前的初步学习了解，这一次要对Lua进行进一步的深入学习。
首先我们要知道Lua是脚本语言，是有自己的虚拟机，是解析执行而非像C#,C++,Java这些编译执行。同时Lua是弱类型语言。
这里不更多的讲解Lua虚拟机相关概念，详情参考http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html这里只要知道Lua的虚拟机(程序模拟线程，堆栈等)是">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/Virtual_Machine_Working_Levels.PNG">
<meta property="og:updated_time" content="2018-04-22T08:55:10.865Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lua_In_Unity">
<meta name="twitter:description" content="Lua结合以前的初步学习了解，这一次要对Lua进行进一步的深入学习。
首先我们要知道Lua是脚本语言，是有自己的虚拟机，是解析执行而非像C#,C++,Java这些编译执行。同时Lua是弱类型语言。
这里不更多的讲解Lua虚拟机相关概念，详情参考http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html这里只要知道Lua的虚拟机(程序模拟线程，堆栈等)是">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.jpg" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">有时候不是习惯了一个人，而是在没有认可自己之前选择了一个人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/08/14/Lua-In-Unity/" title="Lua_In_Unity" itemprop="url">Lua_In_Unity</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-08-14T14:19:01.000Z" itemprop="datePublished"> 發表於 2017-08-14</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目錄</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua"><span class="toc-number">1.</span> <span class="toc-text">Lua</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua_Study"><span class="toc-number">2.</span> <span class="toc-text">Lua Study</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Weak_Tables_And_Finalizers"><span class="toc-number">2.1.</span> <span class="toc-text">Weak Tables And Finalizers</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ToLua"><span class="toc-number">3.</span> <span class="toc-text">ToLua</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Refrence"><span class="toc-number">4.</span> <span class="toc-text">Refrence</span></a></li></ol>
		
		</div>
		
		<h1 id="Lua">Lua</h1><p>结合以前的初步学习了解，这一次要对Lua进行进一步的深入学习。</p>
<p>首先我们要知道Lua是脚本语言，是有自己的虚拟机，是解析执行而非像C#,C++,Java这些编译执行。同时Lua是弱类型语言。</p>
<p>这里不更多的讲解Lua虚拟机相关概念，详情参考<a href="Scripting System">http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html</a><br><img src="/img/Lua/Virtual_Machine_Working_Levels.PNG" alt="Virtual_Machine_Working_Levels"><br>这里只要知道Lua的虚拟机(程序模拟线程，堆栈等)是运行在程序里而非物理CPU上，因此只要虚拟机把Lua脚本解析成对应平台的机器码就能支持跨平台(好比Java的JVM)。</p>
<h1 id="Lua_Study">Lua Study</h1><h2 id="Weak_Tables_And_Finalizers">Weak Tables And Finalizers</h2><p>“and Finalizers Lua  does  automatic  memory  management. Programs  create  objects  (tables, threads,  etc.),  but  there  is  no  function  to  delete  objects. Lua  automatically deletes  objects that become garbage,  using garbage  collection. “</p>
<p><strong>Weak Table</strong><br>“Weak tables allow the collection of Lua objects that are still accessible to the program”</p>
<p>“A weak reference is a reference to an object hat is not considered by the garbage collector”</p>
<p>“In weak tables,, both keys and values can be weak”(three kinds of week table:1. weak key 2. weak value 3. weak key and value)</p>
<p>Weak Table Using:</p>
<ol>
<li>释放使用不再使用的缓存数据(memorizing)<br>Auxiliary table(辅助表),Lua里有类似于C#里的internal hash table用于重用使用过的string和访问结果(C#里主要是使用过的string重用。Lua还能将访问过的string的table结果缓存返回)</li>
</ol>
<p>但Auxiliary table有个缺点就是使用不频繁的string和result会一直被缓存无法释放。weak table正是用于解决这一问题的方案之一。(因为weak table的weak reference一旦不再被使用就会被下一次GC释放)</p>
<ol>
<li><p>Object Attributes Implemetation<br>Solution: use external table to associate objects with attributes<br>Drawback: external table reference prevent objects from being collected<br>Final solution: use weak keys for objects in external table</p>
</li>
<li><p>Tables with Default Values<br>这里有两种各有优缺点的实现方案：<br>方案1:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> defaults = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(defaults, &#123;__mode = <span class="string">"k"</span>&#125;)</span><br><span class="line"><span class="keyword">local</span> mt = &#123;__index = <span class="function"><span class="keyword">function</span> <span class="params">(t)</span></span> <span class="keyword">return</span> defaults[t] <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setDefault</span> <span class="params">(t, d)</span></span></span><br><span class="line">defaults[t] = d</span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>方案2:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> metas = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(metas, &#123;__mode = <span class="string">"v"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setDefault</span> <span class="params">(t, d)</span></span></span><br><span class="line"><span class="keyword">local</span> mt = metas[d]</span><br><span class="line"><span class="keyword">if</span> mt == <span class="keyword">nil</span> <span class="keyword">then</span></span><br><span class="line">mt = &#123;__index = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="keyword">return</span> d <span class="keyword">end</span>&#125;</span><br><span class="line">metas[d] = mt <span class="comment">-- memorize</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>前者针对每一个不同的Table都会分配一个defaults入口,table作为key，default value作为value。这样的缺点就是当table数量很大的时候会需要分配很多内存去存储不同table的default value。</p>
<p>后者针对不同的default value分配了更多的内存(比如mt，entry on metas, closure……)，但优点是同样的default value只需要分配一次即可，所以后者更适用于table数量多但default value大都相同的情况。</p>
<ol>
<li>Ephemeron Tables(声明短暂的table Lua 5.2里提供)<br>Ephemeron Table:<br>“In Lua 5.2, a table with weak keys and strong values is an ephemeron table. In an ephemeron table, the accessibility of a key controls the accessibility of its corresponding value.(只当有strong<br>reference to key时value才是strong的)”<br>e.g. constant-function factory</li>
</ol>
<p>Note:<br>“Only objects can be collected from a weak table. Values, such as numbers and booleans, are not collectible”(只有Objects在weak table里能被gc回收，number和booleans这种Value类型不能在weak table里被gc回收)</p>
<p>“strings are collectible, but string is not removed from weak table(unless its associated value is collected)”</p>
<p><strong>Finalizers</strong><br>“Finalizers allow the collection of externa objects that are not directly under control of the garbage collector”</p>
<p>“Finalizer is a function associated with an object that is called when that object is about to be collected.”(相当于C#里的Finalize,在GC object的时候会被调用。但只有一开始设置Metamethod的<strong>gc时才能mark该object为可finalization的，否则就算后面在复制</strong>gc也不会在调用该object的finalizer)</p>
<p>Lua里是通过Metamethod里的__gc实现。<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试环境要求至少Lua 5.2</span></span><br><span class="line">o = &#123;x = <span class="string">"hi"</span>&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(o, &#123;__gc = <span class="function"><span class="keyword">function</span> <span class="params">(o)</span></span> <span class="built_in">print</span>(o.x) <span class="keyword">end</span>&#125;)</span><br><span class="line">o = <span class="keyword">nil</span></span><br><span class="line"><span class="built_in">collectgarbage</span>() <span class="comment">--&gt; hi</span></span><br></pre></td></tr></table></figure></p>
<p>The order of finalization called:<br>“When the collector finalizes several obejcts in the same cycle, it calls their finalizers in the reverse order that the objects were marked for finalization”(先声明__gc被mark为可finalization的object的finalizer后被调用)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试环境要求至少Lua 5.2</span></span><br><span class="line">mt = &#123;__gc = <span class="function"><span class="keyword">function</span> <span class="params">(o)</span></span> <span class="built_in">print</span>(o[<span class="number">1</span>]) <span class="keyword">end</span>&#125;</span><br><span class="line">list = <span class="keyword">nil</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">3</span> <span class="keyword">do</span></span><br><span class="line">    list = <span class="built_in">setmetatable</span>(&#123;i, link = list&#125;, mt)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">list = <span class="keyword">nil</span></span><br><span class="line"><span class="built_in">collectgarbage</span>()</span><br><span class="line"><span class="comment">--&gt; 1</span></span><br><span class="line"><span class="comment">--&gt; 2</span></span><br><span class="line"><span class="comment">--&gt; 3</span></span><br></pre></td></tr></table></figure>
<p>对于被finalize的object，Finlization会使被finalize的object处于两个特殊的状态：</p>
<ol>
<li>transient resurrection(短暂的复苏)</li>
<li>permanent resurrection(永久的复苏)<br>前者因为在调用__gc的metamethod时我们会得到finalize的object，这样一来使得该object alive again，然后我们可以通过该object用于访问里面的对象。<br>finalizer被调用时，该alive again的object被存储在了global table里，导致该object在finalize后依然存在。<strong>要想使用finalize也真正回收obejct，我们需要调用两次gc，第一次用于回收原始object，第二次用于回收alive again的object。</strong><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 因为当前测试环境是Lua 5.1(基于LuaTo#插件学习的，JIT支持到5.1的版本)所以不支持Talbe的__gc Metamethod，这里暂时没有写测试程序。</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Note:<br>“In lua 5.1 the only lua values that work with <strong>gc metamethod is userdata. “(Lua 5.1不支持table的</strong>gc metamethod，只支持userdata的__gc metamethod)</p>
<h1 id="ToLua">ToLua</h1><p>待续……</p>
<h1 id="Refrence">Refrence</h1><p>以下是以前学习做的部分笔记：<br><a href="Game Scripting Mastery">http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html</a><br><a href="Lua -- some important concept and knowledge">http://blog.sina.com.cn/s/blog_8c7d49f20102v0rk.html</a><br><a href="Lua - Coroutines Study">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s0.html</a><br><a href="Lua - Metatables and Metamethods">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s5.html</a><br><a href="Lua - Object Oriented Programming">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s9.html</a><br><a href="Lua - C API">http://blog.sina.com.cn/s/blog_8c7d49f20102v0zp.html</a><br><a href="Lua - C call Lua &amp; Lua call C">http://blog.sina.com.cn/s/blog_8c7d49f20102v0zs.html</a><br><a href="Lua - Userdata">http://blog.sina.com.cn/s/blog_8c7d49f20102v1qg.html</a><br><a href="Lua - Managing Resources &amp; Threads and States">http://blog.sina.com.cn/s/blog_8c7d49f20102v383.html</a></p>
<p>参考书籍:<br>《Programming in Lua third edition》 — Roberto Ierusalimschy<br>《Lua用户手册》<br>《Game Scripting Mastery》 — Alex Varanese</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://tonytang1990.github.io/2017/08/14/Lua-In-Unity/" data-title="Lua_In_Unity | 走停人生路" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/03/18/Data-Config-Automation/" title="Data-Config-Automation">
  <strong>上一篇：</strong><br/>
  <span>
  Data-Config-Automation</span>
</a>
</div>


<div class="next">
<a href="/2017/06/14/Android-Sign-Study/"  title="Android-Sign-Study">
 <strong>下一篇：</strong><br/> 
 <span>Android-Sign-Study
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2017/08/14/Lua-In-Unity/" data-title="Lua_In_Unity" data-url="http://tonytang1990.github.io/2017/08/14/Lua-In-Unity/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目錄</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua"><span class="toc-number">1.</span> <span class="toc-text">Lua</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua_Study"><span class="toc-number">2.</span> <span class="toc-text">Lua Study</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Weak_Tables_And_Finalizers"><span class="toc-number">2.1.</span> <span class="toc-text">Weak Tables And Finalizers</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ToLua"><span class="toc-number">3.</span> <span class="toc-text">ToLua</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Refrence"><span class="toc-number">4.</span> <span class="toc-text">Refrence</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game-Engine/" title="Game_Engine">Game_Engine<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>3</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Sort/" title="Sort">Sort<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情鏈接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 訂閱</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Tony Tang. <br/>
			This is my new blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"TonyTang1990"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回頂部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
