
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Unity中的Lua | 走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta name="description" content="Lua结合以前的初步学习了解，这一次要对Lua进行进一步的深入学习。 首先我们要知道Lua是脚本语言，是有自己的虚拟机，是解析执行而非像C#,C++,Java这些编译执行。同时Lua是弱类型语言。 这里不更多的讲解Lua虚拟机相关概念，详情参考[http:&#x2F;&#x2F;blog.sina.com.cn&#x2F;s&#x2F;blog_8c7d49f20102uzsx.html](Scripting System)这里只要知道">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity中的Lua">
<meta property="og:url" content="http://tonytang1990.github.io/2017/08/14/Unity%E4%B8%AD%E7%9A%84Lua/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:description" content="Lua结合以前的初步学习了解，这一次要对Lua进行进一步的深入学习。 首先我们要知道Lua是脚本语言，是有自己的虚拟机，是解析执行而非像C#,C++,Java这些编译执行。同时Lua是弱类型语言。 这里不更多的讲解Lua虚拟机相关概念，详情参考[http:&#x2F;&#x2F;blog.sina.com.cn&#x2F;s&#x2F;blog_8c7d49f20102uzsx.html](Scripting System)这里只要知道">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/Virtual_Machine_Working_Levels.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/BitNotOperation.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/BitwiseOperation.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/ReadOnlyTableOutput.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/RecusiveReadOnlyTableOuput.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/HandlerOutput.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaFirstClassValues.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaPairsAndIpairs.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaType.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/WhereMinGW.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaBuildOutput.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaEnvSetting.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/MakeSureLuaExits.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaRocksInstallCommand.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaRocksInstallSuccess.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaRocksPathAndCPath.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/OrignalLuaPathAndCPath.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaEnviromentSetting.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/InstallSerpent.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/SerpentInstallatio.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/SerpentOutput.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LpegInstallation.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LpegPatternsDoc.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LpegCaptureDoc.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaFolderStructure.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/EmmyLuaNotation.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/LuaMethodReference.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Lua/VSCodeEmmyLuaDebug.png">
<meta property="article:published_time" content="2017-08-14T14:19:01.000Z">
<meta property="article:modified_time" content="2022-07-31T13:19:44.159Z">
<meta property="article:author" content="Tony Tang">
<meta property="article:tag" content="Lua">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://tonytang1990.github.io/img/Lua/Virtual_Machine_Working_Levels.PNG">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/08/14/Unity中的Lua/" title="Unity中的Lua" itemprop="url">Unity中的Lua</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2017-08-14T14:19:01.000Z" itemprop="datePublished"> 发表于 2017-08-14</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua"><span class="toc-number">1.</span> <span class="toc-text">Lua</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua-Study"><span class="toc-number">2.</span> <span class="toc-text">Lua Study</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Weak-Tables-And-Finalizers"><span class="toc-number">2.1.</span> <span class="toc-text">Weak Tables And Finalizers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E9%87%8C%E7%9A%84%E4%BD%8D%E8%BF%90%E7%AE%97"><span class="toc-number">2.2.</span> <span class="toc-text">Lua里的位运算</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E5%8F%8D"><span class="toc-number">2.2.1.</span> <span class="toc-text">取反</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%BB%E4%BD%8D%E5%92%8C%E5%BC%82%E6%88%96"><span class="toc-number">2.2.2.</span> <span class="toc-text">移位和异或</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E9%87%8C%E7%9A%84OOP"><span class="toc-number">2.3.</span> <span class="toc-text">Lua里的OOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Class%E6%8A%BD%E8%B1%A1"><span class="toc-number">2.3.1.</span> <span class="toc-text">Class抽象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Class%E5%AE%9A%E4%B9%89"><span class="toc-number">2.3.2.</span> <span class="toc-text">Class定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Class%E7%BB%A7%E6%89%BF"><span class="toc-number">2.3.3.</span> <span class="toc-text">Class继承</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Class%E5%AF%B9%E8%B1%A1%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.3.4.</span> <span class="toc-text">Class对象实例化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E5%8F%AA%E8%AF%BBTable"><span class="toc-number">2.4.</span> <span class="toc-text">Lua只读Table</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%89%88%E5%8F%AA%E8%AF%BBTable"><span class="toc-number">2.4.1.</span> <span class="toc-text">基础版只读Table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E7%89%88%E5%8F%AA%E8%AF%BBTable-%E6%94%AF%E6%8C%81-%E5%92%8Cpairs"><span class="toc-number">2.4.2.</span> <span class="toc-text">进阶版只读Table(支持#和pairs)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%96%84%E7%89%88%E5%8F%AA%E8%AF%BBTable-%E6%94%AF%E6%8C%81%E9%80%92%E5%BD%92ReadOnly"><span class="toc-number">2.4.3.</span> <span class="toc-text">完善版只读Table(支持递归ReadOnly)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%82%B9"><span class="toc-number">2.4.4.</span> <span class="toc-text">优化点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E5%9B%9E%E8%B0%83%E7%BB%91%E5%AE%9A"><span class="toc-number">2.5.</span> <span class="toc-text">Lua回调绑定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E5%B0%8F%E7%9F%A5%E8%AF%86"><span class="toc-number">2.6.</span> <span class="toc-text">Lua小知识</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">Lua常用插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#luarocks"><span class="toc-number">3.1.</span> <span class="toc-text">luarocks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#serpent"><span class="toc-number">3.2.</span> <span class="toc-text">serpent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lpeg"><span class="toc-number">3.3.</span> <span class="toc-text">Lpeg</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pattern"><span class="toc-number">3.3.1.</span> <span class="toc-text">Pattern</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Match"><span class="toc-number">3.3.2.</span> <span class="toc-text">Match</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Capture"><span class="toc-number">3.3.3.</span> <span class="toc-text">Capture</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">3.3.4.</span> <span class="toc-text">实战</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua-IDE"><span class="toc-number">4.</span> <span class="toc-text">Lua IDE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#VSCode"><span class="toc-number">4.1.</span> <span class="toc-text">VSCode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">4.1.1.</span> <span class="toc-text">设置同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E6%8D%B7%E9%94%AE"><span class="toc-number">4.1.2.</span> <span class="toc-text">快捷键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Snippets"><span class="toc-number">4.1.3.</span> <span class="toc-text">Snippets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E8%B0%83%E8%AF%95"><span class="toc-number">4.1.4.</span> <span class="toc-text">Lua调试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EmmyLua"><span class="toc-number">4.1.4.1.</span> <span class="toc-text">EmmyLua</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#VSCode%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.4.1.1.</span> <span class="toc-text">VSCode配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#XLua"><span class="toc-number">4.1.4.1.2.</span> <span class="toc-text">XLua</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%8F%90%E7%A4%BA"><span class="toc-number">4.1.4.1.3.</span> <span class="toc-text">代码提示</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8"><span class="toc-number">4.1.4.1.4.</span> <span class="toc-text">查找方法引用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">4.1.4.1.5.</span> <span class="toc-text">调试</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ToLua"><span class="toc-number">5.</span> <span class="toc-text">ToLua</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Refrence"><span class="toc-number">6.</span> <span class="toc-text">Refrence</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A5%E5%89%8D%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-number">6.1.</span> <span class="toc-text">以前学习笔记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E7%BD%91%E7%AB%99"><span class="toc-number">6.2.</span> <span class="toc-text">官方网站</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E4%B9%A6%E7%B1%8D"><span class="toc-number">6.3.</span> <span class="toc-text">参考书籍</span></a></li></ol></li></ol>
		
		</div>
		
		<h1 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h1><p>结合以前的初步学习了解，这一次要对Lua进行进一步的深入学习。</p>
<p>首先我们要知道Lua是脚本语言，是有自己的虚拟机，是解析执行而非像C#,C++,Java这些编译执行。同时Lua是弱类型语言。</p>
<p>这里不更多的讲解Lua虚拟机相关概念，详情参考[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]</a>(Scripting System)<br><img src="/img/Lua/Virtual_Machine_Working_Levels.PNG" alt="Virtual_Machine_Working_Levels"><br>这里只要知道Lua的虚拟机(程序模拟线程，堆栈等)是运行在程序里而非物理CPU上，因此只要虚拟机把Lua脚本解析成对应平台的机器码就能支持跨平台(好比Java的JVM)。</p>
<h1 id="Lua-Study"><a href="#Lua-Study" class="headerlink" title="Lua Study"></a>Lua Study</h1><p>以前的部分学习参考:<br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html">Scripting System &amp; Lua Study</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0rk.html">Lua – some important concept and knowledge</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zp.html">Lua - C API </a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zs.html">Lua - C call Lua &amp; Lua call C</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s9.html">Lua - Object Oriented Programming</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v1qg.html">Lua - Userdata</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v383.html">Lua - Managing Resources &amp; Threads and States</a></p>
<h2 id="Weak-Tables-And-Finalizers"><a href="#Weak-Tables-And-Finalizers" class="headerlink" title="Weak Tables And Finalizers"></a>Weak Tables And Finalizers</h2><p>“and Finalizers Lua  does  automatic  memory  management. Programs  create  objects  (tables, threads,  etc.),  but  there  is  no  function  to  delete  objects. Lua  automatically deletes  objects that become garbage,  using garbage  collection. “</p>
<p><strong>Weak Table</strong><br>“Weak tables allow the collection of Lua objects that are still accessible to the program”</p>
<p>“A weak reference is a reference to an object hat is not considered by the garbage collector”</p>
<p>“In weak tables,, both keys and values can be weak”(three kinds of week table:1. weak key 2. weak value 3. weak key and value)</p>
<p>Weak Table Using:</p>
<ol>
<li>释放使用不再使用的缓存数据(memorizing)<br>Auxiliary table(辅助表),Lua里有类似于C#里的internal hash table用于重用使用过的string和访问结果(C#里主要是使用过的string重用。Lua还能将访问过的string的table结果缓存返回)</li>
</ol>
<p>但Auxiliary table有个缺点就是使用不频繁的string和result会一直被缓存无法释放。weak table正是用于解决这一问题的方案之一。(因为weak table的weak reference一旦不再被使用就会被下一次GC释放)</p>
<ol start="2">
<li><p>Object Attributes Implemetation<br>Solution: use external table to associate objects with attributes<br>Drawback: external table reference prevent objects from being collected<br>Final solution: use weak keys for objects in external table</p>
</li>
<li><p>Tables with Default Values<br>这里有两种各有优缺点的实现方案：<br>方案1:</p>
</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> defaults = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(defaults, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;k&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">local</span> mt = &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t)</span></span> <span class="keyword">return</span> defaults[t] <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setDefault</span> <span class="params">(t, d)</span></span></span><br><span class="line">defaults[t] = d</span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>方案2:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> metas = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(metas, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;v&quot;</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setDefault</span> <span class="params">(t, d)</span></span></span><br><span class="line"><span class="keyword">local</span> mt = metas[d]</span><br><span class="line"><span class="keyword">if</span> mt == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">mt = &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="keyword">return</span> d <span class="keyword">end</span>&#125;</span><br><span class="line">metas[d] = mt <span class="comment">-- memorize</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>前者针对每一个不同的Table都会分配一个defaults入口,table作为key，default value作为value。这样的缺点就是当table数量很大的时候会需要分配很多内存去存储不同table的default value。</p>
<p>后者针对不同的default value分配了更多的内存(比如mt，entry on metas, closure……)，但优点是同样的default value只需要分配一次即可，所以后者更适用于table数量多但default value大都相同的情况。</p>
<ol start="4">
<li>Ephemeron Tables(声明短暂的table Lua 5.2里提供)<br>Ephemeron Table:<br>“In Lua 5.2, a table with weak keys and strong values is an ephemeron table. In an ephemeron table, the accessibility of a key controls the accessibility of its corresponding value.(只当有strong<br> reference to key时value才是strong的)”<br>e.g. constant-function factory</li>
</ol>
<p>Note:<br>“Only objects can be collected from a weak table. Values, such as numbers and booleans, are not collectible”(只有Objects在weak table里能被gc回收，number和booleans这种Value类型不能在weak table里被gc回收)</p>
<p>“strings are collectible, but string is not removed from weak table(unless its associated value is collected)”</p>
<p><strong>Finalizers</strong><br>“Finalizers allow the collection of externa objects that are not directly under control of the garbage collector”</p>
<p>“Finalizer is a function associated with an object that is called when that object is about to be collected.”(相当于C#里的Finalize,在GC object的时候会被调用。但只有一开始设置Metamethod的__gc时才能mark该object为可finalization的，否则就算后面在复制__gc也不会在调用该object的finalizer)</p>
<p>Lua里是通过Metamethod里的__gc实现。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试环境要求至少Lua 5.2</span></span><br><span class="line">o = &#123;x = <span class="string">&quot;hi&quot;</span>&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(o, &#123;<span class="built_in">__gc</span> = <span class="function"><span class="keyword">function</span> <span class="params">(o)</span></span> <span class="built_in">print</span>(o.x) <span class="keyword">end</span>&#125;)</span><br><span class="line">o = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">collectgarbage</span>() <span class="comment">--&gt; hi</span></span><br></pre></td></tr></table></figure>

<p>The order of finalization called:<br>“When the collector finalizes several obejcts in the same cycle, it calls their finalizers in the reverse order that the objects were marked for finalization”(先声明__gc被mark为可finalization的object的finalizer后被调用)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试环境要求至少Lua 5.2</span></span><br><span class="line">mt = &#123;<span class="built_in">__gc</span> = <span class="function"><span class="keyword">function</span> <span class="params">(o)</span></span> <span class="built_in">print</span>(o[<span class="number">1</span>]) <span class="keyword">end</span>&#125;</span><br><span class="line">list = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">3</span> <span class="keyword">do</span></span><br><span class="line">    list = <span class="built_in">setmetatable</span>(&#123;i, link = list&#125;, mt)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">list = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">collectgarbage</span>()</span><br><span class="line"><span class="comment">--&gt; 1</span></span><br><span class="line"><span class="comment">--&gt; 2</span></span><br><span class="line"><span class="comment">--&gt; 3</span></span><br></pre></td></tr></table></figure>

<p>对于被finalize的object，Finlization会使被finalize的object处于两个特殊的状态：</p>
<ol>
<li>transient resurrection(短暂的复苏)</li>
<li>permanent resurrection(永久的复苏)<br>前者因为在调用__gc的metamethod时我们会得到finalize的object，这样一来使得该object alive again，然后我们可以通过该object用于访问里面的对象。<br>finalizer被调用时，该alive again的object被存储在了global table里，导致该object在finalize后依然存在。<strong>要想使用finalize也真正回收obejct，我们需要调用两次gc，第一次用于回收原始object，第二次用于回收alive again的object。</strong></li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 因为当前测试环境是Lua 5.1(基于LuaTo#插件学习的，JIT支持到5.1的版本)所以不支持Talbe的__gc Metamethod，这里暂时没有写测试程序。</span></span><br></pre></td></tr></table></figure>

<p>Note:<br>“In lua 5.1 the only lua values that work with __gc metamethod is userdata. “(Lua 5.1不支持table的__gc metamethod，只支持userdata的__gc metamethod)</p>
<h2 id="Lua里的位运算"><a href="#Lua里的位运算" class="headerlink" title="Lua里的位运算"></a>Lua里的位运算</h2><p>在了解Lua里的位运算之前我们需要了解原码，反码，补码相关的概念，详情参考：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangziqiu/archive/2011/03/30/computercode.html">原码, 反码, 补码 详解</a></p>
<p>这里直接说结论：<br><strong>机器的数字存储采用补码的方式来编码存储的。</strong></p>
<p><strong>正数的反码 &#x3D; 自身</strong><br><strong>负数的反码 &#x3D; 符号位不变 + 其他位取反</strong></p>
<p><strong>正数的补码 &#x3D; 自身</strong><br><strong>负数的补码 &#x3D; 反码 + 1</strong></p>
<p><strong>移码 &#x3D; 2^n + 补码(真值为排开非符号位的值，n为真值的位数) &#x3D; 补码符号位取反</strong></p>
<p>为什么会需要原码，反码，补码?<br>个人总结原因有以下几点:</p>
<ol>
<li><strong>计算机运算设计为了简化让符号位直接参与运算，同时只有加法没有减法，减法用加一个负数的表示</strong></li>
<li><strong>直接用原码相加无法解决符号位相加问题，导致结果不正确</strong></li>
<li><strong>直接用反码相加无法解决0的准确表达，即1<em>0和0</em>0都表示0但区分了正负之分(有效范围127到-127)</strong></li>
<li><strong>用补码相加不仅解决了正负0的问题，同时1*0还能表示-128(扩展有效范围为127到-128。这也是为什么我们的int32的有效范围为2^31 - 1到(-2)^31的原因)</strong></li>
<li><strong>移码解决补码不能快速比较两个数大小的问题</strong></li>
</ol>
<p>了解了基础的理论知识，让我们再来看看Lua里的位运算。</p>
<h3 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i = <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line">	<span class="built_in">print</span>(i)</span><br><span class="line">	<span class="keyword">local</span> number = i</span><br><span class="line">	<span class="keyword">local</span> result = ~number</span><br><span class="line">	<span class="built_in">print</span>(result)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>让我们看下输出结果:<br><img src="/img/Lua/BitNotOperation.png" alt="BitNotOperation"><br>上面的结果出人意料，0取反为-1，1取反为-2,2取反为-3,3取反为-4，并不是我们想象中的0取反为-2^31</p>
<p>那么为什么会有这样的结果了，让我们结合前面学习的原码，反码，补码知识来破解其中的奥妙。<br>让我们来一步一步看看，0在取反的过程中是怎么一步一步变成-1的。<br>正向:<br>0000(原码)                    0<br>0000(反码)                    0<br>0000(补码)                    0<br>1111(补码取反)                -2^31 + 1</p>
<p>因为机器是以补码存储数字的，所以0的存储编码为0000<br>我们通过对0取反，得到1111(补码取反)<br>得到了取反后的补码，我们如何知道这个补码表达的是什么数值了？这个时候需要结合补码的计算方式逆向推导出原码值。</p>
<p>补码逆向:<br>1111 - 1 &#x3D; 1110(反码)          -2^31 + 1<br>1110(反码) &#x3D; 原码符号位不变 + 原码其他位取反 &#x3D; 1001(原码) &#x3D; -1</p>
<p>可以看到通过正向和逆向反推，我们成功得出了0取反后的值为-1而不是我们想象中的-2^31</p>
<h3 id="移位和异或"><a href="#移位和异或" class="headerlink" title="移位和异或"></a>移位和异或</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> num1 = <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(num1 &lt;&lt; <span class="number">1</span>)</span><br><span class="line"><span class="keyword">local</span> num2 = <span class="number">-1</span></span><br><span class="line"><span class="built_in">print</span>(num2 &lt;&lt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line"><span class="comment">-- 01101(原码)</span></span><br><span class="line"><span class="comment">-- 01101(补码)</span></span><br><span class="line"><span class="keyword">local</span> num3 = <span class="number">13</span></span><br><span class="line"><span class="comment">-- 11011(原码)</span></span><br><span class="line"><span class="comment">-- 10100(反码)</span></span><br><span class="line"><span class="comment">-- 10101(补码)</span></span><br><span class="line"><span class="keyword">local</span> num4 = <span class="number">-11</span></span><br><span class="line"><span class="comment">-- 01101(补码) &amp; 10011(补码)</span></span><br><span class="line"><span class="comment">-- 00101(异后补码)</span></span><br><span class="line"><span class="comment">-- 00101(异后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num3 &amp; num4)</span><br><span class="line"><span class="comment">-- 01101(补码) | 10101(补码)</span></span><br><span class="line"><span class="comment">-- 11101(或后补码)</span></span><br><span class="line"><span class="comment">-- 11100(或后反码)</span></span><br><span class="line"><span class="comment">-- 10011(或后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num3 | num4)</span><br><span class="line"><span class="comment">-- 01101(补码) ~ 10101(补码)</span></span><br><span class="line"><span class="comment">-- 11000(异或后)</span></span><br><span class="line"><span class="comment">-- 10111(异或后反码)</span></span><br><span class="line"><span class="comment">-- 11000(异或后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num3 ~ num4)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line"><span class="comment">-- 11001(原码)</span></span><br><span class="line"><span class="comment">-- 10111(补码)</span></span><br><span class="line"><span class="keyword">local</span> num5 = <span class="number">-9</span></span><br><span class="line"><span class="comment">-- 00011(原码)</span></span><br><span class="line"><span class="comment">-- 00011(补码)</span></span><br><span class="line"><span class="keyword">local</span> num6 = <span class="number">3</span></span><br><span class="line"><span class="comment">-- 10111(补码) ~ 00011(补码)</span></span><br><span class="line"><span class="comment">-- 10100(异或后)</span></span><br><span class="line"><span class="comment">-- 10011(异或后反码)</span></span><br><span class="line"><span class="comment">-- 11100(异或后原码)</span></span><br><span class="line"><span class="built_in">print</span>(num5 ~ num6)</span><br></pre></td></tr></table></figure>
<p><img src="/img/Lua/BitwiseOperation.png" alt="BitwiseOperation"><br>可以看到num5和num6异或因为补码的影响得到-12的结果。<br>Note:<br>    1. <strong>有负数的情况，异和或操作都会受补码影响，整数补码等于原码，所以整数异和或操作等价于原码直接异或</strong><br>    2. <strong>异或操作对符号位会有影响，需要考虑补码影响</strong><br>    3. <strong>位移操作左移会替换符号位，右移会丢弃低位</strong></p>
<h2 id="Lua里的OOP"><a href="#Lua里的OOP" class="headerlink" title="Lua里的OOP"></a>Lua里的OOP</h2><p>OOP(Object Oriented Programming)<br>首先Lua里面编写更重要的是Think in Lua，所以这里我不是强调OOP的重要性，而是单纯因为OOP被更多的C#程序员所熟悉。</p>
<h3 id="Class抽象"><a href="#Class抽象" class="headerlink" title="Class抽象"></a>Class抽象</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:    Class.lua</span></span><br><span class="line"><span class="comment">-- Description:    模拟Lua里OOP特性(不支持多重继承)</span></span><br><span class="line"><span class="comment">-- Author:       TangHuan</span></span><br><span class="line"><span class="comment">-- Create Date:    2018/11/09</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用方法：</span></span><br><span class="line"><span class="comment">-- 1. 定义类</span></span><br><span class="line"><span class="comment">-- local ClassName = Class(&quot;ClassName&quot;, nil)</span></span><br><span class="line"><span class="comment">-- ***(自定义类数据方法等)</span></span><br><span class="line"><span class="comment">-- 参数说明：</span></span><br><span class="line"><span class="comment">-- clsname类名，super父类</span></span><br><span class="line"><span class="comment">-- 返回结果:</span></span><br><span class="line"><span class="comment">-- ClassName(含Class基本信息结构的table)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 实例化类对象</span></span><br><span class="line"><span class="comment">-- 参数说明：</span></span><br><span class="line"><span class="comment">-- BaseClass含类定义的Class Table</span></span><br><span class="line"><span class="comment">-- ...构造类实例对象的构造函数ctor()的参数</span></span><br><span class="line"><span class="comment">-- 返回结果：</span></span><br><span class="line"><span class="comment">-- 基于BaseClass的实例对象</span></span><br><span class="line"><span class="comment">-- new(BaseClass, ...)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---克隆对象(建议用于克隆Class对象)</span></span><br><span class="line"><span class="comment">---@param  any 对象</span></span><br><span class="line"><span class="comment">---@return  any 克隆对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Clone</span><span class="params">(object)</span></span></span><br><span class="line">    <span class="keyword">local</span> lookup_table = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_copy</span><span class="params">(object)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(object) ~= <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> object</span><br><span class="line">        <span class="keyword">elseif</span> lookup_table[object] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> lookup_table[object]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> new_table = &#123;&#125;</span><br><span class="line">        lookup_table[object] = new_table</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(object) <span class="keyword">do</span></span><br><span class="line">            new_table[_copy(key)] = _copy(value)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setmetatable</span>(new_table, <span class="built_in">getmetatable</span>(object))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> _copy(object)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---判定是否是指定类或者继承至该类</span></span><br><span class="line"><span class="comment">---@param self Class@类实例对象或者类</span></span><br><span class="line"><span class="comment">---@param cname string | Class@类名或者类定义table</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">IsClass</span><span class="params">(self, cname)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(<span class="built_in">self</span>) ~= <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(cname) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>.class == cname <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">elseif</span> <span class="built_in">self</span>.super <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">self</span>.super.IsClass(<span class="built_in">self</span>.super, cname);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">elseif</span> <span class="built_in">type</span>(cname) == <span class="string">&quot;string&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>.class.className == cname <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">elseif</span> <span class="built_in">self</span>.super <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">self</span>.super.IsClass(<span class="built_in">self</span>.super, cname);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 提供Lua的OOP实现，快速定义一个Class(不支持多重继承)</span></span><br><span class="line"><span class="comment">--- 模拟Class封装，继承，多态，类型信息，构造函数等</span></span><br><span class="line"><span class="comment">--- 模拟一个基础的Class需要的信息</span></span><br><span class="line"><span class="comment">---@param clsname string@类名</span></span><br><span class="line"><span class="comment">---@param super super@父类</span></span><br><span class="line"><span class="comment">---@return Class@含Class所需基本信息的Class table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Class</span><span class="params">(clsname, super)</span></span></span><br><span class="line">    <span class="keyword">local</span> classtable = &#123;&#125;</span><br><span class="line">    <span class="comment">-- ctor模拟构造函数</span></span><br><span class="line">    classtable.Ctor = <span class="literal">false</span></span><br><span class="line">    <span class="comment">-- className模拟类型信息，负责存储类名</span></span><br><span class="line">    classtable.className = clsname</span><br><span class="line">    <span class="comment">-- super模拟父类</span></span><br><span class="line">    <span class="comment">-- Note: 外部逻辑层不允许直接._super访问父类</span></span><br><span class="line">    classtable._super = super</span><br><span class="line">    <span class="comment">-- 自身class类table</span></span><br><span class="line">    classtable.class = classtable;</span><br><span class="line">    <span class="comment">-- 指定索引元方法__index为自身,模拟类访问</span></span><br><span class="line">    <span class="comment">-- 后面实例化对象时会将classtable作为元表，从而实现访问类封装的数据</span></span><br><span class="line">    classtable.<span class="built_in">__index</span> = classtable</span><br><span class="line">    <span class="comment">-- 是否是指定类或者继承至某类的方法接口</span></span><br><span class="line">    classtable.IsClass = IsClass;</span><br><span class="line">    <span class="comment">-- 如果指定了父类，通过设置Class的元表为父类模拟继承</span></span><br><span class="line">    <span class="keyword">if</span> super <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(classtable, super)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">--print(&quot;如果定义的不是最基类，请确认是否require了父类!&quot;)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> classtable</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 提供实例化对象的方法接口</span></span><br><span class="line"><span class="comment">--- 模拟构造函数的递归调用，从最上层父类构造开始调用</span></span><br><span class="line"><span class="comment">---@param cls cls@类定义</span></span><br><span class="line"><span class="comment">---@param ... ...@构造函数变长参数</span></span><br><span class="line"><span class="comment">---@return cls@cls类的实例对象table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">New</span><span class="params">(cls, ...)</span></span></span><br><span class="line">    <span class="comment">-- 实例对象表</span></span><br><span class="line">    <span class="keyword">local</span> instance = &#123;&#125;</span><br><span class="line">    <span class="comment">-- 设置实例对象元表为cls类模拟类的封装访问</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(instance, cls)</span><br><span class="line">    <span class="comment">-- create模拟面向对象里构造函数的递归调用(从父类开始构造)</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">create</span></span><br><span class="line">    <span class="built_in">create</span> = <span class="function"><span class="keyword">function</span><span class="params">(cls, ...)</span></span></span><br><span class="line">        <span class="keyword">if</span> cls._super <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">create</span>(cls._super, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> cls.Ctor <span class="keyword">then</span></span><br><span class="line">            cls.Ctor(instance, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">create</span>(cls, ...)</span><br><span class="line">    <span class="keyword">return</span> instance</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---静态类</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>  <span class="title">StaticClass</span><span class="params">(clsname)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>上面的代码注释已经很清楚了，就不一一解释了。</p>
<p>理解上面Lua实现OOP的关键在于通过table模拟Class的抽象以及数据封装，通过metatable模拟继承特性。</p>
<h3 id="Class定义"><a href="#Class定义" class="headerlink" title="Class定义"></a>Class定义</h3><p>定义一个类的方式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">类名 = Class(<span class="string">&quot;类名&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 类名:<span class="title">Ctor</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">--成员变量定义</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--方法定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 类名:方法名<span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Class继承"><a href="#Class继承" class="headerlink" title="Class继承"></a>Class继承</h3><p>继承一个类的方式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">子类名 = Class(<span class="string">&quot;子类名&quot;</span>, 父类名)</span><br><span class="line"></span><br><span class="line"><span class="comment">--构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 子类名:<span class="title">Ctor</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">--成员变量定义</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--方法定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> 子类名:方法名<span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Class对象实例化"><a href="#Class对象实例化" class="headerlink" title="Class对象实例化"></a>Class对象实例化</h3><p>Lua OOP对象实例化方式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> 变量名 = New(类名)</span><br><span class="line">变量名.成员变量</span><br><span class="line">变量名:成员方法()</span><br><span class="line">变量名.静态方法()</span><br></pre></td></tr></table></figure>

<h2 id="Lua只读Table"><a href="#Lua只读Table" class="headerlink" title="Lua只读Table"></a>Lua只读Table</h2><p>在游戏开发里，配置表数据往往是固定不允许修改的，无论是C#还是Lua，对于对象修改限制都只能通过上层封装实现此功能。</p>
<p>而这里我要学习了解的就是在Lua里实现ReadOnly table用于配置表，确保开发人员不会出现对配置表的错误操作。</p>
<p>参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/tkokof1/article/details/112850563">Sweet Snippet 之 Lua readonly table</a></p>
<h3 id="基础版只读Table"><a href="#基础版只读Table" class="headerlink" title="基础版只读Table"></a>基础版只读Table</h3><p>在Lua官网上其实已经给出了一版ReadOnly的基础实现思路:</p>
<p><a target="_blank" rel="noopener" href="https://www.lua.org/pil/13.4.5.html">Read-Only Tables</a></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readOnly</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123;       <span class="comment">-- create metatable</span></span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="string">&quot;attempt to update a read-only table&quot;</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">days = readOnly&#123;<span class="string">&quot;Sunday&quot;</span>, <span class="string">&quot;Monday&quot;</span>, <span class="string">&quot;Tuesday&quot;</span>, <span class="string">&quot;Wednesday&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Thursday&quot;</span>, <span class="string">&quot;Friday&quot;</span>, <span class="string">&quot;Saturday&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(days[<span class="number">1</span>])     <span class="comment">--&gt; Sunday</span></span><br><span class="line">days[<span class="number">2</span>] = <span class="string">&quot;Noday&quot;</span>  <span class="comment">--&gt; stdin:1: attempt to update a read-only table</span></span><br></pre></td></tr></table></figure>

<p>通过上面的事例可以看出，设计Readonly table的核心思想是通过**__index**(访问不存在Key时触发)和**__newindex**(赋值不存在Key时触发)元方法来接手所有的table访问赋值。</p>
<p>为了确保**__index<strong>和</strong>__newindex<strong>的触发，我们需要通过实现一个空table作为代理table来实现所有的Key访问和赋值都能触发</strong>__index<strong>和</strong>__newindex**，然后通过实现**__index<strong>和</strong>__newindex**将数据访问赋值指向原始table来实现数据访问和ReadOnly功能。</p>
<h3 id="进阶版只读Table-支持-和pairs"><a href="#进阶版只读Table-支持-和pairs" class="headerlink" title="进阶版只读Table(支持#和pairs)"></a>进阶版只读Table(支持#和pairs)</h3><p>上面的事例代码虽然实现了基础的ReadOnly功能，但当我们采用#或pairs访问数据长度和数据时会发现，访问不到数据，原因是因为我们的代理table本来就没有数据并且我们也没有自己实现**__len<strong>和</strong>__pairs**元方法指向原始数据访问导致的。所以进阶版ReadOnly实现如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReadOnly</span> <span class="params">(t, name)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123;       <span class="comment">-- create metatable</span></span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;attempt to update a read-only table:%s&quot;</span>, name))</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        <span class="built_in">__len</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> #t</span><br><span class="line">	    <span class="keyword">end</span>,</span><br><span class="line">        __pairs = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">next</span>, t, <span class="literal">nil</span></span><br><span class="line">	    <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> originalTable = &#123;&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(originalTable, <span class="string">&quot;A&quot;</span>)</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(originalTable, <span class="string">&quot;C&quot;</span>)</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(originalTable, <span class="string">&quot;B&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> readOnlyTable = ReadOnly(originalTable, <span class="string">&quot;readOnlyTable&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(#readOnlyTable)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(readOnlyTable) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(key)</span><br><span class="line">	<span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(readOnlyTable) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(index)</span><br><span class="line">	<span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line">readOnlyTable[<span class="number">3</span>] = <span class="string">&quot;BB&quot;</span></span><br><span class="line"><span class="comment">--readOnlyTable[4] = &quot;D&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/ReadOnlyTableOutput.png" alt="ReadOnlyTableOutput"></p>
<p>可以看到，通过重写**__len<strong>和</strong>__pairs**我们已经支持了ReadOnly的长度获取和pairs遍历访问。</p>
<h3 id="完善版只读Table-支持递归ReadOnly"><a href="#完善版只读Table-支持递归ReadOnly" class="headerlink" title="完善版只读Table(支持递归ReadOnly)"></a>完善版只读Table(支持递归ReadOnly)</h3><p>经过上面的努力我们已经支持了#和pairs的遍历操作，但我们的只读Table还只支持了一层，也就是说嵌套的table并没有支持只读设定。</p>
<p>实现思路:</p>
<ol>
<li>递归对所有的table调用ReadOnly方法</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 转换table成只读table</span></span><br><span class="line"><span class="comment">---@param t table @需要变成ReadOnly的table</span></span><br><span class="line"><span class="comment">---@param name string @ReadOnly table的名字(方便报错打印定位)</span></span><br><span class="line"><span class="comment">---@param depth number @只读table深度</span></span><br><span class="line"><span class="comment">---@return table @转换后的只读table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReadOnlyTable</span><span class="params">(t, name, depth)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(t) ~= <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">&quot;not support none table to a recusive read-only table!&quot;</span>)</span><br><span class="line"> 		<span class="keyword">return</span> t</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	depth = depth <span class="keyword">or</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> depth &gt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    	<span class="keyword">local</span> nextDepth = depth - <span class="number">1</span></span><br><span class="line">	    <span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">	    	<span class="keyword">if</span> <span class="built_in">type</span>(value) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">	    		t[key] = ReadOnlyTable (t[key], name, nextDepth)</span><br><span class="line">	    	<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123;</span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;attempt to update a read-only table:%s&quot;</span>, name))</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        <span class="built_in">__len</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> #t</span><br><span class="line">	    <span class="keyword">end</span>,</span><br><span class="line">        __pairs = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">next</span>, t, <span class="literal">nil</span></span><br><span class="line">	    <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> originalTable = &#123;&#125;</span><br><span class="line">originalTable[<span class="string">&quot;A&quot;</span>] = <span class="string">&quot;A&quot;</span></span><br><span class="line">originalTable[<span class="string">&quot;NestTable&quot;</span>] = &#123;</span><br><span class="line">	[<span class="string">&quot;Nest_A&quot;</span>] = <span class="string">&quot;Nest_A&quot;</span>,</span><br><span class="line">	[<span class="string">&quot;Nest_B&quot;</span>] = <span class="string">&quot;Nest_B&quot;</span>,</span><br><span class="line">	[<span class="string">&quot;NestNestTable&quot;</span>] = &#123;</span><br><span class="line">		[<span class="string">&quot;Nest_Nest_A&quot;</span>] = <span class="string">&quot;Nest_Nest_A&quot;</span>,</span><br><span class="line">		[<span class="string">&quot;Nest_Nest_B&quot;</span>] = <span class="string">&quot;Nest_Nest_B&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">originalTable[<span class="string">&quot;B&quot;</span>] = <span class="string">&quot;B&quot;</span></span><br><span class="line"><span class="keyword">local</span> readOnlyTable = ReadOnlyTable(originalTable, <span class="string">&quot;readOnlyTable&quot;</span>, <span class="number">2</span>)</span><br><span class="line">print_table(readOnlyTable)</span><br><span class="line"><span class="built_in">print</span>(#readOnlyTable)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(readOnlyTable) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(key)</span><br><span class="line">	<span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;==========================&quot;</span>)</span><br><span class="line"><span class="comment">--readOnlyTable[&quot;A&quot;] = &quot;AA&quot; --&gt; ReadOnly Error</span></span><br><span class="line"><span class="comment">--readOnlyTable[&quot;NestTable&quot;][&quot;Nest_A&quot;] = &quot;Nest_AA&quot; --&gt; ReadOnly Error</span></span><br><span class="line">readOnlyTable[<span class="string">&quot;NestTable&quot;</span>][<span class="string">&quot;NestNestTable&quot;</span>][<span class="string">&quot;Nest_Nest_A&quot;</span>] = <span class="string">&quot;Nest_Nest_AA&quot;</span></span><br><span class="line">print_table(readOnlyTable)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/RecusiveReadOnlyTableOuput.png" alt="RecusiveReadOnlyTableOuput"></p>
<p>通过上面的完善，我们成功的实现了支持指定深度的ReadOnly表实现。</p>
<h3 id="优化点"><a href="#优化点" class="headerlink" title="优化点"></a>优化点</h3><ol>
<li><strong>考虑到原表的性能开销，我们可以在开发期开启ReadOnly表的设计，发包后直接采用原始表访问的方式来优化掉这部分性能开销</strong></li>
</ol>
<h2 id="Lua回调绑定"><a href="#Lua回调绑定" class="headerlink" title="Lua回调绑定"></a>Lua回调绑定</h2><p>在Lua里函数有着第一类值的说法(在Lua中函数和其他值（数值、字符串）一样，函数可以被存放在变量中，也可以存放在表中，可以作为函数的参数，还可以作为函数的返回值。)。</p>
<p>很多时候我们想传递一个类方法作为回调方法，希望回来的时候是自带self，如果我们只按以下写法来使用，我们将丢掉self这个上下文:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> testHandler = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:FuncWithoutParams</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;testHandler:FuncWithoutParams()&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:TestHandler</span><span class="params">(cb)</span></span>    </span><br><span class="line">	cb()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">testHandler:TestHandler(testHandler.FuncWithoutParams)</span><br></pre></td></tr></table></figure>

<p>所以为了封装self的，我们需要通过闭包机制来实现一个handler，以下代码实现了带参和不带参的handler.lua版本:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:      Handler.lua</span></span><br><span class="line"><span class="comment">-- Description:    带self的回调绑定</span></span><br><span class="line"><span class="comment">-- Author:         TonyTang</span></span><br><span class="line"><span class="comment">-- Create Date:    2021/6/5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 无参委托绑定</span></span><br><span class="line"><span class="comment">---@param obj table @对象</span></span><br><span class="line"><span class="comment">---@param method func() @方法</span></span><br><span class="line"><span class="comment">---@return func() @委托绑定无参方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler</span><span class="params">(obj, method)</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">		method(obj)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 带参委托绑定</span></span><br><span class="line"><span class="comment">---@param obj table @对象</span></span><br><span class="line"><span class="comment">---@param method func() @方法</span></span><br><span class="line"><span class="comment">---@param ... any @参数</span></span><br><span class="line"><span class="comment">---@return func(...) @委托绑定带参方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlerBind</span><span class="params">(object, method, ...)</span></span></span><br><span class="line">	<span class="keyword">local</span> params = <span class="built_in">table</span>.pack(...)</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">		method(obj, <span class="built_in">table</span>.<span class="built_in">unpack</span>(params))</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> testHandler = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:FuncWithoutParams</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;testHandler:FuncWithoutParams()&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:FuncWithParams</span><span class="params">(param1, param2, param3)</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;testHandler:FuncWithParams(%s, %s, %s)&quot;</span>, param1, param2, param3))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:TestHandler</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">local</span> handler = <span class="built_in">_G</span>.handler(<span class="built_in">self</span>, <span class="built_in">self</span>.FuncWithoutParams)</span><br><span class="line">	handler()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testHandler:TestHandlerBind</span><span class="params">(param1, param2, param3)</span></span></span><br><span class="line">	<span class="keyword">local</span> handlerBind = <span class="built_in">_G</span>.handlerBind(<span class="built_in">self</span>, <span class="built_in">self</span>.FuncWithParams, param1, param2, param3)</span><br><span class="line">	handlerBind()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">testHandler:TestHandler()</span><br><span class="line">testHandler:TestHandlerBind(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">testHandler:TestHandlerBind(<span class="number">1</span>, <span class="literal">nil</span>, <span class="number">3</span>)</span><br><span class="line">testHandler:TestHandlerBind(<span class="literal">nil</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/HandlerOutput.PNG" alt="HandlerOutput"></p>
<p>但上面这种设计，还不支持自定义传参的基础上保留自定义函数传参：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function testHandler:FuncWithParams(...)</span><br><span class="line">	print(<span class="string">&quot;testHandler:FuncWithParams()&quot;</span>)</span><br><span class="line">    print(...)</span><br><span class="line">end</span><br><span class="line">    </span><br><span class="line">function testHandler:TestHandlerBind(...)</span><br><span class="line">	local handlerBind = _G.handlerBind(self, self.FuncWithParams, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>)</span><br><span class="line">	handlerBind(...)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">testHandler:TestHandlerBind(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>理论上上面这种情况，我们预期的testHandler:FuncWithParams()最终调用传入的参数为2+N个(“param1”+”param2”+…)</p>
<p><strong>实现上面的需求，核心我们需要利用table.pack和table.unpack的机制(但要注意table.unpack(tb)默认效果等价于table.unpack(tb, 1, #tb)即会被nil打断的，这个不是我们希望看到的)。</strong></p>
<p><strong>解决上述问题，我们只需要通过封装参数pack和unpack过程，并明确指定table.unpack(tb, 1, count)的方式来解决被nil打断的情况，最终handler.lua代码如下:</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">-- File Name:      Handler.lua</span><br><span class="line">-- Description:    带self的回调绑定</span><br><span class="line">-- Author:         TonyTang</span><br><span class="line">-- Create Date:    <span class="number">2021</span>/<span class="number">6</span>/<span class="number">5</span></span><br><span class="line"></span><br><span class="line">--- 无参委托绑定</span><br><span class="line">---@param obj table @对象</span><br><span class="line">---@param <span class="function">method <span class="title">func</span>() @方法</span></span><br><span class="line"><span class="function">---@<span class="keyword">return</span> <span class="title">func</span>() @委托绑定无参方法</span></span><br><span class="line"><span class="function">function <span class="title">handler</span>(<span class="params">obj, method</span>)</span></span><br><span class="line"><span class="function">	<span class="keyword">return</span> <span class="title">function</span>(<span class="params">...</span>)</span></span><br><span class="line"><span class="function">		<span class="title">method</span>(<span class="params">obj, ...</span>)</span></span><br><span class="line"><span class="function">	end</span></span><br><span class="line"><span class="function">end</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">--- 带参委托绑定</span></span><br><span class="line"><span class="function">---@param obj table @对象</span></span><br><span class="line"><span class="function">---@param method <span class="title">func</span>() @方法</span></span><br><span class="line"><span class="function">---@param ... any @可变长参数</span></span><br><span class="line"><span class="function">---@<span class="keyword">return</span> <span class="title">func</span>(<span class="params">...</span>) @委托绑定带参方法</span></span><br><span class="line"><span class="function">function <span class="title">handlerBind</span>(<span class="params"><span class="built_in">object</span>, method, ...</span>)</span></span><br><span class="line"><span class="function">	local <span class="keyword">params</span></span> = SafePack(...)</span><br><span class="line">	<span class="keyword">return</span> function(...)</span><br><span class="line">		local params2 = SafePack(...)</span><br><span class="line">		local concateParams = ConcatePack(<span class="keyword">params</span>, params2)</span><br><span class="line">		method(obj, SaveUnpack(concateParams))</span><br><span class="line">	end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--- 安全Pack(解决原生pack的nil截断问题, SafePack与SafeUnpack要成对使用)</span><br><span class="line">---@return table @pack后的参数<span class="function">table</span></span><br><span class="line"><span class="function">function <span class="title">SafePack</span>(<span class="params">...</span>)</span></span><br><span class="line"><span class="function">    local <span class="keyword">params</span></span> = &#123;...&#125;</span><br><span class="line">    <span class="keyword">params</span>.n = <span class="keyword">select</span>(<span class="string">&quot;#&quot;</span>, ...)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">params</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--- 安全Unpack(解决原生unpack被nil阶段问题, SafePack与SafeUnpack要成对使用)</span><br><span class="line">---@return ... @unpack后的参数列表</span><br><span class="line"><span class="function">function <span class="title">SaveUnpack</span>(<span class="params">parakParams</span>)</span></span><br><span class="line"><span class="function">	--- 使用table.<span class="title">unpack</span>()显示指定起始值和数量的方式避免被nil打断</span></span><br><span class="line"><span class="function">	<span class="keyword">return</span> table.<span class="title">unpack</span>(<span class="params">parakParams, <span class="number">1</span>, parakParams.n</span>)</span></span><br><span class="line"><span class="function">end</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">--- 合并参数</span></span><br><span class="line"><span class="function">---@param packParams1 table @已经pack的参数table1</span></span><br><span class="line"><span class="function">---@param packParams2 table @已经pack的参数table2</span></span><br><span class="line"><span class="function">---@<span class="keyword">return</span> table @合并pack后table</span></span><br><span class="line"><span class="function">function <span class="title">ConcatePack</span>(<span class="params">packParams1, packParams2</span>)</span></span><br><span class="line"><span class="function">	--- 基于table.pack和table.unpack机制合并参数</span></span><br><span class="line"><span class="function">	local finalParams</span> = &#123;&#125;</span><br><span class="line">	local params1Count = packParams1.n</span><br><span class="line">	<span class="keyword">for</span> i = <span class="number">1</span>, params1Count, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">		finalParams[i] = packParams1[i]</span><br><span class="line">	end</span><br><span class="line">	local params2Count = packParams2.n</span><br><span class="line">	<span class="keyword">for</span> i = <span class="number">1</span>, params2Count, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">		finalParams[params1Count + i] = packParams2[i]</span><br><span class="line">	end</span><br><span class="line">	finalParams.n = params1Count + params2Count</span><br><span class="line">	<span class="keyword">return</span> finalParams</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li><strong>table.unpack()默认是table.unpack(tb, 1, #tb),所以如果传递了nil的话是会被打断无法返回所有的</strong></li>
</ol>
<h2 id="Lua小知识"><a href="#Lua小知识" class="headerlink" title="Lua小知识"></a>Lua小知识</h2><ol>
<li><p>Lua里没有Class只有通过Table模拟的Class<br>参考前面的Lua OOP实现</p>
</li>
<li><p>Lua里没有this的概念，self不等价于this，函数调用传的是谁谁就是self。Lua里.定义和:定义相对于self的用法来说相当于静态和成员定义。<br>Lua里通过.调用的话是不会默认传递自身作为self的，不主动传的话self为空<br>Lua里通过:调用的话默认第一个参数就是调用者，既self</p>
</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tab.dotFunc</span><span class="params">(param)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;self = &quot;</span>, <span class="built_in">self</span>)</span><br><span class="line">    <span class="built_in">print</span>(param)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tab:colonFunc</span><span class="params">(param)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;self = &quot;</span>, <span class="built_in">self</span>)</span><br><span class="line">    <span class="built_in">print</span>(param)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">tab.dotFunc(<span class="number">1</span>)</span><br><span class="line">tab:colonFunc(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<pre><code>![LuaDotAndColon](/img/Lua/LuaDotAndColon.png)
Note:
:只是起了省略第一个参数self的作用，该self指向调用者本身，并没有其他特殊的地方。
</code></pre>
<ol start="3">
<li><p>Lua中的函数是带有词法定界（lexical scoping）的第一类值（first-class values）(在Lua中函数和其他值（数值、字符串）一样，函数可以被存放在变量中，也可以存放在表中，可以作为函数的参数，还可以作为函数的返回值)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class:Func</span><span class="params">(param1, func)</span></span></span><br><span class="line">    <span class="built_in">print</span>(param1)</span><br><span class="line">    func()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">myfunc = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;tempFunc()&quot;</span>) <span class="keyword">end</span></span><br><span class="line">class:Func(<span class="number">1</span>, myfunc)</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaFirstClassValues.png" alt="LuaFirstClassValues"></p>
</li>
<li><p>指定Lua搜索文件路径</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">package</span>.<span class="built_in">path</span> = *</span><br></pre></td></tr></table></figure>

<p>package.path是在Lua触发require时会去搜索的路径，默认是LUA_PATH_5_3或者LUA_PATH，详情参考:<a target="_blank" rel="noopener" href="https://www.lua.org/manual/5.3/manual.html#pdf-package.path">Lua Manual</a></p>
</li>
<li><p>Lua文件热重载<br>Lua通过require加载进来的文件都会被记录在package.loaded里，所以Lua热重载的核心就是让pacakge.loaded里的对应Lua文件清除后重新加载。</p>
 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---热重载指定Lua脚本</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reloadLua</span><span class="params">(filename)</span></span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">package</span>.<span class="built_in">loaded</span>[filename] == <span class="literal">nil</span>) <span class="keyword">then</span></span><br><span class="line">        Log.<span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;lua脚本 : %s 未被加载&quot;</span>, filename))</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        Log.<span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;lua脚本 : %s 已加载&quot;</span>, filename))</span><br><span class="line">        <span class="comment">--重置loaded信息</span></span><br><span class="line">        <span class="built_in">package</span>.<span class="built_in">loaded</span>[filename] = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">--重新加载Lua脚本</span></span><br><span class="line">    <span class="built_in">require</span>(filename)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Lua里pairs和ipairs有区别。pairs是key，value的形式遍历所有值。ipairs是从1开始按顺序递增遍历。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">testtab = &#123;[<span class="number">1</span>] = <span class="string">&quot;Tony&quot;</span>, [<span class="number">4</span>] = <span class="string">&quot;Huan&quot;</span>, [<span class="number">2</span>] = <span class="string">&quot;Tang&quot;</span>, [<span class="number">5</span>] = <span class="literal">nil</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(testtab) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k)</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(testtab) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaPairsAndIpairs.png" alt="LuaPairsAndIpairs"></p>
<p>Note:<br><strong>pairs不会被nil打断但ipairs都会被nil打断</strong><br><strong>ipairs还会被不是按1递增的打断</strong></p>
</li>
<li><p>Lua参数传递<br>Lua里通过arg[?]的形式访问传入的参数，默认第一个参数是arg[1]，arg[0]是lua脚本自身</p>
</li>
<li><p>Lua里面可以通过#得到table长度<br>Note:<br><strong>#会被nil打断</strong></p>
</li>
<li><p>Lua里打印数据类型用type</p>
</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="string">&quot;Tony&quot;</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaType.png" alt="LuaType">  </p>
<h1 id="Lua常用插件"><a href="#Lua常用插件" class="headerlink" title="Lua常用插件"></a>Lua常用插件</h1><h2 id="luarocks"><a href="#luarocks" class="headerlink" title="luarocks"></a>luarocks</h2><p><a target="_blank" rel="noopener" href="https://luarocks.org/"><strong>LuaRocks</strong> is the package manager for Lua modules.</a></p>
<p>从官方的介绍可以看出，LuaRocks相对于Lua，就好比Package Ctronl在Sublime Text里的存在，主要目的就是包管理器，方便Lua快速安装各种第三方Lua库。</p>
<p>根据官方的教程，LuaRocks安装设置相当复杂，单纯下载一个exe还有很多环境问题要处理。</p>
<p>这里本人不想使用官方<a target="_blank" rel="noopener" href="https://github.com/luarocks/luarocks/wiki/Installation-instructions-for-Windows/_edit">Installation instructions for Windows</a><a target="_blank" rel="noopener" href="https://github.com/luarocks/luarocks/wiki/_new">New Page</a>]的一键安装方式，主要是希望能用Lua5.3，他一键安装的方式好像是Lua5.1，所以最后打算把Lua和LuaRocks都按照以下博主的方式从源码编译走一遍流程:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/techfield/article/details/82896403">Windows 平台 Luarocks 3.0.2 编译安装</a></p>
<ul>
<li><p>安装<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/mingw-w64/">MinGW</a>(用于编译源码)</p>
<p>添加**&#x2F;MinGW&#x2F;bin到环境变量，确保gcc编译器能找到.</p>
<p><img src="/img/Lua/WhereMinGW.png" alt="WhereMinGW"></p>
<p>关于MinGW和Cygwin的区别这里暂时不深入，详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1343059">MinGw与Cygwin的区别</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1343059">MinGW 的主要方向是让GCC的Windows移植版能使用Win32API来编程。 Cygwin 的目标是能让Unix-like下的程序代码在Windows下直接被编译。</a></p>
<p>这里考虑到这里的主要目的是编译Windows版的Lua5.3，用哪一个都行，暂时是用MinGW了。</p>
</li>
<li><p>编译Lua5.3</p>
<p>下载<a target="_blank" rel="noopener" href="https://www.lua.org/ftp/">Lua5.3源码</a></p>
<p>MinGW安装好后，编译Lua5.3就很容易了，因为Lua5.3里面自带了MakeFile(指定make如何编译的文件，这里暂时不深入学习)，通过命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mingw32-make mingw</span><br></pre></td></tr></table></figure>

<p>就能触发编译Lua5.3，但为了LuaSocks后续会用到的相关目录准备工作，这里还是采用前面<a target="_blank" rel="noopener" href="https://blog.csdn.net/techfield/article/details/82896403">博主</a>提供的build.bat:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">:: ========================</span><br><span class="line">:: build.bat</span><br><span class="line">::</span><br><span class="line">:: build lua to dist folder</span><br><span class="line">:: tested with lua-<span class="number">5</span>.<span class="number">3</span>.<span class="number">5</span></span><br><span class="line">:: based on:</span><br><span class="line">:: https://medium.com/@CassiusBenard/lua-basics-windows-<span class="number">7</span>-installation-and-running-lua-files-from-the-command-line-e8196e988d71</span><br><span class="line">:: ========================</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line">:: you may change the following variable’s value</span><br><span class="line">:: to suit the downloaded version</span><br><span class="line"><span class="built_in">set</span> work_dir=%~dp0</span><br><span class="line">:: Removes trailing backslash</span><br><span class="line">:: to enhance readability <span class="keyword">in</span> the following steps</span><br><span class="line"><span class="built_in">set</span> work_dir=<span class="variable">%work_dir:~0,-1%</span></span><br><span class="line"><span class="built_in">set</span> lua_install_dir=<span class="variable">%work_dir%</span>\dist</span><br><span class="line"><span class="built_in">set</span> compiler_bin_dir=<span class="variable">%work_dir%</span>\tdm-gcc\bin</span><br><span class="line"><span class="built_in">set</span> lua_build_dir=<span class="variable">%work_dir%</span></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">path</span>=<span class="variable">%compiler_bin_dir%</span>;<span class="variable">%path%</span></span><br><span class="line"><span class="built_in">cd</span> /D <span class="variable">%lua_build_dir%</span></span><br><span class="line">mingw32-make PLAT=mingw</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="built_in">echo</span> **** COMPILATION TERMINATED ****</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="built_in">echo</span> **** BUILDING BINARY DISTRIBUTION ****</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line">:: create a clean “binary” installation</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\doc</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\bin</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\include</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%lua_install_dir%</span>\lib</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\doc\*.* <span class="variable">%lua_install_dir%</span>\doc\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\*.exe <span class="variable">%lua_install_dir%</span>\bin\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\*.dll <span class="variable">%lua_install_dir%</span>\bin\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\luaconf.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lua.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lualib.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lauxlib.h <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\lua.hpp <span class="variable">%lua_install_dir%</span>\include\*.*</span><br><span class="line"><span class="built_in">copy</span> <span class="variable">%lua_build_dir%</span>\src\liblua.a <span class="variable">%lua_install_dir%</span>\lib\liblua.a</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="built_in">echo</span> **** BINARY DISTRIBUTION BUILT ****</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="variable">%lua_install_dir%</span>\bin\lua.exe -e &quot;<span class="built_in">print</span> [[Hello!]];<span class="built_in">print</span>[[Simple Lua test successful<span class="variable">!!!</span>]]&quot;</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"></span><br><span class="line">:: configure environment variable</span><br><span class="line">:: https://stackoverflow.com/a/<span class="number">21606502</span>/<span class="number">4394850</span></span><br><span class="line">:: http://lua-users.org/wiki/LuaRocksConfig</span><br><span class="line">:: SETX - <span class="built_in">Set</span> an environment variable permanently.</span><br><span class="line">:: /m <span class="built_in">Set</span> the variable <span class="keyword">in</span> the system environment HKLM.</span><br><span class="line">setx LUA &quot;<span class="variable">%lua_install_dir%</span>\bin\lua.exe&quot; /m</span><br><span class="line">setx LUA_BINDIR &quot;<span class="variable">%lua_install_dir%</span>\bin&quot; /m</span><br><span class="line">setx LUA_INCDIR &quot;<span class="variable">%lua_install_dir%</span>\include&quot; /m</span><br><span class="line">setx LUA_LIBDIR &quot;<span class="variable">%lua_install_dir%</span>\lib&quot; /m</span><br><span class="line"></span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure>

<p>这样一来Lua编译以及Lua环境变量设置就搞定了:</p>
<p><img src="/img/Lua/LuaBuildOutput.png" alt="LuaBuildOutput"></p>
<p><img src="/img/Lua/LuaEnvSetting.png" alt="LuaEnvSetting"></p>
<p>测试以下Lua使用：</p>
<p><img src="/img/Lua/MakeSureLuaExits.png" alt="MakeSureLuaExits"></p>
<p>Note：</p>
<ol>
<li><strong>因为我们使用的是MinGW，所以博客上的make命令是找不到的需要用mingw32-make</strong></li>
<li><strong>因为涉及到设置环境变量等操作所以启动cmd或者powershell运行bat时需要以管理员身份</strong></li>
<li><strong>上文的Lua环境变量设置并未设置Lua到Path中，所以还需要单独添加Lua&#x2F;bin到能确保Lua能被找到使用</strong></li>
</ol>
</li>
<li><p>编译LuaRocks</p>
<p>下载<a target="_blank" rel="noopener" href="http://luarocks.github.io/luarocks/releases/">LuaRocks源码</a>(下一键带Install.bat的)</p>
<p>执行Install.bat触发编译流程</p>
<p><img src="/img/Lua/LuaRocksInstallCommand.png" alt="LuaRocksInstallCommand"></p>
<p>详细参数介绍参考:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/luarocks/luarocks/wiki/Installation-instructions-for-Windows">Installation instructions for Windows</a></p>
<p>最后看到LuaRocks安装成功:</p>
<p><img src="/img/Lua/LuaRocksInstallSuccess.png" alt="LuaRocksInstallSuccess"></p>
<p>最后将LuaRocks&#x2F;systree&#x2F;bin所在目录添加到环境变量Path里，这样通过LuaRocks安装的第三方库就可以使用了(经测试单独只加到Path里还不行(好像是因为Lua和LuaRocks默认分开安装的)，package.path里默认是不会去LuaRocks&#x2F;systree&#x2F;bin下找的)，需要执行以下命令来查看手动设置LUA_PATH所需的位置信息：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luarocks <span class="built_in">path</span> --bin</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/LuaRocksPathAndCPath.png" alt="LuaRocksPathAndCPath"></p>
<p>原本的LUA_PATH和LUACPATH信息：</p>
<p><img src="/img/Lua/OrignalLuaPathAndCPath.png" alt="OrignalLuaPathAndCPath"></p>
<p>把上面两个手动设置到环境变量LUA_PATH和LUA_CPATH里:</p>
<p><img src="/img/Lua/LuaEnviromentSetting.png" alt="LuaEnviromentSetting"></p>
</li>
</ul>
<p>接下来测试LuaRocks的使用：</p>
<p>我们尝试安装serpent：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luarocks install serpent</span><br></pre></td></tr></table></figure>

<p><img src="/img/Lua/InstallSerpent.png" alt="InstallSerpent"></p>
<p><img src="/img/Lua/SerpentInstallatio.png" alt="SerpentInstallatio"></p>
<p>后续会讲到serpent的使用学习，到这里Lua5.3和LuaRocks以及serpent的LuaRocks快速安装就全部结束了。</p>
<h2 id="serpent"><a href="#serpent" class="headerlink" title="serpent"></a>serpent</h2><p><a target="_blank" rel="noopener" href="https://github.com/pkulchenko/serpent">Lua serializer and pretty printer.</a></p>
<p>从Git上的介绍可以看出，Serpent是一个支持序列化反序列化以及格式化打印的第三方库。</p>
<p>比如我们希望把内存里的某个Table序列化到本地，支持下一次反序列化加载：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SerpentStudy!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;DIYLog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> serpent = <span class="built_in">require</span> <span class="string">&quot;serpent&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> serializeDataTable = &#123;</span><br><span class="line">	[<span class="string">&quot;Name&quot;</span>] = <span class="string">&quot;TonyTang&quot;</span>,</span><br><span class="line">	detailInfo = &#123;</span><br><span class="line">		[<span class="string">&quot;Age&quot;</span>] = <span class="number">18</span>,</span><br><span class="line">		[<span class="string">&quot;BirthDate&quot;</span>] = <span class="string">&quot;2000/01/01&quot;</span>,</span><br><span class="line">		[<span class="string">&quot;Adrress&quot;</span>] = <span class="string">&quot;SiChuan&quot;</span>		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> serializeString = serpent.<span class="built_in">dump</span>(serializeDataTable)</span><br><span class="line"><span class="built_in">print</span>(serializeString)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> formatSerializeString = serpent.block(serializeDataTable)</span><br><span class="line"><span class="built_in">print</span>(formatSerializeString)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> result, deserializeDataTable = serpent.<span class="built_in">load</span>(formatSerializeString)</span><br><span class="line">print_table(deserializeDataTable)</span><br></pre></td></tr></table></figure>

<p>输出:</p>
<p><img src="/img/Lua/SerpentOutput.png" alt="SerpentOutput"></p>
<p>从上面测试用例结果可以看出，通过Serpent我们轻易的做到了Lua序列化反序列化以及格式化输出</p>
<h2 id="Lpeg"><a href="#Lpeg" class="headerlink" title="Lpeg"></a>Lpeg</h2><p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/"><em>LPeg</em> is a new pattern-matching library for Lua, based on Parsing Expression Grammars (PEGs). </a></p>
<p>从官方的介绍可以看出Lpeg是一个类似正则的但并不是正则的新一代(基于Parsing Expression Grammars)的模式匹配Lua库。</p>
<p>那么什么是Parsing Expression Grammars了？</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Parsing_expression_grammar"> a <strong>parsing expression grammar</strong> (<strong>PEG</strong>), is a type of analytic formal grammar, i.e. it describes a formal language in terms of a set of rules for recognizing strings in the language.</a></p>
<p>根据Wiki的介绍可以看出Parsing Expression Grammars就是我们编程语言里的解析表达式语法。</p>
<p>为了进一步的深入学习和使用，让我们先通过Luasocks安装Lpeg库。</p>
<p><img src="/img/Lua/LpegInstallation.png" alt="LpegInstallation"></p>
<p>接下来文档<a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/">Lpeg</a>和下面这篇文章<a target="_blank" rel="noopener" href="https://www.cnblogs.com/freeblues/p/8436523.html">通过 LPeg 介绍解析表达式语法(Parsing Expression Grammars)</a>来深入学习Lpeg的设计和使用:</p>
<h3 id="Pattern"><a href="#Pattern" class="headerlink" title="Pattern"></a>Pattern</h3><p>Pattern差不多可以理解成正则里的匹配表达式。</p>
<p>为了方便理解，这里先截图下Lpeg Pattern相关定义的基础介绍:</p>
<p><img src="/img/Lua/LpegPatternsDoc.png" alt="LpegPatternsDoc"></p>
<h3 id="Match"><a href="#Match" class="headerlink" title="Match"></a>Match</h3><p>Match也和正则里的概念差不多，就是触发指定字符串使用指定Pattern进行匹配的一个过程，同时返回匹配相关结果(比如返回匹配到的字符位置的下一个字符位置。或者通过Capture函数将匹配结果转换成指定值)</p>
<p>了解了Lpeg里面的一些基础Pattern定义后，让我们看看Lpeg里匹配函数match的介绍:</p>
<p>lpeg.match (pattern, subject [, init])</p>
<p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/">The matching function. It attempts to match the given pattern against the subject string. If the match succeeds, returns the index in the subject of the first character after the match, or the captured values(if the pattern captured any value).</a></p>
<p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/">Unlike typical pattern-matching functions, <code>match</code> works only in <em>anchored</em> mode; that is, it tries to match the pattern with a prefix of the given subject string (at position <code>init</code>), not with an arbitrary substring of the subject. So, if we want to find a pattern anywhere in a string, we must either write a loop in Lua or write a pattern that matches anywhere.</a></p>
<p>从上面的介绍可以看出，match匹配成功会返回匹配位置的下一个位置或者是捕获到的值(后续会讲到<strong>捕获函数</strong>相关)。同时match不想正则可以把所有匹配都找出来而是需要通过自行通过match的init方式来loop所有捕获后的子字符串来找出所有匹配的结果。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/freeblues/p/8436523.html">默认情况下，成功匹配时，<code>LPeg</code> 将返回字符消耗数(译者注: 也就是成功匹配子串之后的下一个字符的位置). 如果你只是想看看是否匹配这就足够好了，但如果你试图解析出字符串的结构来，你必须用一些 <code>LPeg</code> 的捕获(<code>capturing</code>)函数.</a></li>
</ol>
<h3 id="Capture"><a href="#Capture" class="headerlink" title="Capture"></a>Capture</h3><p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/#captures">A <em>capture</em> is a pattern that produces values (the so called <em>semantic information</em>) according to what it matches. LPeg offers several kinds of captures, which produces values based on matches and combine these values to produce new values. Each capture may produce zero or more values.</a></p>
<p>从介绍大概理解Capture也是一种Pattern，但它是一种基于Pattern匹配结果转换出结果值的Pattern而不是常规的匹配Pattern(个人理解就好比Pattern+转换函数)。</p>
<p>为了方便理解，这里先截图下Capture相关定义的基础介绍:</p>
<p><img src="/img/Lua/LpegCaptureDoc.png" alt="LpegCaptureDoc"></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg/#captures">A capture pattern produces its values only when it succeeds.</a>(Capture Pattern只会在成功时计算值)</li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;LpegStudy&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;DIYLog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 最终目标：</span></span><br><span class="line"><span class="comment">--- 1. &#123;***&#125;占位替换 </span></span><br><span class="line"><span class="comment">--- 2. &#123;num string1 | string2 | string3 &#125;根据num选择对应字符串</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> lpeg = <span class="built_in">require</span>(<span class="string">&quot;lpeg&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> <span class="built_in">match</span> = lpeg.<span class="built_in">match</span></span><br><span class="line"><span class="keyword">local</span> P = lpeg.P</span><br><span class="line"><span class="keyword">local</span> R = lpeg.R</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 普通匹配</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;普通匹配:&quot;</span>)</span><br><span class="line"><span class="comment">--- 不匹配，返回nil</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(P(<span class="string">&quot;hello&quot;</span>), <span class="string">&quot;world&quot;</span>))</span><br><span class="line"><span class="comment">--- 一个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(P(<span class="string">&quot;hello&quot;</span>), <span class="string">&quot;hello&quot;</span>))</span><br><span class="line"><span class="comment">--- 一个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(P(<span class="string">&quot;hello&quot;</span>), <span class="string">&quot;helloworld&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 模式组合</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;模式组合:&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> helloPattern = P(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> worldPattern = P(<span class="string">&quot;world&quot;</span>)</span><br><span class="line"><span class="comment">--- *表示匹配pattern1后面跟随pattern2</span></span><br><span class="line"><span class="keyword">local</span> helloAndworldPattern = helloPattern * worldPattern</span><br><span class="line"><span class="comment">--- +表示匹配pattern1或者pattern2</span></span><br><span class="line"><span class="keyword">local</span> helloOrworldPattern = helloPattern + worldPattern</span><br><span class="line"><span class="comment">--- 一个匹配，返回11</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloAndworldPattern, <span class="string">&quot;helloworld&quot;</span>))</span><br><span class="line"><span class="comment">--- 不匹配，返回nil</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloAndworldPattern, <span class="string">&quot;worldhello&quot;</span>))</span><br><span class="line"><span class="comment">--- 1个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloOrworldPattern, <span class="string">&quot;helloworld&quot;</span>))</span><br><span class="line"><span class="comment">--- 1个匹配，返回6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(helloOrworldPattern, <span class="string">&quot;worldhello&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 解析数字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;解析数字:&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> integerPattern = R(<span class="string">&quot;09&quot;</span>)^<span class="number">1</span></span><br><span class="line"><span class="comment">--- 解析数字带捕获函数</span></span><br><span class="line"><span class="keyword">local</span> integerCapturePattern = R(<span class="string">&quot;09&quot;</span>)^<span class="number">1</span> / <span class="built_in">tonumber</span></span><br><span class="line"><span class="comment">--- 匹配，返回5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(integerPattern, <span class="string">&quot;2923 2924&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，返回2923</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(integerCapturePattern, <span class="string">&quot;2923 2924&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 解析数字或者字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;解析数字或者字符：&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> charPattern = P(<span class="number">1</span>)</span><br><span class="line"><span class="comment">--- 匹配，返回2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">match</span>(charPattern, <span class="string">&quot;hello 123&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> integerOrchaPattern = integerCapturePattern<span class="comment">-- + charPattern</span></span><br><span class="line"><span class="comment">--- 利用Capture.Ct函数存储所有匹配结果到表中</span></span><br><span class="line"><span class="keyword">local</span> integerOrcharCapture = lpeg.Ct(integerOrchaPattern^<span class="number">0</span>)</span><br><span class="line"><span class="comment">--- 未匹配输出 &#123;&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;hello!&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出：&#123;123&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;hello 123&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出：&#123;5,5,5,7,7,7&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;5 5 5 yeah 7 7 7&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出：&#123;5,5,5,7,7,7&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(integerOrcharCapture, <span class="string">&quot;5 5 5 a b c d 7 7 7&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 计算器语法解析器</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;计算器语法解析器:&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> white = lpeg.S(<span class="string">&quot; \t\r\n&quot;</span>) ^ <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> integer = white * lpeg.R(<span class="string">&quot;09&quot;</span>) ^ <span class="number">1</span> / <span class="built_in">tonumber</span></span><br><span class="line"><span class="keyword">local</span> muldiv = white * lpeg.C(lpeg.S(<span class="string">&quot;/*&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> addsub = white * lpeg.C(lpeg.S(<span class="string">&quot;+-&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> factor = integer * muldiv * integer + integer</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;5&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(lpeg.Ct(factor), <span class="string">&quot;5&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;2,&quot;*&quot;,1&#125;</span></span><br><span class="line">print_table(<span class="built_in">match</span>(lpeg.Ct(factor), <span class="string">&quot;2*1&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 字符串匹配替换</span></span><br><span class="line"><span class="comment">--- 实现类似gsub的方法的效果</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;字符串匹配替换：&quot;</span>)</span><br><span class="line"><span class="comment">--- lpeg.Ct -- 仅仅捕获到table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">(s, patt)</span></span></span><br><span class="line">	patt = P(patt) / <span class="built_in">tostring</span></span><br><span class="line">	<span class="keyword">local</span> p = lpeg.Ct((patt + <span class="number">1</span>)^<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">match</span>(p, s)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- lpeg.Cs -- 捕获并替换</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gsub</span><span class="params">(s, patt, repl)</span></span></span><br><span class="line">	patt = P(patt)</span><br><span class="line">	<span class="keyword">local</span> p = lpeg.Cs((patt / repl + <span class="number">1</span>)^<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">match</span>(p, s)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;&quot;dog&quot;,&quot;dog&quot;&#125;</span></span><br><span class="line">print_table(<span class="built_in">find</span>(<span class="string">&quot;hello dog, dog!&quot;</span>, <span class="string">&quot;dog&quot;</span>))</span><br><span class="line"><span class="comment">--- 匹配，输出:&#123;&quot;hello cat, cat!&quot;&#125;</span></span><br><span class="line">print_table(<span class="built_in">gsub</span>(<span class="string">&quot;hello dog, dog!&quot;</span>, <span class="string">&quot;dog&quot;</span>, <span class="string">&quot;cat&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 最终目标1: &#123;***&#125;占位替换</span></span><br><span class="line"><span class="comment">--- 指定字符串，采用table里的key替换&#123;key&#125;成key对应的value</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tableGsub</span><span class="params">(s, tb)</span></span></span><br><span class="line">	<span class="keyword">local</span> result = s</span><br><span class="line">	<span class="keyword">local</span> replaceKey = <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">local</span> replaceValue = <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(tb) <span class="keyword">do</span></span><br><span class="line">		replaceKey = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;&#123;%s&#125;&quot;</span>, key)</span><br><span class="line">		replaceValue = <span class="built_in">tostring</span>(value)</span><br><span class="line">		<span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;字符串:%s 替换:%s为%s&quot;</span>, result, replaceKey, replaceValue))</span><br><span class="line">		result = <span class="built_in">gsub</span>(result, replaceKey, replaceValue)</span><br><span class="line">		<span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;替换后结果:%s&quot;</span>, result))</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> content = <span class="string">&quot;测试table替换,名字:&#123;name&#125; 年龄:&#123;age&#125; 性别:&#123;sex&#125; 名字2:&#123;name&#125; 名字3:&#123;name&#125;&quot;</span></span><br><span class="line"><span class="keyword">local</span> replaceTable = &#123;</span><br><span class="line">	name = <span class="string">&quot;TonyTang&quot;</span>,</span><br><span class="line">	sex = <span class="string">&quot;Man&quot;</span>,</span><br><span class="line">	age = <span class="number">18</span>,</span><br><span class="line">	luckyNumber = <span class="number">7</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">local</span> timeCounter = New(TimeCounter, <span class="string">&quot;tableGsub&quot;</span>)</span><br><span class="line">timeCounter:Start()</span><br><span class="line">content = tableGsub(content, replaceTable)</span><br><span class="line">timeCounter:Stop()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;替换后结果:replaceValue&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;替换耗时:%s&quot;</span>, timeCounter.EllapseTime))</span><br></pre></td></tr></table></figure>









<h1 id="Lua-IDE"><a href="#Lua-IDE" class="headerlink" title="Lua IDE"></a>Lua IDE</h1><p>首先这里决定选一个相对轻量级的Lua IDE，VS因为太重量级了，这里不考虑。<br>其次考虑到跨平台和前端常用的(平时主要会用到C#和Lua)，最初决定选择VSCode作为Lua代码编写的IDE，VSCode丰富的插件库也是选择VSCode很重要的一个原因之一。经过调研发现VSCode第三方插件<a target="_blank" rel="noopener" href="https://www.showdoc.cc/luaide?page_id=1832520940259550">Luaide在VSCode 1.33.1以上版本有严重的内存暴涨问题</a>，所以最后笔者转向了VSCode + EmmyLua 插件的方式。</p>
<h2 id="VSCode"><a href="#VSCode" class="headerlink" title="VSCode"></a>VSCode</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Visual_Studio_Code">Visual Studio Code（简称VS Code）是一个由微软开发的，同时支持Windows、Linux、和macOS系统且开放源代码的代码编辑器[4]，它支持测试，并内置了Git 版本控制功能，同时也具有开发环境功能，例如代码补全（类似于 IntelliSense）、代码片段、和代码重构等，该编辑器支持用户个性化配置，例如改变主题颜色、键盘快捷方式等各种属性和参数，还在编辑器中内置了扩展程序管理的功能。</a></p>
<h3 id="设置同步"><a href="#设置同步" class="headerlink" title="设置同步"></a>设置同步</h3><p>VSCode支持高度自由的自定义插件和自定义设置，我们如何在不同的工作环境快速同步IDE信息(插件，自定义设置等)，避免每一次在不同工作环境下都重复下载插件设置等操作是一个需要解决的问题。</p>
<p>借助于第三方插件：<br>SettingsSync(使用了Github Gist)可以同步保存VSCode配置和扩展。</p>
<p>详细配置流程参考:<br><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=Shan.code-settings-sync">Settings Sync</a></p>
<p>上传快捷键：<br>Shift + Alt + U<br>下载同步快捷键：<br>Shift + Alt + D</p>
<h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><p>当拿到新的IDE时，为了工作效率，快捷键不熟是一个很影响开发效率的问题。<br>VSCode丰富的插件库和高度的可自定义可以轻松解决这个问题：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.vs-keybindings">Visual Studio Keymap</a>(第三方插件 – 快速导入VS的快捷键)</li>
<li>Custom Shortcup Keymap(自定义设置快捷键File -&gt; Preference -&gt; Keyboard Shortcuts – 用于满足自定义需求)</li>
</ol>
<h3 id="Snippets"><a href="#Snippets" class="headerlink" title="Snippets"></a>Snippets</h3><p>Snippets又名代码片段，主要目的是为了通过自定义关键词和模板，快速触发代码片段生成。<br>这里主要针对自定义代码片段的功能使用来学习。<br>File -&gt; Preference -&gt; User Snippets<br>e.g.个人文件署名的代码片段：<br>lua.json</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Lua File Title Sneppits&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;prefix&quot;</span>: <span class="string">&quot;LuaFileTitle&quot;</span>,</span><br><span class="line">        <span class="string">&quot;body&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;-- File Name:    $TM_FILENAME&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-- Description:    This file is used to $&#123;1:Staff&#125;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-- Author:       $&#123;2:TangHuan&#125;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-- Create Date:    $&#123;3:Year&#125;/$&#123;4:Month&#125;/$&#123;5:Day&#125;&quot;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Lua File Title Sneppits&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来当我们输入LuaFileTitle关键词时，VSCode就会自动触发提示，直接table键选择Snippets就能触发代码生成。<br>效果如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:    Base.lua</span></span><br><span class="line"><span class="comment">-- Description:    This file is used to Staff</span></span><br><span class="line"><span class="comment">-- Author:       TangHuan</span></span><br><span class="line"><span class="comment">-- Create Date:    Year/Month/Day</span></span><br></pre></td></tr></table></figure>

<p>详细使用Snippets参考:<br><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/editor/userdefinedsnippets">Creating your own snippets</a></p>
<h3 id="Lua调试"><a href="#Lua调试" class="headerlink" title="Lua调试"></a>Lua调试</h3><p>Lua作为解析执行的语言，调试相比其他高级语言比较麻烦一点，这里选择借助第三方(Luaide)插件作为辅助工具。</p>
<p>经过调研发现VSCode第三方插件<a target="_blank" rel="noopener" href="https://www.showdoc.cc/luaide?page_id=1832520940259550">Luaide在VSCode 1.33.1以上版本有严重的内存暴涨问题</a>，所以最后笔者转向了VSCode + EmmyLua 插件的方式。<br>这里就没有详细了解VSCode + LuaIde的调试方式了。</p>
<h4 id="EmmyLua"><a href="#EmmyLua" class="headerlink" title="EmmyLua"></a>EmmyLua</h4><p><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/annotation.html">EmmyLua</a><br>VSCode安装EmmyLua很简单，直接插件里搜索安装即可，这里就不多做说明。</p>
<p>接下来主要结合XLua+VSCode+EmmyLua实战使用EmmyLua提示和调试两大重要功能。</p>
<h5 id="VSCode配置"><a href="#VSCode配置" class="headerlink" title="VSCode配置"></a>VSCode配置</h5><p>安装EmmyLua插件后，VSCode基本就已经完成配置了，但要使用VSCode开始编写Lua代码，我们还需要把Lua代码导入到VSCode里来。</p>
<p>VSCode导入Lua代码是以目录的形式，我们导入的我们加载Lua文件所在的最上层目录即可：<br><img src="/img/Lua/LuaFolderStructure.png" alt="LuaFolderStructure"></p>
<h5 id="XLua"><a href="#XLua" class="headerlink" title="XLua"></a>XLua</h5><p><a target="_blank" rel="noopener" href="https://github.com/Tencent/xLua">XLua官网</a><br>XLua的集成很简单，从Git下下来，把关键的几个目录放到项目里即可。<br>主要是如下几个目录：</p>
<ol>
<li>Tools(打包时XLua代码注入需要的工具在这里 Note: 放Assets同一层不要放到Assets里了)</li>
<li>Assets&#x2F;XLua&#x2F;Src(XLua需要的CS源代码)</li>
<li>Assets&#x2F;XLua&#x2F;Editor&#x2F;ExampleConfig.cs(XLua默认给的一套纯Lua开发基于反射生成需要标记CSharpCallLua || LuaCallCSharp || BlackList || Hotfix的一套模板)</li>
<li>Assets&#x2F;Plugins(XLua编译多平台后的库文件)</li>
</ol>
<p>Unity加载Lua文件默认不认.lua后缀的文件，我们需要自定义CustomLoader去加载到我们想要加载的.lua文件。<br>LuaManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> XLua;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lua单例管理者</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LuaManager</span> : <span class="title">SingletonMonoBehaviourTemplate</span>&lt;<span class="title">LuaManager</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua环境(全局唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> LuaEnv LuaEnv</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua脚本默认创建目录路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> LuaScriptFolderPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua脚本文件后缀</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> LuaFilePostFix = <span class="string">&quot;.lua&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua脚本文件路径映射Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Key为文件名(不含.lua后缀)，Value为该文件的全路径(含.lua后缀)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; mLuaScriptFilePathMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;LuaManager:init()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (LuaEnv == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            LuaEnv = <span class="keyword">new</span> LuaEnv();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Lua环境已经初始化！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LuaScriptFolderPath = Application.dataPath + <span class="string">&quot;/Scripts/XLua/Lua/&quot;</span>;</span><br><span class="line">        mLuaScriptFilePathMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自定义CustomLoader</span></span><br><span class="line">        LuaEnv.AddLoader(LuaCustomLoader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取所有Lua文件</span></span><br><span class="line">        readAllLuaFiles();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载LuaMain.lua</span></span><br><span class="line">        LuaEnv.DoString(<span class="string">&quot;require &#x27;LuaMain&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readAllLuaFiles</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> allluafiles = Directory.GetFiles(LuaScriptFolderPath, <span class="string">&quot;*.lua&quot;</span>, SearchOption.AllDirectories);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> luafile <span class="keyword">in</span> allluafiles)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> luafilename = Path.GetFileNameWithoutExtension(luafile);</span><br><span class="line">            <span class="keyword">if</span>(!mLuaScriptFilePathMap.ContainsKey(luafilename))</span><br><span class="line">            &#123;</span><br><span class="line">                mLuaScriptFilePathMap.Add(luafilename, luafile);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;有重名的Lua文件,文件路径:&#123;0&#125;文件路径:&#123;1&#125;&quot;</span>,luafile, mLuaScriptFilePathMap[luafilename]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua自定义Loader</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">byte</span>[] <span class="title">LuaCustomLoader</span>(<span class="params"><span class="keyword">ref</span> <span class="built_in">string</span> filename</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;加载Lua文件 ： &#123;0&#125;&quot;</span>, filename));</span><br><span class="line">        <span class="keyword">var</span> scriptfullpath = <span class="built_in">string</span>.Empty;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        <span class="comment">//Editor走File加载</span></span><br><span class="line">        <span class="comment">//Unity不认Lua后缀的情况</span></span><br><span class="line">        <span class="keyword">var</span> luascriptfolderpath = <span class="built_in">string</span>.Empty;</span><br><span class="line">        <span class="built_in">byte</span>[] luafile = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mLuaScriptFilePathMap.TryGetValue(filename, <span class="keyword">out</span> scriptfullpath))</span><br><span class="line">        &#123;</span><br><span class="line">            luafile = File.ReadAllBytes(scriptfullpath);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">        <span class="comment">//真机走其他方式加载</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (luafile != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> luafile;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;找不到Lua文件 : &#123;0&#125;&quot;</span>, filename));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到为了成功加载.lua后缀的Lua文件我做了以下几件事：</p>
<ol>
<li>通过Directory.GetFiles()获取到所有*.lua文件的路径映射，用于加载时消除目录的概念</li>
<li>自定义CustomLoader，支持加载(通过File.ReadAllBytes).lua后缀文件</li>
</ol>
<h5 id="代码提示"><a href="#代码提示" class="headerlink" title="代码提示"></a>代码提示</h5><p>Test.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- File Name:    Test.lua</span></span><br><span class="line"><span class="comment">-- Description:    This file is used to Test EmmyLua</span></span><br><span class="line"><span class="comment">-- Author:       TangHuan</span></span><br><span class="line"><span class="comment">-- Create Date:    2019/04/29</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 自定义table类型，测试Emmylua注释提示</span></span><br><span class="line"><span class="comment">---@class diytable</span></span><br><span class="line"><span class="comment">---@field field1 number 字段1</span></span><br><span class="line"><span class="comment">---@field field2 string 字段2</span></span><br><span class="line"><span class="keyword">local</span> diytable = &#123;</span><br><span class="line">    field1 = <span class="number">321</span>,</span><br><span class="line">    field2 = <span class="string">&quot;field2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">---@param para1 number 参数1</span></span><br><span class="line"><span class="comment">---@return diytable 返回diytable</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Test</span><span class="params">(para1)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Test(&quot;</span> .. para1 .. <span class="string">&quot;)&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> diytable</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">table</span> = Test(<span class="number">123</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">table</span>.field1)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">table</span>.field2)</span><br></pre></td></tr></table></figure>

<p>输入table.时会看到成员变量提示:<br><img src="/img/Lua/EmmyLuaNotation.png" alt="EmmyLuaNotation"></p>
<p>EmmyLua提示详细使用参考：<br><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/annotations/class.html">@class类声明注解</a></p>
<h5 id="查找方法引用"><a href="#查找方法引用" class="headerlink" title="查找方法引用"></a>查找方法引用</h5><p>EmmyLua查找方法引用很简单，直接在方法上右键查找所有引用即可：<br><img src="/img/Lua/LuaMethodReference.png" alt="LuaMethodReference"></p>
<h5 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h5><p>EmmyLua插件装好后，VSCode导入了Lua加载最上层目录后，调试Lua就很简单了：<br>F5 -&gt; EmmyLua Attach Debug -&gt; 选择对应Unity进程<br>然后通过F9下断点就可以像VS一样给Lua下断点了。<br><img src="/img/Lua/VSCodeEmmyLuaDebug.png" alt="VSCodeEmmyLuaDebug"></p>
<h1 id="ToLua"><a href="#ToLua" class="headerlink" title="ToLua"></a>ToLua</h1><p>待续……</p>
<h1 id="Refrence"><a href="#Refrence" class="headerlink" title="Refrence"></a>Refrence</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/freeblues/p/8436523.html">通过 LPeg 介绍解析表达式语法(Parsing Expression Grammars)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.inf.puc-rio.br/~roberto/lpeg">lpeg</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangziqiu/archive/2011/03/30/computercode.html">原码, 反码, 补码 详解</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000024426172">谈谈二进制（四）——原码、补码、反码、移码</a></p>
<h2 id="以前学习笔记"><a href="#以前学习笔记" class="headerlink" title="以前学习笔记"></a>以前学习笔记</h2><p>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102uzsx.html]</a>(Game Scripting Mastery)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0rk.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0rk.html]</a>(Lua – some important concept and knowledge)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s0.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s0.html]</a>(Lua - Coroutines Study )<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s5.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s5.html]</a>(Lua - Metatables and Metamethods)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0s9.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0s9.html]</a>(Lua - Object Oriented Programming)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zp.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0zp.html]</a>(Lua - C API)<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v0zs.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v0zs.html]</a>(Lua - C call Lua &amp; Lua call C )<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v1qg.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v1qg.html]</a>(Lua - Userdata )<br>[<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v383.html]">http://blog.sina.com.cn/s/blog_8c7d49f20102v383.html]</a>(Lua - Managing Resources &amp; Threads and States)</p>
<h2 id="官方网站"><a href="#官方网站" class="headerlink" title="官方网站"></a>官方网站</h2><p><a target="_blank" rel="noopener" href="https://github.com/Tencent/xLua">XLua</a><br><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/installation.html">EmmyLua</a></p>
<h2 id="参考书籍"><a href="#参考书籍" class="headerlink" title="参考书籍"></a>参考书籍</h2><p>《Programming in Lua third edition》 – Roberto Ierusalimschy<br>《Lua用户手册》<br>《Game Scripting Mastery》 – Alex Varanese</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Programming-Language/">Programming Language</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Lua/">Lua</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://tonytang1990.github.io/2017/08/14/Unity%E4%B8%AD%E7%9A%84Lua/" data-title="Unity中的Lua | 走停人生路" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/03/18/导表工具/" title="导表工具">
  <strong>上一篇：</strong><br/>
  <span>
  导表工具</span>
</a>
</div>


<div class="next">
<a href="/2017/06/14/Android自动化签包/"  title="Android自动化签包">
 <strong>下一篇：</strong><br/> 
 <span>Android自动化签包
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua"><span class="toc-number">1.</span> <span class="toc-text">Lua</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua-Study"><span class="toc-number">2.</span> <span class="toc-text">Lua Study</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Weak-Tables-And-Finalizers"><span class="toc-number">2.1.</span> <span class="toc-text">Weak Tables And Finalizers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E9%87%8C%E7%9A%84%E4%BD%8D%E8%BF%90%E7%AE%97"><span class="toc-number">2.2.</span> <span class="toc-text">Lua里的位运算</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E5%8F%8D"><span class="toc-number">2.2.1.</span> <span class="toc-text">取反</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%BB%E4%BD%8D%E5%92%8C%E5%BC%82%E6%88%96"><span class="toc-number">2.2.2.</span> <span class="toc-text">移位和异或</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E9%87%8C%E7%9A%84OOP"><span class="toc-number">2.3.</span> <span class="toc-text">Lua里的OOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Class%E6%8A%BD%E8%B1%A1"><span class="toc-number">2.3.1.</span> <span class="toc-text">Class抽象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Class%E5%AE%9A%E4%B9%89"><span class="toc-number">2.3.2.</span> <span class="toc-text">Class定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Class%E7%BB%A7%E6%89%BF"><span class="toc-number">2.3.3.</span> <span class="toc-text">Class继承</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Class%E5%AF%B9%E8%B1%A1%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.3.4.</span> <span class="toc-text">Class对象实例化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E5%8F%AA%E8%AF%BBTable"><span class="toc-number">2.4.</span> <span class="toc-text">Lua只读Table</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%89%88%E5%8F%AA%E8%AF%BBTable"><span class="toc-number">2.4.1.</span> <span class="toc-text">基础版只读Table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E7%89%88%E5%8F%AA%E8%AF%BBTable-%E6%94%AF%E6%8C%81-%E5%92%8Cpairs"><span class="toc-number">2.4.2.</span> <span class="toc-text">进阶版只读Table(支持#和pairs)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%96%84%E7%89%88%E5%8F%AA%E8%AF%BBTable-%E6%94%AF%E6%8C%81%E9%80%92%E5%BD%92ReadOnly"><span class="toc-number">2.4.3.</span> <span class="toc-text">完善版只读Table(支持递归ReadOnly)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%82%B9"><span class="toc-number">2.4.4.</span> <span class="toc-text">优化点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E5%9B%9E%E8%B0%83%E7%BB%91%E5%AE%9A"><span class="toc-number">2.5.</span> <span class="toc-text">Lua回调绑定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E5%B0%8F%E7%9F%A5%E8%AF%86"><span class="toc-number">2.6.</span> <span class="toc-text">Lua小知识</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">Lua常用插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#luarocks"><span class="toc-number">3.1.</span> <span class="toc-text">luarocks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#serpent"><span class="toc-number">3.2.</span> <span class="toc-text">serpent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lpeg"><span class="toc-number">3.3.</span> <span class="toc-text">Lpeg</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pattern"><span class="toc-number">3.3.1.</span> <span class="toc-text">Pattern</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Match"><span class="toc-number">3.3.2.</span> <span class="toc-text">Match</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Capture"><span class="toc-number">3.3.3.</span> <span class="toc-text">Capture</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">3.3.4.</span> <span class="toc-text">实战</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua-IDE"><span class="toc-number">4.</span> <span class="toc-text">Lua IDE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#VSCode"><span class="toc-number">4.1.</span> <span class="toc-text">VSCode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">4.1.1.</span> <span class="toc-text">设置同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E6%8D%B7%E9%94%AE"><span class="toc-number">4.1.2.</span> <span class="toc-text">快捷键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Snippets"><span class="toc-number">4.1.3.</span> <span class="toc-text">Snippets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E8%B0%83%E8%AF%95"><span class="toc-number">4.1.4.</span> <span class="toc-text">Lua调试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EmmyLua"><span class="toc-number">4.1.4.1.</span> <span class="toc-text">EmmyLua</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#VSCode%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.4.1.1.</span> <span class="toc-text">VSCode配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#XLua"><span class="toc-number">4.1.4.1.2.</span> <span class="toc-text">XLua</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%8F%90%E7%A4%BA"><span class="toc-number">4.1.4.1.3.</span> <span class="toc-text">代码提示</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8"><span class="toc-number">4.1.4.1.4.</span> <span class="toc-text">查找方法引用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">4.1.4.1.5.</span> <span class="toc-text">调试</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ToLua"><span class="toc-number">5.</span> <span class="toc-text">ToLua</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Refrence"><span class="toc-number">6.</span> <span class="toc-text">Refrence</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A5%E5%89%8D%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-number">6.1.</span> <span class="toc-text">以前学习笔记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E7%BD%91%E7%AB%99"><span class="toc-number">6.2.</span> <span class="toc-text">官方网站</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E4%B9%A6%E7%B1%8D"><span class="toc-number">6.3.</span> <span class="toc-text">参考书籍</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2025 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
