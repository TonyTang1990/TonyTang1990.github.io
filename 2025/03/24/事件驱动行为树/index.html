
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>事件驱动行为树 | 走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta name="description" content="前言在学习了UIElement相关知识以后，实战实现一套基于事件驱动的行为树(用UIElement开发编辑器)作为目标，深入基于事件驱动的行为树设计和UIElement的深入使用，为未来实现引导节点编辑器等功能需求做准备。 行为树行为树主要用于AI开发，将AI逻辑通过树状逻辑进行组装表达，可以方便的制作和调试AI。 常规的行为树中，每帧都要从根节点开始遍历行为树，而目的仅仅是为了得到最近激活的节点">
<meta property="og:type" content="article">
<meta property="og:title" content="事件驱动行为树">
<meta property="og:url" content="http://tonytang1990.github.io/2025/03/24/%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:description" content="前言在学习了UIElement相关知识以后，实战实现一套基于事件驱动的行为树(用UIElement开发编辑器)作为目标，深入基于事件驱动的行为树设计和UIElement的深入使用，为未来实现引导节点编辑器等功能需求做准备。 行为树行为树主要用于AI开发，将AI逻辑通过树状逻辑进行组装表达，可以方便的制作和调试AI。 常规的行为树中，每帧都要从根节点开始遍历行为树，而目的仅仅是为了得到最近激活的节点">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/AddRootNode.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/CustomNodeViewUI.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/PortConnectPreview.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/AvalibleConnectPortPreview.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/CreateEdgeViewFromEdgeData.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/NodeDIYParamsDisplay.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/NodeRightClickMenu.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/ShowNodeEdgeIndex.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/CreateGridDisplay.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/GraphDataReusing.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/RecusiveCopyNode.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/NodeSelectionOperation.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/SaveAndLoadGraphData.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/DeleteNodeRecusive.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/RecoverDeleteNodeRecusiveOperation.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/">
<meta property="og:image" content="http://tonytang1990.github.io/">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/EventBehaviourTree/RootNodeRunningOnceSetting.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/EventBehaviourTree/BlackBoardStopNone.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/EventBehaviourTree/StopNoneBlackBoardInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/EventBehaviourTree/BlackBoardStopSelf.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/EventBehaviourTree/BlackBoardStopLowerPriority.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/EventBehaviourTree/BlackBoardStopBoth.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/EventBehaviourTree/BlackBoardStopLowerPriorityImmediateRestart.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/EventBehaviourTree/BlackBoardStopImmediateRestart.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/EventBehaviourTree/BehaviourTreePause.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/EventBehaviourTree/BehaviourTreeResume.PNG">
<meta property="article:published_time" content="2025-03-24T07:45:00.000Z">
<meta property="article:modified_time" content="2026-01-15T09:24:11.293Z">
<meta property="article:author" content="Tony Tang">
<meta property="article:tag" content="AI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://tonytang1990.github.io/img/Unity/UIToolkit/AddRootNode.PNG">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2025/03/24/事件驱动行为树/" title="事件驱动行为树" itemprop="url">事件驱动行为树</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2025-03-24T07:45:00.000Z" itemprop="datePublished"> 发表于 2025-03-24</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%8C%E4%B8%BA%E6%A0%91"><span class="toc-number">2.</span> <span class="toc-text">行为树</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%8C%E4%B8%BA%E6%A0%91%E8%8A%82%E7%82%B9%E7%BC%96%E8%BE%91%E5%99%A8"><span class="toc-number">3.</span> <span class="toc-text">行为树节点编辑器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.1.</span> <span class="toc-text">节点设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E9%80%89%E6%8B%A9%E5%88%97%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.2.</span> <span class="toc-text">节点选择列表设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C%E6%98%BE%E7%A4%BA%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.3.</span> <span class="toc-text">节点操作显示设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GraphView%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.3.1.</span> <span class="toc-text">GraphView设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StyleSheet%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.2.</span> <span class="toc-text">StyleSheet添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.3.</span> <span class="toc-text">节点创建添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E8%87%AA%E5%AE%9A%E4%B9%89UI%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.4.</span> <span class="toc-text">节点自定义UI添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9Port%E5%88%9B%E5%BB%BA%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.5.</span> <span class="toc-text">节点Port创建添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9Port%E8%BF%9E%E7%BA%BF%E5%8A%9F%E8%83%BD%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.6.</span> <span class="toc-text">节点Port连线功能添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9Port%E8%BF%9E%E7%BA%BF%E8%BF%98%E5%8E%9F"><span class="toc-number">3.3.7.</span> <span class="toc-text">节点Port连线还原</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%8F%82%E6%95%B0%E9%9D%A2%E6%9D%BF%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.8.</span> <span class="toc-text">节点参数面板添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%8F%B3%E9%94%AE%E6%93%8D%E4%BD%9C%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.9.</span> <span class="toc-text">节点右键操作添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E7%AB%AF%E5%8F%A3%E8%8A%82%E7%82%B9%E8%BE%B9%E9%A1%BA%E5%BA%8F%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E6%8E%92%E5%BA%8F%E6%98%BE%E7%A4%BA"><span class="toc-number">3.3.10.</span> <span class="toc-text">输出端口节点边顺序索引数据排序显示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E7%BD%91%E6%A0%BC%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.11.</span> <span class="toc-text">背景网格添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%BE%E6%95%B0%E6%8D%AE%E6%8B%96%E6%8B%BD%E9%87%8D%E7%94%A8"><span class="toc-number">3.3.12.</span> <span class="toc-text">图数据拖拽重用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6"><span class="toc-number">3.3.13.</span> <span class="toc-text">节点数据复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%91%E6%9D%BF%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.14.</span> <span class="toc-text">黑板数据</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%91%E6%9D%BF%E6%95%B0%E6%8D%AE%E8%BF%90%E8%A1%8C%E6%97%B6%E5%AD%98%E5%82%A8"><span class="toc-number">3.3.14.1.</span> <span class="toc-text">黑板数据运行时存储</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%91%E6%9D%BF%E6%95%B0%E6%8D%AE%E8%BF%90%E8%A1%8C%E6%97%B6%E9%A9%B1%E5%8A%A8%E5%92%8C%E9%80%9A%E7%9F%A5"><span class="toc-number">3.3.14.2.</span> <span class="toc-text">黑板数据运行时驱动和通知</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%91%E6%9D%BF%E6%95%B0%E6%8D%AE%E7%BC%96%E8%BE%91%E5%99%A8%E7%BC%96%E8%BE%91%E5%92%8C%E5%AD%98%E5%82%A8%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.3.14.3.</span> <span class="toc-text">黑板数据编辑器编辑和存储加载</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GraphView%E6%93%8D%E4%BD%9C%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.15.</span> <span class="toc-text">GraphView操作添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2"><span class="toc-number">3.3.16.</span> <span class="toc-text">坐标转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%BF%9D%E5%AD%98%E5%92%8C%E5%8A%A0%E8%BD%BD%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.17.</span> <span class="toc-text">数据保存和加载添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%92%A4%E9%94%80%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.3.18.</span> <span class="toc-text">撤销系统</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91"><span class="toc-number">4.</span> <span class="toc-text">事件驱动行为树</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E7%B1%BB%E5%9B%BE%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.1.</span> <span class="toc-text">事件驱动行为树类图设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%95%B0%E6%8D%AE%E7%BC%96%E8%BE%91"><span class="toc-number">4.2.</span> <span class="toc-text">事件驱动行为树数据编辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E6%9E%84%E5%BB%BA"><span class="toc-number">4.3.</span> <span class="toc-text">事件驱动行为树运行时数据构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%89%A7%E8%A1%8C%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.4.</span> <span class="toc-text">事件驱动行为树执行设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%9D%A1%E4%BB%B6%E5%88%A4%E5%AE%9A%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.5.</span> <span class="toc-text">事件驱动行为树条件判定设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E9%BB%91%E6%9D%BF"><span class="toc-number">4.6.</span> <span class="toc-text">事件驱动行为树黑板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%89%93%E6%96%AD"><span class="toc-number">4.7.</span> <span class="toc-text">事件驱动行为树打断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%89%93%E6%96%AD%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">4.7.1.</span> <span class="toc-text">事件驱动行为树打断单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Stops-NONE"><span class="toc-number">4.7.1.1.</span> <span class="toc-text">Stops.NONE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stops-SELF"><span class="toc-number">4.7.1.2.</span> <span class="toc-text">Stops.SELF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stops-LOWER-PRIORITY"><span class="toc-number">4.7.1.3.</span> <span class="toc-text">Stops.LOWER_PRIORITY</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stops-BOTH"><span class="toc-number">4.7.1.4.</span> <span class="toc-text">Stops.BOTH</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stops-LOWER-PRIORITY-IMMEDIATE-RESTART"><span class="toc-number">4.7.1.5.</span> <span class="toc-text">Stops.LOWER_PRIORITY_IMMEDIATE_RESTART</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stops-IMMEDIATE-RESTART"><span class="toc-number">4.7.2.</span> <span class="toc-text">Stops.IMMEDIATE_RESTART</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%9A%82%E5%81%9C"><span class="toc-number">4.8.</span> <span class="toc-text">事件驱动行为树暂停</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E8%B0%83%E8%AF%95"><span class="toc-number">4.9.</span> <span class="toc-text">事件驱动行为树调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E5%AE%9E%E6%88%98"><span class="toc-number">4.10.</span> <span class="toc-text">事件驱动行为树实战</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AA%E6%9D%A5%E8%AE%A1%E5%88%92"><span class="toc-number">4.11.</span> <span class="toc-text">未来计划</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AA%E4%BA%BA%E5%BF%83%E5%BE%97"><span class="toc-number">5.</span> <span class="toc-text">个人心得</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitHub"><span class="toc-number">6.</span> <span class="toc-text">GitHub</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">7.</span> <span class="toc-text">Reference</span></a></li></ol>
		
		</div>
		
		<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在学习了UIElement相关知识以后，实战实现一套基于事件驱动的行为树(用UIElement开发编辑器)作为目标，深入基于事件驱动的行为树设计和UIElement的深入使用，为未来实现引导节点编辑器等功能需求做准备。</p>
<h2 id="行为树"><a href="#行为树" class="headerlink" title="行为树"></a>行为树</h2><p><strong>行为树主要用于AI开发，将AI逻辑通过树状逻辑进行组装表达，可以方便的制作和调试AI。</strong></p>
<p><strong>常规的行为树中，每帧都要从根节点开始遍历行为树，而目的仅仅是为了得到最近激活的节点，这也是博主之前设计的基于Lua的简易行为树<a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/BehaviourTreeForLua">BehaviourTreeForLua</a>的设计方案。</strong></p>
<p>但此方案会导致每帧大量的逻辑浪费(比如已经运行到很深很远的节点处，第二帧又会从头跑一次前面相关的逻辑判定)，这也是实现一个基于事件驱动的行为树的原因所在。</p>
<p><strong>基于事件的行为树设计是，我们不再每帧都从根节点去遍历行为树，而是维护一个调度器负责保存已激活的节点，当正在执行的行为终止时，由其父节点决定接下来的行为。</strong></p>
<h2 id="行为树节点编辑器"><a href="#行为树节点编辑器" class="headerlink" title="行为树节点编辑器"></a>行为树节点编辑器</h2><p>结合前面学习到关于GraphView的相关知识，在实战前再回顾下几个GraphView相关的重要概念：</p>
<ol>
<li>GraphView – Unity官方推出的一套编写节点边的通用节点编辑器编写的UI组件</li>
<li>Node – GraphView里的节点类型</li>
<li>Port – GraphView里的端口连线</li>
</ol>
<h3 id="节点设计"><a href="#节点设计" class="headerlink" title="节点设计"></a>节点设计</h3><p>设计之初是面向节点编辑器需求，为后续支持行为树编辑器，剧情编辑器，新手引导编辑器细分做准备，<strong>目前是面向事件驱动行为树编辑器来编写的</strong>。</p>
<p>BaseNode.cs(节点基类，标识GUID，根节点以及节点大类型分类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseNode</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一ID</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一ID&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> GUID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;位置&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> Rect Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;节点描述&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Des = <span class="string">&quot;节点描述&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是根节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> EntryPoint</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型(子类重写自定义节点类型)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> NodeType NodeType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NodeType.Composition;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> NodeState NodeState</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NodeType.cs(节点大类型，用于分类分列表显示)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> NodeType</span><br><span class="line">&#123;</span><br><span class="line">    Composition,               <span class="comment">// 行为树组合节点</span></span><br><span class="line">    Decoration,                <span class="comment">// 行为树装饰节点</span></span><br><span class="line">    Condition,                 <span class="comment">// 行为树条件节点</span></span><br><span class="line">    Action,                    <span class="comment">// 行为树行为节点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseCompositionNode.cs(组合节点抽象基类)</p>
<p>BaseDecorationNode.cs(装饰节点抽象基类)</p>
<p>BaseConditionNode.cs(条件节点抽象基类)</p>
<p>BaseActionNode.cs(行为节点抽象基类)</p>
<h3 id="节点选择列表设计"><a href="#节点选择列表设计" class="headerlink" title="节点选择列表设计"></a>节点选择列表设计</h3><p>UIBTGraphEditorWindow.cs(行为树图窗口类，未来扩展不同类型节点编辑器参考此代码即可)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图窗口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    ******    </span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可用的节点类型列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;NodeType&gt; mAvailableNodeTypeList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可用节点类型Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;NodeType, NodeType&gt; mAvailableNodeTypeMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型和对应节点类型信息Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;NodeType, List&lt;Type&gt;&gt; mNodeTypeTypeMap;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitNodeDatas</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAvailableNodeTypeList = GetInitAvalibleNodeTypeList();</span><br><span class="line">        InitNodeTypeDatas();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取初始化可用节点类型列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="title">List</span>&lt;<span class="title">NodeType</span>&gt; <span class="title">GetInitAvalibleNodeTypeList</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> List&lt;NodeType&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            NodeType.Dialogue,</span><br><span class="line">            NodeType.Composition,</span><br><span class="line">            NodeType.Decoration,</span><br><span class="line">            NodeType.Condition,</span><br><span class="line">            NodeType.Action,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点类型数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitNodeTypeDatas</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitAvalibleNodeTypeMapData();</span><br><span class="line">        InitNodeTypeTypeListData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点类型Map数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitAvalibleNodeTypeMapData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAvailableNodeTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, NodeType&gt;();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> availableNodeType <span class="keyword">in</span> mAvailableNodeTypeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!mAvailableNodeTypeMap.ContainsKey(availableNodeType))</span><br><span class="line">            &#123;</span><br><span class="line">                mAvailableNodeTypeMap.Add(availableNodeType, availableNodeType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点类型类型信息列表数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitNodeTypeTypeListData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNodeTypeTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, List&lt;Type&gt;&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> availableNodeType <span class="keyword">in</span> mAvailableNodeTypeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mNodeTypeTypeMap.ContainsKey(availableNodeType))</span><br><span class="line">            &#123;</span><br><span class="line">                mNodeTypeTypeMap.Add(availableNodeType, <span class="keyword">new</span> List&lt;Type&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> allNodeTypes = CommonGraphConst.BaseNodeAssembly.GetTypes().Where(</span><br><span class="line">            nodeType =&gt; (CommonGraphConst.BaseNodeType.IsAssignableFrom(nodeType) &amp;&amp; !nodeType.IsAbstract &amp;&amp; nodeType != CommonGraphConst.BaseNodeType));</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> allNodeTypes)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> nodeInstance = Activator.CreateInstance(type) <span class="keyword">as</span> BaseNode;</span><br><span class="line">            <span class="keyword">if</span>(IsAvailableNodeType(nodeInstance.NodeType))</span><br><span class="line">            &#123;</span><br><span class="line">                List&lt;Type&gt; typeList;</span><br><span class="line">                <span class="keyword">if</span>(mNodeTypeTypeMap.TryGetValue(nodeInstance.NodeType, <span class="keyword">out</span> typeList))</span><br><span class="line">                &#123;</span><br><span class="line">                    typeList.Add(type);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建所有节点类型的UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateAllNodeTypeUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> availableNodeType <span class="keyword">in</span> mAvailableNodeTypeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> nodeFoldOut = <span class="keyword">new</span> FoldOut();</span><br><span class="line">            <span class="keyword">var</span> nodeTypeTitle = CommonGraphUtilities.GetNodeTypeTitle(availableNodeType);</span><br><span class="line">            nodeFoldOut.name = nodeTypeTitle;</span><br><span class="line">            nodeFoldOut.viewDataKey = CommonGraphUtilities.GetNodeTypeFoldOutViewDataKeyName(availableNodeType);</span><br><span class="line">            nodeFoldOut.text = nodeTypeTitle;</span><br><span class="line">            nodeFoldOut.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> typeList = GetTypeListByNodeType(availableNodeType);</span><br><span class="line">            <span class="keyword">var</span> nodeListView = <span class="keyword">new</span> ListView(typeList, <span class="number">20</span>, OnMakeNodeItem, (NodeItemUserData, index) =&gt;</span><br><span class="line">                                            &#123;</span><br><span class="line">                                                OnBindNodeItem(item, index, availableNodeType);</span><br><span class="line">                                            &#125;);</span><br><span class="line">            nodeFoldOut.Add(nodeListView);</span><br><span class="line">            <span class="comment">// 注册节点FoldOut值变化回调</span></span><br><span class="line">            nodeFoldOut.ReigsterValueChangedCallback(OnNodeFoldOutValueChange);</span><br><span class="line">            <span class="keyword">var</span> nodeVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(CommonGraphElementNames.NodeVerticalContainerName);</span><br><span class="line">            nodeVerticalContainer.Add(nodeFoldOut);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>节点列表通过以下流程定义和展示:</p>
<ol>
<li><strong>通过GetInitAvalibleNodeTypeList()方法定义节点窗口可用节点类型列表</strong></li>
<li><strong>结合反射InitNodeTypeTypeListData()初始化所有符合的节点类型信息列表</strong></li>
<li><strong>通过CreateAllNodeTypeUI()使用UIElement创建可选节点列表</strong></li>
</ol>
<h3 id="节点操作显示设计"><a href="#节点操作显示设计" class="headerlink" title="节点操作显示设计"></a>节点操作显示设计</h3><h4 id="GraphView设计"><a href="#GraphView设计" class="headerlink" title="GraphView设计"></a>GraphView设计</h4><p>BehaviourTreeGraphView.cs(通用节点编辑器GraphView(继承至GraphView)，不同的节点编辑器继承修改部分接口即可)</p>
<p>继承UIBTGraphEditorWindow修改获取新的GraphView接口GetNewGraphView()即可。</p>
<p>UIBTGraphEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通用节点编辑器窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">   ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点编辑器GraphView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateGraphView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ClearGraphView();</span><br><span class="line">        <span class="keyword">var</span> middleGraphViewContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.MiddleGraphViewContainerName);</span><br><span class="line">        mGraphView = GetNewGraphView();</span><br><span class="line">        mGraphView.StretchToParentSize();</span><br><span class="line">        middleGraphViewContainer.Add(mGraphView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建新的GraphView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> BehaviourTreeGraphView <span class="title">GetNewGraphView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BehaviourTreeGraphView(mAvailableNodeTypeList, <span class="keyword">this</span>.OnSelectedNodeChange);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="StyleSheet添加"><a href="#StyleSheet添加" class="headerlink" title="StyleSheet添加"></a>StyleSheet添加</h4><p>创建UIBTGraphEditorWindow.uss文件，编写相关USS</p>
<p>BehaviourTreeGraphView.cs定义StyleSheet路径和加载流程</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">   ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Style Sheet Asset路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="built_in">string</span> StyleSheetAssetPath</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="string">&quot;Assets/Scripts/Editor/UIToolkitStudy/UIBTGraphEditorWindow/DefaultGraphStyleSheet.uss&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BehaviourTreeGraphView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAvailableNodeTypeList = <span class="keyword">new</span> List&lt;NodeType&gt;() ;</span><br><span class="line">        mSelectedNodeChangeDelegate = <span class="literal">null</span>;</span><br><span class="line">        Init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;availableNodeTypeList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selectedNodeChangeCB&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BehaviourTreeGraphView</span>(<span class="params">List&lt;NodeType&gt; availableNodeTypeList, Action&lt;NodeView&gt; selectedNodeChangeCB = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAvailableNodeTypeList = availableNodeTypeList;</span><br><span class="line">        mSelectedNodeChangeDelegate += selectedNodeChangeCB;</span><br><span class="line">        Init();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        LoadStyleSheet();</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载Style Sheet</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">LoadStyleSheet</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> styleSheet = AssetDatabase.LoadAssetAtPath&lt;StyleSheet&gt;(StyleSheetAssetPath);</span><br><span class="line">        styleSheets.Add(styleSheet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UICommonGraphEditorWindow.uss</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GridBackground &#123;</span><br><span class="line">   --grid-background-color: #282828;</span><br><span class="line">   --line-color: rgba(193, 196, 192, 0.1);</span><br><span class="line">   --thick-line-color: rgba(193, 196, 192, 0.1);</span><br><span class="line">   --spacing: 10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="节点创建添加"><a href="#节点创建添加" class="headerlink" title="节点创建添加"></a>节点创建添加</h4><p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点默认Rect</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> Rect NodeDefaultRect = <span class="keyword">new</span> Rect(<span class="number">100</span>, <span class="number">200</span>, <span class="number">100</span>, <span class="number">150</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根节点类型(子类重写实现自定义不同根节点类型)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> Type RootNodeType = BTGraphConstEditor.RootNodeType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> GraphView朝向</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">virtual</span> Orientation GraphOrientation</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> GraphOrientation.Horizontal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    *******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        AddEntryPointNode();</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加根节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddEntryPointNode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        AddElement(GenerateEntryPointNode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成根节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> NodeView <span class="title">GenerateEntryPointNode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rootNode = CreateNodeByType(RootNodeType, BTGraphConstEditor.NodeDefaultPos);</span><br><span class="line">        <span class="keyword">return</span> rootNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定节点名的新节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isEntryNode&quot;&gt;</span>是否是根节点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;addNodeData&quot;&gt;</span>是否添加节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> NodeView <span class="title">CreateNode</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">bool</span> isEntryNode = <span class="literal">false</span>, <span class="built_in">bool</span> addNodeData = <span class="literal">true</span></span>) <span class="keyword">where</span> T : BaseNode, <span class="keyword">new</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> typeInfo = <span class="keyword">typeof</span>(T);</span><br><span class="line">        <span class="keyword">var</span> nodeView = CreateNodeByType(typeInfo, isEntryNode, addNodeData);</span><br><span class="line">        <span class="keyword">return</span> nodeView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定类型信息和节点名的新节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typeInfo&quot;&gt;</span>类型信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;position&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isEntryNode&quot;&gt;</span>是否是根节点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NodeView <span class="title">CreateNodeByType</span>(<span class="params">Type typeInfo, Vector2 position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> newNode = BTGraphUtilitiesEditor.CreateNodeInstance(typeInfo);</span><br><span class="line">        <span class="keyword">var</span> guid = Guid.NewGuid().ToString();</span><br><span class="line">        <span class="keyword">var</span> nodeRect = BTGraphConstEditor.NodeDefaultRect;</span><br><span class="line">        nodeRect.x = position.x;</span><br><span class="line">        nodeRect.y = position.y;</span><br><span class="line">        newNode.Init(guid, nodeRect);</span><br><span class="line">        <span class="keyword">var</span> nodeView = BTGraphUtilitiesEditor.CreateNodeViewInstance(typeInfo);</span><br><span class="line">        nodeView.Init(SourceGraphData, newNode, OnNodeSelected, <span class="literal">null</span>, GraphOrientation);</span><br><span class="line">        AddNodeData(newNode);</span><br><span class="line">        AddElement(nodeView);</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeRect);</span><br><span class="line">        <span class="keyword">return</span> nodeView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新NodeView的Rect信息(同时自动更新Node节点数据的Rect信息)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;position&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">UpdateNodeViewRect</span>(<span class="params">NodeView nodeView, Rect position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许更新空NodeView的位置数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nodeView.SetPosition(position);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加新节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">AddNodeData</span>(<span class="params">BaseNode node, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许添加空节点数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (enableUndoSystem)</span><br><span class="line">        &#123;</span><br><span class="line">            Undo.RecordObject(SourceGraphData, <span class="string">&quot;AddNodeData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> result = SourceGraphData.AddNode(node);</span><br><span class="line">        <span class="keyword">if</span> (result)</span><br><span class="line">        &#123;</span><br><span class="line">            OnAddNodeData(node);</span><br><span class="line">            EditorUtility.SetDirty(SourceGraphData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BTGraphUtilitiesEditor.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BTGraphUtilitiesEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树节点编辑器工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BTGraphUtilitiesEditor</span></span><br><span class="line">&#123;</span><br><span class="line">   ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定Node类型信息实例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typeInfo&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BaseNode <span class="title">CreateNodeInstance</span>(<span class="params">Type typeInfo</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(typeInfo == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不支持创建空类型信息的节点对象！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(typeInfo != CommonGraphConstEditor.BaseNodeType &amp;&amp; !typeInfo.IsSubclassOf(CommonGraphConstEditor.BaseNodeType))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许创建未继承BaseNode的类型:<span class="subst">&#123;typeInfo.Name&#125;</span>信息节点对象！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 硬编码类型构建避免反射</span></span><br><span class="line">        <span class="keyword">return</span> ScriptableObject.CreateInstance(typeInfo) <span class="keyword">as</span> BaseNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定Node类型信息的NodeView实例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typeInfo&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NodeView <span class="title">CreateNodeViewInstance</span>(<span class="params">Type typeInfo</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeInfo == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不支持创建空类型信息的节点View对象！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> nodeViewType = GetNodeViewType(typeInfo);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 硬编码类型构建避免反射</span></span><br><span class="line">        <span class="keyword">if</span> (nodeViewType != CommonGraphConstEditor.NodeViewType &amp;&amp; !nodeViewType.IsSubclassOf(CommonGraphConstEditor.NodeViewType))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许创建未继承BaseNode的类型:<span class="subst">&#123;nodeViewType.Name&#125;</span>信息节点View对象！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Activator.CreateInstance(nodeViewType) <span class="keyword">as</span> NodeView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BehaviourTreeGraphView.GenerateEntryPointNode()负责创建根节点。</p>
<p>BehaviourTreeGraphView.CreateNode<T>()和CreateNodeByType()负责创建新节点。</p>
<p>BTGraphUtilitiesEditor.CreateNodeInstance()和BTGraphUtilitiesEditor.CreateNodeViewInstance()负责构建节点对象和节点显示对象(TODO:添加非反射版节点实例对象创建实现)。</p>
<p>BehaviourTreeGraphView.UpdateNodeViewRect()负责更新显示节点数据和位置。</p>
<p><img src="/img/Unity/UIToolkit/AddRootNode.PNG" alt="AddRootNode"></p>
<p>Note:</p>
<ol>
<li><strong>GraphView.GetNodeByGuid()获取指定GUID的节点是根据Node.viewDataKey来标识的</strong></li>
</ol>
<h4 id="节点自定义UI添加"><a href="#节点自定义UI添加" class="headerlink" title="节点自定义UI添加"></a>节点自定义UI添加</h4><p>通过style.color根据不同节点类型设置不同节点颜色显示</p>
<p>通过创建插入竖向容器Element添加自定义UI显示</p>
<p>NodeState.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeState.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点状态</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> NodeState</span><br><span class="line">&#123;</span><br><span class="line">    Suspend = <span class="number">0</span>,        <span class="comment">// 挂起状态</span></span><br><span class="line">    Running,            <span class="comment">// 运行状态</span></span><br><span class="line">    Abort,              <span class="comment">// 被打断状态</span></span><br><span class="line">    Success,            <span class="comment">// 成功状态</span></span><br><span class="line">    Failed,             <span class="comment">// 失败状态</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点数据基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseNode</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一ID</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一ID&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> GUID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;位置&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> Rect Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;节点描述&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Des = <span class="string">&quot;节点描述&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是根节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> EntryPoint</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型(子类重写自定义节点类型)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> NodeType NodeType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NodeType.Composition;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> NodeState NodeState</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否进入过打断(辅助调试信息显示)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsEnteredAbort</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 无参构造</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseNode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">		******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;guid&quot;&gt;</span>唯一ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;position&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeState&quot;&gt;</span>节点状态<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"><span class="built_in">string</span> guid, Rect position, NodeState nodeState = NodeState.Suspend</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        GUID = guid;</span><br><span class="line">        Position = position;</span><br><span class="line">        NodeState = nodeState;</span><br><span class="line">        IsEnteredAbort = <span class="literal">false</span>;</span><br><span class="line">        name = GetType().Name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NodeView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点显示抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NodeView</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所属图数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BehaviourTreeGraphData OwnerGraphData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BaseNode NodeData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 入口Port连线数量类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Port.Capacity InPortCapacity</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Port.Capacity.Single;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 出口Port连线数量类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Port.Capacity OutPortCapacity</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Port.Capacity.Single;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点朝向</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Orientation mOrientation;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点选择委托</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Action&lt;NodeView&gt; mNodeSelectedDelegate;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有输入端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Port&gt; mAllInputPorts;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有输出端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Port&gt; mAllOutputPorts;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 无参构造</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NodeView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAllInputPorts = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">        mAllOutputPorts = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ownerGraphData&quot;&gt;</span>所属图数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeSelectedCB&quot;&gt;</span>节点选择委托<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeName&quot;&gt;</span>节点名(默认不传为BaseNode的类型名)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span>节点方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NodeView</span>(<span class="params">BehaviourTreeGraphData ownerGraphData, BaseNode nodeData, Action&lt;NodeView&gt; nodeSelectedCB = <span class="literal">null</span>, <span class="built_in">string</span> nodeName = <span class="literal">null</span>, Orientation orientation = Orientation.Horizontal</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Init(ownerGraphData, nodeData, nodeSelectedCB, nodeName, orientation);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据Node数据初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ownerGraphData&quot;&gt;</span>所属图数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeSelectedCB&quot;&gt;</span>节点选择委托<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeName&quot;&gt;</span>节点名(默认不传为BaseNode的类型名)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span>节点方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params">BehaviourTreeGraphData ownerGraphData, BaseNode node, Action&lt;NodeView&gt; nodeSelectedCB = <span class="literal">null</span>, <span class="built_in">string</span> nodeName = <span class="literal">null</span>, Orientation orientation = Orientation.Horizontal</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        OwnerGraphData = ownerGraphData;</span><br><span class="line">        name = node.GUID;</span><br><span class="line">        <span class="comment">// viewDataKey是GraphView.GetNodeByGUID的数据来源</span></span><br><span class="line">        viewDataKey = node.GUID;</span><br><span class="line">        NodeData = node;</span><br><span class="line">        mNodeSelectedDelegate += nodeSelectedCB;</span><br><span class="line">        mOrientation = orientation;</span><br><span class="line">        title = nodeName == <span class="literal">null</span> ? node.GetType().Name : nodeName;</span><br><span class="line">        titleContainer.style.backgroundColor = BTGraphUtilitiesEditor.GetBackgroundColorByNodeData(NodeData);</span><br><span class="line">        <span class="keyword">var</span> titleLabel = titleContainer.Q&lt;Label&gt;(<span class="string">&quot;title-label&quot;</span>);</span><br><span class="line">        titleLabel.style.color = Color.black;</span><br><span class="line">        titleLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        CreateNodeUI();</span><br><span class="line">        GenerateAllPort();</span><br><span class="line">        RefreshExpandedState();</span><br><span class="line">        RefreshPorts();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateNodeContainerUI();</span><br><span class="line">        CreateNodeGUIDUI();</span><br><span class="line">        CreateNodeStateUI();</span><br><span class="line">        CreateCustomUI();</span><br><span class="line">        CreateNodeDesUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeContainerUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeVerticalUIContainer = UIToolkitUtilities.CreateVerticalContainer(BTGraphElementNames.NodeUIVerticalContainerName,</span><br><span class="line">                                                                                 <span class="number">1</span>, <span class="string">&quot;unity-box&quot;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                                                                                 BTGraphConstEditor.NodeContainerBGColor);</span><br><span class="line">        <span class="keyword">var</span> nodeContentElement = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(<span class="string">&quot;contents&quot;</span>);</span><br><span class="line">        nodeContentElement.Insert(<span class="number">0</span>, nodeVerticalUIContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点GUID UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeGUIDUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeVerticalUIContainer = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(BTGraphElementNames.NodeUIVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> nodeGUIDHorizontalUIContainer = UIToolkitUtilities.CreateHorizontalContainer(BTGraphElementNames.NodeGUIDUIHorizontalContainerName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeGUIDDivider = UIToolkitUtilities.CreateHorizontalDivider(BTGraphConstEditor.DividerColor);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeGUIDDivider);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeGUIDHorizontalUIContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeGuidTitleLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        nodeGuidTitleLabel.text = <span class="string">&quot;GUID:&quot;</span>;</span><br><span class="line">        nodeGuidTitleLabel.style.height = BTGraphConstEditor.NodeOneLineHeight;</span><br><span class="line">        nodeGuidTitleLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        nodeGuidTitleLabel.style.unityTextAlign = TextAnchor.MiddleCenter;</span><br><span class="line">        nodeGuidTitleLabel.style.alignSelf = Align.Center;</span><br><span class="line">        nodeGUIDHorizontalUIContainer.Add(nodeGuidTitleLabel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeGuidLabel = <span class="keyword">new</span> TextField();</span><br><span class="line">        nodeGuidLabel.isReadOnly = <span class="literal">true</span>;</span><br><span class="line">        nodeGuidLabel.<span class="keyword">value</span> = NodeData.GUID;</span><br><span class="line">        nodeGuidLabel.style.height = BTGraphConstEditor.NodeOneLineHeight;</span><br><span class="line">        nodeGuidLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        nodeGuidLabel.style.unityTextAlign = TextAnchor.MiddleCenter;</span><br><span class="line">        nodeGuidLabel.style.alignSelf = Align.Center;</span><br><span class="line">        <span class="comment">//nodeGuidLabel.style.color = Color.white;</span></span><br><span class="line">        nodeGUIDHorizontalUIContainer.Add(nodeGuidLabel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点状态UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeStateUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeVerticalUIContainer = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(BTGraphElementNames.NodeUIVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> nodeStateHorizontalUIContainer = UIToolkitUtilities.CreateHorizontalContainer(BTGraphElementNames.NodeStateUIHorizontalContainerName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeStateDivider = UIToolkitUtilities.CreateHorizontalDivider(BTGraphConstEditor.DividerColor);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeStateDivider);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeStateHorizontalUIContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeStateTitleLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        nodeStateTitleLabel.style.width = <span class="number">40f</span>;</span><br><span class="line">        nodeStateTitleLabel.style.height = BTGraphConstEditor.NodeOneLineHeight;</span><br><span class="line">        nodeStateTitleLabel.text = <span class="string">&quot;状态:&quot;</span>;</span><br><span class="line">        nodeStateTitleLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        nodeStateTitleLabel.style.color = Color.black;</span><br><span class="line">        nodeStateTitleLabel.style.unityTextAlign = TextAnchor.MiddleCenter;</span><br><span class="line">        nodeStateTitleLabel.style.alignSelf = Align.Center;</span><br><span class="line">        nodeStateHorizontalUIContainer.Add(nodeStateTitleLabel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeStateLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        nodeStateLabel.name = BTGraphElementNames.NodeStateLabelName;</span><br><span class="line">        nodeStateLabel.style.width = <span class="number">40f</span>;</span><br><span class="line">        nodeStateLabel.style.unityTextAlign = TextAnchor.MiddleCenter;</span><br><span class="line">        nodeStateLabel.style.alignSelf = Align.Center;</span><br><span class="line">        nodeStateLabel.style.height = BTGraphConstEditor.NodeOneLineHeight;</span><br><span class="line">        nodeStateLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        nodeStateLabel.style.color = Color.black;</span><br><span class="line">        nodeStateLabel.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        nodeStateHorizontalUIContainer.Add(nodeStateLabel);</span><br><span class="line">        UpdateNodeStateBackgroundColor();</span><br><span class="line">        UpdateNodeStateLabel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点自定义UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateCustomUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新节点状态背景颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateNodeStateBackgroundColor</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeStateHorizontalUIContainer = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(BTGraphElementNames.NodeStateUIHorizontalContainerName);</span><br><span class="line">        <span class="keyword">if</span>(nodeStateHorizontalUIContainer != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            nodeStateHorizontalUIContainer.style.backgroundColor = BTGraphUtilitiesEditor.GetColorByNodeState(NodeData.NodeState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新节点状态Label</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateNodeStateLabel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeStateLabel = <span class="keyword">this</span>.Q&lt;Label&gt;(BTGraphElementNames.NodeStateLabelName);</span><br><span class="line">        <span class="keyword">if</span> (nodeStateLabel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> stateDes = NodeData.NodeState.ToString();</span><br><span class="line">            <span class="keyword">if</span>(NodeData.IsEnteredAbort)</span><br><span class="line">            &#123;</span><br><span class="line">                stateDes = <span class="string">$&quot;<span class="subst">&#123;stateDes&#125;</span>(打断)&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nodeStateLabel.text = stateDes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点描述UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeDesUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeVerticalUIContainer = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(BTGraphElementNames.NodeUIVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> nodeDesHorizontalUIContainer = UIToolkitUtilities.CreateHorizontalContainer(BTGraphElementNames.NodeDesUIHorizontalContainerName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeDesDivider = UIToolkitUtilities.CreateHorizontalDivider(BTGraphConstEditor.DividerColor);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeDesDivider);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeDesHorizontalUIContainer);</span><br><span class="line"></span><br><span class="line">        UIToolkitUtilities.CreateBindSOTextField(nodeDesHorizontalUIContainer, NodeData,</span><br><span class="line">                                                 BTGraphConstEditor.NodeDesPropertyName, <span class="number">1</span>,</span><br><span class="line">                                                 BTGraphConstEditor.NodeOneLineHeight,</span><br><span class="line">                                                 BTGraphConstEditor.NormalLabelFontSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点自定义UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateCustomUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BTGraphUtilitiesEditor.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BTGraphUtilitiesEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树节点编辑器工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BTGraphUtilitiesEditor</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型和颜色背景Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;NodeType, Color&gt; NodeTypeBackgroundColorMap = <span class="keyword">new</span> Dictionary&lt;NodeType, Color&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;NodeType.Composition, Color.blue&#125;,</span><br><span class="line">        &#123;NodeType.Decoration, Color.cyan&#125;,</span><br><span class="line">        &#123;NodeType.Condition, Color.yellow&#125;,</span><br><span class="line">        &#123;NodeType.Action, Color.red&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点状态和颜色背景Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;NodeState, Color&gt; NodeStateColorMap = <span class="keyword">new</span> Dictionary&lt;NodeState, Color&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;NodeState.Suspend, Color.grey&#125;,</span><br><span class="line">        &#123;NodeState.Running, Color.yellow&#125;,</span><br><span class="line">        &#123;NodeState.Abort, Color.magenta&#125;,</span><br><span class="line">        &#123;NodeState.Success, Color.green&#125;,</span><br><span class="line">        &#123;NodeState.Failed, Color.red&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定节点类型的背景颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Color <span class="title">GetBackgroundColorByNodeType</span>(<span class="params">NodeType nodeType</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Color nodeTypeBackgroundColor;</span><br><span class="line">        <span class="keyword">if</span> (NodeTypeBackgroundColorMap.TryGetValue(nodeType, <span class="keyword">out</span> nodeTypeBackgroundColor))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> nodeTypeBackgroundColor;</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;未配置节点类型:<span class="subst">&#123;nodeType&#125;</span>的背景颜色！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Color.grey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定节点类型的背景颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeState&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Color <span class="title">GetColorByNodeState</span>(<span class="params">NodeState nodeState</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Color nodeStateColor;</span><br><span class="line">        <span class="keyword">if</span> (NodeStateColorMap.TryGetValue(nodeState, <span class="keyword">out</span> nodeStateColor))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> nodeStateColor;</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;未配置节点状态:<span class="subst">&#123;nodeState&#125;</span>的颜色！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Color.grey;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UIToolkitUtilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIToolkitUtilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIToolkit工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">UIToolkitUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建一个指定名字指定相关设置的横向容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;containerName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flexGrow&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;classList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleLeft&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleRight&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleTop&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleBottom&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleColor&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateHorizontalContainer</span>(<span class="params"><span class="built_in">string</span> containerName, <span class="built_in">float</span> flexGrow = <span class="number">1f</span>, <span class="built_in">string</span> classList = <span class="literal">null</span>, <span class="built_in">float</span> styleLeft = <span class="number">0</span>, <span class="built_in">float</span> styleRight = <span class="number">0</span>, <span class="built_in">float</span> styleTop = <span class="number">0</span>, <span class="built_in">float</span> styleBottom = <span class="number">0</span>, StyleColor styleColor = <span class="literal">default</span>(StyleColor</span>))</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeHorizontalUIContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        nodeHorizontalUIContainer.name = containerName;</span><br><span class="line">        nodeHorizontalUIContainer.style.left = styleLeft;</span><br><span class="line">        nodeHorizontalUIContainer.style.right = styleRight;</span><br><span class="line">        nodeHorizontalUIContainer.style.flexGrow = flexGrow;</span><br><span class="line">        nodeHorizontalUIContainer.style.top = styleTop;</span><br><span class="line">        nodeHorizontalUIContainer.style.bottom = styleBottom;</span><br><span class="line">        nodeHorizontalUIContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        nodeHorizontalUIContainer.style.backgroundColor = styleColor;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">string</span>.IsNullOrEmpty(classList))</span><br><span class="line">        &#123;</span><br><span class="line">            nodeHorizontalUIContainer.AddToClassList(classList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nodeHorizontalUIContainer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建一个指定名字指定相关设置的竖向容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;containerName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flexGrow&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;classList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleLeft&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleRight&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleTop&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleBottom&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleColor&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateVerticalContainer</span>(<span class="params"><span class="built_in">string</span> containerName, <span class="built_in">float</span> flexGrow = <span class="number">1f</span>, <span class="built_in">string</span> classList = <span class="literal">null</span>, <span class="built_in">float</span> styleLeft = <span class="number">0</span>, <span class="built_in">float</span> styleRight = <span class="number">0</span>, <span class="built_in">float</span> styleTop = <span class="number">0</span>, <span class="built_in">float</span> styleBottom = <span class="number">0</span>, StyleColor styleColor = <span class="literal">default</span>(StyleColor</span>))</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeHorizontalUIContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        nodeHorizontalUIContainer.name = containerName;</span><br><span class="line">        nodeHorizontalUIContainer.style.left = styleLeft;</span><br><span class="line">        nodeHorizontalUIContainer.style.right = styleRight;</span><br><span class="line">        nodeHorizontalUIContainer.style.flexGrow = flexGrow;</span><br><span class="line">        nodeHorizontalUIContainer.style.top = styleTop;</span><br><span class="line">        nodeHorizontalUIContainer.style.bottom = styleBottom;</span><br><span class="line">        nodeHorizontalUIContainer.style.flexDirection = FlexDirection.Column;</span><br><span class="line">        nodeHorizontalUIContainer.style.backgroundColor = styleColor;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(classList))</span><br><span class="line">        &#123;</span><br><span class="line">            nodeHorizontalUIContainer.AddToClassList(classList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nodeHorizontalUIContainer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建一个横向分割线</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;color&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateHorizontalDivider</span>(<span class="params">Color color, <span class="built_in">float</span> height = <span class="number">1f</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> horizontalDivider = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        horizontalDivider.style.height = height;</span><br><span class="line">        horizontalDivider.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        horizontalDivider.style.backgroundColor = color;</span><br><span class="line">        <span class="keyword">return</span> horizontalDivider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建一个竖向分割线</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;color&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateVerticalDivider</span>(<span class="params">Color color</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> horizontalDivider = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        horizontalDivider.style.width = <span class="number">1</span>;</span><br><span class="line">        horizontalDivider.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        horizontalDivider.style.backgroundColor = color;</span><br><span class="line">        <span class="keyword">return</span> horizontalDivider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定容器创建指定对象的可视化Inspector</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scriptableObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;propertyBindDataMap&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateBindSOInspector</span>(<span class="params">ScriptableObject scriptableObject, Dictionary&lt;<span class="built_in">string</span>, PropertyBindData&gt; propertyBindDataMap = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(scriptableObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空ScriptableObject创建可视化Inspector！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> container = CreateVerticalContainer(<span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(scriptableObject);</span><br><span class="line">        <span class="keyword">var</span> propertyIterator = serializedObject.GetIterator();</span><br><span class="line">        propertyIterator.NextVisible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">while</span>(propertyIterator.NextVisible(<span class="literal">false</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> propertyField = <span class="keyword">new</span> PropertyField();</span><br><span class="line">            <span class="keyword">var</span> propertyName = propertyIterator.name;</span><br><span class="line">            <span class="keyword">var</span> property = serializedObject.FindProperty(propertyName);</span><br><span class="line">            propertyField.name = propertyName;</span><br><span class="line">            propertyField.BindProperty(property);</span><br><span class="line">            container.Add(propertyField);</span><br><span class="line">            <span class="keyword">if</span>(propertyBindDataMap != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> propertyBindData = <span class="keyword">new</span> PropertyBindData(serializedObject, property, propertyField);</span><br><span class="line">                propertyBindDataMap.Add(propertyName, propertyBindData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定容器创建指定对象指定属性名的绑定PropertyField</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;container&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scriptableObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;propertyName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flexGrow&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;height&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PropertyBindData <span class="title">CreateBindSOPropertyField</span>(<span class="params">VisualElement container, ScriptableObject scriptableObject, <span class="built_in">string</span> propertyName, <span class="built_in">float</span> flexGrow = <span class="number">0</span>, <span class="built_in">float</span> height = <span class="number">25f</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (container == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空容器创建绑定PropertyField！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (scriptableObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空ScriptableObject创建绑定PropertyField！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(scriptableObject);</span><br><span class="line">        <span class="keyword">var</span> property = serializedObject.FindProperty(propertyName);</span><br><span class="line">        <span class="keyword">if</span>(property == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;ScriptableObject:<span class="subst">&#123;scriptableObject.name&#125;</span>没找到属性名:<span class="subst">&#123;propertyName&#125;</span>的属性，创建绑定PropertyField失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> propertyField = <span class="keyword">new</span> PropertyField();</span><br><span class="line">        propertyField.name = propertyName;</span><br><span class="line">        propertyField.BindProperty(property);</span><br><span class="line">        propertyField.style.height = height;</span><br><span class="line">        propertyField.style.flexGrow = flexGrow;</span><br><span class="line">        container.Add(propertyField);</span><br><span class="line">        <span class="keyword">var</span> propertyBindData = <span class="keyword">new</span> PropertyBindData(serializedObject, property, propertyField);</span><br><span class="line">        <span class="keyword">return</span> propertyBindData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定容器创建指定对象指定属性名的绑定TextField</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;container&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scriptableObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;propertyName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flexGrow&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;height&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fontSize&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;textAnchor&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PropertyBindData <span class="title">CreateBindSOTextField</span>(<span class="params">VisualElement container, ScriptableObject scriptableObject, <span class="built_in">string</span> propertyName, <span class="built_in">float</span> flexGrow = <span class="number">0</span>, <span class="built_in">float</span> height = <span class="number">25f</span>, <span class="built_in">float</span> fontSize = <span class="number">15f</span>, TextAnchor textAnchor = TextAnchor.MiddleCenter</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (container == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空容器创建绑定TextField！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (scriptableObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空ScriptableObject创建绑定TextField！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(scriptableObject);</span><br><span class="line">        <span class="keyword">var</span> property = serializedObject.FindProperty(propertyName);</span><br><span class="line">        <span class="keyword">if</span> (property == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;ScriptableObject:<span class="subst">&#123;scriptableObject.name&#125;</span>没找到属性名:<span class="subst">&#123;propertyName&#125;</span>的属性，创建绑定TextField失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> textField = <span class="keyword">new</span> TextField();</span><br><span class="line">        textField.name = propertyName;</span><br><span class="line">        textField.BindProperty(property);</span><br><span class="line">        textField.style.height = height;</span><br><span class="line">        textField.style.fontSize = fontSize;</span><br><span class="line">        textField.style.flexGrow = flexGrow;</span><br><span class="line">        textField.style.unityTextAlign = textAnchor;</span><br><span class="line">        container.Add(textField);</span><br><span class="line">        <span class="keyword">var</span> propertyBindData = <span class="keyword">new</span> PropertyBindData(serializedObject, property, textField);</span><br><span class="line">        <span class="keyword">return</span> propertyBindData;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/CustomNodeViewUI.PNG" alt="CustomNodeViewUI"></p>
<p>Note:</p>
<ol>
<li><strong>子类重写CreateCustomUI()自定义节点UI显示</strong></li>
</ol>
<h4 id="节点Port创建添加"><a href="#节点Port创建添加" class="headerlink" title="节点Port创建添加"></a>节点Port创建添加</h4><p>NodeView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点显示抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NodeView</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所属图数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BehaviourTreeGraphData OwnerGraphData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BaseNode NodeData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 入口Port连线数量类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Port.Capacity InPortCapacity</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Port.Capacity.Single;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 出口Port连线数量类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Port.Capacity OutPortCapacity</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Port.Capacity.Single;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点朝向</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Orientation mOrientation;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点选择委托</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Action&lt;NodeView&gt; mNodeSelectedDelegate;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有输入端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Port&gt; mAllInputPorts;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有输出端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Port&gt; mAllOutputPorts;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 无参构造</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NodeView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">		mAllInputPorts = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">        mAllOutputPorts = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ownerGraphData&quot;&gt;</span>所属图数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeSelectedCB&quot;&gt;</span>节点选择委托<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeName&quot;&gt;</span>节点名(默认不传为BaseNode的类型名)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span>节点方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NodeView</span>(<span class="params">BehaviourTreeGraphData ownerGraphData, BaseNode nodeData, Action&lt;NodeView&gt; nodeSelectedCB = <span class="literal">null</span>, <span class="built_in">string</span> nodeName = <span class="literal">null</span>, Orientation orientation = Orientation.Horizontal</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Init(ownerGraphData, nodeData, nodeSelectedCB, nodeName, orientation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据Node数据初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ownerGraphData&quot;&gt;</span>所属图数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeSelectedCB&quot;&gt;</span>节点选择委托<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeName&quot;&gt;</span>节点名(默认不传为BaseNode的类型名)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span>节点方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params">BehaviourTreeGraphData ownerGraphData, BaseNode node, Action&lt;NodeView&gt; nodeSelectedCB = <span class="literal">null</span>, <span class="built_in">string</span> nodeName = <span class="literal">null</span>, Orientation orientation = Orientation.Horizontal</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        OwnerGraphData = ownerGraphData;</span><br><span class="line">        name = node.GUID;</span><br><span class="line">        <span class="comment">// viewDataKey是GraphView.GetNodeByGUID的数据来源</span></span><br><span class="line">        viewDataKey = node.GUID;</span><br><span class="line">        NodeData = node;</span><br><span class="line">        mNodeSelectedDelegate += nodeSelectedCB;</span><br><span class="line">        mOrientation = orientation;</span><br><span class="line">        title = nodeName == <span class="literal">null</span> ? node.GetType().Name : nodeName;</span><br><span class="line">        titleContainer.style.backgroundColor = BTGraphUtilitiesEditor.GetBackgroundColorByNodeData(NodeData);</span><br><span class="line">        <span class="keyword">var</span> titleLabel = titleContainer.Q&lt;Label&gt;(<span class="string">&quot;title-label&quot;</span>);</span><br><span class="line">        titleLabel.style.color = Color.black;</span><br><span class="line">        titleLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        CreateNodeUI();</span><br><span class="line">        GenerateAllPort();</span><br><span class="line">        RefreshExpandedState();</span><br><span class="line">        RefreshPorts();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义输入Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Port <span class="title">InstantiateCustomInputPort</span>(<span class="params"><span class="built_in">string</span> portName, System.Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> port = InstantiateCustomPort(portName, Direction.Input, InPortCapacity, type);</span><br><span class="line">        inputContainer.Add(port);</span><br><span class="line">        mAllInputPorts.Add(port);</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义输出Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Port <span class="title">InstantiateCustomOutputPort</span>(<span class="params"><span class="built_in">string</span> portName, System.Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> port = InstantiateCustomPort(portName, Direction.Output, OutPortCapacity, type);</span><br><span class="line">        outputContainer.Add(port);</span><br><span class="line">        mAllOutputPorts.Add(port);</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取所有Input端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Port&gt; <span class="title">GetAllInputPorts</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mAllInputPorts;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取所有Output端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Port&gt; <span class="title">GetAllOutputPorts</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mAllOutputPorts;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不含添加到容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;direction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;capacity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> Port <span class="title">InstantiateCustomPort</span>(<span class="params"><span class="built_in">string</span> portName, Direction direction, Port.Capacity capacity, System.Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> port = InstantiatePort(mOrientation, direction, capacity, type);</span><br><span class="line">        port.name = portName;</span><br><span class="line">        port.portName = portName;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实例化Port(自定义Port创建接口用于支持创建自定义EdgeView)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;direction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;capacity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Port <span class="title">InstantiatePort</span>(<span class="params">Orientation orientation, Direction direction, Port.Capacity capacity, Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Port.Create&lt;EdgeView&gt;(orientation, direction, capacity, type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建所有Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">GenerateAllPort</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        GenerateAllInputPort();</span><br><span class="line">        GenerateAllOutputPort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成节点所有Input Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GenerateAllInputPort</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InstantiateCustomInputPort(BTGraphConstEditor.DefaultInputPortName, BTGraphConstEditor.FloatType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成节点所有Output Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GenerateAllOutputPort</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InstantiateCustomOutputPort(BTGraphConstEditor.DefaultOutputPortName, BTGraphConstEditor.FloatType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseParentNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseParentNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 父节点基类抽象(所有有子节点的类型都继承这个)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseParentNode</span> : <span class="title">BaseNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子节点数量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ChildNodeCount</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mChildNodeList != <span class="literal">null</span> ? mChildNodeList.Count : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子节点列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseNode&gt; mChildNodeList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置子节点列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;childNodeList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetChildNodeList</span>(<span class="params">List&lt;BaseNode&gt; childNodeList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mChildNodeList = childNodeList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseCompositionNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseCompositionNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树组合节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseCompositionNode</span> : <span class="title">BaseParentNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> NodeType NodeType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NodeType.Composition;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SequnceNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SequenceNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树顺序节点(多个节点按顺序执行直到遇到返回失败的节点)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SequenceNode</span> : <span class="title">BaseCompositionNode</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面代码可以看到节点Port创建流程如下：</p>
<ol>
<li><strong>NodeView.GenerateAllPort()，NodeView.GenerateAllInputPort()和NodeView.GenerateAllOutputPort()负责节点Port的初始化创建流程</strong></li>
<li><strong>NodeView.InstantiateCustomInputPort()和NodeView.InstantiateCustomOutputPort()方法分别负责创建输入和输出节点Port</strong></li>
<li><strong>NodeView.inputContainer和NodeView.outputContainer分别对应输入和输出节点容器通过*Container.Add(port)方法给对应节点容器添加创建节点</strong></li>
<li><strong>调用RefreshExpandedState()和RefreshPorts()触发节点输出节点排版刷新显示</strong></li>
</ol>
<p><img src="/img/Unity/UIToolkit/PortConnectPreview.PNG" alt="PortConnectPreview"></p>
<p>Note:</p>
<ol>
<li><strong>InPortCapacity或OutPortCapacity实现自定义节点的输入输出Port连线数量定义</strong></li>
<li><strong>GenerateAllInputPort()或GenerateAllOutputPort()实现自定义输入输出节点Port创建</strong></li>
</ol>
<h4 id="节点Port连线功能添加"><a href="#节点Port连线功能添加" class="headerlink" title="节点Port连线功能添加"></a>节点Port连线功能添加</h4><p><strong>节点的连线规则是通过GraphView:GetCompatiblePorts()接口返回决定的</strong></p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Port可连接节点类型Map<span class="doctag">&lt;节点类型, &lt;可连接节点类型, 可连接节点类型&gt;</span>&gt;</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;NodeType, Dictionary&lt;NodeType, NodeType&gt;&gt; mPortAvailableConnectNodeTypeMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Port不可连接节点类型信息Map<span class="doctag">&lt;节点类型, &lt;不可连接节点类型信息, 不可连接节点类型信息&gt;</span>&gt;</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;NodeType, Dictionary&lt;Type, Type&gt;&gt; mPortUnavailableConnectTypeMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可连接的Port列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Port&gt; mCompatiblePortList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        </span><br><span class="line">        InitPortConnectRuleData();</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Port连接规则数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitPortConnectRuleData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCompatiblePortList = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">        InitPortAvalibleConnectNodeTypeData();</span><br><span class="line">        InitPortUnavalibleConnectTypeData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Port连接规则数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitPortConnectRuleData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCompatiblePortList = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">        InitPortAvalibleConnectNodeTypeData();</span><br><span class="line">        InitPortUnavalibleConnectTypeData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Port可连接节点类型数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitPortAvalibleConnectNodeTypeData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPortAvailableConnectNodeTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, Dictionary&lt;NodeType, NodeType&gt;&gt;();</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Composition, NodeType.Composition);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Composition, NodeType.Decoration);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Composition, NodeType.Condition);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Composition, NodeType.Action);</span><br><span class="line"></span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Decoration, NodeType.Composition);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Decoration, NodeType.Decoration);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Decoration, NodeType.Condition);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Decoration, NodeType.Action);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加Port指定节点类型可连接节点类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sourceNodeType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;targetNodeType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">AddPortAvalibleConnectNodeType</span>(<span class="params">NodeType sourceNodeType, NodeType targetNodeType</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dictionary&lt;NodeType, NodeType&gt; portAvalibleConnectNodeTypeMap;</span><br><span class="line">        <span class="keyword">if</span> (!mPortAvailableConnectNodeTypeMap.TryGetValue(sourceNodeType, <span class="keyword">out</span> portAvalibleConnectNodeTypeMap))</span><br><span class="line">        &#123;</span><br><span class="line">            portAvalibleConnectNodeTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, NodeType&gt;();</span><br><span class="line">            mPortAvailableConnectNodeTypeMap.Add(sourceNodeType, portAvalibleConnectNodeTypeMap);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (portAvalibleConnectNodeTypeMap.ContainsKey(targetNodeType))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;重复添加节点类型:<span class="subst">&#123;sourceNodeType&#125;</span>的Port可连接节点类型:<span class="subst">&#123;targetNodeType&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        portAvalibleConnectNodeTypeMap.Add(targetNodeType, targetNodeType);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Port不可连接类型信息数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitPortUnavalibleConnectTypeData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPortUnavailableConnectTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, Dictionary&lt;Type, Type&gt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取可连接的Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;startPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeAdapter&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> List&lt;Port&gt; <span class="title">GetCompatiblePorts</span>(<span class="params">Port startPort, NodeAdapter nodeAdapter</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCompatiblePortList.Clear();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> port <span class="keyword">in</span> ports)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 不允许连接自身Port || 不允许连接自身节点 || 不允许连接相同In or Out Port</span></span><br><span class="line">            <span class="keyword">if</span> (startPort == port || startPort.node == port.node || startPort.direction == port.direction)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> startNode = startPort.node <span class="keyword">as</span> NodeView;</span><br><span class="line">            <span class="keyword">var</span> portNode = port.node <span class="keyword">as</span> NodeView;</span><br><span class="line">            <span class="keyword">if</span> (!IsPortAvalibleConnectNodeType(startNode.NodeData.NodeType, portNode.NodeData.NodeType))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> portNodeType = port.node.GetType();</span><br><span class="line">            <span class="keyword">if</span> (IsPortUnavalibleConnectType(startNode.NodeData.NodeType, portNodeType))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 不允许连接根节点的InputPort</span></span><br><span class="line">            <span class="keyword">if</span> (portNode.NodeData.EntryPoint &amp;&amp; port.direction == Direction.Input)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根节点的InputPort不允许连接任何OutputPort</span></span><br><span class="line">            <span class="keyword">if</span> (startNode.NodeData.EntryPoint &amp;&amp; port.direction == Direction.Output)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mCompatiblePortList.Add(port);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mCompatiblePortList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>InitPortAvalibleConnectNodeTypeData()实现自定义节点类型和哪些节点类型可连</strong></p>
<p><strong>IsPortUnavalibleConnectType()实现自定义节点类型哪些节点类型信息不可连</strong></p>
<p><img src="/img/Unity/UIToolkit/AvalibleConnectPortPreview.PNG" alt="AvalibleConnectPortPreview"></p>
<p>通过GraphView:GetCompatiblePorts()返回所有可连接Port，我们可以看到当我们点击需要连接Port后，所有可连接Port会处于高亮状态(表示可连接)。</p>
<h4 id="节点Port连线还原"><a href="#节点Port连线还原" class="headerlink" title="节点Port连线还原"></a>节点Port连线还原</h4><p>前面我们实现了自定义Port连接操作，在端口连接后，我们重新加载图数据后如何还原Port连线了？</p>
<p>Port的连接是通过Edge(边)来实现的。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定图数据的所有边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;addEdgeData&quot;&gt;</span>是否添加边数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span>是否开启Undo系统<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateGraphAllEdges</span>(<span class="params">BehaviourTreeGraphData graphData, <span class="built_in">bool</span> addEdgeData = <span class="literal">true</span>, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (graphData == <span class="literal">null</span> || graphData.AllEdgeDataList == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> edgeData <span class="keyword">in</span> graphData.AllEdgeDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateEdgeByEdgeData(graphData, edgeData, addEdgeData, enableUndoSystem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定节点View获取或创建指定名字和类型的输入端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portTypeFullName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Port <span class="title">GetOrCreateInputPort</span>(<span class="params">NodeView nodeView, <span class="built_in">string</span> portName, <span class="built_in">string</span> portTypeFullName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空节点View创建输入端口，创建端口名:<span class="subst">&#123;portName&#125;</span>类型:<span class="subst">&#123;portTypeFullName&#125;</span>的输入节点端口失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> port = nodeView.inputContainer.Q&lt;Port&gt;(portName);</span><br><span class="line">        <span class="keyword">if</span> (port == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> portType = TypeCache.GetType(portTypeFullName);</span><br><span class="line">            <span class="keyword">if</span> (portType == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;找不到类型全名:<span class="subst">&#123;portTypeFullName&#125;</span>的类型信息，创建端口名:<span class="subst">&#123;portName&#125;</span>的输入节点端口失败！&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            port = nodeView.InstantiateCustomInputPort(portName, portType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定节点View获取或创建指定名字和类型的输出端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portTypeFullName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Port <span class="title">GetOrCreateOutputPort</span>(<span class="params">NodeView nodeView, <span class="built_in">string</span> portName, <span class="built_in">string</span> portTypeFullName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空节点View创建输出端口，创建端口名:<span class="subst">&#123;portName&#125;</span>类型:<span class="subst">&#123;portTypeFullName&#125;</span>的输出节点端口失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> port = nodeView.outputContainer.Q&lt;Port&gt;(portName);</span><br><span class="line">        <span class="keyword">if</span> (port == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> portType = TypeCache.GetType(portTypeFullName);</span><br><span class="line">            <span class="keyword">if</span> (portType == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;找不到类型全名:<span class="subst">&#123;portTypeFullName&#125;</span>的类型信息，创建端口名:<span class="subst">&#123;portName&#125;</span>的输出节点端口失败！&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            port = nodeView.InstantiateCustomOutputPort(portName, portType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加显示边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;inputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Edge <span class="title">AddEdgeView</span>(<span class="params">EdgeData edgeData, Port inputPort, Port outputPort</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (edgeData == <span class="literal">null</span> || inputPort == <span class="literal">null</span> || outputPort == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许创建空边数据或空输入端口或空输出端口的显示边，创建显示边失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> edgeView = CreateEdgeView(edgeData, inputPort, outputPort);</span><br><span class="line">        outputPort.Connect(edgeView);</span><br><span class="line">        inputPort.Connect(edgeView);</span><br><span class="line">        Add(edgeView);</span><br><span class="line">        OnEdgeViewUpdate(edgeView);</span><br><span class="line">        <span class="keyword">return</span> edgeView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建显示边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;inputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> EdgeView <span class="title">CreateEdgeView</span>(<span class="params">EdgeData edgeData, Port inputPort, Port outputPort</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> edgeView = <span class="keyword">new</span> EdgeView()</span><br><span class="line">        &#123;</span><br><span class="line">            input = inputPort,</span><br><span class="line">            output = outputPort,</span><br><span class="line">        &#125;;</span><br><span class="line">        edgeView.Init(SourceGraphData, edgeData);</span><br><span class="line">        edgeView.UpdateEdgeControlStateColor();</span><br><span class="line">        <span class="keyword">return</span> edgeView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建显示边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;inputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> EdgeView <span class="title">CreateEdgeView</span>(<span class="params">EdgeData edgeData, Port inputPort, Port outputPort</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> edgeView = <span class="keyword">new</span> EdgeView()</span><br><span class="line">        &#123;</span><br><span class="line">            input = inputPort,</span><br><span class="line">            output = outputPort,</span><br><span class="line">        &#125;;</span><br><span class="line">        edgeView.Init(SourceGraphData, edgeData);</span><br><span class="line">        edgeView.UpdateEdgeControlStateColor();</span><br><span class="line">        <span class="keyword">return</span> edgeView;</span><br><span class="line">    &#125;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NodeView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点显示抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NodeView</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义输入Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Port <span class="title">InstantiateCustomInputPort</span>(<span class="params"><span class="built_in">string</span> portName, System.Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> port = InstantiateCustomPort(portName, Direction.Input, InPortCapacity, type);</span><br><span class="line">        inputContainer.Add(port);</span><br><span class="line">        mAllInputPorts.Add(port);</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义输出Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Port <span class="title">InstantiateCustomOutputPort</span>(<span class="params"><span class="built_in">string</span> portName, System.Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> port = InstantiateCustomPort(portName, Direction.Output, OutPortCapacity, type);</span><br><span class="line">        outputContainer.Add(port);</span><br><span class="line">        mAllOutputPorts.Add(port);</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EdgeView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> EdgeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 显示边基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EdgeView</span> : <span class="title">Edge</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新显示边线状态颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateEdgeControlStateColor</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> edgeInputNode = OwnerGraphData.GetNodeByGUID(EdgeData.InputNodeGUID);</span><br><span class="line">        <span class="keyword">var</span> edgeInputColor = BTGraphUtilitiesEditor.GetEdgeColorByNodeState(edgeInputNode.NodeState);</span><br><span class="line">        <span class="keyword">var</span> edgeOutputColor = BTGraphUtilitiesEditor.GetEdgeColorByNodeState(edgeInputNode.NodeState);</span><br><span class="line">        edgeControl.inputColor = edgeInputColor;</span><br><span class="line">        edgeControl.outputColor = edgeOutputColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>在创建完所有NodeView(BehaviourTreeGraphView.CreateGraphAllNodes())后，我们根据BehaviourTreeGraphData.AllEdgeDataList的所有边数据，通过边数据EdgeData.OutputNodeGUID和EdgeData.InputNodeGUID获得边所对应的输入输出NodeView。</p>
</li>
<li><p>得到边所对应的NodeView后，我们通过EdgeData边数据的端口信息给NodeView创建对应的输入和输出端口(GetOrCreateOutputPort()和GetOrCreateInputPort())。</p>
</li>
<li><p>创建好NodeView的对应输入和输出端口后，我们通过创建自定义EdgeView(CreateEdgeView())将创建的输入和输出端口传入作为边的对应连接端口，最后初始化EdgeView对应图和边数据(EdgeData.Init(<em>))并添加到GraphView</em>(Add(edgeView))则成功创建并还原了连接NodeView之间的EdgeView显示。</p>
</li>
</ol>
<p><img src="/img/Unity/UIToolkit/CreateEdgeViewFromEdgeData.PNG" alt="CreateEdgeViewFromEdgeData"></p>
<p>Note:</p>
<ol>
<li><strong>Edge(边)的输入Port是被连线的一侧，输出Port是开始连线的一侧。</strong></li>
<li><strong>Node(节点)的输入端口是Edge连入的一侧，输出端口是Edge连出的一侧。</strong></li>
</ol>
<h4 id="节点参数面板添加"><a href="#节点参数面板添加" class="headerlink" title="节点参数面板添加"></a>节点参数面板添加</h4><p>不同的节点有不同的数据需要展示和配置，节点数据的配置面板在节点编辑器中是必不可少的。</p>
<p>显示节点参数面板步骤如下：</p>
<ol>
<li>创建节点参数面板容器</li>
<li>检测节点选中</li>
<li>创建节点参数显示UI并添加到参数面板容器显示</li>
</ol>
<p>UIBTGraphEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图窗口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">   ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 临时绑定属性Map<span class="doctag">&lt;属性名, 属性绑定数据&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, PropertyBindData&gt; mTempBindPropertyDataMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, PropertyBindData&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建右侧内容UI显示</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateRightContentUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rightVerticalContentContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        rightVerticalContentContainer.name = BTGraphElementNames.RightVerticalContentContainerName;</span><br><span class="line">        rightVerticalContentContainer.style.left = <span class="number">0</span>;</span><br><span class="line">        rightVerticalContentContainer.style.width = <span class="number">300f</span>;</span><br><span class="line">        rightVerticalContentContainer.style.top = <span class="number">0</span>;</span><br><span class="line">        rightVerticalContentContainer.style.bottom = <span class="number">0</span>;</span><br><span class="line">        rightVerticalContentContainer.style.flexDirection = FlexDirection.Column;</span><br><span class="line">        rightVerticalContentContainer.AddToClassList(<span class="string">&quot;unity-rect-field&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> toolbarMenu = <span class="keyword">new</span> Toolbar();</span><br><span class="line">        toolbarMenu.name = BTGraphElementNames.RightToolbarMenuName;</span><br><span class="line">        toolbarMenu.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        toolbarMenu.style.height = <span class="number">25f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rightNodeConfigMenuButton = <span class="keyword">new</span> Button(OnNodeConfigMenuClick);</span><br><span class="line">        rightNodeConfigMenuButton.name = BTGraphElementNames.RightNodeConfigMenuButtonName;</span><br><span class="line">        rightNodeConfigMenuButton.text = <span class="string">&quot;节点参数&quot;</span>;</span><br><span class="line">        rightNodeConfigMenuButton.style.flexGrow = <span class="number">1f</span>;</span><br><span class="line">        rightNodeConfigMenuButton.AddToClassList(<span class="string">&quot;unity-toggle&quot;</span>);</span><br><span class="line">        toolbarMenu.Add(rightNodeConfigMenuButton);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rightBlackboardMenuButton = <span class="keyword">new</span> Button(OnBlackboardMenuClick);</span><br><span class="line">        rightBlackboardMenuButton.name = BTGraphElementNames.RightBlackboardMenuButtonName;</span><br><span class="line">        rightBlackboardMenuButton.text = <span class="string">&quot;黑板&quot;</span>;</span><br><span class="line">        rightBlackboardMenuButton.style.flexGrow = <span class="number">1f</span>;</span><br><span class="line">        rightBlackboardMenuButton.AddToClassList(<span class="string">&quot;unity-toggle&quot;</span>);</span><br><span class="line">        toolbarMenu.Add(rightBlackboardMenuButton);</span><br><span class="line"></span><br><span class="line">        rightVerticalContentContainer.Add(toolbarMenu);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rightPanelVerticalContainer = UIToolkitUtilities.CreateVerticalContainer(BTGraphElementNames.RightPanelVerticalContainerName, <span class="number">1f</span>, <span class="string">&quot;unity-rect-field&quot;</span>);</span><br><span class="line">        rightVerticalContentContainer.Add(rightPanelVerticalContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> horizontalContentContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.HorizontalContentContainerName);</span><br><span class="line">        horizontalContentContainer.Add(rightVerticalContentContainer);</span><br><span class="line"></span><br><span class="line">        UpdateSelectedPanelUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新选中面板类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;panelType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateSelectedPanel</span>(<span class="params">PanelType panelType</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentSelectedPanelType = panelType;</span><br><span class="line">        UpdateSelectedPanelUI();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新选中面板显示UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateSelectedPanelUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rightPanelVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.RightPanelVerticalContainerName);</span><br><span class="line">        rightPanelVerticalContainer.Clear();</span><br><span class="line">        <span class="keyword">if</span> (mCurrentSelectedPanelType == PanelType.NODE_CONFIG_PANEL)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateSelectionNodeConfigUI();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mCurrentSelectedPanelType == PanelType.BLACKBOARD_PANEL)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateBlackboardUI();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            CreateNotSupportPanelTypeUI();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建选择节点配置UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateSelectionNodeConfigUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rightPanelVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.RightPanelVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> rightNodeConfigVerticalContainer = UIToolkitUtilities.CreateVerticalContainer(BTGraphElementNames.RightNodeConfigVerticalContainerName);</span><br><span class="line">        rightPanelVerticalContainer.Add(rightNodeConfigVerticalContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rightVerticalContentLableTitle = <span class="keyword">new</span> Label();</span><br><span class="line">        rightVerticalContentLableTitle.text = <span class="string">&quot;参数面板&quot;</span>;</span><br><span class="line">        rightVerticalContentLableTitle.style.height = <span class="number">20f</span>;</span><br><span class="line">        rightVerticalContentLableTitle.style.alignSelf = Align.Center;</span><br><span class="line">        rightNodeConfigVerticalContainer.Add(rightVerticalContentLableTitle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mGraphView.SelectedNode != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateSelectedNodeInspector(rightNodeConfigVerticalContainer, mGraphView.SelectedNode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> rightSelectedNodeTipLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">            rightSelectedNodeTipLabelTitle.text = <span class="string">&quot;无选中节点&quot;</span>;</span><br><span class="line">            rightSelectedNodeTipLabelTitle.style.height = <span class="number">20</span>;</span><br><span class="line">            rightSelectedNodeTipLabelTitle.style.alignSelf = Align.Center;</span><br><span class="line">            rightNodeConfigVerticalContainer.Add(rightSelectedNodeTipLabelTitle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 给指定面板添加选中节点GUI显示</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeInspectorContainer&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selectedNodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateSelectedNodeInspector</span>(<span class="params">VisualElement nodeInspectorContainer, NodeView selectedNodeView</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(nodeInspectorContainer == <span class="literal">null</span> || selectedNodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;不允许给空容器或空显示节点创建选中节点GUI显示！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mTempBindPropertyDataMap.Clear();</span><br><span class="line">        <span class="keyword">var</span> inspectorUIElement = selectedNodeView.CreateInspectorGUIElement(mTempBindPropertyDataMap);</span><br><span class="line">        nodeInspectorContainer.Add(inspectorUIElement);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应节点根节点设置变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnNodeEntryPointValueChange</span>(<span class="params">NodeView nodeView</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeData = nodeView.NodeData;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;响应节点GUID:<span class="subst">&#123;nodeData.GUID&#125;</span>的根节点设置变化到:<span class="subst">&#123;nodeData.EntryPoint&#125;</span>&quot;</span>);</span><br><span class="line">        nodeView.style.backgroundColor = BTGraphUtilitiesEditor.GetBackgroundColorByNodeData(nodeData);</span><br><span class="line">        <span class="comment">// 根节点不允许输入端连接任何节点</span></span><br><span class="line">        <span class="keyword">if</span> (nodeData.EntryPoint)</span><br><span class="line">        &#123;</span><br><span class="line">            DisconnectAllInputPort(nodeView);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建新的GraphView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> BehaviourTreeGraphView <span class="title">GetNewGraphView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BehaviourTreeGraphView(mAvailableNodeTypeList, <span class="keyword">this</span>.OnSelectedNodeChange);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>PropertyBindData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 属性绑定数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PropertyBindData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定属性名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> BindPropertyName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定SerializedObject</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> SerializedObject BindSerializedObject</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> SerializedProperty BindSerializedProperty</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定属性显示组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> PropertyField BindVisualElement</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bindSerializedObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bindSerializedProperty&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bindVisualElement&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PropertyBindData</span>(<span class="params">SerializedObject bindSerializedObject, SerializedProperty bindSerializedProperty, PropertyField bindVisualElement</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        BindSerializedObject = bindSerializedObject;</span><br><span class="line">        BindSerializedProperty = bindSerializedProperty;</span><br><span class="line">        BindVisualElement = bindVisualElement;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UIToolkitUtilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIToolkitUtilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIToolkit工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">UIToolkitUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定容器创建指定对象的可视化Inspector</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scriptableObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;propertyBindDataMap&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateBindSOInspector</span>(<span class="params">ScriptableObject scriptableObject, Dictionary&lt;<span class="built_in">string</span>, PropertyBindData&gt; propertyBindDataMap = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(scriptableObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空ScriptableObject创建可视化Inspector！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> container = CreateVerticalContainer(<span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(scriptableObject);</span><br><span class="line">        <span class="keyword">var</span> propertyIterator = serializedObject.GetIterator();</span><br><span class="line">        propertyIterator.NextVisible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">while</span>(propertyIterator.NextVisible(<span class="literal">false</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> propertyField = <span class="keyword">new</span> PropertyField();</span><br><span class="line">            <span class="keyword">var</span> propertyName = propertyIterator.name;</span><br><span class="line">            <span class="keyword">var</span> property = serializedObject.FindProperty(propertyName);</span><br><span class="line">            propertyField.name = propertyName;</span><br><span class="line">            propertyField.BindProperty(property);</span><br><span class="line">            container.Add(propertyField);</span><br><span class="line">            <span class="keyword">if</span>(propertyBindDataMap != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> propertyBindData = <span class="keyword">new</span> PropertyBindData(serializedObject, property, propertyField);</span><br><span class="line">                propertyBindDataMap.Add(propertyName, propertyBindData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NodeView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点显示抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NodeView</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点选择委托</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Action&lt;NodeView&gt; mNodeSelectedDelegate;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据Node数据初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeSelectedCB&quot;&gt;</span>节点选择委托<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeName&quot;&gt;</span>节点名(默认不传为BaseNode的类型名)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span>节点方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params">BaseNode node, Action&lt;NodeView&gt; nodeSelectedCB = <span class="literal">null</span>, <span class="built_in">string</span> nodeName = <span class="literal">null</span>, Orientation orientation = Orientation.Horizontal</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        mNodeSelectedDelegate += nodeSelectedCB;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应节点选择</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnSelected</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnSelected();</span><br><span class="line">        Debug.Log(<span class="string">$&quot;节点GUID:<span class="subst">&#123;NodeData.GUID&#125;</span>,节点类型:<span class="subst">&#123;NodeData.NodeType&#125;</span>，节点名:<span class="subst">&#123;NodeData.GetType().Name&#125;</span>被选中！&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (mNodeSelectedDelegate != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mNodeSelectedDelegate(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定类型信息和节点名的新节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typeInfo&quot;&gt;</span>类型信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;position&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isEntryNode&quot;&gt;</span>是否是根节点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NodeView <span class="title">CreateNodeByType</span>(<span class="params">Type typeInfo, Vector2 position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> newNode = BTGraphUtilitiesEditor.CreateNodeInstance(typeInfo);</span><br><span class="line">        <span class="keyword">var</span> guid = Guid.NewGuid().ToString();</span><br><span class="line">        <span class="keyword">var</span> nodeRect = BTGraphConstEditor.NodeDefaultRect;</span><br><span class="line">        nodeRect.x = position.x;</span><br><span class="line">        nodeRect.y = position.y;</span><br><span class="line">        newNode.Init(guid, nodeRect);</span><br><span class="line">        <span class="keyword">var</span> nodeView = BTGraphUtilitiesEditor.CreateNodeViewInstance(typeInfo);</span><br><span class="line">        nodeView.Init(SourceGraphData, newNode, OnNodeSelected, <span class="literal">null</span>, GraphOrientation);</span><br><span class="line">        AddNodeData(newNode);</span><br><span class="line">        AddElement(nodeView);</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeRect);</span><br><span class="line">        <span class="keyword">return</span> nodeView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 相应节点选择</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selectedNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnNodeSelected</span>(<span class="params">NodeView selectedNode</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;CommonGraphView:OnNodeSelected()&quot;</span>);</span><br><span class="line">        UpdateSelectedNode(selectedNode);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新选择节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selectedNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateSelectedNode</span>(<span class="params">NodeView selectedNode</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SelectedNode = selectedNode;</span><br><span class="line">        <span class="keyword">if</span> (mSelectedNodeChangeDelegate != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mSelectedNodeChangeDelegate(SelectedNode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/NodeDIYParamsDisplay.PNG" alt="NodeDIYParamsDisplay"></p>
<p>从上面可以看到，我们通过创建BehaviourTreeGraphView时传入节点选择回调，然后创建节点时有把这个回调传给节点，最后在Node.OnSelected()里响应选中，最终成功实现选中节点的逻辑回调。</p>
<p>得到选中节点后，我们把UIBTGraphEditorWindow.CreateSelectionNodeConfigUI()实现参数面板的动态创建。</p>
<p><strong>为了监听节点的EntryPoint属性变化做出节点刷新显示，在UIToolkitUtilities.CreateBindSOInspector()方法里，我支持了传递绑定数据Map返回所有属性绑定Map的方式，实现对指定属性的自定义变化监听绑定。</strong></p>
<p>Note:</p>
<ol>
<li><strong>为了使用PropertyField快速实现属性绑定展示，这里图和节点数据都继承至ScriptableObject，存储成Asset和SubAsset的方式，最后通过UIToolkitUtilities.CreateBindSOInspector()方法创建通用的节点属性绑定显示</strong></li>
</ol>
<h4 id="节点右键操作添加"><a href="#节点右键操作添加" class="headerlink" title="节点右键操作添加"></a>节点右键操作添加</h4><p>除了通过操作面板选择节点进行节点创建操作，我们还可以给节点实现右键打开附属菜单的方式实现快捷节点操作功能。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜单操作类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> MenuOperationType</span><br><span class="line">    &#123;</span><br><span class="line">        CreateNode = <span class="number">1</span>,             <span class="comment">// 创建节点</span></span><br><span class="line">        DeleteNodeOnly,             <span class="comment">// 删除节点自身</span></span><br><span class="line">        DeleteNodeRecusive,         <span class="comment">// 递归删除节点</span></span><br><span class="line">        DuplicatedNodeOnly,         <span class="comment">// 复制粘贴节点(非递归)</span></span><br><span class="line">        DuplicateNodeRecusive,      <span class="comment">// 复制粘贴节点(递归)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜单自定义数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MenuUserData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜单操作类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> MenuOperationType OperationType</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜单操作VisualElement</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> VisualElement OperationElement</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> System.Object CustomData</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MenuUserData</span>(<span class="params">MenuOperationType operationType, VisualElement operationElement, System.Object customData</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            OperationType = operationType;</span><br><span class="line">            OperationElement = operationElement;</span><br><span class="line">            CustomData = customData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型可用通用菜单操作类型列表Map<span class="doctag">&lt;节点类型, 可用通用菜单操作类型列表&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;NodeType, List&lt;MenuOperationType&gt;&gt; mNodeCommonOperationTypesMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型可用菜单节点类型信息列表Map<span class="doctag">&lt;节点类型, &lt;节点类型, 可用节点类型信息列表&gt;</span>&gt;</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;NodeType, Dictionary&lt;NodeType, List&lt;Type&gt;&gt;&gt; mNodeTypeMenuTypesMap;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;availableNodeTypeList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selectedNodeChangeCB&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BehaviourTreeGraphView</span>(<span class="params">List&lt;NodeType&gt; availableNodeTypeList, Action&lt;NodeView&gt; selectedNodeChangeCB = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAvailableNodeTypeList = availableNodeTypeList;</span><br><span class="line">        mSelectedNodeChangeDelegate += selectedNodeChangeCB;</span><br><span class="line">        Init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">      	******</span><br><span class="line">        InitMenuData();</span><br><span class="line">      	******</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点菜单数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitMenuData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitNodeCommonMenuOperationDatas();</span><br><span class="line">        InitNodeMenuTypesData();</span><br><span class="line">        InitGraphViewMenuTypesData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点通用菜单操作数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitNodeCommonMenuOperationDatas</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNodeCommonOperationTypesMap = <span class="keyword">new</span> Dictionary&lt;NodeType, List&lt;MenuOperationType&gt;&gt;();</span><br><span class="line">        <span class="keyword">var</span> nodeTypeValues = Enum.GetValues(<span class="keyword">typeof</span>(NodeType));</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> nodeTypeValue <span class="keyword">in</span> nodeTypeValues)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> commonMenuOperationTypeList = <span class="keyword">new</span> List&lt;MenuOperationType&gt;();</span><br><span class="line">            mNodeCommonOperationTypesMap.Add((NodeType)nodeTypeValue, commonMenuOperationTypeList);</span><br><span class="line">            commonMenuOperationTypeList.Add(MenuOperationType.DeleteNodeOnly);</span><br><span class="line">            commonMenuOperationTypeList.Add(MenuOperationType.DeleteNodeRecusive);</span><br><span class="line">            commonMenuOperationTypeList.Add(MenuOperationType.DuplicatedNodeOnly);</span><br><span class="line">            commonMenuOperationTypeList.Add(MenuOperationType.DuplicateNodeRecusive);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点菜单类型信息数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitNodeMenuTypesData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNodeTypeMenuTypesMap = <span class="keyword">new</span> Dictionary&lt;NodeType, Dictionary&lt;NodeType, List&lt;Type&gt;&gt;&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> portAvalibleConnectNodeTypeInfo <span class="keyword">in</span> mPortAvailableConnectNodeTypeMap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (portAvalibleConnectNodeTypeInfo.Value.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> nodeTypeMenuTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, List&lt;Type&gt;&gt;();</span><br><span class="line">            mNodeTypeMenuTypesMap.Add(portAvalibleConnectNodeTypeInfo.Key, nodeTypeMenuTypeMap);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> portAvalibleConnectNodeTypeMap <span class="keyword">in</span> portAvalibleConnectNodeTypeInfo.Value)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> targetNodeType = portAvalibleConnectNodeTypeMap.Key;</span><br><span class="line">                <span class="keyword">var</span> targetNodeBaseType = GetBaseTypeByNodeType(targetNodeType);</span><br><span class="line">                <span class="keyword">if</span> (targetNodeBaseType == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> menuTypeList = <span class="keyword">new</span> List&lt;Type&gt;();</span><br><span class="line">                nodeTypeMenuTypeMap.Add(targetNodeType, menuTypeList);</span><br><span class="line">                <span class="keyword">var</span> allSubTypeList = TypeUtilities.GetAllSubTypes(targetNodeBaseType);</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> subType <span class="keyword">in</span> allSubTypeList)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (subType.IsAbstract || IsPortUnavalibleConnectType(targetNodeType, subType))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    menuTypeList.Add(subType);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 移除没有任何一个有效类型的节点类型数据</span></span><br><span class="line">                <span class="keyword">if</span> (menuTypeList.Count == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    nodeTypeMenuTypeMap.Remove(targetNodeType);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化GraphView菜单数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitGraphViewMenuTypesData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mGraphViewMenuTypesMap = <span class="keyword">new</span> Dictionary&lt;NodeType, List&lt;Type&gt;&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> availableNodeType <span class="keyword">in</span> mAvailableNodeTypeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> targetNodeBaseType = GetBaseTypeByNodeType(availableNodeType);</span><br><span class="line">            <span class="keyword">if</span> (targetNodeBaseType == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> menuTypeList = <span class="keyword">new</span> List&lt;Type&gt;();</span><br><span class="line">            mGraphViewMenuTypesMap.Add(availableNodeType, menuTypeList);</span><br><span class="line">            <span class="keyword">var</span> allSubTypeList = TypeUtilities.GetAllSubTypes(targetNodeBaseType);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> subType <span class="keyword">in</span> allSubTypeList)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (subType.IsAbstract)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                menuTypeList.Add(subType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 移除没有任何一个有效类型的节点类型数据</span></span><br><span class="line">            <span class="keyword">if</span> (menuTypeList.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mGraphViewMenuTypesMap.Remove(availableNodeType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取制定通用菜单操作类型的子菜单名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子菜单名组成 = 菜单操作类型名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuOperationType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">string</span> <span class="title">GetMenuOperationName</span>(<span class="params">MenuOperationType menuOperationType</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;<span class="subst">&#123;menuOperationType.ToString()&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定节点类型信息的子菜单名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子菜单名组成 = 节点类型/节点类型名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeType&quot;&gt;</span>节点类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>节点类型信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">string</span> <span class="title">GetNodeTypeSubMenuName</span>(<span class="params">NodeType nodeType, Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(type == <span class="literal">null</span> || type == BTGraphConstEditor.BaseNodeType</span><br><span class="line">            || !type.IsSubclassOf(BTGraphConstEditor.BaseNodeType))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;<span class="subst">&#123;nodeType.ToString()&#125;</span>/<span class="subst">&#123;type.Name&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应菜单栏添加</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;evt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">BuildContextualMenu</span>(<span class="params">ContextualMenuPopulateEvent evt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//base.BuildContextualMenu(evt);</span></span><br><span class="line">        BuildNodeContextualMenu(evt);</span><br><span class="line">        BuildGraphContextualMenu(evt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 构建节点菜单栏</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;evt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">BuildNodeContextualMenu</span>(<span class="params">ContextualMenuPopulateEvent evt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> target = evt.target;</span><br><span class="line">        <span class="keyword">var</span> targetNodeView = target <span class="keyword">as</span> NodeView;</span><br><span class="line">        <span class="keyword">if</span> (targetNodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> nodeType = targetNodeView.NodeData.NodeType;</span><br><span class="line">        <span class="keyword">var</span> allCommonMenuOperationTypes = GetNodeCommonMenuOperationTypes(nodeType);</span><br><span class="line">        <span class="keyword">if</span> (allCommonMenuOperationTypes != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> commonOperationType <span class="keyword">in</span> allCommonMenuOperationTypes)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> menuOperationName = GetMenuOperationName(commonOperationType);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(menuOperationName))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> menuUserData = <span class="keyword">new</span> MenuUserData(commonOperationType, targetNodeView, commonOperationType);</span><br><span class="line">                evt.menu.AppendAction(menuOperationName, OnNodeViewCommonMenuOperationNode, OnSubMenuStatus, menuUserData);</span><br><span class="line">                <span class="comment">//Debug.Log($&quot;添加子菜单:&#123;menuOperationName&#125;&quot;);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> allSubMenuTypesMap = GetNodeTypeMenuTypesMap(nodeType);</span><br><span class="line">        <span class="keyword">if</span> (allSubMenuTypesMap != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> subMenuTypesMap <span class="keyword">in</span> allSubMenuTypesMap)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> targetNodeType = subMenuTypesMap.Key;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> subMenuType <span class="keyword">in</span> subMenuTypesMap.Value)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (subMenuType.IsAbstract)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">var</span> subMenuName = GetNodeTypeSubMenuName(targetNodeType, subMenuType);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(subMenuName))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">var</span> menuUserData = <span class="keyword">new</span> MenuUserData(MenuOperationType.CreateNode, targetNodeView, subMenuType);</span><br><span class="line">                    evt.menu.AppendAction(subMenuName, OnNodeViewSubMenuCreateNode, OnSubMenuStatus, menuUserData);</span><br><span class="line">                    <span class="comment">//Debug.Log($&quot;添加子菜单:&#123;subMenuName&#125;&quot;);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应NodeView节点通用菜单操作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnNodeViewCommonMenuOperationNode</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menuUserData = menuAction.userData <span class="keyword">as</span> MenuUserData;</span><br><span class="line">        <span class="keyword">var</span> targetNodeView = menuUserData.OperationElement <span class="keyword">as</span> NodeView;</span><br><span class="line">        <span class="keyword">var</span> menuOperationType = menuUserData.OperationType;</span><br><span class="line">        <span class="keyword">if</span> (menuOperationType == MenuOperationType.DeleteNodeOnly)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveNodeView(targetNodeView, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (menuOperationType == MenuOperationType.DeleteNodeRecusive)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveNodeView(targetNodeView, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (menuOperationType == MenuOperationType.DuplicatedNodeOnly)</span><br><span class="line">        &#123;</span><br><span class="line">            DuplicateNodeView(targetNodeView, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(menuOperationType == MenuOperationType.DuplicateNodeRecusive)</span><br><span class="line">        &#123;</span><br><span class="line">            DuplicateNodeView(targetNodeView, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应NodeView子菜单栏创建节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnNodeViewSubMenuCreateNode</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menuUserData = menuAction.userData <span class="keyword">as</span> MenuUserData;</span><br><span class="line">        <span class="keyword">var</span> nodeType = menuUserData.CustomData <span class="keyword">as</span> Type;</span><br><span class="line">        Vector2 actualGraphPosition = TransformGridLocalMousePosToGraphPos(menuAction.eventInfo.localMousePosition);</span><br><span class="line">        <span class="keyword">var</span> nodeView = CreateNodeByType(nodeType, actualGraphPosition);</span><br><span class="line">        <span class="keyword">var</span> nodeViewPosition = nodeView.GetPosition();</span><br><span class="line">        nodeViewPosition.position = actualGraphPosition;</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeViewPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;CommonGraphView:OnNodeViewSubMenuCreateNode() NodeType:&#123;menuUserData.SourceNodeView.NodeData.NodeType&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;localMousePosition:&#123;menuAction.eventInfo.localMousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;mousePosition:&#123;menuAction.eventInfo.mousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;actualGraphPosition:&#123;actualGraphPosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 创建节点Port链接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应节点子菜单栏Item状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> DropdownMenuAction.<span class="function">Status <span class="title">OnSubMenuStatus</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MenuUserData menuUserData = menuAction.userData <span class="keyword">as</span> MenuUserData;</span><br><span class="line">        NodeView nodeView = menuUserData.OperationElement <span class="keyword">as</span> NodeView;</span><br><span class="line">        <span class="keyword">if</span> (nodeView != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (nodeView.NodeData.EntryPoint)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">bool</span> isDeleteNodeOnlyType = menuUserData.OperationType == MenuOperationType.DeleteNodeOnly;</span><br><span class="line">                <span class="built_in">bool</span> isDeleteNodeRecusiveType = menuUserData.OperationType == MenuOperationType.DeleteNodeRecusive;</span><br><span class="line">                <span class="built_in">bool</span> isDuplicatedNodeOperationType = menuUserData.OperationType == MenuOperationType.DuplicatedNodeOnly;</span><br><span class="line">                <span class="built_in">bool</span> isDuplicateNodeRecusiveOperation = menuUserData.OperationType == MenuOperationType.DuplicateNodeRecusive;</span><br><span class="line">                <span class="keyword">if</span> (isDeleteNodeOnlyType || isDeleteNodeRecusiveType || isDuplicatedNodeOperationType || isDuplicateNodeRecusiveOperation)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> DropdownMenuAction.Status.Disabled;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> DropdownMenuAction.Status.Normal;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> DropdownMenuAction.Status.Disabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 构建GraphView菜单栏</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;evt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">BuildGraphContextualMenu</span>(<span class="params">ContextualMenuPopulateEvent evt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> target = evt.target;</span><br><span class="line">        <span class="keyword">var</span> targetGraphView = target <span class="keyword">as</span> GraphView;</span><br><span class="line">        <span class="keyword">if</span> (targetGraphView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> graphViewTypesMap <span class="keyword">in</span> mGraphViewMenuTypesMap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> nodeType = graphViewTypesMap.Key;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> graphViewType <span class="keyword">in</span> graphViewTypesMap.Value)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (graphViewType.IsAbstract)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> subMenuName = GetNodeTypeSubMenuName(nodeType, graphViewType);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(subMenuName))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> menuUserData = <span class="keyword">new</span> MenuUserData(MenuOperationType.CreateNode, <span class="literal">null</span>, graphViewType);</span><br><span class="line">                evt.menu.AppendAction(subMenuName, OnGraphViewSubMenuCreateNode, OnGraphSubMenuStatus, menuUserData);</span><br><span class="line">                <span class="comment">//Debug.Log($&quot;添加子菜单:&#123;subMenuName&#125;&quot;);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应GraphView子菜单创建节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnGraphViewSubMenuCreateNode</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menuUserData = menuAction.userData <span class="keyword">as</span> MenuUserData;</span><br><span class="line">        <span class="keyword">var</span> nodeType = menuUserData.CustomData <span class="keyword">as</span> Type;</span><br><span class="line">        Vector2 actualGraphPosition = TransformGridLocalMousePosToGraphPos(menuAction.eventInfo.localMousePosition);</span><br><span class="line">        <span class="keyword">var</span> nodeView = CreateNodeByType(nodeType, actualGraphPosition);</span><br><span class="line">        <span class="keyword">var</span> nodeViewPosition = nodeView.GetPosition();</span><br><span class="line">        nodeViewPosition.position = actualGraphPosition;</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeViewPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;CommonGraphView:OnGraphViewSubMenuCreateNode()&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;localMousePosition:&#123;menuAction.eventInfo.localMousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;mousePosition:&#123;menuAction.eventInfo.mousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;actualGraphPosition:&#123;actualGraphPosition.ToString()&#125;&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应图子菜单栏Item状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> DropdownMenuAction.<span class="function">Status <span class="title">OnGraphSubMenuStatus</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DropdownMenuAction.Status.Normal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">RemoveNodeView</span>(<span class="params">NodeView nodeView, <span class="built_in">bool</span> recusive = <span class="literal">false</span>, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许移除空NodeView，删除节点View失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!Contains(nodeView))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;未包含NodeView GUID:<span class="subst">&#123;nodeView.NodeData.GUID&#125;</span>的节点View，删除节点View失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(enableUndoSystem)</span><br><span class="line">        &#123;</span><br><span class="line">        	Undo.RecordObject(SourceGraphData, <span class="string">$&quot;RemoveNodeView(<span class="subst">&#123;recusive&#125;</span>)&quot;</span>);            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!recusive)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveNodeViewWithAllEdge(nodeView);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> allChildNodeViews = GetAllChildNodeViews(nodeView);</span><br><span class="line">        <span class="keyword">if</span> (allChildNodeViews != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> childNodeView <span class="keyword">in</span> allChildNodeViews)</span><br><span class="line">            &#123;</span><br><span class="line">                RemoveNodeView(childNodeView, recusive);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        RemoveNodeViewWithAllEdge(nodeView);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定节点View和其所有边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">RemoveNodeViewWithAllEdge</span>(<span class="params">NodeView nodeView</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许移除空NodeView，删除节点View和其所有边失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mDeleteElementTempList.Clear();</span><br><span class="line">        <span class="keyword">var</span> allInputPorts = nodeView.inputContainer.Query&lt;Port&gt;().ToList();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> inputPort <span class="keyword">in</span> allInputPorts)</span><br><span class="line">        &#123;</span><br><span class="line">            mDeleteElementTempList.AddRange(inputPort.connections);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> allOutputPorts = nodeView.outputContainer.Query&lt;Port&gt;().ToList();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> outputPort <span class="keyword">in</span> allOutputPorts)</span><br><span class="line">        &#123;</span><br><span class="line">            mDeleteElementTempList.AddRange(outputPort.connections);</span><br><span class="line">        &#125;</span><br><span class="line">        mDeleteElementTempList.Add(nodeView);</span><br><span class="line">        DeleteElements(mDeleteElementTempList);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 复制指定节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">DuplicateNodeView</span>(<span class="params">NodeView nodeView, <span class="built_in">bool</span> recusive = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/NodeRightClickMenu.PNG" alt="NodeRightClickMenu"></p>
<p>从上面可以看到，GraphView.BuildContextualMenu()方法是响应添加菜单的接口，我们通过初始化BehaviourTreeGraphView.InitMenuData()所有节点相关菜单数据，在GraphView.BuildContextualMenu()里通过获取可用菜单的方式动态构建节点对应菜单，从而实现节点自定义右键菜单操作。</p>
<p>这里简单介绍下插入菜单的参数:</p>
<p>DropdownMenuAction.menu.AppendAction(string actionName, Action<DropdownMenuAction> action, Func&lt;DropdownMenuAction,Status&gt; actionStatusCallback, object userData)</p>
<ul>
<li><p>actionName</p>
<p>菜单名，二级菜单通过&#x2F;分割</p>
</li>
<li><p>action</p>
<p>菜单选中执行回调</p>
</li>
<li><p>actionStatusCallback</p>
<p>菜单选项显示状态返回回调</p>
</li>
<li><p>userData</p>
<p>菜单自定义传递数据，传递后可以在action点击回调里通过DropdownMenuAction.userData获取访问</p>
</li>
</ul>
<h4 id="输出端口节点边顺序索引数据排序显示"><a href="#输出端口节点边顺序索引数据排序显示" class="headerlink" title="输出端口节点边顺序索引数据排序显示"></a>输出端口节点边顺序索引数据排序显示</h4><p><strong>无论是横向GraphView还是纵向GraphView，常规定义节点顺序都是通过横向(竖向GraphView)或则纵向(横向GraphView)位置大小来判定的</strong></p>
<p>为了方便和快速看出节点顺序的正确性，我通过对端口各条边的位置大小进行排序并显示。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应GraphView变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphViewChange&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> GraphViewChange <span class="title">OnGraphViewChanged</span>(<span class="params">GraphViewChange graphViewChange</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;CommonGraphVIew:OnGraphViewChanged()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.elementsToRemove != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> elementToRemove <span class="keyword">in</span> graphViewChange.elementsToRemove)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (elementToRemove <span class="keyword">is</span> NodeView removeNodeView)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;删除节点GUID:<span class="subst">&#123;removeNodeView.NodeData.GUID&#125;</span>，节点数据类型:<span class="subst">&#123;removeNodeView.NodeData.GetType().Name&#125;</span>&quot;</span>);</span><br><span class="line">                    RemoveNodeData(removeNodeView.NodeData);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (elementToRemove <span class="keyword">is</span> Edge removeEdge)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> inputNodeView = removeEdge.input.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                    <span class="keyword">var</span> outputNodeView = removeEdge.output.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                    <span class="keyword">var</span> inputNodeViewName = inputNodeView != <span class="literal">null</span> ? inputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                    <span class="keyword">var</span> outputNodeViewName = outputNodeView != <span class="literal">null</span> ? outputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;删除边，Input节点名:<span class="subst">&#123;inputNodeViewName&#125;</span>，Input端口名:<span class="subst">&#123;removeEdge.input.portName&#125;</span>，Output节点名:<span class="subst">&#123;outputNodeViewName&#125;</span>，Output端口名:<span class="subst">&#123;removeEdge.output.portName&#125;</span>&quot;</span>);</span><br><span class="line">                    RemoveEdgeData(outputNodeView.NodeData.GUID, removeEdge.output.portName, inputNodeView.NodeData.GUID, removeEdge.input.portName);</span><br><span class="line">                    OnEdgeViewUpdate(removeEdge);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;TODO:删除其他Element类型:<span class="subst">&#123;elementToRemove.GetType().Name&#125;</span>！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.edgesToCreate != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> edgeToCreate <span class="keyword">in</span> graphViewChange.edgesToCreate)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> edgeView = edgeToCreate <span class="keyword">as</span> EdgeView;</span><br><span class="line">                <span class="keyword">var</span> inputNodeView = edgeToCreate.input.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                <span class="keyword">var</span> outputNodeView = edgeToCreate.output.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                <span class="keyword">var</span> inputNodeViewName = inputNodeView != <span class="literal">null</span> ? inputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                <span class="keyword">var</span> outputNodeViewName = outputNodeView != <span class="literal">null</span> ? outputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                <span class="keyword">var</span> ouputNodeGUID = outputNodeView.NodeData.GUID;</span><br><span class="line">                <span class="keyword">var</span> outputPortName = edgeToCreate.output.portName;</span><br><span class="line">                <span class="keyword">var</span> outputPortTypeFullName = edgeToCreate.output.portType.FullName;</span><br><span class="line">                <span class="keyword">var</span> inputNodeGUID = inputNodeView.NodeData.GUID;</span><br><span class="line">                <span class="keyword">var</span> intputPortName = edgeToCreate.input.portName;</span><br><span class="line">                <span class="keyword">var</span> intputPortTypeFullName = edgeToCreate.input.portType.FullName;</span><br><span class="line">                <span class="keyword">var</span> guid = Guid.NewGuid().ToString();</span><br><span class="line">                EdgeData edgeData = <span class="keyword">new</span> EdgeData(guid, ouputNodeGUID, outputPortName, outputPortTypeFullName, inputNodeGUID, intputPortName, intputPortTypeFullName);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;创建边，Input节点名:<span class="subst">&#123;inputNodeViewName&#125;</span>，Input端口名:<span class="subst">&#123;edgeToCreate.input.portName&#125;</span>，Output节点名:<span class="subst">&#123;outputNodeViewName&#125;</span>，Output端口名:<span class="subst">&#123;edgeToCreate.output.portName&#125;</span>&quot;</span>);</span><br><span class="line">                AddEdgeData(edgeData);</span><br><span class="line">                OnEdgeViewUpdate(edgeView);</span><br><span class="line">                <span class="comment">// 新增边不知道为什么在OnGraphViewChanged里触发时还未添加到connections里</span></span><br><span class="line">                <span class="comment">// 这里采取手动更新新增显示边的索引显示数据</span></span><br><span class="line">                UpdateEdgeViewIndex(edgeView);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.movedElements != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> moveElement <span class="keyword">in</span> graphViewChange.movedElements)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (moveElement <span class="keyword">is</span> NodeView moveNodeView)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;更新节点GUID:<span class="subst">&#123;moveNodeView.NodeData.GUID&#125;</span>，节点数据类型:<span class="subst">&#123;moveNodeView.NodeData.GetType().Name&#125;</span>的位置X:<span class="subst">&#123;moveNodeView.NodeData.Position.x&#125;</span> Y:<span class="subst">&#123;moveNodeView.NodeData.Position.y&#125;</span>&quot;</span>);</span><br><span class="line">                    UpdateNodeRectByNodeView(moveNodeView);</span><br><span class="line">                    OnNodeViewMove(moveNodeView);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;TODO:移动Element类型:<span class="subst">&#123;moveElement.GetType().Name&#125;</span>！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> graphViewChange;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> 	******   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BehaviourTreeGraphData.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphData</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line"> 	******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应边数据更新</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEdgeDataUpdate</span>(<span class="params">EdgeData edgeData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (edgeData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不应该更新空边数据，请检查代码！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        UpdateNodeOutputPortEdgeIndex(edgeData.OutputNodeGUID, edgeData.OutputPortName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新指定节点和指定输出端口名的边索引数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeGUID&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputPortName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateNodeOutputPortEdgeIndex</span>(<span class="params"><span class="built_in">string</span> nodeGUID, <span class="built_in">string</span> outputPortName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTempEdgeDataList.Clear();</span><br><span class="line">        GetOutputNodePortEdgeDatas(nodeGUID, outputPortName, <span class="keyword">ref</span> mTempEdgeDataList);</span><br><span class="line">        <span class="keyword">if</span> (mTempEdgeDataList.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Debug.Log($&quot;找不到节点GUID:&#123;nodeGUID&#125;和输出端口名:&#123;outputPortName&#125;的边数据列表，更新边索引数据失败！&quot;);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mTempEdgeDataList.Sort(SortPortEdgeDataIndex);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>, length = mTempEdgeDataList.Count; index &lt; length; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> edgeData = mTempEdgeDataList[index];</span><br><span class="line">            edgeData.UpdateEdgeOutputPortIndex(index);</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;更新节点GUID:<span class="subst">&#123;nodeGUID&#125;</span>的输出端口明:<span class="subst">&#123;outputPortName&#125;</span>的边索引数据！&quot;</span>);</span><br><span class="line">        AllEdgeDataList.Sort(SortAllEdgeDataIndex);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到实现对节点顺序排序流程如下:</p>
<ol>
<li>监听OnGraphViewChanged的EdgeView变化(<strong>增(BehaviourTreeGraphView.AddEdgeData())，删(BehaviourTreeGraphView.RemoveEdgeData())和移动(BehaviourTreeGraphView.OnNodeViewMove())</strong>)对EdgeData的输出端口边索引数据(EdgeData.OutputPortEdgeIndex)进行了根据位置大小的排序(<strong>BehaviourTreeGraphData.UpdateNodeOutputPortEdgeIndex()和BehaviourTreeGraphData.SortPortEdgeDataIndex()</strong>)。</li>
<li>EdgeData输出端口边索引数据的排序原理是通过边输出端口节点GUID和输出端口名得到对应所有连接的边数据(EdgeData)列表，然后通过遍历所有边数据列表所连接的输入节点GUID得到所有对应的输入节点数据(BaseNode)，最后根据图朝向(BehaviourTreeGraphData.GraphOrientation)去比较所有输入节点(BaseNode)的横向或纵向位置大小进行排序得出所有边对应的顺序并保存在边数据(EdgeData.OutputPortEdgeIndex)里。</li>
</ol>
<p><img src="/img/Unity/UIToolkit/ShowNodeEdgeIndex.PNG" alt="ShowNodeEdgeIndex"></p>
<p>Note:</p>
<ol>
<li><strong>新增边EdgeView在OnGraphViewChange里访问时不存在，此时通过强制更新指定EdgeView索引的方式更新显示(BehaviourTreeGraphView.UpdateEdgeViewIndex())</strong></li>
<li><strong>删除边EdgeView时OnGraphViewChange里访问时还依然存在，所以通过判定逻辑边数据(EdgeData)不存在来避免问题(BehaviourTreeGraphView.UpdateEdgeViewIndex())</strong></li>
</ol>
<h4 id="背景网格添加"><a href="#背景网格添加" class="headerlink" title="背景网格添加"></a>背景网格添加</h4><p>前面讲到我们加载了自定义的UICommonGraphEditorWindow.uss的StyleSheet，那么在代码里我们直接创建GridBackground即可使用对应GridBackground的StyleSheet设置了。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BehaviourTreeGraphView</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加网格背景</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">AddGridBackground</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> grid = <span class="keyword">new</span> GridBackground();</span><br><span class="line">        grid.name = BTGraphElementNames.GridBackgroundName;</span><br><span class="line">        Insert(<span class="number">0</span>, grid);</span><br><span class="line">        grid.StretchToParentSize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/CreateGridDisplay.PNG" alt="CreateGridDisplay"></p>
<h4 id="图数据拖拽重用"><a href="#图数据拖拽重用" class="headerlink" title="图数据拖拽重用"></a>图数据拖拽重用</h4><p>数据拖拽我们可以监听DragExitedEvent</p>
<p>CommonGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        AddAllEvents();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加所有监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddAllEvents</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        graphViewChanged += OnGraphViewChanged;</span><br><span class="line">        RegisterCallback&lt;DragExitedEvent&gt;(OnDragExistedEvent);</span><br><span class="line">        </span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除所有监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RemoveAllEvents</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        graphViewChanged -= OnGraphViewChanged;</span><br><span class="line">        UnregisterCallback&lt;DragExitedEvent&gt;(OnDragExistedEvent);</span><br><span class="line">        </span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 转换图ContentContainer组件鼠标局部坐标到GraphView本地坐标</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;localMousePosition&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Vector2 <span class="title">TransformContentLocalMousePosToGraphPos</span>(<span class="params">Vector2 localMousePosition</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Vector2 worldMousePosition = contentContainer.LocalToWorld(localMousePosition);</span><br><span class="line">        Vector2 actualGraphPosition = contentViewContainer.WorldToLocal(worldMousePosition);</span><br><span class="line">        <span class="keyword">return</span> actualGraphPosition;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应拖拽结束事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dragExitedEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnDragExistedEvent</span>(<span class="params">DragExitedEvent dragExitedEvent</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;响应拖拽结束！&quot;</span>);</span><br><span class="line">        <span class="comment">// dragExistEvent.localMousePosition的坐标系貌似就是ContentViewContainer，所以不需要转换</span></span><br><span class="line">        Debug.Log(<span class="string">$&quot;拖拽结束位置:<span class="subst">&#123;dragExitedEvent.localMousePosition&#125;</span>&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;当前拖拽物体数量:<span class="subst">&#123;DragAndDrop.objectReferences.Length&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> objectReference <span class="keyword">in</span> DragAndDrop.objectReferences)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;拖拽物体名:<span class="subst">&#123;objectReference.name&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> graphData = objectReference <span class="keyword">as</span> BehaviourTreeGraphData;</span><br><span class="line">            <span class="keyword">if</span> (graphData != <span class="literal">null</span> &amp;&amp; AssetDatabase.Contains(graphData))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> graphDataAssetPath = AssetDatabase.GetAssetPath(graphData);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;拖拽的图数据Asset路径:<span class="subst">&#123;graphDataAssetPath&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> cloneGraphData = graphData.CloneSelf();</span><br><span class="line">                <span class="comment">// 这里Drag响应的目标组件貌似是Graph的ContentContainer,</span></span><br><span class="line">                <span class="comment">// 所以要采用ContentContainer作为基础坐标系转换</span></span><br><span class="line">                Vector2 actualGraphPosition = TransformContentLocalMousePosToGraphPos(dragExitedEvent.localMousePosition);</span><br><span class="line">                AddGraphData(cloneGraphData, actualGraphPosition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定位置添加图数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;targetPos&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">AddGraphData</span>(<span class="params">BehaviourTreeGraphData graphData, Vector2? targetPos = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (graphData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许添加空图数据，添加图数据失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        graphData.RegenerateAllNodeGUID();</span><br><span class="line">        <span class="keyword">if</span> (targetPos != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            graphData.MoveToTargetPosition((Vector2)targetPos);</span><br><span class="line">        &#125;</span><br><span class="line">        CreateGraphAllNodes(graphData, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        CreateGraphAllEdges(graphData, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;添加指定Graph:<span class="subst">&#123;graphData.name&#125;</span>数据到指定位置成功！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *****</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GraphData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphData</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 克隆自身</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此方法会实现嵌套存储的SO Asset也会全部Clone</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BehaviourTreeGraphData <span class="title">CloneSelf</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> cloneGraphData = <span class="keyword">this</span>.Clone();</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>, length = AllNodeList.Count; index &lt; length; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            cloneGraphData.AllNodeList[index] = AllNodeList[index].CloneSelf();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cloneGraphData;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点数据基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseNode</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 克隆自身</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此方法实现嵌套存储的SO Asset也全部Clone</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> BaseNode <span class="title">CloneSelf</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.Clone();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ScriptableObjectExtension.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ScriptableObjectExtension.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ScriptableObject扩展类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ScriptableObjectExtension</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 泛型ScriptableObject克隆扩展方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">Clone</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> T scriptableObject</span>) <span class="keyword">where</span> T : ScriptableObject</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (scriptableObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;ScriptableObject is null. Returning default <span class="subst">&#123;<span class="keyword">typeof</span>(T)&#125;</span> object.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> (T)ScriptableObject.CreateInstance(<span class="keyword">typeof</span>(T));</span><br><span class="line">        &#125;</span><br><span class="line">        T instance = Object.Instantiate(scriptableObject);</span><br><span class="line">        <span class="comment">// remove (Clone) from name</span></span><br><span class="line">        instance.name = scriptableObject.name;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/GraphDataReusing.PNG" alt="GraphDataReusing"></p>
<p>这里就不展示所有代码了，核心就是通过DragExitedEvent监听拖拽到图上的Asset判定是否是支持的图Asset，是的话直接读取图Asset然后通过Clone的方式实现深拷贝一个图Asset数据进行动态图数据添加。</p>
<p>实现ScriptableObject深拷贝的核心是通过扩展ScriptableObjectClone泛型方法实现通用的ScriptableObject克隆。</p>
<p>克隆之后的图Asset数据进行所有节点GUID的重新生成避免GUID重复问题。</p>
<p>潜在设计和可优化点:</p>
<ol>
<li><strong>目前的克隆实现是图数据实例化克隆，克隆后的数据跟原始图数据没有任何关系了，既无法直接通过修改克隆数据修改原始图数据，果想做像BehaviorDesginer图数据直接重用，需要支持一个图数据节点类型，然后在运行时读取图数据节点原始指向数据进行真是图数据克隆(注意排除重复的根节点)。图数据节点的调试可以分为Editor只查看图数据节点，而运行时查看真是图数据克隆还原后的树结构。</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>目前克隆图数据是连带根节点也复制了，如果不需要请自行删除根节点</strong></li>
</ol>
<h4 id="节点数据复制"><a href="#节点数据复制" class="headerlink" title="节点数据复制"></a>节点数据复制</h4><p><strong>前面已经实现了图数据的重用，节点数据的复制重用原理是类似的，核心就是将所有的节点数据(NodeData)通过克隆并重新生成新的GUID再添加并创建对应NodeView显示(为了避免新复制的节点重叠，会添加一定的位置偏移)，然后将所有的边数据(EdgeData)克隆并按照新生成的节点GUID重新修改边数据相关的节点GUID数据并创建对应EdgeView显示即可。</strong></p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 复制指定节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;duplicateNodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">DuplicateNodeView</span>(<span class="params">NodeView duplicateNodeView, <span class="built_in">bool</span> recusive = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Undo.RecordObject(SourceGraphData, <span class="string">$&quot;DuplicateNodeView(<span class="subst">&#123;recusive&#125;</span>)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> allNodeViews = <span class="keyword">new</span> List&lt;NodeView&gt;();</span><br><span class="line">        allNodeViews.Add(duplicateNodeView);</span><br><span class="line">        <span class="keyword">var</span> allNodeOuputEdgeViews = <span class="keyword">new</span> List&lt;EdgeView&gt;();</span><br><span class="line">        <span class="keyword">if</span>(recusive)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> allChildNodeViews = GetAllChildNodeViews(duplicateNodeView, recusive);</span><br><span class="line">            allNodeViews.AddRange(allChildNodeViews);</span><br><span class="line">            <span class="keyword">var</span> allChildOutputEdgeViews = GetAllChildOutputEdgeViews(duplicateNodeView, recusive);</span><br><span class="line">            allNodeOuputEdgeViews.AddRange(allChildOutputEdgeViews);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> allNewNodeDatas = <span class="keyword">new</span> List&lt;BaseNode&gt;();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> nodeView <span class="keyword">in</span> allNodeViews)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> oldNodeData = nodeView.NodeData;</span><br><span class="line">            <span class="keyword">var</span> newNodeData = oldNodeData.CloneSelf();</span><br><span class="line">            allNewNodeDatas.Add(newNodeData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// EdgeData是靠Serializable序列化而非ScriptableObject</span></span><br><span class="line">        <span class="comment">// 所以EdgeData无法直接通过ScriptableObject.CloneSelf()的方式复制</span></span><br><span class="line">        <span class="comment">// 这里只能EdgeData自身实现CloneSelf()的方式去复制EdgeData</span></span><br><span class="line">        <span class="keyword">var</span> allNewEdgeDatas = <span class="keyword">new</span> List&lt;EdgeData&gt;();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> edgeView <span class="keyword">in</span> allNodeOuputEdgeViews)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> oldEdgeData = edgeView.EdgeData;</span><br><span class="line">            <span class="keyword">var</span> newEdgeData = oldEdgeData.CloneSelf();</span><br><span class="line">            allNewEdgeDatas.Add(newEdgeData);</span><br><span class="line">        &#125;</span><br><span class="line">        CommonUtilities.RegenerateAllNodeGUID(allNewNodeDatas, allNewEdgeDatas);</span><br><span class="line">        CommonUtilities.MoveAllNodePosByOffset(allNewNodeDatas, BTGraphConstEditor.DumplicateNodePositionOffset);</span><br><span class="line">        <span class="comment">// 添加并创建所有新的NodeView和EdgeView</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> newNodeData <span class="keyword">in</span> allNewNodeDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateNodeByNodeData(SourceGraphData, newNodeData, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> newEdgeData <span class="keyword">in</span> allNewEdgeDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateEdgeByEdgeData(SourceGraphData, newEdgeData, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定NodeView的所有子节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不含节点View自身</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;NodeView&gt; <span class="title">GetAllChildNodeViews</span>(<span class="params">NodeView nodeView, <span class="built_in">bool</span> recusive = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> allChildNodeViews = <span class="keyword">new</span> List&lt;NodeView&gt;();</span><br><span class="line">        GetAllChildNodeViewsRecusive(nodeView, <span class="keyword">ref</span> allChildNodeViews, recusive);</span><br><span class="line">        <span class="keyword">return</span> allChildNodeViews;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定NodeView的所有子节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;allChildNodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetAllChildNodeViewsRecusive</span>(<span class="params">NodeView nodeView, <span class="keyword">ref</span> List&lt;NodeView&gt; allChildNodeView, <span class="built_in">bool</span> recusive = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> allOuputPortList = nodeView.outputContainer.Query&lt;Port&gt;().ToList();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> outputPort <span class="keyword">in</span> allOuputPortList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> edge <span class="keyword">in</span> outputPort.connections)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> outputNodeView = edge.input.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                <span class="comment">// 避免搜索循环</span></span><br><span class="line">                <span class="keyword">if</span> (outputNodeView != <span class="literal">null</span> &amp;&amp; !allChildNodeView.Contains(outputNodeView))</span><br><span class="line">                &#123;</span><br><span class="line">                    allChildNodeView.Add(outputNodeView);</span><br><span class="line">                    <span class="keyword">if</span> (recusive)</span><br><span class="line">                    &#123;</span><br><span class="line">                        GetAllChildNodeViewsRecusive(outputNodeView, <span class="keyword">ref</span> allChildNodeView, recusive);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定NodeView的所有输出端口边EdgeView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 只有递归时会包含传入NodeView的所有输出端口边EdgeView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;EdgeView&gt; <span class="title">GetAllChildOutputEdgeViews</span>(<span class="params">NodeView nodeView, <span class="built_in">bool</span> recusive = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> allChildOutputEdgeViews = <span class="keyword">new</span> List&lt;EdgeView&gt;();</span><br><span class="line">        <span class="keyword">if</span>(recusive)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> nodeAllDirectOutputEdgeViews = GetAllDirectChildOutputEdgeViews(nodeView);</span><br><span class="line">            allChildOutputEdgeViews.AddRange(nodeAllDirectOutputEdgeViews);</span><br><span class="line">            <span class="keyword">var</span> allChildNodeViews = GetAllChildNodeViews(nodeView, recusive);</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">var</span> childNodeView <span class="keyword">in</span> allChildNodeViews)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> childAllDirectChildOutputEdgeViews = GetAllDirectChildOutputEdgeViews(childNodeView);</span><br><span class="line">                allChildOutputEdgeViews.AddRange(childAllDirectChildOutputEdgeViews);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allChildOutputEdgeViews;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定NodeData的NodeView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span>所属图数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>自定义节点数据(传这个时不创建新节点Node)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;addNodeData&quot;&gt;</span>是否添加节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span>是否开启Undo系统<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NodeView <span class="title">CreateNodeByNodeData</span>(<span class="params">BehaviourTreeGraphData graphData, BaseNode nodeData, <span class="built_in">bool</span> addNodeData = <span class="literal">true</span>, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (graphData == <span class="literal">null</span> || nodeData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许传递空图数据或空节点数据创建显示节点！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        BaseNode newNode = <span class="literal">null</span>;</span><br><span class="line">        newNode = nodeData;</span><br><span class="line">        nodeData.Init(nodeData.GUID, nodeData.Position, nodeData.NodeState, nodeData.IsEnteredAbort);</span><br><span class="line">        <span class="keyword">var</span> typeInfo = nodeData.GetType();</span><br><span class="line">        <span class="keyword">var</span> nodeView = BTGraphUtilitiesEditor.CreateNodeViewInstance(typeInfo);</span><br><span class="line">        nodeView.Init(graphData, newNode, OnNodeSelected, <span class="literal">null</span>, GraphOrientation);</span><br><span class="line">        <span class="keyword">if</span> (addNodeData)</span><br><span class="line">        &#123;</span><br><span class="line">            AddNodeData(nodeData, enableUndoSystem);</span><br><span class="line">        &#125;</span><br><span class="line">        AddElement(nodeView);</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeData.Position);</span><br><span class="line">        <span class="keyword">return</span> nodeView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定EdgeData的EdgeView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;addEdgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EdgeView <span class="title">CreateEdgeByEdgeData</span>(<span class="params">BehaviourTreeGraphData graphData, EdgeData edgeData, <span class="built_in">bool</span> addEdgeData = <span class="literal">true</span>, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (graphData == <span class="literal">null</span> || edgeData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许传递空图数据或空边点数据创建显示边！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (addEdgeData)</span><br><span class="line">        &#123;</span><br><span class="line">            AddEdgeData(edgeData, enableUndoSystem);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 为了支持动态边的创建和加载还原</span></span><br><span class="line">        <span class="comment">// 如果不存在的端口和边数据则动态创建并连接</span></span><br><span class="line">        <span class="keyword">var</span> outputNode = GetNodeByGuid(edgeData.OutputNodeGUID) <span class="keyword">as</span> NodeView;</span><br><span class="line">        <span class="keyword">var</span> outputPort = GetOrCreateOutputPort(outputNode, edgeData.OutputPortName, edgeData.OutputPortTypeFullName);</span><br><span class="line">        <span class="keyword">var</span> inputNode = GetNodeByGuid(edgeData.InputNodeGUID) <span class="keyword">as</span> NodeView;</span><br><span class="line">        <span class="keyword">var</span> inputPort = GetOrCreateInputPort(inputNode, edgeData.InputPortName, edgeData.InputPortTypeFullName);</span><br><span class="line">        <span class="keyword">var</span> edgeView = AddEdgeView(edgeData, inputPort, outputPort);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;创建输出节点GUID:<span class="subst">&#123;edgeData.OutputNodeGUID&#125;</span>的端口名:<span class="subst">&#123;edgeData.OutputPortName&#125;</span>和输入节点GUID:<span class="subst">&#123;edgeData.InputNodeGUID&#125;</span>的端口名:<span class="subst">&#123;edgeData.InputPortName&#125;</span>边！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> edgeView <span class="keyword">as</span> EdgeView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EdgeData.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> EdgeData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 边数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EdgeData</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 克隆EdgeData</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EdgeData <span class="title">CloneSelf</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> newEdgeData = <span class="keyword">new</span> EdgeData(GUID, OutputNodeGUID, OutputPortName, OutputPortTypeFullName, InputNodeGUID, InputPortName, InputPortTypeFullName);</span><br><span class="line">        <span class="keyword">return</span> newEdgeData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>节点复制流程如下：</p>
<ol>
<li>通过需要复制的NodeView找到所有相关联的NodeView和EdgeView</li>
<li>然后通过找到的NodeView和EdgeView获取到所有对应的BaseNode和EdgeData并调用CloneSelf()进行数据复制</li>
<li>然后通过将复制的BaseNode和EdgeData进行所有节点GUID数据重新随机的方式更新新节点GUID(<strong>CommonUtilities.RegenerateAllNodeGUID()</strong>)</li>
<li>为了避免复制节点重叠，统一将复制的节点数据做位置偏移(<strong>CommonUtilities.MoveAllNodePosByOffset()</strong>)</li>
<li>使用新的节点数据和边数据创建对应新的对应NodeView和EdgeView即完成节点数据复制</li>
</ol>
<p><img src="/img/Unity/UIToolkit/RecusiveCopyNode.PNG" alt="RecusiveCopyNode"></p>
<p>Note:</p>
<ol>
<li><strong>因为节点复制后，第一个节点的父节点不一定支持多个子节点相连(比如修饰节点只允许一个子节点)，所以节点复制会排除第一个节点的输入端口边数据，剩余节点和边数据全部复制。</strong></li>
<li><strong>EdgeData并非继承至ScriptableObejct，所以Clone需要自行实现CloneSelf方法。</strong></li>
</ol>
<h4 id="黑板数据"><a href="#黑板数据" class="headerlink" title="黑板数据"></a>黑板数据</h4><p>黑板数据可以简单的理解成一个共享数据的地方，每棵树可以快速访问修改黑板上的公共数据作为临时数据使用。</p>
<h5 id="黑板数据运行时存储"><a href="#黑板数据运行时存储" class="headerlink" title="黑板数据运行时存储"></a>黑板数据运行时存储</h5><p><strong>黑板数据的核心设计是一个K-V结构的Map容器(结合泛型的设计支持不同类型的数据访问)，通过统一的数据访问方式实现行为树统一的数据访问。</strong></p>
<p>首先我们来看看黑板是如何使用泛型快速支持多种数据类型存储的:</p>
<p>Blackboard.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板数据接口抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseBlackboardData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板数据变量名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;变量名&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseBlackboardData</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板数据泛型基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BlackboardData</span>&lt;<span class="title">T</span>&gt; : <span class="title">BaseBlackboardData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> T Data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BlackboardData</span>(<span class="params"><span class="built_in">string</span> name, T data</span>) : <span class="title">base</span>(<span class="params">name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板模式，数据共享中心</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Blackboard</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板数据集合中心</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, BaseBlackboardData&gt; mBlackboardDataMap;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以看到首先定义了字符串Key作为黑板数据的唯一标识的BaseBlackboardData基类，然后通过泛型子类BlackboardData<T>支持不同类型的数据泛型支持。</strong></p>
<h5 id="黑板数据运行时驱动和通知"><a href="#黑板数据运行时驱动和通知" class="headerlink" title="黑板数据运行时驱动和通知"></a>黑板数据运行时驱动和通知</h5><p><strong>事件驱动的行为树黑板和常规Update驱动行为树的黑板最大的不同就是Clock(定时器)+监听者模式组成。</strong></p>
<p>为什么事件驱动的行为树黑板也是Clock驱动了？</p>
<ol>
<li><strong>为了避免不必要的Update更新驱动</strong></li>
<li><strong>统一Clock驱动能更好的处理行为树的Update驱动和黑板通知的顺序逻辑</strong></li>
<li><strong>如果行为树在更新中，缓一帧再通知能有效避免通知系统遍历过程中插入删除的情况</strong></li>
</ol>
<p>Blackboard.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板模式，数据共享中心</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Blackboard</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板操作类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> BBOperationType</span><br><span class="line">    &#123;</span><br><span class="line">        ADD,</span><br><span class="line">        REMOVE,</span><br><span class="line">        CHANGE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通知数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">struct</span> Notification</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 操作Key</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> key;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 黑板操作类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> BBOperationType type;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 操作值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">object</span> <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Notification</span>(<span class="params"><span class="built_in">string</span> key, BBOperationType type, <span class="built_in">object</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.type = type;</span><br><span class="line">            <span class="keyword">this</span>.<span class="keyword">value</span> = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;noNotification&quot;&gt;</span>是否不通知(默认通知)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T <span class="keyword">value</span> = <span class="literal">default</span>, <span class="built_in">bool</span> noNotification = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> data = GetBlackboardData(key);</span><br><span class="line">        <span class="keyword">if</span> (data != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> targetData = data <span class="keyword">as</span> BlackboardData&lt;T&gt;;</span><br><span class="line">            <span class="keyword">if</span> (targetData == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;黑板数据里Key:<span class="subst">&#123;key&#125;</span>的数据类型和更新数据类型:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>不匹配，更新数据失败！&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            targetData.Data = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span>(!noNotification)</span><br><span class="line">            &#123;</span><br><span class="line">                mNotifications.Add(<span class="keyword">new</span> Notification(key, BBOperationType.CHANGE, <span class="keyword">value</span>));</span><br><span class="line">                mClock.AddTimer(<span class="number">0f</span>, <span class="number">0</span>, NotifiyObservers);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            BlackboardData&lt;T&gt; targetData = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            mBlackboardDataMap.Add(key, targetData);</span><br><span class="line">            <span class="keyword">if</span> (!noNotification)</span><br><span class="line">            &#123;</span><br><span class="line">                mNotifications.Add(<span class="keyword">new</span> Notification(key, BBOperationType.ADD, <span class="keyword">value</span>));</span><br><span class="line">                mClock.AddTimer(<span class="number">0f</span>, <span class="number">0</span>, NotifiyObservers);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通知</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">NotifiyObservers</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mNotifications.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mNotificationsDispatch.Clear();</span><br><span class="line">            mNotificationsDispatch.AddRange(mNotifications);</span><br><span class="line">            mNotifications.Clear();</span><br><span class="line"></span><br><span class="line">            mIsNotifying = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (Notification notification <span class="keyword">in</span> mNotificationsDispatch)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.mObservers.ContainsKey(notification.key))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//                Debug.Log(&quot;1 do not notify for key:&quot; + notification.key + &quot; value: &quot; + notification.value);</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                List&lt;System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt; observers = GetObserverList(<span class="keyword">this</span>.mObservers, notification.key);</span><br><span class="line">                <span class="keyword">foreach</span> (System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt; observer <span class="keyword">in</span> observers)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.mRemoveObservers.ContainsKey(notification.key) &amp;&amp; <span class="keyword">this</span>.mRemoveObservers[notification.key].Contains(observer))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    observer(notification.type, notification.<span class="keyword">value</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">string</span> key <span class="keyword">in</span> <span class="keyword">this</span>.mAddObservers.Keys)</span><br><span class="line">            &#123;</span><br><span class="line">                GetObserverList(<span class="keyword">this</span>.mObservers, key).AddRange(<span class="keyword">this</span>.mAddObservers[key]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">string</span> key <span class="keyword">in</span> <span class="keyword">this</span>.mRemoveObservers.Keys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt; action <span class="keyword">in</span> mRemoveObservers[key])</span><br><span class="line">                &#123;</span><br><span class="line">                    GetObserverList(<span class="keyword">this</span>.mObservers, key).Remove(action);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.mAddObservers.Clear();</span><br><span class="line">            <span class="keyword">this</span>.mRemoveObservers.Clear();</span><br><span class="line"></span><br><span class="line">            mIsNotifying = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到对于黑板的增删改操作类型和通知都做了对应类型定义和封装，通过Clock开启数据相关操作(增删改)通知。</p>
<p>黑板作为单棵行为树的公共数据存储的地方，每个行为树构建时都会传入对应的一个黑板对象:</p>
<p>TBehaviourTree.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TBehaviourTree.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TBehaviourTree</span> : <span class="title">IRecycle</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 运行时的行为树数据(Clone反序列化原始数据BTOriginalGraph而来)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BehaviourTreeGraphData BTRunningGraph</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 行为树定时器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Clock BehaviourTreeClock</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bindUID&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"><span class="built_in">int</span> bindUID</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        BehaviourTreeClock = <span class="keyword">new</span> Clock();</span><br><span class="line">        UpdateBindUID(bindUID);</span><br><span class="line">        RegisterBehaviourTree();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载行为树图数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetPath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadBTGraphData</span>(<span class="params"><span class="built_in">string</span> assetPath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ReleaseBTGraphAsset();</span><br><span class="line">        BTOriginalGraph = TBehaviourTreeManager.Singleton.GetCacheBTGraph(assetPath);</span><br><span class="line">        <span class="keyword">if</span>(BTOriginalGraph == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> btGraphAsset = Resources.Load&lt;BehaviourTreeGraphData&gt;(assetPath);</span><br><span class="line">            BTOriginalGraph = btGraphAsset;</span><br><span class="line">            TBehaviourTreeManager.Singleton.CacheBTGraph(assetPath, BTOriginalGraph);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        BTRunningGraph = BTOriginalGraph?.CloneSelf();</span><br><span class="line">        BTRunningGraph?.SetBTOwner(<span class="keyword">this</span>);</span><br><span class="line">        BTRunningGraph?.InitRuntimeDatas(BehaviourTreeClock);</span><br><span class="line">        BTRunningGraph?.Start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看出，每棵行为树(TBehaviourTree)运行时都够建了一个新的Clock(TBehaviourTree.BehaviourTreeClock)用于驱动整棵树的更新。</p>
<h5 id="黑板数据编辑器编辑和存储加载"><a href="#黑板数据编辑器编辑和存储加载" class="headerlink" title="黑板数据编辑器编辑和存储加载"></a>黑板数据编辑器编辑和存储加载</h5><p>前面提到的都是行为树黑板运行时部分，那编辑器的行为树数据是如何存储？编辑器编辑的行为树数据又是如何读取到运行时使用的了？</p>
<p>Dictionary&lt;string, BaseBlackboardData&gt; mBlackboardDataMap是不支持序列化的结构，所以编辑器的黑板数据存储和修改还需要独立定义。</p>
<p>BlackboardData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BlackboardDataType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板数据类型枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> BlackboardDataType</span><br><span class="line">&#123;</span><br><span class="line">    Bool = <span class="number">1</span>,</span><br><span class="line">    Int,</span><br><span class="line">    Float,</span><br><span class="line">    String,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BlackboardData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BlackboardData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有Bool变量定义数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Bool变量黑板数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;BlackboardData&lt;<span class="built_in">bool</span>&gt;&gt; AllBoolDataList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有Int变量定义数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Int变量黑板数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;BlackboardData&lt;<span class="built_in">int</span>&gt;&gt; AllIntDataList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有Float变量定义数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Float变量黑板数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;BlackboardData&lt;<span class="built_in">float</span>&gt;&gt; AllFloatDataList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有String变量定义数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;String变量黑板数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;BlackboardData&lt;<span class="built_in">string</span>&gt;&gt; AllStringDataList;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加指定黑板数据类型和数据名的黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;blackboardDataType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">AddDataByType</span>(<span class="params">BlackboardDataType blackboardDataType, <span class="built_in">string</span> key</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ExistData(key))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;黑板数据里已存在Key:<span class="subst">&#123;key&#125;</span>的数据，添加数据失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (blackboardDataType == BlackboardDataType.Bool)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AddData&lt;<span class="built_in">bool</span>&gt;(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (blackboardDataType == BlackboardDataType.Int)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AddData&lt;<span class="built_in">int</span>&gt;(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (blackboardDataType == BlackboardDataType.Float)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AddData&lt;<span class="built_in">float</span>&gt;(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (blackboardDataType == BlackboardDataType.String)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AddData&lt;<span class="built_in">string</span>&gt;(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不支持的黑板变量类型:<span class="subst">&#123;blackboardDataType&#125;</span>，添加数据名:<span class="subst">&#123;key&#125;</span>数据失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加指定变量类型和数据名的黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">AddData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T <span class="keyword">value</span> = <span class="literal">default</span>(T</span>))</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ExistData(key))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;黑板数据里已存在Key:<span class="subst">&#123;key&#125;</span>的数据，添加数据失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> dataType = <span class="keyword">typeof</span>(T);</span><br><span class="line">        <span class="keyword">if</span>(dataType == CommonGraphConst.BoolType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> data = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            AllBoolDataList.Add(data <span class="keyword">as</span> BlackboardData&lt;<span class="built_in">bool</span>&gt;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (dataType == CommonGraphConst.IntType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> data = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            AllIntDataList.Add(data <span class="keyword">as</span> BlackboardData&lt;<span class="built_in">int</span>&gt;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (dataType == CommonGraphConst.FloatType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> data = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            AllFloatDataList.Add(data <span class="keyword">as</span> BlackboardData&lt;<span class="built_in">float</span>&gt;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (dataType == CommonGraphConst.StringType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> data = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            AllStringDataList.Add(data <span class="keyword">as</span> BlackboardData&lt;<span class="built_in">string</span>&gt;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不支持的黑板变量类型:<span class="subst">&#123;dataType.Name&#125;</span>，添加数据名:<span class="subst">&#123;key&#125;</span>数据失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BehaviourTreeGraphData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphData</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;黑板数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> BlackboardData BlackboardData;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BehaviourTreeGraphData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        AllNodeList = <span class="keyword">new</span> List&lt;BaseNode&gt;();</span><br><span class="line">        AllEdgeDataList = <span class="keyword">new</span> List&lt;EdgeData&gt;();</span><br><span class="line">        OwnerBT = <span class="literal">null</span>;</span><br><span class="line">        TreeDataList = <span class="keyword">new</span> List&lt;TreeData&gt;();</span><br><span class="line">        BlackboardData = <span class="keyword">new</span> BlackboardData();</span><br><span class="line">        Clock = <span class="literal">null</span>;</span><br><span class="line">        Blackboard = <span class="literal">null</span>;</span><br><span class="line">        RootTree = <span class="literal">null</span>;</span><br><span class="line">        mInitRunTimeDataComplete = <span class="literal">false</span>;</span><br><span class="line">        mTempEdgeDataList = <span class="keyword">new</span> List&lt;EdgeData&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化运行时数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InitRuntimeDatas</span>(<span class="params">Clock clock</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitClock(clock);</span><br><span class="line">        InitBlackboard();</span><br><span class="line">        InitTreeDatas();</span><br><span class="line">        mInitRunTimeDataComplete = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化共享黑板</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitBlackboard</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Blackboard = <span class="keyword">new</span> Blackboard(Clock);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> boolVariableData <span class="keyword">in</span> BlackboardData.AllBoolDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardData&lt;<span class="built_in">bool</span>&gt;(boolVariableData.Name, boolVariableData.Data, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> intVariableData <span class="keyword">in</span> BlackboardData.AllIntDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardData&lt;<span class="built_in">int</span>&gt;(intVariableData.Name, intVariableData.Data, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> floatVariableData <span class="keyword">in</span> BlackboardData.AllFloatDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardData&lt;<span class="built_in">float</span>&gt;(floatVariableData.Name, floatVariableData.Data, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> stringVariableData <span class="keyword">in</span> BlackboardData.AllStringDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardData&lt;<span class="built_in">string</span>&gt;(stringVariableData.Name, stringVariableData.Data, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Blackboard.PrintAllBlackBoardDatas();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UIBTGraphEditorWindow.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图窗口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建黑板UI面板</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateBlackboardUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rightPanelVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.RightPanelVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> rightVerticalContentLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">        rightVerticalContentLabelTitle.text = <span class="string">&quot;黑板面板&quot;</span>;</span><br><span class="line">        rightVerticalContentLabelTitle.style.height = <span class="number">20f</span>;</span><br><span class="line">        rightVerticalContentLabelTitle.style.alignSelf = Align.Center;</span><br><span class="line">        rightPanelVerticalContainer.Add(rightVerticalContentLabelTitle);</span><br><span class="line"></span><br><span class="line">        CreateBlackboardOperationUI();</span><br><span class="line">        CreateBlackboardDataUI();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建黑板数据UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateBlackboardDataUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rightPanelVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.RightPanelVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> blackboardDataVerticalContainer = UIToolkitUtilities.CreateVerticalContainer(BTGraphElementNames.BlackboardDataVerticalContainerName);</span><br><span class="line">        rightPanelVerticalContainer.Add(blackboardDataVerticalContainer);</span><br><span class="line"></span><br><span class="line">        UpdateBlackboardDataUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新黑板数据UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateBlackboardDataUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCurrentSelectedPanelType != PanelType.BLACKBOARD_PANEL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> blackboardDataVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.BlackboardDataVerticalContainerName);</span><br><span class="line">        blackboardDataVerticalContainer.Clear();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> variabletype <span class="keyword">in</span> mAvalibleVariableTypeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> variableTypeFoldOut = <span class="keyword">new</span> Foldout();</span><br><span class="line">            <span class="keyword">var</span> variableTypeTitle = BTGraphUtilitiesEditor.GetVariableTypeFoldTitle(variabletype);</span><br><span class="line">            variableTypeFoldOut.name = variableTypeTitle;</span><br><span class="line">            variableTypeFoldOut.viewDataKey = BTGraphUtilitiesEditor.GetVariableTypeFoldOutViewDataKeyName(variabletype);</span><br><span class="line">            variableTypeFoldOut.text = variableTypeTitle;</span><br><span class="line">            variableTypeFoldOut.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line"></span><br><span class="line">            blackboardDataVerticalContainer.Add(variableTypeFoldOut);</span><br><span class="line">            CreateVariableDataUI(variabletype);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定变量类型的变量数据UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;variableType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateVariableDataUI</span>(<span class="params">BlackboardDataType variableType</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!Application.isPlaying)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateEditorVariableDataUI(variableType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            CreateRuntimeVariableDataUI(variableType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应添加黑板变量数据按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;evt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnBlackboardAddVariableDataClick</span>(<span class="params">ClickEvent evt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;响应黑板添加变量数据按钮点击！&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> blackboardVariableInputText = rootVisualElement.Q&lt;TextField&gt;(BTGraphElementNames.BlackboardInputVariableTextName);</span><br><span class="line">        <span class="keyword">var</span> newVariableName = blackboardVariableInputText.<span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(newVariableName))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许添加空变量名的黑板数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Undo.RegisterCompleteObjectUndo(mGraphView.SourceGraphData, <span class="string">&quot;AddBlackboardData&quot;</span>);</span><br><span class="line">        PopupField&lt;BlackboardDataType&gt; variableTypePopField = rootVisualElement.Q&lt;PopupField&lt;BlackboardDataType&gt;&gt;(BTGraphElementNames.BlackboardVariableTypePopName);</span><br><span class="line">        <span class="keyword">var</span> newVariableType = variableTypePopField.<span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">if</span>(mGraphView.SourceGraphData.BlackboardData.AddDataByTyoe(newVariableType, newVariableName))</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardDataUI();</span><br><span class="line">            EditorUtility.SetDirty(mGraphView.SourceGraphData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新指定黑板变量和值的编辑器黑板数据值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;variableName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newValue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">UpdateEditorVariableData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> variableName, T newValue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;编辑器变量类型:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>的变量名:<span class="subst">&#123;variableName&#125;</span>值更新:<span class="subst">&#123;newValue&#125;</span>&quot;</span>);</span><br><span class="line">        Undo.RegisterCompleteObjectUndo(mGraphView.SourceGraphData, <span class="string">&quot;UpdateBlackboardData&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> result = mGraphView.SourceGraphData.BlackboardData.UpdaetValue&lt;T&gt;(variableName, newValue);</span><br><span class="line">        EditorUtility.SetDirty(mGraphView.SourceGraphData);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定黑板变量编辑器黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;variableName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">RemoveEditorVariableData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> variableName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;编辑器删除变量类型:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>的变量名:<span class="subst">&#123;variableName&#125;</span>数据！&quot;</span>);</span><br><span class="line">        Undo.RegisterCompleteObjectUndo(mGraphView.SourceGraphData, <span class="string">&quot;RemoveBlackboardData&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> result = mGraphView.SourceGraphData.BlackboardData.RemoveData&lt;T&gt;(variableName);</span><br><span class="line">        UpdateBlackboardDataUI();</span><br><span class="line">        EditorUtility.SetDirty(mGraphView.SourceGraphData);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到针对每一个<strong>行为树图数据(BehaviourTreeGraphData)<strong>都定义了一个</strong>BlackboardData(行为树编辑器黑板数据)</strong></p>
<p><strong>可以看到编辑器和运行时，UIBTGraphEditorWindow.CreateVariableDataUI()通过选择性读取BlackboardData或Blackboard数据进行黑板数据读取显示。</strong></p>
<p>编辑器模式下BehaviourTreeGraphData.BlackboardData支持序列化，然后通过创建UIToolkit的编辑器UI进行读取和修改BehaviourTreeGraphData.BlackboardData数据，从而实现编辑器对黑板数据的编辑和保存。</p>
<p>黑板数据操作UI界面展示:</p>
<p><img src="/"></p>
<p>Note:</p>
<ol>
<li><strong>目前的黑板设计是针对单棵行为树的，所以是局部黑板而非全局黑板(也就是多棵行为树之间无法通过黑板存储公共数据交流)。</strong></li>
</ol>
<h4 id="GraphView操作添加"><a href="#GraphView操作添加" class="headerlink" title="GraphView操作添加"></a>GraphView操作添加</h4><p>给GraphView添加额外操作功能(e.g. 节点拖拽，点击节点选择，方形选框节点选择，滚轮缩放 ……)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加所有Manipulator</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">AddAllManipulator</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.AddManipulator(<span class="keyword">new</span> ContentDragger());</span><br><span class="line">        <span class="keyword">this</span>.AddManipulator(<span class="keyword">new</span> SelectionDragger());</span><br><span class="line">        <span class="keyword">this</span>.AddManipulator(<span class="keyword">new</span> RectangleSelector());</span><br><span class="line">        <span class="keyword">this</span>.AddManipulator(<span class="keyword">new</span> ContentZoomer());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AddManipulator()是VisualElement的扩展方法，通过添加Manipulator我们可以快速实现对Element添加各种各样的操作功能，GraphView也继承至UIElement，所以通过上述几行代码我们成功的给图添加了框选，缩放等功能。</p>
<p><img src="/img/Unity/UIToolkit/NodeSelectionOperation.PNG" alt="NodeSelectionOperation"></p>
<h4 id="坐标转换"><a href="#坐标转换" class="headerlink" title="坐标转换"></a>坐标转换</h4><p>当我们的GraphView支持放大缩小时，我们点击创建节点的位置需要通过坐标转换才能得到正确的节点位置。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 转换Grid组件鼠标局部坐标到GraphView本地坐标</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;localMousePosition&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Vector2 <span class="title">TransformGridLocalMousePosToGraphPos</span>(<span class="params">Vector2 localMousePosition</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> gridElement = ElementAt(<span class="number">0</span>);</span><br><span class="line">        Vector2 worldMousePosition = contentContainer.ChangeCoordinatesTo(gridElement, localMousePosition);</span><br><span class="line">        Vector2 actualGraphPosition = contentViewContainer.WorldToLocal(worldMousePosition);</span><br><span class="line">        <span class="keyword">return</span> actualGraphPosition;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应NodeView子菜单栏创建节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnNodeViewSubMenuCreateNode</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menuUserData = menuAction.userData <span class="keyword">as</span> MenuUserData;</span><br><span class="line">        <span class="keyword">var</span> nodeType = menuUserData.CustomData <span class="keyword">as</span> Type;</span><br><span class="line">        Vector2 actualGraphPosition = TransformGridLocalMousePosToGraphPos(menuAction.eventInfo.localMousePosition);</span><br><span class="line">        <span class="keyword">var</span> nodeView = CreateNodeByType(nodeType, actualGraphPosition);</span><br><span class="line">        <span class="keyword">var</span> nodeViewPosition = nodeView.GetPosition();</span><br><span class="line">        nodeViewPosition.position = actualGraphPosition;</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeViewPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;CommonGraphView:OnNodeViewSubMenuCreateNode() NodeType:&#123;menuUserData.SourceNodeView.NodeData.NodeType&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;localMousePosition:&#123;menuAction.eventInfo.localMousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;mousePosition:&#123;menuAction.eventInfo.mousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;actualGraphPosition:&#123;actualGraphPosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 创建节点Port链接</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   ******   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先我们通过获取添加到根节点且铺满的Grid UIElement作为转换获取显示区域世界坐标的参考组件。</p>
<p>然后通过VisualElementExtension.ChangeCoordinatesTo()将通过DropdownMenuAction.eventInfo.localMousePosition得到鼠标局部点击坐标转换到网格的局部坐标(个人理解因为网格是铺满显示范围的，所以这里的局部坐标也就等价于世界坐标)。</p>
<p>最后将转换到网格的局部坐标(即世界坐标)通过VisualElementExtension.WorldToLocal()转换到我们节点目标显示父UIElement(contentViewContainer)坐标下得到对应局部坐标。</p>
<h4 id="数据保存和加载添加"><a href="#数据保存和加载添加" class="headerlink" title="数据保存和加载添加"></a>数据保存和加载添加</h4><p>数据保存和加载首先需要两步：</p>
<ol>
<li>创建操作UI</li>
<li>响应操作保存和加载数据</li>
</ol>
<p>UICommonGraphEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图窗口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建左侧操作内容</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateLeftOperationContent</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateSavePathContent();</span><br><span class="line">        CreateNodeOperationContent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建保存路径内容</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateSavePathContent</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> leftVerticalContentContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.LeftVerticalContentContainerName);</span><br><span class="line">        <span class="keyword">var</span> savePathHorizontalContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        savePathHorizontalContainer.style.left = <span class="number">0</span>;</span><br><span class="line">        savePathHorizontalContainer.style.right = <span class="number">0</span>;</span><br><span class="line">        savePathHorizontalContainer.style.height = <span class="number">20</span>;</span><br><span class="line">        savePathHorizontalContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        savePathHorizontalContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> savePathLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">        savePathLabelTitle.style.width = <span class="number">70f</span>;</span><br><span class="line">        savePathLabelTitle.style.unityTextAlign = TextAnchor.MiddleLeft;</span><br><span class="line">        savePathLabelTitle.style.alignSelf = Align.Center;</span><br><span class="line">        savePathLabelTitle.text = <span class="string">&quot;保存路径:&quot;</span>;</span><br><span class="line">        savePathHorizontalContainer.Add(savePathLabelTitle);</span><br><span class="line">        <span class="keyword">var</span> savePathTextField = <span class="keyword">new</span> TextField();</span><br><span class="line">        savePathTextField.name = BTGraphElementNames.SavePathTextFieldName;</span><br><span class="line">        savePathTextField.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        savePathTextField.style.flexShrink = <span class="number">1</span>;</span><br><span class="line">        savePathTextField.<span class="keyword">value</span> = mGraphSaveFolderPath;</span><br><span class="line">        savePathHorizontalContainer.Add(savePathTextField);</span><br><span class="line">        <span class="keyword">var</span> savePathButton = <span class="keyword">new</span> Button();</span><br><span class="line">        savePathButton.style.width = <span class="number">60</span>;</span><br><span class="line">        savePathButton.text = <span class="string">&quot;修改&quot;</span>;</span><br><span class="line">        savePathHorizontalContainer.Add(savePathButton);</span><br><span class="line">        <span class="comment">// 注册按钮点击</span></span><br><span class="line">        savePathButton.RegisterCallback&lt;ClickEvent&gt;(OnSavePathButtonClick);</span><br><span class="line">        leftVerticalContentContainer.Add(savePathHorizontalContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应保存路径按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clickEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnSavePathButtonClick</span>(<span class="params">ClickEvent clickEvent</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;保存路径按钮点击！&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> newSavePath = EditorUtility.OpenFolderPanel(<span class="string">&quot;保存路径&quot;</span>, mGraphSaveFolderPath, <span class="built_in">string</span>.Empty);</span><br><span class="line">        <span class="keyword">if</span> (!AssetDatabase.IsValidFolder(newSavePath))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;请选择有效的Asset路径，此:<span class="subst">&#123;newSavePath&#125;</span>路径无效，修改保存路径失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(newSavePath))</span><br><span class="line">        &#123;</span><br><span class="line">            mGraphSaveFolderPath = newSavePath;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;更新保存路径:<span class="subst">&#123;newSavePath&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> savePathTextField = rootVisualElement.Q&lt;TextField&gt;(BTGraphElementNames.SavePathTextFieldName);</span><br><span class="line">            savePathTextField.<span class="keyword">value</span> = mGraphSaveFolderPath;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点操作面板</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateNodeOperationContent</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> leftVerticalContentContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.LeftVerticalContentContainerName);</span><br><span class="line">        <span class="keyword">var</span> assetSelectionHorizontalContainer = UIToolkitUtilities.CreateHorizontalContainer(BTGraphElementNames.AssetSelectionHorizontalContainerName,</span><br><span class="line">                                                                                             <span class="number">0f</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">default</span>(StyleColor));</span><br><span class="line">        assetSelectionHorizontalContainer.style.height = <span class="number">20f</span>;</span><br><span class="line">        leftVerticalContentContainer.Add(assetSelectionHorizontalContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> assetSelectionTitleLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        assetSelectionTitleLabel.text = <span class="string">&quot;Asset:&quot;</span>;</span><br><span class="line">        assetSelectionTitleLabel.style.width = <span class="number">70f</span>;</span><br><span class="line">        assetSelectionTitleLabel.style.unityTextAlign = TextAnchor.MiddleLeft;</span><br><span class="line">        assetSelectionTitleLabel.style.alignSelf = Align.Center;</span><br><span class="line">        assetSelectionHorizontalContainer.Add(assetSelectionTitleLabel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> assetSelectionObjectField = <span class="keyword">new</span> ObjectField();</span><br><span class="line">        assetSelectionObjectField.objectType = GetGraphViewDataType();</span><br><span class="line">        assetSelectionObjectField.name = BTGraphElementNames.AssetSelectionName;</span><br><span class="line">        assetSelectionObjectField.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        assetSelectionObjectField.style.width = <span class="number">210</span>;</span><br><span class="line">        assetSelectionObjectField.allowSceneObjects = <span class="literal">false</span>;</span><br><span class="line">        assetSelectionObjectField.RegisterValueChangedCallback(OnAssetSelectionValueChange);</span><br><span class="line">        assetSelectionHorizontalContainer.Add(assetSelectionObjectField);</span><br><span class="line">        UpdateAssetSelectionValue();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> newGraphButton = <span class="keyword">new</span> Button();</span><br><span class="line">        newGraphButton.name = BTGraphElementNames.SaveButtonName;</span><br><span class="line">        newGraphButton.text = <span class="string">&quot;新建&quot;</span>;</span><br><span class="line">        newGraphButton.style.height = <span class="number">20</span>;</span><br><span class="line">        leftVerticalContentContainer.Add(newGraphButton);</span><br><span class="line">        <span class="comment">// 注册导出按钮点击</span></span><br><span class="line">        newGraphButton.RegisterCallback&lt;ClickEvent&gt;(OnNewGraphButtonClick);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> saveButton = <span class="keyword">new</span> Button();</span><br><span class="line">        saveButton.name = BTGraphElementNames.SaveButtonName;</span><br><span class="line">        saveButton.text = <span class="string">&quot;保存&quot;</span>;</span><br><span class="line">        saveButton.style.height = <span class="number">20</span>;</span><br><span class="line">        leftVerticalContentContainer.Add(saveButton);</span><br><span class="line">        <span class="comment">// 注册导出按钮点击</span></span><br><span class="line">        saveButton.RegisterCallback&lt;ClickEvent&gt;(OnSaveButtonClick);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新选中Asset</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateAssetSelectionValue</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> assetSelectionObjectField = rootVisualElement.Q&lt;ObjectField&gt;(BTGraphElementNames.AssetSelectionName); ;</span><br><span class="line">        <span class="keyword">if</span> (assetSelectionObjectField != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            assetSelectionObjectField.<span class="keyword">value</span> = mSelectedGraphData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应选中Asset变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetSelected&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnAssetSelectionValueChange</span>(<span class="params">ChangeEvent&lt;UnityEngine.Object&gt; assetSelected</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> previewAssetName = assetSelected.previousValue != <span class="literal">null</span> ? assetSelected.previousValue.name : <span class="built_in">string</span>.Empty;</span><br><span class="line">        <span class="keyword">var</span> newAssetName = assetSelected.newValue != <span class="literal">null</span> ? assetSelected.newValue.name : <span class="built_in">string</span>.Empty;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;响应Asset选择变化，从:<span class="subst">&#123;previewAssetName&#125;</span>到:<span class="subst">&#123;newAssetName&#125;</span>&quot;</span>);</span><br><span class="line">        UpdateSelectedGraphData(assetSelected.newValue <span class="keyword">as</span> BehaviourTreeGraphData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应保存按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clickEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnSaveButtonClick</span>(<span class="params">ClickEvent clickEvent</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Application.isPlaying)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarning(<span class="string">$&quot;运行时不允许保存操作！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(mGraphSaveFileName))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许保存空文件名！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> graphDataPath = Path.Combine(mGraphSaveFolderPath, mGraphSaveFileName);</span><br><span class="line">        graphDataPath = PathUtilities.GetRegularPath(graphDataPath);</span><br><span class="line">        <span class="keyword">var</span> graphData = mGraphView.SourceGraphData;</span><br><span class="line">        <span class="keyword">if</span> (graphData != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> saveFodlerFullPath = PathUtilities.GetAssetFullPath(mGraphSaveFolderPath);</span><br><span class="line">            FolderUtilities.CheckAndCreateSpecificFolder(saveFodlerFullPath);</span><br><span class="line">            <span class="keyword">var</span> assetSourcePath = AssetDatabase.GetAssetPath(graphData);</span><br><span class="line">            assetSourcePath = PathUtilities.GetRegularPath(assetSourcePath);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(assetSourcePath))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="string">$&quot;目标Asset:<span class="subst">&#123;assetSourcePath&#125;</span>已存在本地！&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">string</span>.Equals(assetSourcePath, graphDataPath))</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;目标Asset:<span class="subst">&#123;graphDataPath&#125;</span>保存路径相同，直接保存！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;目标Asset:<span class="subst">&#123;assetSourcePath&#125;</span>保存路径不同，移动到:<span class="subst">&#123;graphDataPath&#125;</span>并保存！&quot;</span>);</span><br><span class="line">                    AssetDatabase.MoveAsset(assetSourcePath, graphDataPath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> targetPathAsset = AssetDatabase.LoadAssetAtPath&lt;UnityEngine.Object&gt;(graphDataPath);</span><br><span class="line">                <span class="keyword">if</span> (targetPathAsset != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    AssetDatabase.DeleteAsset(graphDataPath);</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;目标Assets不存在，但目标位置:<span class="subst">&#123;graphDataPath&#125;</span>存在同名Asset，删除同名Asset！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                AssetDatabase.CreateAsset(graphData, graphDataPath);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;目标Asset不存在，创建新Asset！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// BaseNode是继承至ScriptableObject的</span></span><br><span class="line">            <span class="comment">// 要想数据被正确序列化，需要将所有节点数据作为GraphData的SubAsset存储</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> node <span class="keyword">in</span> graphData.AllNodeList)</span><br><span class="line">            &#123;</span><br><span class="line">                AssetDatabase.RemoveObjectFromAsset(node);</span><br><span class="line">                AssetDatabase.AddObjectToAsset(node, graphData);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 删除因为Undo系统导致未及时删除的Node Asset</span></span><br><span class="line">            <span class="keyword">var</span> allSubAssets = AssetDatabase.LoadAllAssetsAtPath(graphDataPath);</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">var</span> subAsset <span class="keyword">in</span> allSubAssets)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> subNode = subAsset <span class="keyword">as</span> BaseNode;</span><br><span class="line">                <span class="keyword">if</span>(subNode != <span class="literal">null</span> &amp;&amp; graphData.GetNodeByGUID(subNode.GUID) == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;节点GUID:<span class="subst">&#123;subNode.GUID&#125;</span>Asset的逻辑对象不存在了，需要删除冗余Node Asset!&quot;</span>);</span><br><span class="line">                    AssetDatabase.RemoveObjectFromAsset(subAsset);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//调用Import更新状态</span></span><br><span class="line">            AssetDatabase.ImportAsset(graphDataPath);</span><br><span class="line">            AssetDatabase.SaveAssets();</span><br><span class="line">            Debug.Log(<span class="string">$&quot;保存图:<span class="subst">&#123;graphDataPath&#125;</span>数据成功！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许保存空图数据，保存图:<span class="subst">&#123;graphDataPath&#125;</span>数据失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新选中图数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateSelectedGraphData</span>(<span class="params">BehaviourTreeGraphData graphData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mGraphView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;未创建有效GraphView，清理之前的选中数据！&quot;</span>);</span><br><span class="line">            ClearSelectedGraphData();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mSelectedGraphData == graphData)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;选中了相同GraphData，不重复加载!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphData != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mSelectedGraphData = graphData;</span><br><span class="line">            mSelectedGraphAssetPath = mSelectedGraphData == <span class="literal">null</span> ? <span class="literal">null</span> : AssetDatabase.GetAssetPath(mSelectedGraphData);</span><br><span class="line">            mGraphSaveFolderPath = <span class="built_in">string</span>.IsNullOrEmpty(mSelectedGraphAssetPath) ? BTGraphConstEditor.DefaultGraphSaveFolderPath : Path.GetDirectoryName(mSelectedGraphAssetPath);</span><br><span class="line">            mGraphSaveFileName = <span class="built_in">string</span>.IsNullOrEmpty(mSelectedGraphAssetPath) ? BTGraphConstEditor.DefaultGraphSaveFileName : Path.GetFileName(mSelectedGraphAssetPath);</span><br><span class="line">            mGraphView.LoadGraphData(mSelectedGraphData);</span><br><span class="line">            UpdateAssetSelectionValue();</span><br><span class="line">            UpdateSelectedPanelUI();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">               </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/SaveAndLoadGraphData.PNG" alt="SaveAndLoadGraphData"></p>
<p>从上面可以看到，我实现以下几个功能:</p>
<ol>
<li>自定义文件名保存设置</li>
<li>自定义文件保存路径设置</li>
<li>自主图数据选择加载还原</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>图数据和节点数据采用的是ScriptableObject方式存储(为了方便通过PropertyField快速绑定ScriptableObject实现属性绑定显示)</strong></li>
<li><strong>ScriptableObject必须存储到本地，所以节点数据是作为子Asset添加到图数据ScriptableObject Asset上的</strong></li>
</ol>
<h4 id="撤销系统"><a href="#撤销系统" class="headerlink" title="撤销系统"></a>撤销系统</h4><p>所有针对ScriptableObject的数据操作，为了方便快速撤销，我们都会使用<strong>Ctrl+Z</strong>的快捷键，但Unity默认对ScriptableObject的修改是不会自动支持修改和快速撤销的，此时我们需要使用<strong>Undo</strong>相关的接口。</p>
<p>在我们对UnityEngine.Object对象(含ScriptableObejct)修改数据前，我们调用Undo.RecordObject()或者Undo.RegisterCompleteObjectUndo()，第一个参数传需要修改的UnityEngine.Object，第二个参数传一个自定义名字的字符串即可。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应GraphView变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphViewChange&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> GraphViewChange <span class="title">OnGraphViewChanged</span>(<span class="params">GraphViewChange graphViewChange</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;CommonGraphVIew:OnGraphViewChanged()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.elementsToRemove != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> elementToRemove <span class="keyword">in</span> graphViewChange.elementsToRemove)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (elementToRemove <span class="keyword">is</span> NodeView removeNodeView)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;删除节点GUID:<span class="subst">&#123;removeNodeView.NodeData.GUID&#125;</span>，节点数据类型:<span class="subst">&#123;removeNodeView.NodeData.GetType().Name&#125;</span>&quot;</span>);</span><br><span class="line">                    RemoveNodeData(removeNodeView.NodeData);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (elementToRemove <span class="keyword">is</span> Edge removeEdge)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> inputNodeView = removeEdge.input.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                    <span class="keyword">var</span> outputNodeView = removeEdge.output.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                    <span class="keyword">var</span> inputNodeViewName = inputNodeView != <span class="literal">null</span> ? inputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                    <span class="keyword">var</span> outputNodeViewName = outputNodeView != <span class="literal">null</span> ? outputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;删除边，Input节点名:<span class="subst">&#123;inputNodeViewName&#125;</span>，Input端口名:<span class="subst">&#123;removeEdge.input.portName&#125;</span>，Output节点名:<span class="subst">&#123;outputNodeViewName&#125;</span>，Output端口名:<span class="subst">&#123;removeEdge.output.portName&#125;</span>&quot;</span>);</span><br><span class="line">                    RemoveEdgeData(outputNodeView.NodeData.GUID, removeEdge.output.portName, inputNodeView.NodeData.GUID, removeEdge.input.portName);</span><br><span class="line">                    OnEdgeViewUpdate(removeEdge);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;TODO:删除其他Element类型:<span class="subst">&#123;elementToRemove.GetType().Name&#125;</span>！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.edgesToCreate != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> edgeToCreate <span class="keyword">in</span> graphViewChange.edgesToCreate)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> edgeView = edgeToCreate <span class="keyword">as</span> EdgeView;</span><br><span class="line">                <span class="keyword">var</span> inputNodeView = edgeToCreate.input.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                <span class="keyword">var</span> outputNodeView = edgeToCreate.output.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                <span class="keyword">var</span> inputNodeViewName = inputNodeView != <span class="literal">null</span> ? inputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                <span class="keyword">var</span> outputNodeViewName = outputNodeView != <span class="literal">null</span> ? outputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                <span class="keyword">var</span> ouputNodeGUID = outputNodeView.NodeData.GUID;</span><br><span class="line">                <span class="keyword">var</span> outputPortName = edgeToCreate.output.portName;</span><br><span class="line">                <span class="keyword">var</span> outputPortTypeFullName = edgeToCreate.output.portType.FullName;</span><br><span class="line">                <span class="keyword">var</span> inputNodeGUID = inputNodeView.NodeData.GUID;</span><br><span class="line">                <span class="keyword">var</span> intputPortName = edgeToCreate.input.portName;</span><br><span class="line">                <span class="keyword">var</span> intputPortTypeFullName = edgeToCreate.input.portType.FullName;</span><br><span class="line">                <span class="keyword">var</span> guid = Guid.NewGuid().ToString();</span><br><span class="line">                EdgeData edgeData = <span class="keyword">new</span> EdgeData(guid, ouputNodeGUID, outputPortName, outputPortTypeFullName, inputNodeGUID, intputPortName, intputPortTypeFullName);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;创建边，Input节点名:<span class="subst">&#123;inputNodeViewName&#125;</span>，Input端口名:<span class="subst">&#123;edgeToCreate.input.portName&#125;</span>，Output节点名:<span class="subst">&#123;outputNodeViewName&#125;</span>，Output端口名:<span class="subst">&#123;edgeToCreate.output.portName&#125;</span>&quot;</span>);</span><br><span class="line">                AddEdgeData(edgeData);</span><br><span class="line">                OnEdgeViewUpdate(edgeView);</span><br><span class="line">                <span class="comment">// 新增边不知道为什么在OnGraphViewChanged里触发时还未添加到connections里</span></span><br><span class="line">                <span class="comment">// 这里采取手动更新新增显示边的索引显示数据</span></span><br><span class="line">                UpdateEdgeViewIndex(edgeView);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.movedElements != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> moveElement <span class="keyword">in</span> graphViewChange.movedElements)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (moveElement <span class="keyword">is</span> NodeView moveNodeView)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;更新节点GUID:<span class="subst">&#123;moveNodeView.NodeData.GUID&#125;</span>，节点数据类型:<span class="subst">&#123;moveNodeView.NodeData.GetType().Name&#125;</span>的位置X:<span class="subst">&#123;moveNodeView.NodeData.Position.x&#125;</span> Y:<span class="subst">&#123;moveNodeView.NodeData.Position.y&#125;</span>&quot;</span>);</span><br><span class="line">                    UpdateNodeRectByNodeView(moveNodeView);</span><br><span class="line">                    OnNodeViewMove(moveNodeView);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;TODO:移动Element类型:<span class="subst">&#123;moveElement.GetType().Name&#125;</span>！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> graphViewChange;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加新节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">AddNodeData</span>(<span class="params">BaseNode node, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许添加空节点数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (enableUndoSystem)</span><br><span class="line">        &#123;</span><br><span class="line">            Undo.RegisterCompleteObjectUndo(SourceGraphData, <span class="string">&quot;AddNodeData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> result = SourceGraphData.AddNode(node);</span><br><span class="line">        <span class="keyword">if</span> (result)</span><br><span class="line">        &#123;</span><br><span class="line">            OnAddNodeData(node);</span><br><span class="line">            EditorUtility.SetDirty(SourceGraphData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">RemoveNodeData</span>(<span class="params">BaseNode node, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许移除空节点数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (enableUndoSystem)</span><br><span class="line">        &#123;</span><br><span class="line">            Undo.RegisterCompleteObjectUndo(SourceGraphData, <span class="string">&quot;RemoveNodeData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> result = SourceGraphData.RemoveNode(node);</span><br><span class="line">        <span class="keyword">if</span> (result)</span><br><span class="line">        &#123;</span><br><span class="line">            OnRemoveNode(node);</span><br><span class="line">            EditorUtility.SetDirty(SourceGraphData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行移除指定节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">DoRemoveNodeView</span>(<span class="params">NodeView nodeView, <span class="built_in">bool</span> recusive = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Undo.RegisterCompleteObjectUndo(SourceGraphData, <span class="string">$&quot;RemoveNodeView(<span class="subst">&#123;recusive&#125;</span>)&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> RemoveNodeViewRecusive(nodeView, recusive);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 复制指定节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;duplicateNodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">DoDuplicateNodeView</span>(<span class="params">NodeView duplicateNodeView, <span class="built_in">bool</span> recusive = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Undo.RegisterCompleteObjectUndo(SourceGraphData, <span class="string">$&quot;DuplicateNodeView(<span class="subst">&#123;recusive&#125;</span>)&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> DumplicateNodeViewRecusive(duplicateNodeView, recusive);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到我们无论是主动递归删除节点数据还是递归复制节点数据，又或是主动添加节点View，又或是主动添加边View，我们都通过Undo.RegisterCompleteObjectUndo()对我们的图数据(SourceGraphData继承至ScriptableObject)进行了撤销标记，这样一来我们就能通过Ctrl+Z快速撤销修改并还原正确的图数据Asset了。</p>
<p>递归删除节点操作:</p>
<p><img src="/img/Unity/UIToolkit/DeleteNodeRecusive.PNG" alt="DeleteNodeRecusive"></p>
<p>Ctrl+Z还原递归是删除节点操作:</p>
<p><img src="/img/Unity/UIToolkit/RecoverDeleteNodeRecusiveOperation.PNG" alt="RecoverDeleteNodeRecusiveOperation"></p>
<p>Note:</p>
<ol>
<li><strong>Undo只支持的是继承至UntiyEngine.Object的对象。</strong></li>
<li><strong>Undo.RecordObject只记录增量快照，Undo.RegisterCompleteObjectUndo记录完整的对象数据，为了确保数据操作的撤销正确性，推荐用后者，本人就是在删除嵌套删除节点数据时发现Undo.RecordObejct未能正确还原数据导致报错后使用Undo.RegisterCompleteObjectUndo才正确实现嵌套删除节点功能。</strong></li>
</ol>
<h2 id="事件驱动行为树"><a href="#事件驱动行为树" class="headerlink" title="事件驱动行为树"></a>事件驱动行为树</h2><p><strong>事件驱动的行为树核心是参考<a target="_blank" rel="noopener" href="https://github.com/meniku/NPBehave/blob/master/README_CH.md">NPBehave</a>的设计思路。</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/meniku/NPBehave/blob/master/README_CH.md"><strong>基于事件的行为树设计是，我们不再每帧都从根节点去遍历行为树，而是维护一个调度器负责保存已激活的节点，当正在执行的行为终止时，由其父节点决定接下来的行为。</strong></a></p>
<h3 id="事件驱动行为树类图设计"><a href="#事件驱动行为树类图设计" class="headerlink" title="事件驱动行为树类图设计"></a>事件驱动行为树类图设计</h3><p><strong>Clock – 行为树驱动时钟(事件驱动行为树的核心，负责统一调度定时器)</strong></p>
<p><strong>BehaviourTreeGraphData – 树编辑器存储数据(基于ScriptableObject)</strong></p>
<p><strong>BaseNode – 树节点数据(基于ScriptableObject)</strong></p>
<p><strong>EdgeData – 树边数据</strong></p>
<p><strong>NodePortData – 树连接端口数据</strong></p>
<p><strong>NodeState – 树节点状态</strong></p>
<p><strong>NodeType – 树节点类型</strong></p>
<p><strong>Blackboard – 树黑板数据</strong></p>
<p><strong>TBehaviourTree – 行为树执行抽象</strong></p>
<p><strong>TBehaviourTreeManager – 行为树执行统一管理类</strong></p>
<p><strong>TreeData – 行为树树数据抽象</strong></p>
<p><strong>UnityContext – Unity驱动类(驱动全局Clock)</strong></p>
<p><strong>AbortType – 行为树打断类型</strong></p>
<p><strong>BaseActionNode – 行为树行为节点基类</strong></p>
<p><strong>BaseConditionNode – 行为树条件节点基类</strong></p>
<p><strong>BaseParentNode – 行为树父节点基类抽象(带子节点的节点需要继承)</strong></p>
<p><strong>BaseCompositionNode – 行为树复合节点基类</strong></p>
<p><strong>BaseDecorationNode – 行为树装饰节点基类</strong></p>
<p><strong>BaseObservingDecorationNode – 行为树可被观察条件打断的装饰节点基类</strong></p>
<p><strong>BaseCompareShareNode – 行为树黑板比较节点基类</strong></p>
<p><strong>BaseConditionDecorationNode – 行为树条件装饰节点基类</strong></p>
<p><strong>RootNode – 行为树根节点类</strong></p>
<p><strong>SelectorNode – 行为树选择节点</strong></p>
<p><strong>SequenceNode – 行为树顺序节点</strong></p>
<p><strong>ParalNode – 行为树并发节点</strong></p>
<p><strong>RandomSelector – 行为树随机选择节点</strong></p>
<p>更多细节的行为树节点这里就不一一介绍了。</p>
<h3 id="事件驱动行为树数据编辑"><a href="#事件驱动行为树数据编辑" class="headerlink" title="事件驱动行为树数据编辑"></a>事件驱动行为树数据编辑</h3><p>前面通过UIElement，GraphView的相关使用，我们已经成功完成了对树数据(BehaviourTreeGraphData.cs)的树数据编辑。</p>
<h3 id="事件驱动行为树运行时数据构建"><a href="#事件驱动行为树运行时数据构建" class="headerlink" title="事件驱动行为树运行时数据构建"></a>事件驱动行为树运行时数据构建</h3><p>通过编辑的树数据到事件驱动的行为树，我们还需要利用树数据构建TBehaviourTree的过程。</p>
<p>第一步:</p>
<ol>
<li><p>读取BehaviourTreeGraphData.cs数据并克隆数据以备运行时使用</p>
<p>TBehaviourTree.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 加载行为树图数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetPath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadBTGraphData</span>(<span class="params"><span class="built_in">string</span> assetPath</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ReleaseBTGraphAsset();</span><br><span class="line">    BTOriginalGraph = TBehaviourTreeManager.Singleton.GetCacheBTGraph(assetPath);</span><br><span class="line">    <span class="keyword">if</span>(BTOriginalGraph == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> btGraphAsset = Resources.Load&lt;BehaviourTreeGraphData&gt;(assetPath);</span><br><span class="line">        BTOriginalGraph = btGraphAsset;</span><br><span class="line">        TBehaviourTreeManager.Singleton.CacheBTGraph(assetPath, BTOriginalGraph);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BTRunningGraph = BTOriginalGraph?.CloneSelf();</span><br><span class="line">    BTRunningGraph?.SetBTOwner(<span class="keyword">this</span>);</span><br><span class="line">    BTRunningGraph?.InitRuntimeDatas();</span><br><span class="line">    BTRunningGraph?.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建行为树运行时数据</p>
<p>BehaviourTreeGraphData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化运行时数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InitRuntimeDatas</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    InitClock();</span><br><span class="line">    InitBlackboard();</span><br><span class="line">    InitTreeDatas();</span><br><span class="line">    mInitRunTimeDataComplete = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化树数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitTreeDatas</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    RecyleAllTreeDatas();</span><br><span class="line">    TreeDataList.Clear();</span><br><span class="line">    <span class="keyword">var</span> rootNodeList = GetAllRootNodes();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> rootNode <span class="keyword">in</span> rootNodeList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> treeData = ObjectPool.Singleton.Pop&lt;TreeData&gt;();</span><br><span class="line">        treeData.SetData(<span class="keyword">this</span>, rootNode, Blackboard, Clock);</span><br><span class="line">        TreeDataList.Add(treeData);</span><br><span class="line">        <span class="keyword">if</span>(RootTree == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            RootTree = treeData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(TreeDataList.Count &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;行为树不应该有多个根节点树，请检查配置！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取所有根节点列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;BaseNode&gt; <span class="title">GetAllRootNodes</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;BaseNode&gt; rootNodeList = <span class="keyword">new</span> List&lt;BaseNode&gt;();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> node <span class="keyword">in</span> AllNodeList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.EntryPoint)</span><br><span class="line">        &#123;</span><br><span class="line">            rootNodeList.Add(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rootNodeList.Count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">$&quot;图:<span class="subst">&#123;name&#125;</span>没有根节点，获取所有根节点数量为0！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rootNodeList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们通过Clone的树数据(BehaviourTreeGraphData.cs)构建了我们想要的单颗树数据(TreeData.cs)(<strong>这一步的目的是为未来支持多个根节点的编辑器设计的，目前行为树只允许一个根节点</strong>)</p>
<p>TreeData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化指定图数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rootNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;blackboard&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clock&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetData</span>(<span class="params">BehaviourTreeGraphData graphData, BaseNode rootNode, Blackboard blackboard, Clock clock</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    OwnerGraphData = graphData;</span><br><span class="line">    RootNode = rootNode;</span><br><span class="line">    Blackboard = blackboard;</span><br><span class="line">    Clock = clock;</span><br><span class="line">    InitAllNodeAndEdgeDatas();</span><br><span class="line">    mInitComplete = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化所有节点和边数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitAllNodeAndEdgeDatas</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mAllNodeList.Clear();</span><br><span class="line">    OwnerGraphData.GetAllChildNodeList(<span class="keyword">ref</span> mAllNodeList, RootNode, <span class="literal">true</span>);</span><br><span class="line">    mAllEdgeDataList.Clear();</span><br><span class="line">    OwnerGraphData.GetAllChildEdgeDataList(<span class="keyword">ref</span> mAllEdgeDataList, RootNode, <span class="literal">true</span>);</span><br><span class="line">    InitNodeMapData();</span><br><span class="line">    InitEdgeMapData();</span><br><span class="line">    InitNodesTreeData();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">******</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化节点树数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitNodesTreeData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> node <span class="keyword">in</span> mAllNodeList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        node.SetOwnerTreeData(<span class="keyword">this</span>);</span><br><span class="line">        List&lt;BaseNode&gt; childNodeList = <span class="keyword">new</span> List&lt;BaseNode&gt;();</span><br><span class="line">        OwnerGraphData.GetAllChildNodeList(<span class="keyword">ref</span> childNodeList, node);</span><br><span class="line">        childNodeList.Remove(node);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> childNode <span class="keyword">in</span> childNodeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(childNode == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            childNode.SetParentNode(node <span class="keyword">as</span> BaseParentNode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> childCount = childNodeList.Count;</span><br><span class="line">        <span class="keyword">if</span> (childCount &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> parentNode = node <span class="keyword">as</span> BaseParentNode;</span><br><span class="line">            parentNode.SetChildNodeList(childNodeList);</span><br><span class="line">            <span class="keyword">if</span>(node <span class="keyword">is</span> BaseDecorationNode &amp;&amp; childCount &gt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;修饰节点名:<span class="subst">&#123;node.name&#125;</span>,GUID:<span class="subst">&#123;node.GUID&#125;</span>有超过1个数量的子节点，请检查配置！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        node.SetClock(Clock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>​		通过构建TreeData.cs以及所有相关BaseNode的运行时数据，我们为行为树的执行的数据准备工作就算是完成了。</p>
<ol start="3">
<li><p>行为树启动执行</p>
<p>BehaviourTreeGraphData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 开始行为树图数据运行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!mInitRunTimeDataComplete)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;未初始化运行时数据，开始行为树图数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Clock?.Enable();</span><br><span class="line">    RootTree?.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TreeData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 开始运行树数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!mInitComplete)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;树数据未初始化完成，开始运行树数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    RootNode?.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点开始运行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;节点GUID:<span class="subst">&#123;GUID&#125;</span>开始运行！&quot;</span>);</span><br><span class="line">    NodeState = NodeState.Running;</span><br><span class="line">    DoStart();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行开始运行流程</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RootNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行开始运行流程</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStart();</span><br><span class="line">    DecorateNode.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到我们通过BehaviourTreeGraphData.cs树数据可用并构建TreeData.cs，然后驱动TreeData调用RootNode的Start实现了行为树的执行驱动，。</p>
</li>
</ol>
<h3 id="事件驱动行为树执行设计"><a href="#事件驱动行为树执行设计" class="headerlink" title="事件驱动行为树执行设计"></a>事件驱动行为树执行设计</h3><p>传统行为树和事件驱动行为树在驱动树执行上的区别:</p>
<ol>
<li><strong>传统行为树每帧都要从根节点开始遍历行为树，而目的仅仅是为了得到最近激活的节点进行逻辑驱动。事件驱动的行为树是通过定时器进行驱动实现节点逻辑执行。</strong></li>
<li><strong>传统行为树和事件驱动的行为树还有一大区别节点执行结果的返回方式。传统行为树是子节点执行完成后直接通过return的方式把子节点执行结果直接返回给父节点，然后父节点根据子节点结果决定后续逻辑。而事件驱动行为树子节点结束是通过调用父节点的ChildStop()通知父节点子节点结束，而不同节点类型对于子节点结束的后续处理逻辑是在自身的OnChildStop里</strong></li>
</ol>
<p>事件驱动执行最核心的是<strong>计时器(Clock.cs)</strong></p>
<p>接下来让我们看看事件驱动行为树是如何利用定时器Clock.cs实现执行驱动和事件驱动的。</p>
<p>在了解之前，这里先说明下RootNode.cs的类继承设计，RootNode.cs这里我设计成的是装饰节点，所以<strong>无论行为树的根是驱动顺序执行(SequenceNode.cs)还是选择执行(SelectorNode.cs)，都得连接在RootNode之下。</strong></p>
<p>RootNode.cs继承关系如下:</p>
<p><strong>RootNode : BaseDecorationNode : BaseParentNode : BaseNode</strong></p>
<p>这里我以RootNode连接一个SequenceNode，SequenceNode连接一个WaitTimeNode.cs和LogNode.cs节点为例来说明事件驱动的执行过程。</p>
<p><img src="/"></p>
<ol>
<li><p>RootNode执行Start()</p>
<p>BaseNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点开始运行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;节点GUID:<span class="subst">&#123;GUID&#125;</span>开始运行！&quot;</span>);</span><br><span class="line">    NodeState = NodeState.Running;</span><br><span class="line">    DoStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>RootNode驱动子节点SequenceNode执行</p>
<p>RootNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行开始运行流程</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStart();</span><br><span class="line">    DecorateNode.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>SequenceNode执行Start()</p>
<p>SequenceNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应开始</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStart();</span><br><span class="line">    mCurrentIndex = <span class="number">-1</span>;</span><br><span class="line">    ProcessChildren();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行子节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ProcessChildren</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mCurrentIndex++;</span><br><span class="line">    <span class="keyword">if</span> (mCurrentIndex &lt; ChildNodeCount)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsAbort)</span><br><span class="line">        &#123;</span><br><span class="line">            Stop(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mChildNodeList[mCurrentIndex].Start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>SequenceNode驱动子节点WaitTimeNode执行Start()</p>
<p>WaitTimeNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行开始</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStart();</span><br><span class="line">    mOwnerTreeData.Clock.AddTimer(WaitTime, <span class="number">1</span>, OnWaitTimeComplete);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">******</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行运行完毕流程</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStop</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStop();</span><br><span class="line">    mOwnerTreeData.Clock.RemoveTimer(OnWaitTimeComplete);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应等待时长完成</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnWaitTimeComplete</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;UID:<span class="subst">&#123;GUID&#125;</span>,WaitTimeNode:OnWaitTimeComplete(),WaitTime:<span class="subst">&#123;WaitTime&#125;</span>&quot;</span>);</span><br><span class="line">    Stop(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以看到WaitTimeNode的等待执行不像传统行为树通过每一次Update进行时间累加，而是通过定时器Clock注入一个等待时长的定时器来驱动等待逻辑判定的。</strong></p>
</li>
<li><p>WaitTimeNode等待执行完毕，通知父节点SequenceNode自身子节点执行完成，SequenceNode.ChildStop()执行然后调用SequenceNode的DoChildStop()</p>
<p>SequenceNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应子节点停止</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">    <span class="keyword">if</span>(success)</span><br><span class="line">    &#123;</span><br><span class="line">        ProcessChildren();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行子节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ProcessChildren</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mCurrentIndex++;</span><br><span class="line">    <span class="keyword">if</span> (mCurrentIndex &lt; ChildNodeCount)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsAbort)</span><br><span class="line">        &#123;</span><br><span class="line">            Stop(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mChildNodeList[mCurrentIndex].Start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应WaitTimeNode执行完成成功，所以SequenceNode接着执行下一个节点LogNode</p>
</li>
<li><p>LogNode执行Start()然后标记执行完成</p>
<p>LogNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行开始</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStart();</span><br><span class="line">    Debug.Log(<span class="string">$&quot;GUID:<span class="subst">&#123;GUID&#125;</span>,LogNode:<span class="subst">&#123;LogContent&#125;</span>&quot;</span>);</span><br><span class="line">    Stop(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LogNode执行打印Log完成后，调用Stop(true)表示完成，然后通过调用父节点SequenceNode.ChildStop()，然后调用SequenceNode.DoChildStop()</p>
</li>
<li><p>SequenceNode响应LogNode子节点执行完成，发现所有子节点都执行完成，调用自身节点执行完成Stop(true)</p>
<p>SequenceNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应子节点停止</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">    <span class="keyword">if</span>(success)</span><br><span class="line">    &#123;</span><br><span class="line">        ProcessChildren();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行子节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ProcessChildren</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mCurrentIndex++;</span><br><span class="line">    <span class="keyword">if</span> (mCurrentIndex &lt; ChildNodeCount)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsAbort)</span><br><span class="line">        &#123;</span><br><span class="line">            Stop(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mChildNodeList[mCurrentIndex].Start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>RootNode响应SequenceNode执行完成，执行RootNode.ChildStop()和RootNode.DoChildStop()</p>
<p>RootNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应子节点运行完毕</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">    <span class="comment">// 根节点运行完一遍后</span></span><br><span class="line">    <span class="keyword">if</span> (!IsRunningOnce)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 重置所有节点状态，避免反复运行时，可视化查看到之前的状态</span></span><br><span class="line">        ResetAllNodeState();</span><br><span class="line">        Clock.AddTimer(<span class="number">0</span>, <span class="number">0</span>, Start);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里我们的行为树逻辑就算是执行完成一遍了，但<strong>行为树如何实现循环执行，逻辑在RootNode.DoChildStop() 里通过重新注入Clock定时器开启RootNode.Start()从而实现了事件驱动行为树的循环执行。</strong></p>
</li>
</ol>
<p>从上面可以看出<strong>事件驱动行为树无论是节点的执行还是行为树的循环执行，都是通过Clock定时器注入定时器来实现的。</strong></p>
<p>事件驱动的优点：</p>
<ol>
<li><strong>避免每帧从根节点执行一遍所有逻辑，而是在对应节点上通过定时器方式实现对应节点逻辑直接执行的方式，从而避免每帧无用的逻辑更新执行，更加高效。</strong></li>
</ol>
<h3 id="事件驱动行为树条件判定设计"><a href="#事件驱动行为树条件判定设计" class="headerlink" title="事件驱动行为树条件判定设计"></a>事件驱动行为树条件判定设计</h3><p>传统行为树和事件驱动行为树在驱动条件节点判定的区别:</p>
<ol>
<li><strong>传统行为树每帧都要把执行的条件节点执行一次去比较条件是否变化，从而实现监听条件变化的目的。事件驱动的行为树是通过启动定时器实现条件节点逻辑判定执行。</strong></li>
</ol>
<p>接下来让我们看看行为树是如何利用定时器Clock.cs实现条件执行判定的。</p>
<p>在实战理解事件驱动行为树条件判定执行之前，我们需要了解几个主要的类设计：</p>
<ol>
<li><p><strong>BaseObservingDecorationNode.cs – 实现可被观察条件打断的装饰节点基类</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseObservingDecorationNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可被观察条件打断的装饰节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseObservingDecorationNode</span> : <span class="title">BaseDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打断类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;打断类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> AbortType AbortType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否正在观察</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">bool</span> mIsObserving;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应开始</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoStart();</span><br><span class="line">        <span class="keyword">if</span> (AbortType != AbortType.NONE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!mIsObserving)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsObserving = <span class="literal">true</span>;</span><br><span class="line">                StartObserving();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!IsConditionMet())</span><br><span class="line">        &#123;</span><br><span class="line">            Stop(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            DecorateNode.Start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应子节点停止</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">        <span class="keyword">if</span>(AbortType == AbortType.NONE || AbortType == AbortType.SELF)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mIsObserving)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsObserving = <span class="literal">false</span>;</span><br><span class="line">                StopObserving();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Stop(success);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始条件监听流程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">StartObserving</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 停止条件监听观察</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">StopObserving</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件是否满足</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">IsConditionMet</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>从上面的代码可以看出BaseObservingDecorationNode.cs实现了节点条件监听（StartObserving()）和取消监听的流程(StopObserving())</strong></p>
</li>
<li><p><strong>BaseConditionDecorationNode.cs – 实现间隔时长判定条件的装饰节点基类</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseConditionDecorationNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可打断定时检查条件修饰节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseConditionDecorationNode</span> : <span class="title">BaseObservingDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查时间间隔(秒)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;条件检查时间间隔(秒)&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> CheckInterval = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查时间随机参考值(-0.5* -- 0.5*)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;条件检查时间随机参考值&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> CheckVariance = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始条件监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StartObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Clock.AddTimer(CheckInterval, CheckVariance, <span class="number">-1</span>, Evaluate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 停止条件监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StopObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Clock.RemoveTimer(Evaluate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件是否满足</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsConditionMet</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ConditionCheck();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查(子类重写)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">ConditionCheck</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>从上面代码可以看出BaseConditionDecorationNode.cs实现了定时器间隔的条件判定</strong></p>
</li>
</ol>
<p>这里我以RootNode连接一个SequenceNode，SequenceNode连接一个HelthValueNode，HelthValueNode连接一个SequenceNode，SequenceNode连接一个WaiterTimeNode和LogNode.cs节点为例来说明事件驱动条件节点的判定更新过程。</p>
<p><img src="/"></p>
<ol>
<li><p>RootNode执行Start()</p>
</li>
<li><p>SequenceNode执行Start()</p>
</li>
<li><p>HelthValueNode执行Start()，如果打断类型不为NONE，此时会触发BaseConditionDecorationNode的StartObserving()开启条件定时器监听</p>
<p>HelthValueNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> HealthValueNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 生命值条件检查修饰节点类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HealthValueNode</span> : <span class="title">BaseConditionDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 比较类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;比较类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> ComparisonType ComparisonType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生命值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;生命值&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> HealthValue = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">ConditionCheck</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> bindUID = mOwnerTreeData.OwnerGraphData.OwnerBT.BindUID;</span><br><span class="line">        <span class="keyword">var</span> bindActor = ActorManager.Singleton.GetActorByUID(bindUID);</span><br><span class="line">        <span class="keyword">if</span>(bindActor == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;找不到UID:<span class="subst">&#123;bindUID&#125;</span>对象，生命值检查比较失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(ComparisonType == ComparisonType.LESS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> bindActor.Health &lt; HealthValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ComparisonType == ComparisonType.GREATER)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> bindActor.Health &gt; HealthValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ComparisonType == ComparisonType.LESS_AND_EQUAL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> bindActor.Health &lt;= HealthValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ComparisonType == ComparisonType.GREATER_AND_EQUAL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> bindActor.Health &gt;= HealthValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ComparisonType == ComparisonType.EQUAL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> bindActor.Health == HealthValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不支持的比较运算类型:<span class="subst">&#123;ComparisonType&#125;</span>,比较对象UID:<span class="subst">&#123;bindUID&#125;</span>的生命值失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面代码可以看到HelthValueNode.cs实现了ConditionCheck()方法，，结合父类的定时器执行，实现了血量的定时条件判定逻辑。</p>
</li>
<li><p>HelthValueNode条件判定ConditionCheck()通过，执行SequenceNode.cs的Start()</p>
</li>
<li><p>WaitTimeNode执行Start()</p>
</li>
<li><p>在WaitTimeNode执行的过程中HelthValueNode的ConditionCheck()依然在执行</p>
</li>
<li><p>WaitTimeNode执行完毕Stop(true)，SequenceNode执行下一个节点LogNode的Start</p>
</li>
<li><p>LogNode执行Start()触发执行完毕Stop(true)，SequenceNode触发DoChildStop()触发执行完成Stop(true)</p>
</li>
<li><p>SequenceNode执行完成触发HelthValueNode的DoChildStop()，此时如果没有设置打断类型(默认为NONE)，那么此时为调用BaseConditionDecorationNode的StopObserving()取消条件定时器判定</p>
</li>
<li><p>HelthValueNode执行完毕Stop(true)，SequenceNode执行DoChildStop()执行Stop(true)，最后触发RootNode的DoChildStop()完成执行。</p>
</li>
</ol>
<p>Node:</p>
<ol>
<li><strong>事件驱动行为树里，需要支持定时判定和打断的都封装成了装饰节点而非条件节点</strong></li>
<li><strong>目前纯条件节点不支持定时器判定和打断，只支持常规单次条件判定，推荐尽量用装饰节点来定义条件</strong></li>
</ol>
<h3 id="事件驱动行为树黑板"><a href="#事件驱动行为树黑板" class="headerlink" title="事件驱动行为树黑板"></a>事件驱动行为树黑板</h3><p><strong>事件驱动行为树的黑板和传统的行为树黑板有所区别。传统行为树黑板主要作为行为树局部黑板负责存储和修改数据。事件驱动的行为树为了支持黑板数据修改的监听，黑板的设计还考虑了数据监听通知逻辑，而黑板的监听通知逻辑是通过定时器(Clock)来完成的。</strong></p>
<p>接下来直接给我们看下黑板的关键部分代码定义就能知道事件驱动行为树的黑板是如何实现黑板数据监听通知逻辑的，后续在讲解打断篇章会涉及实例理解黑板的数据修改和打断监听设计。</p>
<p>Blackboard.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板模式，数据共享中心</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Blackboard</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板操作类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> BBOperationType</span><br><span class="line">    &#123;</span><br><span class="line">        ADD,</span><br><span class="line">        REMOVE,</span><br><span class="line">        CHANGE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通知数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">struct</span> Notification</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 操作Key</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> key;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 黑板操作类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> BBOperationType type;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 操作值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">object</span> <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Notification</span>(<span class="params"><span class="built_in">string</span> key, BBOperationType type, <span class="built_in">object</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.type = type;</span><br><span class="line">            <span class="keyword">this</span>.<span class="keyword">value</span> = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 时钟</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Clock mClock;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板数据集合中心</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, BaseBlackboardData&gt; mBlackboardDataMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有Key的监听Map<span class="doctag">&lt;黑板数据Key名, 黑板监听类型回调列表&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt;&gt; mObservers;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否正在通知</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsNotifying;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有待添加的监听Key的监听Map<span class="doctag">&lt;黑板数据Key名, 黑板监听类型回调列表&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt;&gt; mAddObservers;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有等待移除的监听Key的监听Map<span class="doctag">&lt;黑板数据Key名, 黑板监听类型回调列表&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt;&gt; mRemoveObservers;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待通知列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Notification&gt; mNotifications;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 正在通知的通知列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Notification&gt; mNotificationsDispatch;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;noNotification&quot;&gt;</span>是否不通知(默认通知)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T <span class="keyword">value</span> = <span class="literal">default</span>, <span class="built_in">bool</span> noNotification = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> data = GetBlackboardData(key);</span><br><span class="line">        <span class="keyword">if</span> (data != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> targetData = data <span class="keyword">as</span> BlackboardData&lt;T&gt;;</span><br><span class="line">            <span class="keyword">if</span> (targetData == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;黑板数据里Key:<span class="subst">&#123;key&#125;</span>的数据类型和更新数据类型:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>不匹配，更新数据失败！&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            targetData.Data = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span>(!noNotification)</span><br><span class="line">            &#123;</span><br><span class="line">                mNotifications.Add(<span class="keyword">new</span> Notification(key, BBOperationType.CHANGE, <span class="keyword">value</span>));</span><br><span class="line">                mClock.AddTimer(<span class="number">0f</span>, <span class="number">0</span>, NotifiyObservers);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            BlackboardData&lt;T&gt; targetData = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            mBlackboardDataMap.Add(key, targetData);</span><br><span class="line">            <span class="keyword">if</span> (!noNotification)</span><br><span class="line">            &#123;</span><br><span class="line">                mNotifications.Add(<span class="keyword">new</span> Notification(key, BBOperationType.ADD, <span class="keyword">value</span>));</span><br><span class="line">                mClock.AddTimer(<span class="number">0f</span>, <span class="number">0</span>, NotifiyObservers);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定数据名的黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;noNotification&quot;&gt;</span>是否不通知(默认通知)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RemoveData</span>(<span class="params"><span class="built_in">string</span> key, <span class="built_in">bool</span> noNotification = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = mBlackboardDataMap.Remove(key);</span><br><span class="line">        <span class="keyword">if</span>(result &amp;&amp; !noNotification)</span><br><span class="line">        &#123;</span><br><span class="line">            mNotifications.Add(<span class="keyword">new</span> Notification(key, BBOperationType.REMOVE, <span class="literal">null</span>));</span><br><span class="line">            mClock.AddTimer(<span class="number">0f</span>, <span class="number">0</span>, NotifiyObservers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加黑板数据操作监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;observer&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddObserver</span>(<span class="params"><span class="built_in">string</span> key, System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt; observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt; observers = GetObserverList(<span class="keyword">this</span>.mObservers, key);</span><br><span class="line">        <span class="keyword">if</span> (!mIsNotifying)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!observers.Contains(observer))</span><br><span class="line">            &#123;</span><br><span class="line">                observers.Add(observer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!observers.Contains(observer))</span><br><span class="line">            &#123;</span><br><span class="line">                List&lt;System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt; addObservers = GetObserverList(<span class="keyword">this</span>.mAddObservers, key);</span><br><span class="line">                <span class="keyword">if</span> (!addObservers.Contains(observer))</span><br><span class="line">                &#123;</span><br><span class="line">                    addObservers.Add(observer);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt; removeObservers = GetObserverList(<span class="keyword">this</span>.mRemoveObservers, key);</span><br><span class="line">            <span class="keyword">if</span> (removeObservers.Contains(observer))</span><br><span class="line">            &#123;</span><br><span class="line">                removeObservers.Remove(observer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通知</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">NotifiyObservers</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mNotifications.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mNotificationsDispatch.Clear();</span><br><span class="line">        mNotificationsDispatch.AddRange(mNotifications);</span><br><span class="line">        mNotifications.Clear();</span><br><span class="line"></span><br><span class="line">        mIsNotifying = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (Notification notification <span class="keyword">in</span> mNotificationsDispatch)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.mObservers.ContainsKey(notification.key))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//                Debug.Log(&quot;1 do not notify for key:&quot; + notification.key + &quot; value: &quot; + notification.value);</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt; observers = GetObserverList(<span class="keyword">this</span>.mObservers, notification.key);</span><br><span class="line">            <span class="keyword">foreach</span> (System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt; observer <span class="keyword">in</span> observers)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.mRemoveObservers.ContainsKey(notification.key) &amp;&amp; <span class="keyword">this</span>.mRemoveObservers[notification.key].Contains(observer))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                observer(notification.type, notification.<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> key <span class="keyword">in</span> <span class="keyword">this</span>.mAddObservers.Keys)</span><br><span class="line">        &#123;</span><br><span class="line">            GetObserverList(<span class="keyword">this</span>.mObservers, key).AddRange(<span class="keyword">this</span>.mAddObservers[key]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> key <span class="keyword">in</span> <span class="keyword">this</span>.mRemoveObservers.Keys)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt; action <span class="keyword">in</span> mRemoveObservers[key])</span><br><span class="line">            &#123;</span><br><span class="line">                GetObserverList(<span class="keyword">this</span>.mObservers, key).Remove(action);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.mAddObservers.Clear();</span><br><span class="line">        <span class="keyword">this</span>.mRemoveObservers.Clear();</span><br><span class="line"></span><br><span class="line">        mIsNotifying = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Blackboard.UpdateData<T>()和Blackboard.RemoveData()方法里可以看到，Blackboard把黑板数据的操作和操作数据封装成Notification，然后结合定时器(Clock)实现下一帧对黑板相关数据和操作监听的通知。</p>
<h3 id="事件驱动行为树打断"><a href="#事件驱动行为树打断" class="headerlink" title="事件驱动行为树打断"></a>事件驱动行为树打断</h3><p><strong>个人理解行为树打断主要是为了支持因为条件满足已经执行过的逻辑执行条件变了不满足需要打断执行往后执行或者因为条件不满足没有执行过的逻辑因为条件变了满足了希望重新激活执行。</strong></p>
<p>首先我们来理解下事件驱动打断的核心设计原理，之后再针对不同的行为树打断类型进行实战分析和测试。</p>
<p>看下BaseObservingDecorationNode.cs的核心代码设计:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TCommonGraph</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseObservingDecorationNode.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可被观察条件打断的装饰节点基类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseObservingDecorationNode</span> : <span class="title">BaseDecorationNode</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打断类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;打断类型&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> AbortType AbortType;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否正在观察</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">protected</span> <span class="built_in">bool</span> mIsObserving;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 响应开始</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.DoStart();</span><br><span class="line">            <span class="keyword">if</span> (AbortType != AbortType.NONE)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!mIsObserving)</span><br><span class="line">                &#123;</span><br><span class="line">                    mIsObserving = <span class="literal">true</span>;</span><br><span class="line">                    StartObserving();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!IsConditionMet())</span><br><span class="line">            &#123;</span><br><span class="line">                Stop(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                DecorateNode.Start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 响应终止</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoAbort</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.DoAbort();</span><br><span class="line">            DecorateNode.Abort();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 响应子节点停止</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">            <span class="keyword">if</span>(AbortType == AbortType.NONE || AbortType == AbortType.SELF)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(mIsObserving)</span><br><span class="line">                &#123;</span><br><span class="line">                    mIsObserving = <span class="literal">false</span>;</span><br><span class="line">                    StopObserving();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Stop(success);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 响应父组合节点停止</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;parentNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoParentCompositeStop</span>(<span class="params">BaseCompositionNode parentNode</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.DoParentCompositeStop(parentNode);</span><br><span class="line">            <span class="keyword">if</span>(mIsObserving)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsObserving = <span class="literal">false</span>;</span><br><span class="line">                StopObserving();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 评估条件流程</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Evaluate</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            ******</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 开始条件监听流程</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">StartObserving</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 停止条件监听观察</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">StopObserving</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 条件是否满足</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">IsConditionMet</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>事件驱动行为树打断设计：</p>
<ul>
<li><p><strong>事件驱动行为树打断是设计在修饰节点</strong></p>
</li>
<li><p><strong>修饰节点BaseObservingDecorationNode:DoStart()时根据打断类型配置决定是否开启条件监听(打断类型不为NONE就要开启条件监听)</strong></p>
</li>
<li><p><strong>子节点执行完成后BaseObservingDecorationNode:DoChildStop()里根据打断类型决定是否停止条件监听(只有打断类型为NONE或SELF时停止条件监听)</strong></p>
</li>
<li><p><strong>修饰节点在上层父复合节点执行完成后进入BaseObservingDecorationNode:DoParentCompositeStop()决定是否停止监听(无论什么打断类型此刻都要停止条件监听)</strong></p>
</li>
<li><p><strong>没有停止条件监听的装饰节点即使节点逻辑执行完毕也会根据打断类型和条件监听被后续通知进行打断或激活执行，具体条件变化如何打断根据打断类型而定(BaseObservingDecorationNode:Evaluate)</strong></p>
</li>
</ul>
<p>接下来结合BaseConditionDecorationNode.cs和BaseCompareShareNode.cs来理解<strong>条件监听</strong>和<strong>黑板数据监听</strong>是如何实现统一的打断流程的。</p>
<p><strong>BaseConditionDecorationNode.cs(条件监听父类)</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseConditionDecorationNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可打断定时检查条件修饰节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseConditionDecorationNode</span> : <span class="title">BaseObservingDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查时间间隔(秒)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;条件检查时间间隔(秒)&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> CheckInterval = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查时间随机参考值(-0.5* -- 0.5*)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;条件检查时间随机参考值&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> CheckVariance = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始条件监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StartObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Clock.AddTimer(CheckInterval, CheckVariance, <span class="number">-1</span>, Evaluate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 停止条件监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StopObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Clock.RemoveTimer(Evaluate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件是否满足</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsConditionMet</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ConditionCheck();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查(子类重写)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">ConditionCheck</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面代码可以看到，<strong>BaseConditionDecorationNode.cs通过在StartObserving()里实现可配置间隔时长的定时器，将条件评估(BaseObservingDecorationNode.Evaluate())逻辑实现了定期执行。然后抽象BaseConditionDecorationNode:onditionCheck()接口让子类只关心条件逻辑的编写，真正的打断核心逻辑设计依然在BaseObservingDecorationNode.Evaluate()里。</strong></p>
<p><strong>BaseCompareShareNode.cs(黑板数据监听父类)</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseCompareShareNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 比较黑板数据基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseCompareShareNode</span> : <span class="title">BaseObservingDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 比较类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;比较类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> OperatorType OperatorType = OperatorType.IS_EQUAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 比较变量名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;比较变量名&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> VariableName = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StartObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Blackboard.AddObserver(VariableName, OnValueChanged);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 停止监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StopObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Blackboard.RemoveObserver(VariableName, OnValueChanged);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应黑板监听变量名值变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;operationType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newValue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnValueChanged</span>(<span class="params">Blackboard.BBOperationType operationType, <span class="built_in">object</span> newValue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Evaluate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件是否满足</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsConditionMet</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (OperatorType == OperatorType.ALWAYS_TRUE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mOwnerTreeData.Blackboard.ExistData(VariableName))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> OperatorType == OperatorType.IS_NOT_SET;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (OperatorType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_SET:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_EQUAL:</span><br><span class="line">                <span class="keyword">return</span> IsValueEqual();</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_NOT_EQUAL:</span><br><span class="line">                <span class="keyword">return</span> !IsValueEqual();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_GREATER_OR_EQUAL:</span><br><span class="line">                <span class="keyword">return</span> IsValueEqual() || IsValueGreater();</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_GREATER:</span><br><span class="line">                <span class="keyword">return</span> IsValueGreater();</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_SMALLER_OR_EQUAL:</span><br><span class="line">                <span class="keyword">return</span> IsValueEqual() || !IsValueGreater();</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_SMALLER:</span><br><span class="line">                <span class="keyword">return</span> !IsValueEqual() &amp;&amp; !IsValueGreater();</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 值是否相等</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">IsValueEqual</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 值是否大于</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">IsValueGreater</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字符串表达</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;OperatorType:<span class="subst">&#123;OperatorType&#125;</span>,VariableName:<span class="subst">&#123;VariableName&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>从上面代码可以看到，BaseCompareShareNode.cs通过在StartObserving()里实现对黑板特定黑板变量数据的监听，实现对特定黑板变量数据时变化通知。在监听黑板数据变化时调用Evaluate()实现对监听黑板数据进行再次条件评估，从而实现监听特定黑板变量数据的条件变化重新判定逻辑，最终实现黑板数据变量变化监听的条件打断流程。而针对不同数据结构类型(e.g. int, bool, string, float……)等数据结构的比较逻辑，BaseCompareShareNode.cs抽象了IsValueEqual和IsValueGreater接口，子类比如CompareShareBoolNode.cs,CompareShareIntNode.cs等都只需实现此接口即可实现对应数据类型的黑板变量比较逻辑。</strong></p>
<p>理解了条件监听和黑板数据监听的核心设计，接下来让我们看看不同打断类型的核心设计是如何实现不同打断类型的逻辑执行的。</p>
<p>不同打断类型的核心逻辑设计在BaseObservingDecorationNode:Evaluate()里。</p>
<p>BaseObservingDecorationNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseObservingDecorationNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可被观察条件打断的装饰节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseObservingDecorationNode</span> : <span class="title">BaseDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打断类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;打断类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> AbortType AbortType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否正在观察</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">bool</span> mIsObserving;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应开始</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoStart();</span><br><span class="line">        <span class="keyword">if</span> (AbortType != AbortType.NONE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!mIsObserving)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsObserving = <span class="literal">true</span>;</span><br><span class="line">                StartObserving();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!IsConditionMet())</span><br><span class="line">        &#123;</span><br><span class="line">            Stop(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            DecorateNode.Start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应终止</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoAbort</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoAbort();</span><br><span class="line">        DecorateNode.Abort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应子节点停止</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">        <span class="keyword">if</span>(AbortType == AbortType.NONE || AbortType == AbortType.SELF)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mIsObserving)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsObserving = <span class="literal">false</span>;</span><br><span class="line">                StopObserving();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Stop(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应父组合节点停止</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;parentNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoParentCompositeStop</span>(<span class="params">BaseCompositionNode parentNode</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoParentCompositeStop(parentNode);</span><br><span class="line">        <span class="keyword">if</span>(mIsObserving)</span><br><span class="line">        &#123;</span><br><span class="line">            mIsObserving = <span class="literal">false</span>;</span><br><span class="line">            StopObserving();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 评估条件流程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Evaluate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsRunning &amp;&amp; !IsConditionMet())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(AbortType == AbortType.SELF ||</span><br><span class="line">               AbortType == AbortType.BOTH ||</span><br><span class="line">               AbortType == AbortType.IMMEDIATE_RESTART)</span><br><span class="line">            &#123;</span><br><span class="line">                Abort();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(!IsRunning &amp;&amp; IsConditionMet())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(AbortType == AbortType.LOWER_PRIORITY ||</span><br><span class="line">               AbortType == AbortType.BOTH ||</span><br><span class="line">               AbortType == AbortType.IMMEDIATE_RESTART ||</span><br><span class="line">               AbortType == AbortType.LOWER_PRIORITY_IMMEDIATE_RESTART)</span><br><span class="line">            &#123;</span><br><span class="line">                BaseParentNode parentNode = ParentNode;</span><br><span class="line">                BaseNode childNode = <span class="keyword">this</span>;</span><br><span class="line">                <span class="keyword">while</span>(parentNode != <span class="literal">null</span> &amp;&amp; !(parentNode <span class="keyword">is</span> BaseCompositionNode))</span><br><span class="line">                &#123;</span><br><span class="line">                    childNode = parentNode;</span><br><span class="line">                    parentNode = parentNode.ParentNode;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(parentNode <span class="keyword">is</span> ParalNode)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(AbortType != AbortType.NONE &amp;&amp; AbortType != AbortType.IMMEDIATE_RESTART)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.LogError(<span class="string">$&quot;ParalNode的所有子节点优先级一致，不支持配置AbortType.Node和AbortType.IMMEDIATE_RESTART以外打断类型,请检查配置！&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> isImmediateRestart = AbortType == AbortType.IMMEDIATE_RESTART || AbortType == AbortType.LOWER_PRIORITY_IMMEDIATE_RESTART;</span><br><span class="line">                <span class="keyword">var</span> parentCompositionNode = parentNode <span class="keyword">as</span> BaseCompositionNode;</span><br><span class="line">                parentCompositionNode?.StopLowerPriorityChildrenForChild(childNode, isImmediateRestart);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在了解详细的打断流程设计前，先了解下打断类型设计。</p>
<p>事件驱动行为树打断支持了以下类型:</p>
<ul>
<li><strong>Stops.NONE</strong>：装饰器只会在启动时检查一次它的状态，并且永远不会停止任何正在运行的节点。</li>
<li><strong>Stops.SELF</strong>：装饰器将在启动时检查一次它的条件状态，如果满足，它将继续观察黑板的变化。一旦不再满足该条件，它将终止自身，并让父组合继续处理它的下一个节点。</li>
<li><strong>Stops.LOWER_PRIORITY</strong>：装饰器将在启动时检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止比此结点优先级较低的节点，允许父组合继续处理下一个节点</li>
<li><strong>Stops.BOTH</strong>：装饰器将同时停止:self和优先级较低的节点。</li>
<li><strong>Stops.LOWER_PRIORITY_IMMEDIATE_RESTART</strong>：一旦启动，装饰器将检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止优先级较低的节点，并命令父组合立即重启此装饰器。</li>
<li><strong>Stops.IMMEDIATE_RESTART</strong>：一旦启动，装饰器将检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止优先级较低的节点，并命令父组合立即重启装饰器。正如在这两种情况下，一旦不再满足条件，它也将停止自己。</li>
</ul>
<p><strong>装饰节点常规执行流程设计：</strong></p>
<ol>
<li>在装饰节点开始执行时DoStart()，如果打断类型不为None，节点就会开启条件监听。</li>
<li>如果条件不满足，此装饰节点会直接Stop(false)将此节点停止执行，反之开始执行修饰节点的子节点。</li>
<li>如果装饰节点一开始条件满足，则会触发装饰节点的子节点执行(Start和DoStart)，</li>
</ol>
<p><strong>装饰节点核心打断流程设计：</strong></p>
<ol>
<li><p><strong>装饰节点开始执行，装饰节点未配置打断类型，不开启条件监听，条件满足则执行子节点，条件不满足则直接Stop(false)</strong></p>
</li>
<li><p><strong>装饰节点开始执行，装饰节点配置了打断类型，开启条件监听，一开始不满足条件</strong></p>
<ul>
<li>不满足条件直接Stop(false)，通知父节点(复合节点或修饰节点)执行DoChildStop()，如果父节点是修饰节点则会继续调用此节点的Stop(false)直到找到第一个复合父节点调用OnChildStop()，复合节点根据自身类型和子节点执行结果决定是否Stop()还是继续执行其他子节点，如果第一个复合父节点选择Stop()，则会通知其子节点，复合父节点执行结束调用子节点的ParentCompositeStop()方法，如果子节点是修饰节点则会触发修饰节点的ParentCompositeStop()方法，此时会执行修饰节点的DoParentCompositeStop()和子节点的ParentCompositeStop()，<strong>修饰节点的DoParentCompositeStop()则触发停止条件监听</strong>，子节点的ParentCompositeStop()是为了确保子节点如果依然是修饰节点时把对应条件监听也取消掉。</li>
<li><strong>执行过程中第一个复合父节点一直未执行结束，此时监听的条件由不满足变到满足</strong>，找到第一个父复合节点通知该复合节点执行StopLowerPriorityChildrenForChild(<strong>非SELF打断类型</strong>)，<strong>复合节点根据修饰节点所在分支的对应子节点+修饰节点的打断类型决定是从此修饰节点的所在分支子节点重新开始执行还是打断比修饰节点的所在分支子节点优先级低的节点执行第一个父复合节点后续的节点逻辑(正在执行的子节点会调用Abort进行打断)。</strong></li>
</ul>
 <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 停止比指定子节点优先级低的节点，并决定是否重新开启组合节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;immediateRestart&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StopLowerPriorityChildrenForChild</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> immediateRestart</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> indexForChild = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">bool</span> found = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (BaseNode currentChild <span class="keyword">in</span> mChildNodeList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentChild == child)</span><br><span class="line">        &#123;</span><br><span class="line">            found = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!found)</span><br><span class="line">        &#123;</span><br><span class="line">            indexForChild++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (found &amp;&amp; currentChild.IsRunning)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (immediateRestart)</span><br><span class="line">            &#123;</span><br><span class="line">                mCurrentIndex = indexForChild - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mCurrentIndex = ChildNodeCount;</span><br><span class="line">            &#125;</span><br><span class="line">            currentChild.Abort();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>装饰节点开始执行，装饰节点配置了打断类型，开启条件监听，一开始满足条件</strong></p>
<ul>
<li>满足条件开始执行子节点Start，子节点执行完毕后通知修饰节点执行DoChildStop()，此时修饰节点会根据根据打断类型决定是否要停止条件监听(<strong>此时如果打断类型是SELF，因为已经满足执行过了，不需要再考虑监听打断，所以就需要停止条件监听</strong>)。</li>
<li><strong>修饰节点子节点持续执行，修饰节点条件定时检查(BaseConditionDecorationNode.cs)和黑板数据监听检查(BaseCompareShareNode.cs)触发定时条件评估(BaseObservingDecorationNode:Evaluate())</strong></li>
<li>如果修饰节点运行中条件由满足变到不满足，此时打断类型SELF，BOTH，IMMEDIATE_RESTART都需要将正在执行的修饰节点打断执行，执行修饰节点的Abort，修饰节点通知其子节点Abort，子节点Abort时通知父修饰节点执行DoChildStop从而实现修饰节点的打断后正确结束Stop流程，<strong>修饰节点此时如果打断类型不是NONE和SELF，则不会停止条件监听，直到第一个父复合节点执行结束时通知修饰节点DoParentCompositeStop才停止条件监听</strong>。</li>
</ul>
</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>事件驱动行为树的打断是支持在装饰节点上的</strong></li>
<li><strong>修饰节点的监听和打断流程核心逻辑在BaseObservingDecorationNode.cs</strong></li>
<li><strong>条件监听(基于定时器)和黑板数据监听(基于定时器+监听者模式)</strong></li>
<li><strong>装饰节点的子节点必须编写DoAbort方法流程，不然其子节点运行时无法因为打断而正确Stop</strong></li>
<li><strong>装饰节点条件从一开始满足的开始条件监听到条件监听取消，核心是由子节点是否执行完成和第一个复合节点执行是否完成决定</strong></li>
<li><strong>装饰节点条件从一开始不满足的开始条件监听到条件监听取消，核心是由装饰节点的第一个父复合节点执行是否完成决定</strong></li>
<li><strong>装饰节点连接的子节点都应该编写DoAbort接口，用于支持装饰节点的相关打断执行逻辑</strong></li>
<li><strong>不同的复合节点的打断处理方式不一样，具体参考代码设计</strong></li>
<li><strong>ParalNode的所有子节点优先级一致，不支持配置AbortType.Node和AbortType.IMMEDIATE_RESTART以外打断类型</strong></li>
<li><strong>所有节点逻辑(e.g 行为节点……)都要基于定时器驱动</strong></li>
</ol>
<h4 id="事件驱动行为树打断单元测试"><a href="#事件驱动行为树打断单元测试" class="headerlink" title="事件驱动行为树打断单元测试"></a>事件驱动行为树打断单元测试</h4><p>这里主要i针对不同打断类型，编写单元测试，验证不同的打断类型的执行逻辑是否正确。</p>
<h5 id="Stops-NONE"><a href="#Stops-NONE" class="headerlink" title="Stops.NONE"></a>Stops.NONE</h5><p><strong>装饰器只会在启动时检查一次它的状态，并且永远不会停止任何正在运行的节点。</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/AI/EventBehaviourTree/RootNodeRunningOnceSetting.PNG" alt="RootNodeRunningOnceSetting"></p>
<p><img src="/img/AI/EventBehaviourTree/BlackBoardStopNone.PNG" alt="BlackBoardStopNone"></p>
<p><img src="/img/AI/EventBehaviourTree/StopNoneBlackBoardInspector.PNG" alt="StopNoneBlackBoardInspector"></p>
<p>上图不清晰，这里我描述下我的行为树设计。</p>
<p>Root-&gt;Selector</p>
<p>​	Selector-&gt;CompareShareFloatNode(打断方式为None)(比较ShareFloat&lt;&#x3D;30)</p>
<p>​		CompareShareFloatNode-&gt;SequenceNode</p>
<p>​			SequenceNode-&gt;LogNode(打印”输出开始执行ShareFloat小于等于30Log”)</p>
<p>​			SequenceNode-&gt;SetShareFloat(设置ShareFloat到100)</p>
<p>​			SequenceNode-&gt;LogNode(打印”输出修改ShareFloat到100完成Log”)</p>
<p>​			SequenceNode-&gt;WaitTimeNode(等待5秒)</p>
<p>​			SequenceNode-&gt;LogNode(打印”输出执行ShareFloat小于等于30完成Log”)</p>
<p><strong>从上面可以看到当执行到设置ShareFloat到100的节点时，第一个CompareShareFloatNode(打断方式为None)(比较ShareFloat&lt;&#x3D;30)的修饰节点并没有被打断而是将SequenceNode完美执行完成，这也就是符合StopNone的不打断设计。</strong></p>
<p>Note:</p>
<ol>
<li><strong>黑板比较数据，只要不是勾选的存在和不存在，那么比较时如果黑板没有设置过基础黑板变量值，那么统一返回失败！</strong></li>
<li><strong>因为为了展示打断机制，所以RootNode根节点勾选了只执行一次的设置</strong></li>
</ol>
<h5 id="Stops-SELF"><a href="#Stops-SELF" class="headerlink" title="Stops.SELF"></a>Stops.SELF</h5><p><strong>装饰器将在启动时检查一次它的条件状态，如果满足，它将继续观察黑板的变化。一旦不再满足该条件，它将终止自身，并让父组合继续处理它的下一个节点。</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/AI/EventBehaviourTree/BlackBoardStopSelf.PNG" alt="BlackBoardStopSelf"></p>
<p><strong>从上图结果可以看到，执行SetShareFloatNode(设置ShareFloat值到100时)后，因为CompareShareFloatNode(比较ShareFloat&lt;&#x3D;30)修饰节点从条件满足变成了条件不满足，同时因为设置的StopSelf打断策略，所以在WaitTimeNode(等待5秒的过程中)，WaitTimeNode直接被打断，让SelectorNode直接执行了第二分支的LogNode打印节点，这也正符合StopSelf的打断策略设计。</strong></p>
<h5 id="Stops-LOWER-PRIORITY"><a href="#Stops-LOWER-PRIORITY" class="headerlink" title="Stops.LOWER_PRIORITY"></a>Stops.LOWER_PRIORITY</h5><p><strong>装饰器将在启动时检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止比此结点优先级较低的节点，允许父组合继续处理下一个节点</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/EventBehaviourTree/BlackBoardStopLowerPriority.PNG" alt="BlackBoardStopLowerPriority"></p>
<p><strong>可以看到第一个CompareShareFloatNode(比较ShareFloat&gt;&#x3D;30，设置打断为LowerPriority)，因为不满足条件所以一开始没有执行，执行到SetShareFloatNode(设置ShareFloat值到100)节点后，WaitTimeNode被打断执行，第二个SelectorNode直接被打断执行，然后第一个SelectorNode直接执行了第一个SelectorNode的第二分支的LogNode节点，这也完美符合了修饰节点LowerPriority从不满足到满足的时候，打断比如LowerPriority低的节点的父组合节点执行，让更上层父节点执行下一个节点的设计。</strong></p>
<h5 id="Stops-BOTH"><a href="#Stops-BOTH" class="headerlink" title="Stops.BOTH"></a>Stops.BOTH</h5><p><strong>装饰器将同时停止:self和优先级较低的节点。</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/AI/EventBehaviourTree/BlackBoardStopBoth.PNG" alt="BlackBoardStopBoth"></p>
<p><strong>通过将第一个CompareShareFloatNode(设置成比较ShareFloat&lt;&#x3D;30且Both打断类型)，我们在后续SequenceNode将ShareFloat设置成100让条件从满足到不满足，从而打断CompareShareFloatNode执行，让第二个SelectorNode接着第二条分支执行，但第二个SelectorNode的第二条分支我又通过将ShareFloat设置成0让CompareShareFloatNode从不满足到满足，从而直接打断第二个SelectorNode的执行，直接进入第二个SelectorNode的第二分支执行打印出最终Log。可以看出这个测试用例完美符合了Both既满足SELF又满足LowerPriority的两个打断机制设计。</strong></p>
<h5 id="Stops-LOWER-PRIORITY-IMMEDIATE-RESTART"><a href="#Stops-LOWER-PRIORITY-IMMEDIATE-RESTART" class="headerlink" title="Stops.LOWER_PRIORITY_IMMEDIATE_RESTART"></a>Stops.LOWER_PRIORITY_IMMEDIATE_RESTART</h5><p><strong>一旦启动，装饰器将检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止优先级较低的节点，并命令父组合立即重启此装饰器。</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/AI/EventBehaviourTree/BlackBoardStopLowerPriorityImmediateRestart.PNG" alt="BlackBoardStopLowerPriorityImmediateRestart"></p>
<p><strong>可以看到SelectorNode的第一个分支的CompareShareFloatNode(设置成比较ShareFloat&gt;&#x3D;30且LowerPriorityImmediateRestart打断类型)，所以一开始就不满足，所以会直接进入SelectorNode的第二个分支，第二个分支里SetShareFloatNode将ShareFloat设置成100，此时第一分支的CompareShareFloatNode从不满足条件到满足条件，因为是LowerPriorityImmediateRestart打断类型的缘故，打断了SelectorNode第二分支的执行，直接重启了SelectorNode第一分支的执行。可以看出这个测试用例完美符合了LowerPriorityImmediateRestart的条件从不满足到满足时打断低优先级分支且从其当前修饰节点所在组合节点的分支设计。</strong></p>
<h4 id="Stops-IMMEDIATE-RESTART"><a href="#Stops-IMMEDIATE-RESTART" class="headerlink" title="Stops.IMMEDIATE_RESTART"></a><strong>Stops.IMMEDIATE_RESTART</strong></h4><p><strong>一旦启动，装饰器将检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止优先级较低的节点，并命令父组合立即重启装饰器。正如在这两种情况下，一旦不再满足条件，它也将停止自己。</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/AI/EventBehaviourTree/BlackBoardStopImmediateRestart.PNG" alt="BlackBoardStopImmediateRestart"></p>
<p><strong>这里测试ImmediateRestart打断类型的测试用例比较复杂，这里简单来说就是先让CompareShareFloatNode(ImmediateRestart打断类型)不满足，然后通过运行其他分支将CompareShareFloatNode从不满足到满足(验证ImmediateRestart的打断低优先级并重启的机制)，然后在CompareShareFloatNode后续流程里将ShareFloat设置成10测试CompareShareFloatNode从条件满足到不满足的自我打断机制，然后借助CompareShareFloatNode(比较ShareFloat值为10)来实现SelectorNode的执行完成流程结束单次运行。可以看出这个测试用例完美验证了ImmediateRestart的从不满足到满足的重启和从满足到不满足的自我打断机制，完美符合ImmediateRestart打断策略。</strong></p>
<h3 id="事件驱动行为树暂停"><a href="#事件驱动行为树暂停" class="headerlink" title="事件驱动行为树暂停"></a>事件驱动行为树暂停</h3><p>通过前面的学习，可以知道，事件驱动行为树的执行核心是<strong>定时器(Clock.cs)</strong></p>
<p><strong>所以要想实现单个行为树逻辑的暂停继续功能，我们必须把定时器(Clock.cs)实现成每个行为树(TBehaviourTree.cs)一个定时器(Clock.cs)</strong></p>
<p><strong>NPBehave的Clock采用的是全局唯一的UnityContext，同时他的Clock设计没有支持暂停继续功能。我这里的设计修改算是我自己的一个改进。</strong></p>
<p>目前设计如下：</p>
<ol>
<li><strong>TBehaviourTreeManager负责管理所有的TBehaviourTree添加，删除和更新</strong></li>
<li><strong>为了确保正确的更新(Update)删除TBehaviourTreeManager采用延迟添加和删除TBehaviourTree的方式</strong></li>
<li><strong>TBehaviourTreeManager的Upadte由外部统一调用传递deltaTime</strong></li>
<li><strong>TBehaviourTree和Clock一对一</strong></li>
</ol>
<p>TBehaviourTreeManager.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TBehaviourTreeManager.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树单例管理类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TBehaviourTreeManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">TBehaviourTreeManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Node:</span></span><br><span class="line">    <span class="comment">// 通过延迟到下一帧Update里添加和删除的方案，确保行为树Update的正确更新逻辑</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有有效的行为树列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TBehaviourTree&gt; AllBehaviourTreeList</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待添加的行为树Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;TBehaviourTree, TBehaviourTree&gt; mWaitAddBehaviourTreeMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待移除的行为树Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;TBehaviourTree, TBehaviourTree&gt; mWaitRemoveBehaviourTreeMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否暂停所有</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsPauseAll</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册指定行为树对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RegisterTBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(behaviourTree == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许注册空行为树对象，注册失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(IsWaitRemoveBehaviourTree(behaviourTree))</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveWaitRemoveBehaviourTree(behaviourTree);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> AddWaitAddBehaviourTree(behaviourTree);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 取消注册指定行为树对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UnregisterTBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(behaviourTree == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许取消注册空行为树对象，取消注册失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(IsWaitAddBehaviourTree(behaviourTree))</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveWaitAddBehaviourTree(behaviourTree);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> AddWaitRemoveBehaviourTree(behaviourTree);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 暂停所有行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PauseAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 继续所有行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ResumeAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打断所有行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AbortAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有行为树定时器更新驱动</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        DoAllWaitRemoveBehaviourTree();</span><br><span class="line">        DoAllWaitAddBehaviourTree();</span><br><span class="line">        UpdateAllBehaviourTree(deltaTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行移除所有待移除行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoAllWaitRemoveBehaviourTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> waitRemoveBehaviourTree <span class="keyword">in</span> mWaitRemoveBehaviourTreeMap)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveBehaviourTree(waitRemoveBehaviourTree.Key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行所有待添加行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoAllWaitAddBehaviourTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> waitAddBehaviourTree <span class="keyword">in</span> mWaitAddBehaviourTreeMap)</span><br><span class="line">        &#123;</span><br><span class="line">            AddBehaviourTree(waitAddBehaviourTree.Key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新所有行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateAllBehaviourTree</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsPauseAll)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>, length = AllBehaviourTreeList.Count; index &lt; length; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> behaviourTree = AllBehaviourTreeList[index];</span><br><span class="line">            behaviourTree?.Update(deltaTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">AddBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">RemoveBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否包含指定行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsContainBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> AllBehaviourTreeList.Contains(behaviourTree);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加等待添加行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">AddWaitAddBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除等待添加行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">RemoveWaitAddBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否包含等待添加行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsWaitAddBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mWaitAddBehaviourTreeMap.ContainsKey(behaviourTree);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加等待移除行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">AddWaitRemoveBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除等待移除行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">RemoveWaitRemoveBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否包含等待移除行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsWaitRemoveBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mWaitRemoveBehaviourTreeMap.ContainsKey(behaviourTree);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TBehaviourTree.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TBehaviourTree.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TBehaviourTree</span> : <span class="title">IRecycle</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 行为树定时器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Clock BehaviourTreeClock</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TBehaviourTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bindUID&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"><span class="built_in">int</span> bindUID</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        BehaviourTreeClock = <span class="keyword">new</span> Clock();</span><br><span class="line">        UpdateBindUID(bindUID);</span><br><span class="line">        RegisterBehaviourTree();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RegisterBehaviourTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        TBehaviourTreeManager.Singleton.RegisterTBehaviourTree(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 取消注册行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UnregisterBehaviourTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        TBehaviourTreeManager.Singleton.UnregisterTBehaviourTree(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 暂停</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Pause</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        BTRunningGraph?.Clock.Disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 继续</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Resume</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        BTRunningGraph?.Clock.Enable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打断</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Stop</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        BTRunningGraph?.Stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 行为树定时器更新驱动</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        BTRunningGraph?.Clock?.Update(deltaTime);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ****</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Clock.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Clock</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否激活(影响Update)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsEnable</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 激活</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        IsEnable = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不激活</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Disable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        IsEnable = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IsEnable)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">		******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码设计有几个要点：</p>
<ol>
<li><strong>行为树的注册和取消注册我通过添加到待添加和待删除列表里，将真正的删除和添加延迟到下一帧Update里去执行，确保了Update所有行为树时不会出现遍历的同时触发删除添加等导致更新所有行为树报错问题。</strong></li>
<li><strong>行为树的暂停除了TBehaviourTreeManager的总暂停开关，单个行为树的暂停实际上是通过对每个TBehaviourTree的一对一Clock进行暂停实现的</strong></li>
</ol>
<p>AI暂停和继续截图:</p>
<p><img src="/img/AI/EventBehaviourTree/BehaviourTreePause.PNG" alt="BehaviourTreePause"></p>
<p><img src="/img/AI/EventBehaviourTree/BehaviourTreeResume.PNG" alt="BehaviourTreeResume"></p>
<p>Note:</p>
<ol>
<li><strong>这里我暂时没有对TBehavourTree和Clock做对象池优化，算是一个优化点。</strong></li>
</ol>
<h3 id="事件驱动行为树调试"><a href="#事件驱动行为树调试" class="headerlink" title="事件驱动行为树调试"></a>事件驱动行为树调试</h3><p><strong>行为树调试很重要的一点就是要可视化整个行为树执行过程，行为树编辑器已经实现了行为树数据的可视化绘制，那么剩下的工作就是将行为树运行时的一些数据(比如节点运行状态，节点运行结果等)通过编辑器将数据可视化显示。</strong></p>
<p>目前行为树的调试是通过加载AI(BaseActor.LoadAI())时挂在<strong>BTDebugger</strong>脚本来决定选中对象是否支持数据加载显示调试(<strong>为了区分运行时编辑器就没有采用TBehaviourTree作为调试加载依据</strong>)。</p>
<p>行为树窗口<strong>UIBTGraphEditorWindow.cs</strong>结合<strong>OnSelectionChange</strong>实现对选中对象的<strong>BTDebugger</strong>对应的运行时<strong>BehaviourTreeGraphData</strong>进行数据读取构建显示。</p>
<p>关于为树运行时的一些数据(比如节点运行状态，节点运行结果，是否打断等)数据可视化，通过<strong>BTGraphEditorWindow.cs</strong>，<strong>BehaviourTreeGraphView.cs</strong>，<strong>NodeView.cs</strong>和<strong>EdgeView.cs</strong>相关代码进行数据显示：</p>
<p>BTGraphEditorWindow.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图窗口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应EditorWindow的Update</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mGraphView?.Update();</span><br><span class="line">        <span class="comment">// 运行时黑板数据不是通过属性绑定显示的</span></span><br><span class="line">        <span class="comment">// 所以采用通过更新刷新的方式确保黑板UI实时显示</span></span><br><span class="line">        <span class="keyword">if</span>(Application.isPlaying)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardDataUI();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> EditorWindow那方驱动过来的Update更新</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UpdateAllNodeStateView();</span><br><span class="line">        UpdateAllEdgeViewColors();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新所有节点状态显示</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateAllNodeStateView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (SourceGraphData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; SourceGraphData.AllNodeList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> node = SourceGraphData.AllNodeList[i];</span><br><span class="line">            <span class="keyword">var</span> nodeView = GetNodeByGuid(node.GUID) <span class="keyword">as</span> NodeView;</span><br><span class="line">            nodeView?.UpdateNodeStateBackgroundColor();</span><br><span class="line">            nodeView?.UpdateNodeStateLabel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新所有显示边颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateAllEdgeViewColors</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (SourceGraphData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; SourceGraphData.AllEdgeDataList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> edge = SourceGraphData.AllEdgeDataList[i];</span><br><span class="line">            <span class="keyword">var</span> edgeView = GetEdgeByGuid(edge.GUID) <span class="keyword">as</span> EdgeView;</span><br><span class="line">            edgeView?.UpdateEdgeControlStateColor();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NodeView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点显示抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NodeView</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点状态UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeStateUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        UpdateNodeStateBackgroundColor();</span><br><span class="line">        UpdateNodeStateLabel();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新节点状态背景颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateNodeStateBackgroundColor</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeStateHorizontalUIContainer = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(BTGraphElementNames.NodeStateUIHorizontalContainerName);</span><br><span class="line">        <span class="keyword">if</span>(nodeStateHorizontalUIContainer != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            nodeStateHorizontalUIContainer.style.backgroundColor = BTGraphUtilitiesEditor.GetColorByNodeState(NodeData.NodeState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新节点状态Label</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateNodeStateLabel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeStateLabel = <span class="keyword">this</span>.Q&lt;Label&gt;(BTGraphElementNames.NodeStateLabelName);</span><br><span class="line">        <span class="keyword">if</span> (nodeStateLabel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> stateDes = NodeData.NodeState.ToString();</span><br><span class="line">            <span class="keyword">if</span>(NodeData.IsEnteredAbort)</span><br><span class="line">            &#123;</span><br><span class="line">                stateDes = <span class="string">$&quot;<span class="subst">&#123;stateDes&#125;</span>(打断)&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nodeStateLabel.text = stateDes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EdgeView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> EdgeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 显示边基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EdgeView</span> : <span class="title">Edge</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建显示边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;inputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> EdgeView <span class="title">CreateEdgeView</span>(<span class="params">EdgeData edgeData, Port inputPort, Port outputPort</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> edgeView = <span class="keyword">new</span> EdgeView()</span><br><span class="line">        &#123;</span><br><span class="line">            input = inputPort,</span><br><span class="line">            output = outputPort,</span><br><span class="line">        &#125;;</span><br><span class="line">        edgeView.Init(SourceGraphData, edgeData);</span><br><span class="line">        edgeView.UpdateEdgeControlStateColor();</span><br><span class="line">        <span class="keyword">return</span> edgeView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新显示边线状态颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateEdgeControlStateColor</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> edgeInputNode = OwnerGraphData.GetNodeByGUID(EdgeData.InputNodeGUID);</span><br><span class="line">        <span class="keyword">var</span> edgeInputColor = BTGraphUtilitiesEditor.GetEdgeColorByNodeState(edgeInputNode.NodeState);</span><br><span class="line">        <span class="keyword">var</span> edgeOutputColor = BTGraphUtilitiesEditor.GetEdgeColorByNodeState(edgeInputNode.NodeState);</span><br><span class="line">        edgeControl.inputColor = edgeInputColor;</span><br><span class="line">        edgeControl.outputColor = edgeOutputColor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BTGraphUtilitiesEditor.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BTGraphUtilitiesEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树节点编辑器工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BTGraphUtilitiesEditor</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点状态和颜色背景Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;NodeState, Color&gt; NodeStateColorMap = <span class="keyword">new</span> Dictionary&lt;NodeState, Color&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;NodeState.Suspend, Color.grey&#125;,</span><br><span class="line">        &#123;NodeState.Running, Color.yellow&#125;,</span><br><span class="line">        &#123;NodeState.Abort, Color.magenta&#125;,</span><br><span class="line">        &#123;NodeState.Success, Color.green&#125;,</span><br><span class="line">        &#123;NodeState.Failed, Color.red&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"> </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定节点类型的背景颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeState&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Color <span class="title">GetColorByNodeState</span>(<span class="params">NodeState nodeState</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Color nodeStateColor;</span><br><span class="line">        <span class="keyword">if</span> (NodeStateColorMap.TryGetValue(nodeState, <span class="keyword">out</span> nodeStateColor))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> nodeStateColor;</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;未配置节点状态:<span class="subst">&#123;nodeState&#125;</span>的颜色！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Color.grey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定节点状态类型对应的边颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeState&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Color <span class="title">GetEdgeColorByNodeState</span>(<span class="params">NodeState nodeState</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 未运行完成按照节点状态颜色显示边颜色，运行完成统一显示绿色</span></span><br><span class="line">        <span class="keyword">if</span>(nodeState == NodeState.Suspend || nodeState == NodeState.Running || nodeState == NodeState.Abort)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetColorByNodeState(nodeState);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Color.green;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>从上面的代码可以看到通过EditorWindow的Update驱动BehaviourTreeGraphView.Update去每帧更新一些运行时动态变化的数据显示</strong></p>
<p>Note:</p>
<ol>
<li><strong>编辑器的运行时数据更新显示(e.g 运行节点，边颜色，打断状态等)是通过Update驱动更新的</strong></li>
<li><strong>运行时黑板数据不是通过属性绑定显示的，所以采用通过更新刷新的方式确保黑板UI实时显示</strong></li>
</ol>
<h3 id="事件驱动行为树实战"><a href="#事件驱动行为树实战" class="headerlink" title="事件驱动行为树实战"></a>事件驱动行为树实战</h3><p>TODO</p>
<h3 id="未来计划"><a href="#未来计划" class="headerlink" title="未来计划"></a>未来计划</h3><ol>
<li><strong>支持行为树引用方式的重用而非复制的方式(这种方式修改原树已经复制的树数据无法跟着变化导致重用性效率大打折扣)</strong></li>
</ol>
<h2 id="个人心得"><a href="#个人心得" class="headerlink" title="个人心得"></a>个人心得</h2><ol>
<li><strong>事件驱动行为树相比传统行为树最大的优势就是树更新的开销，前者基于定时器可以做到通知打断+子节点通知父节点运行结果的单向执行(不用每帧从根节点开始)，后者是每次都从根节点开始的遍历执行，后者每帧都会从根节点再走一遍流程到之前的节点继续运行(同时打断设计不好设计成基于定时器减少更新频率)</strong></li>
<li><strong>UIElement的GraphView把逻辑节点(Node)和边(Edge)数据和节点(NodeView)和边(NodeView)显示抽象分离的很好，可以高度自由的编写显示节点(NodeView)和边(EdgeView)</strong></li>
</ol>
<h2 id="GitHub"><a href="#GitHub" class="headerlink" title="GitHub"></a>GitHub</h2><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/EventBehaviourTree">EventBehaviourTree</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://github.com/meniku/NPBehave/tree/master">NPBehave</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-properties.html">USS properties reference</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/UIElements.IStyle.html">IStyle</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-ElementRef.html">UXML现有可用Element查询</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-built-in-variable-reference.html">USS built-in variable references</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Reference.html">Event Reference</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=7KHGH0fPL84">UNITY DIALOGUE GRAPH TUTORIAL - Setup</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/AI/">AI</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AI/">AI</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://tonytang1990.github.io/2025/03/24/%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91/" data-title="事件驱动行为树 | 走停人生路" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2026/01/12/Copilot/" title="Copilot">
  <strong>上一篇：</strong><br/>
  <span>
  Copilot</span>
</a>
</div>


<div class="next">
<a href="/2025/03/12/ECS架构/"  title="ECS架构">
 <strong>下一篇：</strong><br/> 
 <span>ECS架构
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%8C%E4%B8%BA%E6%A0%91"><span class="toc-number">2.</span> <span class="toc-text">行为树</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%8C%E4%B8%BA%E6%A0%91%E8%8A%82%E7%82%B9%E7%BC%96%E8%BE%91%E5%99%A8"><span class="toc-number">3.</span> <span class="toc-text">行为树节点编辑器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.1.</span> <span class="toc-text">节点设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E9%80%89%E6%8B%A9%E5%88%97%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.2.</span> <span class="toc-text">节点选择列表设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C%E6%98%BE%E7%A4%BA%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.3.</span> <span class="toc-text">节点操作显示设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GraphView%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.3.1.</span> <span class="toc-text">GraphView设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StyleSheet%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.2.</span> <span class="toc-text">StyleSheet添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.3.</span> <span class="toc-text">节点创建添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E8%87%AA%E5%AE%9A%E4%B9%89UI%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.4.</span> <span class="toc-text">节点自定义UI添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9Port%E5%88%9B%E5%BB%BA%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.5.</span> <span class="toc-text">节点Port创建添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9Port%E8%BF%9E%E7%BA%BF%E5%8A%9F%E8%83%BD%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.6.</span> <span class="toc-text">节点Port连线功能添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9Port%E8%BF%9E%E7%BA%BF%E8%BF%98%E5%8E%9F"><span class="toc-number">3.3.7.</span> <span class="toc-text">节点Port连线还原</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%8F%82%E6%95%B0%E9%9D%A2%E6%9D%BF%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.8.</span> <span class="toc-text">节点参数面板添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%8F%B3%E9%94%AE%E6%93%8D%E4%BD%9C%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.9.</span> <span class="toc-text">节点右键操作添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E7%AB%AF%E5%8F%A3%E8%8A%82%E7%82%B9%E8%BE%B9%E9%A1%BA%E5%BA%8F%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E6%8E%92%E5%BA%8F%E6%98%BE%E7%A4%BA"><span class="toc-number">3.3.10.</span> <span class="toc-text">输出端口节点边顺序索引数据排序显示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E7%BD%91%E6%A0%BC%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.11.</span> <span class="toc-text">背景网格添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%BE%E6%95%B0%E6%8D%AE%E6%8B%96%E6%8B%BD%E9%87%8D%E7%94%A8"><span class="toc-number">3.3.12.</span> <span class="toc-text">图数据拖拽重用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6"><span class="toc-number">3.3.13.</span> <span class="toc-text">节点数据复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%91%E6%9D%BF%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.14.</span> <span class="toc-text">黑板数据</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%91%E6%9D%BF%E6%95%B0%E6%8D%AE%E8%BF%90%E8%A1%8C%E6%97%B6%E5%AD%98%E5%82%A8"><span class="toc-number">3.3.14.1.</span> <span class="toc-text">黑板数据运行时存储</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%91%E6%9D%BF%E6%95%B0%E6%8D%AE%E8%BF%90%E8%A1%8C%E6%97%B6%E9%A9%B1%E5%8A%A8%E5%92%8C%E9%80%9A%E7%9F%A5"><span class="toc-number">3.3.14.2.</span> <span class="toc-text">黑板数据运行时驱动和通知</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%91%E6%9D%BF%E6%95%B0%E6%8D%AE%E7%BC%96%E8%BE%91%E5%99%A8%E7%BC%96%E8%BE%91%E5%92%8C%E5%AD%98%E5%82%A8%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.3.14.3.</span> <span class="toc-text">黑板数据编辑器编辑和存储加载</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GraphView%E6%93%8D%E4%BD%9C%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.15.</span> <span class="toc-text">GraphView操作添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2"><span class="toc-number">3.3.16.</span> <span class="toc-text">坐标转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%BF%9D%E5%AD%98%E5%92%8C%E5%8A%A0%E8%BD%BD%E6%B7%BB%E5%8A%A0"><span class="toc-number">3.3.17.</span> <span class="toc-text">数据保存和加载添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%92%A4%E9%94%80%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.3.18.</span> <span class="toc-text">撤销系统</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91"><span class="toc-number">4.</span> <span class="toc-text">事件驱动行为树</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E7%B1%BB%E5%9B%BE%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.1.</span> <span class="toc-text">事件驱动行为树类图设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%95%B0%E6%8D%AE%E7%BC%96%E8%BE%91"><span class="toc-number">4.2.</span> <span class="toc-text">事件驱动行为树数据编辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E6%9E%84%E5%BB%BA"><span class="toc-number">4.3.</span> <span class="toc-text">事件驱动行为树运行时数据构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%89%A7%E8%A1%8C%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.4.</span> <span class="toc-text">事件驱动行为树执行设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%9D%A1%E4%BB%B6%E5%88%A4%E5%AE%9A%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.5.</span> <span class="toc-text">事件驱动行为树条件判定设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E9%BB%91%E6%9D%BF"><span class="toc-number">4.6.</span> <span class="toc-text">事件驱动行为树黑板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%89%93%E6%96%AD"><span class="toc-number">4.7.</span> <span class="toc-text">事件驱动行为树打断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%89%93%E6%96%AD%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">4.7.1.</span> <span class="toc-text">事件驱动行为树打断单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Stops-NONE"><span class="toc-number">4.7.1.1.</span> <span class="toc-text">Stops.NONE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stops-SELF"><span class="toc-number">4.7.1.2.</span> <span class="toc-text">Stops.SELF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stops-LOWER-PRIORITY"><span class="toc-number">4.7.1.3.</span> <span class="toc-text">Stops.LOWER_PRIORITY</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stops-BOTH"><span class="toc-number">4.7.1.4.</span> <span class="toc-text">Stops.BOTH</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stops-LOWER-PRIORITY-IMMEDIATE-RESTART"><span class="toc-number">4.7.1.5.</span> <span class="toc-text">Stops.LOWER_PRIORITY_IMMEDIATE_RESTART</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stops-IMMEDIATE-RESTART"><span class="toc-number">4.7.2.</span> <span class="toc-text">Stops.IMMEDIATE_RESTART</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%9A%82%E5%81%9C"><span class="toc-number">4.8.</span> <span class="toc-text">事件驱动行为树暂停</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E8%B0%83%E8%AF%95"><span class="toc-number">4.9.</span> <span class="toc-text">事件驱动行为树调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E8%A1%8C%E4%B8%BA%E6%A0%91%E5%AE%9E%E6%88%98"><span class="toc-number">4.10.</span> <span class="toc-text">事件驱动行为树实战</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AA%E6%9D%A5%E8%AE%A1%E5%88%92"><span class="toc-number">4.11.</span> <span class="toc-text">未来计划</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AA%E4%BA%BA%E5%BF%83%E5%BE%97"><span class="toc-number">5.</span> <span class="toc-text">个人心得</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitHub"><span class="toc-number">6.</span> <span class="toc-text">GitHub</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">7.</span> <span class="toc-text">Reference</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2026 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
