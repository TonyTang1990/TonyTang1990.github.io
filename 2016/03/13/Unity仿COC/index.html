
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Unity仿COC | 走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta name="description" content="Preface(序言)What is COC?COC(Clash of Clans) is a freemium mobile MMO strategy video game developed and published by Supercell.The game was released for iOS platforms on 2 August, 2012,[1] and on Google">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity仿COC">
<meta property="og:url" content="http://tonytang1990.github.io/2016/03/13/Unity仿COC/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:description" content="Preface(序言)What is COC?COC(Clash of Clans) is a freemium mobile MMO strategy video game developed and published by Supercell.The game was released for iOS platforms on 2 August, 2012,[1] and on Google">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/MyCOC.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/COCModel.JPG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/AgeOfEmpires.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Diablo2.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/FSM.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/AI_DecisionTree.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/Adjacency _Matrix.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/AI/Adjacency_List.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/mHCostPercentage1.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/mHCostPercentage1point5.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/mHCostPercentage1withWall.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/mHCostPercentage1point5withWall.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/mHCostPercentage1withMoreWall.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/mHCostPercentage1point5withMoreWall.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/WithWallWeightValue.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/WithoutWallWeightValue.PNG">
<meta property="og:updated_time" content="2019-03-04T16:47:06.833Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity仿COC">
<meta name="twitter:description" content="Preface(序言)What is COC?COC(Clash of Clans) is a freemium mobile MMO strategy video game developed and published by Supercell.The game was released for iOS platforms on 2 August, 2012,[1] and on Google">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.jpg" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/13/Unity仿COC/" title="Unity仿COC" itemprop="url">Unity仿COC</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-03-13T11:14:35.000Z" itemprop="datePublished"> 發表於 2016-03-13</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目錄</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Preface(序言)"><span class="toc-number">1.</span> <span class="toc-text">Preface(序言)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What_is_COC?"><span class="toc-number">1.1.</span> <span class="toc-text">What is COC?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#My_COC_Experience"><span class="toc-number">1.2.</span> <span class="toc-text">My COC Experience</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#COC_Project(Unity)"><span class="toc-number">2.</span> <span class="toc-text">COC Project(Unity)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Preparation"><span class="toc-number">2.1.</span> <span class="toc-text">Preparation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity"><span class="toc-number">2.1.1.</span> <span class="toc-text">Unity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Programming_Language(C#)"><span class="toc-number">2.1.2.</span> <span class="toc-text">Programming Language(C#)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AI"><span class="toc-number">2.1.3.</span> <span class="toc-text">AI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Knowledge"><span class="toc-number">2.1.4.</span> <span class="toc-text">Knowledge</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Is_COC_a_2D_game_or_3D_game?"><span class="toc-number">2.1.4.1.</span> <span class="toc-text">Is COC a 2D game or 3D game?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Isometric_Tileset_Engine"><span class="toc-number">2.1.4.2.</span> <span class="toc-text">Isometric Tileset Engine</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#What_is_Isometric_Tileset_Engine?"><span class="toc-number">2.1.4.2.1.</span> <span class="toc-text">What is Isometric Tileset Engine?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#What_does_game_with_isometric_projection_look_like?"><span class="toc-number">2.1.4.2.2.</span> <span class="toc-text">What does game with isometric projection look like?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#How_to_make_game_work_under_isometric_projection?"><span class="toc-number">2.1.4.2.3.</span> <span class="toc-text">How to make game work under isometric projection?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Searching"><span class="toc-number">2.1.5.</span> <span class="toc-text">Searching</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#How_to_develope_COC_like_game?"><span class="toc-number">2.1.5.1.</span> <span class="toc-text">How to develope COC like game?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Project"><span class="toc-number">2.2.</span> <span class="toc-text">Project</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Game_Engine"><span class="toc-number">2.2.1.</span> <span class="toc-text">Game Engine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Programming_Language"><span class="toc-number">2.2.2.</span> <span class="toc-text">Programming Language</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Developer_Tool"><span class="toc-number">2.2.3.</span> <span class="toc-text">Developer Tool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Basic_Setting_with_Scene"><span class="toc-number">2.2.4.</span> <span class="toc-text">Basic Setting with Scene</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Camera_Control_&_Input"><span class="toc-number">2.2.5.</span> <span class="toc-text">Camera Control & Input</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PC"><span class="toc-number">2.2.5.1.</span> <span class="toc-text">PC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mobile"><span class="toc-number">2.2.5.2.</span> <span class="toc-text">Mobile</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UI"><span class="toc-number">2.2.6.</span> <span class="toc-text">UI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Map"><span class="toc-number">2.2.7.</span> <span class="toc-text">Map</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Map_Type"><span class="toc-number">2.2.7.1.</span> <span class="toc-text">Map Type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Map_Save"><span class="toc-number">2.2.7.2.</span> <span class="toc-text">Map Save</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Event_Manager"><span class="toc-number">2.2.8.</span> <span class="toc-text">Event Manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Object_Pool"><span class="toc-number">2.2.9.</span> <span class="toc-text">Object Pool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Utilities"><span class="toc-number">2.2.10.</span> <span class="toc-text">Utilities</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AI-1"><span class="toc-number">2.2.11.</span> <span class="toc-text">AI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#A_Star"><span class="toc-number">2.2.11.1.</span> <span class="toc-text">A Star</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Searching-1"><span class="toc-number">2.2.11.1.1.</span> <span class="toc-text">Searching</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Create_Myself_A_Star"><span class="toc-number">2.2.11.1.2.</span> <span class="toc-text">Create Myself A Star</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#A_Star_Preperation"><span class="toc-number">2.2.11.1.2.1.</span> <span class="toc-text">A Star Preperation</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#PriorityQueue"><span class="toc-number">2.2.11.1.2.2.</span> <span class="toc-text">PriorityQueue</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#A_Star-1"><span class="toc-number">2.2.11.1.2.3.</span> <span class="toc-text">A Star</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Optimization"><span class="toc-number">2.2.12.</span> <span class="toc-text">Optimization</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sumary"><span class="toc-number">2.3.</span> <span class="toc-text">Sumary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Final_Effect"><span class="toc-number">2.4.</span> <span class="toc-text">Final Effect</span></a></li></ol></li></ol>
		
		</div>
		
		<h1 id="Preface(序言)">Preface(序言)</h1><h2 id="What_is_COC?">What is COC?</h2><p>COC(Clash of Clans) is a freemium mobile MMO strategy video game developed and published by Supercell.The game was released for iOS platforms on 2 August, 2012,[1] and on Google Play for Android on 7 October, 2013<br>(<a href="https://en.wikipedia.org/wiki/Clash_of_Clans" target="_blank" rel="external">from wiki</a>)</p>
<h2 id="My_COC_Experience">My COC Experience</h2><p>我第一次接触COC大概是在2014年2月份，当时被朋友拉着一起玩这个游戏，三个人建立了自己的小部落，后来陆陆续续拉了不少朋友加入，口口相传，部落成长到40人的部落，从此以后就一发不可收拾。<br>这款游戏最吸引我的地方有以下几点：</p>
<ol>
<li>游戏时间碎片化（采用真实时间计时），不需要玩家长时间在线。</li>
<li>线上进攻布局，线下防守的玩法。</li>
<li>不同兵种和法术的不同特性使得玩家的手法和路线规划显得尤为重要（后来出的部落战尤其体现了这一点）。</li>
<li>部落的概念，增强了集体的概念和玩家间的互动（分享进攻防守记录，打部落战，聊天，捐兵等）</li>
<li>资深COC玩家来说，游戏的种树文化也不得不说是一种游戏乐趣。</li>
</ol>
<p>贴一张我的COC图已做留念<br><img src="/img/Unity/MyCOC.PNG" alt="My COC"></p>
<p>为了这个游戏还买过COC模型<br><img src="/img/Unity/COCModel.JPG" alt="COC Model"></p>
<p>经历了两年多的COC洗礼，经历了部落解散，部落合并，到现在最后一起坚持到最后的7,8个小伙伴（基本都满防满王了），感慨万千（此处省略一万字）。</p>
<p>出于自己是做游戏开发的缘故，刚开始学习Unity（同时学习C#），所以决定以COC为模板来制作学习Unity。就这样我的Unity COC计划就这样开始了，虽然最后只实现了很小一部分东西（而且很不完美，但学到很多东西），所以写下这个篇文章来总结自己学到的一些东西。</p>
<h1 id="COC_Project(Unity)">COC Project(Unity)</h1><h2 id="Preparation">Preparation</h2><h3 id="Unity">Unity</h3><p>(<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/">Unity Study</a>)</p>
<h3 id="Programming_Language(C#)">Programming Language(C#)</h3><p>(<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/">C# Study</a>)</p>
<p>参考书籍：<br><a href="http://download.csdn.net/download/baiyu9821179/4282298" target="_blank" rel="external">C#入门经典第五版</a><br>CLR Via C# Fourth Edition - Jeffrey Richter</p>
<h3 id="AI">AI</h3><p>(<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">Artificial-Inteligence-Study</a>)</p>
<h3 id="Knowledge">Knowledge</h3><h4 id="Is_COC_a_2D_game_or_3D_game?">Is COC a 2D game or 3D game?</h4><p>The answer is 2D game，actually we should call 2.5D.<br>第一眼看到COC里面的所有动画人物给人的感觉都是3D的，但后来知道了Isometric Tileset Engine的概念。</p>
<h4 id="Isometric_Tileset_Engine">Isometric Tileset Engine</h4><h5 id="What_is_Isometric_Tileset_Engine?">What is Isometric Tileset Engine?</h5><p>(<a href="http://blog.codingnow.com/2014/01/isometric_tileset_engine.html" target="_blank" rel="external">斜视角游戏的地图渲染</a>)<br>(<a href="http://flarerpg.org/tutorials/isometric_intro/" target="_blank" rel="external">Isometric Tiles Introduction</a>)<br>结合上述文章，我们可以知道，Isometric Tileset Engine主要是通过美术制作出Isometric Projection（we angle our camera along two axes (swing the camera 45 degrees to one side, then 30 degrees down)）的2D图片来实现游戏的3D效果（2.5D）。</p>
<h5 id="What_does_game_with_isometric_projection_look_like?">What does game with isometric projection look like?</h5><p>典型的Isometric Projection游戏有：<br>Age of Empires<br><img src="/img/Unity/AgeOfEmpires.PNG" alt="Age of Empires"><br>Diablo 2<br><img src="/img/Unity/Diablo2.PNG" alt="Diablo2"></p>
<h5 id="How_to_make_game_work_under_isometric_projection?">How to make game work under isometric projection?</h5><p>(<a href="http://gamedevelopment.tutsplus.com/tutorials/creating-isometric-worlds-a-primer-for-game-developers--gamedev-6511" target="_blank" rel="external">参考:Creating Isometric Worlds: A Primer for Game Developers</a>)<br>从标准的2D游戏到isometric projection的2.5D注意事项</p>
<ol>
<li>Coordinates Transformation — From Cartesian to isometric coordiates</li>
<li>Creating the Art — isometric projection art</li>
<li>Collision Detection — based on rectangle that is caculated from isometric projection</li>
</ol>
<h3 id="Searching">Searching</h3><h4 id="How_to_develope_COC_like_game?">How to develope COC like game?</h4><p>云风参与开发的陌陌争霸<br>(<a href="http://blog.codingnow.com/2014/01/routemap.html" target="_blank" rel="external">参考:COC Like 游戏中的寻路算法</a>)<br>从上面我们可以看出通过对不同建筑队不同兵种的路径的预算，我们可以在在城墙未被破坏的前提下实现O(1)的速度查询建筑距离信息。（但这里我没明白云风大哥所说的”如果下一个行军路线是城墙就攻打城墙” — 这个前提下怎么实现远距离攻打城墙的效果，所以最终并未采取这种方式实现）。</p>
<h2 id="Project">Project</h2><h3 id="Game_Engine">Game Engine</h3><p>Unity</p>
<h3 id="Programming_Language">Programming Language</h3><p>C#</p>
<h3 id="Developer_Tool">Developer Tool</h3><p>Unity<br>VS2013 / VS2010 (IDE)<br>ILDissembler — 反编译工具<br>Blender — 建模工具（本来打算学习并使用这个，但由于游戏最终并未做出来，都只是使用Unity官网的一些现有模型）<br>Git — 版本控制<br><a href="https://github.com/TonyTang1990/PathFinding/commits/master" target="_blank" rel="external">项目地址</a></p>
<h3 id="Basic_Setting_with_Scene">Basic Setting with Scene</h3><p>Scene — 3D Scene(考虑2.5D素材的缘故，直接采用3D场景来学习制作2.5D游戏)<br>Camera — Orthographic Projection(通过采用正交投影并旋转摄像机X轴35度，Y轴45度来模拟Isometric Projection)</p>
<h3 id="Camera_Control_&amp;_Input">Camera Control &amp; Input</h3><h4 id="PC">PC</h4><p>PC主要通过GetAxis()来针对用户的上下左右控制<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> moveHorizontal = Input.GetAxis (<span class="string">"Horizontal"</span>) * mMoveSpeed * Time.deltaTime;</span><br><span class="line"><span class="keyword">float</span> moveVertical = Input.GetAxis (<span class="string">"Vertical"</span>) * mMoveSpeed * Time.deltaTime;</span><br></pre></td></tr></table></figure></p>
<h4 id="Mobile">Mobile</h4><p>Mobile主要通过Input.touch来获取屏幕点击事件信息<br>遇到得问题：<br><strong>点击到UI上的时候touch事件并未被吞噬</strong><br>Solved — 通过UnityEngine.EventSystems.EventSystem.current.IsPointerOverGameObject(Input.touches[0].fingerId)来判断是否点击到UI上<br>e.g.<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f (!UnityEngine.EventSystems.EventSystem.current.IsPointerOverGameObject (Input.touches[<span class="number">0</span>].fingerId));</span><br></pre></td></tr></table></figure></p>
<ol>
<li>单指和多指的处理<br>通过Input.touchCount分别作处理，多指的处理主要通过遍历Input.touches来判断多指的具体行为<br>遇到的问题：<br><strong>单指相应速度过快</strong><br>Solved — 通过定义一个有效的单指响应时间，只有当每帧DeltaTime时间叠加超过有效响应时间的时候才响应输入<br>e.g.<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">	mInputTimer += Time.deltaTime;</span><br><span class="line">	<span class="keyword">if</span> (Input.touchCount == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(Input.touches[<span class="number">0</span>].phase == TouchPhase.Ended &amp;&amp; (mInputTimer &gt; mValidInputDeltaTime))</span><br><span class="line">		&#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>两根手指如何判断是拉远还是缩近地图</strong><br>Solved — 主要通过判断两根手指每一帧的距离是变大还是变小来判断<br>e.g.<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (Input.touches[i].phase == TouchPhase.Began)</span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentTouchFingerPos[i] = Input.touches[<span class="number">0</span>].position;</span><br><span class="line">        mPreTouchFingerPos[i] = Input.touches[<span class="number">0</span>].position;</span><br><span class="line">        mTouchFingerDeltaPos[i] = Vector2.zero;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mPreTwoFingersDistance = mCurrentTwoFingersDistance;</span><br><span class="line">            mCurrentTwoFingersDistance = Vector2.Distance(mCurrentTouchFingerPos[<span class="number">0</span>], mCurrentTouchFingerPos[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">Input.touches[i].phase == TouchPhase.Moved</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mPreTouchFingerPos[i] = mCurrentTouchFingerPos[i];</span><br><span class="line">        mCurrentTouchFingerPos[i] = Input.touches[i].position;</span><br><span class="line">        mTouchFingerDeltaPos[i] = Input.touches[i].deltaPosition;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mPreTwoFingersDistance = mCurrentTwoFingersDistance;</span><br><span class="line">            mCurrentTwoFingersDistance = Vector2.Distance(mCurrentTouchFingerPos[<span class="number">0</span>], mCurrentTouchFingerPos[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">Input.touches[i].phase == TouchPhase.Ended</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mCurrentTouchFingerPos[i] = Vector2.zero;</span><br><span class="line">        mPreTouchFingerPos[i] = Vector2.zero;</span><br><span class="line">        mTouchFingerDeltaPos[i] = Vector2.zero;</span><br><span class="line">        mCurrentTwoFingersDistance = <span class="number">0.0</span>f;</span><br><span class="line">        mPreTwoFingersDistance = <span class="number">0.0</span>f;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="UI">UI</h3><p>UI主要使用Unity自带的UI，主要以一个按钮一个方法响应的基本方式。</p>
<p>UI有几个重要的概念：</p>
<ol>
<li>Unity里所有的UI elements都是包含在Canvas里。</li>
<li>UI的Render Mode主要分为三种<br> 2.1 Screen Space — Overlay(Rendered on top of the secene)<br> 2.2 Screen Space — Camera(有距离感的UI，受摄像机设置影响)<br> 2.3 World Space(3D UI,有深度概念，会被3D物体遮挡)</li>
</ol>
<p>UI自适应里的重要概念：</p>
<ol>
<li>UI Scale Mode<br> 1.1 Constant Pixel Size<br> 1.2 Scale With Screen Size(自适应里比较重的一种，会根据设定分辨率比例自动扩大或缩小UI)<br> 1.3 Constant Physical Size</li>
<li>Anchors — 这个我的理解是根据锚点的四个点相对父节点位置的设置，会决定子节点UI如何针对父节点的变化而变化<br>比如锚点的四个点分别位于父节点的四个角落，那就表示子节点UI会根据父节点的放大缩小做出一致的变化。<br>比如锚点的四个点都在父节点的四个角落中的一个角落，就表示，无论父节点如何变化，子节点UI都不会变化并且相对于父节点锚点的那个点的相对位置是不变的。</li>
</ol>
<p><a href="http://docs.unity3d.com/Manual/UISystem.html" target="_blank" rel="external">更多的UI概念参考官网学习</a></p>
<h3 id="Map">Map</h3><h4 id="Map_Type">Map Type</h4><p>Tile Map<br>地图是基于一块一块的Tile构成，默认40 * 40</p>
<h4 id="Map_Save">Map Save</h4><p>C# System.Runtime.Serialization — 序列化来存储Map数据<br>Unity [System.Serializable] — 支持在编辑器可视化</p>
<p>遇到的问题：</p>
<ol>
<li><p>Unity一些自带的基础类型不支持Serializable<br>e.g. UnityEngine.Vector3(is not marked as Serializable)<br>Solved — 需要自定义Seralizable的Struct来封装Vector3数据</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> BuildingPosition</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> mX;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> mY;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> mZ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Unity挂载和类继承问题<br>Unity要挂载到GameObject上必须继承至MonoBehaviour,但C#不支持多重继承<br>Solved — 定义interface，通过extends interface来实现C#中的多重继承（这一点和Java很像）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public interface GameObjectType &#123;</span><br><span class="line">	ObjectType GameType</span><br><span class="line">	&#123;</span><br><span class="line">		get;</span><br><span class="line">		set;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line">public class Building : MonoBehaviour, GameObjectType &#123;</span><br><span class="line">	.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Event_Manager">Event Manager</h3><p>主要用于事件监听。（UnityAction是无参并返回void类型的的Delegate）<br>遇到的问题：</p>
<ol>
<li>对于带参数的事件监听<br>Solved — 通过继承UnityEvent<t>实现带特定参数的Delegate监听<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine.Events;</span><br><span class="line"></span><br><span class="line">public class MyIntEvent : UnityEvent&lt;int&gt;</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class EventManager : MonoBehaviour &#123;</span><br><span class="line"></span><br><span class="line">	private Dictionary&lt;string, UnityEvent&gt; mEventDictionary;</span><br><span class="line"></span><br><span class="line">    private Dictionary&lt;string, MyIntEvent&gt; mIntEventDictionary;</span><br><span class="line"></span><br><span class="line">	public static EventManager mEMInstance = null;</span><br><span class="line"></span><br><span class="line">	void Awake()</span><br><span class="line">	&#123;</span><br><span class="line">		if (mEMInstance == null) &#123;</span><br><span class="line">			mEMInstance = this;</span><br><span class="line">			mEMInstance.Init();</span><br><span class="line">		&#125; else if (mEMInstance != this) &#123;</span><br><span class="line">			Destroy(gameObject);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	void Init()</span><br><span class="line">	&#123;</span><br><span class="line">		if (mEventDictionary == null) &#123;</span><br><span class="line">			mEventDictionary = new Dictionary&lt;string, UnityEvent&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">        if (mIntEventDictionary == null)</span><br><span class="line">        &#123;</span><br><span class="line">            mIntEventDictionary = new Dictionary&lt;string, MyIntEvent&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void StartListening(string eventname, UnityAction listener)</span><br><span class="line">	&#123;</span><br><span class="line">		UnityEvent evt = null;</span><br><span class="line">		if (mEMInstance.mEventDictionary.TryGetValue (eventname, out evt)) &#123;</span><br><span class="line">			evt.AddListener (listener);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			evt = new UnityEvent();</span><br><span class="line">			evt.AddListener(listener);</span><br><span class="line">			mEMInstance.mEventDictionary.Add(eventname, evt);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void StopListening(string eventname, UnityAction listener)</span><br><span class="line">	&#123;</span><br><span class="line">		if (mEMInstance == null) &#123;</span><br><span class="line">			return ;</span><br><span class="line">		&#125;</span><br><span class="line">		UnityEvent thisevent = null;</span><br><span class="line">		if (mEMInstance.mEventDictionary.TryGetValue (eventname, out thisevent)) &#123;</span><br><span class="line">			thisevent.RemoveListener(listener);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    public void StartListening(string eventname, UnityAction&lt;int&gt; listener)</span><br><span class="line">    &#123;</span><br><span class="line">        MyIntEvent evt = null;</span><br><span class="line">        if (mEMInstance.mIntEventDictionary.TryGetValue(eventname, out evt))</span><br><span class="line">        &#123;</span><br><span class="line">            evt.AddListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            evt = new MyIntEvent();</span><br><span class="line">            evt.AddListener(listener);</span><br><span class="line">            mEMInstance.mIntEventDictionary.Add(eventname, evt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void StopListening(string eventname, UnityAction&lt;int&gt; listener)</span><br><span class="line">    &#123;</span><br><span class="line">        if (mEMInstance == null)</span><br><span class="line">        &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        MyIntEvent thisevent = null;</span><br><span class="line">        if (mEMInstance.mIntEventDictionary.TryGetValue(eventname, out thisevent))</span><br><span class="line">        &#123;</span><br><span class="line">            thisevent.RemoveListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool HasListening(string eventname)</span><br><span class="line">    &#123;</span><br><span class="line">        if (mEMInstance == null)</span><br><span class="line">        &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        UnityEvent thisevent = null;</span><br><span class="line">        MyIntEvent intevent = null;</span><br><span class="line">        if (mEMInstance.mEventDictionary.TryGetValue(eventname, out thisevent))</span><br><span class="line">        &#123;</span><br><span class="line">            if(thisevent != null)</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (mEMInstance.mIntEventDictionary.TryGetValue(eventname, out intevent))</span><br><span class="line">        &#123;</span><br><span class="line">            if (intevent != null)</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	public void TriggerEvent(string eventname, int p = 0)</span><br><span class="line">	&#123;</span><br><span class="line">		UnityEvent thisevent = null;</span><br><span class="line">		if (mEMInstance.mEventDictionary.TryGetValue (eventname, out thisevent)) &#123;</span><br><span class="line">			if(thisevent != null)</span><br><span class="line">            &#123;</span><br><span class="line">                thisevent.Invoke();</span><br><span class="line">            &#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        MyIntEvent intevent = null;</span><br><span class="line">        if (mEMInstance.mIntEventDictionary.TryGetValue(eventname, out intevent))</span><br><span class="line">        &#123;</span><br><span class="line">            if (intevent != null)</span><br><span class="line">            &#123;</span><br><span class="line">                intevent.Invoke(p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</t></li>
</ol>
<h3 id="Object_Pool">Object Pool</h3><p>主要为了重用GameObject，减少Instantiate的调用。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ObjectPoolManager</span> : <span class="title">MonoBehaviour</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ObjectPoolManager mObjectPoolManagerInstance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mBuildingBullet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mBBulletPoolAmount = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;GameObject&gt; mBBulletsList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mSoldierBullet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mSBulletPoolAmount = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;GameObject&gt; mSBulletsList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> mWillGrow = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mObjectPoolManagerInstance == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mObjectPoolManagerInstance = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">mObjectPoolManagerInstance != <span class="keyword">this</span></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            Destroy(gameObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mBBulletsList = <span class="keyword">new</span> List&lt;GameObject&gt;();</span><br><span class="line">        mSBulletsList = <span class="keyword">new</span> List&lt;GameObject&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mBBulletPoolAmount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject bbulletobj = Instantiate(mBuildingBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            bbulletobj.SetActive(<span class="keyword">false</span>);</span><br><span class="line">            mBBulletsList.Add(bbulletobj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; mSBulletPoolAmount; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject sbulletobj = Instantiate(mSoldierBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            sbulletobj.SetActive(<span class="keyword">false</span>);</span><br><span class="line">            mSBulletsList.Add(sbulletobj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameObject <span class="title">GetBuildingBulletObject</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mBBulletsList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mBBulletsList[i].activeInHierarchy)</span><br><span class="line">            &#123;</span><br><span class="line">                mBBulletsList[i].SetActive(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">return</span> mBBulletsList[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWillGrow)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject bbulletobj = Instantiate(mBuildingBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            mBBulletsList.Add(bbulletobj);</span><br><span class="line">            <span class="keyword">return</span> bbulletobj;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameObject <span class="title">GetSoldierBulletObject</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSBulletsList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSBulletsList[i].activeInHierarchy)</span><br><span class="line">            &#123;</span><br><span class="line">                mSBulletsList[i].SetActive(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">return</span> mSBulletsList[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWillGrow)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject sbulletobj = Instantiate(mSoldierBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            mSBulletsList.Add(sbulletobj);</span><br><span class="line">            <span class="keyword">return</span> sbulletobj;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Utilities">Utilities</h3><ol>
<li><p>FPS Display(用于显示FPS)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FPSDisplay</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> Text mFPSText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> mDeltaTime = <span class="number">0.0</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> mFPS = <span class="number">0.0</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		mDeltaTime += (Time.deltaTime - mDeltaTime) * <span class="number">0.1</span>f;</span><br><span class="line">		<span class="keyword">float</span> msec = mDeltaTime * <span class="number">1000.0</span>f;</span><br><span class="line">		mFPS = <span class="number">1.0</span>f / mDeltaTime;</span><br><span class="line">		mFPSText.text = <span class="keyword">string</span>.Format(<span class="string">"&#123;0:0.0&#125; ms (&#123;1:0.&#125; fps)"</span>, msec, mFPS);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Time Counter(用于计算时间消耗 — 比如A Star运算时间)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TimerCounter</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> TimerCounter TCInstance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Stopwatch mTimer;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">string</span> mName;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> TimeSpend</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mTimer.ElapsedMilliseconds;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> mTimeSpend;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TimerCounter <span class="title">CreateInstance</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (TCInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">			TCInstance = <span class="keyword">new</span> TimerCounter();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> TCInstance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DestroyInstance</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (TCInstance != <span class="keyword">null</span>) &#123;</span><br><span class="line">			TCInstance = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">TimerCounter</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		mTimer = <span class="keyword">new</span> Stopwatch ();</span><br><span class="line">		mName = <span class="string">"Default"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"><span class="keyword">string</span> name</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		mName = name;</span><br><span class="line">		mTimer.Start ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Restart</span>(<span class="params"><span class="keyword">string</span> name</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		mTimer.Reset ();</span><br><span class="line">		mTimer.Start ();</span><br><span class="line">		mName = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">End</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		mTimer.Stop ();</span><br><span class="line"></span><br><span class="line">		mTimeSpend = mTimer.ElapsedMilliseconds;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="AI-1">AI</h3><ol>
<li><p>FSM(Finite State Machine — 有限状态机)<br>通过把行为体的行为细分到几种状态来抽象行为体行为，不同状态的AI逻辑在对应的状态去编写。<br>下图来源：《Artificial Intelligence for Game》 — Ian Millington<br><img src="/img/Unity/FSM.PNG" alt="FSM"><br>游戏里把士兵的状态分为三种，MoveState, AttackState, IdleState。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">public class SoldierAttackState : SoldierState &#123;</span><br><span class="line"></span><br><span class="line">	private Soldier mSoldier; </span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class SoldierAttackState : SoldierState &#123;</span><br><span class="line"></span><br><span class="line">	private Soldier mSoldier; </span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class SoldierAttackState : SoldierState &#123;</span><br><span class="line"></span><br><span class="line">	private Soldier mSoldier; </span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line">public class Soldier : MonoBehaviour, GameObjectType</span><br><span class="line">&#123;</span><br><span class="line">    public SoldierState SCurrentState</span><br><span class="line">    &#123;</span><br><span class="line">        set</span><br><span class="line">        &#123;</span><br><span class="line">            if (mSCurrentState != null)</span><br><span class="line">            &#123;</span><br><span class="line">                mSCurrentState.ExitState();</span><br><span class="line">            &#125;</span><br><span class="line">            mSCurrentState = value;</span><br><span class="line">            mSCurrentState.EnterState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [HideInInspector]</span><br><span class="line">    private SoldierState mSCurrentState;</span><br><span class="line"></span><br><span class="line">    [HideInInspector]</span><br><span class="line">    public SoldierAttackState mSAttackState;</span><br><span class="line"></span><br><span class="line">    [HideInInspector]</span><br><span class="line">    public SoldierDeadState mSDeadState;</span><br><span class="line"></span><br><span class="line">    [HideInInspector]</span><br><span class="line">    public SoldierMoveState mSMoveState;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	public virtual void Awake()</span><br><span class="line">	&#123;</span><br><span class="line">	    mSAttackState = new SoldierAttackState(this);</span><br><span class="line"></span><br><span class="line">	    mSMoveState = new SoldierMoveState(this);</span><br><span class="line"></span><br><span class="line">	    mSDeadState = new SoldierDeadState(this);</span><br><span class="line"></span><br><span class="line">	    ......</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public virtual void Update()</span><br><span class="line">    &#123;</span><br><span class="line">        if (gameObject)</span><br><span class="line">        &#123;</span><br><span class="line">            mSCurrentState.UpdateState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Decision Trees(决策树 — 用于简单的AI(Decision making))<br>Decision Trees主要用于AI体做决策，通过对已知数据的分析判断，根据Decision Tree抉择出最终的决定（即AI行为）。（项目里我主要使用FSM而非Decision Trees）<br>下图来源：《Artificial Intelligence for Game》 — Ian Millington<br><img src="/img/Unity/AI_DecisionTree.PNG" alt="Decision Tree"></p>
</li>
<li>A Star(A Star是 <a href="https://en.wikipedia.org/wiki/Dijkstra&#39;s_algorithm" target="_blank" rel="external">Dijkstra</a>（著名的最短路径算法）基础上通过一个启发因子来预估给定节点到目标节点的距离来使得路径节点搜索是向目标节点方向逼近不至于出现搜索大量无效节点的情况)<br>(<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">AI相关学习</a>)</li>
</ol>
<h4 id="A_Star">A Star</h4><h5 id="Searching-1">Searching</h5><p>通过搜索，我发现网络上有现成的很完善的A Star的版本<br><a href="http://arongranberg.com/astar/" target="_blank" rel="external">A Star Pathfinding Project(Asset)</a><br>但通过使用后发现，里面所支持的Four,Six and Eight connections都不符合我的需求（每个点都和周围的八个点连通），所以最终放弃了A Star Pathfinding Project而决定自己实现自己的A Star Pathfinding</p>
<h5 id="Create_Myself_A_Star">Create Myself A Star</h5><h6 id="A_Star_Preperation">A Star Preperation</h6><p>结合<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">Artificial-Inteligence-Study</a>的学习，让我们了解下A Star里的一些基本概念和核心思想：<br>A Star属于什么图？<br>A Star里的图属于导航图（Navigation Graph），是基于开销的图搜索(cost-based graph searches)</p>
<p>导航图信息的数据存储？<br>邻接矩阵：<br><img src="/img/AI/Adjacency _Matrix.PNG" alt="Adjacency _Matrix"><br>邻接表：<br><img src="/img/AI/Adjacency_List.PNG" alt="Adjacency_List"><br>邻接表用于存储稀疏图非常有效，不会浪费空间来存储空链接。(邻接矩阵会存储大量无效数据(没有连接的边))<br>这里我们只需要每个点和周边的8个点相连接，所以可以定位成稀疏图。<br>当我们初始化地图数据的时候，会把所有的点和边以及点和周边相连接边等信息存储起来。<br>大部分操作都是插入和查询(一般不涉及删除，一旦地图创建好，一般只是修改节点信息而非删除节点(如果真要删除可以通过设定节点信息为INVALID_INDEX来实现而非真正删除))。<br>为了快速查询我们采用C#里的List &lt; Node &gt; 和List &lt; List &lt; Edge &gt; &gt;来存储节点信息和边连接信息。因为我们会用一个唯一的index去标识节点，所以当我们用节点index去访问节点数据的时候是O(1)的时间复杂度，添加节点到List里也是O(1)。同理，当我们用List &lt; List &lt; Edge &gt; &gt;来存储边连接信息(邻接表)的时候，我们可以通过List[index]去访问特定节点的边连接信息(O(1)，对于边连接信息的添加和删除(这里不是O(1)主要是因为添加的时候我们需要确保不会重复添加同一个边连接信息，删除的时候要去查询找到该边连接信息)<br>这样一来所有的节点和边链接信息就都存储起来了。</p>
<p>图搜索(寻路)是怎样基于图实现的了？<br>首先我们要明确我们的搜索目的，为什么这样说了，只有明确了搜索目的我们才能制定合理的搜索策略。<br>在之前的学习<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">Artificial-Inteligence-Study</a>中提到了盲目搜索(基于广度(Stack来模拟FILO)或者深度的搜索策略(Queue来模拟FIFO))和基于开销的搜索(最短路径开销的策略)。<br>因为这里我是为了找到最短路径，所以肯定采用的是基于开销的搜索策略。<br>基于开销的搜索策略的一个重要思想是边放松，边放松的核心思想是通过存储源节点到其他节点的最短路径信息，一边探索新边一边更新该最短路径信息(如果新的边加入导致A节点到B节点有更优的最短路径，那么就更新该A节点到B节点的最短路径信息。直到找到从源节点到目标节点的最短路径信息为止。)</p>
<p>SPT(Shortest Path Tree — 最短路径树)存储的就是源节点到其他节点的最短路径信息(只存储了搜索过的)。(List<edge>的方式存储起来，比如源节点是0，目标节点是8，那么最短路径存储即为List[0] = Edge(0,x) List[x] = Edge(x,y) …. List[8] = Edge(y,8))<br>Edge的抽象Edge(From,To)，From表示初始点，To表示结束点。</edge></p>
<p>知道了最短路径的存储，那么更重要的问题来了，这个最短路径是怎么推导出来的？<br>这里不得不提Dijstra算法和A Star算法。<br>Dijstra步骤 ：</p>
<ol>
<li>从源节点开始搜索，利用优先队列对在搜索的节点的GCost(源节点到搜索节点的距离)进行排序</li>
<li>Pop出到当前所有搜索过的节点里GCost最小的节点</li>
<li>添加到该节点的行进边作为抵达该节点的最短路径边(包含在SPT里)</li>
<li>基于该节点进行扩展搜索</li>
<li>如果在扩展搜索时有到该节点更短(GCost)的路线边出现就更新该点的GCost以及行进边信息</li>
<li>继续弹出搜索节点里GCost最小的节点</li>
<li>直到搜索到目标节点为止</li>
<li>最后通过最短路径树(SPT)从目标节点反推得出源节点到目标节点的最短路径行进路线</li>
</ol>
<p>Dijstra算法的缺点：<br>Dijkstra算法检查了太多的边。</p>
<p>Dijstra算法改进：<br>A Star — 和Dijkstra算法的唯一区别是对搜索边界上的点的开销(GCost)的计算。因为Dijstra的搜索扩展方向是由GCost决定的，所以A Star算法通过给GCost添加一个启发因子(H)来确保搜索行进方向。<br>F的计算：<br>F = G + H<br>G是到达一个节点的累计开销， H是一个启发因子，它给出的是节点到目标节点的估计距离。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//伪代码如下</span></span><br><span class="line"><span class="comment">//添加源节点开始Dijstra算法搜索</span></span><br><span class="line">mPQ.Clear();</span><br><span class="line">mPQ.Push(mFCosts[mISource]);</span><br><span class="line"><span class="comment">//Pop出所有搜索过的节点到目标节点FCost最小的节点</span></span><br><span class="line"><span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加当前搜索节点里FCost最小的行进边作为最短路径的边之一</span></span><br><span class="line">    <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="keyword">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">    &#123;</span><br><span class="line">        mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//直到找到目标节点为止</span></span><br><span class="line">    <span class="keyword">if</span> (nextclosestnode == mITarget)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以当前搜索节点里到目标节点最近的点为基准进行边扩展搜索</span></span><br><span class="line">    List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">    GraphEdge edge;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        edge = edgelist[i];</span><br><span class="line">        <span class="comment">//计算该节点到目标节点的H值，用于控制搜索行进方向(A*对Dijstra算法的改进)</span></span><br><span class="line">        <span class="keyword">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//算出到该节点的路径GCost</span></span><br><span class="line">        <span class="comment">//GCost是源节点到特定节点的实际距离(用于判断是否是源节点到特定节点更近的路线)</span></span><br><span class="line">        <span class="comment">//G+H是源节点通过特定节点到目标节点的预估距离(用于控制行进方向)</span></span><br><span class="line">        <span class="keyword">float</span> gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断搜索行进的节点是否已经有任何搜索边抵达过</span></span><br><span class="line">        <span class="comment">//如果没有抵达过，添加该边到搜索列表里(mSearchFrontier)，并添加更新到该新节点的最短距离GCost和预估距离FCost(GCost+H)</span></span><br><span class="line">        <span class="comment">//同时把该FCost作为该节点通过特定节点到目标节点的估算距离添加到队列里进行排序，</span></span><br><span class="line">        <span class="comment">//用于得出搜索节点里下一个离目标节点最近的节点index</span></span><br><span class="line">        <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="keyword">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">        &#123;</span><br><span class="line">            mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">            mGCosts[edge.To] = gcost;</span><br><span class="line">            <span class="comment">//添加的是特定节点到目标节点的估算距离G+H来作为排序的依据</span></span><br><span class="line">            mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">            mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果抵达过，那么就去判断当前路线(通过当前边到该节点的路线)的GCost是否比之前记录在GCost里到达该节点的GCost更小</span></span><br><span class="line">        <span class="comment">//如果更小就说明有新的更短的路径可以抵达该节点</span></span><br><span class="line">        <span class="comment">//更新到该节点的GCost，FCost用于下一次Pop当前搜索节点里里目标节点最近(FCost)的节点</span></span><br><span class="line">        <span class="comment">//同时更新到该节点的最短路径边</span></span><br><span class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">gcost &lt; mGCosts[edge.To]</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">            mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">            mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">            mSearchFrontier[edge.To] = edge;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面有一个关键的点(PriorityQueue)，用于得到所有搜索节点到目标节点的FCost最小的节点。<br>这里对于节点的操作主要是插入和修改。<br>为了快速得到当前搜索节点里里目标节点的估算距离最近的节点，我们需要对当前所有的搜索节点进行排序。<br>而这里每一次排序的时间复杂度很大程度就决定了A Star的时间消耗。<br>参考<a href="http://tonytang1990.github.io/2015/07/11/Sort-Algorithm/">排序算法概念</a>的学习<br>可以知道借助堆的特性，我们可以很容易的得到最大最小值。<br>原本堆排序要经历下列步骤:</p>
<ol>
<li>Init heap(创建最大堆（Build_Max_Heap）：初始化堆数据)</li>
<li>Adjust heap(最大堆调整（Max_Heapify）：将堆的末端子节点作调整，使得子节点永远小于父节点) — O(Log(n))</li>
<li>Sort heap(堆排序（HeapSort）：移除位在第一个数据的根节点，并做最大堆调整的递归运算) — O(n)<br>但这里我们并不需要对堆进行完整的排序，我们只需每次插入或删除或修改的时候能得到最大或最小值即可(即只需要Adjust Heap即可)<br>这样一来每一次插入，删除或修改都只需O(Log(n))的时间复杂度。</li>
</ol>
<p>了解了理论，接下来一步一步看一下如何实现A Star算法的：<br>首先我们需要抽象出导航图里的节点和边<br>NavGraphNode里的mIsWall和mIsJumpable后续会讲到为什么会有这两个成员变量<br>e.g.<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GraphEdge</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GraphEdge</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mFrom = (<span class="keyword">int</span>)E_NODE_INDEX.INVALID_NODE;</span><br><span class="line">        mTo = (<span class="keyword">int</span>)E_NODE_INDEX.INVALID_NODE;</span><br><span class="line">        mCost = <span class="number">0.0</span>f;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> From</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mFrom;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Assert(<span class="keyword">value</span> &gt;= <span class="number">0</span>, <span class="string">"mFrom must great or equal to 0"</span>);</span><br><span class="line">            mFrom = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mFrom;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> To</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mTo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Assert(<span class="keyword">value</span> &gt;= <span class="number">0</span>, <span class="string">"mTo must great or equal to 0"</span>);</span><br><span class="line">            mTo = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> Cost</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mCost;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Assert(<span class="keyword">value</span> &gt;= <span class="number">0</span>, <span class="string">"mCost must great or equal to 0"</span>);</span><br><span class="line">            mCost = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mCost;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NavGraphNode</span> : <span class="title">GraphNode</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">NavGraphNode</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">NavGraphNode</span>(<span class="params"><span class="keyword">int</span> index,Vector3 pos, <span class="keyword">float</span> weight, <span class="keyword">bool</span> iswall</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		Index = index;</span><br><span class="line">		mPosition = pos;</span><br><span class="line">		mWeight = weight;</span><br><span class="line">		mIsWall = iswall;</span><br><span class="line">		mIsJumpable = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> Index</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mIndex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mIndex = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mIndex;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Vector3 Position</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mPosition;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mPosition = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> Vector3 mPosition;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> Weight</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mWeight;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mWeight = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> mWeight;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">bool</span> IsWall</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mIsWall;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mIsWall = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> mIsWall;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">bool</span> IsJumpable</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mIsJumpable;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mIsJumpable = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> mIsJumpable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>抽象了节点和边后，我们就可以初始化我们的地图数据了<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGraph</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">	mNavGraph = <span class="keyword">new</span> SparseGraph&lt;NavGraphNode, GraphEdge&gt; (mRow * mColumn);</span><br><span class="line">	</span><br><span class="line">	mNavGraph.BDrawMap = mBDrawMap;</span><br><span class="line"></span><br><span class="line">	Vector3 nodeposition = <span class="keyword">new</span> Vector3 ();</span><br><span class="line">	<span class="keyword">int</span> nextindex = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//SparseGraph nodes data</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> rw = <span class="number">0</span>; rw &lt; mRow; rw++) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> col = <span class="number">0</span>; col &lt; mColumn; col++) &#123;</span><br><span class="line">			nodeposition = <span class="keyword">new</span> Vector3 (rw, <span class="number">0.0</span>f, col);</span><br><span class="line">			nextindex = mNavGraph.NextFreeNodeIndex;</span><br><span class="line">			mNavGraph.AddNode (<span class="keyword">new</span> NavGraphNode (nextindex, nodeposition, <span class="number">0.0</span>f, <span class="keyword">false</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//SparseGraph edges data</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> rw = <span class="number">0</span>; rw &lt; mRow; rw++) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> col = <span class="number">0</span>; col &lt; mColumn; col++) </span><br><span class="line">		&#123;</span><br><span class="line">			CreateAllNeighboursToGridNode(rw, col, mRow, mColumn);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mTotalNodes = mNavGraph.NumNodes();</span><br><span class="line">	mTotalEdges = mNavGraph.NumEdges ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样一来我们的地图基本数据就都创建完成了。<br>在实现A Star之前，我们需要一个优先队列来排序我们所搜索的所有边的优先级。</p>
<h6 id="PriorityQueue">PriorityQueue</h6><p>通过Search我发现C#没有自带的优先队列，所以需要自己实现<br>这里的优先队列主要要实现排第一位的永远是cost最低的（其他并不需要有序，因为A Star里面是通过pop出cost最低的边来进行搜索行进的）<br>这里我用到了<a href="http://tonytang1990.github.io/2015/07/11/Sort-Algorithm/">堆排序(Heap Sort)</a>：<br>平均时间复杂度：O(n log(n))<br>最坏时间复杂度：O(n log(n))<br>最优时间复杂度：O(n log(n)) (时间复杂度都跟堆的深度和数据长度相关，无可避免的需要去做堆调整和堆排序<br>所以最坏时间复杂度和最优时间复杂度都是O(nlog(n)<br>因为我们只需要确保第一个是cost最低的，所以我们并不需要每一次都完整的排序整个堆（完整排序的时间复杂度是n * Log(n)），我们只需要在每一次insert和pop的时候重新掉整一下堆即可（这样一来就可以在Log(n)的时间内保证第一个是cost最低的）<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using System;</span><br><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine.Assertions;</span><br><span class="line"></span><br><span class="line">public class PriorityQueue&lt;T1, T2&gt;</span><br><span class="line">&#123;</span><br><span class="line">	public PriorityQueue()</span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = new Heap&lt;T1, T2&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public PriorityQueue(int size)</span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = new Heap&lt;T1, T2&gt; (size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public PriorityQueue(Heap&lt;T1, T2&gt; heap)</span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = heap;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public PriorityQueue(List&lt;Pair&lt;T1,T2&gt;&gt; key)</span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = new Heap&lt;T1, T2&gt; (key);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public bool Empty()</span><br><span class="line">	&#123;</span><br><span class="line">		return (mHeap.Size() == 0);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    public void Clear()</span><br><span class="line">    &#123;</span><br><span class="line">        mHeap.Clear();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	public void Push(Pair&lt;T1, T2&gt; kvp)</span><br><span class="line">	&#123;</span><br><span class="line">		mHeap.Insert(kvp);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public Pair&lt;T1, T2&gt; Pop()</span><br><span class="line">	&#123;</span><br><span class="line">		Pair&lt;T1,T2&gt; result = mHeap.Top();</span><br><span class="line">		mHeap.RemoveTop();</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public int Size()</span><br><span class="line">	&#123;</span><br><span class="line">		return mHeap.Size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public Pair&lt;T1, T2&gt; Top()</span><br><span class="line">	&#123;</span><br><span class="line">		return mHeap.Top(); ;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void ChangePriority(T1 index)</span><br><span class="line">	&#123;</span><br><span class="line">		//Assert.IsTrue (index &gt;= 0 &amp;&amp; index &lt; mHeap.Size ());</span><br><span class="line">		int i = 0;</span><br><span class="line">		i  = mHeap.FindSpecificKeyIndex(index);</span><br><span class="line">		mHeap.HeapifyFromEndToBeginning (i);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public void PrintOutAllMember()</span><br><span class="line">	&#123;</span><br><span class="line">		mHeap.PrintOutAllMember();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	private Heap&lt;T1, T2&gt; mHeap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Heap&lt;T1, T2&gt;</span><br><span class="line">&#123;</span><br><span class="line">	private List&lt;Pair&lt;T1, T2&gt;&gt; mList;</span><br><span class="line">	private IComparer&lt;T2&gt; mComparer;</span><br><span class="line">	private IComparer&lt;T1&gt; mCompareKey;</span><br><span class="line">	private int mCount;</span><br><span class="line">	</span><br><span class="line">	public Heap()</span><br><span class="line">	&#123;</span><br><span class="line">		mList = new List&lt;Pair&lt;T1, T2&gt;&gt;();</span><br><span class="line">		mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">		mCompareKey = Comparer&lt;T1&gt;.Default;</span><br><span class="line">		mCount = 0;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Heap(int size)</span><br><span class="line">	&#123;</span><br><span class="line">		mList = new List&lt;Pair&lt;T1, T2&gt;&gt;(size);</span><br><span class="line">		mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">		mCompareKey = Comparer&lt;T1&gt;.Default;</span><br><span class="line">		mCount = 0;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public Heap(List&lt;Pair&lt;T1, T2&gt;&gt; list)</span><br><span class="line">	&#123;</span><br><span class="line">		mList = list;</span><br><span class="line">		mCount = list.Count;</span><br><span class="line">		mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">		mCompareKey = Comparer&lt;T1&gt;.Default;</span><br><span class="line">		BuildingHeap();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    public void Clear()</span><br><span class="line">    &#123;</span><br><span class="line">        mList.Clear();</span><br><span class="line">        mCount = 0;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	public int Size()</span><br><span class="line">	&#123;</span><br><span class="line">		if (mList != null)</span><br><span class="line">		&#123;</span><br><span class="line">			return mCount;</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			return 0;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//O(Log(N))</span><br><span class="line">	public void RemoveTop()</span><br><span class="line">	&#123;</span><br><span class="line">		if (mList != null)</span><br><span class="line">		&#123;</span><br><span class="line">			mList[0] = mList[mCount - 1];</span><br><span class="line">			mList.RemoveAt(mCount-1);</span><br><span class="line">			mCount--;</span><br><span class="line">			HeapifyFromBeginningToEnd(0,mCount - 1);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public Pair&lt;T1, T2&gt; Top()</span><br><span class="line">	&#123;</span><br><span class="line">		if (mList != null)</span><br><span class="line">		&#123;</span><br><span class="line">			return mList[0];</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			//No more member</span><br><span class="line">			throw new InvalidOperationException("Empty heap.");</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public int FindSpecificKeyIndex(T1 key)</span><br><span class="line">	&#123;</span><br><span class="line">		return mList.FindIndex (x =&gt; mCompareKey.Compare (x.Key, key) == 0);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public void PrintOutAllMember()</span><br><span class="line">	&#123;</span><br><span class="line">        Pair&lt;T1, T2&gt; valuepair;</span><br><span class="line">		for (int i = 0; i &lt; mList.Count; i++)</span><br><span class="line">		&#123;</span><br><span class="line">            valuepair = mList[i];</span><br><span class="line">			Debug.Log(valuepair.ToString());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//O(Log(N))</span><br><span class="line">	public void Insert(Pair&lt;T1, T2&gt; valuepair)</span><br><span class="line">	&#123;</span><br><span class="line">		mList.Add(valuepair);</span><br><span class="line">		mCount++;</span><br><span class="line">		HeapifyFromEndToBeginning(mCount - 1);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//调整堆确保堆是最大堆，这里花O(log(n))，跟堆的深度有关</span><br><span class="line">	public void HeapifyFromBeginningToEnd(int parentindex, int length)</span><br><span class="line">	&#123;</span><br><span class="line">		int max_index = parentindex;</span><br><span class="line">		int left_child_index = parentindex * 2 + 1;</span><br><span class="line">		int right_child_index = parentindex * 2 + 2;</span><br><span class="line">		</span><br><span class="line">		//Chose biggest one between parent and left&amp;right child</span><br><span class="line">		if (left_child_index &lt; length &amp;&amp; mComparer.Compare(mList[left_child_index].Value, mList[max_index].Value) &lt; 0)</span><br><span class="line">		&#123;</span><br><span class="line">			max_index = left_child_index;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		if (right_child_index &lt; length &amp;&amp; mComparer.Compare(mList[right_child_index].Value, mList[max_index].Value) &lt; 0)</span><br><span class="line">		&#123;</span><br><span class="line">			max_index = right_child_index;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		//If any child is bigger than parent, </span><br><span class="line">		//then we swap it and do adjust for child again to make sure meet max heap definition</span><br><span class="line">		if (max_index != parentindex)</span><br><span class="line">		&#123;</span><br><span class="line">			Swap(max_index, parentindex);</span><br><span class="line">			HeapifyFromBeginningToEnd(max_index, length);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//O(log(N))</span><br><span class="line">	public void HeapifyFromEndToBeginning(int index)</span><br><span class="line">	&#123;</span><br><span class="line">		if(index &gt;= mCount)</span><br><span class="line">		&#123;</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line">		while (index &gt; 0)</span><br><span class="line">		&#123;</span><br><span class="line">			int parentindex = (index - 1) / 2;</span><br><span class="line">			if(mComparer.Compare(mList[parentindex].Value,mList[index].Value) &gt; 0)</span><br><span class="line">			&#123;</span><br><span class="line">				Swap(parentindex, index);</span><br><span class="line">				index = parentindex;</span><br><span class="line">			&#125;</span><br><span class="line">			else</span><br><span class="line">			&#123;</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//通过初试数据构建最大堆</span><br><span class="line">	////O(N*Log(N))</span><br><span class="line">	private void BuildingHeap()</span><br><span class="line">	&#123;</span><br><span class="line">		if (mList != null)</span><br><span class="line">		&#123;</span><br><span class="line">			for (int i = mList.Count / 2 - 1; i &gt;= 0; i--)</span><br><span class="line">			&#123;</span><br><span class="line">				//1.2 Adjust heap</span><br><span class="line">				//Make sure meet max heap definition</span><br><span class="line">				//Max Heap definition:</span><br><span class="line">				// (k(i) &gt;= k(2i) &amp;&amp; k(i) &gt;= k(2i+1))   (1 &lt;= i &lt;= n/2)</span><br><span class="line">				HeapifyFromBeginningToEnd(i, mList.Count);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	////O(N*log(N))</span><br><span class="line">	private void HeapSort()</span><br><span class="line">	&#123;</span><br><span class="line">		if (mList != null)</span><br><span class="line">		&#123;</span><br><span class="line">			//Steps:</span><br><span class="line">			// 1. Build heap</span><br><span class="line">			// 1.1 Init heap</span><br><span class="line">			// 1.2 Adjust heap</span><br><span class="line">			// 2. Sort heap</span><br><span class="line">			</span><br><span class="line">			//1. Build max heap</span><br><span class="line">			// 1.1 Init heap</span><br><span class="line">			//Assume we construct max heap</span><br><span class="line">			BuildingHeap();</span><br><span class="line">			//2. Sort heap</span><br><span class="line">			//这里花O(n)，跟数据数量有关</span><br><span class="line">			for (int i = mList.Count - 1; i &gt; 0; i--)</span><br><span class="line">			&#123;</span><br><span class="line">				//swap first element and last element</span><br><span class="line">				//do adjust heap process again to make sure the new array are still max heap</span><br><span class="line">				Swap(i, 0);</span><br><span class="line">				//Due to we already building max heap before,</span><br><span class="line">				//so  we just need to adjust for index 0 after we swap first and last element</span><br><span class="line">				HeapifyFromBeginningToEnd(0, i);</span><br><span class="line">			&#125;            </span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			Debug.Log("mList == null");</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	private void Swap(int id1, int id2)</span><br><span class="line">	&#123;</span><br><span class="line">		Pair&lt;T1, T2&gt; temp;</span><br><span class="line">		temp = mList[id1];</span><br><span class="line">		mList[id1] = mList[id2];</span><br><span class="line">		mList[id2] = temp;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Pair&lt;T1, T2&gt;</span><br><span class="line">&#123;</span><br><span class="line">	public Pair()</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public Pair(T1 k, T2 v)</span><br><span class="line">	&#123;</span><br><span class="line">		Key = k;</span><br><span class="line">		Value = v;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public override string ToString()</span><br><span class="line">	&#123;</span><br><span class="line">		return String.Format("[&#123;0&#125;,&#123;1&#125;]",Key,Value);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public T1 Key</span><br><span class="line">	&#123;</span><br><span class="line">		get;</span><br><span class="line">		set;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public T2 Value</span><br><span class="line">	&#123;</span><br><span class="line">		get;</span><br><span class="line">		set;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样一来我们所需要的优先队列就完成了。</p>
<h6 id="A_Star-1">A Star</h6><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Assertions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SearchAStar</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> PathInfo</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; PathToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mPathToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mPathToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> List&lt;<span class="keyword">int</span>&gt; mPathToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;Vector3&gt; MovementPathToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mMovementPathToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMovementPathToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> List&lt;Vector3&gt; mMovementPathToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> IsWallInPathToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mIsWallInPathToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mIsWallInPathToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> mIsWallInPathToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> WallInPathToTargetIndex</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mWallInPathToTargetIndex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mWallInPathToTargetIndex = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mWallInPathToTargetIndex;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> CostToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mCostToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mCostToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> mCostToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> ITarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mITarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mITarget;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mITarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> OriginalTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mOriginalTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mOriginalTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mOriginalTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> NodesSearched</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mNodesSearched;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mNodesSearched = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mNodesSearched;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> EdgesSearched</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mEdgesSearched;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mEdgesSearched = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mEdgesSearched;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//this list of edges is used to store any subtree returned from any of the graph algorithms</span></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">        public List&lt;GraphEdge&gt; SubTree</span><br><span class="line">        &#123;</span><br><span class="line">            get</span><br><span class="line">            &#123;</span><br><span class="line">                return mSubTree;</span><br><span class="line">            &#125;</span><br><span class="line">            set</span><br><span class="line">            &#123;</span><br><span class="line">                mSubTree = value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        private List&lt;GraphEdge&gt; mSubTree;</span><br><span class="line">        */</span></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">        public PathInfo()</span><br><span class="line">        &#123;</span><br><span class="line">            ResetPathInfo();</span><br><span class="line">        &#125;</span><br><span class="line">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PathInfo <span class="title">DeepCopy</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            PathInfo pi = (PathInfo)<span class="keyword">this</span>.MemberwiseClone();</span><br><span class="line">            pi.PathToTarget = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;(mPathToTarget);</span><br><span class="line">            pi.MovementPathToTarget = <span class="keyword">new</span> List&lt;Vector3&gt;(mMovementPathToTarget);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> pi;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ResetPathInfo</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            mIsWallInPathToTarget = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            mWallInPathToTargetIndex = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPathToTarget != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mPathToTarget.Clear();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mPathToTarget = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mMovementPathToTarget != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMovementPathToTarget.Clear();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMovementPathToTarget = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mNodesSearched = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            mEdgesSearched = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            mCostToTarget = <span class="number">0.0</span>f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SearchAStar</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SearchAStar</span>(<span class="params">SparseGraph&lt;NavGraphNode, GraphEdge&gt; graph</span><br><span class="line">                       , <span class="keyword">int</span> source</span><br><span class="line">                       , <span class="keyword">int</span> target</span><br><span class="line">                       , <span class="keyword">bool</span> isignorewall</span><br><span class="line">                       , <span class="keyword">float</span> strickdistance</span><br><span class="line">                       , <span class="keyword">float</span> hcostpercentage</span><br><span class="line">                       , <span class="keyword">bool</span> drawexplorepath</span><br><span class="line">                       , <span class="keyword">float</span> explorepathremaintime</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mGraph = graph;</span><br><span class="line">        mPQ = <span class="keyword">new</span> PriorityQueue&lt;<span class="keyword">int</span>, <span class="keyword">float</span>&gt;((<span class="keyword">int</span>)Mathf.Sqrt(mGraph.NumNodes()));</span><br><span class="line">        mGCosts = <span class="keyword">new</span> List&lt;<span class="keyword">float</span>&gt;(graph.NumNodes());</span><br><span class="line">        mFCosts = <span class="keyword">new</span> List&lt;Pair&lt;<span class="keyword">int</span>, <span class="keyword">float</span>&gt;&gt;(graph.NumNodes());</span><br><span class="line">        mShortestPathTree = <span class="keyword">new</span> List&lt;GraphEdge&gt;(graph.NumNodes());</span><br><span class="line">        mSearchFrontier = <span class="keyword">new</span> List&lt;GraphEdge&gt;(graph.NumNodes());</span><br><span class="line">        <span class="comment">//Init G cost and F cost and Cost value</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; graph.NumNodes(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            mGCosts.Add(<span class="number">0.0</span>f);</span><br><span class="line">            mFCosts.Add(<span class="keyword">new</span> Pair&lt;<span class="keyword">int</span>, <span class="keyword">float</span>&gt;(i, <span class="number">0.0</span>f));</span><br><span class="line">            mShortestPathTree.Add(<span class="keyword">new</span> GraphEdge());</span><br><span class="line">            mSearchFrontier.Add(<span class="keyword">new</span> GraphEdge());</span><br><span class="line">        &#125;</span><br><span class="line">        mISource = source;</span><br><span class="line">        mITarget = target;</span><br><span class="line">        mOriginalTarget = target;</span><br><span class="line"></span><br><span class="line">        Assert.IsTrue(hcostpercentage &gt;= <span class="number">0</span>);</span><br><span class="line">        mHCostPercentage = hcostpercentage;</span><br><span class="line"></span><br><span class="line">        mBDrawExplorePath = drawexplorepath;</span><br><span class="line"></span><br><span class="line">        mExplorePathRemainTime = explorepathremaintime;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo = <span class="keyword">new</span> PathInfo();</span><br><span class="line"></span><br><span class="line">        mIsIgnoreWall = isignorewall;</span><br><span class="line"></span><br><span class="line">        mStrickDistance = strickdistance;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Search(mStrickDistance, mIsIgnoreWall);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//GeneratePathToTargetInfo();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateSearch</span>(<span class="params"><span class="keyword">int</span> sourceindex, <span class="keyword">int</span> targetindex, <span class="keyword">float</span> strickdistance</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        Assert.IsTrue(mISource &gt;= <span class="number">0</span> &amp;&amp; mISource &lt; mGraph.NumNodes());</span><br><span class="line">        Assert.IsTrue(mITarget &gt;= <span class="number">0</span> &amp;&amp; mITarget &lt; mGraph.NumNodes());</span><br><span class="line"></span><br><span class="line">        AstarReset(sourceindex, targetindex, strickdistance);</span><br><span class="line"></span><br><span class="line">        Search(mStrickDistance, mIsIgnoreWall);</span><br><span class="line"></span><br><span class="line">        GeneratePathToTargetInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AstarReset</span>(<span class="params"><span class="keyword">int</span> sourceindex, <span class="keyword">int</span> targetindex, <span class="keyword">float</span> strickdistance</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mISource = sourceindex;</span><br><span class="line"></span><br><span class="line">        mITarget = targetindex;</span><br><span class="line"></span><br><span class="line">        mOriginalTarget = targetindex;</span><br><span class="line"></span><br><span class="line">        mStrickDistance = strickdistance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mGraph.NumNodes(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            mGCosts[i] = <span class="number">0.0</span>f;</span><br><span class="line">            mFCosts[i].Value = <span class="number">0.0</span>f;</span><br><span class="line">            mShortestPathTree[i].Reset();</span><br><span class="line">            mSearchFrontier[i].Reset();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.ResetPathInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> mIsIgnoreWall;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> StrickDistance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mStrickDistance = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mStrickDistance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PathInfo AStarPathInfo</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mAStarPathInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mAStarPathInfo = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> PathInfo mAStarPathInfo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GeneratePathToTargetInfo</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mAStarPathInfo.PathToTarget.Clear();</span><br><span class="line">        mAStarPathInfo.MovementPathToTarget.Clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mITarget &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> nd = mITarget;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.PathToTarget.Add(nd);</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.MovementPathToTarget.Add(mGraph.Nodes[nd].Position);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((nd != mISource) &amp;&amp; (mShortestPathTree[nd] != <span class="keyword">null</span>) &amp;&amp; mShortestPathTree[nd].IsValidEdge())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Debug.DrawLine(mGraph.Nodes[mShortestPathTree[nd].From].Position,mGraph.Nodes[nd].Position,Color.green, Mathf.Infinity);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mIsIgnoreWall)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//No matter the wall in path is jumpable or not, we should record it as useful information</span></span><br><span class="line">                <span class="keyword">if</span> (mGraph.Nodes[nd].IsWall <span class="comment">/*&amp;&amp; !mGraph.Nodes[nd].IsJumpable*/</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mAStarPathInfo.IsWallInPathToTarget = <span class="keyword">true</span>;</span><br><span class="line">                    mAStarPathInfo.WallInPathToTargetIndex = nd;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            nd = mShortestPathTree[nd].From;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.PathToTarget.Add(nd);</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.MovementPathToTarget.Add(mGraph.Nodes[nd].Position);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.CostToTarget = GetCostToTarget();</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.ITarget = mITarget;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.OriginalTarget = mOriginalTarget;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;GraphEdge&gt; <span class="title">GetSPT</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mShortestPathTree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">GetCostToTarget</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mGCosts[mITarget];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SparseGraph&lt;NavGraphNode, GraphEdge&gt; mGraph;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PriorityQueue&lt;<span class="keyword">int</span>, <span class="keyword">float</span>&gt; mPQ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="keyword">float</span>&gt; mGCosts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Pair&lt;<span class="keyword">int</span>, <span class="keyword">float</span>&gt;&gt; mFCosts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;GraphEdge&gt; SPT</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mShortestPathTree;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> List&lt;GraphEdge&gt; mShortestPathTree;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">	public List&lt;float&gt; CostToTargetNode </span><br><span class="line">	&#123;</span><br><span class="line">		get &#123;</span><br><span class="line">			return mCostToTargetNode;</span><br><span class="line">		&#125;</span><br><span class="line">		set</span><br><span class="line">		&#123;</span><br><span class="line">			mCostToTargetNode = value;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	private List&lt;float&gt; mCostToTargetNode;</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GraphEdge&gt; mSearchFrontier;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> ISource</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mISource = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mISource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> ITarget</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mITarget = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mITarget;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mITarget;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> OriginalTarget</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mOriginalTarget;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mOriginalTarget = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mOriginalTarget;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mHCostPercentage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> mBDrawExplorePath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mExplorePathRemainTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The A* search algorithm</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Search</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mPQ.Clear();</span><br><span class="line"></span><br><span class="line">        mPQ.Push(mFCosts[mISource]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//mSearchFrontier [mISource] = new GraphEdge (mISource, mISource, 0.0f);</span></span><br><span class="line">        mSearchFrontier[mISource].From = mISource;</span><br><span class="line">        mSearchFrontier[mISource].To = mISource;</span><br><span class="line">        mSearchFrontier[mISource].Cost = <span class="number">0.0</span>f;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get lowest cost node from the queue</span></span><br><span class="line">            <span class="keyword">int</span> nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.NodesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//move this node from the frontier to the spanning tree</span></span><br><span class="line">            <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="keyword">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">            &#123;</span><br><span class="line">                mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//If the target has been found exit</span></span><br><span class="line">            <span class="keyword">if</span> (nextclosestnode == mITarget)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Now to test all the edges attached to this node</span></span><br><span class="line">            List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">            GraphEdge edge;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                edge = edgelist[i];</span><br><span class="line">                <span class="comment">//calculate the heuristic cost from this node to the target (H)</span></span><br><span class="line">                <span class="keyword">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//calculate the 'real' cost to this node from the source (G)</span></span><br><span class="line">                <span class="keyword">float</span> gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if the node has not been added to the frontier, add it and update the G and F costs</span></span><br><span class="line">                <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="keyword">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if this node is already on the frontier but the cost to get here</span></span><br><span class="line">                <span class="comment">//is cheaper than has been found previously, update the node</span></span><br><span class="line">                <span class="comment">//cost and frontier accordingly</span></span><br><span class="line">                <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">gcost &lt; mGCosts[edge.To]</span>)</span><br><span class="line">                </span>&#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Due to some node's f cost has been changed</span></span><br><span class="line">                    <span class="comment">//we should reoder the priority queue to make sure we pop up the lowest fcost node first</span></span><br><span class="line">                    <span class="comment">//compare the fcost will make sure we search the path in the right direction</span></span><br><span class="line">                    <span class="comment">//h cost is the key to search in the right direction</span></span><br><span class="line">                    mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The A* search algorithm with strickdistance</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Search</span>(<span class="params"><span class="keyword">float</span> strickdistance</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">float</span> currentnodetotargetdistance = Mathf.Infinity;</span><br><span class="line"></span><br><span class="line">        mPQ.Clear();</span><br><span class="line"></span><br><span class="line">        mPQ.Push(mFCosts[mISource]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//mSearchFrontier [mISource] = new GraphEdge (mISource, mISource, 0.0f);</span></span><br><span class="line">        mSearchFrontier[mISource].From = mISource;</span><br><span class="line">        mSearchFrontier[mISource].To = mISource;</span><br><span class="line">        mSearchFrontier[mISource].Cost = <span class="number">0.0</span>f;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get lowest cost node from the queue</span></span><br><span class="line">            <span class="keyword">int</span> nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.NodesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//move this node from the frontier to the spanning tree</span></span><br><span class="line">            <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="keyword">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">            &#123;</span><br><span class="line">                mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            currentnodetotargetdistance = Heuristic_Euclid.Calculate(mGraph, mITarget, nextclosestnode);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextclosestnode == mITarget || currentnodetotargetdistance &lt;= strickdistance)</span><br><span class="line">            &#123;</span><br><span class="line">                mITarget = nextclosestnode;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Now to test all the edges attached to this node</span></span><br><span class="line">            List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">            GraphEdge edge;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                edge = edgelist[i];</span><br><span class="line">                <span class="comment">//calculate the heuristic cost from this node to the target (H)</span></span><br><span class="line">                <span class="keyword">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//calculate the 'real' cost to this node from the source (G)</span></span><br><span class="line">                <span class="keyword">float</span> gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if the node has not been added to the frontier, add it and update the G and F costs</span></span><br><span class="line">                <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="keyword">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if this node is already on the frontier but the cost to get here</span></span><br><span class="line">                <span class="comment">//is cheaper than has been found previously, update the node</span></span><br><span class="line">                <span class="comment">//cost and frontier accordingly</span></span><br><span class="line">                <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">gcost &lt; mGCosts[edge.To]</span>)</span><br><span class="line">                </span>&#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Due to some node's f cost has been changed</span></span><br><span class="line">                    <span class="comment">//we should reoder the priority queue to make sure we pop up the lowest fcost node first</span></span><br><span class="line">                    <span class="comment">//compare the fcost will make sure we search the path in the right direction</span></span><br><span class="line">                    <span class="comment">//h cost is the key to search in the right direction</span></span><br><span class="line">                    mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The A* search algorithm with strickdistance with wall consideration</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Search</span>(<span class="params"><span class="keyword">float</span> strickdistance, <span class="keyword">bool</span> isignorewall</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">float</span> currentnodetotargetdistance = Mathf.Infinity;</span><br><span class="line"></span><br><span class="line">        mPQ.Clear();</span><br><span class="line"></span><br><span class="line">        mPQ.Push(mFCosts[mISource]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//mSearchFrontier [mISource] = new GraphEdge (mISource, mISource, 0.0f);</span></span><br><span class="line">        mSearchFrontier[mISource].From = mISource;</span><br><span class="line">        mSearchFrontier[mISource].To = mISource;</span><br><span class="line">        mSearchFrontier[mISource].Cost = <span class="number">0.0</span>f;</span><br><span class="line">        GraphEdge edge = <span class="keyword">new</span> GraphEdge();</span><br><span class="line">        <span class="keyword">int</span> nextclosestnode = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get lowest cost node from the queue</span></span><br><span class="line">            nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.NodesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//move this node from the frontier to the spanning tree</span></span><br><span class="line">            <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="keyword">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">            &#123;</span><br><span class="line">                mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            currentnodetotargetdistance = Heuristic_Euclid.Calculate(mGraph, mITarget, nextclosestnode);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextclosestnode == mITarget || (currentnodetotargetdistance &lt;= strickdistance &amp;&amp; !mGraph.Nodes[nextclosestnode].IsWall))</span><br><span class="line">            &#123;</span><br><span class="line">                mITarget = nextclosestnode;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Now to test all the edges attached to this node</span></span><br><span class="line">            List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//Avoid pass refrence</span></span><br><span class="line">                edge.Reset();</span><br><span class="line">                edge.From = edgelist[i].From;</span><br><span class="line">                edge.To = edgelist[i].To;</span><br><span class="line">                edge.Cost = edgelist[i].Cost;</span><br><span class="line">                <span class="comment">//calculate the heuristic cost from this node to the target (H)</span></span><br><span class="line">                <span class="keyword">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//calculate the 'real' cost to this node from the source (G)</span></span><br><span class="line">                <span class="keyword">float</span> gcost = <span class="number">0.0</span>f;</span><br><span class="line">                <span class="keyword">if</span> (isignorewall)</span><br><span class="line">                &#123;</span><br><span class="line">                    gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.From].IsWall)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.From].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.To].IsWall)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.To].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.From].IsJumpable)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.From].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.To].IsJumpable)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.To].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if the node has not been added to the frontier, add it and update the G and F costs</span></span><br><span class="line">                <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="keyword">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To].ValueCopy(edge);</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if this node is already on the frontier but the cost to get here</span></span><br><span class="line">                <span class="comment">//is cheaper than has been found previously, update the node</span></span><br><span class="line">                <span class="comment">//cost and frontier accordingly</span></span><br><span class="line">                <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">gcost &lt; mGCosts[edge.To]</span>)</span><br><span class="line">                </span>&#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Due to some node's f cost has been changed</span></span><br><span class="line">                    <span class="comment">//we should reoder the priority queue to make sure we pop up the lowest fcost node first</span></span><br><span class="line">                    <span class="comment">//compare the fcost will make sure we search the path in the right direction</span></span><br><span class="line">                    <span class="comment">//h cost is the key to search in the right direction</span></span><br><span class="line">                    mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To].ValueCopy(edge);</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Heuristic_Euclid</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">Calculate</span>(<span class="params">SparseGraph&lt;NavGraphNode, GraphEdge&gt; g, <span class="keyword">int</span> nd1, <span class="keyword">int</span> nd2</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">//Manhattan distance heuritic</span></span><br><span class="line">        <span class="comment">//Vector2 v1 = Utility.ConvertIndexToRC (nd1);</span></span><br><span class="line">        <span class="comment">//Vector2 v2 = Utility.ConvertIndexToRC (nd2);</span></span><br><span class="line">        <span class="comment">//float dis = v1.x - v2.x + v1.y - v2.y;</span></span><br><span class="line">        <span class="comment">//Debug.Log("dis = " + dis);</span></span><br><span class="line">        <span class="comment">//return dis;</span></span><br><span class="line">        <span class="comment">//Caculation distance takes much time</span></span><br><span class="line">        <span class="keyword">return</span> Vector3.Distance(g.Nodes[nd1].Position, g.Nodes[nd2].Position);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出我写了三个Search的版本：<br>第一个没有参数是最初的A Star Search，用于普通的寻路。<br>第二个带有float strickdistance的参数，是由于后来为了实现兵种间不同攻击距离下的寻路，只要达到攻击范围就算寻路完成。<br>第三个参数带了float strickdistance和bool isignorewall两个参数，还记得之前在GraphNode里写到的由于游戏里有城墙的概念，所以我在NavGraphNode里加入的mIsWall和mIsJumpable变量，用于判断节点是否是城墙并且是否可以直接越过。而这里的第二个参数isignorewall主要是用于判断当前兵种是否支持跳跃城墙（比如COC里的野猪），如果可以忽略城墙，那么寻路的时候就不会加入城墙的考虑。<br>后续我都会一一展示。</p>
<p>注意： A算法和Dijkstra算法的唯一区别是对搜索边界上的点的开销的计算。被修正的到节点的开销F用来决定节点在优先队列中的位置。<br>F的计算：<br>F = G + H<br>G是到达一个节点的累计开销， H是一个启发因子，它给出的是节点到目标节点的估计距离。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br></pre></td></tr></table></figure></p>
<p>这里算的是两点之间的实际距离，通过设定一个mHCostPercentage来实现对启发因子数值的控制。</p>
<p>让我们看看mHCostPercentage不同值时的效果：<br>黄色为寻路过程中探测的路线，绿色是最终路线。<br>mHCostPercentage = 1，即以两点之间的实际距离为H值的寻路的效果：<br><img src="/img/Unity/mHCostPercentage1.PNG" alt="mHCostPercentage1"></p>
<p>mHCostPercentage = 1.5,即以两点之前的实际距离的1.5倍为H值得寻路效果：<br><img src="/img/Unity/mHCostPercentage1point5.PNG" alt="mHCostPercentage1point5"></p>
<p>从上图可以看出H的值会使得A Star的搜索方向尽可能的往正确的方向搜索，从而避免不必要的边搜索。<br>上图由于绘制了搜索路径，所以实际上的Search Time没有那么高，如果mHCostPercentage设置成1.5一般都在2ms以内。</p>
<p>让我们看看加入城墙以后的效果：<br>注意，这里城墙的权值是设的4，即经过城墙相当于多走4的距离<br>mHCostPercentage = 1<br><img src="/img/Unity/mHCostPercentage1withWall.PNG" alt="mHCostPercentage1withWall"></p>
<p>mHCostPercentage = 1.5<br><img src="/img/Unity/mHCostPercentage1point5withWall.PNG" alt="mHCostPercentage1point5withWall"></p>
<p>从上图可以看出通过探索，士兵选择了最近的路线是绕过城墙，同时mHCostPercentage越大使得搜索的边减少了。</p>
<p>接下来看看当建筑被城墙大量包围时的寻路效果：<br>mHCostPercentage = 1<br><img src="/img/Unity/mHCostPercentage1withMoreWall.PNG" alt="mHCostPercentage1withMoreWall"></p>
<p>mHCostPercentage = 1.5<br><img src="/img/Unity/mHCostPercentage1point5withMoreWall.PNG" alt="mHCostPercentage1point5withMoreWall"></p>
<p>通过上面可以看出，由于建筑被城墙幅度包围，士兵的最终路线选择是经过城墙。<br>让我们来看一张有城墙的和无城墙的权值图：<br>有城墙：<br><img src="/img/Unity/WithWallWeightValue.PNG" alt="WithWallWeightValue"></p>
<p>无城墙：<br><img src="/img/Unity/WithoutWallWeightValue.PNG" alt="WithoutWallWeightValue"></p>
<p>NavGraphNode里加入的mIsJumpable变量将用于对城墙是否可跳跃的状态进行了抽象（实现COC里的弹跳法术）。</p>
<p>最终这个游戏实现了如下功能：</p>
<ol>
<li>地图的存储</li>
<li>地图的编辑（建造和删除）</li>
<li>游戏进攻AI（包括对特有类型建筑有限攻击（好比COC里胖子优先攻击防御建筑））</li>
<li>存档清除</li>
<li>PC和Mobile控制</li>
<li>A Star调试信息面板</li>
<li>调整兵种信息调整（对优先攻击进行设定，行进速度设定，攻击距离设定，攻击伤害，血量是否可跳墙等属性设定等）</li>
<li>对建筑物信息调整（所占格子2<em>2 or 3</em>3等设定（暂时只支持1<em>1,2</em>2,3*3），攻击距离，攻击伤害，血量等信息）</li>
<li>法术信息调整（法术范围，法术持续时间等信息）</li>
</ol>
<p>兵种支持：</p>
<ol>
<li>近战型优先攻击防御建筑 — 好比COC的胖子</li>
<li>远程，无特定攻击对象 — 好比COC的弓箭手</li>
</ol>
<p>建筑支持：</p>
<ol>
<li>攻击建筑 — 好比COC里的箭塔</li>
<li>不可攻击建筑 — 好比COC里的兵营</li>
<li>城墙 — 好比COC里的城墙</li>
</ol>
<p>法术支持：<br>弹跳法术</p>
<p>所有功能都会在最后的视频一一展示。</p>
<h3 id="Optimization">Optimization</h3><ol>
<li><p>Rendering<br>最初是绘制了40*40，1600个带Sprite图案的Tile，后来改为用一张整的Ground和只带Collider的1600个Tile。</p>
</li>
<li><p>GC<br>A Star最初写的时候是每一次运算都申请新的内存(每一次都New上百k的内存)，后来改为通用数据保留下来，每次只重新申请需要返回的A Star Path的数据(大概几K)</p>
</li>
<li><p>Physics<br>最初是打开了所有Layer之间的碰撞检测，后来改为只打开需要碰撞检测的Layer之间的碰撞检测(Edit -&gt; Project Settings -&gt; Physics)</p>
</li>
<li><p>Memory<br>避免不必要的内存开销(比如box会在堆上申请额外的内存)<br>项目里用Dictionary而不要用Hashtable，因为Dictionary是基于模板的，在针对ValueType的时候不会触发box和unbox。<br>Unity里foreach会触发box，所以在Unity里尽量避免使用foreach，用while or for代替。</p>
</li>
</ol>
<h2 id="Sumary">Sumary</h2><p>在这次尝试制作和学习的过程中，学习了解了Unity和C#的一些基本概念。<br>巩固学习了AI寻路方面的知识。<br>对于炸弹人的AI，虽然云风大哥说大概是“寻找附近封闭空间中最近目标”，对于如何实现这一点没有头绪。(未来AI学习书籍 — 《Artificial Intelligence for Game》 — Ian Millington)<br>通过这一次的实践学习，我明白了，好的数据结构设计才是性能的关键所在。我的实现依赖于A Star的实时运算，即使每次运算时1ms级别，但数量一旦达到成百上千，A Star是无法保证帧率的。尽量做到预算和O(1)时间的查找或者运用更好的数据结构解决问题才是提升性能的关键。<br>最后再贴一个没有解决的真机bug（相对严重的，PC上没有），暂时未能解决的。<br><a href="http://answers.unity3d.com/questions/1158635/transformlookat-got-different-behaviour-on-pc-and.html" target="_blank" rel="external">Unity 的提问</a></p>
<h2 id="Final_Effect">Final Effect</h2><p><a href="http://blog.sina.com.cn/s/blog_8c7d49f20102xfck.html" target="_blank" rel="external">视频</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Game-Engine/">Game_Engine</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://tonytang1990.github.io/2016/03/13/Unity仿COC/" data-title="Unity仿COC | 走停人生路" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/07/25/Shader-Toy/" title="Shader Toy">
  <strong>上一篇：</strong><br/>
  <span>
  Shader Toy</span>
</a>
</div>


<div class="next">
<a href="/2015/10/14/Artificial-Inteligence-Study/"  title="Artificial-Inteligence-Study">
 <strong>下一篇：</strong><br/> 
 <span>Artificial-Inteligence-Study
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2016/03/13/Unity仿COC/" data-title="Unity仿COC" data-url="http://tonytang1990.github.io/2016/03/13/Unity仿COC/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目錄</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Preface(序言)"><span class="toc-number">1.</span> <span class="toc-text">Preface(序言)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What_is_COC?"><span class="toc-number">1.1.</span> <span class="toc-text">What is COC?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#My_COC_Experience"><span class="toc-number">1.2.</span> <span class="toc-text">My COC Experience</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#COC_Project(Unity)"><span class="toc-number">2.</span> <span class="toc-text">COC Project(Unity)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Preparation"><span class="toc-number">2.1.</span> <span class="toc-text">Preparation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity"><span class="toc-number">2.1.1.</span> <span class="toc-text">Unity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Programming_Language(C#)"><span class="toc-number">2.1.2.</span> <span class="toc-text">Programming Language(C#)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AI"><span class="toc-number">2.1.3.</span> <span class="toc-text">AI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Knowledge"><span class="toc-number">2.1.4.</span> <span class="toc-text">Knowledge</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Is_COC_a_2D_game_or_3D_game?"><span class="toc-number">2.1.4.1.</span> <span class="toc-text">Is COC a 2D game or 3D game?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Isometric_Tileset_Engine"><span class="toc-number">2.1.4.2.</span> <span class="toc-text">Isometric Tileset Engine</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#What_is_Isometric_Tileset_Engine?"><span class="toc-number">2.1.4.2.1.</span> <span class="toc-text">What is Isometric Tileset Engine?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#What_does_game_with_isometric_projection_look_like?"><span class="toc-number">2.1.4.2.2.</span> <span class="toc-text">What does game with isometric projection look like?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#How_to_make_game_work_under_isometric_projection?"><span class="toc-number">2.1.4.2.3.</span> <span class="toc-text">How to make game work under isometric projection?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Searching"><span class="toc-number">2.1.5.</span> <span class="toc-text">Searching</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#How_to_develope_COC_like_game?"><span class="toc-number">2.1.5.1.</span> <span class="toc-text">How to develope COC like game?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Project"><span class="toc-number">2.2.</span> <span class="toc-text">Project</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Game_Engine"><span class="toc-number">2.2.1.</span> <span class="toc-text">Game Engine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Programming_Language"><span class="toc-number">2.2.2.</span> <span class="toc-text">Programming Language</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Developer_Tool"><span class="toc-number">2.2.3.</span> <span class="toc-text">Developer Tool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Basic_Setting_with_Scene"><span class="toc-number">2.2.4.</span> <span class="toc-text">Basic Setting with Scene</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Camera_Control_&_Input"><span class="toc-number">2.2.5.</span> <span class="toc-text">Camera Control & Input</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PC"><span class="toc-number">2.2.5.1.</span> <span class="toc-text">PC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mobile"><span class="toc-number">2.2.5.2.</span> <span class="toc-text">Mobile</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UI"><span class="toc-number">2.2.6.</span> <span class="toc-text">UI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Map"><span class="toc-number">2.2.7.</span> <span class="toc-text">Map</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Map_Type"><span class="toc-number">2.2.7.1.</span> <span class="toc-text">Map Type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Map_Save"><span class="toc-number">2.2.7.2.</span> <span class="toc-text">Map Save</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Event_Manager"><span class="toc-number">2.2.8.</span> <span class="toc-text">Event Manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Object_Pool"><span class="toc-number">2.2.9.</span> <span class="toc-text">Object Pool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Utilities"><span class="toc-number">2.2.10.</span> <span class="toc-text">Utilities</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AI-1"><span class="toc-number">2.2.11.</span> <span class="toc-text">AI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#A_Star"><span class="toc-number">2.2.11.1.</span> <span class="toc-text">A Star</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Searching-1"><span class="toc-number">2.2.11.1.1.</span> <span class="toc-text">Searching</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Create_Myself_A_Star"><span class="toc-number">2.2.11.1.2.</span> <span class="toc-text">Create Myself A Star</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#A_Star_Preperation"><span class="toc-number">2.2.11.1.2.1.</span> <span class="toc-text">A Star Preperation</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#PriorityQueue"><span class="toc-number">2.2.11.1.2.2.</span> <span class="toc-text">PriorityQueue</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#A_Star-1"><span class="toc-number">2.2.11.1.2.3.</span> <span class="toc-text">A Star</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Optimization"><span class="toc-number">2.2.12.</span> <span class="toc-text">Optimization</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sumary"><span class="toc-number">2.3.</span> <span class="toc-text">Sumary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Final_Effect"><span class="toc-number">2.4.</span> <span class="toc-text">Final Effect</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game-Engine/" title="Game_Engine">Game_Engine<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>3</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Sort/" title="Sort">Sort<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Skill/" title="Skill">Skill<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/GameDesignPattern/" title="GameDesignPattern">GameDesignPattern<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Network/" title="Network">Network<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/VersionControl/" title="VersionControl">VersionControl<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情鏈接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 訂閱</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Tony Tang. <br/>
			This is my new blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2021 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"TonyTang1990"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回頂部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
