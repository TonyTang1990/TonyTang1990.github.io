
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Unity Study | 走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta name="description" content="Unity Introduction因为后期发现目录越来越长导致前面的一些代码模块不具可读性，所以在这里加很多…过度符……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity Study">
<meta property="og:url" content="http://tonytang1990.github.io/2015/07/15/Unity-Study/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:description" content="Unity Introduction因为后期发现目录越来越长导致前面的一些代码模块不具可读性，所以在这里加很多…过度符……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Roll_A_Ball_Game_Play.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Roll_A_Ball_Game_Win.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Space_Shooter_Game_Play.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Space_Shooter_Game_Win.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Survival_Shooter_Game.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/2DRogueLike_Game_Start.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/2DRogueLike_Game_Play.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/2DRogueLike_Game_Lose.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/NetworkManagerAndHUD.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/NetworkManagerHUD.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/NetworkIdentity.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RegisterPlayerPrefab.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/StartHost.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/TestOnlineMove.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/MultiplayerNetworkingMovement.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ChangeLocalPlayerColor.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/PlayerWithFunAndBullet.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/MultiplayerNetworkingWithBullet.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/SpawnableBullet.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/MultiplayerNetworkingWithBulletSyn.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RemoteActions.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/PlayerSpawning.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/PlayerWithHealthBarHierachycal.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/PlayerGameObjectWithHealthBar.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/HealthScriptInEditor.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/MultiplayerNetworkingWithHealthBar.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/SyncHealthBarOnlyOnServer.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/SyncHealthBarAndValue.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RespawnPlayer.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ServerOnly.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/EnemyPrefab.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/EnemySpawnableList.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/EnemySpawner.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/MultiplayerNetworkingWithEnemy.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/DestroyEnemyWhenEnemyDead.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Mono.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/IL2CPP.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/CSharp/ValueTypeComparerForDictionary.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/CSharp/EmitStudy.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ProtocolBufferMessageValueType.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ProtobufSerializerSerialize.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ProtobufSerializerWrite.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ConstantPixelSizeScaleFactor.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ConstantPixelSizeScaleFactor2.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ScaleWithScreenSize.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ConstantPhysicalSize.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RectTransform.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ThickBorder.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/EventSystem.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/SystemInfo.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ButtonUINavigation.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/GraphicRaycast.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UGUISpriteEditor.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/SpritePackerSetting.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UGUISpritePacker.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ProfilerDrawCall.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/HLAPIHostAndClientRelationShip.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/HLAPILayerStructureOnNetwork.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ExcelReaderDLL.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/AccountPasswordAndGameSettingSheet1.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/AccountPasswordAndGameSettingSheet2.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ExcelReaderOutput.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Perssistence_PlayerPrefs_Serialization.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/EditorWindow_ScriptableObject.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Unity_Coroutine_LifeTime.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Unity_Coroutine_LifeTime_Monobehaviour.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Coroutine_Study.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ForEachCall.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ForCall.PNG">
<meta property="og:updated_time" content="2016-12-19T17:19:38.309Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity Study">
<meta name="twitter:description" content="Unity Introduction因为后期发现目录越来越长导致前面的一些代码模块不具可读性，所以在这里加很多…过度符……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………………………………..……………………">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.jpg" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">有时候不是习惯了一个人，而是在没有认可自己之前选择了一个人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/15/Unity-Study/" title="Unity Study" itemprop="url">Unity Study</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2015-07-15T15:48:26.000Z" itemprop="datePublished"> 發表於 2015-07-15</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目錄</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Unity_Introduction"><span class="toc-number">1.</span> <span class="toc-text">Unity Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What_is_Unity?"><span class="toc-number">1.1.</span> <span class="toc-text">What is Unity?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why_should_we_study_Unity?"><span class="toc-number">1.2.</span> <span class="toc-text">Why should we study Unity?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Which_programming_language_are_we_using?"><span class="toc-number">1.3.</span> <span class="toc-text">Which programming language are we using?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Unity_Tutorial_Study"><span class="toc-number">2.</span> <span class="toc-text">Unity Tutorial Study</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ROLL-A-BALL"><span class="toc-number">2.1.</span> <span class="toc-text">ROLL-A-BALL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SPACE_SHOOTER"><span class="toc-number">2.2.</span> <span class="toc-text">SPACE SHOOTER</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2D-ROGUELIKE-TUTORIAL"><span class="toc-number">2.3.</span> <span class="toc-text">2D-ROGUELIKE-TUTORIAL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multiplayer_Networking"><span class="toc-number">2.4.</span> <span class="toc-text">Multiplayer Networking</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#编辑器界面"><span class="toc-number">3.</span> <span class="toc-text">编辑器界面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#工具"><span class="toc-number">4.</span> <span class="toc-text">工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MonoDevelop"><span class="toc-number">4.1.</span> <span class="toc-text">MonoDevelop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ILSpy"><span class="toc-number">4.2.</span> <span class="toc-text">ILSpy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ildasm(安装VS自带的工具)"><span class="toc-number">4.3.</span> <span class="toc-text">ildasm(安装VS自带的工具)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Blender"><span class="toc-number">4.4.</span> <span class="toc-text">Blender</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VSTU"><span class="toc-number">4.5.</span> <span class="toc-text">VSTU</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#相关概念学习"><span class="toc-number">5.</span> <span class="toc-text">相关概念学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Unity_Engine"><span class="toc-number">5.1.</span> <span class="toc-text">Unity Engine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#C_Sharp"><span class="toc-number">5.1.1.</span> <span class="toc-text">C Sharp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mono"><span class="toc-number">5.1.2.</span> <span class="toc-text">Mono</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IL2CPP"><span class="toc-number">5.1.3.</span> <span class="toc-text">IL2CPP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Why_do_we_need_IL2CPP?"><span class="toc-number">5.1.3.1.</span> <span class="toc-text">Why do we need IL2CPP?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IL2CPP_Components"><span class="toc-number">5.1.3.2.</span> <span class="toc-text">IL2CPP Components</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mono_and_IL2CPP_compile_and_execution_process"><span class="toc-number">5.1.3.3.</span> <span class="toc-text">Mono and IL2CPP compile and execution process</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOT_&_JIT"><span class="toc-number">5.1.4.</span> <span class="toc-text">AOT & JIT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AOT"><span class="toc-number">5.1.4.1.</span> <span class="toc-text">AOT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JIT"><span class="toc-number">5.1.4.2.</span> <span class="toc-text">JIT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IOS_AOT_Limitations"><span class="toc-number">5.1.4.3.</span> <span class="toc-text">IOS AOT Limitations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Protocol_Buffers"><span class="toc-number">5.1.4.4.</span> <span class="toc-text">Protocol Buffers</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unity_Using"><span class="toc-number">5.2.</span> <span class="toc-text">Unity Using</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#快捷键学习"><span class="toc-number">6.</span> <span class="toc-text">快捷键学习</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#项目编译发布"><span class="toc-number">7.</span> <span class="toc-text">项目编译发布</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PC"><span class="toc-number">7.1.</span> <span class="toc-text">PC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IOS"><span class="toc-number">7.2.</span> <span class="toc-text">IOS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Native_Code_Compilation"><span class="toc-number">7.2.1.</span> <span class="toc-text">Native Code Compilation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prepare_XCode_Project"><span class="toc-number">7.2.2.</span> <span class="toc-text">Prepare XCode Project</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compile_XCode_Project"><span class="toc-number">7.2.3.</span> <span class="toc-text">Compile XCode Project</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#版块学习"><span class="toc-number">8.</span> <span class="toc-text">版块学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#UGUI"><span class="toc-number">8.1.</span> <span class="toc-text">UGUI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Coordinates_System"><span class="toc-number">8.1.1.</span> <span class="toc-text">Coordinates System</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity_Unit_&_Pixel_Per_Unit"><span class="toc-number">8.1.2.</span> <span class="toc-text">Unity Unit & Pixel Per Unit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Canvas"><span class="toc-number">8.1.3.</span> <span class="toc-text">Canvas</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventSystem"><span class="toc-number">8.1.4.</span> <span class="toc-text">EventSystem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UGUI_Atlas"><span class="toc-number">8.1.5.</span> <span class="toc-text">UGUI Atlas</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multiplayer_Networking-1"><span class="toc-number">8.2.</span> <span class="toc-text">Multiplayer Networking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The_Hight_Level_API"><span class="toc-number">8.2.1.</span> <span class="toc-text">The Hight Level API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using_The_Transport_Layer_API"><span class="toc-number">8.2.2.</span> <span class="toc-text">Using The Transport Layer API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unity_Shader"><span class="toc-number">8.3.</span> <span class="toc-text">Unity Shader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Excel数据读取"><span class="toc-number">8.4.</span> <span class="toc-text">Excel数据读取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#资源管理"><span class="toc-number">8.5.</span> <span class="toc-text">资源管理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Plugins"><span class="toc-number">9.</span> <span class="toc-text">Plugins</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C#脚本"><span class="toc-number">10.</span> <span class="toc-text">C#脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence_-_Saving_and_Loading_Data"><span class="toc-number">10.1.</span> <span class="toc-text">Persistence - Saving and Loading Data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PlayerPrefs"><span class="toc-number">10.1.1.</span> <span class="toc-text">PlayerPrefs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Seralization"><span class="toc-number">10.1.2.</span> <span class="toc-text">Seralization</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#What_is_seralization?"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">What is seralization?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C#_Serialization"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">C# Serialization</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity_Editor_Window,_Menu_Item_&_ScriptableObject"><span class="toc-number">10.1.3.</span> <span class="toc-text">Unity Editor Window, Menu Item & ScriptableObject</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Coroutine"><span class="toc-number">10.2.</span> <span class="toc-text">Coroutine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Why_are_we_using_coroutines?"><span class="toc-number">10.2.1.</span> <span class="toc-text">Why are we using coroutines?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#What_is_a_coroutine?"><span class="toc-number">10.2.2.</span> <span class="toc-text">What is a coroutine?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How_long_is_the_life_cycle?_&_When_does_coroutine_get_called?"><span class="toc-number">10.2.3.</span> <span class="toc-text">How long is the life cycle? & When does coroutine get called?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How_to_stop_coroutines?"><span class="toc-number">10.2.4.</span> <span class="toc-text">How to stop coroutines?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Go_depth_in_Coroutine"><span class="toc-number">10.2.5.</span> <span class="toc-text">Go depth in Coroutine</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Unity优化注意事项"><span class="toc-number">11.</span> <span class="toc-text">Unity优化注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Code"><span class="toc-number">11.1.</span> <span class="toc-text">Code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Use_For_or_while_instead_of_foreach"><span class="toc-number">11.1.1.</span> <span class="toc-text">Use For or while instead of foreach</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rendering"><span class="toc-number">11.2.</span> <span class="toc-text">Rendering</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Physic"><span class="toc-number">11.3.</span> <span class="toc-text">Physic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Close_Unnecessary_Collision"><span class="toc-number">11.3.1.</span> <span class="toc-text">Close Unnecessary Collision</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memory"><span class="toc-number">11.4.</span> <span class="toc-text">Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Avoid_Uneccessary_GC"><span class="toc-number">11.4.1.</span> <span class="toc-text">Avoid Uneccessary GC</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#游戏相关"><span class="toc-number">12.</span> <span class="toc-text">游戏相关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Shuffle_Bag"><span class="toc-number">12.1.</span> <span class="toc-text">Shuffle Bag</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C#学习"><span class="toc-number">13.</span> <span class="toc-text">C#学习</span></a></li></ol>
		
		</div>
		
		<h1 id="Unity_Introduction">Unity Introduction</h1><p>因为后期发现目录越来越长导致前面的一些代码模块不具可读性，所以在这里加很多…过度符<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..</p>
<h2 id="What_is_Unity?">What is Unity?</h2><p>Unity is a cross-platform game engine developed by Unity Technologies and used to develop video games for PC, consoles, mobile devices and websites. First released on June 8, 2005<br>(<a href="https://en.wikipedia.org/wiki/Unity_(game_engine" target="_blank" rel="external">from wiki</a>))</p>
<h2 id="Why_should_we_study_Unity?">Why should we study Unity?</h2><ol>
<li>Cross-platform</li>
<li>Free</li>
<li>Complete SDK documentation</li>
<li>Many free assets</li>
</ol>
<h2 id="Which_programming_language_are_we_using?">Which programming language are we using?</h2><ol>
<li>C# (推荐入门书籍《C#入门经典》，进阶书籍《CLR via C#》)</li>
<li>Javascript</li>
<li>Boo</li>
</ol>
<h1 id="Unity_Tutorial_Study">Unity Tutorial Study</h1><p>Website: <a href="https://unity3d.com/learn/tutorials" target="_blank" rel="external">Unity Tutorials</a></p>
<h2 id="ROLL-A-BALL">ROLL-A-BALL</h2><p><strong>Game Introduction</strong><br>控制小球移动收集场景里的方块，UI会显示当前收集的方块数量，当所有方块通过碰撞收集后游戏UI提示You Win</p>
<p><strong>Code</strong><br>PlayerController.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_Speed;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Text m_CountText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Text m_WinText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Rigidbody m_RB;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> m_Count;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		m_RB = GetComponent&lt;Rigidbody&gt; ();</span><br><span class="line">		m_Count = <span class="number">0</span>;</span><br><span class="line">		SetCountText();</span><br><span class="line">		m_WinText.text = <span class="string">""</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">float</span> moveHorizontal = Input.GetAxis (<span class="string">"Horizontal"</span>);</span><br><span class="line">		<span class="keyword">float</span> moveVertical = Input.GetAxis (<span class="string">"Vertical"</span>);</span><br><span class="line"></span><br><span class="line">		Vector3 movement = <span class="keyword">new</span> Vector3(moveHorizontal, <span class="number">0.0</span>f, moveVertical);</span><br><span class="line">		m_RB.AddForce (movement * m_Speed);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnTriggerEnter</span>(<span class="params">Collider other</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (other.gameObject.CompareTag (<span class="string">"Pickup"</span>)) </span><br><span class="line">		&#123;</span><br><span class="line">			other.gameObject.SetActive(<span class="keyword">false</span>);</span><br><span class="line">			m_Count++;</span><br><span class="line">			SetCountText();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">SetCountText</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		m_CountText.text = <span class="string">"Count: "</span> + m_Count.ToString();</span><br><span class="line">		<span class="keyword">if</span> (m_Count &gt;= <span class="number">12</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			m_WinText.text = <span class="string">"You Win!"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>CameraController.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CameraController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> GameObject m_Player;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Vector3 m_Offset;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		m_Offset = transform.position - m_Player.transform.position;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		transform.position = m_Player.transform.position + m_Offset;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Rotator.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Rotator</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		transform.Rotate (<span class="keyword">new</span> Vector3 (<span class="number">15</span>, <span class="number">35</span>, <span class="number">45</span>) * Time.deltaTime);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Captures</strong><br><em>Game Play</em><br><img src="/img/Unity/Roll_A_Ball_Game_Play.PNG" alt="Roll_A_Ball_Game_Play"><br><em>Win Game</em><br><img src="/img/Unity/Roll_A_Ball_Game_Win.PNG" alt="Roll_A_Ball_Game_Win"></p>
<h2 id="SPACE_SHOOTER">SPACE SHOOTER</h2><p><strong>Game Introduction</strong><br>Top Down Game<br>好比全民打飞机</p>
<p><strong>Code</strong><br>ShipController.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line">[System.Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Boundary</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_MinX,m_MaxX,m_MinZ,m_MaxZ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShipController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_Speed = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_Tilt = <span class="number">4</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> fireRate = <span class="number">0.5</span>F;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> nextFire = <span class="number">0.0</span>F;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Boundary m_Boundary;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject m_Shot;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Transform m_ShotSpawn;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> AudioSource m_FireAudio;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Rigidbody m_ShipRB;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> GameController m_GameController;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		m_ShipRB = GetComponent&lt;Rigidbody&gt; ();</span><br><span class="line">		m_FireAudio = GetComponent&lt;AudioSource&gt; ();</span><br><span class="line">		GameObject gamecontrollerobject = GameObject.FindGameObjectWithTag (<span class="string">"GameController"</span>);</span><br><span class="line">		<span class="keyword">if</span> (gamecontrollerobject != <span class="keyword">null</span>) &#123;</span><br><span class="line">			m_GameController = gamecontrollerobject.GetComponent&lt;GameController&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (m_GameController == <span class="keyword">null</span>) &#123;</span><br><span class="line">			Debug.Log(<span class="string">"m_GameController == null in ShipController::Start()"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (Input.GetKey(KeyCode.J) &amp;&amp; Time.time &gt; nextFire) &#123;</span><br><span class="line">			nextFire = Time.time + fireRate;</span><br><span class="line">			GameObject clone = Instantiate (m_Shot, m_ShotSpawn.position, m_ShotSpawn.rotation) <span class="keyword">as</span> GameObject;</span><br><span class="line">			m_FireAudio.Play();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!m_GameController.IsGameEnd ()) &#123;</span><br><span class="line">			<span class="keyword">float</span> moveHorizontal = Input.GetAxis (<span class="string">"Horizontal"</span>);</span><br><span class="line">			<span class="keyword">float</span> moveVertical = Input.GetAxis (<span class="string">"Vertical"</span>);</span><br><span class="line">			Vector3 movement = <span class="keyword">new</span> Vector3 (moveHorizontal, <span class="number">0.0</span>f, moveVertical);</span><br><span class="line">			m_ShipRB.velocity = movement * m_Speed;</span><br><span class="line"></span><br><span class="line">			m_ShipRB.position = <span class="keyword">new</span> Vector3 (</span><br><span class="line">				Mathf.Clamp (m_ShipRB.position.x, m_Boundary.m_MinX, m_Boundary.m_MaxX),</span><br><span class="line">				<span class="number">0.0</span>f,</span><br><span class="line">				Mathf.Clamp (m_ShipRB.position.z, m_Boundary.m_MinZ, m_Boundary.m_MaxZ)</span><br><span class="line">			);</span><br><span class="line">			m_ShipRB.rotation = Quaternion.Euler (<span class="number">0.0</span>f, <span class="number">0.0</span>f, -m_ShipRB.velocity.x * m_Tilt);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			m_ShipRB.rotation = Quaternion.Euler(<span class="number">0.0</span>f,<span class="number">0.0</span>f,<span class="number">0.0</span>f);</span><br><span class="line">			m_ShipRB.velocity = <span class="keyword">new</span> Vector3(<span class="number">0.0</span>f,<span class="number">0.0</span>f,<span class="number">0.0</span>f);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GameController.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject m_Hazard;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Vector3 m_SpawnValue = <span class="keyword">new</span> Vector3(<span class="number">5.5</span>f,<span class="number">0.0</span>f,<span class="number">8.0</span>f);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> m_HazardCount = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_SpawnWait = <span class="number">1.0</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_StartWait = <span class="number">3.0</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_WaveWait = <span class="number">4.0</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Text m_ScoreText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Text m_WinText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Button m_RestartButton;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> m_WinningScore = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> m_Score = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> m_IsGameEnd = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> m_RestartGame = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> AudioSource m_BackgroundAudio;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		StartCoroutine (SpawnAsteriod());</span><br><span class="line">		UpdateScore ();</span><br><span class="line">		m_WinText.text = <span class="string">""</span>;</span><br><span class="line">		m_RestartButton.gameObject.SetActive (<span class="keyword">false</span>);</span><br><span class="line">		m_RestartButton.onClick.AddListener (RestartGame);</span><br><span class="line">		m_BackgroundAudio = GetComponent&lt;AudioSource&gt; ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_RestartGame) &#123;</span><br><span class="line">			Debug.Log(<span class="string">"Restart Game Now"</span>);</span><br><span class="line">			Application.LoadLevel(Application.loadedLevel);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsGameEnd</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> m_IsGameEnd;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RestartGame</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		Debug.Log(<span class="string">"Restart Button clicked"</span>);</span><br><span class="line">		m_RestartGame = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">IEnumerator <span class="title">SpawnAsteriod</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span> (<span class="params">m_StartWait</span>)</span>;</span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_HazardCount; i++) &#123;</span><br><span class="line">				Vector3 spawnposition =  <span class="keyword">new</span> Vector3 (Random.Range (-m_SpawnValue.x, m_SpawnValue.x), <span class="number">0.0</span>f, m_SpawnValue.z);</span><br><span class="line">				Quaternion spawnrotation = Quaternion.identity;</span><br><span class="line">				Instantiate(m_Hazard,spawnposition,spawnrotation);</span><br><span class="line">				<span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span> (<span class="params">m_SpawnWait</span>)</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span> (<span class="params">m_WaveWait</span>)</span>;</span><br><span class="line">			<span class="keyword">if</span>(m_IsGameEnd)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddScore</span>(<span class="params"><span class="keyword">int</span> score</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		m_Score += score;</span><br><span class="line">		UpdateScore ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateScore</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		m_ScoreText.text = <span class="string">"Score: "</span> + m_Score;</span><br><span class="line">		<span class="keyword">if</span> (m_Score &gt;= m_WinningScore) &#123;</span><br><span class="line">			m_WinText.text = <span class="string">"Congratulation! You Win"</span>;</span><br><span class="line">			m_IsGameEnd = <span class="keyword">true</span>;</span><br><span class="line">			m_RestartButton.gameObject.SetActive (<span class="keyword">true</span>);</span><br><span class="line">			m_BackgroundAudio.Stop();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DestroyByContact.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DestroyByContact</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject m_ExplosionObject;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject m_PlayerExplosionObject;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> GameController m_GameController;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> m_ScoreValue = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		GameObject gamecontrollerobject = GameObject.FindGameObjectWithTag (<span class="string">"GameController"</span>);</span><br><span class="line">		<span class="keyword">if</span> (gamecontrollerobject != <span class="keyword">null</span>) &#123;</span><br><span class="line">			m_GameController = gamecontrollerobject.GetComponent&lt;GameController&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (m_GameController == <span class="keyword">null</span>) &#123;</span><br><span class="line">			Debug.Log(<span class="string">"m_GameController == null"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnTriggerEnter</span>(<span class="params">Collider other</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (other.tag == <span class="string">"Boundary"</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">		Debug.Log (<span class="string">"other.tag = "</span> + other.tag);</span><br><span class="line"></span><br><span class="line">		Instantiate (m_ExplosionObject, transform.position, transform.rotation);</span><br><span class="line">		<span class="keyword">if</span> (other.tag == <span class="string">"Player"</span>) &#123;</span><br><span class="line">			Instantiate (m_PlayerExplosionObject, other.transform.position, other.transform.rotation);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (other.tag == <span class="string">"Bullet"</span>) &#123;</span><br><span class="line">			Debug.Log(<span class="string">"Asteriod is destroied by Bullet"</span>);</span><br><span class="line">			m_GameController.AddScore(m_ScoreValue);</span><br><span class="line">		&#125;</span><br><span class="line">		Destroy(other.gameObject);</span><br><span class="line">		Destroy (gameObject);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DestroyByTime.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DestroyByTime</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_LifeTime = <span class="number">5.0</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		Destroy (gameObject,m_LifeTime);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GameBoundary.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameBoundary</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnTriggerExit</span>(<span class="params">Collider other</span>) </span>&#123;</span><br><span class="line">		Destroy(other.gameObject);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Mover.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mover</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_Speed = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Rigidbody m_RigidBody;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> GameController m_GameController;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		m_RigidBody = GetComponent&lt;Rigidbody&gt; ();</span><br><span class="line">		m_RigidBody.velocity = transform.forward * m_Speed;</span><br><span class="line">		GameObject gamecontrollerobject = GameObject.FindGameObjectWithTag (<span class="string">"GameController"</span>);</span><br><span class="line">		<span class="keyword">if</span> (gamecontrollerobject != <span class="keyword">null</span>) &#123;</span><br><span class="line">			m_GameController = gamecontrollerobject.GetComponent&lt;GameController&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (m_GameController == <span class="keyword">null</span>) &#123;</span><br><span class="line">			Debug.Log(<span class="string">"m_GameController == null in ShipController::Start()"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_GameController.IsGameEnd ()) </span><br><span class="line">		&#123;</span><br><span class="line">			m_RigidBody.rotation = Quaternion.Euler(<span class="number">0.0</span>f,<span class="number">0.0</span>f,<span class="number">0.0</span>f);</span><br><span class="line">			m_RigidBody.velocity = <span class="keyword">new</span> Vector3(<span class="number">0.0</span>f,<span class="number">0.0</span>f,<span class="number">0.0</span>f);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>RandomRotator.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RandomRotator</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_Tumble = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Rigidbody m_Rigidbody;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		m_Rigidbody = GetComponent&lt;Rigidbody&gt; ();</span><br><span class="line">		m_Rigidbody.angularVelocity = Random.insideUnitSphere * m_Tumble;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Captures</strong><br><em>Game Play</em><br><img src="/img/Unity/Space_Shooter_Game_Play.PNG" alt="Space_Shooter_Game_Play"><br><em>Win Game</em><br><img src="/img/Unity/Space_Shooter_Game_Win.PNG" alt="Space_Shooter_Game_Win"></p>
<p>Survival Shooter<br><strong>Game Introduction</strong><br>固定(2.5D — isometric projection)第三人称视角游戏</p>
<p><strong>Code</strong><br>CameraFollow.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CameraFollow</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> Transform m_Target;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_Smoothing = <span class="number">5.0</span>f;</span><br><span class="line"></span><br><span class="line">	Vector3 m_Offset;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		m_Offset = transform.position - m_Target.position;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		Vector3 targetCamPos = m_Target.position + m_Offset;</span><br><span class="line">		transform.position = Vector3.Lerp (transform.position, targetCamPos, m_Smoothing * Time.deltaTime);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PlayerShooting.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerShooting</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> damagePerShot = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> timeBetweenBullets = <span class="number">0.15</span>f;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> range = <span class="number">100</span>f;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> timer;</span><br><span class="line">    Ray shootRay;</span><br><span class="line">    RaycastHit shootHit;</span><br><span class="line">    <span class="keyword">int</span> shootableMask;</span><br><span class="line">    ParticleSystem gunParticles;</span><br><span class="line">    LineRenderer gunLine;</span><br><span class="line">    AudioSource gunAudio;</span><br><span class="line">    Light gunLight;</span><br><span class="line">    <span class="keyword">float</span> effectsDisplayTime = <span class="number">0.2</span>f;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        shootableMask = LayerMask.GetMask (<span class="string">"Shootable"</span>);</span><br><span class="line">        gunParticles = GetComponent&lt;ParticleSystem&gt; ();</span><br><span class="line">        gunLine = GetComponent &lt;LineRenderer&gt; ();</span><br><span class="line">        gunAudio = GetComponent&lt;AudioSource&gt; ();</span><br><span class="line">        gunLight = GetComponent&lt;Light&gt; ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        timer += Time.deltaTime;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(Input.GetButton (<span class="string">"Fire1"</span>) &amp;&amp; timer &gt;= timeBetweenBullets &amp;&amp; Time.timeScale != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Shoot ();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(timer &gt;= timeBetweenBullets * effectsDisplayTime)</span><br><span class="line">        &#123;</span><br><span class="line">            DisableEffects ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DisableEffects</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        gunLine.enabled = <span class="keyword">false</span>;</span><br><span class="line">        gunLight.enabled = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Shoot</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        timer = <span class="number">0</span>f;</span><br><span class="line"></span><br><span class="line">        gunAudio.Play ();</span><br><span class="line"></span><br><span class="line">        gunLight.enabled = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        gunParticles.Stop ();</span><br><span class="line">        gunParticles.Play ();</span><br><span class="line"></span><br><span class="line">        gunLine.enabled = <span class="keyword">true</span>;</span><br><span class="line">        gunLine.SetPosition (<span class="number">0</span>, transform.position);</span><br><span class="line"></span><br><span class="line">        shootRay.origin = transform.position;</span><br><span class="line">        shootRay.direction = transform.forward;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(Physics.Raycast (shootRay, <span class="keyword">out</span> shootHit, range, shootableMask))</span><br><span class="line">        &#123;</span><br><span class="line">            EnemyHealth enemyHealth = shootHit.collider.GetComponent &lt;EnemyHealth&gt; ();</span><br><span class="line">			Debug.Log(<span class="string">"Shootting"</span>);</span><br><span class="line">			Debug.Log(<span class="string">"shootHit.collider.name = "</span> + shootHit.collider.name);</span><br><span class="line">			<span class="keyword">if</span>(enemyHealth != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">				Debug.Log(<span class="string">"enermyHealth != null"</span>);</span><br><span class="line">                enemyHealth.TakeDamage (damagePerShot, shootHit.point);</span><br><span class="line">            &#125;</span><br><span class="line">            gunLine.SetPosition (<span class="number">1</span>, shootHit.point);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">			Debug.Log(<span class="string">"Not shot"</span>);</span><br><span class="line">            gunLine.SetPosition (<span class="number">1</span>, shootRay.origin + shootRay.direction * range);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PlayerMovement.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerMovement</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> m_Speed = <span class="number">6.0</span>f;</span><br><span class="line"></span><br><span class="line">	Vector3 m_Movement;</span><br><span class="line"></span><br><span class="line">	Animator m_Anim;</span><br><span class="line"></span><br><span class="line">	Rigidbody m_PlayerRigidbody;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> m_FloorMask;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> m_CamRayLength = <span class="number">100.0</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		m_FloorMask = LayerMask.GetMask (<span class="string">"Floor"</span>);</span><br><span class="line"></span><br><span class="line">		m_Anim = GetComponent&lt;Animator&gt; ();</span><br><span class="line"></span><br><span class="line">		m_PlayerRigidbody = GetComponent&lt;Rigidbody&gt; ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">float</span> h = Input.GetAxisRaw (<span class="string">"Horizontal"</span>);</span><br><span class="line">		<span class="keyword">float</span> v = Input.GetAxisRaw (<span class="string">"Vertical"</span>);</span><br><span class="line"></span><br><span class="line">		Move (h, v);</span><br><span class="line">		Turning ();</span><br><span class="line">		Animating(h,v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Move</span>(<span class="params"><span class="keyword">float</span> h, <span class="keyword">float</span> v</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		m_Movement.Set (h, <span class="number">0.0</span>f, v);</span><br><span class="line">		m_Movement = m_Movement.normalized * m_Speed * Time.deltaTime;</span><br><span class="line">		m_PlayerRigidbody.MovePosition (transform.position + m_Movement);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Turning</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		Ray camRay = Camera.main.ScreenPointToRay (Input.mousePosition);</span><br><span class="line"></span><br><span class="line">		RaycastHit floorHit;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(Physics.Raycast(camRay,<span class="keyword">out</span> floorHit,m_CamRayLength, m_FloorMask))</span><br><span class="line">	   &#123;</span><br><span class="line">		Vector3 playerToMouse = floorHit.point - transform.position;</span><br><span class="line">		playerToMouse.y = <span class="number">0.0</span>f;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		Quaternion newRotation = Quaternion.LookRotation(playerToMouse);</span><br><span class="line">		m_PlayerRigidbody.MoveRotation(newRotation);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Animating</span>(<span class="params"><span class="keyword">float</span> h, <span class="keyword">float</span> v</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">bool</span> walking = (h != <span class="number">0.0</span>f || v != <span class="number">0.0</span>f);</span><br><span class="line">		m_Anim.SetBool (<span class="string">"IsWalking"</span>, walking);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PlayerHealth.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerHealth</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> startingHealth = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> currentHealth;</span><br><span class="line">    <span class="keyword">public</span> Slider healthSlider;</span><br><span class="line">    <span class="keyword">public</span> Image damageImage;</span><br><span class="line">    <span class="keyword">public</span> AudioClip deathClip;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> flashSpeed = <span class="number">5</span>f;</span><br><span class="line">    <span class="keyword">public</span> Color flashColour = <span class="keyword">new</span> Color(<span class="number">1</span>f, <span class="number">0</span>f, <span class="number">0</span>f, <span class="number">0.1</span>f);</span><br><span class="line"></span><br><span class="line">    Animator anim;</span><br><span class="line">    AudioSource playerAudio;</span><br><span class="line">    PlayerMovement playerMovement;</span><br><span class="line">    <span class="comment">//PlayerShooting playerShooting;</span></span><br><span class="line">    <span class="keyword">bool</span> isDead;</span><br><span class="line">    <span class="keyword">bool</span> damaged;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        anim = GetComponent &lt;Animator&gt; ();</span><br><span class="line">        playerAudio = GetComponent &lt;AudioSource&gt; ();</span><br><span class="line">        playerMovement = GetComponent &lt;PlayerMovement&gt; ();</span><br><span class="line">        <span class="comment">//playerShooting = GetComponentInChildren &lt;PlayerShooting&gt; ();</span></span><br><span class="line">        currentHealth = startingHealth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(damaged)</span><br><span class="line">        &#123;</span><br><span class="line">            damageImage.color = flashColour;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            damageImage.color = Color.Lerp (damageImage.color, Color.clear, flashSpeed * Time.deltaTime);</span><br><span class="line">        &#125;</span><br><span class="line">        damaged = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span> (<span class="params"><span class="keyword">int</span> amount</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        damaged = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        currentHealth -= amount;</span><br><span class="line"></span><br><span class="line">        healthSlider.<span class="keyword">value</span> = currentHealth;</span><br><span class="line"></span><br><span class="line">        playerAudio.Play ();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(currentHealth &lt;= <span class="number">0</span> &amp;&amp; !isDead)</span><br><span class="line">        &#123;</span><br><span class="line">            Death ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Death</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        isDead = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//playerShooting.DisableEffects ();</span></span><br><span class="line"></span><br><span class="line">        anim.SetTrigger (<span class="string">"Die"</span>);</span><br><span class="line"></span><br><span class="line">        playerAudio.clip = deathClip;</span><br><span class="line">        playerAudio.Play ();</span><br><span class="line"></span><br><span class="line">        playerMovement.enabled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//playerShooting.enabled = false;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RestartLevel</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        Application.LoadLevel (Application.loadedLevel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>EnemyMovement.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyMovement</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    Transform player;</span><br><span class="line">    PlayerHealth playerHealth;</span><br><span class="line">    EnemyHealth enemyHealth;</span><br><span class="line">    NavMeshAgent nav;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        player = GameObject.FindGameObjectWithTag (<span class="string">"Player"</span>).transform;</span><br><span class="line">        playerHealth = player.GetComponent &lt;PlayerHealth&gt; ();</span><br><span class="line">        enemyHealth = GetComponent &lt;EnemyHealth&gt; ();</span><br><span class="line">        nav = GetComponent &lt;NavMeshAgent&gt; ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(enemyHealth.currentHealth &gt; <span class="number">0</span> &amp;&amp; playerHealth.currentHealth &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            nav.SetDestination (player.position);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            nav.enabled = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>EnemyHealth.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyHealth</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> startingHealth = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> currentHealth;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> sinkSpeed = <span class="number">2.5</span>f;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> scoreValue = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">public</span> AudioClip deathClip;</span><br><span class="line"></span><br><span class="line">    Animator anim;</span><br><span class="line">    AudioSource enemyAudio;</span><br><span class="line">    ParticleSystem hitParticles;</span><br><span class="line">    CapsuleCollider capsuleCollider;</span><br><span class="line">    <span class="keyword">bool</span> isDead;</span><br><span class="line">    <span class="keyword">bool</span> isSinking;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        anim = GetComponent &lt;Animator&gt; ();</span><br><span class="line">        enemyAudio = GetComponent &lt;AudioSource&gt; ();</span><br><span class="line">        hitParticles = GetComponentInChildren &lt;ParticleSystem&gt; ();</span><br><span class="line">        capsuleCollider = GetComponent &lt;CapsuleCollider&gt; ();</span><br><span class="line"></span><br><span class="line">        currentHealth = startingHealth;</span><br><span class="line">		isDead = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(isSinking)</span><br><span class="line">        &#123;</span><br><span class="line">            transform.Translate (-Vector3.up * sinkSpeed * Time.deltaTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span> (<span class="params"><span class="keyword">int</span> amount, Vector3 hitPoint</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">		Debug.Log (<span class="string">"isDead = "</span> + isDead);</span><br><span class="line">        <span class="keyword">if</span>(isDead)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        enemyAudio.Play ();</span><br><span class="line"></span><br><span class="line">        currentHealth -= amount;</span><br><span class="line">            </span><br><span class="line">        hitParticles.transform.position = hitPoint;</span><br><span class="line">        hitParticles.Play();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(currentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Death ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Death</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        isDead = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        capsuleCollider.isTrigger = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        anim.SetTrigger (<span class="string">"Dead"</span>);</span><br><span class="line"></span><br><span class="line">        enemyAudio.clip = deathClip;</span><br><span class="line">        enemyAudio.Play ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartSinking</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        GetComponent &lt;NavMeshAgent&gt; ().enabled = <span class="keyword">false</span>;</span><br><span class="line">        GetComponent &lt;Rigidbody&gt; ().isKinematic = <span class="keyword">true</span>;</span><br><span class="line">        isSinking = <span class="keyword">true</span>;</span><br><span class="line">        ScoreManager.score += scoreValue;</span><br><span class="line">        Destroy (gameObject, <span class="number">2</span>f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>EnemyAttack.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyAttack</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> timeBetweenAttacks = <span class="number">0.5</span>f;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> attackDamage = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> validAttackDistance = <span class="number">1.0</span>f;</span><br><span class="line"></span><br><span class="line">    Animator anim;</span><br><span class="line">    GameObject player;</span><br><span class="line">    PlayerHealth playerHealth;</span><br><span class="line">    EnemyHealth enemyHealth;</span><br><span class="line">    <span class="keyword">bool</span> playerInRange;</span><br><span class="line">    <span class="keyword">float</span> timer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        player = GameObject.FindGameObjectWithTag (<span class="string">"Player"</span>);</span><br><span class="line">        playerHealth = player.GetComponent &lt;PlayerHealth&gt; ();</span><br><span class="line">        enemyHealth = GetComponent&lt;EnemyHealth&gt;();</span><br><span class="line">        anim = GetComponent &lt;Animator&gt; ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line">    void OnTriggerEnter (Collider other)</span><br><span class="line">    &#123;</span><br><span class="line">        if(other.gameObject == player)</span><br><span class="line">        &#123;</span><br><span class="line">            playerInRange = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void OnTriggerExit (Collider other)</span><br><span class="line">    &#123;</span><br><span class="line">        if(other.gameObject == player)</span><br><span class="line">        &#123;</span><br><span class="line">            playerInRange = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnCollisionEnter</span>(<span class="params">Collision collision</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(collision.gameObject == player)</span><br><span class="line">		&#123;</span><br><span class="line">			playerInRange = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnCollisionExit</span>(<span class="params">Collision collision</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(collision.gameObject == player)</span><br><span class="line">		&#123;</span><br><span class="line">			playerInRange = <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        timer += Time.deltaTime;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(timer &gt;= timeBetweenAttacks &amp;&amp; playerInRange &amp;&amp; enemyHealth.currentHealth &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Attack ();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(playerHealth.currentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            anim.SetTrigger (<span class="string">"PlayerDead"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Attack</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        timer = <span class="number">0</span>f;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(playerHealth.currentHealth &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            playerHealth.TakeDamage (attackDamage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ScoreManager.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ScoreManager</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> score;</span><br><span class="line"></span><br><span class="line">    Text text;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        text = GetComponent &lt;Text&gt; ();</span><br><span class="line">        score = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        text.text = <span class="string">"Score: "</span> + score;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>EnemyManager.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyManager</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> PlayerHealth playerHealth;</span><br><span class="line">    <span class="keyword">public</span> GameObject enemy;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> spawnTime = <span class="number">3</span>f;</span><br><span class="line">    <span class="keyword">public</span> Transform[] spawnPoints;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        InvokeRepeating (<span class="string">"Spawn"</span>, spawnTime, spawnTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Spawn</span> (<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(playerHealth.currentHealth &lt;= <span class="number">0</span>f)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> spawnPointIndex = Random.Range (<span class="number">0</span>, spawnPoints.Length);</span><br><span class="line"></span><br><span class="line">        Instantiate (enemy, spawnPoints[spawnPointIndex].position, spawnPoints[spawnPointIndex].rotation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GameOverManager.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameOverManager</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> PlayerHealth playerHealth;</span><br><span class="line"></span><br><span class="line">    Animator anim;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        anim = GetComponent&lt;Animator&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">		Debug.Log (<span class="string">"playerHealth.currentHealth = "</span> + playerHealth.currentHealth);</span><br><span class="line">        <span class="keyword">if</span> (playerHealth.currentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            anim.SetTrigger(<span class="string">"GameOver"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Captures</strong><br><em>Game(因为一些原因没有截图)</em><br><img src="/img/Unity/Survival_Shooter_Game.PNG" alt="Survival_Shooter_Game"><br><a href="https://unity3d.com/learn/tutorials/projects/survival-shooter-project" target="_blank" rel="external">图片来源</a></p>
<h2 id="2D-ROGUELIKE-TUTORIAL">2D-ROGUELIKE-TUTORIAL</h2><p><strong>Game Introduction</strong><br>Over the course of the project will create procedural tile based levels, implement turn based movement, add a hunger system, audio and mobile touch controls. </p>
<p><strong>Code</strong><br>BoardManager.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Random = UnityEngine.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoardManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	[Serializable]</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Count</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">int</span> minimum;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">int</span> maximum;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">Count</span>(<span class="params"><span class="keyword">int</span> min, <span class="keyword">int</span> max</span>)</span><br><span class="line">		</span>&#123;</span><br><span class="line">			minimum = min;</span><br><span class="line">			maximum = max;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> columns = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> rows = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">public</span> Count wallCount = <span class="keyword">new</span> Count(<span class="number">5</span>,<span class="number">9</span>);</span><br><span class="line">	<span class="keyword">public</span> Count foodCount = <span class="keyword">new</span> Count(<span class="number">1</span>,<span class="number">5</span>);</span><br><span class="line">	<span class="keyword">public</span> GameObject exit;</span><br><span class="line">	<span class="keyword">public</span> GameObject[] floorTiles;</span><br><span class="line">	<span class="keyword">public</span> GameObject[] wallTiles;</span><br><span class="line">	<span class="keyword">public</span> GameObject[] foodTiles;</span><br><span class="line">	<span class="keyword">public</span> GameObject[] enemyTiles;</span><br><span class="line">	<span class="keyword">public</span> GameObject[] outerwallTiles;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Transform boardHolder;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Vector3&gt; gridPositions = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">InitialiseList</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		gridPositions.Clear ();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">1</span>; x &lt; columns - <span class="number">1</span>; x++) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> y = <span class="number">1</span>; y &lt; rows - <span class="number">1</span>; y++)</span><br><span class="line">			&#123;</span><br><span class="line">				gridPositions.Add(<span class="keyword">new</span> Vector3(x,y,<span class="number">0</span>f));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">BoardSetup</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		boardHolder = <span class="keyword">new</span> GameObject (<span class="string">"Board"</span>).transform;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> x = -<span class="number">1</span>; x &lt; columns + <span class="number">1</span>; x++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> y = -<span class="number">1</span>; y &lt; rows + <span class="number">1</span>; y++)</span><br><span class="line">			&#123;</span><br><span class="line">				GameObject toInstantiate = floorTiles[Random.Range (<span class="number">0</span>,floorTiles.Length)];</span><br><span class="line">				<span class="keyword">if</span>(x == -<span class="number">1</span> || x == columns || y == -<span class="number">1</span> || y == rows)</span><br><span class="line">				&#123;</span><br><span class="line">					toInstantiate = outerwallTiles[Random.Range(<span class="number">0</span>,outerwallTiles.Length)];</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				GameObject instance = Instantiate (toInstantiate, <span class="keyword">new</span> Vector3(x,y,<span class="number">0</span>f),Quaternion.identity) <span class="keyword">as</span> GameObject;</span><br><span class="line"></span><br><span class="line">				instance.transform.SetParent(boardHolder);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">Vector3 <span class="title">RandomPosition</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">int</span> randomIndex = Random.Range (<span class="number">0</span>, gridPositions.Count);</span><br><span class="line">		Vector3 randomPosition = gridPositions [randomIndex];</span><br><span class="line">		gridPositions.RemoveAt(randomIndex);</span><br><span class="line">		<span class="keyword">return</span> randomPosition;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LayoutObjectAtRandom</span>(<span class="params">GameObject[] tileArray, <span class="keyword">int</span> minimum, <span class="keyword">int</span> maximum</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">int</span> objectCount = Random.Range (minimum, maximum + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objectCount; i++) &#123;</span><br><span class="line">			Vector3 randomPosition = RandomPosition();</span><br><span class="line">			GameObject tileChoice = tileArray[Random.Range (<span class="number">0</span>, tileArray.Length)];</span><br><span class="line">			Instantiate(tileChoice, randomPosition, Quaternion.identity);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetupScene</span>(<span class="params"><span class="keyword">int</span> level</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		BoardSetup ();</span><br><span class="line">		InitialiseList ();</span><br><span class="line">		LayoutObjectAtRandom (wallTiles, wallCount.minimum, wallCount.maximum);</span><br><span class="line">		LayoutObjectAtRandom (foodTiles, foodCount.minimum, foodCount.maximum);</span><br><span class="line">		<span class="keyword">int</span> enemyCount = (<span class="keyword">int</span>)Mathf.Log (level, <span class="number">2</span>f);</span><br><span class="line">		LayoutObjectAtRandom (enemyTiles, enemyCount, enemyCount);</span><br><span class="line">		Instantiate (exit, <span class="keyword">new</span> Vector3 (columns - <span class="number">1</span>, rows - <span class="number">1</span>, <span class="number">0</span>f), Quaternion.identity);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GameManager.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> levelStartDelay = <span class="number">2</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> turnDelay = <span class="number">0.1</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> GameManager instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> BoardManager boardScript;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> playerFoodPoints = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">	[HideInInspector]<span class="keyword">public</span> <span class="keyword">bool</span> playerTurn = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Text levelText;</span><br><span class="line">	<span class="keyword">private</span> GameObject levelImage;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> level = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> doingSetup;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;Enemy&gt; enemies;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> enemiesMoving;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (instance == <span class="keyword">null</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			instance = <span class="keyword">this</span>;</span><br><span class="line">		&#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">instance != <span class="keyword">this</span></span>) </span><br><span class="line">		</span>&#123;</span><br><span class="line">			Destroy (gameObject);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		DontDestroyOnLoad(gameObject);</span><br><span class="line"></span><br><span class="line">		enemies = <span class="keyword">new</span> List&lt;Enemy&gt; ();</span><br><span class="line"></span><br><span class="line">		boardScript = GetComponent&lt;BoardManager&gt; ();</span><br><span class="line">		InitGame ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnLevelWasLoaded</span>(<span class="params"><span class="keyword">int</span> index</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		level++;</span><br><span class="line"></span><br><span class="line">		InitGame ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">InitGame</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		doingSetup = <span class="keyword">true</span>;</span><br><span class="line">		levelImage = GameObject.Find (<span class="string">"LevelImage"</span>);</span><br><span class="line">		levelText = GameObject.Find (<span class="string">"LevelText"</span>).GetComponent&lt;Text&gt; ();</span><br><span class="line">		levelText.text = <span class="string">"Day "</span> + level;</span><br><span class="line">		levelImage.SetActive (<span class="keyword">true</span>);</span><br><span class="line">		Invoke (<span class="string">"HideLevelImage"</span>, levelStartDelay);</span><br><span class="line"></span><br><span class="line">		enemies.Clear ();</span><br><span class="line">		boardScript.SetupScene (level);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HideLevelImage</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		levelImage.SetActive (<span class="keyword">false</span>);</span><br><span class="line">		doingSetup = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GameOver</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		levelText.text = <span class="string">"After "</span> + level + <span class="string">" days, you starved."</span>;</span><br><span class="line">		levelImage.SetActive (<span class="keyword">true</span>);</span><br><span class="line">		enabled = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (playerTurn || enemiesMoving || doingSetup ) &#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		StartCoroutine (MoveEnemies ());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddEnemyToList</span>(<span class="params">Enemy script</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		enemies.Add (script);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">IEnumerator <span class="title">MoveEnemies</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		enemiesMoving = <span class="keyword">true</span>;</span><br><span class="line">		<span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span>(<span class="params">turnDelay</span>)</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (enemies.Count == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span>(<span class="params">turnDelay</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; enemies.Count; i++) &#123;</span><br><span class="line">			enemies[i].MoveEnemy();</span><br><span class="line">			<span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span>(<span class="params">turnDelay</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Debug.Log (<span class="string">"GameManager::MoveEnemies"</span>);</span><br><span class="line">		playerTurn = <span class="keyword">true</span>;</span><br><span class="line">		enemiesMoving = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MovingObject.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>BoardManager.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">MovingObject</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> moveTime = <span class="number">0.1</span>f;</span><br><span class="line">	<span class="keyword">public</span> LayerMask blockingLayer;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> BoxCollider2D BoxCollider;</span><br><span class="line">	<span class="keyword">private</span> Rigidbody2D rb2D;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> inverseMoveTime;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		BoxCollider = GetComponent&lt;BoxCollider2D&gt; ();</span><br><span class="line">		rb2D = GetComponent&lt;Rigidbody2D&gt; ();</span><br><span class="line">		inverseMoveTime = <span class="number">1</span>f / moveTime;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">Move</span>(<span class="params"><span class="keyword">int</span> xDir, <span class="keyword">int</span> yDir, <span class="keyword">out</span> RaycastHit2D hit</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		Vector2 start = transform.position;</span><br><span class="line">		Vector2 end = start + <span class="keyword">new</span> Vector2 (xDir, yDir);</span><br><span class="line"></span><br><span class="line">		BoxCollider.enabled = <span class="keyword">false</span>;</span><br><span class="line">		hit = Physics2D.Linecast (start, end, blockingLayer);</span><br><span class="line">		BoxCollider.enabled = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>( hit.transform == <span class="keyword">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			StartCoroutine(SmoothMovement(end));</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> IEnumerator <span class="title">SmoothMovement</span>(<span class="params">Vector3 end</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">float</span> sqrRemainingDistance = (transform.position - end).sqrMagnitude;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (sqrRemainingDistance &gt; <span class="keyword">float</span>.Epsilon) &#123;</span><br><span class="line">			Vector3 newPosition = Vector3.MoveTowards(rb2D.position, end, inverseMoveTime * Time.deltaTime);</span><br><span class="line">			rb2D.MovePosition(newPosition);</span><br><span class="line">			sqrRemainingDistance = (transform.position - end).sqrMagnitude;</span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> AttemptMove&lt;T&gt;(<span class="keyword">int</span> xDir, <span class="keyword">int</span> yDir) <span class="keyword">where</span> T : Component</span><br><span class="line">	&#123;</span><br><span class="line">		RaycastHit2D hit;</span><br><span class="line">		<span class="keyword">bool</span> canMove = Move (xDir, yDir, <span class="keyword">out</span> hit);</span><br><span class="line">		<span class="keyword">if</span> (hit.transform == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		T hitComponent = hit.transform.GetComponent&lt;T&gt; ();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!canMove &amp;&amp; hitComponent != <span class="keyword">null</span>) &#123;</span><br><span class="line">			OnCanMove(hitComponent);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> OnCanMove&lt;T&gt;(T component) <span class="keyword">where</span> T : Component;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Player.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span> : <span class="title">MovingObject</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> wallDamage = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> pointsPerFood = <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> pointsPerSoda = <span class="number">20</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> restartLevelDelay = <span class="number">1</span>f;</span><br><span class="line">	<span class="keyword">public</span> Text foodText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AudioClip moveSound1;</span><br><span class="line">	<span class="keyword">public</span> AudioClip moveSound2;</span><br><span class="line">	<span class="keyword">public</span> AudioClip eatSound1;</span><br><span class="line">	<span class="keyword">public</span> AudioClip eatSound2;</span><br><span class="line">	<span class="keyword">public</span> AudioClip drinkSound1;</span><br><span class="line">	<span class="keyword">public</span> AudioClip drinkSound2;</span><br><span class="line">	<span class="keyword">public</span> AudioClip gameOverSound;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Animator animator;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> food;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Vector2 touchOrigin = -Vector2.one;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		foodText.text = <span class="string">"Food:"</span> + food;</span><br><span class="line"></span><br><span class="line">		animator = GetComponent&lt;Animator&gt; ();</span><br><span class="line"></span><br><span class="line">		food = GameManager.instance.playerFoodPoints;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">base</span>.Start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		GameManager.instance.playerFoodPoints = food;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!GameManager.instance.playerTurn) &#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Debug.Log (<span class="string">"Player::Update() called"</span>);</span><br><span class="line">		<span class="keyword">int</span> horizontal = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span> vertical = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="preprocessor">#<span class="keyword">if</span> UNITY_EDITOR || UNITY_STANDLONE || UNITY_WEBPLAYER</span></span><br><span class="line">		horizontal = (<span class="keyword">int</span>)Input.GetAxisRaw (<span class="string">"Horizontal"</span>);</span><br><span class="line">		vertical = (<span class="keyword">int</span>)Input.GetAxisRaw (<span class="string">"Vertical"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (horizontal != <span class="number">0</span>) &#123;</span><br><span class="line">			vertical = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(Input.touchCount &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Touch myTouch = Input.touches[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">if</span>(myTouch.phase == TouchPhase.Began)</span><br><span class="line">			&#123;</span><br><span class="line">				touchOrigin = myTouch.position;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">myTouch.phase == TouchPhase.Ended &amp;&amp; touchOrigin.x &gt;= <span class="number">0</span></span>)</span><br><span class="line">			</span>&#123;</span><br><span class="line">				Vector2 touchEnd = myTouch.position;</span><br><span class="line">				<span class="keyword">float</span> x = touchEnd.x - touchOrigin.x;</span><br><span class="line">				<span class="keyword">float</span> y = touchEnd.y - touchOrigin.y;</span><br><span class="line">				touchOrigin.x = -<span class="number">1</span>;</span><br><span class="line">				<span class="keyword">if</span>(Mathf.Abs(x) &gt; Mathf.Abs(y))</span><br><span class="line">				&#123;</span><br><span class="line">					horizontal = x &gt; <span class="number">0</span> ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					vertical = y &gt; <span class="number">0</span> ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (horizontal != <span class="number">0</span> || vertical != <span class="number">0</span> ) &#123;</span><br><span class="line">			AttemptMove&lt;Wall&gt;(horizontal, vertical);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> AttemptMove&lt;T&gt;(<span class="keyword">int</span> xDir, <span class="keyword">int</span> yDir)</span><br><span class="line">	&#123;</span><br><span class="line">		food--;</span><br><span class="line">		foodText.text = <span class="string">"Food:"</span> + food;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">base</span>.AttemptMove&lt;T&gt; (xDir, yDir);</span><br><span class="line"></span><br><span class="line">		RaycastHit2D hit;</span><br><span class="line">		<span class="keyword">if</span>(Move (xDir, yDir, <span class="keyword">out</span> hit))</span><br><span class="line">		&#123;</span><br><span class="line">			SoundManager.instance.RandomizeSfx(moveSound1,moveSound2);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CheckIfGameOver ();</span><br><span class="line"></span><br><span class="line">		GameManager.instance.playerTurn = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnTriggerEnter2D</span>(<span class="params">Collider2D other</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (other.tag == <span class="string">"Exit"</span>) &#123;</span><br><span class="line">			Invoke (<span class="string">"Restart"</span>, restartLevelDelay);</span><br><span class="line">			enabled = <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">other.tag == <span class="string">"Food"</span></span>) </span>&#123;</span><br><span class="line">			food += pointsPerFood;</span><br><span class="line">			other.gameObject.SetActive(<span class="keyword">false</span>);</span><br><span class="line">			foodText.text = <span class="string">"+:"</span> + pointsPerFood + <span class="string">"Food: "</span> + food;</span><br><span class="line">			SoundManager.instance.RandomizeSfx(drinkSound1,drinkSound2);</span><br><span class="line">		&#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">other.tag == <span class="string">"Soda"</span></span>) </span>&#123;</span><br><span class="line">			food += pointsPerSoda;</span><br><span class="line">			other.gameObject.SetActive(<span class="keyword">false</span>);</span><br><span class="line">			foodText.text = <span class="string">"+:"</span> + pointsPerSoda + <span class="string">"Food: "</span> + food;			</span><br><span class="line">			SoundManager.instance.RandomizeSfx(drinkSound1,drinkSound2);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> OnCanMove&lt;T&gt;(T component)</span><br><span class="line">	&#123;</span><br><span class="line">		Wall hitWall = component <span class="keyword">as</span> Wall;</span><br><span class="line">		hitWall.DamageWall (wallDamage);</span><br><span class="line">		animator.SetTrigger (<span class="string">"PlayerChop"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Restart</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		Application.LoadLevel (Application.loadedLevel);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoseFood</span>(<span class="params"><span class="keyword">int</span> loss</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		animator.SetTrigger (<span class="string">"PlayerHit"</span>);</span><br><span class="line">		food -= loss;</span><br><span class="line">		foodText.text = <span class="string">"-:"</span> + loss + <span class="string">"Food: "</span> + food;</span><br><span class="line">		CheckIfGameOver();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckIfGameOver</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (food &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			SoundManager.instance.PlaySingle(gameOverSound);</span><br><span class="line">			SoundManager.instance.musicSource.Stop();</span><br><span class="line">			GameManager.instance.GameOver();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Enemy.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Enemy</span> : <span class="title">MovingObject</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> playerDamager;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Animator animator;</span><br><span class="line">	<span class="keyword">private</span> Transform target;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> skipMove;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AudioClip enemyAttack1;</span><br><span class="line">	<span class="keyword">public</span> AudioClip enemyAttack2;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		GameManager.instance.AddEnemyToList (<span class="keyword">this</span>);</span><br><span class="line">		animator = GetComponent&lt;Animator&gt; ();</span><br><span class="line">		target = GameObject.FindGameObjectWithTag (<span class="string">"Player"</span>).transform;</span><br><span class="line">		<span class="keyword">base</span>.Start ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> AttemptMove&lt;T&gt;(<span class="keyword">int</span> xDir, <span class="keyword">int</span> yDir)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (skipMove) &#123;</span><br><span class="line">			skipMove = <span class="keyword">false</span>;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">base</span>.AttemptMove&lt;T&gt; (xDir, yDir);</span><br><span class="line"></span><br><span class="line">		skipMove = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MoveEnemy</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">int</span> xDir = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span> yDir = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (Mathf.Abs (target.position.x - transform.position.x) &lt; <span class="keyword">float</span>.Epsilon) &#123;</span><br><span class="line">			yDir = target.position.y &gt; transform.position.y ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			xDir = target.position.x &gt; transform.position.x ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		AttemptMove&lt;Player&gt; (xDir, yDir);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> OnCanMove&lt;T&gt;(T component)</span><br><span class="line">	&#123;</span><br><span class="line">		Player hitPlayer = component <span class="keyword">as</span> Player;</span><br><span class="line"></span><br><span class="line">		animator.SetTrigger (<span class="string">"enemyAttack"</span>);</span><br><span class="line"></span><br><span class="line">		hitPlayer.LoseFood (playerDamager);</span><br><span class="line"></span><br><span class="line">		SoundManager.instance.RandomizeSfx (enemyAttack1, enemyAttack2);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SoundManager.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoundManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AudioSource efxSource;</span><br><span class="line">	<span class="keyword">public</span> AudioSource musicSource;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> SoundManager instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> lowPitchRange = <span class="number">0.95</span>f;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> highPitchRange = <span class="number">1.05</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">			instance = <span class="keyword">this</span>;</span><br><span class="line">		&#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">instance != <span class="keyword">this</span></span>) </span>&#123;</span><br><span class="line">			Destroy(gameObject);</span><br><span class="line">		&#125;</span><br><span class="line">		DontDestroyOnLoad (gameObject);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PlaySingle</span>(<span class="params">AudioClip clip</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		efxSource.clip = clip;</span><br><span class="line">		efxSource.Play ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RandomizeSfx</span>(<span class="params"><span class="keyword">params</span> AudioClip[] clips</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">int</span> randomIndex = Random.Range (<span class="number">0</span>, clips.Length);</span><br><span class="line">		<span class="keyword">float</span> randomPitch = Random.Range (lowPitchRange, highPitchRange);</span><br><span class="line"></span><br><span class="line">		efxSource.pitch = randomPitch;</span><br><span class="line">		efxSource.clip = clips [randomIndex];</span><br><span class="line">		efxSource.Play ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Wall.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Wall</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Sprite dmgSprite;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> hp = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SpriteRenderer spriteRenderer;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AudioClip wallChop1;</span><br><span class="line">	<span class="keyword">public</span> AudioClip wallChop2;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		spriteRenderer = GetComponent&lt;SpriteRenderer&gt; ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DamageWall</span>(<span class="params"><span class="keyword">int</span> loss</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		spriteRenderer.sprite = dmgSprite;</span><br><span class="line">		hp -= loss;</span><br><span class="line">		SoundManager.instance.RandomizeSfx (wallChop1, wallChop2);</span><br><span class="line">		<span class="keyword">if</span> (hp &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			gameObject.SetActive(<span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Loder.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Loader</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject gameManager;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (GameManager.instance == <span class="keyword">null</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			Instantiate (gameManager);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Captures</strong><br><em>Game Start</em><br><img src="/img/Unity/2DRogueLike_Game_Start.PNG" alt="2DRogueLike_Game_Start"><br><em>Game Play</em><br><img src="/img/Unity/2DRogueLike_Game_Play.PNG" alt="2DRogueLike_Game_Play"><br><em>lose Game</em><br><img src="/img/Unity/2DRogueLike_Game_Lose.PNG" alt="2DRogueLike_Game_Lose"></p>
<h2 id="Multiplayer_Networking">Multiplayer Networking</h2><p>这里采用HLAPI(Hight Level API)来制作简单的Multiplayer Networking Game。<br>我们需要通过NetworkkManager去管理网络状态。</p>
<ol>
<li>创建一个Empty Object改名为NetworkManager，然后Add NetworkManager Component到上面。 同时添加一个NetworkManagerHUD Component用于显示对NetworkManager简单控制的UI。<br><img src="/img/Unity/NetworkManagerAndHUD.PNG" alt="NetworkManagerAndHUD"><br><img src="/img/Unity/NetworkManagerHUD.PNG" alt="NetworkManagerHUD"></li>
<li>创建我们的Player Prefab(用于代表我们的Player)<br>这里简单的创建一个Capsule 和Cube GameObject简单制作一个Player Prefab<br>添加NetworkIdentity到Player上用于表示Player，并勾上Local Player Autority。<br>然后创建prefab并保存。<br><img src="/img/Unity/NetworkIdentity.PNG" alt="NetworkIdentity"><br><a href="https://docs.unity3d.com/ScriptReference/Networking.NetworkIdentity.html" target="_blank" rel="external">The NetworkIdentity identifies objects across the network, between server and clients. The NetworkIdentity is used to synchronize information in the object with the network.</a><br><a href="https://docs.unity3d.com/Manual/UNetPlayers.html?_ga=1.67295640.827985704.1454244920" target="_blank" rel="external">Player Object They represent the player on the server and so have the ability to run commands (which are secure client-to-server remote procedure calls) from the player’s client. In this server authoritative system, other non-player server side objects do not have the capability to receive commands directly from objects on clients.</a><br>可以看出NetworkIdentity用于在Server和Clients之间标识对象，同步信息。这样一来Player就具有了从client在server上远程执行commands的能力，就可以通过Client来控制Player Object了。</li>
<li>Registering The Player Prefab<br>在Client控制Player Object之前，我们需要去注册该Player Prefab到Network Manager，然后Network Manager会去负责在Server和Client端Spawn Object。<br>把Player Prefab设置到Network Manager的Player Prefab参数上。<br><img src="/img/Unity/RegisterPlayerPrefab.PNG" alt="RegisterPlayerPrefab"><br>Note:<br>Only the server should create instances of objects which have NetworkIdentity as otherwise they will not be properly connected to the system.(只有server可以创建含NetworkIdentity的实例对象，否则无法正常连接到server system)</li>
<li><p>Creating Player Movement(Single Player)<br>在通过server远程执行commands控制Player移动之前，我们先编写简单的控制逻辑用于本地的移动。<br>挂载PlayerController.cs到Player Prefab上。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> mRotateSpeed = <span class="number">150.0</span>f;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> mMoveSpeed = <span class="number">3.0</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> x = Input.GetAxis(<span class="string">"Horizontal"</span>) * Time.deltaTime * mRotateSpeed;</span><br><span class="line">        <span class="keyword">var</span> z = Input.GetAxis(<span class="string">"Vertical"</span>) * Time.deltaTime * mMoveSpeed;</span><br><span class="line"></span><br><span class="line">        transform.Rotate(<span class="number">0</span>, x, <span class="number">0</span>);</span><br><span class="line">        transform.Translate(<span class="number">0</span>, <span class="number">0</span>, z);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Testing Player Movement Online<br>支持Player Prefab单机控制后，让我们看看如何实现通过Online控制。<br>首先通过NetworkManagerHUD去把本机作为Host，点击LAN Host(H)<br><img src="/img/Unity/StartHost.PNG" alt="StartHost"><br>开启host后NetworkManager会自动根据设定的Player Prefab去创建一个。<br>为了测试我们需要运行两个游戏程序，一个作为Host，一个作为Client。<br>先打包发布PC办。<br>运行PC版作为Host。(点击LAN Hosts(H))<br>然后运行Editor版作为Client进行连接。(点击LAN Client)<br><img src="/img/Unity/TestOnlineMove.PNG" alt="TestOnlineMove"><br>在Server一侧出现了两个Player Prefab创建的对象，但在Server一侧控制的时候会控制两个物体的移动，并且在Client一侧控制并不会影响到Server一侧。<br>这是因为PlayerController脚本还没有network-aware(通过NetworkBehaviour在去获取network相关的一些信息去区分Server和Client等)。<br>所以我们还需要使Client与Host通过NetworkManager进行数据同步。</p>
</li>
<li>Networking Player Movement<br>要使PlayerController脚本network-aware，我们需要使PlayerController继承至NetworkBehaviour(所有需要networking features(receive various callback, automatically synchronize state from server-to-client……)的对象都应该继承至NetworkBehaviour)<br><a href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/networking-player-movement?playlist=29690" target="_blank" rel="external">The LocalPlayer is the player GameObject “owned” by the local Client. This ownership is set by the NetworkManager when a Client connects to the Server and new player GameObjects are created from the player prefab. When a Client connects to the Server, the instance created on the local client is marked as the LocalPlayer.</a><br>可以看出当Client连接到Server的时候，NetworkManager会把新生成的Player GameObject标记为Client的LocalPlayer，然后通过isLocalPlayer去判断是否是本地控制的对象，这样一来解决了同时控制了其他Player物体的问题。<br>但是Client和Server之间Player数据的同步还没有解决。<br>在Player Prefab上我们需要挂载NetworkTransform component，NetworkTransform 回去负责GameObject的trasnform同步。</li>
<li>Testing Multiplayer Movement<br>再次发布PC版，运行PC版作为Server，Editor版作为Client测试。<br>这遇到个错误”Spawn scene object not found for 1<br>UnityEngine.Networking.NetworkIdentity:UNetStaticUpdate()”<br><a href="https://community.unity.com/t5/Multiplayer-Networking/UNET-Spawn-scene-object-not-found/td-p/2387695" target="_blank" rel="external">根据这里的讨论</a>重新制作Prefab和挂载居然能解决问题，感觉是Unity的bug。<br><img src="/img/Unity/MultiplayerNetworkingMovement.PNG" alt="MultiplayerNetworkingMovement"><br>NetworkTransform的一些设定可以控制Network数据同步设定。</li>
<li><p>Identifying The Local Player<br> 为了显示区分Client和Server的Player对象，我们通过利用NetworkBehaviour的接口方法去修改Local Player的颜色信息。<br> OnStartLocalPlayer — “Called when the local player object has been set up.”</p>
 <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStartLocalPlayer</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnStartLocalPlayer();</span><br><span class="line">    GetComponent&lt;MeshRenderer&gt;().material.color = Color.blue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <img src="/img/Unity/ChangeLocalPlayerColor.PNG" alt="ChangeLocalPlayerColor"><br> 可以看到OnStartLocalPlayer是针对于Local Player而言的，所以只有Local Player看到自己控制的对象颜色变了，在另一个Client端因为并没有同步material信息，所以看到的依然是默认Spawn的白色。(NetworkBehaviour里还有很多类似的回调方法会在Server和Client创建GameObject的时候调用)</p>
</li>
<li><p>Shooting(Single Player)<br> 为了增加网络交互，这里我们先测试单机版的shooting功能。<br> 创建并调整Sphere作为Bullet Prefab。同时修改Player添加Cylinder作为Gun，并设置BulletSpawn作为子弹发射点。<br> 制作完如下：<br> <img src="/img/Unity/PlayerWithFunAndBullet.PNG" alt="PlayerWithFunAndBullet"><br> 增加PlayerController.cs的射击功能。</p>
 <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Space))</span><br><span class="line">    &#123;</span><br><span class="line">        Fire();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Fire</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">//Create the bullet from the prefab</span></span><br><span class="line">    GameObject bullet = (GameObject)Instantiate(mBulletPrefab, mBulletSpawn.position, mBulletSpawn.rotation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Add velocity to the bullet</span></span><br><span class="line">    bullet.GetComponent&lt;Rigidbody&gt;().velocity = bullet.transform.forward * mBulletSpeed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Destroy the bullet after 2 seconds</span></span><br><span class="line">    Destroy(bullet, <span class="number">2.0</span>f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 然后发布联机测试：<br> <img src="/img/Unity/MultiplayerNetworkingWithBullet.PNG" alt="MultiplayerNetworkingWithBullet"><br> 从上面可以看到Bullet并没有同步显示到Server端，这是因为我们的Bullet并没有挂载NetworkIdentity脚本用于标识Server和Client对象，不具备在client在server之间信息同步的能力。并且也没有挂载NetworkTransform去同步位置数据。</p>
</li>
<li><p>Adding Multiplayer Shooting<br>那么通过上面的分析，要想Bullet具备网络数据同步功能，我们需要做如下几件事：</p>
<ol>
<li>Add NetworkIdentity到Bullet上(用于标识Server和Client对象，使其具备在server上执行commands能力)</li>
<li>Add NetworkTransform到Bullet上(用于同步位置信息)</li>
<li>设置Network Send Rate to 0(因为Bullet不会改变方向和速度，是通过物理驱动，所以不用同步位置信息每个Client也能计算出来)</li>
<li>添加Bullet Prefab作为Network Manager Spawnable的对象<br><img src="/img/Unity/SpawnableBullet.PNG" alt="SpawnableBullet"></li>
<li>修改PlayerController,通过CMD去Spawn Bullet<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Networking;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerController</span> : <span class="title">NetworkBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> mRotateSpeed = <span class="number">150.0</span>f;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> mMoveSpeed = <span class="number">3.0</span>f;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mBulletPrefab;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Transform mBulletSpawn;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> mBulletSpeed = <span class="number">6.0</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isLocalPlayer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> x = Input.GetAxis(<span class="string">"Horizontal"</span>) * Time.deltaTime * mRotateSpeed;</span><br><span class="line">        <span class="keyword">var</span> z = Input.GetAxis(<span class="string">"Vertical"</span>) * Time.deltaTime * mMoveSpeed;</span><br><span class="line"></span><br><span class="line">        transform.Rotate(<span class="number">0</span>, x, <span class="number">0</span>);</span><br><span class="line">        transform.Translate(<span class="number">0</span>, <span class="number">0</span>, z);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Space))</span><br><span class="line">        &#123;</span><br><span class="line">            CmdFire();</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    [Command]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CmdFire</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">//Create the bullet from the prefab</span></span><br><span class="line">        GameObject bullet = (GameObject)Instantiate(mBulletPrefab, mBulletSpawn.position, mBulletSpawn.rotation);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Add velocity to the bullet</span></span><br><span class="line">        bullet.GetComponent&lt;Rigidbody&gt;().velocity = bullet.transform.forward * mBulletSpeed;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Spawn the bullet on the clients</span></span><br><span class="line">        NetworkServer.Spawn(bullet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Destroy the bullet after 2 seconds</span></span><br><span class="line">        Destroy(bullet, <span class="number">2.0</span>f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStartLocalPlayer</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">base</span>.OnStartLocalPlayer();</span><br><span class="line">        GetComponent&lt;MeshRenderer&gt;().material.color = Color.blue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="/img/Unity/MultiplayerNetworkingWithBulletSyn.PNG" alt="MultiplayerNetworkingWithBulletSyn"><br>为了使Bullet真正在多个Client之间同步，下面需要理解几个概念：</p>
<ol>
<li>Remote Actions<br>先来看看Remote Actions的调用框架：<br><img src="/img/Unity/RemoteActions.PNG" alt="RemoteActions"><br>Remote Actions分为：<br>Commands - which are called from the client and run on the server(client调用，server执行)<br>ClientRpc calls - which are called on the server and run on clients.(server调用，client执行)<br>这里我们看一下Commands，前面我们提到过通过isLocalPlayer区分Local Player的控制等操作。<br>除了通过isLocalPlayer我们还是通过Command attribute来实现。(NetworkManager在Server端创建的包含NetworkIdentity的Player Object可以通过commands的形式从client端调用server端方法)<br><a href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/adding-multiplayer-shooting?playlist=29690" target="_blank" rel="external">The [Command] attribute indicates that the following function will be called by the Client, but will be run on the Server.</a><br><a href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/adding-multiplayer-shooting?playlist=29690" target="_blank" rel="external">When making a networked command, the function name must begin with “Cmd”.</a><br>Command方法必须以Cmd开头。<br><a href="https://docs.unity3d.com/Manual/UNetActions.html?_ga=1.55901730.827985704.1454244920" target="_blank" rel="external">Commands are sent from player objects on the client to player objects on the server. Commands can only be sent from YOUR player object, so you cannot control the objects of other players.</a><br>Commands只能从Local Player Object发送到Server端Player对应的Obejct，所以不能控制其他Player Obejct，这也就是为什么不用区分isLocalPlayer也能确保在Client端只影响Local Player Object的原因(但在Server端需要区分，不然Host点击Space会导致所有的Client都发射子弹)</li>
<li>Object Spawning<br><a href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/adding-multiplayer-shooting?playlist=29690" target="_blank" rel="external">In the Multiplayer Networking HLAPI “Spawn” means more than just “Instantiate”. It means to create a GameObject on the Server and on all of the Clients connected to the Server. The GameObject will then be managed by the spawning system; state updates are sent to Clients when the object changes on the Server.</a><br>可以看出Multiplayer Networking的Object Spawn是针对Server和所有Clients而言的，需要在Server上创建该GameObject然后同步到所有连接的Clients上，Server管理了所有的需要同步的状态信息。<br>比如有2个Player，那么创建结构如下：<br><img src="/img/Unity/PlayerSpawning.PNG" alt="PlayerSpawning"><br>Object和Player Objects Creation的完整流程<a href="https://docs.unity3d.com/Manual/UNetSpawning.html?_ga=1.100989192.827985704.1454244920" target="_blank" rel="external">参考官网</a></li>
</ol>
</li>
<li><p>Player Health(Single Player)<br>增加Bullet的碰撞逻辑，编写Bullet Script。(这里遇到了Bullet脚本无效，重新制作Bullet prefab后又可以了)<br>Bullet.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Bullet</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mDamage = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCollisionEnter</span>(<span class="params">Collision collision</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        GameObject hit = collision.gameObject;</span><br><span class="line">        Health health = hit.GetComponent&lt;Health&gt;();</span><br><span class="line">        <span class="keyword">if</span>(health != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            health.TakeDamage(mDamage);</span><br><span class="line">        &#125;</span><br><span class="line">        Destroy(gameObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来Health逻辑代码。<br>Health.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Health</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">int</span> mMaxHealth = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RectTransform mHealthBar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span>(<span class="params"><span class="keyword">int</span> amount</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mCurrentHealth -= amount;</span><br><span class="line">        <span class="keyword">if</span>(mCurrentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCurrentHealth = <span class="number">0</span>;</span><br><span class="line">            Debug.Log(<span class="string">"Dead!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mHealthBar.sizeDelta = <span class="keyword">new</span> Vector2(mCurrentHealth, mHealthBar.sizeDelta.y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>血条可视化HealthBar制作。<br>用3D UI的Image来制作血条。<br><img src="/img/Unity/PlayerWithHealthBarHierachycal.PNG" alt="PlayerWithHealthBarHierachycal"><br>动态修改HealthBar的Forground的Rect来显示当前血量。<br><img src="/img/Unity/PlayerGameObjectWithHealthBar.PNG" alt="PlayerGameObjectWithHealthBar"><br><img src="/img/Unity/HealthScriptInEditor.PNG" alt="HealthScriptInEditor"><br>添加Billboard脚本(挂载到HealthBarCanva上)，确保血条始终面向Camera。<br>Billboard.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Billboard</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        transform.LookAt(Camera.main.transform);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试效果：<br><img src="/img/Unity/MultiplayerNetworkingWithHealthBar.PNG" alt="MultiplayerNetworkingWithHealthBar"><br>可以看到血条更新了但是，血条在Server和Client端并不一致，这是因为Bullet和Health脚本是工作在Local的并没有通过网络同步数据。</p>
</li>
<li><p>Networking Player Health<br><a href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/networking-player-health?playlist=29690" target="_blank" rel="external">Changes to the player’s current health should only be applied on the Server. These changes are then synchronized on the Clients. This is called Server Authority.</a><br>改变Player血量应该是在Server端修改，然后再同步到Client端。(这叫做Server Authority)<br>先了解一个概念<a href="https://docs.unity3d.com/Manual/UNetStateSync.html?_ga=1.102101512.827985704.1454244920" target="_blank" rel="external">State Synchronization</a><br><a href="https://docs.unity3d.com/Manual/UNetStateSync.html?_ga=1.102101512.827985704.1454244920" target="_blank" rel="external">State Synchronization is done from the Server to Remote Clients.</a><br>还记得之前讲到的Remote Action里的ClientRpc calls吗?<br>Which are called on the server and run on clients.(server调用，client执行)<br>ClientRpc calls用于同步Server端控制的数据。(Commands用于同步Client端控制的数据，比如前面我们用Commands同步子弹发射。)<br>[SyncVars]标记的成员变量就是用于把server端控制的数据同步到client端<br><a href="https://docs.unity3d.com/Manual/UNetStateSync.html?_ga=1.102101512.827985704.1454244920" target="_blank" rel="external">SyncLists are like SyncVars but they are lists of values instead of individual values.SyncLists do not require the SyncVar attributes.</a>(SyncLists相当于List &lt; SyncVars &gt; ,SyncLists不需要[SyncVar]关键词)<br>我们可以通过重写NetworkBehaviour的OnSerialize和OnDeSerialize函数去自定义序列化行为。<br><a href="https://docs.unity3d.com/Manual/UNetStateSync.html?_ga=1.102101512.827985704.1454244920" target="_blank" rel="external">Serialization Flow on server and client详情参考</a><br>这里需要用到SyncVars来标记我们的mCurrentHealth值并且通过isServer来使TakeDamage只在Server上起作用(因为是作为Server端控制的数据)：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Health</span> : <span class="title">NetworkBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">int</span> mMaxHealth = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    [SyncVar]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RectTransform mHealthBar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span>(<span class="params"><span class="keyword">int</span> amount</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isServer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/SyncHealthBarOnlyOnServer.PNG" alt="SyncHealthBarOnlyOnServer"><br>但从上面可以看出只有Server端的血条更新，虽然Client端的值显示变化了但是血条UI却没有变化，这是因为我们指同步了mCurrentHealth数据但没有同步HealthBar Foreground的Rect。<br>这里需要介绍SyncVar hook. <a href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/networking-player-health?playlist=29690" target="_blank" rel="external">SyncVar hooks will link a function to the SyncVar. These functions are invoked on the Server and all Clients when the value of the SyncVar changes.</a>当SyncVa变化的时候SyncVar Hooks关联的方法会在Server和所有Clients里调用。(用于更新Server和Client的一些相关数据，这里我们是为了更新HealthBar Foreground的Rect)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Health</span> : <span class="title">NetworkBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">int</span> mMaxHealth = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    [SyncVar(hook = <span class="string">"OnChangeHealth"</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RectTransform mHealthBar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span>(<span class="params"><span class="keyword">int</span> amount</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnChangeHealth</span>(<span class="params"><span class="keyword">int</span> currenthealth</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mHealthBar.sizeDelta = <span class="keyword">new</span> Vector2(currenthealth, mHealthBar.sizeDelta.y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次测试效果：<br><img src="/img/Unity/SyncHealthBarAndValue.PNG" alt="SyncHealthBarAndValue"><br>终于成功的同步了mCurrentHealth数据和HealthBar Forground的Rect数据。</p>
</li>
<li><p>Death And Respawning<br>ClientRpc在这里正式出场(用于同步Server端控制的数据)。<br><a href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/death-and-respawning?playlist=29690" target="_blank" rel="external">ClientRpc calls can be sent from any spawned object on the Server with a NetworkIdentity. Even though this function is called on the Server, it will be executed on the Clients.</a><br>ClientRpc修饰的方法在Server端调用，但会在Client端执行。([ClientRpc]修饰的方法需要加Rpc前缀)<br>这里我们为了使Player在血量为零后Respawn，我们需要添加[ClientRpc]修饰的Respawn方法到Health脚本中。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Health</span> : <span class="title">NetworkBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">int</span> mMaxHealth = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    [SyncVar(hook = <span class="string">"OnChangeHealth"</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RectTransform mHealthBar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span>(<span class="params"><span class="keyword">int</span> amount</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isServer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCurrentHealth -= amount;</span><br><span class="line">        <span class="keyword">if</span>(mCurrentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">            RpcRespawn();</span><br><span class="line"></span><br><span class="line">            Debug.Log(<span class="string">"Dead!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnChangeHealth</span>(<span class="params"><span class="keyword">int</span> currenthealth</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mHealthBar.sizeDelta = <span class="keyword">new</span> Vector2(currenthealth, mHealthBar.sizeDelta.y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [ClientRpc]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RpcRespawn</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">    	<span class="comment">//这里不知道为什么要加这个判断，按理只有对应的Client才会调用此方法</span></span><br><span class="line">        <span class="keyword">if</span>(isLocalPlayer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//move back to zero location</span></span><br><span class="line">            transform.position = Vector3.zero;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试效果：<br><img src="/img/Unity/RespawnPlayer.PNG" alt="RespawnPlayer"><br>可以看到我们成功把生命值归零的Client重置到了原点处。</p>
</li>
<li><p>Handling Non-Player Obejcts<br>Enemy属于non-player，属于Server端控制的对象。<br>所以在设置NetworkIdentity的时候，勾选Server Only(<a href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/handling-non-player-objects?playlist=29690" target="_blank" rel="external">By setting Server Only to true, this prevents the Enemy Spawner from being sent to the Clients.</a>)<br><img src="/img/Unity/ServerOnly.PNG" alt="ServerOnly"><br>添加Enemy Spawn的功能。<br>EnemySpawner.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Networking;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemySpawner</span> :  <span class="title">NetworkBehaviour</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mEnemyPrefab;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mNumberOfEnemies;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStartServer</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">base</span>.OnStartServer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mNumberOfEnemies; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 spawnposition = <span class="keyword">new</span> Vector3(</span><br><span class="line">                                                Random.Range(-<span class="number">8.0</span>f, <span class="number">8.0</span>f),</span><br><span class="line">                                                <span class="number">0.0</span>f,</span><br><span class="line">                                                Random.Range(-<span class="number">8.0</span>f, <span class="number">8.0</span>f));</span><br><span class="line"></span><br><span class="line">            Quaternion spawnrotation =  Quaternion.Euler(</span><br><span class="line">                                                        <span class="number">0.0</span>f,</span><br><span class="line">                                                        Random.Range(<span class="number">0</span>, <span class="number">180</span>),</span><br><span class="line">                                                        <span class="number">0.0</span>f);</span><br><span class="line"></span><br><span class="line">            GameObject enemy = (GameObject)Instantiate(mEnemyPrefab,spawnposition, spawnrotation);</span><br><span class="line">            NetworkServer.Spawn(enemy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/handling-non-player-objects?playlist=29690" target="_blank" rel="external">OnStartServer is called on the Server when the Server starts listening to the Network</a><br>OnStartServer在Server端启动的时候调用，这里用来初始化敌人。<br>在Player Prefab基础上制作EnemyPrefab。<br><img src="/img/Unity/EnemyPrefab.PNG" alt="EnemyPrefab"><br>添加EnemyPrefab到NetworkManager的Spawnable List里。<br><img src="/img/Unity/EnemySpawnableList.PNG" alt="EnemySpawnableList"><br>设置EnemySpawner。<br><img src="/img/Unity/EnemySpawner.PNG" alt="EnemySpawner"><br>测试效果：<br><img src="/img/Unity/MultiplayerNetworkingWithEnemy.PNG" alt="MultiplayerNetworkingWithEnemy"><br>成功创建了Server管理的Enemy。</p>
</li>
<li><p>Destroying Enemies<br>因为Enemy Prefab采用的是Player的Health设定，所以生命值归零时会重置到原点，这并非我们想要的，我们需要Enemy被打死后被摧毁掉。<br>这里需要修改Health脚本去做判断。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Health</span> : <span class="title">NetworkBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span>(<span class="params"><span class="keyword">int</span> amount</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isServer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCurrentHealth -= amount;</span><br><span class="line">        <span class="keyword">if</span>(mCurrentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mDestroyOnDeath)</span><br><span class="line">            &#123;</span><br><span class="line">                Destroy(gameObject);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">                RpcRespawn();</span><br><span class="line">            &#125;</span><br><span class="line">            Debug.Log(<span class="string">"Dead!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Enemy Prefab上勾选mDestroyOnDeath。<br>再次测试：<br><img src="/img/Unity/DestroyEnemyWhenEnemyDead.PNG" alt="DestroyEnemyWhenEnemyDead"><br>成功摧毁Enemy。</p>
</li>
<li>Spawning And Respawning<br>随机Spawn到不同的位置。<br>The NetworkStartPosition component可以用于spawn object到不同的位置。<br>在场景里创建Gameobject添加NetworkStartPosition并设定位置。<br>NetworkManager会自动去找到这些带有NetworkStartPosition component的Gameobject，把他们的位置作为Start Position的选项。(Round Robin Player Spawn Method on the Network Manager)<br>Spawn和Respawn等内容详情参考<a href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/spawning-and-respawning?playlist=29690" target="_blank" rel="external">Spawning and Respawning</a><br>Multiplayer Networking教程学习终于结束了。但初次接触Unity Networking的学习，还有很多地方理解错误的地方，欢迎纠正。</li>
</ol>
<h1 id="编辑器界面">编辑器界面</h1><ol>
<li><p><strong>Hierachy</strong><br>游戏组成元素(这个tutorial里，好比小球，方块，地面，摄像机，灯光，墙等)<br>主要用于对物件的归类管理</p>
<ol>
<li>Create Empty可以用于层次管理归类</li>
</ol>
</li>
<li><p><strong>Project</strong><br>游戏原件管理（这个tutorial里，好比材质，C#脚本）<br>主要用于对一次性资源的归类管理</p>
<ol>
<li>可通过创建Folder进行资源整理归类</li>
</ol>
</li>
<li><p><strong>Scene</strong><br>编辑场景</p>
<ol>
<li>右上角可以切换视角</li>
<li>可以切换Local和Global模式进行移动物体</li>
</ol>
</li>
<li><p><strong>Game</strong><br>运行时场景（可动态编辑查看物体属性）</p>
</li>
<li><p><strong>Inspector</strong><br>对象属性查看</p>
<ol>
<li>通过物体名字左边的Active勾选框可以决定物体是否在编辑器可见可选</li>
<li>可以通过点击界面的？来打开相应面板的介绍页面</li>
</ol>
</li>
</ol>
<h1 id="工具">工具</h1><h2 id="MonoDevelop">MonoDevelop</h2><p>C#,Js脚本编辑器(也可自己设定编辑器为VS  Edit-&gt;Preference-&gt;External Tools-&gt;External Script Editor)</p>
<h2 id="ILSpy">ILSpy</h2><p><a href="http://ilspy.net/" target="_blank" rel="external">ILSpy is the open-source .NET assembly browser and decompiler.</a><br>可以用于反编译一些Unity项目学习源代码</p>
<h2 id="ildasm(安装VS自带的工具)">ildasm(安装VS自带的工具)</h2><p>IL反编译工具<br>可以通过这个工具查看编译生成的IL中间代码</p>
<h2 id="Blender">Blender</h2><p><a href="https://en.wikipedia.org/wiki/Blender_software" target="_blank" rel="external">Blender is a professional free and open-source 3D computer graphics software product used for creating animated films, visual effects, art, 3D printed models, interactive 3D applications and video games.</a><br>主要用于制作一些3D模型和动画然后到处FBX用于Unity</p>
<h2 id="VSTU">VSTU</h2><p>工具原名UnityVS，由于微软收购了SyntaxTree(制作UnityVS的公司)的公司，微软将UnityVS置入了VS开发套件中。<br>VSTU(Visual Studio Tools For Unity)<br>使Visual Studio支持Unity开发。<br>好处：</p>
<ol>
<li>构建多平台游戏</li>
<li>在Visual Studio中调试</li>
<li>在Visual Studio创建Unity脚本</li>
<li>使用Visual Studio提高工作效率(e.g. 智能提示，高亮，快速查询Unity API，快速查询或插入Unity方法等)</li>
<li>免费获取开发Unity所需的全部内容<br>既然能让我们继续使用熟悉的VS作为开发IDE，那么让我们看看怎么集成安装吧。<br><a href="https://msdn.microsoft.com/en-us/library/dn940025.aspx" target="_blank" rel="external">Unity version 4.0.0 or higher; Unity version 5.2.0 or higher to take advantage of built-in support for Visual Studio Tools for Unity version 2.1 or higher.</a><br>注意Unity 5.2.0及以上版本已经内置支持VSTU了。<br>这里讲讲老版本需要如何安装继承VSTU:</li>
<li><a href="https://msdn.microsoft.com/en-us/library/dn940025.aspx" target="_blank" rel="external">下载对应版本的VSTU</a></li>
<li>导入VSTU到Unity(Assets -&gt; Import Package -&gt; Visual Studio 20** Tools)</li>
<li>设置Unity debug开发环境(File -&gt; Building Setting 下勾选Development Build和Script Debugging)</li>
<li>设定VS 20<strong>作为默认IDE(Edit -&gt; Preference -&gt; External Tools -&gt; External Script Editor设置成VS 20</strong>)</li>
<li><a href="https://msdn.microsoft.com/en-us/library/dn940020.aspx#debugging-your-project-in-a-unity-player" target="_blank" rel="external">支持调试managed dll</a></li>
</ol>
<p>这里使用VSTU有几个快捷和帮助快速开发的小技巧：</p>
<ol>
<li>Ctrl+Shift+M(显示可定义的Monobehavior方法，并帮助自动生成方法定义)</li>
<li>Ctrl+Shift+Q(熟悉了Unity API后，这个可以快速检索方法并生成方法定义)</li>
<li>Alt+Shift+E(查看Unity项目目录结构文件)</li>
<li>F5快速调试Unity Code(首先需要设定Unity debug环境(前面提到过)，然后需要通过Debug -&gt; Attach Unity Debugger(Attach到Unity进程上，最后运行Unity即可))</li>
<li>Unity的错误，警告等信息显示在VS的error list里</li>
</ol>
<h1 id="相关概念学习">相关概念学习</h1><h2 id="Unity_Engine">Unity Engine</h2><p><a href="http://inpla.net/thread-8197-1-1.html" target="_blank" rel="external">参考文章</a></p>
<h3 id="C_Sharp">C Sharp</h3><p>Unity支持C#的作为编程语言，这里不得不了解下C#的历史。<br><a href="https://zh.wikipedia.org/wiki/C%E2%99%AF" target="_blank" rel="external">C#是微软推出的一种基于.NET框架的、面向对象的高级编程语言。C#的发音为“C sharp”，模仿音乐上的音名“C♯”（C调升），是C语言的升级的意思。其正确写法应和音名一样为“C♯”[来源请求]，但大多数情况下“♯”符号被井号“#”所混用；两者差别是：“♯”的笔画是上下偏斜的，而“#”的笔画是左右偏斜。C♯由C语言和C++派生而来，继承了其强大的性能，同时又以.NET框架类库作为基础，拥有类似Visual Basic的快速开发能力。C#由安德斯·海尔斯伯格主持开发，微软在2000年发布了这种语言。</a><br><a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/">相关C#学习</a></p>
<h3 id="Mono">Mono</h3><p><a href="http://inpla.net/thread-8197-1-1.html" target="_blank" rel="external">C#虽好，但是只能在Windows上运行，微软那时候也没有将其开源，所以总是会有人说不能跨平台，光就这点，C#和Java就不能比呀。微软公司已经向ECMA申请将C#作为一种标准。在2001年12月，ECMA发布了ECMA-334 C#语言规范。C#在2003年成为一个ISO标准（ISO/IEC 23270）。这意味着只要你遵守CLI（Common Language Infrastructure），第三方可以将任何一种语言实现到.Net平台之上。Mono就是在这种环境下诞生的。Mono是一个由Xamarin公司（先前是Novell,最早为Ximian）所主持的自由开放源代码项目。该项目的目标是创建一系列符合ECMA标准（Ecma-334和Ecma-335）的.NET工具，包括C#编译器和通用语言架构。与微软的.NET Framework（共通语言运行平台）不同，Mono项目不仅可以运行于Windows系统上，还可以运行于Linux，FreeBSD，Unix，OS X和Solaris，甚至一些游戏平台，例如：Playstation 3，Wii或XBox 360之上。Mono使得C#这门语言有了很好的跨平台能力。相对于微软的.Net Framework运行时库Mono使用自己的Mono VM作为运行时库。</a></p>
<h3 id="IL2CPP">IL2CPP</h3><p>既然Mono这么好，那么为什么还需要IL2CPP了？</p>
<h4 id="Why_do_we_need_IL2CPP?">Why do we need IL2CPP?</h4><ol>
<li>C# runtime performance still lags behind C/C++(C#运行效率没有C/C++好)</li>
<li>Latest and greatest .NET language and runtime features are not supported in Unity’s current version of Mono.(新版本的.Net语言和运行时特性没有被当前的Unity版本支持)</li>
<li>With around 23 platforms and architecture permutations, a large amount of effort is required for porting, maintaining, and offering feature and quality parity.(Mono VM在跨平台的维护上很费时费力)</li>
<li>Garbage collection can cause pauses while running(Mono VM现有的GC很容易使得游戏卡顿)</li>
</ol>
<h4 id="IL2CPP_Components">IL2CPP Components</h4><ol>
<li>AOT(Ahead of Time) compiler<br><a href="https://en.wikipedia.org/wiki/Ahead-of-time_compilation" target="_blank" rel="external">Ahead-of-time (AOT) compilation is the act of compiling a high-level programming language such as C or C++, or an intermediate language such as Java bytecode or .NET Common Intermediate Language (CIL) code, into a native (system-dependent) machine code with the intention of executing the resulting binary file natively.</a>(预编译IL到系统相关的机器代码。 C# -&gt; IL -&gt; C++ -&gt; Machine code)</li>
<li>IL2CPP Virtual Machine<br>Provide additional services (like a GC, metadata, platform specific resources)(提供运行时的一些功能比如GC,访问平台相关资源等)</li>
</ol>
<h4 id="Mono_and_IL2CPP_compile_and_execution_process">Mono and IL2CPP compile and execution process</h4><p>我们来看看使用Mono和使用IL2CPP时的脚本编译运行过程：<br><a href="http://inpla.net/thread-8197-1-1.html" target="_blank" rel="external">下面两张图来源</a><br>Mono:<br><img src="/img/Unity/Mono.png" alt="Mono"></p>
<p>IL2CPP:<br><img src="/img/Unity/IL2CPP.png" alt="IL2CPP"><br>从上图可以看出编译成IL后，会被IL2CPP再次编译成C++，然后通过Native的C++编译器编译C++代码到相关平台的汇编代码，最后运行在IL2CPP VM里。<br>这样做的好处官网提到了下几点：</p>
<ol>
<li><p>Performance(效率上的优化)，原因如下<br> . C++ compilers and linkers provide a vast array of advanced optimisations previously unavailable.<br> . Static analysis is performed on your code for optimisation of both size and speed.<br> . Unity-focused optimisations to the scripting runtime.</p>
</li>
<li><p>All code generation is done to C++ rather than architecture specific machine code. The cost of porting and maintenance of architecture specific code generation is now more amortised. (因为现在是通过利用现有的C++编译器编译C++而没有直接编译成特定架构的机器代码，这样一来跨平台的移植和维护责任就更分散了)</p>
</li>
<li><p>Feature development and bug fixing proceed much faster. For us, days of mucking in architecture specific files are replaced by minutes of changing C++. Features and bug fixes are immediately available for all platforms. (功能开发和bug修改更容易快捷。通过修改IL2CPP的C++生成就能快速的针对多个平台有效)</p>
</li>
<li><p>IL2CPP is not tied to any one specific garbage collector, instead interacting with a pluggable API(GC导致游戏卡顿的现象也可以通过不同的GC方式来改善)</p>
</li>
</ol>
<p>Note:<br>IL2CPP支持了arm64机器架构(Mono不支持, Apple新出的设备大多基于arm64)</p>
<h3 id="AOT_&amp;_JIT">AOT &amp; JIT</h3><p>之前有讲到过AOT和JIT，那么这里为什么还要再次提他了？<br>主要原因是在IOS平台开发中，Mono .NET只支持AOT(Ahead of Time预编译生成所有对应机器代码)，而不是通过JIT在运行时去编译成对应的机器代码。在IOS上采用full-AOT模式。<br>在这一限制下，我们必须明白什么是AOT什么是JIT，并且要知道哪些特性会使用到JIT导致IOS不支持。</p>
<h4 id="AOT">AOT</h4><p><a href="https://en.wikipedia.org/wiki/Ahead-of-time_compilation" target="_blank" rel="external">AOT详细介绍</a><br>AOT大概意思就是预编译所有的IL到系统相关的机器代码。 C# -&gt; IL -&gt; C++ -&gt; Machine code</p>
<h4 id="JIT">JIT</h4><p>JIT:<br>在<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Executing_Assembly_Code">C# Study</a>中有讲到JIT是在执行Assembly Code(也就是C#编译的CIL中间程序)运行时编译成本地机器代码。<br>Full-AOT模式可以看出Mono .NET在IOS上不支持动态生成代码。<br>那么具体哪些特性不被IOS支持，哪些用法会触发动态生成代码了？</p>
<h4 id="IOS_AOT_Limitations">IOS AOT Limitations</h4><p><a href="https://developer.xamarin.com/guides/ios/advanced_topics/limitations/#.NET.c2.a0API.c2.a0Limitations" target="_blank" rel="external">IOS AOT limitations</a></p>
<ol>
<li>Profiler</li>
<li>Reflection.Emit</li>
<li>Reflection.Emit.Save functionality</li>
<li>COM bindings</li>
<li>The JIT engine</li>
<li>Metadata verifier (since there is no JIT)</li>
</ol>
<p>在这里我从官网提取几个典型问题来说明：</p>
<ol>
<li><p>P/Invokes in Generic Types<br>P/Invokes in generic classes aren’t supported:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class GenericType&lt;T&gt; &#123;</span><br><span class="line">    [DllImport ("System")]</span><br><span class="line">    public static extern int getpid ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 不支持对泛型类的P/Invoke</p>
</li>
<li><p>Value types as Dictionary Keys<br>值类型作为Dictionary的Key时会有问题，实际上实现了IEquatable<t>的类型都会有此问题，因为Dictionary的默认构造函数会使用EqualityComparer<tkey>.Default作为比较器，而对于实现了IEquatable<t>的类型，EqualityComparer<tkey>.Default要通过反射来实例化一个实现了IEqualityComparer<tkey>的类（可以参考EqualityComparer<t>的实现）。 解决方案是自己实现一个IEqualityComparer<tkey>，然后使用Dictionary<tkey, tvalue="">(IEqualityComparer<tkey>)构造器创建Dictionary实例。<br>讲到如果T实现了IEquatable<t>，那么就会反射实例化一个实现了IEqualityCompareer<tkey>的类，这里通过查看EqaulityCompare<t>源码可以看到确实如此。</t></tkey></t></tkey></tkey,></tkey></t></tkey></tkey></t></tkey></t></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public abstract class EqualityComparer&lt;t&gt; : IEqualityComparer, IEqualityComparer&lt;t&gt; </span><br><span class="line">&#123;</span><br><span class="line">    static EqualityComparer&lt;t&gt; defaultComparer; </span><br><span class="line"></span><br><span class="line">    public static EqualityComparer&lt;t&gt; Default &#123;</span><br><span class="line">        [System.Security.SecuritySafeCritical]  // auto-generated </span><br><span class="line">#if !FEATURE_CORECLR</span><br><span class="line">        [TargetedPatchingOptOut("Performance critical to inline across NGen image boundaries")]</span><br><span class="line">#endif</span><br><span class="line">        get &#123; </span><br><span class="line">            Contract.Ensures(Contract.Result&lt;equalitycomparer&lt;t&gt;&gt;() != null);</span><br><span class="line"></span><br><span class="line">            EqualityComparer&lt;t&gt; comparer = defaultComparer; </span><br><span class="line">            if (comparer == null) &#123;</span><br><span class="line">                comparer = CreateComparer(); </span><br><span class="line">                defaultComparer = comparer;</span><br><span class="line">            &#125;</span><br><span class="line">            return comparer;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [System.Security.SecuritySafeCritical]  // auto-generated </span><br><span class="line">    private static EqualityComparer&lt;t&gt; CreateComparer() &#123;</span><br><span class="line">        Contract.Ensures(Contract.Result&lt;equalitycomparer&lt;t&gt;&gt;() != null); </span><br><span class="line"></span><br><span class="line">        RuntimeType t = (RuntimeType)typeof(T);</span><br><span class="line">        // Specialize type byte for performance reasons</span><br><span class="line">        if (t == typeof(byte)) &#123; </span><br><span class="line">            return (EqualityComparer&lt;t&gt;)(object)(new ByteEqualityComparer());</span><br><span class="line">        &#125; </span><br><span class="line">        // If T implements IEquatable&lt;t&gt; return a GenericEqualityComparer&lt;t&gt; </span><br><span class="line">        if (typeof(IEquatable&lt;t&gt;).IsAssignableFrom(t)) &#123;</span><br><span class="line">            //return (EqualityComparer&lt;t&gt;)Activator.CreateInstance(typeof(GenericEqualityComparer&lt;&gt;).MakeGenericType(t)); </span><br><span class="line">            return (EqualityComparer&lt;t&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(GenericEqualityComparer&lt;int&gt;), t);</span><br><span class="line">        &#125;</span><br><span class="line">        // If T is a Nullable&lt;u&gt; where U implements IEquatable&lt;u&gt; return a NullableEqualityComparer&lt;u&gt;</span><br><span class="line">        if (t.IsGenericType &amp;&amp; t.GetGenericTypeDefinition() == typeof(Nullable&lt;&gt;)) &#123; </span><br><span class="line">            RuntimeType u = (RuntimeType)t.GetGenericArguments()[0];</span><br><span class="line">            if (typeof(IEquatable&lt;&gt;).MakeGenericType(u).IsAssignableFrom(u)) &#123; </span><br><span class="line">                //return (EqualityComparer&lt;t&gt;)Activator.CreateInstance(typeof(NullableEqualityComparer&lt;&gt;).MakeGenericType(u)); </span><br><span class="line">                return (EqualityComparer&lt;t&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(NullableEqualityComparer&lt;int&gt;), u);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        // If T is an int-based Enum, return an EnumEqualityComparer&lt;t&gt;</span><br><span class="line">        // If you update this check, you need to update the METHOD__JIT_HELPERS__UNSAFE_ENUM_CAST case in getILIntrinsicImplementation</span><br><span class="line">        if (t.IsEnum &amp;&amp; Enum.GetUnderlyingType(t) == typeof(int)) </span><br><span class="line">        &#123;</span><br><span class="line">            return (EqualityComparer&lt;t&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(EnumEqualityComparer&lt;int&gt;), t); </span><br><span class="line">        &#125; </span><br><span class="line">        // Otherwise return an ObjectEqualityComparer&lt;t&gt;</span><br><span class="line">        return new ObjectEqualityComparer&lt;t&gt;(); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 注意下面这个分支</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If T implements IEquatable&lt;t&gt; return a GenericEqualityComparer&lt;t&gt; </span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span>(IEquatable&lt;t&gt;).IsAssignableFrom(t)) &#123;</span><br><span class="line">    <span class="comment">//return (EqualityComparer&lt;t&gt;)Activator.CreateInstance(typeof(GenericEqualityComparer&lt;&gt;).MakeGenericType(t)); </span></span><br><span class="line">    <span class="keyword">return</span> (EqualityComparer&lt;t&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(GenericEqualityComparer&lt;<span class="keyword">int</span>&gt;), t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 当我们的的T也就是我们的Dictionary<tkey,tvalue>里面的TKey实现了IEquatable<t>接口的话，里面的代码实现看不太懂，大概是动态创建实现了IEqualityComparer<tkey>的类，然后实例化返回了一个作为TKey的EqualityComparer。<br> “This works for reference types (as the reflection+create a new type step is skipped)”<br> 当我们传递的TKey是reference types的时候不会触发创建实现了IEqualityCompareer<tkey>的类，直接返回ObjectEqualityComparer<t>()。<br> 解决方案：<br> 如果我们一定要在IOS上把value type作为Dictionary的Key的话，我们需要自己实现一个实现了IEqualityCompareer<tkey>的类，然后作为TKey的EqualityComparer传递给Dictionary<tkey,tvlue>的构造函数。<br> 比如我们要给int添加我们自己的比较方法，那么按如下方式写即可。</tkey,tvlue></tkey></t></tkey></tkey></t></tkey,tvalue></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class ValueTypeComparer : EqualityComparer&lt;int&gt;</span><br><span class="line">&#123;</span><br><span class="line">    public override bool Equals(int a, int b)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine("ValueTypeComparer:Equals() called");</span><br><span class="line">        if (a == b)</span><br><span class="line">        &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override int GetHashCode(int a)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine("ValueTypeComparer:GetHashCode() called");</span><br><span class="line">        return a.GetHashCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Program</span><br><span class="line">&#123;</span><br><span class="line">	static void Main(string[] args)</span><br><span class="line">	&#123;</span><br><span class="line">	    ValueTypeComparer valuetypecomparer = new ValueTypeComparer();</span><br><span class="line">	    int vt1 = 1;</span><br><span class="line">	    Dictionary&lt;int, bool&gt; mydictionary1 = new Dictionary&lt;int, bool&gt;(valuetypecomparer);</span><br><span class="line">	    mydictionary1.Add(vt1, true);</span><br><span class="line">	    mydictionary1.ContainsKey(vt1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <img src="/img/CSharp/ValueTypeComparerForDictionary.PNG" alt="ValueTypeComparerForDictionary"></p>
</li>
<li>System.Reflection.Emit<br><a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit(v=vs.110" target="_blank" rel="external">The System.Reflection.Emit namespace contains classes that allow a compiler or tool to emit metadata and Microsoft intermediate language (MSIL) and optionally generate a PE file on disk.</a>.aspx)<br>可以看出System.Reflection.Emit是用于动态生成代码，这一点明显违背了Full-AOT的原则。<br>在了解Emit是如何动态生成代码之前，可以先了解一下<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Platform_Invoke">AppDomain的概念</a><br>AppDomain负责Assebmly的加载和隔离，代码是加载在AppDomain里执行的。<br>接下来让我们看看System.Reflection.Emit是如何动态生成代码的：<br>先来看下MSDN官网介绍<br><a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit(v=vs.110" target="_blank" rel="external">The System.Reflection.Emit namespace contains classes that allow a compiler or tool to emit metadata and Microsoft intermediate language (MSIL) and optionally generate a PE file on disk.</a>.aspx)</li>
</ol>
<p>可以看出System.Reflection.Emit包含了很多可以动态创建程序集，类，方法的类。<br>以下学习主要参考<a href="http://www.cnblogs.com/hui088/p/4571484.html" target="_blank" rel="external">C#反射发出System.Reflection.Emit学习</a><br>这位博主对Emit研究的很透侧，讲解的也通熟易懂。<br>Emit生成代码的基本流程：</p>
<ol>
<li><p>构建程序集</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AssemblyName aname = <span class="keyword">new</span> AssemblyName(<span class="string">"DynamicgAssembly"</span>);</span><br><span class="line">AssemblyBuilder ab = AppDomain.CurrentDomain.DefineDynamicAssembly(aname, AssemblyBuilderAccess.RunAndSave);</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建模块</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModuleBuilder mb = ab.DefineDynamicModule(aname.Name, aname.Name + <span class="string">".dll"</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义类</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeBuilder tb = mb.DefineType(<span class="string">"DynamicType"</span>, TypeAttributes.Public);</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义类成员(方法，属性等)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 创建方法签名</span></span><br><span class="line">   MethodBuilder methodb = tb.DefineMethod(<span class="string">"Hello"</span>,MethodAttributes.Public);</span><br><span class="line">   <span class="comment">// 定义方法实现</span></span><br><span class="line">   <span class="comment">// 这里比较重要，可以把这里理解成代码反编译之后的函数调用操作的代码化</span></span><br><span class="line">   ILGenerator il = methodb.GetILGenerator();</span><br><span class="line">   <span class="comment">//OpCodes包含所有的Microsoft Intermediate Language (MSIL) instructions </span></span><br><span class="line">	<span class="comment">//OpCodes.Ldstr表示加载一个字符串到evaluation stack。</span></span><br><span class="line">il.Emit(OpCodes.Ldstr, <span class="string">"Hello, World!"</span>);</span><br><span class="line">   <span class="comment">//OpCodes.Call表示调用方法</span></span><br><span class="line">il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Console).GetMethod(<span class="string">"WriteLine"</span>, <span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(<span class="keyword">string</span>) &#125;));</span><br><span class="line">   <span class="comment">//OpCodes.Ret表示返回，当evaluation stack有值时会返回栈顶值。</span></span><br><span class="line">il.Emit(OpCodes.Ret);</span><br><span class="line"></span><br><span class="line">tb.CreateType();</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建Assembly</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab.Save(<span class="string">"DynamicAssemble.dll"</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="/img/CSharp/EmitStudy.PNG" alt="EmitStudy"><br>结合反编译我们生成的DynamicAssemble.dll可以看出，我们是通过Emit把函数定义用IL指令定义出来了。<br>毫无疑问这是动态生成了程序集，方法等，所以在Full-AOT面前，IOS是不支持的。<br>让我们来看个实际的问题：<br><a href="https://docs.unity3d.com/Manual/TroubleShootingIPhone.html" target="_blank" rel="external">The game crashes with the error message “ExecutionEngineException: Attempting to JIT compile method ‘SometType`1<somevaluetype>:.ctor ()’ while running with –aot-only.</somevaluetype></a><br>这里是由于在序列化的时候使用了泛型方法导致的。<br><a href="https://docs.unity3d.com/Manual/TroubleShootingIPhone.html" target="_blank" rel="external">The Mono .NET implementation for iOS is based on AOT. It compiles only those generic type methods (where a value type is used as a generic parameter) which are explicitly used by other code. When such methods are used only via reflection or from native code (ie, the serialization system) then they get skipped during AOT compilation.The AOT compiler can be hinted to include code by adding a dummy method somewhere in the script code. This can refer to the missing methods and so get them compiled ahead of time.</a><br>可以看出在Full-AOT下，如果我们在反射和序列化中使用泛型方法，该方法会被AOT过滤掉，不预编译，要想使该泛型方法参与预编译，我们需要定义一个不使用的方法去显示调用该类去通知AOT去预编译该方法。<br>本人遇到这个问题是：<br>ExecutionEngineException: Attempting to JIT compile method ‘**TypeMetadata:.ctor ()’ while running with –aot-only<br><a href="http://answers.unity3d.com/questions/30930/why-did-my-binaryserialzer-stop-working.html" target="_blank" rel="external">Why did my BinarySerialzer stop working?</a><br>根据上面的说法是BinaryFormatter里的ObjectWriter去动态生成了我们自定义的value type类导致的JIT。<br>通过下面代码可以使ObjectWriter采用反射去实现而非JIT生成动态类。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Environment.SetEnvironmentVariable(<span class="string">"MONO_REFLECTION_SERIALIZER"</span>, <span class="string">"yes"</span>);</span><br></pre></td></tr></table></figure></p>
<p>但是反射很慢，如果频繁进行序列化反序列化的话，在IOS上并不是一种好的解决办法。<br><a href="http://forum.unity3d.com/threads/protobuf-net-unity-is-it-worth-it.288007/" target="_blank" rel="external">根据这里的讨论</a>，可以看出Google Protocol Buffers是一个不错的解决方案(当然我们得绕过默认使用JIT)。</p>
<p>Note:<br>IOS只支持static code, Unlike traditional Mono/.NET, code on the iPhone is statically compiled ahead of time instead of being compiled on demand by a JIT compiler(IOS只支持full aot，不支持JIT).所以有些动态特性没法被Full AOT支持。<br>But the entire Reflection API, including Type.GetType (“someClass”), listing methods, listing properties, fetching attributes and values works just fine.(反射依然在IOS可用)</p>
<h4 id="Protocol_Buffers">Protocol Buffers</h4><p>Protocol Buffers是Google发布出来的开源项目。<br><a href="https://developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="external">Protocol Buffers - a language-neutral, platform-neutral, extensible way of serializing structured data for use in communications protocols, data storage, and more. </a><br>从官网介绍可以看出Google Protocol Buffers(平台无关，语言无关)是针对序列化数据的存储和传输协议等。<br>既然都是用于数据存储，那么Protocol buffers相比传统的二进制和XML序列化有什么优势了？<br>相比XML序列化，Protocol buffers更高效，更灵活，更快，更小，更简单。<br>更方便简单在于 — PB只需定义一次data的数据结构就能自动生成对应语言的解析该数据结构的代码类。<br>更高效更小在于 — XML存储的数据量大，XML在解析的时候，空间开销大，内容多速度慢。(XML的好处 — 具有可读性)<br>更灵活在于 — 只需更新数据结构定义然后编译出对应语言的代码就能无缝衔接以前的版本。<br>既然Protocol buffers这么好，那么让我们看看他是怎么工作的？</p>
<ol>
<li>定义出我们需要序列化的数据结构，保存在.proto文件里。</li>
<li><p>运用Protocol buffer编译器编译出我们对应语言的解析该数据结构的代码类。<br>首先下载对应语言的<a href="https://github.com/google/protobuf/releases/tag/v3.0.0" target="_blank" rel="external">Protocol buffer编译器</a><br>“There are two NuGet packages: Google.Protobuf (the support library) and Google.Protobuf.Tools (containing protoc)”<br>根据上面写的，C#现在貌似有两个版本支持Protocol Buffer，但原生的Protobuf版本支持的.NET版本很高，所以不适合Unity(Unity是基于Mono的，Mono现在对.NET的支持还停留在.NET 2.0和.NET 2.0 subset)。<br>所以通过Google，我找到了以下两个开源项目：</p>
<ol>
<li><a href="https://github.com/jskeet/protobuf-csharp-port" target="_blank" rel="external">Protobuf-csharp-port</a></li>
<li><p><a href="https://github.com/mgravell/protobuf-net" target="_blank" rel="external">Protobuf-net</a><br>前者在Git上的描述不多，所以这里就以下面引用的话来了解两者之间的区别。<br><a href="http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/" target="_blank" rel="external">Protobuf-csharp-port is written by Jon Skeet and is a faithful port of Google’s java implementation that uses similar command-line tooling. You create the data definitions in text-based .proto files and use a code generation tool to create the C# classes.</a><br>Protobuf-csharp-port是由Jon Skeet编写，利用原生工具去port的版本。在编译创建上都沿用了Protocol buffer的原始方式(通过编译.proto文件生成解析定义的Message数据结构的C#代码类)<br><a href="http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/" target="_blank" rel="external">Protobuf-net is written by Marc Gravell and will be more familiar to .Net developers. The implementation uses .Net classes and attributes to define data rather than .proto files. Overall, the code resembles existing .Net serializers such as the DataContractSerializer.</a><br>Protobuf-net是由Marc Gravell编写，支持.NET的类和attributes去定义数据结构，也支持.proto文件预编译生成对应代码类。可以说是.NET风格的Protobuf。<br>同时Github写明了支持：<br>.net 2.0/3.0/3.5/4.0<br>Mono 2.x<br>所以这里就决定使用Protobuf-net作为Unity C#序列化数据的存储和协议传输的库来学习。</p>
<ol>
<li><p>安装Protobuf-net<br>VS -&gt; Tools -&gt; Nuget Package Manager -&gt; Package Manager Console<br>在Package Manager Console窗口输入下列命令就会自动去下载Protobuf-net包并安装了。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package protobuf-net</span><br></pre></td></tr></table></figure>
<p>也可以直接下载<a href="https://code.google.com/archive/p/protobuf-net/downloads" target="_blank" rel="external">Down load link of Protobuf-net</a><br>把Protobuf-net.dll放到Assets/Plugins目录下</p>
</li>
<li>定义可序列化的类<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> ProtoBuf;</span><br><span class="line"></span><br><span class="line">[ProtoContract]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerData</span> &#123;</span><br><span class="line">    [ProtoMember(<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> SceneName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [ProtoMember(<span class="number">2</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Scores</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [ProtoMember(<span class="number">3</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
</li>
<li><p>通过C#(对应语言)protocol buffer API去读写存储的数据。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line"></span><br><span class="line">    mProfilePath =  Application.persistentDataPath + <span class="string">"/PlayerProile.bin"</span>;</span><br><span class="line">    Debug.Log(<span class="string">"mProfilePath = "</span> + mProfilePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SavePlayerData</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">//Do serialization for player data</span></span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Create(mProfilePath);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadPlayerData</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.OpenRead(mProfilePath);</span><br><span class="line">        mPlayerData = Serializer.Deserialize&lt;PlayerData&gt;(profile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line">        mPlayerData.SceneName = Application.productName;</span><br><span class="line">        mPlayerData.Scores = <span class="number">0</span>;</span><br><span class="line">        mPlayerData.SpeedLevel = <span class="number">1</span>;</span><br><span class="line">        SavePlayerData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>但只是这样的话，会报如下错误：<br>NotSupportException： …… System.Reflection.Emit is not supported<br>这里出现了Emit类的使用，显然是用到了动态生成代码，根据我们之前讲到的IOS是在Full-AOT模式下运行不允许动态生成代码的。<br>所以直接使用.NET风格的Attribute会触发动态代码生成，那么我们就需要想办法提前生成，这里就需要使用.proto文件然后通过预编译的方式生成对应的代码类。<br>所以现在我们需要先定义.proto文件(Protobuf-net只支持Proto2)，所以编写<a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="external">proto2参考</a><br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PlayerData.proto</span></span><br><span class="line">syntax = <span class="string">"proto2"</span>;</span><br><span class="line"></span><br><span class="line">package NGUI2DGame;</span><br><span class="line"></span><br><span class="line">message PlayerData&#123;</span><br><span class="line">	optional <span class="keyword">string</span> SceneName = <span class="number">1</span>;</span><br><span class="line">	optional int32 Scores = <span class="number">2</span>;</span><br><span class="line">	optional int32 SpeedLevel = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后通过Protogen.exe帮我们生成对应解析该数据结构所需要的代码类<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protogen -i:PlayerData.proto -o:PlayerData.cs -ns:NGUI2DGame</span><br></pre></td></tr></table></figure></p>
<p>-i是指明输入，这里可以通过-i指定多个输入proto文件。-o是指定输出文件，最终生成的对应信息的代码类。-ns是指定namespace<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">//PlayerData.cs</span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line">// &lt;auto-generated&gt;</span><br><span class="line">//     This code was generated by a tool.</span><br><span class="line">//</span><br><span class="line">//     Changes to this file may cause incorrect behavior and will be lost if</span><br><span class="line">//     the code is regenerated.</span><br><span class="line">// &lt;/auto-generated&gt;</span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">// Generated from: PlayerData.proto</span><br><span class="line">namespace NGUI2DGame</span><br><span class="line">&#123;</span><br><span class="line">  [global::System.Serializable, global::ProtoBuf.ProtoContract(Name=@"PlayerData")]</span><br><span class="line">  public partial class PlayerData : global::ProtoBuf.IExtensible</span><br><span class="line">  &#123;</span><br><span class="line">    public PlayerData() &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    private string _SceneName = "";</span><br><span class="line">    [global::ProtoBuf.ProtoMember(1, IsRequired = false, Name=@"SceneName", DataFormat = global::ProtoBuf.DataFormat.Default)]</span><br><span class="line">    [global::System.ComponentModel.DefaultValue("")]</span><br><span class="line">    public string SceneName</span><br><span class="line">    &#123;</span><br><span class="line">      get &#123; return _SceneName; &#125;</span><br><span class="line">      set &#123; _SceneName = value; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private int _Scores = default(int);</span><br><span class="line">    [global::ProtoBuf.ProtoMember(2, IsRequired = false, Name=@"Scores", DataFormat = global::ProtoBuf.DataFormat.TwosComplement)]</span><br><span class="line">    [global::System.ComponentModel.DefaultValue(default(int))]</span><br><span class="line">    public int Scores</span><br><span class="line">    &#123;</span><br><span class="line">      get &#123; return _Scores; &#125;</span><br><span class="line">      set &#123; _Scores = value; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private int _SpeedLevel = default(int);</span><br><span class="line">    [global::ProtoBuf.ProtoMember(3, IsRequired = false, Name=@"SpeedLevel", DataFormat = global::ProtoBuf.DataFormat.TwosComplement)]</span><br><span class="line">    [global::System.ComponentModel.DefaultValue(default(int))]</span><br><span class="line">    public int SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">      get &#123; return _SpeedLevel; &#125;</span><br><span class="line">      set &#123; _SpeedLevel = value; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private global::ProtoBuf.IExtension extensionObject;</span><br><span class="line">    global::ProtoBuf.IExtension global::ProtoBuf.IExtensible.GetExtensionObject(bool createIfMissing)</span><br><span class="line">      &#123; return global::ProtoBuf.Extensible.GetExtensionObject(ref extensionObject, createIfMissing); &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来把我们生成的代码通过VS编译成DLL</p>
<ol>
<li>新建C# Library工程</li>
<li>删掉原始cs添加刚才生成的PlayerData.cs</li>
<li>添加Protobuf-net库引用(用CoreOnly/ios/protobuf-net.dll)</li>
<li>编译出dll<br>最后我们需要通过上一步生成的信息类dll来编译出专门序列化该信息的类库。(添加precompile.exe的路径到环境变量确保找得到，这里要注意的是dll项目的.NET target设置成2.0，因为Unity Mono现在只支持到2.0)<br>在之前生成的PlayerData.dll目录下执行下列命令：<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">precompile PlayerData.dll -o:ProtobufSerializer.dll -t:com.TonyTang.ProtobufSerializer</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>-o指明输出文件 -t指明生成的序列化类的类名<br>最后利用生成的PlayerData.dll和ProtobufSerializer.dll到Unity里进行测试，编写对应代码即可，写法和之前的区别就是用我们生成好的类来完成序列化和反序列化。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Serialization</span></span><br><span class="line">ProtobufSerializer serializer = <span class="keyword">new</span> ProtobufSerializer();       </span><br><span class="line">profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">serializer.Serialize(profile, mPlayerData);</span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">profile = File.OpenRead(mProfilePath);</span><br><span class="line">mPlayerData = serializer.Deserialize(profile,<span class="keyword">null</span>,<span class="keyword">typeof</span>(PlayerData)) <span class="keyword">as</span> PlayerData;</span><br></pre></td></tr></table></figure></p>
<p>因为需要编写.proto文件后编译生成对应的Serialization类的dll，所以最好通过shell脚本写成自动化。<br>还有一种方式是使用Probobuf-net源码的形式(貌似需要设定-unsafe和.NET 2 subset)，这里我没有尝试，下面给出链接：<br><a href="http://www.ceeger.com/forum/read.php?tid=14359&amp;fid=27" target="_blank" rel="external">在ios android设备上使用 Protobuf (使用源码方式) </a></p>
<p>了解了什么(What)是Protobuf，如何(How)使用Protobuf，那么我们也应该大概了解下为什么(Why)Protobuf高效，更小，更快，更简单…..<br>参考下面两篇文章：<br><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/" target="_blank" rel="external">Google Protocol Buffer 的使用和原理</a><br><a href="https://developers.google.com/protocol-buffers/docs/encoding" target="_blank" rel="external">官网讲到的Protocol buffer的Encode技术</a><br>从上面可以看出，更小更快是因为Protocol buffer采用了巧妙的Encoding方法。<br>而这个Encoding方法利用了Varint技术，那么什么是Varint了？<br>“Varints are a method of serializing integers using one or more bytes. Smaller numbers take a smaller number of bytes. “<br>Varints通过更少的字节来表达准确的数据，比如0-127只需要1个字节就能表示。<br>当需要多个字节表达的时候，通过利用1byte里的first bit来区分，如果first bit是1表示后续的7个bit都表示数据，如果first bit是0表示这是最后一个字节用于表示数据。<br>同时Protocol buffer在Encode的时候通过key和value来存储数据。key只包含filed的名字和类型，value包含数据。<br>类型数据映射<br><img src="/img/Unity/ProtocolBufferMessageValueType.PNG" alt="ProtocolBufferMessageValueType"><br>当Decode的时候，如果遇到不识别的key值，只需要skip即可，保证了程序的老版本兼容。<br>更方便在于，我们只需通过编写简单易懂的.proto文件然后通过ProtoGen，Precompile工具就能生成对应的Message，Encode和Decode类。<br>结合前面的事例，让我们窥探一下到底Protocol-net是如何实现编写.proto文件结合编译生成Message类和序列化类来实现数据的Encode和Decode的。<br>首先反编译的ProtovufSerializer.dll，查看Serialize方法<br><img src="/img/Unity/ProtobufSerializerSerialize.PNG" alt="ProtobufSerializerSerialize"><br>可以看到ProtobufSerializer调用了Write方法，接下来查看Write方法<br><img src="/img/Unity/ProtobufSerializerWrite.PNG" alt="ProtobufSerializerWrite"><br>可以看到我们ProtobufSerializer实际是通过调用ProtoBuf.ProtoWriter::WriteFieldHeader(Protobuf-net库)实现数据的Encode的。同时因为ProtobufSerializer是根据PlayerData.dll编译而成，所以Write方法里的实现针对每一个需要Encode的Message成员进行数据Encode写入。<br>这样一来就完成了通过编写.proto文件定义Message，然后生成对应的Message类和序列化类再结合Protocol-net库实现了自定义Message的Encode和Decode了，而最终数据的Encode，Decode实现就落实到Protocol-net的实现了。</p>
<p>那么为什么要用Protocol buffer了？<br>参考文章：<br><a href="http://www.oschina.net/translate/choose-protocol-buffers" target="_blank" rel="external">使用 Protocol Buffers 代替 JSON 的五个原因</a><br>Protocol buffer因为是存储在二进制文件，相比XML，Jason等技术不具可读性。</p>
<p>Note:<br>最初的Protocol Buffers只开发了针对Java,C++,Python的版本。后来开园后有了C#，Go等语言的支持。<br>Protocol Buffer存储的数据是以二进制的形式。<br>Protocol-net只支持<a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="external">proto2的语言编写规范</a>。</p>
<h2 id="Unity_Using">Unity Using</h2><ol>
<li><strong>Layout</strong> — 排版，可用于存储我们在Unity里面的面板排版设置，通过制定layout使用特定排版</li>
<li><strong>Prefab</strong> — 原件，可在场景里重复利用，而且Prefab的改变可以通过点击Inspector界面的Apply影响到所有从该Prefab里创建出的对象</li>
<li><strong>Tag</strong>  — Scene里面所有物体的唯一标识，用于确保正确识别物体，通过对物体添加tag可以在程序里用于身份判别</li>
<li><strong>Static collider</strong> — will not be affected by collision (not cause collide). Unity keep static collider mesh in cach</li>
<li><strong>Dynamic collider</strong> — will be affected by collision</li>
<li><strong>Is Trigger</strong> — when no collide caused(e.g. static collider), we can use trigger to enter collide event(只有没有物理碰撞的物体才会触发Trigger的)</li>
<li><strong>Rigibody body</strong> — Moved by using physical force, use dynamic collider</li>
<li><strong>Kinematic body</strong> — Moved by using the transform instead of physical force</li>
<li><strong>Mesh Collider</strong> — Use Model mesh as collider mesh (一般只用于简单的三角形数量少的mesh)</li>
<li><strong>AudioSource</strong> — 声音在Unity里也是组件的形式存在</li>
<li><strong>C# Script</strong> — 每个物体可以绑定多个脚本用于不同逻辑，特别是用于原件一些特有的逻辑特性</li>
<li><strong>2.5D</strong> — 在3D的世界里通过平行投影(Orthographic Projection - isometric projection)实现</li>
<li><strong>Raycast</strong> — 射线碰撞检测（Physics.Raycast()在物体是is triiger on的时候不会触发）</li>
<li><strong>LayerMask</strong> — 可以用于选择和射线检测过滤</li>
<li><strong>NavMeshAgent</strong> — Unity的Navigation system可以提供最基本的路径AI寻址(只需要指定agent相关参数，在代码里设定跟踪目标) — 添加后需要Bake Navigation</li>
<li><strong>Animation Controller</strong> — 动画管理，通过给物体添加Animator并设定动画状态机之间的切换规则来实现动画状态切换管理(通过给UI添加Animator我们也可以在Anmation面板设置简单动画)</li>
<li><strong>LineRenderer</strong> — 可以用于在3D世界里绘制线条，实现可视化一些射线检测物体碰撞等</li>
<li><strong>Select icon</strong> — 可以给没有实际物体或透明物体一个颜色标记(容易看到3D世界位置)</li>
<li><strong>Canvas</strong> — 画布是所有UI所应该在的区域(UI的层级关系会影响渲染顺序) — 通过设定Render Mode实现不同的效果(Screen Space - Overlay不会受Camera的投影方式影响，永远在场景上. Screen Space - Camera会受Camera的投影方式影响，比如在透视投影里就会有近大远小的效果. World Space会把UI当做3D空间里的物体来对待，有深度概念会被遮挡 ))</li>
<li><strong>Physics2D.Linecast</strong> — 可用于检测特定layer的射线检测</li>
<li><p><em>**Input</em> — 不同平台要使用不同平台的AIP<br>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">if</span> UNITY_EDITOR || UNITY_STANDLONE || UNITY_WEBPLAYER</span></span><br><span class="line">	horizontal = (<span class="keyword">int</span>)Input.GetAxisRaw (<span class="string">"Horizontal"</span>);</span><br><span class="line">	vertical = (<span class="keyword">int</span>)Input.GetAxisRaw (<span class="string">"Vertical"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (horizontal != <span class="number">0</span>) &#123;</span><br><span class="line">		vertical = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span>(Input.touchCount &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Touch myTouch = Input.touches[<span class="number">0</span>];</span><br><span class="line">		<span class="keyword">if</span>(myTouch.phase == TouchPhase.Began)</span><br><span class="line">		&#123;</span><br><span class="line">			touchOrigin = myTouch.position;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">myTouch.phase == TouchPhase.Ended &amp;&amp; touchOrigin.x &gt;= <span class="number">0</span></span>)</span><br><span class="line">		</span>&#123;</span><br><span class="line">			Vector2 touchEnd = myTouch.position;</span><br><span class="line">			<span class="keyword">float</span> x = touchEnd.x - touchOrigin.x;</span><br><span class="line">			<span class="keyword">float</span> y = touchEnd.y - touchOrigin.y;</span><br><span class="line">			touchOrigin.x = -<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(Mathf.Abs(x) &gt; Mathf.Abs(y))</span><br><span class="line">			&#123;</span><br><span class="line">				horizontal = x &gt; <span class="number">0</span> ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				vertical = y &gt; <span class="number">0</span> ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>DontDestroyOnLoad()</strong> — 加载新的scene的时候保证对象不会被销毁</p>
</li>
<li><strong>Invoke()</strong> — 延时调用方法</li>
</ol>
<h1 id="快捷键学习">快捷键学习</h1><p>F — 在Scene界面选中对象后可以快速聚焦到该物体<br>Ctrl + ‘ — 打开脚本的类Reference page<br>Ctrl + D — Duplicated（复制）物体</p>
<h1 id="项目编译发布">项目编译发布</h1><h2 id="PC">PC</h2><ol>
<li>File -&gt; Build Setting 设置平台PC</li>
<li>Drag Scene file to Scenes to build 选择要编译的场景</li>
<li>点击Build 编译游戏</li>
</ol>
<h2 id="IOS">IOS</h2><h3 id="Native_Code_Compilation">Native Code Compilation</h3><p>PC平台使用C++编写的库的时候是通过lib或者dll的静态和动态链接<br>但在IOS移动平台使用的时候，这些代码必须以插件的形式调用，以静态方式链接。<br><a href="http://docs.unity3d.com/Manual/Plugins.html" target="_blank" rel="external">Managed plugins and Native Plugins</a></p>
<p>Note:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">if</span> UNITY_IPHONE || UNITY_XBOX360</span></span><br><span class="line"><span class="comment">//On iOS and Xbox 360 plugins are statically linked into</span></span><br><span class="line"><span class="comment">//the executable, so we have to use **Internal as the</span></span><br><span class="line"><span class="comment">//library name.</span></span><br><span class="line">[DllImport (<span class="string">"**Internal"</span>)]</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line"><span class="comment">// Other platforms load plugins dynamically, so pass the name</span></span><br><span class="line"><span class="comment">// of the plugin's dynamic library.</span></span><br><span class="line">[DllImport (<span class="string">"PluginName"</span>)]</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>在真正编译到IOS上使用之前，我们必须通过cross compile把Native code编译成.a的文件，然后静态链接到项目中使用。（需要在Mac电脑上cross compile）</p>
<p>以下以开源工具Zlib为例：<br><a href="http://www.zlib.net/" target="_blank" rel="external">Zlib Download</a></p>
<p><a href="http://blog.karmadust.com/category/ios/" target="_blank" rel="external">参考文章:Building Universal Binaries for iOS</a></p>
<p>解压打开文件夹后会发现，目录下有MakeFile, .configure, MakeFile.in等文件。<a href="https://en.wikipedia.org/wiki/Makefile" target="_blank" rel="external">MakeFile</a>是编写了编译规则的文件用于自动编译的工具(在Unix，Linux系统上广泛运用)。而configure和MakeFile.in是通过<a href="https://zh.wikipedia.org/wiki/Autoconf" target="_blank" rel="external">Autoconf</a>和<a href="https://zh.wikipedia.org/wiki/Automake" target="_blank" rel="external">Automake</a>工具生成，用于编写高阶语言来生成makefile而无需手动编写复杂的makefie.。通过调用.configure并传入参数，.configure就会以MakeFile.in为模板产生我们预期的MakeFile。（这里我对MakeFile,autoconf,automake都不熟悉，现阶段的认识是这样的）</p>
<p>我们将会通过.configure生成我们需要的Makefile用于编译程序:</p>
<ol>
<li>.configure —prefix=${PWD}/installdir(用于生成makefile，—prefix用于指定make install后的文件夹)</li>
<li>unset CC(先重置一次CC编译设定，避免出问题) </li>
<li>export CC=”xcrun -sdk iphoneos clang -arch armv7”(这里很重要，在调用makefile之前，我们通过设置环境变量CC的值来指定make的编译设定，比如编译工具，编译架构等，-sdk 指定SDK路径用于搜索相关工具(比如编译工具等) -arch 用于指定编译出的文件架构类型)</li>
<li>make clean(清理make生成的文件)</li>
<li>make(执行makefile进行编译)</li>
<li>make install(安装make生成的相关文件到对应目录)</li>
<li>lipo -info libz.a(通过lipo工具来查看生成的libz.a文件是基于什么架构的)</li>
</ol>
<p>上述有几个概念需要提一下：<br><a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/xcrun.1.html" target="_blank" rel="external">xcrum</a>(个人理解是，通过这个工具可以在不改makefile的前提下，通过命令行指定开发工具的一些信息) properties.<br>clang — <a href="https://zh.wikipedia.org/wiki/Clang" target="_blank" rel="external">clang是 是一个C、C++、Objective-C和Objective-C++编程语言的编译器前端。它采用了底层虚拟机（LLVM）作为其后端。它的目标是提供一个GNU编译器套装（GCC）的替代品。Clang是LLVM编译器工具集的前端（front-end），目的是输出代码对应的抽象语法树（Abstract Syntax Tree, AST），并将代码编译成LLVM Bitcode。接着在后端（back-end）使用LLVM编译成平台相关的机器语言 。Clang支持C、C++、Objective C。</a>(可以理解成Mac上的编译工具，支持多种语言编译生成多种平台相关的机器语言)<br>Universal binary — 可以理解成multiarchitecture binary，支持多种架构的二进制文件（比如我们这里针对IOS生成的armv7架构的libz.a，我们也可以再生成一个针对simulator的i386架构的libz.a，然后通过执行lipo -create -arch i386 libz.a(386) -arch armv7 libz.a(armv7) -output libz_fatbinary.a生成同时支持simulator和IOS的.a文件）<br>lipo — 苹果上用于生成Universal binary的工具(lipo -info libz.a用于查看.a文件支持的架构信息)</p>
<p>Note:<br>Simulator（模拟器）使用的.a文件是基于i386的，而IOS真机使用的.a文件是基于armv7 or armv8的。</p>
<h3 id="Prepare_XCode_Project">Prepare XCode Project</h3><ol>
<li>File -&gt; Build Setting 设置平台IOS</li>
<li>Drag Scene file to Scenes to build 选择要编译的场景</li>
<li>点击Build </li>
</ol>
<p>这样一来XCode项目就生成了。</p>
<h3 id="Compile_XCode_Project">Compile XCode Project</h3><p>条件：</p>
<ol>
<li>需要苹果开发者账号<br>待续……</li>
</ol>
<p>Note:<br><a href="https://cmake.org/" target="_blank" rel="external">跨平台自动化编译工具CMake</a></p>
<h1 id="版块学习">版块学习</h1><h2 id="UGUI">UGUI</h2><p>在Unity 4.6版本后推出的官方的GUI</p>
<h3 id="Coordinates_System">Coordinates System</h3><p><a href="http://stackoverflow.com/questions/21937544/working-with-the-coordinate-system-and-game-screen-in-unity-2d" target="_blank" rel="external">下面的定义来源</a></p>
<ol>
<li><p>Screen coordinates<br>Is 2D, measured in pixels and start in the lower left corner at (0,0) and go to (Screen.width, Screen.height). Screen coordinates change with the resolution of the device, and even the orientation (if you app allows it) on mobile devices.<br>左下角为(0,0)，右上角为(Screen.width, Screen.height)</p>
</li>
<li><p>GUI coordinates<br>Is used by the GUI system. They are identical to Screen coordinates except that they start at (0,0) in the upper left and go to (Screen.width, Screen.height) in the lower right.<br>左上角为(0,0)，右下角为(Screen.width, Screen.height)</p>
</li>
<li><p>Viewport coordinates<br>Is the same no matter what the resolution. The are 2D, start at (0,0) in the lower left and go to (1,1) in the upper right. For example (0.5, 0.5) in viewport coordinates will be the center of the screen no matter what resolution or orientation.<br>相对于摄像机坐标系而言的，近平面(0,0)，远平面(1,1)，(0.5,0.5)表示在摄像机坐标系的中间。</p>
</li>
<li><p>World coordinates<br>Is a 3D coordinates system and where all of your object live.<br>世界坐标系的(x,y,z)</p>
</li>
</ol>
<h3 id="Unity_Unit_&amp;_Pixel_Per_Unit">Unity Unit &amp; Pixel Per Unit</h3><ol>
<li><p>Unity Unit<br>Unity Unit代表Unity里的一个Unit单位代表物理大小，默认是1 unit = 1 meter<br>所以我们在建模的时候如果想导入到Unity后保持scale(1,1,1)就应该把建模软件也设定成1 unit = 1 meter。<br>Unity Unit主要影响的是Physical(比如重力加速度的运算，如果修改Unit为厘米，但不重新计算重力加速度，那么物体会落的很快)</p>
</li>
<li><p>Pixel Per Unit<br>Pixel Per Unit主要影响Sprite在屏幕上的映射显示。表示多少个像素等价于一个Unit，后面会详细讲到。</p>
</li>
</ol>
<h3 id="Canvas">Canvas</h3><p><a href="http://docs.unity3d.com/Manual/UICanvas.html" target="_blank" rel="external">The Canvas is the area that all UI elements should be inside.(所有的UI元素都必须处于Canvas里)</a><br>以下学习参考<a href="http://k79k06k02k.com/blog/24/unity/unity-ugui-%E5%8E%9F%E7%90%86%E7%AF%87%E4%BA%8C%EF%BC%9Acanvas-scaler-%E7%B8%AE%E6%94%BE%E6%A0%B8%E5%BF%83" target="_blank" rel="external">Unity UGUI 原理篇(二)：Canvas Scaler 縮放核心</a><br>UI Render Space:<br>Screen Space(Overlay) — 不会受Camera的投影方式影响，永远在场景上.(不用设置Camera)<br>Screen Space(Camera) — 需要设置Camera，会受Camera的投影方式影响，比如在透视投影里就会有近大远小的效果，有遮挡的概念. (正交投影会根据摄像机的Orthographic Size和PPU设定去显示UI)。Screen Space下屏幕分辨率变化，Canva会自动缩放UI去适应。<br>World Space — 会把UI当做3D空间里的物体来对待，有深度概念会被遮挡。</p>
<p>Canvas Scaler：<br><a href="https://docs.unity3d.com/Manual/script-CanvasScaler.html" target="_blank" rel="external">The Canvas Scaler component is used for controlling the overall scale and pixel density of UI elements in the Canvas. This scaling affects everything under the Canvas, including font sizes and image borders.</a><br>可以看出Canvas Scaler是控制了UI在画布上的具体显示，这个好比NGUI里UIRoot下的Scaling Style设定。<br>UI Scale Mode有如下三种:</p>
<ol>
<li><p>Constant Pixel Size<br> <a href="https://docs.unity3d.com/Manual/script-CanvasScaler.html" target="_blank" rel="external">Makes UI elements retain the same size in pixels regardless of screen size.</a><br> 保持UI像素大小与屏幕大小无关(相当于NGUI里的UIRoot的PixelPerfect)<br> 参数Scale Factor — <a href="https://docs.unity3d.com/Manual/script-CanvasScaler.html" target="_blank" rel="external">Scales all UI elements in the Canvas by this factor.</a><br> 通过Scale Factor去scale canvas的大小已达到整体scale UI的目的。<br> 我们设置屏幕大小为1024 <em> 768，Scale Factor为1时：<br> <img src="/img/Unity/ConstantPixelSizeScaleFactor.PNG" alt="ConstantPixelSizeScaleFactor"><br> 可以看到Canva Size为1024 </em> 768，Scale为(1,1,1)<br> 当我们设置Scale Factor为2时：<br> <img src="/img/Unity/ConstantPixelSizeScaleFactor2.PNG" alt="ConstantPixelSizeScaleFactor2"><br> 可以看到Canva Size为512 * 384，Scale为(2,2,1)<br> 这样一来所有Canva下的UI就相当于放大了两倍。<br> Note:<br> 这里注意区分Screen Size和Canva Size是两个概念。<br> 参数Reference Pixels Per Unit — <a href="https://docs.unity3d.com/Manual/script-CanvasScaler.html" target="_blank" rel="external">If a sprite has this ‘Pixels Per Unit’ setting, then one pixel in the sprite will cover one unit in the UI.</a><br> PPU指定了多少个像素表示一个Unit。如果Sprite有设置PPU，那么会把Sprite里的1 pixel转换成UI中的1 pixel。<br> 这里我用的是非Pro版的Unity，所以查看不到源码，<a href="http://k79k06k02k.com/blog/24/unity/unity-ugui-%E5%8E%9F%E7%90%86%E7%AF%87%E4%BA%8C%EF%BC%9Acanvas-scaler-%E7%B8%AE%E6%94%BE%E6%A0%B8%E5%BF%83" target="_blank" rel="external">下面源码来源</a><br> Image.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">float</span> pixelsPerUnit</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">float</span> spritePixelsPerUnit = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">if</span> (sprite)</span><br><span class="line">            spritePixelsPerUnit = sprite.pixelsPerUnit;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">float</span> referencePixelsPerUnit = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">if</span> (canvas)</span><br><span class="line">            referencePixelsPerUnit = canvas.referencePixelsPerUnit;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> spritePixelsPerUnit / referencePixelsPerUnit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetNativeSize</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (overrideSprite != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">float</span> w = overrideSprite.rect.width / pixelsPerUnit;</span><br><span class="line">        <span class="keyword">float</span> h = overrideSprite.rect.height / pixelsPerUnit;</span><br><span class="line">        rectTransform.anchorMax = rectTransform.anchorMin;</span><br><span class="line">        rectTransform.sizeDelta = <span class="keyword">new</span> Vector2(w, h);</span><br><span class="line">        SetAllDirty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 可以看到当我们设置了Sprite的PPU后，Sprite的可显示区域(Rect)的大小计算如下：<br> SpriteRectSize =  SpriteSize * SpritePPU / CanvaReferencePPU<br> 所以如果我们设置SpritePPU和CanvaReferencePPU一样，那么SpriteRect的大小就会以Sprite的原始大小为准。<br> Note:<br> SetNatieSize需要通过点击Image Component的Set Native Size触发。</p>
</li>
<li><p>Scale With Screen Size<br> 以预设的Resolution为基准来进行自适应计算。(相当于NGUI里的Fixed Size)<br> Screen Match Mode的设定则决定了如何基于高度和宽度变化去适应。<br> 以下是CanvasScaler.cs源码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Vector2 screenSize = <span class="keyword">new</span> Vector2(Screen.width, Screen.height);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">float</span> scaleFactor = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (m_ScreenMatchMode)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">case</span> ScreenMatchMode.MatchWidthOrHeight:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// We take the log of the relative width and height before taking the average.</span></span><br><span class="line">        <span class="comment">// Then we transform it back in the original space.</span></span><br><span class="line">        <span class="comment">// the reason to transform in and out of logarithmic space is to have better behavior.</span></span><br><span class="line">        <span class="comment">// If one axis has twice resolution and the other has half, it should even out if widthOrHeight value is at 0.5.</span></span><br><span class="line">        <span class="comment">// In normal space the average would be (0.5 + 2) / 2 = 1.25</span></span><br><span class="line">        <span class="comment">// In logarithmic space the average is (-1 + 1) / 2 = 0</span></span><br><span class="line">        <span class="keyword">float</span> logWidth = Mathf.Log(screenSize.x / m_ReferenceResolution.x, kLogBase);</span><br><span class="line">        <span class="keyword">float</span> logHeight = Mathf.Log(screenSize.y / m_ReferenceResolution.y, kLogBase);</span><br><span class="line">        <span class="keyword">float</span> logWeightedAverage = Mathf.Lerp(logWidth, logHeight, m_MatchWidthOrHeight);</span><br><span class="line">        scaleFactor = Mathf.Pow(kLogBase, logWeightedAverage);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ScreenMatchMode.Expand:</span><br><span class="line">    &#123;</span><br><span class="line">        scaleFactor = Mathf.Min(screenSize.x / m_ReferenceResolution.x, screenSize.y / m_ReferenceResolution.y);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ScreenMatchMode.Shrink:</span><br><span class="line">    &#123;</span><br><span class="line">        scaleFactor = Mathf.Max(screenSize.x / m_ReferenceResolution.x, screenSize.y / m_ReferenceResolution.y);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> Screen Match Mode有三中：</p>
<ol>
<li>MatchWidthOrHeight(根据Screen Size相对于预设Resolution的宽度和高度变化去计算ScaleFactor(缩放Canva Size))<br> 举例说明：<br> Reference Size为1024 <em> 768。Screen Size为960 </em> 640。<br> LogWidth = Mathf.Log(screenSize.x / m_ReferenceResolution.x, kLogBase) = Log2( 960 / 1024) = Log2(0.9375);<br> LogHeight = Mathf.Log(screenSize.y / m_ReferenceResolution.y, kLogBase) = Log2( 640 / 768) = Log2(0.8333);<br> logWeightedAverage = Mathf.Lerp(logWidth, logHeight, m_MatchWidthOrHeight) = Lerp(Log2(0.9375), Log2(0.8333), MatchWidthOrHeight));<br> scaleFactor = Mathf.Pow(kLogBase, logWeightedAverage) = Pow(2, Lerp(Log2(0.9375), Log2(0.8333), MatchWidthOrHeight)));<br> MatchWidthOrHeight会决定Width和Height Scale所占比例。<br> 如果MatchWidthOrHeight为0。<br> scaleFactor = Mathf.Pow(kLogBase, logWeightedAverage) = Pow(2, Lerp(Log2(0.9375), Log2(0.8333), 0))) = Pow(2, Log2(0.9375)) = 0.9375;<br> Canva Size Width = Screen Size Width / scaleFactor = 960 / 0.9375 = 1024<br> Canva Size Height = Screen Size Height / scaleFactor = 640 / 0.9375 = 682.667<br> 为什么需要通过先取对数在进行平均混合了？<br> 假設Reference Resolution為400<em>300，Screen Size為200</em>600 大小關係是<br> Reference Resolution Width 是 Screen Size Width的2倍<br> Reference Resolution Height 是 Screen Size 的0.5倍<br> 看起来如下图：<br> <img src="/img/Unity/ScaleWithScreenSize.PNG" alt="ScaleWithScreenSize"><br> 當March為0.5時，ScaleFactor應該要是 1 (拉平) — ？没太理解这里拉平的概念<br> ScaleFactor Width： 200/400=0.5<br> ScaleFactor Height：600/300=2<br> 一般混合：<br> ScaleFactor = March <em> ScaleFactor Width + (1 - March) </em> ScaleFactorHeight<br> ScaleFactor = 0.5 <em> 0.5 + 0.5 </em> 2 = 1.25<br> 對數混合：<br> logWidth：log2(0.5) = -1<br> logHeight：log2(2) = 1<br> logWeightedAverage：0<br> ScaleFactor：Pow(2,0) = 1</li>
<li>Expand(将Canva Size基于宽度或高度去扩大)<br> 以Scale Factor Width和Scale Factor Height中小的为准。</li>
<li>Shrink(将Canva Size基于宽度或高度去收缩)<br> 以Scale Factor Width和Scale Factor Height中大的为准。<br> scaleFactor一般混合為1.25，對數混合為1，結果很明顯，使用對數混合能更完美的修正大小<br> 可以看出UGUI的自适应都是基于动态计算Scale Factor(也就是Canva Size即Canva Scale的大小)来实现的。</li>
</ol>
</li>
<li><p>Constant Physical Size<br><a href="https://docs.unity3d.com/Manual/script-CanvasScaler.html" target="_blank" rel="external">Makes UI elements retain the same physical size regardless of screen size and resolution.</a><br>保持UI的Physical Size(DPI - Dots Per Inch 每英寸像素点)<br><img src="/img/Unity/ConstantPhysicalSize.png" alt="ConstantPhysicalSize"></p>
<ol>
<li><p>Physical Unit：使用的單位种类</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">| 单位种类    |     中文       |   与<span class="number">1</span>英寸关系 |</span><br><span class="line">| ----------- | -------------- | ------------- |</span><br><span class="line">| Centimeters |	公分(cm，厘米) |     <span class="number">2.54</span>      |</span><br><span class="line">| Millimeters | 毫米(mm，毫米) |     <span class="number">25.4</span>      |</span><br><span class="line">|  Inches     |	   英寸        |      <span class="number">1</span>        |</span><br><span class="line">|  Points     |     点         |      <span class="number">72</span>       |</span><br><span class="line">|  Picas      |皮卡(十二点活字)|      <span class="number">6</span>        |</span><br></pre></td></tr></table></figure>
</li>
<li><p>Fallback Screen DPI：备用Dpi，当找不到设备Dpi時，使用此值</p>
</li>
<li>Default Sprite DPI：预设的图片Dpi<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> currentDpi = Screen.dpi;</span><br><span class="line"><span class="keyword">float</span> dpi = (currentDpi == <span class="number">0</span> ? m_FallbackScreenDPI : currentDpi);</span><br><span class="line"><span class="keyword">float</span> targetDPI = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">switch</span> (m_PhysicalUnit)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">case</span> Unit.Centimeters: targetDPI = <span class="number">2.54</span>f; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Unit.Millimeters: targetDPI = <span class="number">25.4</span>f; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Unit.Inches:      targetDPI =     <span class="number">1</span>; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Unit.Points:      targetDPI =    <span class="number">72</span>; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Unit.Picas:       targetDPI =     <span class="number">6</span>; <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">SetScaleFactor(dpi / targetDPI);</span><br><span class="line">SetReferencePixelsPerUnit(m_ReferencePixelsPerUnit * targetDPI / m_DefaultSpriteDPI);</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<p>结论：<br>ScaleFactor 為 “目前硬體dpi” 佔了 “目標單位” 的比例<br>ReferencePixelsPerUnit 要與目前的Dpi在運算求出新的值，再傳入Canvas中求出大小，公式如下：<br>新的Reference Pixels Per Unit = Reference Pixels Per Unit * Physical Unit / Default Sprite DPI<br>UI大小 = 原圖大小(Pixels)  /  (Pixels Per Unit / 新的 Reference Pixels Per Unit)<br>(关于基于Constant Physical Size这一点还没看明白，<a href="http://k79k06k02k.com/blog/24/unity/unity-ugui-%E5%8E%9F%E7%90%86%E7%AF%87%E4%BA%8C%EF%BC%9Acanvas-scaler-%E7%B8%AE%E6%94%BE%E6%A0%B8%E5%BF%83" target="_blank" rel="external">上面资料来源</a>)</p>
<p>RectTransform:<br><a href="https://docs.unity3d.com/Manual/UIBasicLayout.html" target="_blank" rel="external">The Rect Transform is a new transform component that is used for all UI elements instead of the regular Transform component. Rect Transforms have position, rotation, and scale just like regular Transforms, but it also has a width and height, used to specify the dimensions of the rectangle.</a><br>RectTransform是用于指定UI相关的一些信息(Position,Rotation,scale,Anchors,Pivot等)<br><img src="/img/Unity/RectTransform.PNG" alt="RectTransform"></p>
<p>Pivot(枢轴):<br>物体的transform变化，比如scale,position,rotation都会以这个点为基准来变化</p>
<p>Anchors(锚点):<br>主要用于UI的layout排版，根据Anchors的位置设置不同，UI会在父节点RectTransform变化的时候做出适当的变化(这里的Anchors相当于完成了NGUI里UIAnchor和UIStreach的任务)。Anchors能够保证以4个锚点设定的相对位置(可以相对屏幕比例，也可以相对特定像素值)。</p>
<p>Layout System:<br>Layout System是基于RectTransform之上的系统，用自动调整一个或多个元素的大小，位置，间隔等。(用于UI布局很重要)<br>详细学习参考<a href="http://k79k06k02k.com/blog/542/unity/unity-ugui-%E5%8E%9F%E7%90%86%E7%AF%87%E4%BA%94%EF%BC%9Aauto-layout-%E8%87%AA%E5%8B%95%E4%BD%88%E5%B1%80" target="_blank" rel="external">Unity UGUI 原理篇(五)：Auto Layout 自動佈局</a></p>
<p>结论：<br>UI Render Mode决定了UI的显示方式。<br>UI Scale Mode决定了UI的大方向(保持像素还是保持比例还是保持物理大小)自适应策略。<br>Pivot决定了自适应的基准点。<br>Anchors决定了自适应变化的参考物(比如我们把锚点都设置在父RectTransform的左上角，那么自适应的时候无论父RectTransform大小如何变化该UI都是相对于父RectTransform的位置都不会变化(但UI大小会变，因为我们可能设置了Scale With Screen Size使得Canvas会自适应屏幕变化(Canvas Scale值会变))，如果我们把锚点设置到父RectTranform的四个角，那么UI就会根据父RectTransform的大小的变化比例去适应(一般用于背景显示，保证背景铺满屏幕，可能会拉伸))</p>
<p>在得出最终结论之前，让我们来看一个像素完美显示问题。<br>如何保证Pixel Perfect 2D？<br>参考文章<a href="https://blogs.unity3d.com/cn/2015/06/19/pixel-perfect-2d/" target="_blank" rel="external">Pixel Perfect 2D</a><br><a href="https://blogs.unity3d.com/cn/2015/06/19/pixel-perfect-2d/" target="_blank" rel="external">The secret to making your pixelated game look nice is to ensure that your sprite is rendered on a nice pixel boundary. In other words, ensure that each pixel of your sprite is rendered on one screen pixel (or any other round number). The trick to achieving this result is tweaking the camera’s orthographic size (and live with the consequences).</a><br>从上面可以看出要保证Pixel Perfect显示，我们需要保证Sprite的一个像素在屏幕上对应显示像素为整数倍(最好1:1)。要做到这一点通过修改Camera Orthographic Size可以做到。正如<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#NGUI_2-7%E5%B1%8F%E5%B9%95%E8%87%AA%E9%80%82%E5%BA%94">NGUI 2.7屏幕自适应</a>学习中提到的，我们要保证PPU = Screen.height / 2 / Orthographic Size;<br>因为我们不可能修改物理的Screen.height，所以为了在不同设备上完美显示像素，我们能做的是动态修改Orthographic Size或制作多套PPU Asset去动态使用。<br>详情参考：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Vertical Resolution  |   PPU  |	PPU Scale |	Orthographics Size |	Size Change</span><br><span class="line">---------------------|--------|-----------|--------------------|----------------</span><br><span class="line"><span class="number">768</span>    	             |   <span class="number">32</span>   |	   <span class="number">1</span>x 	  |        <span class="number">12</span> 	       |       <span class="number">100</span>%</span><br><span class="line"><span class="number">1080</span> 	             |   <span class="number">32</span>   |	   <span class="number">1</span>x 	  |      <span class="number">16.875</span>        |       <span class="number">140</span>%</span><br><span class="line"><span class="number">1080</span> 	             |   <span class="number">48</span>   |    <span class="number">1</span>x     | 	  <span class="number">11.25</span>        | 	   <span class="number">93.75</span>%</span><br><span class="line"><span class="number">1080</span>  	             |   <span class="number">32</span>   |    <span class="number">2</span>x 	  |       <span class="number">8.4375</span>       |       <span class="number">70.31</span>%</span><br><span class="line"><span class="number">1440</span> 	             |   <span class="number">32</span>   |    <span class="number">2</span>x 	  |       <span class="number">11.25</span>        |       <span class="number">93.75</span>%</span><br><span class="line"><span class="number">1536</span> 	             |   <span class="number">32</span>   |    <span class="number">2</span>x 	  |         <span class="number">12</span>         |       <span class="number">100</span>%</span><br></pre></td></tr></table></figure></p>
<p>但是由于修改Orthographic Size会导致Visible World Space变化，所以还需要根据项目实际情况做出修正。</p>
<ol>
<li>Thick Borders<br><img src="/img/Unity/ThickBorder.PNG" alt="ThickBorder"><br>如果是2D游戏有边框限制且Orthographic Size变化不大，我们可以通过只调整边框厚度去弥补</li>
<li>Increase Asset Resolution<br>通过制作多套PPU的Asset，已达到修正Orthographics Size值(从前面表格可以看出，通过使用不同PPU Asset可以在保证Pixel Perfect的前提下尽量减小Orthographics Size的变化)的目的。(Size Change变化不大的话可以采用第一种方案按情况弥补)</li>
<li>Halving Orthographic Size<br>如果Screen.height变化很大，导致计算出的Orthographics Size变化很大，我们可以通过修正(以2倍数为基准)Orthographic Size大小使其Size Change变化不大，然后通过Thick Borders来做最后修正。(比如表格上面从768变到1440的时候，我们Orthographics Size不是22.5而是22.5/2=11.25来修正。这个方法的好处是不需要做多套PPU的Asset)</li>
</ol>
<p>UGUI自适应的结论就不言而喻了，一般来说都是基于按比例的缩放，所以设置如下(2D为例)：<br>UI Render Mode — Screen Space(Camera)，设置Main Camera为Orthographic，Orthographic Size设置为Screen.height / 2 / PPU(使用Screen Space(Camera)为了配合Orthographic Camera对Scren Unit进行细分)<br>UI Scale Mode — Scale With Screen Size,设置基准Resolution，同时Screen Match Mode为MatchWidthOrHeight = 0.5(确保同时适应宽和高的变化)。<br>Pivot — 不出意外都设置在UI的中心点<br>Anchors — 如果是和父RectTransform大小一起适应的话，放到父RectTransform的四个角即可(可能会有拉伸，多用于背景显示)。如果想保持UI相对于父RectTransform的特定比例的位置即设置锚点到特定比例位置即可。如果只想保持相对位置不变，四个锚点都设置到同一个点即可(一般UI都有固定位置，一般都设置成这个)。更多的UI排版使用Layout，Layout Group管理。<br>美术制作的时候以UI Scale Mode里设置的Resolution基准和PPU设定来制作(比如Resolution基准决定了背景图片的大小，PPU设定决定UI大小(PPU = Screen.height / 2 / Orthographic Size)，如果设定Screen.height = 768，Orthographic Size = 12， 那么PPU = 32, 1 unit = 32 pixel,屏幕UI高度为24 Unit，如果想设计button占屏幕高度1 unit，那么32 * 32 像素即可)。<br>然后在游戏里通过动态计算Orthographic Size来确保Pixel Perfect显示。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Orthographic Size = Screen.height / <span class="number">2</span> / PPU(<span class="number">32</span>);</span><br></pre></td></tr></table></figure></p>
<p>当Screen.height(Orthographic Size变化大)变化大的时候，我们通过按2的倍数的比例来修正Orthographic Size。(也可以通过制作多套PPU的Asset来动态替换)</p>
<h3 id="EventSystem">EventSystem</h3><p>UI要想响应UI Event，必须在场景里创建EventSystem(创建UI Canvas的时候会自动创建)。<br><img src="/img/Unity/EventSystem.PNG" alt="EventSystem"><br>可以看到现在Event System主要是由2个Component构成：</p>
<ol>
<li>Event System<br><a href="https://docs.unity3d.com/ScriptReference/EventSystems.EventSystem.html" target="_blank" rel="external">The EventSystem is responsible for processing and handling events in a Unity scene. A scene should only contain one EventSystem.</a><br>Event System是负责处理场景里的事件，负责更新Input Module<br>点击Play后，选中Event System，然后在场景里交互的时候，EventSystem会显示出当前交互的信息<br><img src="/img/Unity/SystemInfo.PNG" alt="SystemInfo"><br>Send Navigation Events — 用于控制是否开启UI导航功能(通过按下键盘上下左右来选择)<br>通过设置Button的Navigation为Explicit我们可以设置该Button的具体导航情况：<br><img src="/img/Unity/ButtonUINavigation.PNG" alt="ButtonUINavigation"></li>
<li>Standalone Input Module<br><a href="https://docs.unity3d.com/ScriptReference/EventSystems.StandaloneInputModule.html" target="_blank" rel="external">Input module for working with, mouse, keyboard, or controller.</a><a href="https://docs.unity3d.com/ScriptReference/EventSystems.BaseInputModule.html" target="_blank" rel="external">An Input Module is a component of the EventSystem that is responsible for raising events and sending them to GameObjects for handling. </a><br>负责Input输入的控制，负责触发和发送事件到指定对象<br>Event System 触发流程<ol>
<li>使用者输入(触摸、键盘)</li>
<li>透过Scene中的Raycasters计算哪个元素被点中</li>
<li>使用Input Module，发送Event到指定对象<br>Canvas上的GraphicRaycaster负责设定UI相关的raycast信息响应：<br><img src="/img/Unity/GraphicRaycast.PNG" alt="GraphicRaycast"><br>同理<a href="http://k79k06k02k.com/blog/440/unity/unity-ugui-%E5%8E%9F%E7%90%86%E7%AF%87%E5%9B%9B%EF%BC%9Aevent-system-manager-%E4%BA%8B%E4%BB%B6%E8%88%87%E8%A7%B8%E7%99%BC" target="_blank" rel="external">PhycsicsRaycaster</a>会负责物理的raycast相关的信息响应。(比如响应位于一个含Collider3D物体之上)</li>
</ol>
</li>
</ol>
<p>Note:<br><a href="http://docs.unity3d.com/Manual/UICanvas.html" target="_blank" rel="external">UI elements in the Canvas are drawn in the same order they appear in the Hierarchy.(UI成员的绘制顺序和UI在Canvas下的顺序一致) </a></p>
<h3 id="UGUI_Atlas">UGUI Atlas</h3><p>以下学习参考<a href="http://www.xuanyusong.com/archives/3304" target="_blank" rel="external">UGUI研究院之全面理解图集与使用（三）</a><br>NGUI的Atlas是通过提前制作好，但UGUI里这一概念模糊了，我们通过设定Sprite的信息：<br><img src="/img/Unity/UGUISpriteEditor.PNG" alt="UGUISpriteEditor"><br>通过设置tag来决定图集tag。<br>然后在打包或主动使用Sprite Packer的时候会去打包图集，Sprite Packer设定Edit -&gt; Project Setting -&gt; Editor:<br><img src="/img/Unity/SpritePackerSetting.PNG" alt="SpritePackerSetting"><br>为了方便查看Sprite Packer打包和Draw call情况，我们采用Always Enable。<br>我们也可以通过打开Sprite Packer主动去查看图集的打包情况：<br><img src="/img/Unity/UGUISpritePacker.PNG" alt="UGUISpritePacker"><br>通过Profiler可以查看到当前Draw Call：<br><img src="/img/Unity/ProfilerDrawCall.PNG" alt="ProfilerDrawCall"><br>关于根据图片名字动态创建Sprite的方案(通过把小图片关联到Prefab上，然后通过Resources.load来加载来实现)以及图集在线更新方案(Assetbundle)参考<a href="http://www.xuanyusong.com/archives/3304" target="_blank" rel="external">UGUI研究院之全面理解图集与使用（三）</a><br>Note:<br>因为在同一个图集里所以，纹理图片只需加载一张，只需通过UV坐标切换就能实现渲染多个Sprite，所以在同一个图集里的Sprite渲染都放在一个Draw Call里就能完成。(关于Draw Call以后的学习再深入学习)<br>Resources下面的Sprite不会被打包到图集里。<br>图集的存放位置在Assets同级目录的Library/AtlasCache下</p>
<p>关于Font Atlas，UGUI采用<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#Font_Maker">动态字体</a>，我们直接导入.ttf等文件就能使用了。</p>
<h2 id="Multiplayer_Networking-1">Multiplayer Networking</h2><h3 id="The_Hight_Level_API">The Hight Level API</h3><p><a href="https://docs.unity3d.com/Manual/UNetOverview.html?_ga=1.102545928.827985704.1454244920" target="_blank" rel="external">Using this means you get access to commands which cover most of the common requirements for multiuser games without needing to worry about the “lower level” implementation details.</a><br>高层面的多人游戏网络传输的抽象，可以方便快速的用于制作简单的多人网络游戏。</p>
<p>多人网络概念:<br>Server and Host:<br><img src="/img/Unity/HLAPIHostAndClientRelationShip.PNG" alt="HLAPIHostAndClientRelationShip"><br><a href="https://docs.unity3d.com/Manual/UNetConcepts.html?_ga=1.102545928.827985704.1454244920" target="_blank" rel="external">The host is a server and a client in the same process. The host uses a special kind of client called the LocalClient, while other clients are RemoteClients. The LocalClient communicates with the (local) server through direct function calls and message queues, since it is in the same process. It actually shares the scene with the server. RemoteClients communicate with the server over a regular network connection.</a><br>Host和Client运行在一个Process里。一个Host多个Client，Host相当于本地通信，其他的Clients通过network通信。</p>
<p>支持实现如下功能：</p>
<ol>
<li>Control the networked state of the game using a “Network Manager”.(通过NetworkManager管理网络状态)</li>
<li>Operate “client hosted” games, where the host is also a player client.(运行Client Host游戏)</li>
<li>Serialize data using a general-purpose serializer.(序列化数据)</li>
<li>Send and receive network messages.(网络数据message发送接收)</li>
<li>Send networked commands from clients to servers.(从clients发送networked commands到servers)</li>
<li>Make remote procedure calls (RPCs) from servers to clients.(servers到clients的远程程序调用)</li>
<li>Send networked events from servers to clients.(从servers发送networed events到clients)</li>
</ol>
<p>实例学习参考<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#Multiplayer_Networking">Multiplayer Networking</a></p>
<p><a href="https://docs.unity3d.com/Manual/UNetUsingHLAPI.html" target="_blank" rel="external">The HLAPI is a new set of networking commands built into Unity, within a new namespace: UnityEngine.Networking.</a><br>在UnityEngine.Networking下HLAPI提供了大量方便的接口方法用于开发多人游戏。<br>让我们看看Unity里网络编程的大体框架结构：<br><img src="/img/Unity/HLAPILayerStructureOnNetwork.PNG" alt="HLAPILayerStructureOnNetwork"><br>更多内容待学习</p>
<h3 id="Using_The_Transport_Layer_API">Using The Transport Layer API</h3><p><a href="https://docs.unity3d.com/Manual/UNetUsingTransport.html" target="_blank" rel="external">The Transport Layer is a thin layer working on top of the operating system’s sockets-based networking. It’s capable of sending and receiving messages represented as arrays of bytes, and offers a number of different “quality of service” options to suit different scenarios. It is focused on flexibility and performance, and exposes an API within the UnityEngine.Networking.NetworkTransport class.</a><br>基于Socket-based networking的底层接口，用于实现自定义的网络传输。</p>
<p>Support two protocols:</p>
<ol>
<li>UDP for generic communications</li>
<li>WebSockets for WebGL<br>更多内容待学习</li>
</ol>
<h2 id="Unity_Shader">Unity Shader</h2><p>详情参见<a href="http://tonytang1990.github.io/2016/12/20/Unity-Shader/">Unity_Shader</a></p>
<h2 id="Excel数据读取">Excel数据读取</h2><p>Unity官网给出TextAsset类用于读取下列格式的文件：<br>.txt, .html, .htm, .xml, .bytes, .json, .csv(<a href="http://baike.baidu.com/link?url=k66qCiCo7dQ2gA3bS09xk_ZhFBldafez_7Ux64tJvvwAx2HcsLW3cFIaKoGua_HnlHV3nnDgHL5NdqwSKHEV_KHhRVEm-B0mYguaAcxSFDm" target="_blank" rel="external">逗号分隔值（Comma-Separated Values，CSV，有时也称为字符分隔值，因为分隔字符也可以不是逗号），其文件以纯文本形式存储表格数据（数字和文本）</a>), .yaml, .fnt<br>从上面可以看出并不支持直接对excel(.xlsx，.xls等格式)的解析。<br>通过官网可以看出TextAsset是针对文本和二进制类型文件的读取，具体的解析还得自己去写。<br>所以并不是我想找的Excel解析的解决方案。<br>让我们来看看这篇文章<a href="http://www.mamicode.com/info-detail-494944.html" target="_blank" rel="external">Unity3D游戏开发之当游戏开发遇上Excel</a>。<br>作者对Excel解析下了不少功夫。<br>从上面可以看出，针对Excel解析作者找到了三中解决方案：</p>
<ol>
<li>Microsoft.Office.Interop.Excel<br><a href="http://www.mamicode.com/info-detail-494944.html" target="_blank" rel="external">基于微软提供的Office API,这组API以COM组件的形式给出，我们可以通过调用该API实现对Excel文件的解析。微软的Office API特点是使用起来方便，可以使用C#、Visual Basic等语言进行相关开发。可是这种解决方案的的缺点同样很明显，因为COM组件主要依赖于系统，因此使用COM组件需要在系统中注册，这将对代码的可移植性产生影响，而且受制于COM技术，这种解决方案只能运行在Windows平台上，无法实现跨平台，加之解析速度较慢，因此这种方案通常只适合在解析速度要求不高，运行环境为Windows平台的应用场景。</a><br>关键词：<br>不跨平台</li>
<li>ExcelReader<br>ExcelRead就是跨平台目标下解析Excel文件的首选方案。<br><a href="http://exceldatareader.codeplex.com/" target="_blank" rel="external">ExcelRead website</a><br>从描述来看支持Windows和OS X，Linux等(注意不包含移动端IOS和Android)。但就PC端来看已经足够作为解析Excel的方式了。<br>Note：<br>针对移动端的时候可以采用先在PC端把数据读取出来写到单独的数据文件，然后再到移动端去读取解析。</li>
<li>FastExcel<br>FastExcel是一个在开源世界里的一个java编写的工具。<a href="http://fastexcel.sourceforge.net/" target="_blank" rel="external">FastExcel Website</a>。官网上有简单demo方便快速集成。</li>
</ol>
<p>接下来我选择以ExcelReader为解决方案，尝试使用ExcelReader来解析Excel。</p>
<ol>
<li>下载Dll，官网的建议是直接下载DLL来用<br><a href="http://exceldatareader.codeplex.com/" target="_blank" rel="external">ExcelReader DLL Download</a><br>可以看到主要有两个DLL(Excel.4.5.dll &amp; ICSharpCode.SharpZiplib.dll)<br><img src="/img/Unity/ExcelReaderDLL.PNG" alt="ExcelReaderDLL"></li>
<li>导入DLL到Unity(Unity对Managed Plugins支持很方便，直接在Asset下创建一个目录copy进去即可)<br>Note:<br>这里要注意的一点，需要采用基于.net 2.0的dll而非基于.net 4.5的(我想是由于mono还不支持所有.net的特性导致的)</li>
<li>通过导入命名空间就可以正常使用ExcelReader库了<br>以下是根据代码参考<a href="http://www.mamicode.com/info-detail-494944.html" target="_blank" rel="external">Unity3D游戏开发之当游戏开发遇上Excel</a>和<a href="http://www.xuanyusong.com/archives/2429" target="_blank" rel="external">Unity3D研究院之MAC&amp;Windows跨平台解析Excel（六十五）</a>和<a href="http://exceldatareader.codeplex.com/" target="_blank" rel="external">Excel Data Reader - Read Excel files in .NET</a>：<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> Excel;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameConfigurationManager</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GameConfigurationManager mLMInstance = <span class="keyword">new</span> GameConfigurationManager();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ConfigurationPath</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mConfigurationPath = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> mConfigurationPath = <span class="string">"/Configuration/AccountPasswordAndGameSetting.xlsx"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> mIsConfigurationComplete = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GameConfigurationManager</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!mIsConfigurationComplete)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">               ReadConfiguration();</span><br><span class="line">                mIsConfigurationComplete = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsConfigurationComplete = <span class="keyword">false</span>;</span><br><span class="line">                Debug.Log(<span class="string">"Exception "</span> + e.ToString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReadConfiguration</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        Debug.Log(<span class="string">"Application.dataPath = "</span> + Application.dataPath);</span><br><span class="line">        Debug.Log(<span class="string">"mConfigurationPath = "</span> + mConfigurationPath);</span><br><span class="line"></span><br><span class="line">        FileStream stream = File.Open(Application.dataPath + mConfigurationPath, FileMode.Open, FileAccess.Read);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reading from a excel file</span></span><br><span class="line">        IExcelDataReader excelreader = ExcelReaderFactory.CreateOpenXmlReader(stream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// DataSet -- the result of each spreadsheet will be created in the result tables</span></span><br><span class="line">        DataSet result = excelreader.AsDataSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> sheetcount = result.Tables.Count;</span><br><span class="line">        Debug.Log(<span class="string">"sheetcount = "</span> + sheetcount);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> m = <span class="number">0</span>; m &lt; sheetcount; m++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> rows = result.Tables[m].Rows.Count;</span><br><span class="line">            <span class="keyword">int</span> columns = result.Tables[m].Columns.Count;</span><br><span class="line">            Debug.Log(<span class="keyword">string</span>.Format(<span class="string">"Table[&#123;0&#125;] with row = &#123;1&#125; columns = &#123;2&#125;"</span>, m, rows, columns));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rows; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; columns; j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">string</span> <span class="keyword">value</span> = result.Tables[m].Rows[i][j].ToString();</span><br><span class="line">                    Debug.Log(<span class="keyword">string</span>.Format(<span class="string">"result.Tables[&#123;0&#125;].Rows[&#123;1&#125;][&#123;2&#125;] = &#123;3&#125;"</span>,m,i,j,<span class="keyword">value</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        excelreader.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>通过上述方法我成功的打印出了AccountPasswordAndGameSetting.xlsx里2个sheet的数据，见下图：<br><img src="/img/Unity/AccountPasswordAndGameSettingSheet1.PNG" alt="AccountPasswordAndGameSettingSheet1"><br><img src="/img/Unity/AccountPasswordAndGameSettingSheet2.PNG" alt="AccountPasswordAndGameSettingSheet2"><br><img src="/img/Unity/ExcelReaderOutput.PNG" alt="ExcelReaderOutput"><br>Note:<br>上面有用到DataSet，DataSet类是属于System.Data.dll里的，所以我们还必须Copy存放在**\Unity\Editor\Data\Mono\lib\mono\2.0下的System.Data.dll到我们的Dlls目录。</p>
<h2 id="资源管理">资源管理</h2><p>详情参见<a href="http://tonytang1990.github.io/2016/10/13/Unity-Resource-Manager/">Unity-Resource-Manager</a></p>
<h1 id="Plugins">Plugins</h1><p>详情参见<a href="http://tonytang1990.github.io/2016/12/11/Unity-Plugins/">Unity-Plugins</a></p>
<h1 id="C#脚本">C#脚本</h1><p>public成员 — 编辑器可见可编辑<br>[System.Serializable] — 标志该类可以被序列化到Inspector<br>[HideInInspector] — 标志该成员在编辑器不可见<br>StartCoroutine（Function()） &amp;&amp;  yield &amp;&amp; WaitForSeconds — 联合使用可以实现对游戏逻辑的等待判断（多线程访问控制）<br>GameObject.FindGameObjectWithTag(Name) — 用于寻找特定tag的对象<br>Virtual Method — Virtual Method使该方法可以被重写<br>abstract — 定义该类是抽象类 &amp;&amp; 该方法是抽象方法（需要被子类实现）</p>
<h2 id="Persistence_-_Saving_and_Loading_Data">Persistence - Saving and Loading Data</h2><h3 id="PlayerPrefs">PlayerPrefs</h3><p>Stores and accesses player preferences between game sessions. (用于存储一些不重要的用户设定的数据，比如游戏分辨率，游戏难度等)</p>
<p>IOS里面的.plist文件，Andoid里面的Preference(程序数据文件)</p>
<h3 id="Seralization"><a href="http://docs.unity3d.com/Manual/script-Serialization.html" target="_blank" rel="external">Seralization</a></h3><h4 id="What_is_seralization?">What is seralization?</h4><p>serialization is the process of converting the state an object to a set of bytes in order to store (or transmit) the object into memory, a database or a file.</p>
<h4 id="C#_Serialization">C# Serialization</h4><p>GameController.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> GameController mController;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> PlayerData mPlayerData;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> mPreferenceHealth = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">string</span> mPlayerSavePath;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mController == <span class="keyword">null</span>) &#123;</span><br><span class="line">			DontDestroyOnLoad (gameObject);</span><br><span class="line">			mController = <span class="keyword">this</span>;</span><br><span class="line">		&#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">mController != <span class="keyword">this</span></span>) </span>&#123;</span><br><span class="line">			Destroy(gameObject);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mPlayerData = <span class="keyword">new</span> PlayerData ();</span><br><span class="line"></span><br><span class="line">		mPlayerSavePath = Application.persistentDataPath + <span class="string">"/playerInfo.dat"</span>;</span><br><span class="line">		Debug.Log (<span class="string">"mPlayerSavePath = "</span> + mPlayerSavePath);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		GUI.Label (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">10</span>, <span class="number">200</span>, <span class="number">30</span>), <span class="string">"Preference Health: "</span> + mPreferenceHealth);</span><br><span class="line">		GUI.Label (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">30</span>), <span class="string">"mPlayerData.mHealth: "</span> + mPlayerData.mHealth);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">90</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">"Increase Health"</span>)) &#123;</span><br><span class="line">			mPreferenceHealth += <span class="number">10</span>;</span><br><span class="line">			mPlayerData.mHealth += <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">130</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">"Decrease Health"</span>)) &#123;</span><br><span class="line">			mPreferenceHealth -= <span class="number">10</span>;</span><br><span class="line">			mPlayerData.mHealth -= <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">170</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">"Save File"</span>)) &#123;</span><br><span class="line">			Save ();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">210</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">"Load File"</span>)) &#123;</span><br><span class="line">			Load ();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">250</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">"Save Preference"</span>)) &#123;</span><br><span class="line">			SavePreference ();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">290</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">"Load Preference"</span>)) &#123;</span><br><span class="line">			LoadPreference ();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Save</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		Debug.Log (<span class="string">"Application.persistentDataPath = "</span> + Application.persistentDataPath);</span><br><span class="line">		<span class="keyword">if</span> (!File.Exists (mPlayerSavePath)) &#123;</span><br><span class="line">			FileStream fsc = File.Create(mPlayerSavePath);</span><br><span class="line">			fsc.Close();</span><br><span class="line">		&#125;</span><br><span class="line">		BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line">		FileStream fs = File.Open (mPlayerSavePath, FileMode.Open);</span><br><span class="line">		</span><br><span class="line">		bf.Serialize (fs, mPlayerData);</span><br><span class="line">		fs.Close ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Load</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(File.Exists(mPlayerSavePath))</span><br><span class="line">	    &#123;</span><br><span class="line">			BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">			FileStream fs = File.Open(mPlayerSavePath,FileMode.Open);</span><br><span class="line">			mPlayerData = (PlayerData)bf.Deserialize(fs);</span><br><span class="line">			fs.Close();</span><br><span class="line">			Debug.Log(<span class="string">"Load: mPlayerData.mHealth = "</span> + mPlayerData.mHealth);</span><br><span class="line">			Debug.Log(<span class="string">"Load: mPlayerData.mB.BuildingType = "</span> + mPlayerData.mB.mBT);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SavePreference</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">//Player preference</span></span><br><span class="line">		PlayerPrefs.SetFloat (<span class="string">"Health"</span>, mPreferenceHealth);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadPreference</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		Debug.Log(<span class="string">"Pre Health = "</span> + PlayerPrefs.GetFloat(<span class="string">"Health"</span>));</span><br><span class="line">		mPreferenceHealth = PlayerPrefs.GetFloat (<span class="string">"Health"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerData</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> mHealth = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Building mB = <span class="keyword">new</span> Building();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> BuildingType</span><br><span class="line">&#123;</span><br><span class="line">	E_WALL = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Building</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> BuildingType mBT = BuildingType.E_WALL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/Unity/Perssistence_PlayerPrefs_Serialization.PNG" alt="Screnn Shot"></p>
<p>Note:<br>Cross Platform except Web</p>
<h3 id="Unity_Editor_Window,_Menu_Item_&amp;_ScriptableObject">Unity Editor Window, Menu Item &amp; ScriptableObject</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyScriptableObject</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">string</span> mID = <span class="string">"1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Use Editor Window to edit ScriptObject data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> mValue = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	[MenuItem(<span class="string">"Window/MyEditorWindow"</span>)]</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		MyEditorWindow window = (MyEditorWindow)EditorWindow.GetWindow (<span class="keyword">typeof</span>(MyEditorWindow));</span><br><span class="line">		window.Show ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		MyScriptableObject asset = ScriptableObject.CreateInstance&lt;MyScriptableObject&gt; ();</span><br><span class="line">		asset = AssetDatabase.LoadAssetAtPath(<span class="string">"Assets/MyScriptableObject.asset"</span>,<span class="keyword">typeof</span>(MyScriptableObject)) <span class="keyword">as</span> MyScriptableObject;</span><br><span class="line">		mValue = asset.mID;</span><br><span class="line">		Debug.Log (<span class="string">"mValue = "</span> + mValue);</span><br><span class="line"></span><br><span class="line">		Debug.Log(<span class="string">"OnGUI"</span>);</span><br><span class="line">		GUILayout.Label (<span class="string">"mID"</span>, EditorStyles.boldLabel);</span><br><span class="line">		<span class="keyword">string</span> value2 = EditorGUILayout.TextField (<span class="string">"ID"</span>,mValue);</span><br><span class="line">		<span class="keyword">if</span> (GUILayout.Button (<span class="string">"Save"</span>, EditorStyles.miniButton)) &#123;</span><br><span class="line">			Debug.Log(<span class="string">"Save Button Clicked"</span>);</span><br><span class="line">			MyScriptableObject asset2 = ScriptableObject.CreateInstance&lt;MyScriptableObject&gt; ();</span><br><span class="line">			asset2.mID = value2;</span><br><span class="line">			AssetDatabase.CreateAsset (asset2, <span class="string">"Assets/MyScriptableObject.asset"</span>);</span><br><span class="line">			AssetDatabase.SaveAssets ();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Menu Item Study</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyMenuItems</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//Normal Menu Item</span></span><br><span class="line">	[MenuItem(<span class="string">"Tools/CreateScriptableAssets %q"</span>)]</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Save</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		MyScriptableObject asset = ScriptableObject.CreateInstance&lt;MyScriptableObject&gt; ();</span><br><span class="line">		asset.mID = <span class="string">"2"</span>;</span><br><span class="line">		AssetDatabase.CreateAsset (asset, <span class="string">"Assets/MyScriptableObject.asset"</span>);</span><br><span class="line">		AssetDatabase.SaveAssets ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	[MenuItem(<span class="string">"Tools/LoadScriptableAssets %w"</span>)]</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Load</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Context Menu Item</span></span><br><span class="line">	[MenuItem(<span class="string">"Assets/ContextMenuItem"</span>)]</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ContextMenuItem</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">		Debug.Log(<span class="string">"ContextMenuItem()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	[MenuItem(<span class="string">"CONTEXT/Transform/ContextMenuItem"</span>)]</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ContextMenuItem2</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		Debug.Log (<span class="string">"ContextMenuItem2"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	[MenuItem(<span class="string">"Assets/Create/ContextMenuItem"</span>)]</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ContextMenuItem3</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		Debug.Log (<span class="string">"ContextMenuItem3"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过自定义Menu Item的功能，我们可以快速创建一些我们所需要的原件</p>
<p>通过自定义Editor Window，我们可以用于制作特定数据的编辑框</p>
<p>ScriptableObject主要用于存储一些不重要的数据，和Monobehaviour的主要区别就是不用attach到游戏对象上，需要通过CreateInstance的方式来创建</p>
<p>结合自定义Editor Window和ScriptableObject的存储，我们可以通过自定义编辑框自定义数据并使用</p>
<p><img src="/img/Unity/EditorWindow_ScriptableObject.PNG" alt="Screnn Shot"></p>
<h2 id="Coroutine">Coroutine</h2><p><a href="https://unitygem.wordpress.com/coroutines/" target="_blank" rel="external">Reference Website</a></p>
<h3 id="Why_are_we_using_coroutines?">Why are we using coroutines?</h3><ol>
<li>Making things happen step by step</li>
<li>Writing routines that need to happen over time</li>
<li>Writing routines that have to wait for another operation to complete</li>
</ol>
<h3 id="What_is_a_coroutine?">What is a coroutine?</h3><p>Coroutines are not threads and coroutines are not asynchronous.</p>
<p>A coroutine is a function that is executed partially and, presuming suitable conditions are met, will be resumed at some point in the future until its work is done.<br>The start of a coroutine corresponds to the creation of an object of type coroutine. That object is tied to the MonoBehaviour component that hosted the call.</p>
<h3 id="How_long_is_the_life_cycle?_&amp;_When_does_coroutine_get_called?">How long is the life cycle? &amp; When does coroutine get called?</h3><p>The lifetime of the Coroutine object is bound to the lifetime of the MonoBehaviour object, so if the latter gets destroyed during process, the coroutine object is also destroyed. <em>Whenever game object that is bound to coroutine is destroyed or inactive(e.g. gameobject.SetActive(false), Destroy(gameobject)), the coroutine will stop to be called. Coroutine is run until a yield is found.</em></p>
<p>GameController.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment">//For Menu Item</span></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> GameController mController;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject mCoroutineObject;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> mInputTimer = <span class="number">0.0</span>f;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> mValidInputDeltaTime = <span class="number">0.5</span>f;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mController == <span class="keyword">null</span>) &#123;</span><br><span class="line">			DontDestroyOnLoad (gameObject);</span><br><span class="line">			mController = <span class="keyword">this</span>;</span><br><span class="line">		&#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">mController != <span class="keyword">this</span></span>) </span>&#123;</span><br><span class="line">			Destroy(gameObject);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		mInputTimer += Time.deltaTime;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (mInputTimer &gt; mValidInputDeltaTime) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Input.GetKey (KeyCode.C)) &#123;</span><br><span class="line">				mInputTimer = <span class="number">0.0</span>f;</span><br><span class="line">				Debug.Log (<span class="string">"Ative Coroutine Game Object"</span>);</span><br><span class="line">				mCoroutineObject.SetActive (<span class="keyword">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mInputTimer &gt; mValidInputDeltaTime) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Input.GetKey (KeyCode.U)) &#123;</span><br><span class="line">				mInputTimer = <span class="number">0.0</span>f;</span><br><span class="line">				Debug.Log (<span class="string">"UnAtive Coroutine Game Object"</span>);</span><br><span class="line">				mCoroutineObject.SetActive (<span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mInputTimer &gt; mValidInputDeltaTime) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Input.GetKey (KeyCode.E)) &#123;</span><br><span class="line">				mInputTimer = <span class="number">0.0</span>f;</span><br><span class="line">				Debug.Log (<span class="string">"Enable Coroutine MonoBehaviour"</span>);</span><br><span class="line">				mCoroutineObject.GetComponent&lt;CoroutineStudy&gt;().enabled = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mInputTimer &gt; mValidInputDeltaTime) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Input.GetKey (KeyCode.D)) &#123;</span><br><span class="line">				mInputTimer = <span class="number">0.0</span>f;</span><br><span class="line">				Debug.Log (<span class="string">"Desable Coroutine MonoBehaviour"</span>);</span><br><span class="line">				mCoroutineObject.GetComponent&lt;CoroutineStudy&gt;().enabled = <span class="keyword">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mInputTimer &gt; mValidInputDeltaTime) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Input.GetKey (KeyCode.K)) &#123;</span><br><span class="line">				mInputTimer = <span class="number">0.0</span>f;</span><br><span class="line">				Debug.Log (<span class="string">"Destroy Coroutine Game Object"</span>);</span><br><span class="line">				Destroy(mCoroutineObject);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>CoroutineStudy.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoroutineStudy</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">string</span> mCoroutineText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> isFixedCall = <span class="keyword">false</span>;  <span class="comment">//Makesure Update() and LateUpdate() and FixedUpdate() Log only once  </span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> isUpdateCall = <span class="keyword">false</span>;  </span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> isLateUpdateCall = <span class="keyword">false</span>;  </span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		mCoroutineText = <span class="string">""</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		GUI.Label (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">10</span>, <span class="number">200</span>, <span class="number">30</span>), <span class="string">"Coroutine Text: "</span> + mCoroutineText);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">400</span>, <span class="number">10</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">"Start Coroutine"</span>)) &#123;</span><br><span class="line">			mCoroutineText = <span class="string">""</span>;</span><br><span class="line">			StartCoroutine (CoroutineCall ());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isFixedCall)  </span><br><span class="line">		&#123;  </span><br><span class="line">			Debug.Log(<span class="string">"FixedUpdate Call Begin"</span>);  </span><br><span class="line">			StartCoroutine(FixedCoutine());  </span><br><span class="line">			Debug.Log(<span class="string">"FixedUpdate Call End"</span>);  </span><br><span class="line">			isFixedCall = <span class="keyword">true</span>;  </span><br><span class="line">		&#125;  </span><br><span class="line">	&#125;  </span><br><span class="line">	</span><br><span class="line">	<span class="function">IEnumerator <span class="title">FixedCoutine</span>(<span class="params"></span>)  </span><br><span class="line">	</span>&#123;  </span><br><span class="line">		Debug.Log(<span class="string">"This is Fixed Coroutine Call Before"</span>);  </span><br><span class="line">		<span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">		Debug.Log(<span class="string">"This is Fixed Coroutine Call After"</span>);  </span><br><span class="line">	&#125;  </span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isUpdateCall)  </span><br><span class="line">		&#123;  </span><br><span class="line">			Debug.Log(<span class="string">"Update Call Begin"</span>);  </span><br><span class="line">			StartCoroutine(UpdateCoutine());  </span><br><span class="line">			Debug.Log(<span class="string">"Update Call End"</span>);  </span><br><span class="line">			isUpdateCall = <span class="keyword">true</span>;  </span><br><span class="line">		&#125;  </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">IEnumerator <span class="title">UpdateCoutine</span>(<span class="params"></span>)  </span><br><span class="line">	</span>&#123;  </span><br><span class="line">		Debug.Log(<span class="string">"This is Update Coroutine Call Before"</span>);  </span><br><span class="line">		<span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">		Debug.Log(<span class="string">"This is Update Coroutine Call After"</span>);  </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isLateUpdateCall)  </span><br><span class="line">		&#123;  </span><br><span class="line">			Debug.Log(<span class="string">"LateUpdate Call Begin"</span>);  </span><br><span class="line">			StartCoroutine(LateCoutine());  </span><br><span class="line">			Debug.Log(<span class="string">"LateUpdate Call End"</span>);  </span><br><span class="line">			isLateUpdateCall = <span class="keyword">true</span>;  </span><br><span class="line">		&#125;  </span><br><span class="line">	&#125;  </span><br><span class="line"></span><br><span class="line">	<span class="function">IEnumerator <span class="title">LateCoutine</span>(<span class="params"></span>)  </span><br><span class="line">	</span>&#123;  </span><br><span class="line">		Debug.Log(<span class="string">"This is Late Coroutine Call Before"</span>);  </span><br><span class="line">		<span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">		Debug.Log(<span class="string">"This is Late Coroutine Call After"</span>);  </span><br><span class="line">	&#125;  </span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> IEnumerator <span class="title">CoroutineCall</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">20</span>; i++) &#123;</span><br><span class="line">			mCoroutineText = i.ToString();</span><br><span class="line">			Debug.Log(<span class="string">"Coroutine Text: "</span> + mCoroutineText);</span><br><span class="line">			<span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">1.0</span>f</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		mCoroutineText = <span class="string">"Finished"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">```</span><br></pre></td></tr></table></figure></p>
<p>ScreenShots<br><img src="/img/Unity/Unity_Coroutine_LifeTime.PNG" alt="The relationship between Coroutine Life Time and Monobehaviour &amp; GameObejct"></p>
<p><img src="/img/Unity/Unity_Coroutine_LifeTime_Monobehaviour.PNG" alt="The relationship between Coroutine Life Time and Monobehaviour"></p>
<p>Note:<br>Diable Monobehaviour(e.g. Monobehaviour.enabled = false) will not influence coroutine.</p>
<p>Coroutine with yiled return null will get called after LateUpdate()(仅根据上面的测试结果)<br>通过返回WaitForSeconds() || WaitForEndOfFrame() || WaitForFixedUpdate() 等yield return 支持的返回类型可以实现coroutine在特定时刻继续调用</p>
<p>StartCoroutine()支持嵌套调用用于实现特定等待特定运算后继续执行特定代码</p>
<h3 id="How_to_stop_coroutines?">How to stop coroutines?</h3><p>IEnumerator coroutine = WaitForSeconds(3.0f);<br>StartCoroutine(coroutine);<br>StopCoroutine(coroutine);</p>
<p>Note:<br>注意如果gameobject处于InActive或则has been destroyed,Coroutine不会再被调用，可以通过Monobehaviour.enabled = false来实现使物体不可见但会出发coroutine的效果</p>
<h3 id="Go_depth_in_Coroutine">Go depth in Coroutine</h3><p>参考文章:<a href="http://blog.csdn.net/tkokof1/article/details/11842673" target="_blank" rel="external">Coroutine，你究竟干了什么？</a></p>
<p>在更深入了解coroutine之前让我们先了解下什么是IEnumerator和yield？<br><em>IEnumrator</em><br><a href="https://msdn.microsoft.com/en-us/library/system.collections.ienumerator(v=vs.110" target="_blank" rel="external">Supports a simple iteration over a non-generic collection.</a>.aspx)<br>在C#里IEnumerator组要是为了自定义类型支持迭代器访问.</p>
<p><em>yield</em><br>yield是C# 2.0引入的特性,表明调用yield的方法是iterator.每一次的迭代访问该方法，都会调用MoveNext()方法，而调用MoveNext()方法的时候就会执行该方法代码，但如果执行IEnumerator方法到yield的时候，该方法就会返回并且记录下yield的位置，并在下一次调用该方法的时候继续执行。</p>
<p>通过yield break我们可以结束方法迭代。</p>
<p>为什么要提IEnumerator和yield了？<br>因为Coroutine其实就是一个IEnumerator的迭代器。</p>
<p>在我们调用StartCoroutine的时候迭代器就被我们添加到了coroutine列表中<br>而Coroutine管理者会每一帧去迭代访问判断每一个coroutine是否达到条件可以删除并继续执行</p>
<p>CoroutineManager.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoroutineYieldInstruction</span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsDone</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoroutineWaitForSeconds</span> : <span class="title">CoroutineYieldInstruction</span>&#123;</span><br><span class="line">	<span class="keyword">float</span> m_WaitTime;</span><br><span class="line">	<span class="keyword">float</span> m_StartTime;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CoroutineWaitForSeconds</span>(<span class="params"><span class="keyword">float</span> waittime</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		m_WaitTime = waittime;</span><br><span class="line">		m_StartTime = -<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">IsDone</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_StartTime &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			m_StartTime = Time.time;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//check elapsed time</span></span><br><span class="line">		<span class="keyword">return</span> (Time.time - m_StartTime) &gt;= m_WaitTime;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoroutineManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> CoroutineManager Instance &#123;</span><br><span class="line">		<span class="keyword">get</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	List&lt;System.Collections.IEnumerator&gt; m_Enumerators = <span class="keyword">new</span> List&lt;System.Collections.IEnumerator&gt;();</span><br><span class="line"></span><br><span class="line">	List&lt;System.Collections.IEnumerator&gt; m_EnumeratorsBuffer = <span class="keyword">new</span> List&lt;System.Collections.IEnumerator&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (Instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">			Instance = <span class="keyword">this</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			Debug.Log (<span class="string">"Multi-instances of CouroutineManager"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span>(<span class="params"></span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_Enumerators.Count; i++) &#123;</span><br><span class="line">			<span class="comment">//handle special enumerator</span></span><br><span class="line">			<span class="keyword">if</span>(m_Enumerators[i].Current <span class="keyword">is</span> CoroutineYieldInstruction)</span><br><span class="line">			&#123;</span><br><span class="line">				CoroutineYieldInstruction yiledinstruction = m_Enumerators[i] .Current <span class="keyword">as</span> CoroutineYieldInstruction;</span><br><span class="line">				<span class="keyword">if</span>(!yiledinstruction.IsDone())&#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//Do normal move next</span></span><br><span class="line">			<span class="keyword">if</span>(!m_Enumerators[i].MoveNext())&#123;</span><br><span class="line">				m_EnumeratorsBuffer.Add(m_Enumerators[i]);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//remove end enumerator</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_EnumeratorsBuffer.Count; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			m_Enumerators.Remove(m_EnumeratorsBuffer[i]);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		m_EnumeratorsBuffer.Clear ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartCoroutineSimple</span>(<span class="params">System.Collections.IEnumerator enumerator</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		m_Enumerators.Add (enumerator);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ScreenShots<br><img src="/img/Unity/Coroutine_Study.PNG" alt="My Own Coroutine"></p>
<h1 id="Unity优化注意事项">Unity优化注意事项</h1><h2 id="Code">Code</h2><h3 id="Use_For_or_while_instead_of_foreach">Use For or while instead of foreach</h3><p>Foreach在通过Mono编译后会造成额外的内存分配（通过VS编译好像不会 — 这个未测试）<br><a href="https://www.zhihu.com/question/30334270" target="_blank" rel="external">参考网站</a></p>
<p>ForEachAndFor.cs<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;&#10;using System.Collections;&#10;using System.Collections.Generic;&#10;&#10;public class ForEachAndFor : MonoBehaviour &#123;&#10;&#10;    private List&#60;int&#62; mTestList;&#10;&#10;&#9;// Use this for initialization&#10;&#9;void Start () &#123;&#10;        mTestList = new List&#60;int&#62;(1000);&#10;        for(int i = 0; i &#60; mTestList.Count; i++)&#10;        &#123;&#10;            mTestList[i] = i;&#10;        &#125;&#10;&#9;&#125;&#10;&#9;&#10;&#9;// Update is called once per frame&#10;&#9;void Update () &#123;&#10;&#9;   &#10;        foreach(var it in mTestList)&#10;        &#123;&#10;&#10;        &#125;&#10;        /*&#10;        for(int i = 0; i &#60; mTestList.Count; i++)&#10;        &#123;&#10;&#10;        &#125;&#10;        */&#10;&#9;&#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>ScreenShorts:<br><img src="/img/Unity/ForEachCall.PNG" alt="ForeachCall"><br><img src="/img/Unity/ForCall.PNG" alt="ForCall"></p>
<p>从上面的测试结果可以看出foreach确实分配了额外40B的内存开销</p>
<p>让我们看看foreach代码反编译后的样子(我用的ILSpy)：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">using System;&#10;using System.Collections.Generic;&#10;using UnityEngine;&#10;&#10;public class ForEachAndFor : MonoBehaviour&#10;&#123;&#10;&#9;private List&#60;int&#62; mTestList;&#10;&#10;&#9;private void Start()&#10;&#9;&#123;&#10;&#9;&#9;this.mTestList = new List&#60;int&#62;(1000);&#10;&#9;&#9;for (int i = 0; i &#60; this.mTestList.get_Count(); i++)&#10;&#9;&#9;&#123;&#10;&#9;&#9;&#9;this.mTestList.set_Item(i, i);&#10;&#9;&#9;&#125;&#10;&#9;&#125;&#10;&#10;&#9;private void Update()&#10;&#9;&#123;&#10;&#9;&#9;using (List&#60;int&#62;.Enumerator enumerator = this.mTestList.GetEnumerator())&#10;&#9;&#9;&#123;&#10;&#9;&#9;&#9;while (enumerator.MoveNext())&#10;&#9;&#9;&#9;&#123;&#10;&#9;&#9;&#9;&#9;int current = enumerator.get_Current();&#10;&#9;&#9;&#9;&#125;&#10;&#9;&#9;&#125;&#10;&#9;&#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面看看不出为什么会有内存分配<br>让我们通过IL反编译工具看生成的IL底层内容（通过IL反编译工具，安装VS就自带的）<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.method private hidebysig instance void  Update() cil managed&#10;&#123;&#10;  // &#20195;&#30721;&#22823;&#23567;       55 (0x37)&#10;  .maxstack  8&#10;  .locals init (int32 V_0,&#10;           valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&#60;int32&#62; V_1)&#10;  IL_0000:  ldarg.0&#10;  IL_0001:  ldfld      class [mscorlib]System.Collections.Generic.List`1&#60;int32&#62; ForEachAndFor::mTestList&#10;  IL_0006:  callvirt   instance valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&#60;!0&#62; class [mscorlib]System.Collections.Generic.List`1&#60;int32&#62;::GetEnumerator()&#10;  IL_000b:  stloc.1&#10;  .try&#10;  &#123;&#10;    IL_000c:  br         IL_0019&#10;    IL_0011:  ldloca.s   V_1&#10;    IL_0013:  call       instance !0 valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&#60;int32&#62;::get_Current()&#10;    IL_0018:  stloc.0&#10;    IL_0019:  ldloca.s   V_1&#10;    IL_001b:  call       instance bool valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&#60;int32&#62;::MoveNext()&#10;    IL_0020:  brtrue     IL_0011&#10;    IL_0025:  leave      IL_0036&#10;  &#125;  // end .try&#10;  finally&#10;  &#123;&#10;    IL_002a:  ldloc.1&#10;    IL_002b:  box        valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&#60;int32&#62;&#10;    IL_0030:  callvirt   instance void [mscorlib]System.IDisposable::Dispose()&#10;    IL_0035:  endfinally&#10;  &#125;  // end handler&#10;  IL_0036:  ret&#10;&#125; // end of method ForEachAndFor::Update</span><br></pre></td></tr></table></figure></p>
<p>可以看出Mono编译出来的代码在finally进行了一次将valuetype的Enumerator，boxing的过程（这里并不是非常明白底层代码对应的代码，但看大概意思应该是using那里编译后导致的boxing）</p>
<p><a href="https://msdn.microsoft.com/en-us/library/yz2be5wk.aspx" target="_blank" rel="external">关于Box和Unbox参考</a><br>从官网可以看出在Boxing Value type的时候会将信息临时存储在Heap上从而造成的额外内存开销</p>
<h2 id="Rendering">Rendering</h2><p>减少渲染的物体数量和精度</p>
<h2 id="Physic">Physic</h2><h3 id="Close_Unnecessary_Collision">Close Unnecessary Collision</h3><p>(Edit -&gt; Project Settings -&gt; Physics)<br>只打开需要碰撞检测的Layer之间的碰撞检测</p>
<h2 id="Memory">Memory</h2><h3 id="Avoid_Uneccessary_GC">Avoid Uneccessary GC</h3><p>尽量重复使用申请的内存，不要每一次都重新申请</p>
<h1 id="游戏相关">游戏相关</h1><h2 id="Shuffle_Bag">Shuffle Bag</h2><p>在Unity和C#中有Random Class，可以为我们提供伪随机数，但伪随机数毕竟不是真正的随机，并且无法保证各个事件发生的几率，这样一来会导致我们的游戏趣味性大大降低。</p>
<p>一下学习参考:<br><a href="https://gamedevelopment.tutsplus.com/tutorials/shuffle-bags-making-random-feel-more-random--gamedev-1249" target="_blank" rel="external">Shuffle Bags: Making Random() Feel More Random</a><br><a href="https://web.archive.org/web/20150324141028/http://kaioa.com/node/53" target="_blank" rel="external">Never-ending Shuffled Sequences - When Random is too Random</a><br>实现参考:<br><a href="https://gist.github.com/mstevenson/4050130" target="_blank" rel="external">Shuffle bag algorithm implemented in C# </a><br>那么什么是Shuffle Bag了？<br>“<br>A Shuffle Bag is a technique for controlling randomness to create the distribution we desire. The idea is:<br>Pick a range of values with the desired distribution.<br>Put all these values into a bag.<br>Shuffle the bag’s contents.<br>Pull the values out one by one until you reach the end.<br>Once you reach the end, you start over, pulling the values out one by one again.<br>“<br>从上面可以看出Shuffle Bag主要是通过把所有可能都放到List里，然后通过随机选择在里面选取一个，而被选择过的不记入下一次选择考虑范围内，直到List里所有可能都被选择完为止。<br>这样一来List里填充的数据就确定了每一个事件发生的概率。<br>并且只通过一次填充数据就能无限随机选择下去。</p>
<p>代码实现：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line"></span><br><span class="line">public class ShuffleBag&lt;T&gt; : ICollection&lt;T&gt;, IList&lt;T&gt;</span><br><span class="line">&#123;</span><br><span class="line">    private List&lt;T&gt; mData = new List&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">    private int mCursor = 0;</span><br><span class="line"></span><br><span class="line">    private T last;</span><br><span class="line"></span><br><span class="line">    public T Next()</span><br><span class="line">    &#123;</span><br><span class="line">        if (mData.Count == 0)</span><br><span class="line">        &#123;</span><br><span class="line">            return default(T);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (mCursor &lt; 1)</span><br><span class="line">        &#123;</span><br><span class="line">            mCursor = mData.Count - 1;</span><br><span class="line">            if (mData.Count &lt; 1)</span><br><span class="line">            &#123;</span><br><span class="line">                return default(T);</span><br><span class="line">            &#125;</span><br><span class="line">            return mData[0];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int grab = Mathf.FloorToInt(Random.value * (mCursor + 1));</span><br><span class="line">        T temp = mData[grab];</span><br><span class="line">        mData[grab] = mData[mCursor];</span><br><span class="line">        mData[mCursor] = temp;</span><br><span class="line">        mCursor--;</span><br><span class="line">        return temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //IList[T] implementation</span><br><span class="line">    public int IndexOf(T item)</span><br><span class="line">    &#123;</span><br><span class="line">        return mData.IndexOf(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Insert(int index, T item)</span><br><span class="line">    &#123;</span><br><span class="line">        mData.Insert(index, item);</span><br><span class="line">        mCursor = mData.Count - 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void RemoveAt(int index)</span><br><span class="line">    &#123;</span><br><span class="line">        mData.RemoveAt(index);</span><br><span class="line">        mCursor = mData.Count - 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public T this[int index]</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return mData[index];</span><br><span class="line">        &#125;</span><br><span class="line">        set</span><br><span class="line">        &#123;</span><br><span class="line">            mData[index] = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //IEnumerable[T] implementation</span><br><span class="line">    IEnumerator&lt;T&gt; IEnumerable&lt;T&gt;.GetEnumerator()</span><br><span class="line">    &#123;</span><br><span class="line">        return mData.GetEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //ICollection[T] implementation</span><br><span class="line">    public void Add(T item)</span><br><span class="line">    &#123;</span><br><span class="line">        mData.Add(item);</span><br><span class="line">        mCursor = mData.Count - 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int Count</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return mData.Count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void Clear()</span><br><span class="line">    &#123;</span><br><span class="line">        //mCursor = 0;</span><br><span class="line">        mData.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool Contains(T item)</span><br><span class="line">    &#123;</span><br><span class="line">        return mData.Contains(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void CopyTo(T[] array, int arrayindex)</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (T item in mData)</span><br><span class="line">        &#123;</span><br><span class="line">            array.SetValue(item, arrayindex);</span><br><span class="line">            arrayindex++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool Remove(T item)</span><br><span class="line">    &#123;</span><br><span class="line">        bool removesuccess = mData.Remove(item);</span><br><span class="line">        mCursor = mData.Count - 1;</span><br><span class="line">        return removesuccess;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public bool IsReadOnly</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //IEnumerable implementation</span><br><span class="line">    IEnumerator IEnumerable.GetEnumerator()</span><br><span class="line">    &#123;</span><br><span class="line">        return mData.GetEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="C#学习">C#学习</h1><p>Book down load link: <a href="http://download.csdn.net/detail/baiyu9821179/4282298" target="_blank" rel="external">c#入门经典第五版</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Game-Engine/">Game_Engine</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://tonytang1990.github.io/2015/07/15/Unity-Study/" data-title="Unity Study | 走停人生路" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/08/15/CSharp-Study/" title="C# Study">
  <strong>上一篇：</strong><br/>
  <span>
  C# Study</span>
</a>
</div>


<div class="next">
<a href="/2015/07/11/Sort-Algorithm/"  title="Sort Algorithm">
 <strong>下一篇：</strong><br/> 
 <span>Sort Algorithm
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/07/15/Unity-Study/" data-title="Unity Study" data-url="http://tonytang1990.github.io/2015/07/15/Unity-Study/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目錄</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Unity_Introduction"><span class="toc-number">1.</span> <span class="toc-text">Unity Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What_is_Unity?"><span class="toc-number">1.1.</span> <span class="toc-text">What is Unity?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why_should_we_study_Unity?"><span class="toc-number">1.2.</span> <span class="toc-text">Why should we study Unity?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Which_programming_language_are_we_using?"><span class="toc-number">1.3.</span> <span class="toc-text">Which programming language are we using?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Unity_Tutorial_Study"><span class="toc-number">2.</span> <span class="toc-text">Unity Tutorial Study</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ROLL-A-BALL"><span class="toc-number">2.1.</span> <span class="toc-text">ROLL-A-BALL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SPACE_SHOOTER"><span class="toc-number">2.2.</span> <span class="toc-text">SPACE SHOOTER</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2D-ROGUELIKE-TUTORIAL"><span class="toc-number">2.3.</span> <span class="toc-text">2D-ROGUELIKE-TUTORIAL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multiplayer_Networking"><span class="toc-number">2.4.</span> <span class="toc-text">Multiplayer Networking</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#编辑器界面"><span class="toc-number">3.</span> <span class="toc-text">编辑器界面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#工具"><span class="toc-number">4.</span> <span class="toc-text">工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MonoDevelop"><span class="toc-number">4.1.</span> <span class="toc-text">MonoDevelop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ILSpy"><span class="toc-number">4.2.</span> <span class="toc-text">ILSpy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ildasm(安装VS自带的工具)"><span class="toc-number">4.3.</span> <span class="toc-text">ildasm(安装VS自带的工具)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Blender"><span class="toc-number">4.4.</span> <span class="toc-text">Blender</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VSTU"><span class="toc-number">4.5.</span> <span class="toc-text">VSTU</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#相关概念学习"><span class="toc-number">5.</span> <span class="toc-text">相关概念学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Unity_Engine"><span class="toc-number">5.1.</span> <span class="toc-text">Unity Engine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#C_Sharp"><span class="toc-number">5.1.1.</span> <span class="toc-text">C Sharp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mono"><span class="toc-number">5.1.2.</span> <span class="toc-text">Mono</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IL2CPP"><span class="toc-number">5.1.3.</span> <span class="toc-text">IL2CPP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Why_do_we_need_IL2CPP?"><span class="toc-number">5.1.3.1.</span> <span class="toc-text">Why do we need IL2CPP?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IL2CPP_Components"><span class="toc-number">5.1.3.2.</span> <span class="toc-text">IL2CPP Components</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mono_and_IL2CPP_compile_and_execution_process"><span class="toc-number">5.1.3.3.</span> <span class="toc-text">Mono and IL2CPP compile and execution process</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOT_&_JIT"><span class="toc-number">5.1.4.</span> <span class="toc-text">AOT & JIT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AOT"><span class="toc-number">5.1.4.1.</span> <span class="toc-text">AOT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JIT"><span class="toc-number">5.1.4.2.</span> <span class="toc-text">JIT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IOS_AOT_Limitations"><span class="toc-number">5.1.4.3.</span> <span class="toc-text">IOS AOT Limitations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Protocol_Buffers"><span class="toc-number">5.1.4.4.</span> <span class="toc-text">Protocol Buffers</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unity_Using"><span class="toc-number">5.2.</span> <span class="toc-text">Unity Using</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#快捷键学习"><span class="toc-number">6.</span> <span class="toc-text">快捷键学习</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#项目编译发布"><span class="toc-number">7.</span> <span class="toc-text">项目编译发布</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PC"><span class="toc-number">7.1.</span> <span class="toc-text">PC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IOS"><span class="toc-number">7.2.</span> <span class="toc-text">IOS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Native_Code_Compilation"><span class="toc-number">7.2.1.</span> <span class="toc-text">Native Code Compilation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prepare_XCode_Project"><span class="toc-number">7.2.2.</span> <span class="toc-text">Prepare XCode Project</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compile_XCode_Project"><span class="toc-number">7.2.3.</span> <span class="toc-text">Compile XCode Project</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#版块学习"><span class="toc-number">8.</span> <span class="toc-text">版块学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#UGUI"><span class="toc-number">8.1.</span> <span class="toc-text">UGUI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Coordinates_System"><span class="toc-number">8.1.1.</span> <span class="toc-text">Coordinates System</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity_Unit_&_Pixel_Per_Unit"><span class="toc-number">8.1.2.</span> <span class="toc-text">Unity Unit & Pixel Per Unit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Canvas"><span class="toc-number">8.1.3.</span> <span class="toc-text">Canvas</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventSystem"><span class="toc-number">8.1.4.</span> <span class="toc-text">EventSystem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UGUI_Atlas"><span class="toc-number">8.1.5.</span> <span class="toc-text">UGUI Atlas</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multiplayer_Networking-1"><span class="toc-number">8.2.</span> <span class="toc-text">Multiplayer Networking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The_Hight_Level_API"><span class="toc-number">8.2.1.</span> <span class="toc-text">The Hight Level API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using_The_Transport_Layer_API"><span class="toc-number">8.2.2.</span> <span class="toc-text">Using The Transport Layer API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unity_Shader"><span class="toc-number">8.3.</span> <span class="toc-text">Unity Shader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Excel数据读取"><span class="toc-number">8.4.</span> <span class="toc-text">Excel数据读取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#资源管理"><span class="toc-number">8.5.</span> <span class="toc-text">资源管理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Plugins"><span class="toc-number">9.</span> <span class="toc-text">Plugins</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C#脚本"><span class="toc-number">10.</span> <span class="toc-text">C#脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence_-_Saving_and_Loading_Data"><span class="toc-number">10.1.</span> <span class="toc-text">Persistence - Saving and Loading Data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PlayerPrefs"><span class="toc-number">10.1.1.</span> <span class="toc-text">PlayerPrefs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Seralization"><span class="toc-number">10.1.2.</span> <span class="toc-text">Seralization</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#What_is_seralization?"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">What is seralization?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C#_Serialization"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">C# Serialization</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity_Editor_Window,_Menu_Item_&_ScriptableObject"><span class="toc-number">10.1.3.</span> <span class="toc-text">Unity Editor Window, Menu Item & ScriptableObject</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Coroutine"><span class="toc-number">10.2.</span> <span class="toc-text">Coroutine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Why_are_we_using_coroutines?"><span class="toc-number">10.2.1.</span> <span class="toc-text">Why are we using coroutines?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#What_is_a_coroutine?"><span class="toc-number">10.2.2.</span> <span class="toc-text">What is a coroutine?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How_long_is_the_life_cycle?_&_When_does_coroutine_get_called?"><span class="toc-number">10.2.3.</span> <span class="toc-text">How long is the life cycle? & When does coroutine get called?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How_to_stop_coroutines?"><span class="toc-number">10.2.4.</span> <span class="toc-text">How to stop coroutines?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Go_depth_in_Coroutine"><span class="toc-number">10.2.5.</span> <span class="toc-text">Go depth in Coroutine</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Unity优化注意事项"><span class="toc-number">11.</span> <span class="toc-text">Unity优化注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Code"><span class="toc-number">11.1.</span> <span class="toc-text">Code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Use_For_or_while_instead_of_foreach"><span class="toc-number">11.1.1.</span> <span class="toc-text">Use For or while instead of foreach</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rendering"><span class="toc-number">11.2.</span> <span class="toc-text">Rendering</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Physic"><span class="toc-number">11.3.</span> <span class="toc-text">Physic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Close_Unnecessary_Collision"><span class="toc-number">11.3.1.</span> <span class="toc-text">Close Unnecessary Collision</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memory"><span class="toc-number">11.4.</span> <span class="toc-text">Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Avoid_Uneccessary_GC"><span class="toc-number">11.4.1.</span> <span class="toc-text">Avoid Uneccessary GC</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#游戏相关"><span class="toc-number">12.</span> <span class="toc-text">游戏相关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Shuffle_Bag"><span class="toc-number">12.1.</span> <span class="toc-text">Shuffle Bag</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C#学习"><span class="toc-number">13.</span> <span class="toc-text">C#学习</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game-Engine/" title="Game_Engine">Game_Engine<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>3</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Sort/" title="Sort">Sort<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情鏈接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 訂閱</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Tony Tang. <br/>
			This is my new blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"TonyTang1990"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回頂部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
